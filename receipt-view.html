<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- ğŸ”§ ã‚­ãƒ£ãƒƒã‚·ãƒ¥é˜²æ­¢ -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸è¡¨ç¤º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      font-size: 28px;
      color: #333;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 14px;
      color: #666;
    }
    
    .receipt-content {
      margin: 30px 0;
      border: 2px solid #eee;
      border-radius: 12px;
      padding: 20px;
      background: #fafafa;
    }
    
    .error-message {
      text-align: center;
      padding: 40px;
      color: #f44336;
      font-size: 18px;
      font-weight: bold;
    }
    
    .loading-message {
      text-align: center;
      padding: 40px;
      color: #667eea;
      font-size: 18px;
      font-weight: bold;
    }
    
    .download-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
      transition: transform 0.2s;
    }
    
    .download-btn:hover {
      transform: translateY(-2px);
    }
    
    .download-btn:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="receiptDisplay" class="receipt-content">
      <div class="loading-message">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    
    <button id="downloadBtn" class="download-btn" style="display: none;" onclick="downloadImage()">
      ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    </button>
  </div>

  <script>
    // ğŸ”§ ä¿®æ­£: ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«å³åº§ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¯ãƒªã‚¢
    const displayDiv = document.getElementById('receiptDisplay');
    displayDiv.innerHTML = '<div class="loading-message">èª­ã¿è¾¼ã¿ä¸­...</div>';
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰IDã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const receiptId = urlParams.get('id');
    
    console.log('ğŸ“± ãƒ¬ã‚·ãƒ¼ãƒˆè¡¨ç¤ºãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿');
    console.log('ğŸ†” ãƒ¬ã‚·ãƒ¼ãƒˆID:', receiptId);
    console.log('ğŸŒ ç¾åœ¨ã®URL:', window.location.href);
    console.log('â° èª­ã¿è¾¼ã¿æ™‚åˆ»:', new Date().toISOString());
    
    let receiptImageData = null;
    
    // ğŸ”§ ä¿®æ­£: ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒã‚’èª­ã¿è¾¼ã¿ï¼ˆå®Œå…¨å†æ§‹ç¯‰ç‰ˆï¼‰
    function loadReceipt() {
      console.log('ğŸ”„ ãƒ¬ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹');
      
      const downloadBtn = document.getElementById('downloadBtn');
      
      // ğŸ”§ é‡è¦: è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’å®Œå…¨ã«ã‚¯ãƒªã‚¢
      displayDiv.innerHTML = '<div class="loading-message">ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...</div>';
      receiptImageData = null;
      
      if (!receiptId) {
        displayDiv.innerHTML = '<div class="error-message">ãƒ¬ã‚·ãƒ¼ãƒˆIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        console.error('âŒ ãƒ¬ã‚·ãƒ¼ãƒˆIDãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      console.log('ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±:');
      console.log('  - æ¤œç´¢ID:', receiptId);
      console.log('  - LocalStorageåˆ©ç”¨å¯èƒ½:', typeof(Storage) !== "undefined");
      console.log('  - LocalStorageã‚¢ã‚¤ãƒ†ãƒ æ•°:', localStorage.length);
      
      // LocalStorageã®å…¨ã‚­ãƒ¼ã‚’è¡¨ç¤º
      console.log('  - ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼:');
      const allKeys = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        allKeys.push(key);
        console.log('    [' + i + '] ' + key);
      }
      
      // ğŸ”§ ä¿®æ­£: ã‚ˆã‚ŠæŸ”è»Ÿãªæ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯
      console.log('ğŸ’¾ LocalStorageã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã¾ã™:', receiptId);
      
      // æ–¹æ³•1: å®Œå…¨ä¸€è‡´ã§æ¤œç´¢
      receiptImageData = localStorage.getItem(receiptId);
      
      if (receiptImageData) {
        console.log('âœ… å®Œå…¨ä¸€è‡´ã§å–å¾—æˆåŠŸ:', receiptId);
      } else {
        console.warn('âš ï¸ å®Œå…¨ä¸€è‡´ã§è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ä»£æ›¿æ¤œç´¢ã‚’è©¦ã¿ã¾ã™...');
        
        // æ–¹æ³•2: æœ€æ–°ã®ãƒ¬ã‚·ãƒ¼ãƒˆIDã‹ã‚‰å–å¾—
        const latestId = localStorage.getItem('latest_receipt_id');
        if (latestId) {
          console.log('ğŸ” æœ€æ–°ãƒ¬ã‚·ãƒ¼ãƒˆID:', latestId);
          receiptImageData = localStorage.getItem(latestId);
          if (receiptImageData) {
            console.log('âœ… æœ€æ–°ãƒ¬ã‚·ãƒ¼ãƒˆIDã‹ã‚‰å–å¾—æˆåŠŸ:', latestId);
          }
        }
        
        // æ–¹æ³•3: receipt_ã§å§‹ã¾ã‚‹æœ€æ–°ã®ã‚­ãƒ¼ã‚’ä½¿ç”¨
        if (!receiptImageData) {
          const receiptKeys = allKeys.filter(k => k && k.startsWith('receipt_'));
          if (receiptKeys.length > 0) {
            // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§ã‚½ãƒ¼ãƒˆï¼ˆé™é †ï¼‰
            receiptKeys.sort((a, b) => {
              const timeA = parseInt(a.replace('receipt_', '')) || 0;
              const timeB = parseInt(b.replace('receipt_', '')) || 0;
              return timeB - timeA;
            });
            const latestKey = receiptKeys[0];
            console.log('ğŸ” receipt_ã‚­ãƒ¼ã®ä¸­ã§æœ€æ–°:', latestKey);
            receiptImageData = localStorage.getItem(latestKey);
            if (receiptImageData) {
              console.log('âœ… æœ€æ–°ã®receipt_ã‚­ãƒ¼ã‹ã‚‰å–å¾—æˆåŠŸ:', latestKey);
            }
          }
        }
        
        // ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
        if (!receiptImageData) {
          displayDiv.innerHTML = `
            <div class="error-message">
              ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“<br><br>
              <small>QRã‚³ãƒ¼ãƒ‰ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã‚‹ã‹ã€ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</small><br><br>
              <div style="font-size: 12px; color: #999; margin-top: 20px; text-align: left;">
                <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>
                æ¤œç´¢ID: ${receiptId}<br>
                LocalStorageã‚¢ã‚¤ãƒ†ãƒ æ•°: ${localStorage.length}<br>
                åˆ©ç”¨å¯èƒ½ãªã‚­ãƒ¼:<br>
                ${allKeys.length > 0 ? allKeys.map(k => '- ' + k).join('<br>') : 'ï¼ˆãªã—ï¼‰'}
              </div>
            </div>
          `;
          console.error('âŒ LocalStorageã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
          return;
        }
      }
      
      if (!receiptImageData || receiptImageData.trim() === '') {
        displayDiv.innerHTML = '<div class="error-message">ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™</div>';
        console.error('âŒ ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
        return;
      }
      
      console.log('âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸï¼ˆã‚µã‚¤ã‚º:', receiptImageData.length, 'æ–‡å­—ï¼‰');
      
      // ğŸ”§ é‡è¦: å¤ã„ç”»åƒã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¦ã‹ã‚‰æ–°ã—ã„ç”»åƒã‚’ä½œæˆ
      displayDiv.innerHTML = '';
      
      // ç”»åƒã‚’è¡¨ç¤º
      const img = document.createElement('img');
      img.src = receiptImageData;
      img.style.width = '100%';
      img.style.borderRadius = '8px';
      
      // ğŸ”§ ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
      img.onerror = function() {
        console.error('âŒ ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        displayDiv.innerHTML = '<div class="error-message">ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      };
      
      // ğŸ”§ ç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸæ™‚ã®ãƒ­ã‚°
      img.onload = function() {
        console.log('âœ… ç”»åƒã®èª­ã¿è¾¼ã¿æˆåŠŸ');
      };
      
      displayDiv.appendChild(img);
      
      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      downloadBtn.style.display = 'block';
      
      console.log('âœ… ãƒ¬ã‚·ãƒ¼ãƒˆè¡¨ç¤ºå®Œäº†');
    }
    
    // ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadImage() {
      if (!receiptImageData) {
        alert('ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      const link = document.createElement('a');
      link.download = `receipt_${receiptId}.png`;
      link.href = receiptImageData;
      link.click();
      
      console.log('ğŸ“¥ ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ');
    }
    
    // ğŸ”§ ä¿®æ­£: ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ç¢ºå®Ÿã«å®Ÿè¡Œ
    // DOMContentLoadedã¨loadã®ä¸¡æ–¹ã§å®Ÿè¡Œã—ã¦ç¢ºå®Ÿæ€§ã‚’é«˜ã‚ã‚‹
    let loaded = false;
    
    function tryLoadReceipt() {
      if (!loaded) {
        loaded = true;
        console.log('ğŸš€ ãƒ¬ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿å®Ÿè¡Œ');
        loadReceipt();
      }
    }
    
    // è¤‡æ•°ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§èª­ã¿è¾¼ã¿ã‚’è©¦ã¿ã‚‹
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', tryLoadReceipt);
    } else {
      // ã™ã§ã«èª­ã¿è¾¼ã¿æ¸ˆã¿ã®å ´åˆã¯å³åº§ã«å®Ÿè¡Œ
      tryLoadReceipt();
    }
    
    window.addEventListener('load', tryLoadReceipt);
    
    // ğŸ”§ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: å°‘ã—å¾…ã£ã¦ã‹ã‚‰å¼·åˆ¶å®Ÿè¡Œ
    setTimeout(() => {
      if (!loaded) {
        console.warn('âš ï¸ é€šå¸¸ã®èª­ã¿è¾¼ã¿ãŒå®Œäº†ã—ãªã‹ã£ãŸãŸã‚ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ');
        tryLoadReceipt();
      }
    }, 100);
  </script>
</body>
</html>
