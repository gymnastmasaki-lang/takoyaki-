<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- ğŸ”§ æœ€å¼·ã‚­ãƒ£ãƒƒã‚·ãƒ¥é˜²æ­¢ -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="-1">
  <title>ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸è¡¨ç¤º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      font-size: 28px;
      color: #333;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 14px;
      color: #666;
    }
    
    .receipt-content {
      margin: 30px 0;
      border: 2px solid #eee;
      border-radius: 12px;
      padding: 20px;
      background: #fafafa;
    }
    
    .error-message {
      text-align: center;
      padding: 40px;
      color: #f44336;
      font-size: 18px;
      font-weight: bold;
    }
    
    .loading-message {
      text-align: center;
      padding: 40px;
      color: #667eea;
      font-size: 18px;
      font-weight: bold;
    }
    
    .debug-info {
      background: #fff3cd;
      border: 2px solid #856404;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 8px;
      font-size: 12px;
      text-align: left;
    }
    
    .download-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
      transition: transform 0.2s;
    }
    
    .download-btn:hover {
      transform: translateY(-2px);
    }
    
    .download-btn:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="receiptDisplay" class="receipt-content">
      <div class="loading-message">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    
    <button id="downloadBtn" class="download-btn" style="display: none;" onclick="downloadImage()">
      ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    </button>
  </div>

  <script>
    // ğŸ”§ è¶…å¼·åŠ›ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼
    (function() {
      console.log('ğŸš€ === ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿é–‹å§‹ ===');
      console.log('â° æ™‚åˆ»:', new Date().toISOString());
      
      const urlParams = new URLSearchParams(window.location.search);
      const receiptId = urlParams.get('id');
      const timestamp = urlParams.get('t');
      const currentTime = Date.now();
      
      console.log('ğŸ“‹ URLæƒ…å ±:');
      console.log('  - receiptId:', receiptId);
      console.log('  - timestamp:', timestamp);
      console.log('  - URL:', window.location.href);
      
      // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒãªã„ã€ã¾ãŸã¯10ç§’ä»¥ä¸Šå¤ã„å ´åˆã¯ãƒªãƒ­ãƒ¼ãƒ‰
      if (receiptId && (!timestamp || (currentTime - parseInt(timestamp)) > 10000)) {
        const newUrl = window.location.pathname + '?id=' + receiptId + '&t=' + currentTime;
        console.log('ğŸ”„ ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—æ›´æ–°:', newUrl);
        window.location.replace(newUrl);
        return;
      }
    })();
    
    // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
    const displayDiv = document.getElementById('receiptDisplay');
    const downloadBtn = document.getElementById('downloadBtn');
    let receiptImageData = null;
    
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const receiptId = urlParams.get('id');
    
    console.log('ğŸ†” å–å¾—ã™ã‚‹ãƒ¬ã‚·ãƒ¼ãƒˆID:', receiptId);
    
    // ãƒ¬ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿é–¢æ•°
    function loadReceipt() {
      console.log('ğŸ“„ === ãƒ¬ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹ ===');
      
      // è¡¨ç¤ºã‚¨ãƒªã‚¢ã‚’ã‚¯ãƒªã‚¢
      displayDiv.innerHTML = '';
      
      // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
      const debugDiv = document.createElement('div');
      debugDiv.className = 'debug-info';
      debugDiv.innerHTML = `
        <strong>ğŸ” èª­ã¿è¾¼ã¿æƒ…å ±</strong><br>
        ID: <code style="background:#fff;padding:2px 5px;">${receiptId || 'ãªã—'}</code><br>
        æ™‚åˆ»: ${new Date().toLocaleTimeString('ja-JP')}<br>
      `;
      displayDiv.appendChild(debugDiv);
      
      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      const loadingDiv = document.createElement('div');
      loadingDiv.className = 'loading-message';
      loadingDiv.textContent = 'ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...';
      displayDiv.appendChild(loadingDiv);
      
      if (!receiptId) {
        displayDiv.innerHTML = '<div class="error-message">ãƒ¬ã‚·ãƒ¼ãƒˆIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        console.error('âŒ ãƒ¬ã‚·ãƒ¼ãƒˆIDãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // LocalStorageç¢ºèª
      console.log('ğŸ’¾ LocalStorageçŠ¶æ…‹:');
      console.log('  - ã‚¢ã‚¤ãƒ†ãƒ æ•°:', localStorage.length);
      
      const allKeys = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        allKeys.push(key);
        console.log('  [' + i + '] ' + key);
      }
      
      // ãƒ‡ãƒ¼ã‚¿å–å¾—
      console.log('ğŸ” æ¤œç´¢ID:', receiptId);
      receiptImageData = localStorage.getItem(receiptId);
      
      if (receiptImageData) {
        console.log('âœ… å®Œå…¨ä¸€è‡´ã§å–å¾—æˆåŠŸ');
        console.log('ğŸ“Š ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º:', receiptImageData.length, 'æ–‡å­—');
      } else {
        console.warn('âš ï¸ å®Œå…¨ä¸€è‡´ã§è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ä»£æ›¿æ¤œç´¢...');
        
        // æœ€æ–°ã®ãƒ¬ã‚·ãƒ¼ãƒˆIDã‹ã‚‰å–å¾—
        const latestId = localStorage.getItem('latest_receipt_id');
        if (latestId) {
          console.log('ğŸ” æœ€æ–°ãƒ¬ã‚·ãƒ¼ãƒˆID:', latestId);
          receiptImageData = localStorage.getItem(latestId);
          if (receiptImageData) {
            console.log('âœ… æœ€æ–°ãƒ¬ã‚·ãƒ¼ãƒˆIDã‹ã‚‰å–å¾—æˆåŠŸ');
          }
        }
        
        // ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€receipt_ã§å§‹ã¾ã‚‹æœ€æ–°ã®ã‚­ãƒ¼ã‚’ä½¿ç”¨
        if (!receiptImageData) {
          const receiptKeys = allKeys.filter(k => k && k.startsWith('receipt_'));
          if (receiptKeys.length > 0) {
            receiptKeys.sort((a, b) => {
              const timeA = parseInt(a.replace('receipt_', '')) || 0;
              const timeB = parseInt(b.replace('receipt_', '')) || 0;
              return timeB - timeA;
            });
            const latestKey = receiptKeys[0];
            console.log('ğŸ” æœ€æ–°ã®receipt_ã‚­ãƒ¼:', latestKey);
            receiptImageData = localStorage.getItem(latestKey);
            if (receiptImageData) {
              console.log('âœ… æœ€æ–°ã‚­ãƒ¼ã‹ã‚‰å–å¾—æˆåŠŸ');
            }
          }
        }
      }
      
      // ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
      if (!receiptImageData) {
        displayDiv.innerHTML = `
          <div class="error-message">
            ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“<br><br>
            <small>QRã‚³ãƒ¼ãƒ‰ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã‚‹ã‹ã€ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</small><br><br>
            <div style="font-size: 12px; color: #999; margin-top: 20px; text-align: left;">
              <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>
              æ¤œç´¢ID: ${receiptId}<br>
              LocalStorageã‚¢ã‚¤ãƒ†ãƒ æ•°: ${localStorage.length}<br>
              åˆ©ç”¨å¯èƒ½ãªã‚­ãƒ¼:<br>
              ${allKeys.length > 0 ? allKeys.map(k => '- ' + k).join('<br>') : 'ï¼ˆãªã—ï¼‰'}
            </div>
          </div>
        `;
        console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // ç”»åƒã‚’è¡¨ç¤º
      console.log('ğŸ–¼ï¸ ç”»åƒè¡¨ç¤ºé–‹å§‹');
      displayDiv.innerHTML = '';
      
      const img = document.createElement('img');
      img.src = receiptImageData;
      img.style.width = '100%';
      img.style.borderRadius = '8px';
      
      img.onload = function() {
        console.log('âœ… ç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸ');
        console.log('ğŸ“ ç”»åƒã‚µã‚¤ã‚º:', img.naturalWidth, 'x', img.naturalHeight);
      };
      
      img.onerror = function() {
        console.error('âŒ ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
        displayDiv.innerHTML = '<div class="error-message">ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      };
      
      displayDiv.appendChild(img);
      downloadBtn.style.display = 'block';
      
      console.log('âœ… ãƒ¬ã‚·ãƒ¼ãƒˆè¡¨ç¤ºå®Œäº†');
    }
    
    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–¢æ•°
    function downloadImage() {
      if (!receiptImageData) {
        alert('ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      const link = document.createElement('a');
      link.download = `receipt_${receiptId}.png`;
      link.href = receiptImageData;
      link.click();
      
      console.log('ğŸ“¥ ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ');
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadReceipt);
    } else {
      loadReceipt();
    }
  </script>
</body>
</html>
