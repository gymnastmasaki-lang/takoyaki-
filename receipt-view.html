<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸è¡¨ç¤º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      font-size: 28px;
      color: #333;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 14px;
      color: #666;
    }
    
    .receipt-content {
      margin: 30px 0;
      border: 2px solid #eee;
      border-radius: 12px;
      padding: 20px;
      background: #fafafa;
    }
    
    .error-message {
      text-align: center;
      padding: 40px;
      color: #f44336;
      font-size: 18px;
      font-weight: bold;
    }
    
    .loading-message {
      text-align: center;
      padding: 40px;
      color: #667eea;
      font-size: 18px;
      font-weight: bold;
    }
    
    .download-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
      transition: transform 0.2s;
    }
    
    .download-btn:hover {
      transform: translateY(-2px);
    }
    
    .download-btn:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ“„ ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ¬ã‚·ãƒ¼ãƒˆ</h1>
      <p>ãŠè²·ã„ä¸Šã’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™</p>
    </div>
    
    <div id="receiptDisplay" class="receipt-content">
      <div class="loading-message">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    
    <button id="downloadBtn" class="download-btn" style="display: none;" onclick="downloadImage()">
      ğŸ’¾ ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    </button>
  </div>

  <script>
    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰IDã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const receiptId = urlParams.get('id');
    
    console.log('ãƒ¬ã‚·ãƒ¼ãƒˆè¡¨ç¤ºãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿');
    console.log('ãƒ¬ã‚·ãƒ¼ãƒˆID:', receiptId);
    
    let receiptImageData = null;
    
    // ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒã‚’èª­ã¿è¾¼ã¿
    function loadReceipt() {
      const displayDiv = document.getElementById('receiptDisplay');
      const downloadBtn = document.getElementById('downloadBtn');
      
      if (!receiptId) {
        displayDiv.innerHTML = '<div class="error-message">âŒ ãƒ¬ã‚·ãƒ¼ãƒˆIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        console.error('ãƒ¬ã‚·ãƒ¼ãƒˆIDãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      console.log('ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±:');
      console.log('  - æ¤œç´¢ID:', receiptId);
      console.log('  - ç¾åœ¨ã®URL:', window.location.href);
      console.log('  - ã‚ªãƒªã‚¸ãƒ³:', window.location.origin);
      console.log('  - LocalStorageåˆ©ç”¨å¯èƒ½:', typeof(Storage) !== "undefined");
      console.log('  - LocalStorageã‚¢ã‚¤ãƒ†ãƒ æ•°:', localStorage.length);
      
      // LocalStorageã®å…¨ã‚­ãƒ¼ã‚’è¡¨ç¤º
      console.log('  - ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚­ãƒ¼:');
      const allKeys = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        allKeys.push(key);
        console.log('    [' + i + '] ' + key);
      }
      
      // LocalStorageã‹ã‚‰ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆå¤§æ–‡å­—å°æ–‡å­—ã‚’åŒºåˆ¥ã—ãªã„ï¼‰
      console.log('ğŸ’¾ LocalStorageã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã¾ã™:', receiptId);
      receiptImageData = localStorage.getItem(receiptId);
      
      if (!receiptImageData) {
        console.warn('âš ï¸ æœ€åˆã®è©¦è¡Œã§è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ä»£æ›¿æ¤œç´¢ã‚’è©¦ã¿ã¾ã™...');
        
        // ã™ã¹ã¦ã®ã‚­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
        let found = false;
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          console.log('  ãƒã‚§ãƒƒã‚¯ä¸­:', key);
          
          // å®Œå…¨ä¸€è‡´
          if (key === receiptId) {
            receiptImageData = localStorage.getItem(key);
            found = true;
            console.log('âœ… å®Œå…¨ä¸€è‡´ã§å–å¾—æˆåŠŸ:', key);
            break;
          }
          
          // éƒ¨åˆ†ä¸€è‡´ï¼ˆreceipt_ã§å§‹ã¾ã‚‹ã‚­ãƒ¼ï¼‰
          if (key && key.startsWith('receipt_')) {
            console.log('  âš ï¸ é¡ä¼¼ã‚­ãƒ¼ç™ºè¦‹:', key);
          }
        }
        
        // ãã‚Œã§ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€æœ€æ–°ã®receipt_ã‚­ãƒ¼ã‚’ä½¿ç”¨
        if (!found && allKeys.length > 0) {
          const receiptKeys = allKeys.filter(k => k && k.startsWith('receipt_'));
          if (receiptKeys.length > 0) {
            // æœ€æ–°ã®ã‚­ãƒ¼ï¼ˆã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒæœ€å¤§ã®ã‚‚ã®ï¼‰ã‚’å–å¾—
            receiptKeys.sort((a, b) => {
              const timeA = parseInt(a.replace('receipt_', ''));
              const timeB = parseInt(b.replace('receipt_', ''));
              return timeB - timeA;
            });
            const latestKey = receiptKeys[0];
            console.log('âš ï¸ æœ€æ–°ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚­ãƒ¼ã‚’ä½¿ç”¨:', latestKey);
            receiptImageData = localStorage.getItem(latestKey);
            found = true;
          }
        }
        
        if (!found) {
          displayDiv.innerHTML = `
            <div class="error-message">
              âŒ ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“<br><br>
              <small>QRã‚³ãƒ¼ãƒ‰ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã‚‹ã‹ã€ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</small><br><br>
              <div style="font-size: 12px; color: #999; margin-top: 20px; text-align: left;">
                <strong>ãƒ‡ãƒãƒƒã‚°æƒ…å ±:</strong><br>
                æ¤œç´¢ID: ${receiptId}<br>
                LocalStorageã‚¢ã‚¤ãƒ†ãƒ æ•°: ${localStorage.length}<br>
                åˆ©ç”¨å¯èƒ½ãªã‚­ãƒ¼:<br>
                ${allKeys.map(k => '- ' + k).join('<br>')}
              </div>
            </div>
          `;
          console.error('âŒ LocalStorageã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“:', receiptId);
          return;
        }
      }
      
      if (!receiptImageData) {
        displayDiv.innerHTML = '<div class="error-message">âŒ ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™</div>';
        console.error('ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
        return;
      }
      
      console.log('âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸï¼ˆã‚µã‚¤ã‚º:', receiptImageData.length, 'æ–‡å­—ï¼‰');
      
      // ç”»åƒã‚’è¡¨ç¤º
      const img = document.createElement('img');
      img.src = receiptImageData;
      img.style.width = '100%';
      img.style.borderRadius = '8px';
      img.onerror = function() {
        console.error('âŒ ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        displayDiv.innerHTML = '<div class="error-message">âŒ ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      };
      
      displayDiv.innerHTML = '';
      displayDiv.appendChild(img);
      
      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      downloadBtn.style.display = 'block';
      
      console.log('âœ… ãƒ¬ã‚·ãƒ¼ãƒˆè¡¨ç¤ºå®Œäº†');
    }
    
    // ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    function downloadImage() {
      if (!receiptImageData) {
        alert('ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      const link = document.createElement('a');
      link.download = `receipt_${receiptId}.png`;
      link.href = receiptImageData;
      link.click();
      
      console.log('ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ');
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    window.addEventListener('DOMContentLoaded', loadReceipt);
  </script>
</body>
</html>
