// ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID
const SHEET_ID = "1BvQLJitHjtqLmOFPQz7kwm0su2FTIuKIunT8yz85B8I";
const ORDER_START_NUMBER = 619; // æ³¨æ–‡ç•ªå·ã®é–‹å§‹ç•ªå·ï¼ˆå¾…ã¡äººæ•°1ã®å ´åˆ619ã‹ã‚‰ï¼‰

// ãƒ¡ã‚¤ãƒ³HTMLè¡¨ç¤ºï¼ˆQRã‚³ãƒ¼ãƒ‰ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å¯¾å¿œï¼‰
function doGet(e) {
  e = e || {};
  const params = e.parameter || {};

  // ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ç”»é¢
  if (params.controller === 'true') {
    return HtmlService.createHtmlOutputFromFile("controller")
      .setTitle("æ³¨æ–‡ç®¡ç†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼")
      .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  }

  // â–¼â–¼ é€šå¸¸ãƒšãƒ¼ã‚¸ï¼ˆindex.htmlï¼‰ã‚’è¿”ã™ â–¼â–¼
  const template = HtmlService.createTemplateFromFile("index");
  template.tableNumber = params.table || 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ';

  return template.evaluate()
    .setTitle("ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—")
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’å–å¾—
function getCategories() {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheets()[0];
    const data = sheet.getDataRange().getValues();
    
    const categories = [];
    const seen = new Set();
    
    for (let i = 1; i < data.length; i++) {
      const category = data[i][1];
      if (category && !seen.has(category)) {
        categories.push(category);
        seen.add(category);
      }
    }
    
    return categories;
  } catch (e) {
    Logger.log('getCategories ã‚¨ãƒ©ãƒ¼: ' + e.toString());
    throw new Error('ã‚«ãƒ†ã‚´ãƒªã®å–å¾—ã«å¤±æ•—: ' + e.message);
  }
}

// å…¨ã¦ã®å•†å“ã‚’å–å¾—ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼‰
function getAllMenu(tableNumber) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const sheet = ss.getSheets()[0];
    const data = sheet.getDataRange().getValues();
    
    const items = [];
    const isEatIn = tableNumber && tableNumber !== 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ';
    
    Logger.log('getAllMenu - ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·: ' + tableNumber);
    Logger.log('ã‚¤ãƒ¼ãƒˆã‚¤ãƒ³åˆ¤å®š: ' + isEatIn);
    
    for (let i = 1; i < data.length; i++) {
      if (data[i][1] && data[i][2]) {
        const note = (data[i][18] || '').toString().trim();
        
        // ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã®å ´åˆã®ã¿ã€ã€Œåº—å†…ã®ã¿ã€å•†å“ã‚’é™¤å¤–
        if (!isEatIn && note.includes('åº—å†…ã®ã¿')) {
          Logger.log(`é™¤å¤–: ${data[i][2]} (ç†ç”±: åº—å†…ã®ã¿å•†å“ã€ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆæ³¨æ–‡)`);
          continue;
        }
        
        items.push({
          id: data[i][0] || '',
          category: data[i][1] || '',
          name: data[i][2] || '',
          price: data[i][3] || 0,
          toppingsId: data[i][4] || '',
          image: data[i][5] || '',
          note: note
        });
      }
    }
    
    Logger.log('å–å¾—ã—ãŸå•†å“æ•°: ' + items.length);
    return items;
  } catch (e) {
    Logger.log('getAllMenu ã‚¨ãƒ©ãƒ¼: ' + e.toString());
    throw new Error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼å–å¾—å¤±æ•—: ' + e.message);
  }
}

// ãƒˆãƒƒãƒ”ãƒ³ã‚°æƒ…å ±ã‚’å–å¾—
function getToppings(toppingsIdStr) {
  try {
    if (!toppingsIdStr) return [];
    
    const ss = SpreadsheetApp.openById(SHEET_ID);
    
    let toppingSheet = null;
    const sheets = ss.getSheets();
    for (let sheet of sheets) {
      if (sheet.getName().toLowerCase() === "toppings") {
        toppingSheet = sheet;
        break;
      }
    }
    
    if (!toppingSheet) {
      Logger.log('toppingsã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return [];
    }
    
    const data = toppingSheet.getDataRange().getValues();
    const toppingIds = toppingsIdStr.split(",").map(id => id.trim());
    const toppings = [];
    
    for (let i = 1; i < data.length; i++) {
      const id = String(data[i][0]).trim();
      if (toppingIds.includes(id)) {
        toppings.push({
          id: id,
          name: data[i][1] || '',
          price: data[i][2] || 0
        });
      }
    }
    
    return toppings;
  } catch (e) {
    Logger.log('getToppings ã‚¨ãƒ©ãƒ¼: ' + e.toString());
    return [];
  }
}

// ä»Šæ—¥ã®æ³¨æ–‡ç•ªå·ã‚’å–å¾—ï¼ˆ618ã‹ã‚‰é–‹å§‹ã€æ·±å¤œ1æ™‚ãƒªã‚»ãƒƒãƒˆï¼‰
function getTodaysOrderNumber(orderSheet) {
  try {
    const now = new Date();
    const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
    
    const todayStart = new Date(jstNow);
    todayStart.setHours(1, 0, 0, 0);
    
    if (jstNow < todayStart) {
      todayStart.setDate(todayStart.getDate() - 1);
    }
    
    const lastRow = orderSheet.getLastRow();
    Logger.log('ordersã‚·ãƒ¼ãƒˆæœ€çµ‚è¡Œ: ' + lastRow);
    
    if (lastRow <= 1) {
      Logger.log('æœ€åˆã®æ³¨æ–‡: ' + ORDER_START_NUMBER);
      return ORDER_START_NUMBER;
    }
    
    // ä»Šæ—¥ã®æœ€å¤§æ³¨æ–‡ç•ªå·ã‚’å–å¾—
    const orderData = orderSheet.getRange(2, 1, lastRow - 1, 2).getValues();
    let maxOrderNumber = ORDER_START_NUMBER - 1;
    
    for (let i = 0; i < orderData.length; i++) {
      const orderNum = Number(orderData[i][0]);
      const orderDate = new Date(orderData[i][1]);
      const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
      
      const orderDayStart = new Date(jstOrderDate);
      orderDayStart.setHours(1, 0, 0, 0);
      
      if (jstOrderDate < orderDayStart) {
        orderDayStart.setDate(orderDayStart.getDate() - 1);
      }
      
      // ä»Šæ—¥ã®æ³¨æ–‡ã§æœ€å¤§ç•ªå·ã‚’æ›´æ–°
      if (orderDayStart.getTime() === todayStart.getTime() && orderNum > maxOrderNumber) {
        maxOrderNumber = orderNum;
      }
    }
    
    const nextNumber = maxOrderNumber + 1;
    Logger.log('æ¬¡ã®æ³¨æ–‡ç•ªå·: ' + nextNumber);
    return nextNumber;
    
  } catch (e) {
    Logger.log('getTodaysOrderNumber ã‚¨ãƒ©ãƒ¼: ' + e.toString());
    return ORDER_START_NUMBER;
  }
}

// æ³¨æ–‡ã‚’ä¿å­˜
function saveOrder(orderData) {
  const lock = LockService.getScriptLock();
  
  try {
    // 5ç§’å¾…ã£ã¦ãƒ­ãƒƒã‚¯å–å¾—ï¼ˆåŒæ™‚æ³¨æ–‡å¯¾ç­–ï¼‰
    lock.waitLock(5000);
    
    Logger.log('=== saveOrder é–‹å§‹ ===');
    Logger.log('å—ä¿¡ãƒ‡ãƒ¼ã‚¿: ' + JSON.stringify(orderData));
    
    if (!orderData || !orderData.items || orderData.items.length === 0) {
      throw new Error('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒç©ºã§ã™');
    }
    
    const ss = SpreadsheetApp.openById(SHEET_ID);
    
    let orderSheet = ss.getSheetByName("orders");
    if (!orderSheet) {
      Logger.log('ordersã‚·ãƒ¼ãƒˆæ–°è¦ä½œæˆ');
      orderSheet = ss.insertSheet("orders");
      orderSheet.getRange(1, 1, 1, 11).setValues([[
        "æ³¨æ–‡ç•ªå·", "æ—¥æ™‚", "ãƒ†ãƒ¼ãƒ–ãƒ«", "å•†å“ID", "å•†å“å", "ä¾¡æ ¼", "ãƒˆãƒƒãƒ”ãƒ³ã‚°", "æ•°é‡", "å°è¨ˆ", "åˆè¨ˆé‡‘é¡", "å‰Šé™¤äºˆå®šæ™‚åˆ»"
      ]]);
      orderSheet.getRange(1, 1, 1, 11).setFontWeight("bold").setBackground("#f3f3f3");
    }
    
    const orderNumber = getTodaysOrderNumber(orderSheet);
    Logger.log('ç¢ºå®šæ³¨æ–‡ç•ªå·: ' + orderNumber);
    
    const now = new Date();
    const timestamp = Utilities.formatDate(now, "Asia/Tokyo", "yyyy/MM/dd HH:mm:ss");
    
    // å‰Šé™¤äºˆå®šæ™‚åˆ»ï¼ˆ10åˆ†å¾Œï¼‰- ä¿®æ­£ç‰ˆ
    const deleteTime = new Date(now.getTime() + 10 * 60 * 1000);
    const deleteTimeStr = Utilities.formatDate(deleteTime, "Asia/Tokyo", "yyyy/MM/dd HH:mm:ss");
    
    Logger.log('ç¾åœ¨æ™‚åˆ»: ' + timestamp);
    Logger.log('å‰Šé™¤äºˆå®šæ™‚åˆ»: ' + deleteTimeStr);
    
    const tableNumber = orderData.tableNumber || 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ';
    Logger.log('ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·: ' + tableNumber);
    
    // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    let totalAmount = 0;
    const rowsToAdd = [];
    
    orderData.items.forEach((item, index) => {
      const price = Number(item.price) || 0;
      const toppingPrice = Number(item.toppingPrice) || 0;
      const quantity = Number(item.quantity) || 1;
      const subtotal = (price + toppingPrice) * quantity;
      totalAmount += subtotal;
      
      const row = [
        orderNumber,
        now,  // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãã®ã¾ã¾ä¿å­˜
        tableNumber,
        item.id || '',
        item.name || '',
        price,
        item.toppings || '',
        quantity,
        subtotal,
        index === 0 ? totalAmount : '',
        deleteTime  // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ãã®ã¾ã¾ä¿å­˜ï¼ˆæ–‡å­—åˆ—ã§ã¯ãªãï¼‰
      ];
      
      rowsToAdd.push(row);
    });
    
    const startRow = orderSheet.getLastRow() + 1;
    orderSheet.getRange(startRow, 1, rowsToAdd.length, 11).setValues(rowsToAdd);
    orderSheet.getRange(startRow, 10).setValue(totalAmount);
    
    Logger.log('ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†: è¡Œ' + startRow);
    
    // å¾…ã¡äººæ•°ã‚’è¨ˆç®—
    const waitingCount = getWaitingCount();
    Logger.log('å¾…ã¡äººæ•°: ' + waitingCount);
    
    // ãƒ¡ãƒ¼ãƒ«é€ä¿¡
    try {
      sendOrderEmail(orderNumber, tableNumber, orderData.items, totalAmount, timestamp);
      Logger.log('ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†');
    } catch (e) {
      Logger.log('ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–ï¼‰: ' + e.toString());
    }
    

    const myPosition = getMyPosition(orderNumber);

    const result = {
      orderNumber: orderNumber,
      waitingCount: myPosition, // ğŸ”¥ æœ€çµ‚ãƒšãƒ¼ã‚¸ç”¨: è‡ªåˆ†ã®é †ç•ª
      totalAmount: totalAmount,
      timestamp: timestamp,
      tableNumber: tableNumber
    };
    
    Logger.log('è¿”å´ãƒ‡ãƒ¼ã‚¿: ' + JSON.stringify(result));
    Logger.log('=== saveOrder å®Œäº† ===');
    
    return result;
    
  } catch (e) {
    Logger.log('saveOrder ã‚¨ãƒ©ãƒ¼: ' + e.toString());
    Logger.log('ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ' + e.stack);
    throw new Error('æ³¨æ–‡ä¿å­˜å¤±æ•—: ' + e.message);
  } finally {
    lock.releaseLock();
  }
}

// ãƒ¡ãƒ¼ãƒ«é€ä¿¡
function sendOrderEmail(orderNumber, tableNumber, items, totalAmount, timestamp) {
  try {
    const email = "hachi.shimoaka@gmail.com";
    const subject = `ã€æ–°è¦æ³¨æ–‡ã€‘#${orderNumber} [${tableNumber}] - ç²‰ã‚‚ã‚“å±‹ å…«`;
    
    let itemList = '';
    items.forEach(item => {
      const subtotal = (item.price + item.toppingPrice) * item.quantity;
      itemList += `
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€å•†å“ã€‘ ${item.name}
ã€å˜ä¾¡ã€‘ Â¥${item.price.toLocaleString()}
ã€ãƒˆãƒƒãƒ”ãƒ³ã‚°ã€‘ ${item.toppings}
ã€æ•°é‡ã€‘ ${item.quantity}å€‹
ã€å°è¨ˆã€‘ Â¥${subtotal.toLocaleString()}
`;
    });
    
    const body = `
ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—
æ–°ã—ã„æ³¨æ–‡ãŒå…¥ã‚Šã¾ã—ãŸ

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€æ³¨æ–‡ç•ªå·ã€‘ ${orderNumber}
ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã€‘ ${tableNumber}
ã€æ³¨æ–‡æ—¥æ™‚ã€‘ ${timestamp}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ã€æ³¨æ–‡å†…å®¹ã€‘
${itemList}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ã€åˆè¨ˆé‡‘é¡ã€‘ Â¥${totalAmount.toLocaleString()}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    `;
    
    MailApp.sendEmail({
      to: email,
      subject: subject,
      body: body
    });
    
    Logger.log('ãƒ¡ãƒ¼ãƒ«é€ä¿¡æˆåŠŸ: ' + email);
  } catch (e) {
    Logger.log('sendOrderEmail ã‚¨ãƒ©ãƒ¼: ' + e.toString());
    throw e;
  }
}

// è‡ªå‹•å‰Šé™¤ï¼ˆå‰Šé™¤äºˆå®šæ™‚åˆ»ã‚’éããŸæ³¨æ–‡ã‚’å‰Šé™¤ï¼‰
function deleteOldOrders() {
  try {
    Logger.log('=== deleteOldOrders é–‹å§‹ ===');
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const orderSheet = ss.getSheetByName("orders");
    
    if (!orderSheet || orderSheet.getLastRow() <= 1) {
      Logger.log('å‰Šé™¤ã™ã‚‹æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    
    const now = new Date();
    Logger.log('ç¾åœ¨æ™‚åˆ»: ' + Utilities.formatDate(now, "Asia/Tokyo", "yyyy/MM/dd HH:mm:ss"));
    
    const lastRow = orderSheet.getLastRow();
    let deletedCount = 0;
    
    for (let i = lastRow; i >= 2; i--) {
      const deleteTime = orderSheet.getRange(i, 11).getValue();
      
      if (deleteTime) {
        const deleteDate = new Date(deleteTime);
        Logger.log(`è¡Œ${i}: å‰Šé™¤äºˆå®š ${Utilities.formatDate(deleteDate, "Asia/Tokyo", "yyyy/MM/dd HH:mm:ss")}`);
        
        if (deleteDate <= now) {
          const orderNum = orderSheet.getRange(i, 1).getValue();
          orderSheet.deleteRow(i);
          deletedCount++;
          Logger.log(`è¡Œ ${i} (æ³¨æ–‡ç•ªå·${orderNum})ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }
      }
    }
    
    Logger.log(`åˆè¨ˆ ${deletedCount} è¡Œã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
    Logger.log('=== deleteOldOrders å®Œäº† ===');
    
  } catch (e) {
    Logger.log('deleteOldOrders ã‚¨ãƒ©ãƒ¼: ' + e.toString());
  }
}

// ğŸ”¥ æ–°è¦è¿½åŠ : ã‚­ãƒ£ãƒ³ã‚»ãƒ«è¡¨ç¤ºã®è‡ªå‹•å‰Šé™¤ï¼ˆ1åˆ†æ¯ï¼‰
function deleteOldCancelRecords() {
  try {
    Logger.log('=== deleteOldCancelRecords é–‹å§‹ ===');
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const cancelSheet = ss.getSheetByName("cancelled_orders");
    
    if (!cancelSheet || cancelSheet.getLastRow() <= 1) {
      Logger.log('å‰Šé™¤ã™ã‚‹ã‚­ãƒ£ãƒ³ã‚»ãƒ«è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“');
      return;
    }
    
    const now = new Date();
    Logger.log('ç¾åœ¨æ™‚åˆ»: ' + Utilities.formatDate(now, "Asia/Tokyo", "yyyy/MM/dd HH:mm:ss"));
    
    const lastRow = cancelSheet.getLastRow();
    let deletedCount = 0;
    
    // 1åˆ†ï¼ˆ60ç§’ï¼‰ä»¥ä¸Šå‰ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«è¨˜éŒ²ã‚’å‰Šé™¤
    for (let i = lastRow; i >= 2; i--) {
      const cancelTime = cancelSheet.getRange(i, 2).getValue();
      
      if (cancelTime) {
        const cancelDate = new Date(cancelTime);
        const timeDiff = (now - cancelDate) / 1000; // ç§’å˜ä½
        
        Logger.log(`è¡Œ${i}: ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚åˆ» ${Utilities.formatDate(cancelDate, "Asia/Tokyo", "yyyy/MM/dd HH:mm:ss")} (${Math.floor(timeDiff)}ç§’å‰)`);
        
        if (timeDiff >= 60) { // ğŸ”¥ 1åˆ†ä»¥ä¸ŠçµŒé
          const orderNum = cancelSheet.getRange(i, 1).getValue();
          cancelSheet.deleteRow(i);
          deletedCount++;
          Logger.log(`è¡Œ ${i} (æ³¨æ–‡ç•ªå·${orderNum})ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }
      }
    }
    
    Logger.log(`åˆè¨ˆ ${deletedCount} è¡Œã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
    Logger.log('=== deleteOldCancelRecords å®Œäº† ===');
    
  } catch (e) {
    Logger.log('deleteOldCancelRecords ã‚¨ãƒ©ãƒ¼: ' + e.toString());
  }
}

// æ³¨æ–‡å­˜åœ¨ãƒã‚§ãƒƒã‚¯
function checkOrderExists(orderNumber) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const orderSheet = ss.getSheetByName("orders");
    
    if (!orderSheet || orderSheet.getLastRow() <= 1) {
      return false;
    }
    
    const lastRow = orderSheet.getLastRow();
    const orderNumbers = orderSheet.getRange(2, 1, lastRow - 1, 1).getValues();
    
    for (let i = 0; i < orderNumbers.length; i++) {
      if (orderNumbers[i][0] == orderNumber) {
        return true;
      }
    }
    
    return false;
    
  } catch (e) {
    Logger.log('checkOrderExists ã‚¨ãƒ©ãƒ¼: ' + e.toString());
    return true;
  }
}

// ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å¾…ã¡äººæ•°ã‚’å–å¾—
function getWaitingCount() {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const orderSheet = ss.getSheetByName("orders");
    
    if (!orderSheet || orderSheet.getLastRow() <= 1) {
      return 1; // ordersã‚·ãƒ¼ãƒˆãŒç©ºã§ã‚‚åŸºæœ¬ã®+1
    }
    
    const now = new Date();
    const lastRow = orderSheet.getLastRow();
    const deleteTimeColumn = orderSheet.getRange(2, 11, lastRow - 1, 1).getValues();
    const orderNumberColumn = orderSheet.getRange(2, 1, lastRow - 1, 1).getValues();
    const uniqueOrders = new Set();
    
    for (let i = 0; i < deleteTimeColumn.length; i++) {
      const scheduledDelete = deleteTimeColumn[i][0];
      if (scheduledDelete && new Date(scheduledDelete) > now) {
        const orderNum = orderNumberColumn[i][0];
        uniqueOrders.add(orderNum);
      }
    }
    
    // åŸºæœ¬+1 + ç¾åœ¨ã®æ³¨æ–‡æ•°
    return 1 + uniqueOrders.size;
    
  } catch (e) {
    Logger.log('getWaitingCount ã‚¨ãƒ©ãƒ¼: ' + e.toString());
    return 1;
  }
}

// ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ç”¨ï¼šå…¨æ³¨æ–‡å–å¾—
function getAllOrders() {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const orderSheet = ss.getSheetByName("orders");
    
    if (!orderSheet || orderSheet.getLastRow() <= 1) {
      return [];
    }
    
    const lastRow = orderSheet.getLastRow();
    const data = orderSheet.getRange(2, 1, lastRow - 1, 11).getValues();
    
    const orders = {};
    
    data.forEach(row => {
      const orderNum = row[0];
      const deleteTime = new Date(row[10]);
      
      if (!orders[orderNum]) {
        orders[orderNum] = {
          orderNumber: orderNum,
          timestamp: Utilities.formatDate(new Date(row[1]), "Asia/Tokyo", "yyyy/MM/dd HH:mm:ss"),
          tableNumber: row[2],
          items: [],
          totalAmount: row[9] || 0,
          deleteTime: Utilities.formatDate(deleteTime, "Asia/Tokyo", "yyyy/MM/dd HH:mm:ss")
        };
      }
      
      orders[orderNum].items.push({
        name: row[4],
        toppings: row[6],
        quantity: row[7]
      });
    });
    
    return Object.values(orders);
    
  } catch (e) {
    Logger.log('getAllOrders ã‚¨ãƒ©ãƒ¼: ' + e.toString());
    return [];
  }
}

// ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ç”¨ï¼šæ™‚é–“å»¶é•·ï¼ˆ+10åˆ†ï¼‰
function extendOrderTime(orderNumber) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const orderSheet = ss.getSheetByName("orders");
    
    if (!orderSheet) return { success: false, message: 'ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' };
    
    const lastRow = orderSheet.getLastRow();
    let updated = 0;
    
    for (let i = 2; i <= lastRow; i++) {
      const orderNum = orderSheet.getRange(i, 1).getValue();
      
      if (orderNum == orderNumber) {
        const currentDeleteTime = orderSheet.getRange(i, 11).getValue();
        const currentDate = new Date(currentDeleteTime);
        const newDeleteTime = new Date(currentDate.getTime() + 10 * 60 * 1000);
        
        orderSheet.getRange(i, 11).setValue(newDeleteTime);  // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦ä¿å­˜
        updated++;
        
        Logger.log(`å»¶é•·: ${Utilities.formatDate(currentDate, "Asia/Tokyo", "HH:mm:ss")} â†’ ${Utilities.formatDate(newDeleteTime, "Asia/Tokyo", "HH:mm:ss")}`);
      }
    }
    
    return { 
      success: updated > 0, 
      message: updated > 0 ? `10åˆ†å»¶é•·ã—ã¾ã—ãŸ (${updated}è¡Œæ›´æ–°)` : 'æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' 
    };
    
  } catch (e) {
    Logger.log('extendOrderTime ã‚¨ãƒ©ãƒ¼: ' + e.toString());
    return { success: false, message: 'ã‚¨ãƒ©ãƒ¼: ' + e.message };
  }
}

// ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ç”¨ï¼šå®Œäº†ï¼ˆå‰Šé™¤ï¼‰
function completeOrder(orderNumber) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const orderSheet = ss.getSheetByName("orders");
    
    if (!orderSheet) return { success: false, message: 'ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' };
    
    const lastRow = orderSheet.getLastRow();
    let deletedCount = 0;
    
    for (let i = lastRow; i >= 2; i--) {
      const orderNum = orderSheet.getRange(i, 1).getValue();
      
      if (orderNum == orderNumber) {
        orderSheet.deleteRow(i);
        deletedCount++;
      }
    }
    
    return { 
      success: deletedCount > 0, 
      message: deletedCount > 0 ? `æ³¨æ–‡ã‚’å®Œäº†ã—ã¾ã—ãŸ (${deletedCount}è¡Œå‰Šé™¤)` : 'æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' 
    };
    
  } catch (e) {
    Logger.log('completeOrder ã‚¨ãƒ©ãƒ¼: ' + e.toString());
    return { success: false, message: 'ã‚¨ãƒ©ãƒ¼: ' + e.message };
  }
}

// ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ç”¨ï¼šã‚­ãƒ£ãƒ³ã‚»ãƒ«
function cancelOrder(orderNumber) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const orderSheet = ss.getSheetByName("orders");
    const cancelSheet = ss.getSheetByName("cancelled_orders") || ss.insertSheet("cancelled_orders");
    
    if (!orderSheet) return { success: false, message: 'ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' };
    
    if (cancelSheet.getLastRow() === 0) {
      cancelSheet.appendRow(["æ³¨æ–‡ç•ªå·", "ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ—¥æ™‚"]);
      cancelSheet.getRange(1, 1, 1, 2).setFontWeight("bold").setBackground("#f3f3f3");
    }
    
    const lastRow = orderSheet.getLastRow();
    let found = false;
    
    for (let i = lastRow; i >= 2; i--) {
      const orderNum = orderSheet.getRange(i, 1).getValue();
      
      if (orderNum == orderNumber) {
        orderSheet.deleteRow(i);
        found = true;
      }
    }
    
    if (found) {
      const now = new Date();
      const cancelTime = Utilities.formatDate(now, "Asia/Tokyo", "yyyy/MM/dd HH:mm:ss");
      cancelSheet.appendRow([orderNumber, cancelTime]);
    }
    
    return { 
      success: found, 
      message: found ? 'æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ' : 'æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' 
    };
    
  } catch (e) {
    Logger.log('cancelOrder ã‚¨ãƒ©ãƒ¼: ' + e.toString());
    return { success: false, message: 'ã‚¨ãƒ©ãƒ¼: ' + e.message };
  }
}

// ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ç”¨ï¼šå¾…ã¡äººæ•°ã‚’æ‰‹å‹•ã§å¢—ã‚„ã™
function increaseWaitingCount() {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    let manualSheet = ss.getSheetByName("manual_waiting");
    
    if (!manualSheet) {
      manualSheet = ss.insertSheet("manual_waiting");
      manualSheet.appendRow(["è¿½åŠ å¾…ã¡äººæ•°"]);
      manualSheet.getRange(2, 1).setValue(0);
    }
    
    const currentCount = manualSheet.getRange(2, 1).getValue() || 0;
    manualSheet.getRange(2, 1).setValue(currentCount + 1);
    
    return { success: true, message: 'å¾…ã¡äººæ•°ã‚’1çµ„å¢—ã‚„ã—ã¾ã—ãŸ', newCount: currentCount + 1 };
    
  } catch (e) {
    Logger.log('increaseWaitingCount ã‚¨ãƒ©ãƒ¼: ' + e.toString());
    return { success: false, message: 'ã‚¨ãƒ©ãƒ¼: ' + e.message };
  }
}

// ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ç”¨ï¼šæ‰‹å‹•å¾…ã¡äººæ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
function resetManualWaiting() {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const manualSheet = ss.getSheetByName("manual_waiting");
    
    if (manualSheet) {
      manualSheet.getRange(2, 1).setValue(0);
    }
    
    return { success: true, message: 'æ‰‹å‹•å¾…ã¡äººæ•°ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ' };
    
  } catch (e) {
    Logger.log('resetManualWaiting ã‚¨ãƒ©ãƒ¼: ' + e.toString());
    return { success: false, message: 'ã‚¨ãƒ©ãƒ¼: ' + e.message };
  }
}

// å¾…ã¡äººæ•°å–å¾—ï¼ˆæ‰‹å‹•è¿½åŠ åˆ†ã‚’å«ã‚€ï¼‰
function getWaitingCountWithManual() {
  const baseCount = getWaitingCount();
  
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const manualSheet = ss.getSheetByName("manual_waiting");
    
    if (manualSheet && manualSheet.getLastRow() >= 2) {
      const manualCount = manualSheet.getRange(2, 1).getValue() || 0;
      return baseCount + manualCount;
    }
  } catch (e) {
    Logger.log('æ‰‹å‹•å¾…ã¡äººæ•°å–å¾—ã‚¨ãƒ©ãƒ¼: ' + e.toString());
  }
  
  return baseCount;
}

// ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
function checkIfCancelled(orderNumber) {
  try {
    const ss = SpreadsheetApp.openById(SHEET_ID);
    const cancelSheet = ss.getSheetByName("cancelled_orders");
    
    if (!cancelSheet || cancelSheet.getLastRow() <= 1) {
      return false;
    }
    
    const lastRow = cancelSheet.getLastRow();
    const cancelledNumbers = cancelSheet.getRange(2, 1, lastRow - 1, 1).getValues();
    
    for (let i = 0; i < cancelledNumbers.length; i++) {
      if (cancelledNumbers[i][0] == orderNumber) {
        return true;
      }
    }
    
    return false;
    
  } catch (e) {
    Logger.log('checkIfCancelled ã‚¨ãƒ©ãƒ¼: ' + e.toString());
    return false;
  }
}

// ğŸ”¥ ä¿®æ­£ç‰ˆ: ãƒˆãƒªã‚¬ãƒ¼è¨­å®šï¼ˆæ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å…¨å‰Šé™¤ã—ã¦ã‹ã‚‰è¿½åŠ ï¼‰
function setupTriggers() {
  // æ—¢å­˜ã®ãƒˆãƒªã‚¬ãƒ¼ã‚’å…¨å‰Šé™¤
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => ScriptApp.deleteTrigger(trigger));
  
  // 10åˆ†ã”ã¨ã«æ³¨æ–‡å‰Šé™¤
  ScriptApp.newTrigger('deleteOldOrders')
    .timeBased()
    .everyMinutes(10)
    .create();
  
  // ğŸ”¥ 1åˆ†ã”ã¨ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«è¨˜éŒ²å‰Šé™¤
  ScriptApp.newTrigger('deleteOldCancelRecords')
    .timeBased()
    .everyMinutes(1)
    .create();
  
  Logger.log('ãƒˆãƒªã‚¬ãƒ¼è¨­å®šå®Œäº†:');
  Logger.log('- 10åˆ†ã”ã¨ã« deleteOldOrders ã‚’å®Ÿè¡Œ');
  Logger.log('- 1åˆ†ã”ã¨ã« deleteOldCancelRecords ã‚’å®Ÿè¡Œ');
}

// ãƒˆãƒªã‚¬ãƒ¼ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
function testDeleteOldOrders() {
  Logger.log('=== deleteOldOrders ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹ ===');
  deleteOldOrders();
  Logger.log('=== deleteOldOrders ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº† ===');
}

// ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‰Šé™¤ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
function testDeleteOldCancelRecords() {
  Logger.log('=== deleteOldCancelRecords ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹ ===');
  deleteOldCancelRecords();
  Logger.log('=== deleteOldCancelRecords ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº† ===');
}
// ğŸ”¥ è‡ªåˆ†ã®é †ç•ªã‚’è¨ˆç®—ã™ã‚‹ï¼ˆæ³¨æ–‡ç•ªå·ã‹ã‚‰ç¾åœ¨ã®é †ç•ªã‚’å–å¾—ï¼‰
function getMyPosition(orderNumber) {
  const count = getWaitingCountWithManual();
  return count;
}