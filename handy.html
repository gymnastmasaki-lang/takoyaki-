<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    /* å…ƒã®CSSã‚’ã™ã¹ã¦ç¶­æŒ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 600px; margin: 0 auto; }
    .login-screen { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .login-screen h1 { text-align: center; color: #667eea; margin-bottom: 30px; font-size: 28px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: bold; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
    .login-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; }
    .tables-screen { display: none; }
    .header { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .logout-btn { background: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
    .table-card { background: white; border-radius: 15px; padding: 30px 20px; text-align: center; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
    .table-card.has-pending-orders { background: linear-gradient(135deg, #fff4e6 0%, #ffe0b2 100%); border: 2px solid #ff9800; }
    .table-card .table-name { font-size: 24px; font-weight: bold; color: #667eea; }
    .checkout-btn { width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    .hidden { display: none !important; }
    .modal-overlay { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 10001; align-items: center; justify-content: center; }
    .modal { background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
    .tax-item { padding: 10px; background: white; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="login-screen" id="loginScreen">
      <h1>ğŸ½ï¸ ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </h1>
      <div id="errorMessage" class="error-message hidden" style="color:red; margin-bottom:10px;"></div>
      <div class="form-group">
        <label for="storeSelect">åº—èˆ—ã‚’é¸æŠ</label>
        <select id="storeSelect"><option value="">é¸æŠã—ã¦ãã ã•ã„</option></select>
      </div>
      <div class="form-group">
        <label for="passwordInput">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      </div>
      <button class="login-btn" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    
    <div class="tables-screen" id="tablesScreen">
      <div class="header">
        <h2 id="storeNameDisplay">åº—èˆ—å</h2>
        <button class="logout-btn" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <div class="tables-grid" id="tablesGrid"></div>
    </div>
  </div>
  
  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3 style="text-align:center;">ğŸ’° ä¼šè¨ˆå‡¦ç†</h3>
      <p id="selectedTableLabel2" style="text-align:center; color:#666; margin-bottom:20px;"></p>
      
      <div id="taxRateSection" style="margin-bottom:20px; padding:15px; background:#e8f5e9; border-radius:10px;">
        <h4 style="font-size:14px; margin-bottom:10px;">å•†å“åˆ¥ç¨ç‡ç¢ºèª</h4>
        <div id="taxRateItemsList"></div>
      </div>
      
      <div style="margin:20px 0; padding:15px; background:#fff3cd; border-radius:10px; text-align:center;">
        <div style="font-size:18px; font-weight:bold;">è«‹æ±‚é¡: <span id="finalPaymentAmount" style="color:#4CAF50;">Â¥0</span></div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <button class="btn" style="background:#4CAF50; color:white;" onclick="completePayment('cash')">ç¾é‡‘ä¼šè¨ˆ</button>
        <button class="btn" style="background:#2196F3; color:white;" onclick="completePayment('credit')">ãã®ä»–ä¼šè¨ˆ</button>
        <button class="btn" style="background:#FF9800; color:white;" onclick="cancelOrdersForTable()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn" style="background:#f44336; color:white;" onclick="deleteOrdersForTable()">æ³¨æ–‡å‰Šé™¤</button>
      </div>
      <button class="btn" style="width:100%; margin-top:10px; background:#eee;" onclick="closePaymentModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="customConfirmModal" class="modal-overlay hidden">
    <div class="modal" style="text-align:center;">
      <div id="modalIcon" style="font-size:40px;">âš ï¸</div>
      <h3 id="modalTitle">ç¢ºèª</h3>
      <p id="modalMessage" style="margin:15px 0; color:#666;"></p>
      <div style="display:flex; gap:10px;">
        <button class="btn" style="flex:1; background:#ddd;" onclick="closeCustomModal()">ã„ã„ãˆ</button>
        <button id="modalConfirmBtn" class="btn" style="flex:1; background:#f44336; color:white;">ã¯ã„</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, getDocs, doc, where, onSnapshot, updateDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®å®šç¾©
    let currentStoreId = null;
    let currentStoreName = null;
    let storesData = {};
    let currentOrders = [];
    let currentTableName = null;
    let customModalResolve = null;

    // --- ãƒ­ã‚°ã‚¤ãƒ³ãƒ»åº—èˆ—ãƒªã‚¹ãƒˆå–å¾— (å¾©å…ƒ) ---
    async function loadStoreList() {
      try {
        const q = query(collection(db, 'stores'), where('isActive', '==', true));
        const snap = await getDocs(q);
        const select = document.getElementById('storeSelect');
        select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        snap.forEach(doc => {
          const data = doc.data();
          storesData[doc.id] = { name: data.storeName, password: String(data.storePassword) };
          const opt = document.createElement('option');
          opt.value = doc.id; opt.textContent = data.storeName;
          select.appendChild(opt);
        });
      } catch (e) { console.error(e); }
    }

    window.handleLogin = () => {
      const id = document.getElementById('storeSelect').value;
      const pass = document.getElementById('passwordInput').value;
      if (!id || !storesData[id]) return;
      if (pass !== storesData[id].password) {
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
        return;
      }
      currentStoreId = id;
      currentStoreName = storesData[id].name;
      sessionStorage.setItem('handyStoreId', id);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      showTablesScreen();
    };

    window.handleLogout = () => { sessionStorage.clear(); location.reload(); };

    function showTablesScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      const screen = document.getElementById('tablesScreen');
      screen.style.display = 'block';
      screen.classList.remove('hidden');
      document.getElementById('storeNameDisplay').textContent = currentStoreName;
      loadTables();
    }

    // --- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã¨æ³¨æ–‡ç›£è¦– (å¾©å…ƒ) ---
    async function loadTables() {
      const tSnap = await getDocs(collection(db, 'stores', currentStoreId, 'tables'));
      const grid = document.getElementById('tablesGrid');
      
      onSnapshot(query(collection(db, 'stores', currentStoreId, 'orders'), where('paidAt', '==', null), where('deleted', '==', false), where('cancelledAt', '==', null)), (oSnap) => {
        const activeTables = new Set();
        oSnap.forEach(d => activeTables.add(d.data().tableNumber));
        grid.innerHTML = '';
        tSnap.forEach(d => {
          const t = d.data();
          const card = document.createElement('div');
          card.className = `table-card ${activeTables.has(t.name) ? 'has-pending-orders' : ''}`;
          card.innerHTML = `<div class="table-name">${t.name}</div><button class="checkout-btn" onclick="openCheckoutForTable('${t.name}')">ä¼šè¨ˆ/ç®¡ç†</button>`;
          grid.appendChild(card);
        });
      });
    }

    // --- ä¼šè¨ˆç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ (ä»Šå›ã®æ”¹å–„ç‚¹) ---
    window.openCheckoutForTable = async (tableName) => {
      currentTableName = tableName;
      const q = query(collection(db, 'stores', currentStoreId, 'orders'), 
                where('tableNumber', '==', String(tableName)),
                where('paidAt', '==', null),
                where('deleted', '==', false),
                where('cancelledAt', '==', null));
      const snap = await getDocs(q);
      currentOrders = snap.docs.map(d => ({id: d.id, ...d.data()}));
      if (currentOrders.length === 0) return alert('æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“');

      document.getElementById('selectedTableLabel2').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ«: ${tableName}`;
      const total = currentOrders.reduce((s, o) => s + (o.totalAmount || 0), 0);
      document.getElementById('finalPaymentAmount').textContent = `Â¥${total.toLocaleString()}`;
      
      const list = document.getElementById('taxRateItemsList');
      list.innerHTML = currentOrders.map(o => `<div class="tax-item">æ³¨æ–‡ #${o.orderNumber || 'ç„¡'}: Â¥${(o.totalAmount || 0).toLocaleString()}</div>`).join('');
      document.getElementById('paymentModal').classList.remove('hidden');
    };

    // å£²ä¸Šåæ˜  + è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰
    window.completePayment = async (method) => {
      const confirmed = await showCustomConfirm({ icon: 'ğŸ’°', title: 'ä¼šè¨ˆç¢ºå®š', message: 'å£²ä¸Šã«åæ˜ ã—ã¾ã™ã‹ï¼Ÿ' });
      if (!confirmed) return;
      try {
        const now = serverTimestamp();
        let total = 0;
        for (const o of currentOrders) {
          await updateDoc(doc(db, 'stores', currentStoreId, 'orders', o.id), { paidAt: now, paymentMethod: method });
          total += (o.totalAmount || 0);
        }
        // å£²ä¸Šåæ˜ 
        await addDoc(collection(db, 'stores', currentStoreId, 'sales'), {
          amount: total, method: method, createdAt: now, tableName: currentTableName, type: 'order'
        });
        await showCustomConfirm({ icon: 'âœ…', title: 'å®Œäº†', message: 'ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸ', btnText: 'OK' });
        location.reload();
      } catch (e) { alert('å¤±æ•—ã—ã¾ã—ãŸ'); }
    };

    // å‰Šé™¤ + è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰
    window.deleteOrdersForTable = async () => {
      const confirmed = await showCustomConfirm({ icon: 'ğŸ—‘ï¸', title: 'å‰Šé™¤ç¢ºèª', message: 'æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ' });
      if (!confirmed) return;
      try {
        for (const o of currentOrders) await updateDoc(doc(db, 'stores', currentStoreId, 'orders', o.id), { deleted: true });
        await showCustomConfirm({ icon: 'ğŸ—‘ï¸', title: 'å®Œäº†', message: 'å‰Šé™¤ã—ã¾ã—ãŸ', btnText: 'OK' });
        location.reload();
      } catch (e) { alert('å¤±æ•—ã—ã¾ã—ãŸ'); }
    };

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ« + è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰
    window.cancelOrdersForTable = async () => {
      const confirmed = await showCustomConfirm({ icon: 'â¸ï¸', title: 'å–æ¶ˆç¢ºèª', message: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ' });
      if (!confirmed) return;
      try {
        const now = serverTimestamp();
        for (const o of currentOrders) await updateDoc(doc(db, 'stores', currentStoreId, 'orders', o.id), { cancelledAt: now });
        await showCustomConfirm({ icon: 'â¸ï¸', title: 'å®Œäº†', message: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ', btnText: 'OK' });
        location.reload();
      } catch (e) { alert('å¤±æ•—ã—ã¾ã—ãŸ'); }
    };

    // ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡
    window.showCustomConfirm = (opt) => {
      return new Promise(res => {
        customModalResolve = res;
        const m = document.getElementById('customConfirmModal');
        document.getElementById('modalIcon').textContent = opt.icon || 'âš ï¸';
        document.getElementById('modalTitle').textContent = opt.title;
        document.getElementById('modalMessage').textContent = opt.message;
        document.getElementById('modalConfirmBtn').textContent = opt.btnText || 'ã¯ã„';
        document.getElementById('modalConfirmBtn').onclick = () => { m.classList.add('hidden'); res(true); };
        m.classList.remove('hidden');
      });
    };
    window.closeCustomModal = () => { document.getElementById('customConfirmModal').classList.add('hidden'); customModalResolve(false); };
    window.closePaymentModal = () => document.getElementById('paymentModal').classList.add('hidden');

    // åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', async () => {
      await loadStoreList();
      const sId = sessionStorage.getItem('handyStoreId');
      if (sId && storesData[sId]) {
        currentStoreId = sId;
        currentStoreName = sessionStorage.getItem('handyStoreName');
        showTablesScreen();
      }
    });
  </script>
</body>
</html>