<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>„Éè„É≥„Éá„Ç£„Ç∑„Çπ„ÉÜ„É† - ‰ºöË®àÊ©üËÉΩ‰ªò„Åç</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ */
    .login-screen {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .login-screen h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 28px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .login-btn:active {
      transform: scale(0.98);
    }
    
    /* „ÉÜ„Éº„Éñ„É´‰∏ÄË¶ßÁîªÈù¢ */
    .tables-screen {
      display: none;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .header h2 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    /* „É¢„Éº„ÉâÂàá„ÇäÊõø„Åà„Éú„Çø„É≥ */
    .mode-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .mode-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .mode-btn.active {
      background: #667eea;
      color: white;
    }
    
    .mode-btn:active {
      transform: scale(0.95);
    }
    
    .store-info {
      color: #666;
      font-size: 14px;
    }
    
    .logout-btn {
      margin-top: 15px;
      padding: 10px 20px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
    }
    
    .logout-btn:active {
      transform: scale(0.98);
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .table-card {
      background: white;
      border-radius: 15px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    
    .table-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .table-card:active {
      transform: translateY(-2px);
    }
    
    .table-card .table-name {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .table-card .table-status {
      font-size: 12px;
      color: #999;
    }
    
    /* ‰ºöË®à„É¢„Éº„ÉâÁî®„Çπ„Çø„Ç§„É´ */
    .table-card.payment-mode {
      cursor: default;
      padding: 20px;
    }
    
    .table-card.has-orders {
      border: 3px solid #4CAF50;
    }
    
    .table-card.has-incomplete-orders {
      border: 3px solid #FF9800 !important;
      background: #fff3e0;
    }
    
    .table-card.all-paid {
      border: 3px solid #2196F3;
    }
    
    .table-card .order-info {
      margin-top: 10px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 12px;
    }
    
    .table-card .order-total {
      font-size: 20px;
      font-weight: bold;
      color: #4CAF50;
      margin: 10px 0;
    }
    
    .table-card .payment-btn {
      width: 100%;
      padding: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .table-card .payment-btn:active {
      transform: scale(0.95);
    }
    
    .table-card .no-orders {
      color: #999;
      font-size: 12px;
      margin-top: 10px;
    }
    
    .table-card .status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    
    .table-card .status-badge.paid {
      background: #2196F3;
      color: white;
    }
    
    .table-card .status-badge.incomplete {
      background: #FF9800;
      color: white;
    }
    
    .hidden {
      display: none !important;
    }
    
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }
    
    /* „Ç´„Çπ„Çø„É†„É¢„Éº„ÉÄ„É´ */
    .custom-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.2s ease-out;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    .custom-modal-box {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-icon {
      font-size: 60px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      color: #333;
      margin-bottom: 15px;
    }
    
    .modal-message {
      font-size: 16px;
      text-align: center;
      color: #666;
      margin-bottom: 25px;
      white-space: pre-line;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modal-btn:active {
      transform: scale(0.95);
    }
    
    .modal-btn-cancel {
      background: #e0e0e0;
      color: #666;
    }
    
    .modal-btn-success {
      background: #4CAF50;
      color: white;
    }
    
    .modal-btn-danger {
      background: #f44336;
      color: white;
    }
    
    /* ‰ºöË®à„É¢„Éº„ÉÄ„É´ */
    .payment-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.2s ease-out;
    }
    
    .payment-modal-content {
      background: white;
      border-radius: 20px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease-out;
    }
    
    .payment-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 20px 20px 0 0;
      position: sticky;
      top: 0;
      z-index: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .payment-header h2 {
      font-size: 20px;
      margin: 0;
    }
    
    .close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: normal;
    }
    
    .close-btn:active {
      transform: scale(0.9);
    }
    
    .payment-body {
      padding: 20px;
    }
    
    .order-section {
      margin-bottom: 20px;
    }
    
    .order-section-title {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
      padding-bottom: 8px;
      border-bottom: 2px solid #667eea;
    }
    
    .order-item {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    
    .order-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    
    .order-number {
      font-weight: bold;
      color: #667eea;
    }
    
    .order-time {
      color: #999;
      font-size: 12px;
    }
    
    .order-item-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background: white;
      border-radius: 8px;
      margin-bottom: 5px;
      transition: all 0.2s;
    }
    
    .order-item-checkbox.checked {
      background: #e8f5e9;
    }
    
    .order-item-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .order-item-info {
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .item-name {
      font-size: 14px;
    }
    
    .item-price {
      font-weight: bold;
      color: #333;
    }
    
    .check-status {
      text-align: center;
      padding: 10px;
      background: #e3f2fd;
      border-radius: 8px;
      margin-bottom: 15px;
      font-weight: bold;
      color: #1976d2;
    }
    
    .order-total-section {
      background: #fff3e0;
      padding: 15px;
      border-radius: 10px;
      margin-top: 10px;
    }
    
    .order-total-row {
      display: flex;
      justify-content: space-between;
      font-size: 18px;
      font-weight: bold;
      color: #FF9800;
    }
    
    .payment-summary {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 16px;
    }
    
    .summary-row.total {
      font-size: 28px;
      font-weight: bold;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .payment-methods {
      margin-bottom: 20px;
    }
    
    .payment-methods h3 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #333;
    }
    
    .payment-method-btn {
      width: 100%;
      padding: 15px;
      margin-bottom: 10px;
      border: 2px solid #ddd;
      background: white;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .payment-method-btn:active {
      transform: scale(0.98);
    }
    
    .payment-method-btn.selected {
      border-color: #4CAF50;
      background: #e8f5e9;
      color: #4CAF50;
    }
    
    .payment-method-icon {
      font-size: 24px;
    }
    
    .cash-input-group {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 10px;
    }
    
    .cash-input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    
    .cash-input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 18px;
      text-align: right;
    }
    
    .quick-amounts {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    
    .quick-amount-btn {
      padding: 10px;
      background: white;
      border: 2px solid #667eea;
      color: #667eea;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .quick-amount-btn:active {
      transform: scale(0.95);
    }
    
    .change-display {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background: #fff3e0;
      border-radius: 10px;
      text-align: center;
    }
    
    .change-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .change-amount {
      font-size: 32px;
      font-weight: bold;
      color: #FF9800;
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    
    .action-btn {
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .action-btn:active {
      transform: scale(0.95);
    }
    
    .btn-complete {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      grid-column: 1 / -1;
    }
    
    .btn-cancel {
      background: #FF9800;
      color: white;
    }
    
    .btn-delete {
      background: #f44336;
      color: white;
    }
    
    .btn-adjust {
      background: #2196F3;
      color: white;
    }
    
    .btn-discount {
      background: #9C27B0;
      color: white;
    }
    
    .btn-payment {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      grid-column: 1 / -1;
      font-size: 18px;
      padding: 18px;
    }
    
    /* ÈáëÈ°çË™øÊï¥„É¢„Éº„ÉÄ„É´ */
    .adjust-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 11000;
      justify-content: center;
      align-items: center;
    }
    
    .adjust-modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
    }
    
    .adjust-modal h3 {
      font-size: 20px;
      margin-bottom: 20px;
      text-align: center;
      color: #333;
    }
    
    .adjust-input-group {
      margin-bottom: 20px;
    }
    
    .adjust-input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    
    .adjust-input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 18px;
      text-align: right;
    }
    
    .adjust-buttons {
      display: flex;
      gap: 10px;
    }
    
    .adjust-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .btn-adjust-cancel {
      background: #e0e0e0;
      color: #666;
    }
    
    .btn-adjust-confirm {
      background: #4CAF50;
      color: white;
    }
  </style>
</head>
<body>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc, doc, Timestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.updateDoc = updateDoc;
    window.doc = doc;
    window.Timestamp = Timestamp;
    window.onSnapshot = onSnapshot;
    window.firebaseReady = true;
    
    console.log('‚úÖ FirebaseÂàùÊúüÂåñÂÆå‰∫Ü');
  </script>

  <!-- „Çø„ÉÉ„ÉóÈü≥Áî®„ÅÆ„Ç™„Éº„Éá„Ç£„Ç™ -->
  <audio id="tapSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=" type="audio/wav">
  </audio>

  <div class="container">
    <!-- „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ -->
    <div class="login-screen" id="loginScreen">
      <h1>üçú „Éè„É≥„Éá„Ç£„Ç∑„Çπ„ÉÜ„É†</h1>
      <div class="form-group">
        <label>Â∫óËàó„ÇíÈÅ∏Êäû</label>
        <select id="storeSelect">
          <option value="">Ë™≠„ÅøËæº„Åø‰∏≠...</option>
        </select>
      </div>
      <button class="login-btn" onclick="login()">„É≠„Ç∞„Ç§„É≥</button>
    </div>

    <!-- „ÉÜ„Éº„Éñ„É´‰∏ÄË¶ßÁîªÈù¢ -->
    <div class="tables-screen" id="tablesScreen">
      <div class="header">
        <h2 id="headerTitle">„Éè„É≥„Éá„Ç£„Ç∑„Çπ„ÉÜ„É†</h2>
        <div class="mode-toggle">
          <button class="mode-btn active" id="orderModeBtn" onclick="switchMode('order')">Ê≥®Êñá„É¢„Éº„Éâ</button>
          <button class="mode-btn" id="paymentModeBtn" onclick="switchMode('payment')">‰ºöË®à„É¢„Éº„Éâ</button>
        </div>
        <div class="store-info" id="storeInfo">Â∫óËàó: Êú™ÈÅ∏Êäû</div>
        <button class="logout-btn" onclick="logout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
      </div>

      <div class="tables-grid" id="tablesGrid">
        <!-- „ÉÜ„Éº„Éñ„É´„Ç´„Éº„Éâ„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Çã -->
      </div>
    </div>
  </div>

  <!-- „Ç´„Çπ„Çø„É†Á¢∫Ë™ç„É¢„Éº„ÉÄ„É´ -->
  <div class="custom-modal-overlay" id="customModal">
    <div class="custom-modal-box">
      <div class="modal-icon" id="modalIcon">‚úÖ</div>
      <div class="modal-title" id="modalTitle">Á¢∫Ë™ç</div>
      <div class="modal-message" id="modalMessage">„É°„ÉÉ„Çª„Éº„Ç∏</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeCustomModal(false)">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="modal-btn modal-btn-success" id="modalConfirmBtn" onclick="closeCustomModal(true)">OK</button>
      </div>
    </div>
  </div>

  <!-- ‰ºöË®à„É¢„Éº„ÉÄ„É´ -->
  <div class="payment-modal" id="paymentModal">
    <div class="payment-modal-content">
      <div class="payment-header">
        <h2 id="paymentTableName">„ÉÜ„Éº„Éñ„É´ 1</h2>
        <button class="close-btn" onclick="closePaymentModal()">√ó</button>
      </div>
      <div class="payment-body" id="paymentBody">
        <!-- ÂÜÖÂÆπ„ÅåÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã -->
      </div>
    </div>
  </div>

  <!-- ÈáëÈ°çË™øÊï¥„É¢„Éº„ÉÄ„É´ -->
  <div class="adjust-modal" id="adjustModal">
    <div class="adjust-modal-content">
      <h3 id="adjustModalTitle">ÈáëÈ°çÂ§âÊõ¥</h3>
      <div class="adjust-input-group">
        <label id="adjustInputLabel">Êñ∞„Åó„ÅÑÈáëÈ°ç„ÇíÂÖ•Âäõ</label>
        <input type="number" id="adjustInput" placeholder="0">
      </div>
      <div class="adjust-buttons">
        <button class="btn-adjust-cancel" onclick="closeAdjustModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="btn-adjust-confirm" onclick="confirmAdjustment()">Á¢∫ÂÆö</button>
      </div>
    </div>
  </div>

  <script>
    // ========== „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞ ==========
    let storesData = {};
    let currentStoreId = null;
    let currentStoreName = null;
    let currentMode = 'order'; // 'order' or 'payment'
    let tablesData = [];
    let ordersData = {};
    let currentPaymentOrders = [];
    let selectedPaymentMethod = null;
    let itemCheckStatus = {};
    let modalResolve = null;
    let ordersListener = null;
    let adjustmentType = null; // 'price' or 'discount'
    let currentAdjustOrderId = null;
    
    // ========== „Çø„ÉÉ„ÉóÈü≥ÂÜçÁîü ==========
    function playTapSound() {
      const audio = document.getElementById('tapSound');
      audio.currentTime = 0;
      audio.play().catch(e => console.log('Èü≥Â£∞ÂÜçÁîü„Ç®„É©„Éº:', e));
    }
    
    // ========== Â∫óËàó„É™„Çπ„ÉàË™≠„ÅøËæº„Åø ==========
    async function loadStoreList() {
      try {
        console.log('üè™ Â∫óËàó„É™„Çπ„Éà„ÇíË™≠„ÅøËæº„Åø‰∏≠...');
        
        const storesRef = window.collection(window.db, 'stores');
        const storesSnapshot = await window.getDocs(storesRef);
        
        storesData = {};
        storesSnapshot.forEach(doc => {
          storesData[doc.id] = doc.data();
        });
        
        console.log('‚úÖ Â∫óËàó„É™„Çπ„Éà:', storesData);
        
        const storeSelect = document.getElementById('storeSelect');
        storeSelect.innerHTML = '<option value="">Â∫óËàó„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
        
        Object.keys(storesData).forEach(storeId => {
          const store = storesData[storeId];
          const option = document.createElement('option');
          option.value = storeId;
          option.textContent = store.name || storeId;
          storeSelect.appendChild(option);
        });
        
      } catch (error) {
        console.error('‚ùå Â∫óËàó„É™„Çπ„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      }
    }
    
    // ========== „É≠„Ç∞„Ç§„É≥ ==========
    function login() {
      playTapSound();
      const storeSelect = document.getElementById('storeSelect');
      const selectedStoreId = storeSelect.value;
      
      if (!selectedStoreId) {
        alert('Â∫óËàó„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }
      
      currentStoreId = selectedStoreId;
      currentStoreName = storesData[selectedStoreId].name;
      
      sessionStorage.setItem('handyStoreId', currentStoreId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      
      console.log('‚úÖ „É≠„Ç∞„Ç§„É≥:', currentStoreName);
      
      showTablesScreen();
    }
    
    // ========== „É≠„Ç∞„Ç¢„Ç¶„Éà ==========
    async function logout() {
      playTapSound();
      const confirmed = await showCustomModal({
        icon: 'üö™',
        title: '„É≠„Ç∞„Ç¢„Ç¶„Éà',
        message: '„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü',
        btnText: '„É≠„Ç∞„Ç¢„Ç¶„Éà',
        btnClass: 'modal-btn-danger'
      });
      
      if (confirmed) {
        // „É™„Çπ„Éä„Éº„ÇíËß£Èô§
        if (ordersListener) {
          ordersListener();
          ordersListener = null;
        }
        
        sessionStorage.removeItem('handyStoreId');
        sessionStorage.removeItem('handyStoreName');
        location.reload();
      }
    }
    
    // ========== „ÉÜ„Éº„Éñ„É´‰∏ÄË¶ßÁîªÈù¢Ë°®Á§∫ ==========
    async function showTablesScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('tablesScreen').style.display = 'block';
      document.getElementById('headerTitle').textContent = currentStoreName + ' - „Éè„É≥„Éá„Ç£';
      document.getElementById('storeInfo').textContent = 'Â∫óËàó: ' + currentStoreName;
      
      await loadTables();
      startOrdersListener();
    }
    
    // ========== „ÉÜ„Éº„Éñ„É´Ë™≠„ÅøËæº„Åø ==========
    async function loadTables() {
      try {
        console.log('ü™ë „ÉÜ„Éº„Éñ„É´ÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø‰∏≠...');
        
        const tablesRef = window.collection(window.db, 'stores', currentStoreId, 'tables');
        const tablesSnapshot = await window.getDocs(tablesRef);
        
        tablesData = [];
        tablesSnapshot.forEach(doc => {
          tablesData.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        tablesData.sort((a, b) => (a.order || 0) - (b.order || 0));
        
        console.log('‚úÖ „ÉÜ„Éº„Éñ„É´:', tablesData);
        
        renderTables();
        
      } catch (error) {
        console.error('‚ùå „ÉÜ„Éº„Éñ„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      }
    }
    
    // ========== Ê≥®Êñá„É™„Ç¢„É´„Çø„Ç§„É†„É™„Çπ„Éä„Éº ==========
    function startOrdersListener() {
      if (ordersListener) {
        ordersListener();
      }
      
      console.log('üëÇ Ê≥®Êñá„É™„Ç¢„É´„Çø„Ç§„É†„É™„Çπ„Éä„ÉºÈñãÂßã');
      
      const ordersRef = window.collection(window.db, 'stores', currentStoreId, 'orders');
      const q = window.query(ordersRef, window.where('deleted', '!=', true));
      
      ordersListener = window.onSnapshot(q, (snapshot) => {
        console.log('üîÑ Ê≥®Êñá„Éá„Éº„ÇøÊõ¥Êñ∞:', snapshot.size, '‰ª∂');
        
        ordersData = {};
        snapshot.forEach(doc => {
          const order = {
            id: doc.id,
            ...doc.data()
          };
          
          const tableId = order.tableId;
          if (!ordersData[tableId]) {
            ordersData[tableId] = [];
          }
          ordersData[tableId].push(order);
        });
        
        console.log('üì¶ Ê≥®Êñá„Éá„Éº„Çø:', ordersData);
        
        renderTables();
      }, (error) => {
        console.error('‚ùå Ê≥®Êñá„É™„Çπ„Éä„Éº„Ç®„É©„Éº:', error);
      });
    }
    
    // ========== „ÉÜ„Éº„Éñ„É´ÊèèÁîª ==========
    function renderTables() {
      const grid = document.getElementById('tablesGrid');
      grid.innerHTML = '';
      
      tablesData.forEach(table => {
        const card = document.createElement('div');
        card.className = 'table-card';
        
        if (currentMode === 'payment') {
          card.classList.add('payment-mode');
          renderPaymentCard(card, table);
        } else {
          // Ê≥®Êñá„É¢„Éº„Éâ: order.html„Å∏„ÅÆ„É™„É≥„ÇØ
          card.onclick = () => {
            playTapSound();
            window.location.href = `order.html?store=${currentStoreId}&table=${table.id}`;
          };
          
          const name = document.createElement('div');
          name.className = 'table-name';
          name.textContent = table.name || `„ÉÜ„Éº„Éñ„É´ ${table.id}`;
          card.appendChild(name);
          
          const status = document.createElement('div');
          status.className = 'table-status';
          status.textContent = 'Ê≥®ÊñáÂèØËÉΩ';
          card.appendChild(status);
        }
        
        grid.appendChild(card);
      });
    }
    
    // ========== ‰ºöË®à„É¢„Éº„ÉâÁî®„Ç´„Éº„ÉâÊèèÁîª ==========
    function renderPaymentCard(card, table) {
      const orders = ordersData[table.id] || [];
      const activeOrders = orders.filter(o => !o.paidAt && !o.cancelledAt && !o.deleted);
      
      const name = document.createElement('div');
      name.className = 'table-name';
      name.textContent = table.name || `„ÉÜ„Éº„Éñ„É´ ${table.id}`;
      card.appendChild(name);
      
      if (activeOrders.length === 0) {
        const noOrders = document.createElement('div');
        noOrders.className = 'no-orders';
        noOrders.textContent = 'Ê≥®Êñá„Å™„Åó';
        card.appendChild(noOrders);
        return;
      }
      
      const totalAmount = activeOrders.reduce((sum, order) => {
        return sum + (order.totalAmount || 0);
      }, 0);
      
      // Êú™ÂÆå‰∫Ü„ÅÆÊ≥®Êñá„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
      const hasIncomplete = activeOrders.some(o => !o.completedAt);
      
      if (hasIncomplete) {
        card.classList.add('has-incomplete-orders');
        const badge = document.createElement('div');
        badge.className = 'status-badge incomplete';
        badge.textContent = 'Êú™ÂÆå‰∫Ü';
        card.appendChild(badge);
      } else {
        card.classList.add('has-orders');
      }
      
      const info = document.createElement('div');
      info.className = 'order-info';
      info.textContent = `${activeOrders.length}‰ª∂„ÅÆÊ≥®Êñá`;
      card.appendChild(info);
      
      const total = document.createElement('div');
      total.className = 'order-total';
      total.textContent = '¬•' + totalAmount.toLocaleString();
      card.appendChild(total);
      
      const btn = document.createElement('button');
      btn.className = 'payment-btn';
      btn.textContent = '‰ºöË®à„Åô„Çã';
      btn.onclick = (e) => {
        e.stopPropagation();
        playTapSound();
        openPaymentModal(table, activeOrders);
      };
      card.appendChild(btn);
    }
    
    // ========== „É¢„Éº„ÉâÂàá„ÇäÊõø„Åà ==========
    function switchMode(mode) {
      playTapSound();
      currentMode = mode;
      
      document.getElementById('orderModeBtn').classList.toggle('active', mode === 'order');
      document.getElementById('paymentModeBtn').classList.toggle('active', mode === 'payment');
      
      renderTables();
    }
    
    // ========== „Ç´„Çπ„Çø„É†„É¢„Éº„ÉÄ„É´ ==========
    function showCustomModal(options) {
      return new Promise((resolve) => {
        modalResolve = resolve;
        
        document.getElementById('modalIcon').textContent = options.icon || '‚úÖ';
        document.getElementById('modalTitle').textContent = options.title || 'Á¢∫Ë™ç';
        document.getElementById('modalMessage').textContent = options.message || '';
        
        const confirmBtn = document.getElementById('modalConfirmBtn');
        confirmBtn.textContent = options.btnText || 'OK';
        confirmBtn.className = 'modal-btn ' + (options.btnClass || 'modal-btn-success');
        
        document.getElementById('customModal').style.display = 'flex';
      });
    }
    
    function closeCustomModal(result) {
      playTapSound();
      document.getElementById('customModal').style.display = 'none';
      if (modalResolve) {
        modalResolve(result);
        modalResolve = null;
      }
    }
    
    // ========== ‰ºöË®à„É¢„Éº„ÉÄ„É´ ==========
    function openPaymentModal(table, orders) {
      currentPaymentOrders = orders;
      itemCheckStatus = {};
      
      document.getElementById('paymentTableName').textContent = table.name || `„ÉÜ„Éº„Éñ„É´ ${table.id}`;
      
      let content = '';
      
      // „ÉÅ„Çß„ÉÉ„ÇØÁä∂ÊÖãË°®Á§∫
      content += `<div class="check-status" id="checkStatus">0 / 0 ÂÆå‰∫Ü</div>`;
      
      // Ê≥®ÊñáË©≥Á¥∞
      content += `<div class="order-section">`;
      content += `<div class="order-section-title">üìù Ê≥®ÊñáË©≥Á¥∞</div>`;
      
      orders.forEach((order, orderIdx) => {
        content += `<div class="order-item">`;
        content += `<div class="order-item-header">`;
        content += `<span class="order-number">Ê≥®Êñá #${order.orderNumber || order.id.slice(-4)}</span>`;
        content += `<span class="order-time">${formatTime(order.createdAt)}</span>`;
        content += `</div>`;
        
        (order.items || []).forEach((item, itemIdx) => {
          const checkboxId = `check-${orderIdx}-${itemIdx}`;
          const isChecked = item.served || false;
          itemCheckStatus[checkboxId] = isChecked;
          
          content += `<div class="order-item-checkbox ${isChecked ? 'checked' : ''}" id="checkbox-${checkboxId}">`;
          content += `<input type="checkbox" id="${checkboxId}" ${isChecked ? 'checked' : ''} onchange="toggleItemCheck('${checkboxId}')">`;
          content += `<div class="order-item-info">`;
          content += `<div class="item-name">${item.name} x${item.quantity}</div>`;
          content += `<div class="item-price">¬•${((item.price || 0) * item.quantity).toLocaleString()}</div>`;
          content += `</div>`;
          content += `</div>`;
        });
        
        content += `<div class="order-total-section">`;
        content += `<div class="order-total-row">`;
        content += `<span>Â∞èË®à</span>`;
        content += `<span>¬•${(order.totalAmount || 0).toLocaleString()}</span>`;
        content += `</div>`;
        content += `</div>`;
        
        content += `</div>`;
      });
      
      content += `</div>`;
      
      // ÂêàË®àÈáëÈ°ç
      const totalAmount = orders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      const orderCount = orders.length;
      
      content += `<div class="payment-summary">`;
      content += `<div class="summary-row"><span>Ê≥®Êñá‰ª∂Êï∞</span><span>${orderCount}‰ª∂</span></div>`;
      content += `<div class="summary-row total"><span>ÂêàË®à</span><span>¬•${totalAmount.toLocaleString()}</span></div>`;
      content += `</div>`;
      
      // ÊîØÊâï„ÅÑÊñπÊ≥ï
      content += `<div class="payment-methods">`;
      content += `<h3>üí≥ ÊîØÊâï„ÅÑÊñπÊ≥ï„ÇíÈÅ∏Êäû</h3>`;
      content += `<button class="payment-method-btn" id="methodCash" onclick="selectPaymentMethod('cash')">`;
      content += `<span class="payment-method-icon">üíµ</span><span>ÁèæÈáë</span>`;
      content += `</button>`;
      content += `<button class="payment-method-btn" id="methodCard" onclick="selectPaymentMethod('card')">`;
      content += `<span class="payment-method-icon">üí≥</span><span>„ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„Éâ</span>`;
      content += `</button>`;
      content += `<button class="payment-method-btn" id="methodEmoney" onclick="selectPaymentMethod('emoney')">`;
      content += `<span class="payment-method-icon">üì±</span><span>ÈõªÂ≠ê„Éû„Éç„Éº</span>`;
      content += `</button>`;
      content += `</div>`;
      
      // ÁèæÈáëÂÖ•Âäõ
      content += `<div class="cash-input-group" id="cashInputGroup">`;
      content += `<label>„ÅäÈ†ê„Åã„ÇäÈáëÈ°ç</label>`;
      content += `<input type="number" id="cashReceived" placeholder="0" oninput="calculateChange()">`;
      content += `<div class="quick-amounts">`;
      content += `<button class="quick-amount-btn" onclick="setQuickAmount(1000)">1,000ÂÜÜ</button>`;
      content += `<button class="quick-amount-btn" onclick="setQuickAmount(2000)">2,000ÂÜÜ</button>`;
      content += `<button class="quick-amount-btn" onclick="setQuickAmount(5000)">5,000ÂÜÜ</button>`;
      content += `<button class="quick-amount-btn" onclick="setQuickAmount(10000)">10,000ÂÜÜ</button>`;
      content += `<button class="quick-amount-btn" onclick="setQuickAmount(0)">„ÇØ„É™„Ç¢</button>`;
      content += `<button class="quick-amount-btn" onclick="setQuickAmount(${totalAmount})">„Éî„ÉÉ„Çø„É™</button>`;
      content += `</div>`;
      content += `</div>`;
      
      // „ÅäÈá£„ÇäË°®Á§∫
      content += `<div class="change-display" id="changeDisplay">`;
      content += `<div class="change-label">„ÅäÈá£„Çä</div>`;
      content += `<div class="change-amount" id="changeAmount">¬•0</div>`;
      content += `</div>`;
      
      // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥
      content += `<div class="action-buttons">`;
      content += `<button class="action-btn btn-adjust" onclick="openAdjustModal('price')">üí∞ ÈáëÈ°çÂ§âÊõ¥</button>`;
      content += `<button class="action-btn btn-discount" onclick="openAdjustModal('discount')">üè∑Ô∏è ÂÄ§Âºï„Åç</button>`;
      content += `<button class="action-btn btn-complete" id="completeOrderBtn" onclick="markOrderComplete()" disabled style="opacity: 0.5;">‚úÖ ÂÆå‰∫Ü</button>`;
      content += `<button class="action-btn btn-cancel" onclick="cancelOrder()">‚è∏ „Ç≠„É£„É≥„Çª„É´</button>`;
      content += `<button class="action-btn btn-delete" onclick="deleteOrder()">üóë ÂâäÈô§</button>`;
      content += `<button class="action-btn btn-payment" id="paymentBtn" onclick="completePayment()" disabled style="opacity: 0.5;">üí≥ ‰ºöË®àÂÆå‰∫Ü</button>`;
      content += `</div>`;
      
      document.getElementById('paymentBody').innerHTML = content;
      
      updateCheckStatus();
      updateCompleteButtonState();
      
      document.getElementById('paymentModal').style.display = 'flex';
    }
    
    function closePaymentModal() {
      playTapSound();
      document.getElementById('paymentModal').style.display = 'none';
      currentPaymentOrders = [];
      selectedPaymentMethod = null;
      itemCheckStatus = {};
    }
    
    // ========== ÊôÇÂàª„Éï„Ç©„Éº„Éû„ÉÉ„Éà ==========
    function formatTime(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const h = date.getHours().toString().padStart(2, '0');
      const m = date.getMinutes().toString().padStart(2, '0');
      return `${h}:${m}`;
    }
    
    // ========== „ÉÅ„Çß„ÉÉ„ÇØÂá¶ÁêÜ ==========
    function toggleItemCheck(checkboxId) {
      playTapSound();
      itemCheckStatus[checkboxId] = document.getElementById(checkboxId).checked;
      
      const checkboxDiv = document.querySelector(`#checkbox-${checkboxId}`);
      if (itemCheckStatus[checkboxId]) {
        checkboxDiv.classList.add('checked');
      } else {
        checkboxDiv.classList.remove('checked');
      }
      
      updateCheckStatus();
      updateCompleteButtonState();
    }
    
    function updateCheckStatus() {
      const total = Object.keys(itemCheckStatus).length;
      const checked = Object.values(itemCheckStatus).filter(v => v).length;
      
      document.getElementById('checkStatus').textContent = `${checked} / ${total} ÂÆå‰∫Ü`;
    }
    
    function updateCompleteButtonState() {
      const allChecked = Object.values(itemCheckStatus).every(v => v);
      const completeBtn = document.getElementById('completeOrderBtn');
      
      if (allChecked && Object.keys(itemCheckStatus).length > 0) {
        completeBtn.disabled = false;
        completeBtn.style.opacity = '1';
      } else {
        completeBtn.disabled = true;
        completeBtn.style.opacity = '0.5';
      }
    }
    
    // ========== ÊîØÊâï„ÅÑÊñπÊ≥ïÈÅ∏Êäû ==========
    function selectPaymentMethod(method) {
      playTapSound();
      selectedPaymentMethod = method;
      
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      const paymentBtn = document.getElementById('paymentBtn');
      paymentBtn.disabled = false;
      paymentBtn.style.opacity = '1';
      
      if (method === 'cash') {
        document.getElementById('methodCash').classList.add('selected');
        document.getElementById('cashInputGroup').style.display = 'block';
        document.getElementById('changeDisplay').style.display = 'block';
      } else if (method === 'card') {
        document.getElementById('methodCard').classList.add('selected');
        document.getElementById('cashInputGroup').style.display = 'none';
        document.getElementById('changeDisplay').style.display = 'none';
      } else if (method === 'emoney') {
        document.getElementById('methodEmoney').classList.add('selected');
        document.getElementById('cashInputGroup').style.display = 'none';
        document.getElementById('changeDisplay').style.display = 'none';
      }
    }
    
    // ========== ÁèæÈáë„ÇØ„Ç§„ÉÉ„ÇØÂÖ•Âäõ ==========
    function setQuickAmount(amount) {
      playTapSound();
      document.getElementById('cashReceived').value = amount;
      calculateChange();
    }
    
    function calculateChange() {
      const totalAmount = currentPaymentOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      const received = parseInt(document.getElementById('cashReceived').value) || 0;
      const change = received - totalAmount;
      
      const changeElement = document.getElementById('changeAmount');
      changeElement.textContent = '¬•' + Math.max(0, change).toLocaleString();
      
      if (change < 0) {
        changeElement.style.color = '#f44336';
      } else {
        changeElement.style.color = '#FF9800';
      }
    }
    
    // ========== ÈáëÈ°çË™øÊï¥„É¢„Éº„ÉÄ„É´ ==========
    function openAdjustModal(type) {
      playTapSound();
      adjustmentType = type;
      
      if (currentPaymentOrders.length === 0) return;
      
      currentAdjustOrderId = currentPaymentOrders[0].id;
      const currentAmount = currentPaymentOrders[0].totalAmount || 0;
      
      const modal = document.getElementById('adjustModal');
      const title = document.getElementById('adjustModalTitle');
      const label = document.getElementById('adjustInputLabel');
      const input = document.getElementById('adjustInput');
      
      if (type === 'price') {
        title.textContent = 'ÈáëÈ°çÂ§âÊõ¥';
        label.textContent = 'Êñ∞„Åó„ÅÑÈáëÈ°ç„ÇíÂÖ•Âäõ';
        input.value = currentAmount;
      } else {
        title.textContent = 'ÂÄ§Âºï„Åç';
        label.textContent = 'ÂÄ§Âºï„ÅçÈ°ç„ÇíÂÖ•Âäõ';
        input.value = '';
      }
      
      modal.style.display = 'flex';
    }
    
    function closeAdjustModal() {
      playTapSound();
      document.getElementById('adjustModal').style.display = 'none';
    }
    
    async function confirmAdjustment() {
      playTapSound();
      
      const input = document.getElementById('adjustInput');
      const value = parseInt(input.value) || 0;
      
      if (value < 0) {
        alert('Ê≠£„ÅÆÊï∞ÂÄ§„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }
      
      try {
        const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', currentAdjustOrderId);
        
        if (adjustmentType === 'price') {
          await window.updateDoc(orderRef, {
            totalAmount: value,
            adjustedAt: window.Timestamp.now()
          });
          
          await showCustomModal({
            icon: '‚úÖ',
            title: 'ÈáëÈ°çÂ§âÊõ¥ÂÆå‰∫Ü',
            message: `ÈáëÈ°ç„Çí¬•${value.toLocaleString()}„Å´Â§âÊõ¥„Åó„Åæ„Åó„Åü`,
            btnText: 'OK',
            btnClass: 'modal-btn-success'
          });
        } else {
          const currentAmount = currentPaymentOrders[0].totalAmount || 0;
          const newAmount = Math.max(0, currentAmount - value);
          
          await window.updateDoc(orderRef, {
            totalAmount: newAmount,
            discount: value,
            adjustedAt: window.Timestamp.now()
          });
          
          await showCustomModal({
            icon: '‚úÖ',
            title: 'ÂÄ§Âºï„ÅçÂÆå‰∫Ü',
            message: `¬•${value.toLocaleString()}„ÇíÂÄ§Âºï„Åç„Åó„Åæ„Åó„Åü\nÊñ∞„Åó„ÅÑÈáëÈ°ç: ¬•${newAmount.toLocaleString()}`,
            btnText: 'OK',
            btnClass: 'modal-btn-success'
          });
        }
        
        closeAdjustModal();
        closePaymentModal();
        
      } catch (error) {
        console.error('‚ùå Ë™øÊï¥„Ç®„É©„Éº:', error);
        alert('Ë™øÊï¥Âá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
      }
    }
    
    // ========== ‰ºöË®àÂÆå‰∫Ü ==========
    async function completePayment() {
      playTapSound();
      
      if (!selectedPaymentMethod) {
        alert('ÊîØÊâï„ÅÑÊñπÊ≥ï„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }
      
      const totalAmount = currentPaymentOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      
      if (selectedPaymentMethod === 'cash') {
        const received = parseInt(document.getElementById('cashReceived').value) || 0;
        
        if (received < totalAmount) {
          alert('„ÅäÈ†ê„Åã„ÇäÈáëÈ°ç„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô');
          return;
        }
        
        const change = received - totalAmount;
        
        const confirmed = await showCustomModal({
          icon: 'üí∞',
          title: '‰ºöË®àÂÆå‰∫ÜÁ¢∫Ë™ç',
          message: `ÊîØÊâï„ÅÑÊñπÊ≥ï: ÁèæÈáë\nÂêàË®à: ¬•${totalAmount.toLocaleString()}\n„ÅäÈ†ê„Åã„Çä: ¬•${received.toLocaleString()}\n„ÅäÈá£„Çä: ¬•${change.toLocaleString()}\n\n‰ºöË®à„ÇíÂÆå‰∫Ü„Åó„Åæ„Åô„ÅãÔºü`,
          btnText: 'ÂÆå‰∫Ü',
          btnClass: 'modal-btn-success'
        });
        
        if (!confirmed) return;
      } else {
        const methodName = selectedPaymentMethod === 'card' ? '„ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„Éâ' : 'ÈõªÂ≠ê„Éû„Éç„Éº';
        
        const confirmed = await showCustomModal({
          icon: 'üí≥',
          title: '‰ºöË®àÂÆå‰∫ÜÁ¢∫Ë™ç',
          message: `ÊîØÊâï„ÅÑÊñπÊ≥ï: ${methodName}\nÂêàË®à: ¬•${totalAmount.toLocaleString()}\n\n‰ºöË®à„ÇíÂÆå‰∫Ü„Åó„Åæ„Åô„ÅãÔºü`,
          btnText: 'ÂÆå‰∫Ü',
          btnClass: 'modal-btn-success'
        });
        
        if (!confirmed) return;
      }
      
      try {
        const now = window.Timestamp.now();
        
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          await window.updateDoc(orderRef, {
            paidAt: now,
            paymentMethod: selectedPaymentMethod
          });
        }
        
        console.log('‚úÖ ‰ºöË®àÂÆå‰∫Ü:', currentPaymentOrders.length, '‰ª∂');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: '‚úÖ',
          title: '‰ºöË®àÂÆå‰∫Ü',
          message: `‰ºöË®à„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü\n\n${currentPaymentOrders.length}‰ª∂„ÅÆÊ≥®Êñá„ÇíÂá¶ÁêÜ„Åó„Åæ„Åó„Åü`,
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('‚ùå ‰ºöË®à„Ç®„É©„Éº:', error);
        alert('‰ºöË®àÂá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
      }
    }
    
    // ========== Ê≥®ÊñáÂÆå‰∫Ü ==========
    async function markOrderComplete() {
      playTapSound();
      
      const allChecked = Object.values(itemCheckStatus).every(v => v);
      
      if (!allChecked) {
        alert('ÂÖ®„Å¶„ÅÆÂïÜÂìÅ„ÇíÊèê‰æõ„Åó„Å¶„Åã„Çâ„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }
      
      const confirmed = await showCustomModal({
        icon: '‚úÖ',
        title: 'Ê≥®ÊñáÂÆå‰∫ÜÁ¢∫Ë™ç',
        message: 'ÂÖ®„Å¶„ÅÆÂïÜÂìÅ„ÇíÊèê‰æõÊ∏à„Åø„Å´„Åó„Å¶„ÄÅÊ≥®Êñá„ÇíÂÆå‰∫Ü„Åó„Åæ„Åô„ÅãÔºü',
        btnText: 'ÂÆå‰∫Ü',
        btnClass: 'modal-btn-success'
      });
      
      if (!confirmed) return;
      
      try {
        const now = window.Timestamp.now();
        
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          const updatedItems = order.items.map(item => ({
            ...item,
            served: true
          }));
          
          await window.updateDoc(orderRef, {
            completedAt: now,
            items: updatedItems
          });
        }
        
        console.log('‚úÖ Ê≥®ÊñáÂÆå‰∫Ü:', currentPaymentOrders.length, '‰ª∂');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: '‚úÖ',
          title: 'Ê≥®ÊñáÂÆå‰∫Ü',
          message: 'Ê≥®Êñá„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü',
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('‚ùå ÂÆå‰∫Ü„Ç®„É©„Éº:', error);
        alert('ÂÆå‰∫ÜÂá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
      }
    }
    
    // ========== „Ç≠„É£„É≥„Çª„É´ ==========
    async function cancelOrder() {
      playTapSound();
      
      const confirmed = await showCustomModal({
        icon: '‚è∏',
        title: 'Ê≥®Êñá„Ç≠„É£„É≥„Çª„É´Á¢∫Ë™ç',
        message: '„Åì„ÅÆÊ≥®Êñá„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åô„ÅãÔºü',
        btnText: '„Ç≠„É£„É≥„Çª„É´',
        btnClass: 'modal-btn-danger'
      });
      
      if (!confirmed) return;
      
      try {
        const now = window.Timestamp.now();
        
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          await window.updateDoc(orderRef, {
            cancelledAt: now
          });
        }
        
        console.log('‚úÖ Ê≥®Êñá„Ç≠„É£„É≥„Çª„É´:', currentPaymentOrders.length, '‰ª∂');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: '‚úÖ',
          title: '„Ç≠„É£„É≥„Çª„É´ÂÆå‰∫Ü',
          message: 'Ê≥®Êñá„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åó„Åü',
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('‚ùå „Ç≠„É£„É≥„Çª„É´„Ç®„É©„Éº:', error);
        alert('„Ç≠„É£„É≥„Çª„É´Âá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
      }
    }
    
    // ========== ÂâäÈô§ ==========
    async function deleteOrder() {
      playTapSound();
      
      const confirmed = await showCustomModal({
        icon: 'üóë',
        title: 'Ê≥®ÊñáÂâäÈô§Á¢∫Ë™ç',
        message: '„Åì„ÅÆÊ≥®Êñá„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü\nÔºà„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„ÇìÔºâ',
        btnText: 'ÂâäÈô§',
        btnClass: 'modal-btn-danger'
      });
      
      if (!confirmed) return;
      
      try {
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          await window.updateDoc(orderRef, {
            deleted: true,
            deletedAt: window.Timestamp.now()
          });
        }
        
        console.log('‚úÖ Ê≥®ÊñáÂâäÈô§:', currentPaymentOrders.length, '‰ª∂');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: '‚úÖ',
          title: 'ÂâäÈô§ÂÆå‰∫Ü',
          message: 'Ê≥®Êñá„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü',
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('‚ùå ÂâäÈô§„Ç®„É©„Éº:', error);
        alert('ÂâäÈô§Âá¶ÁêÜ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message);
      }
    }
    
    // ========== „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ ==========
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('üì± „Éè„É≥„Éá„Ç£„Ç∑„Çπ„ÉÜ„É†Ëµ∑Âãï');
      
      while (!window.firebaseReady || !window.db) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      console.log('‚úÖ FirebaseÊ∫ñÂÇôÂÆå‰∫Ü„ÄÅÂ∫óËàó„É™„Çπ„Éà„ÇíË™≠„ÅøËæº„Åø„Åæ„Åô');
      
      await loadStoreList();
      
      const savedStoreId = sessionStorage.getItem('handyStoreId');
      const savedStoreName = sessionStorage.getItem('handyStoreName');
      
      if (savedStoreId && savedStoreName && storesData[savedStoreId]) {
        currentStoreId = savedStoreId;
        currentStoreName = savedStoreName;
        
        console.log('‚úÖ „Çª„ÉÉ„Ç∑„Éß„É≥„Åã„ÇâÂæ©ÂÖÉ:', currentStoreName);
        showTablesScreen();
      }
    });
  </script>
</body>
</html>
