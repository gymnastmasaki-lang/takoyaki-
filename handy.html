<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    /* ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®šï¼ˆå¤‰æ›´ãªã—ï¼‰ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 600px; margin: 0 auto; }
    .login-screen { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .login-screen h1 { text-align: center; color: #667eea; margin-bottom: 30px; font-size: 28px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: bold; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
    .login-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; }
    .tables-screen { display: none; }
    .header { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .logout-btn { background: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
    .table-card { background: white; border-radius: 15px; padding: 30px 20px; text-align: center; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
    
    /* æ³¨æ–‡ã‚ã‚Šã®ãƒãƒƒã‚¸è¡¨ç¤º */
    .table-card.has-pending-orders { background: linear-gradient(135deg, #fff4e6 0%, #ffe0b2 100%); border: 2px solid #ff9800; }
    .table-card.has-pending-orders::after { content: 'æ³¨æ–‡ã‚ã‚Š'; position: absolute; top: 10px; right: 10px; background: #ff9800; color: white; font-size: 10px; padding: 4px 8px; border-radius: 10px; }
    
    .table-card .table-name { font-size: 24px; font-weight: bold; color: #667eea; }
    .checkout-btn { width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    .hidden { display: none !important; }
    .modal-overlay { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 10001; align-items: center; justify-content: center; }
    .modal { background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; }
    .tax-item { padding: 10px; background: white; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 8px; display: flex; justify-content: space-between; }
  </style>
</head>
<body>
  <div class="container">
    <div class="login-screen" id="loginScreen">
      <h1>ğŸ½ï¸ ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </h1>
      <div class="form-group">
        <label for="storeSelect">åº—èˆ—ã‚’é¸æŠ</label>
        <select id="storeSelect"><option value="">èª­ã¿è¾¼ã¿ä¸­...</option></select>
      </div>
      <div class="form-group">
        <label for="passwordInput">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      </div>
      <button class="login-btn" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    
    <div class="tables-screen" id="tablesScreen">
      <div class="header">
        <h2 id="storeNameDisplay">åº—èˆ—å</h2>
        <button class="logout-btn" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <div class="tables-grid" id="tablesGrid">
        <div style="text-align:center; padding:20px;">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>
  
  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3 style="text-align:center;">ğŸ’° ä¼šè¨ˆå‡¦ç†</h3>
      <p id="selectedTableLabel2" style="text-align:center; color:#666; margin-bottom:20px;"></p>
      
      <div id="taxRateSection" style="margin-bottom:20px; padding:15px; background:#e8f5e9; border-radius:10px; max-height: 300px; overflow-y: auto;">
        <h4 style="font-size:14px; margin-bottom:10px;">æ³¨æ–‡å†…å®¹</h4>
        <div id="taxRateItemsList"></div>
      </div>
      
      <div style="margin:20px 0; padding:15px; background:#fff3cd; border-radius:10px; text-align:center;">
        <div style="font-size:18px; font-weight:bold;">è«‹æ±‚é¡: <span id="finalPaymentAmount" style="color:#4CAF50;">Â¥0</span></div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <button class="btn" style="background:#4CAF50; color:white;" onclick="completePayment('cash')">ç¾é‡‘ä¼šè¨ˆ</button>
        <button class="btn" style="background:#2196F3; color:white;" onclick="completePayment('credit')">ãã®ä»–ä¼šè¨ˆ</button>
        <button class="btn" style="background:#FF9800; color:white;" onclick="cancelOrdersForTable()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn" style="background:#f44336; color:white;" onclick="deleteOrdersForTable()">æ³¨æ–‡å‰Šé™¤</button>
      </div>
      <button class="btn" style="width:100%; margin-top:10px; background:#eee;" onclick="closePaymentModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="customConfirmModal" class="modal-overlay hidden">
    <div class="modal" style="text-align:center;">
      <div id="modalIcon" style="font-size:40px;">âš ï¸</div>
      <h3 id="modalTitle">ç¢ºèª</h3>
      <p id="modalMessage" style="margin:15px 0; color:#666;"></p>
      <div style="display:flex; gap:10px;">
        <button class="btn" style="flex:1; background:#ddd;" onclick="closeCustomModal()">ã„ã„ãˆ</button>
        <button id="modalConfirmBtn" class="btn" style="flex:1; background:#f44336; color:white;">ã¯ã„</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, getDocs, doc, where, onSnapshot, updateDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentStoreId = null;
    let currentStoreName = null;
    let storesData = {};
    let currentOrders = [];
    let currentTableName = null;
    let customModalResolve = null;

    // --- åº—èˆ—ãƒªã‚¹ãƒˆå–å¾— ---
    async function loadStoreList() {
      try {
        const q = query(collection(db, 'stores'), where('isActive', '==', true));
        const snap = await getDocs(q);
        const select = document.getElementById('storeSelect');
        select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        snap.forEach(doc => {
          const data = doc.data();
          storesData[doc.id] = { name: data.storeName, password: String(data.storePassword) };
          const opt = document.createElement('option');
          opt.value = doc.id; opt.textContent = data.storeName;
          select.appendChild(opt);
        });
      } catch (e) {
        console.error(e);
        document.getElementById('storeSelect').innerHTML = '<option>èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</option>';
      }
    }

    // --- ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ---
    window.handleLogin = () => {
      const id = document.getElementById('storeSelect').value;
      const pass = document.getElementById('passwordInput').value;
      if (!id || !storesData[id]) {
        alert('åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      if (pass !== storesData[id].password) {
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
        return;
      }
      currentStoreId = id;
      currentStoreName = storesData[id].name;
      sessionStorage.setItem('handyStoreId', id);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      showTablesScreen();
    };

    window.handleLogout = () => { sessionStorage.clear(); location.reload(); };

    function showTablesScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      const screen = document.getElementById('tablesScreen');
      screen.style.display = 'block';
      screen.classList.remove('hidden');
      document.getElementById('storeNameDisplay').textContent = currentStoreName;
      loadTables();
    }

    // --- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã¨ç›£è¦– ---
    async function loadTables() {
      const tSnap = await getDocs(collection(db, 'stores', currentStoreId, 'tables'));
      const grid = document.getElementById('tablesGrid');
      
      // ä¿®æ­£: æ³¨æ–‡ã®æ¤œç´¢æ¡ä»¶ã‚’ç·©å’Œã—ã€JSå´ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹æ–¹å¼ã«å¤‰æ›´ï¼ˆç¢ºå®Ÿã«æ‹¾ã†ãŸã‚ï¼‰
      onSnapshot(collection(db, 'stores', currentStoreId, 'orders'), (oSnap) => {
        const activeTables = new Set();
        oSnap.forEach(d => {
          const data = d.data();
          // æœªä¼šè¨ˆãƒ»æœªå‰Šé™¤ãƒ»æœªã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ã‚‚ã®ã‚’åˆ¤å®š
          if (!data.paidAt && !data.deleted && !data.cancelledAt) {
            if (data.tableNumber) activeTables.add(String(data.tableNumber));
          }
        });

        grid.innerHTML = '';
        const tables = [];
        tSnap.forEach(d => tables.push(d.data()));
        // ãƒ†ãƒ¼ãƒ–ãƒ«é †åºã‚½ãƒ¼ãƒˆï¼ˆorderãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰é †ã€ãªã‘ã‚Œã°åå‰é †ï¼‰
        tables.sort((a, b) => (a.order || 0) - (b.order || 0) || a.name.localeCompare(b.name));

        tables.forEach(t => {
          const isActive = activeTables.has(String(t.name));
          const card = document.createElement('div');
          card.className = `table-card ${isActive ? 'has-pending-orders' : ''}`;
          card.innerHTML = `
            <div class="table-name">${t.name}</div>
            <div style="font-size:12px; color:#666; margin:5px 0;">${isActive ? 'æœªä¼šè¨ˆã‚ã‚Š' : 'ç©ºå¸­'}</div>
            <button class="checkout-btn" onclick="openCheckoutForTable('${t.name}')">ä¼šè¨ˆ/ç®¡ç†</button>
          `;
          grid.appendChild(card);
        });
      });
    }

    // --- ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º (ä¿®æ­£: ç¢ºå®Ÿãªãƒ‡ãƒ¼ã‚¿å–å¾—) ---
    window.openCheckoutForTable = async (tableName) => {
      currentTableName = tableName;
      
      // ä¿®æ­£: è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å•é¡Œã‚’é¿ã‘ã‚‹ãŸã‚ã€ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã ã‘ã§ã¾ãšå–å¾—ã™ã‚‹
      const q = query(collection(db, 'stores', currentStoreId, 'orders'), 
                where('tableNumber', '==', String(tableName)));
      
      const snap = await getDocs(q);
      
      // JSå´ã§ã€Œç”Ÿãã¦ã„ã‚‹æ³¨æ–‡ã€ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
      currentOrders = snap.docs
        .map(d => ({id: d.id, ...d.data()}))
        .filter(o => !o.paidAt && !o.deleted && !o.cancelledAt);

      if (currentOrders.length === 0) {
        await showCustomConfirm({ icon: 'ğŸ“‹', title: 'æ³¨æ–‡ãªã—', message: 'ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯æœªä¼šè¨ˆã®æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“', btnText: 'OK', btnClass: 'success' });
        return;
      }

      document.getElementById('selectedTableLabel2').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ«: ${tableName}`;
      
      // åˆè¨ˆé‡‘é¡è¨ˆç®—
      const total = currentOrders.reduce((s, o) => s + (o.totalAmount || 0), 0);
      document.getElementById('finalPaymentAmount').textContent = `Â¥${total.toLocaleString()}`;
      
      // æ˜ç´°è¡¨ç¤º
      const list = document.getElementById('taxRateItemsList');
      list.innerHTML = currentOrders.map(o => {
        // å•†å“è©³ç´°ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’è¡¨ç¤ºã€ãªã‘ã‚Œã°åˆè¨ˆã®ã¿
        let details = '';
        if (o.items && o.items.length > 0) {
          details = o.items.map(i => `<div style="font-size:12px; color:#666;">ãƒ»${i.name} Ã—${i.quantity}</div>`).join('');
        }
        return `
          <div class="tax-item" style="flex-direction:column;">
            <div style="display:flex; justify-content:space-between; font-weight:bold;">
              <span>æ³¨æ–‡æ™‚åˆ»: ${o.createdAt ? new Date(o.createdAt.toDate()).getHours() + ':' + String(new Date(o.createdAt.toDate()).getMinutes()).padStart(2, '0') : '-'}</span>
              <span>Â¥${(o.totalAmount || 0).toLocaleString()}</span>
            </div>
            ${details}
          </div>`;
      }).join('');
      
      document.getElementById('paymentModal').classList.remove('hidden');
    };

    // --- å£²ä¸Šåæ˜  + è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰ ---
    window.completePayment = async (method) => {
      const confirmed = await showCustomConfirm({ 
        icon: 'ğŸ’°', title: 'ä¼šè¨ˆç¢ºå®š', message: 'ä¼šè¨ˆã‚’å®Œäº†ã—ã€å£²ä¸Šã«åæ˜ ã—ã¾ã™ã‹ï¼Ÿ', btnClass: 'success' 
      });
      if (!confirmed) return;

      try {
        const now = serverTimestamp();
        let total = 0;
        
        // æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        for (const o of currentOrders) {
          await updateDoc(doc(db, 'stores', currentStoreId, 'orders', o.id), { 
            paidAt: now, 
            paymentMethod: method 
          });
          total += (o.totalAmount || 0);
        }
        
        // POSç”¨å£²ä¸Šãƒ‡ãƒ¼ã‚¿ä½œæˆ
        await addDoc(collection(db, 'stores', currentStoreId, 'sales'), {
          amount: total, 
          method: method, 
          createdAt: now, 
          tableName: currentTableName, 
          type: 'order'
        });

        await showCustomConfirm({ icon: 'âœ…', title: 'å®Œäº†', message: 'ä¼šè¨ˆå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ', btnText: 'OK', btnClass: 'success' });
        location.reload();
      } catch (e) { 
        console.error(e);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); 
      }
    };

    // --- å‰Šé™¤ + è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰ ---
    window.deleteOrdersForTable = async () => {
      const confirmed = await showCustomConfirm({ icon: 'ğŸ—‘ï¸', title: 'å‰Šé™¤ç¢ºèª', message: 'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå£²ä¸Šã«ã¯è¨ˆä¸Šã•ã‚Œã¾ã›ã‚“ï¼‰' });
      if (!confirmed) return;
      try {
        for (const o of currentOrders) {
          await updateDoc(doc(db, 'stores', currentStoreId, 'orders', o.id), { deleted: true });
        }
        await showCustomConfirm({ icon: 'ğŸ—‘ï¸', title: 'å®Œäº†', message: 'æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', btnText: 'OK', btnClass: 'success' });
        location.reload();
      } catch (e) { alert('å¤±æ•—ã—ã¾ã—ãŸ'); }
    };

    // --- ã‚­ãƒ£ãƒ³ã‚»ãƒ« + è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰ ---
    window.cancelOrdersForTable = async () => {
      const confirmed = await showCustomConfirm({ icon: 'â¸ï¸', title: 'å–æ¶ˆç¢ºèª', message: 'æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ‰±ã„ã«ã—ã¾ã™ã‹ï¼Ÿ' });
      if (!confirmed) return;
      try {
        const now = serverTimestamp();
        for (const o of currentOrders) {
          await updateDoc(doc(db, 'stores', currentStoreId, 'orders', o.id), { cancelledAt: now });
        }
        await showCustomConfirm({ icon: 'â¸ï¸', title: 'å®Œäº†', message: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã—ã¾ã—ãŸ', btnText: 'OK', btnClass: 'success' });
        location.reload();
      } catch (e) { alert('å¤±æ•—ã—ã¾ã—ãŸ'); }
    };

    // --- ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ---
    window.showCustomConfirm = (opt) => {
      return new Promise(res => {
        customModalResolve = res;
        const m = document.getElementById('customConfirmModal');
        document.getElementById('modalIcon').textContent = opt.icon || 'âš ï¸';
        document.getElementById('modalTitle').textContent = opt.title;
        document.getElementById('modalMessage').textContent = opt.message;
        const btn = document.getElementById('modalConfirmBtn');
        btn.textContent = opt.btnText || 'ã¯ã„';
        btn.style.background = opt.btnClass === 'success' ? '#4CAF50' : '#f44336';
        
        btn.onclick = () => { m.classList.add('hidden'); res(true); };
        m.classList.remove('hidden');
      });
    };
    window.closeCustomModal = () => { 
      document.getElementById('customConfirmModal').classList.add('hidden'); 
      if(customModalResolve) customModalResolve(false); 
    };
    window.closePaymentModal = () => document.getElementById('paymentModal').classList.add('hidden');

    // --- åˆæœŸåŒ– ---
    window.addEventListener('DOMContentLoaded', async () => {
      await loadStoreList();
      const sId = sessionStorage.getItem('handyStoreId');
      if (sId && storesData[sId]) {
        currentStoreId = sId;
        currentStoreName = sessionStorage.getItem('handyStoreName');
        showTablesScreen();
      }
    });
  </script>
</body>
</html>