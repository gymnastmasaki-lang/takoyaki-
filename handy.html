<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    .login-screen {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .login-screen h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 28px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .login-btn:active {
      transform: scale(0.98);
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ */
    .tables-screen {
      display: none;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .header h2 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .header .store-info {
      color: #666;
      font-size: 14px;
    }
    
    .logout-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .table-card {
      background: white;
      border-radius: 15px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    
    .table-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .table-card:active {
      transform: translateY(-2px);
    }
    
    /* ğŸ†• æœªå®Œäº†ãƒ†ãƒ¼ãƒ–ãƒ«ã®è‰² */
    .table-card.has-pending-orders {
      background: linear-gradient(135deg, #fff4e6 0%, #ffe0b2 100%);
      border: 2px solid #ff9800;
    }
    
    .table-card.has-pending-orders .table-name {
      color: #f57c00;
    }
    
    .table-card.has-pending-orders .pending-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff9800;
      color: white;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
    }
    
    .table-card .table-name {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .table-card .table-status {
      font-size: 12px;
      color: #999;
    }
    
    /* ğŸ†• ä¼šè¨ˆãƒœã‚¿ãƒ³ */
    .checkout-btn {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .checkout-btn:active {
      transform: scale(0.95);
    }
    
    .hidden {
      display: none !important;
    }
    
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }
    
    /* ğŸ†• POSã‹ã‚‰ã‚³ãƒ”ãƒ¼: ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã®CSS */
    .custom-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    
    .custom-modal-box {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .modal-icon {
      font-size: 64px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 15px;
      color: #333;
    }
    
    .modal-message {
      text-align: center;
      font-size: 16px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.6;
      white-space: pre-line;
    }
    
    .modal-buttons {
      display: flex;
      gap: 15px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 18px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .modal-btn:active {
      transform: scale(0.95);
    }
    
    .modal-btn-cancel {
      background: #e0e0e0;
      color: #333;
    }
    
    .modal-btn-cancel:hover {
      background: #d0d0d0;
    }
    
    .modal-btn-danger {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
    }
    
    .modal-btn-success {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    /* ğŸ†• POSã‹ã‚‰ã‚³ãƒ”ãƒ¼: ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã®CSS */
    .modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10001;
      align-items: center;
      justify-content: center;
    }
    
    .modal-overlay.hidden {
      display: none !important;
    }
    
    .modal {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal h3 {
      margin: 0 0 20px 0;
      color: #333;
      font-size: 24px;
      text-align: center;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .payment-methods {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .payment-method-btn {
      padding: 15px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .payment-method-btn:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    
    .payment-method-btn.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .cash-input-section {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    
    .cash-input-section label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    
    .cash-input-section input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 18px;
      text-align: center;
    }
    
    .change-display {
      margin-top: 15px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
    }
    
    .change-amount {
      color: #4CAF50;
      font-size: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div class="login-screen" id="loginScreen">
      <h1>ğŸ½ï¸ ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </h1>
      <div id="errorMessage" class="error-message hidden"></div>
      
      <div class="form-group">
        <label for="storeSelect">åº—èˆ—ã‚’é¸æŠ</label>
        <select id="storeSelect">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="passwordInput">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      </div>
      
      <button class="login-btn" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    
    <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ -->
    <div class="tables-screen" id="tablesScreen">
      <div class="header">
        <h2 id="storeNameDisplay">åº—èˆ—å</h2>
        <div class="store-info">ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        <button class="logout-btn" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      
      <div class="tables-grid" id="tablesGrid">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>
  
  <!-- ğŸ†• POSã‹ã‚‰ã‚³ãƒ”ãƒ¼: ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="customConfirmModal" class="custom-modal-overlay">
    <div class="custom-modal-box">
      <div class="modal-icon" id="modalIcon">âš ï¸</div>
      <div class="modal-title" id="modalTitle">ç¢ºèª</div>
      <div class="modal-message" id="modalMessage">æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeCustomModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-danger" id="modalConfirmBtn" onclick="confirmCustomModal()">å®Ÿè¡Œ</button>
      </div>
    </div>
  </div>
  
  <!-- ğŸ†• ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« (POSã‹ã‚‰ã‚³ãƒ”ãƒ¼) -->
  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ’° ä¼šè¨ˆå‡¦ç†</h3>
      <p id="selectedTableLabel2" style="color: #666; margin-bottom: 20px;">ãƒ†ãƒ¼ãƒ–ãƒ«</p>
      
      <div id="taxRateSection" style="margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px; border-left: 4px solid #4CAF50; max-height: 300px; overflow-y: auto;">
        <h4 style="margin: 0 0 15px 0; color: #2e7d32; font-size: 16px;">å„å•†å“ã®ç¨ç‡ã‚’é¸æŠ</h4>
        <div id="taxRateItemsList"></div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #4CAF50; font-weight: bold; font-size: 14px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>8%å¯¾è±¡:</span>
            <span id="tax8Summary" style="color: #FF9800;">Â¥0</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>10%å¯¾è±¡:</span>
            <span id="tax10Summary" style="color: #2196F3;">Â¥0</span>
          </div>
        </div>
      </div>
      
      <div class="payment-methods">
        <button class="payment-method-btn" onclick="selectPaymentMethod('cash')">
          ğŸ’µ ç¾é‡‘
        </button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('emoney')">
          ğŸ“± é›»å­ãƒãƒãƒ¼
        </button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('credit')">
          ğŸ’³ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰
        </button>
      </div>
      
      <div id="cashInputSection" class="cash-input-section hidden">
        <label>ãŠé ã‹ã‚Šé‡‘é¡</label>
        <input type="number" id="cashReceived" placeholder="0" oninput="calculateChange()">
        <div class="change-display" id="changeDisplay">
          ãŠã¤ã‚Š: <span class="change-amount" id="changeAmount">Â¥0</span>
        </div>
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 10px;">
        <label style="font-weight: bold; color: #856404;">å€¤å¼•ãé‡‘é¡</label>
        <input type="number" id="discountAmount" placeholder="0" value="0" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ffc107; border-radius: 8px; margin-top: 8px;" oninput="updatePaymentTotal()">
        <div style="text-align: center; margin-top: 10px; font-size: 18px; font-weight: bold; color: #333;">
          è«‹æ±‚é¡: <span id="finalPaymentAmount" style="color: #4CAF50;">Â¥0</span>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="closePaymentModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn" style="flex: 2; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="completePayment()" id="completePaymentBtn" disabled>âœ… ä¼šè¨ˆå®Œäº†</button>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white;" onclick="cancelOrdersForTable()">â¸ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="deleteOrdersForTable()">ğŸ—‘ï¸ å‰Šé™¤</button>
      </div>
    </div>
  </div>

  <!-- ğŸ†• é‡‘é¡å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="priceChangeModal" class="modal-overlay hidden">
    <div class="modal">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 50px; margin-bottom: 10px;">ğŸ’´</div>
        <h3 style="margin: 0; font-size: 20px; color: #333;" id="priceChangeTitle">é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h3>
      </div>
      
      <div style="background: #f5f5f5; border-radius: 10px; padding: 15px; margin: 20px 0; text-align: center;">
        <div style="color: #666; margin-bottom: 10px;" id="priceChangeItemInfo"></div>
        <div style="font-size: 18px; font-weight: bold; color: #333;">
          ç¾åœ¨: <span id="priceChangeCurrentPrice"></span>
        </div>
      </div>
      
      <div style="margin: 20px 0;">
        <input type="number" id="priceChangeInput" placeholder="æ–°ã—ã„é‡‘é¡ã‚’å…¥åŠ›" style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 24px; text-align: center;">
      </div>
      
      <input type="hidden" id="priceChangeItemId">
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="closePriceChangeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="confirmPriceChange()">âœ“ å¤‰æ›´</button>
      </div>
    </div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, getDocs, doc, getDoc, where, onSnapshot, updateDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.doc = doc;
    window.getDoc = getDoc;
    window.onSnapshot = onSnapshot;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.Timestamp = Timestamp;
    
    console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†');
    
    // FirebaseåˆæœŸåŒ–å®Œäº†ã‚’é€šçŸ¥
    window.firebaseReady = true;
    window.dispatchEvent(new Event('firebaseReady'));
  </script>
  
  <script>
    let currentStoreId = null;
    let currentStoreName = null;
    let storesData = {}; // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    let ordersListener = null; // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼
    let currentOrders = []; // ç¾åœ¨ã®æ³¨æ–‡ãƒªã‚¹ãƒˆï¼ˆPOSã¨åŒã˜å¤‰æ•°åï¼‰
    
    // ğŸ†• ä¼šè¨ˆå‡¦ç†ç”¨ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼ˆPOSã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼‰
    let selectedPaymentMethod = null;
    let totalAmountToPay = 0;
    let cashReceived = 0;
    let changeAmount = 0;
    
    // ğŸ†• POSã‹ã‚‰ã‚³ãƒ”ãƒ¼: ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
    let customModalResolve = null;
    
    function showCustomConfirm(options) {
      return new Promise((resolve) => {
        customModalResolve = resolve;
        
        const modal = document.getElementById('customConfirmModal');
        const icon = document.getElementById('modalIcon');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        
        icon.textContent = options.icon || 'âš ï¸';
        title.textContent = options.title || 'ç¢ºèª';
        message.textContent = options.message || 'æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ';
        
        confirmBtn.className = 'modal-btn ' + (options.btnClass || 'modal-btn-danger');
        confirmBtn.textContent = options.btnText || 'å®Ÿè¡Œ';
        
        modal.style.display = 'flex';
      });
    }
    
    function closeCustomModal() {
      document.getElementById('customConfirmModal').style.display = 'none';
      if (customModalResolve) {
        customModalResolve(false);
        customModalResolve = null;
      }
    }
    
    function confirmCustomModal() {
      document.getElementById('customConfirmModal').style.display = 'none';
      if (customModalResolve) {
        customModalResolve(true);
        customModalResolve = null;
      }
    }
    
    // åº—èˆ—ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
    async function loadStoreList() {
      try {
        console.log('ğŸ“‹ åº—èˆ—ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...');
        const storesQuery = window.query(
          window.collection(window.db, 'stores'),
          window.where('isActive', '==', true)
        );
        const storesSnapshot = await window.getDocs(storesQuery);
        const storeSelect = document.getElementById('storeSelect');
        
        storeSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        storesData = {};
        
        storesSnapshot.forEach(doc => {
          const storeData = doc.data();
          const storeId = doc.id;
          const storeName = storeData.storeName || doc.id;
          const password = storeData.storePassword || '';
          
          // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
          storesData[storeId] = {
            storeName: storeName,
            password: String(password),
            isActive: true
          };
          
          // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¿½åŠ 
          const option = document.createElement('option');
          option.value = storeId;
          option.textContent = storeName;
          storeSelect.appendChild(option);
          
          console.log('ğŸ“ åº—èˆ—è¿½åŠ :', storeName, '(ID:', storeId, ')');
        });
        
        console.log('âœ… åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å®Œäº†:', Object.keys(storesData).length, 'åº—èˆ—');
      } catch (error) {
        console.error('âŒ åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        showError('åº—èˆ—ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
    
    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    window.handleLogin = async function() {
      const storeSelect = document.getElementById('storeSelect');
      const passwordInput = document.getElementById('passwordInput');
      
      const storeId = storeSelect.value;
      const inputPassword = passwordInput.value.trim();
      
      console.log('ğŸ” ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ:', storeId);
      
      if (!storeId) {
        showError('åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!inputPassword) {
        showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      const storeInfo = storesData[storeId];
      if (!storeInfo) {
        showError('åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
      if (inputPassword !== storeInfo.password) {
        console.error('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸ä¸€è‡´');
        showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
      currentStoreId = storeId;
      currentStoreName = storeInfo.storeName;
      sessionStorage.setItem('handyStoreId', storeId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      
      console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', currentStoreName);
      console.log('   currentStoreId:', currentStoreId);
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ã‚’è¡¨ç¤º
      showTablesScreen();
    };
    
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
    window.handleLogout = async function() {
      const confirmed = await showCustomConfirm({
        icon: 'ğŸšª',
        title: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
        message: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ',
        btnClass: 'modal-btn-danger',
        btnText: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ'
      });
      
      if (confirmed) {
        // ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
        if (ordersListener) {
          ordersListener();
          ordersListener = null;
        }
        
        sessionStorage.removeItem('handyStoreId');
        sessionStorage.removeItem('handyStoreName');
        
        currentStoreId = null;
        currentStoreName = null;
        
        await showCustomConfirm({
          icon: 'ğŸ‘‹',
          title: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†',
          message: 'ã¾ãŸã®ã”åˆ©ç”¨ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™',
          btnClass: 'modal-btn-success',
          btnText: 'OK'
        });
        
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('tablesScreen').classList.add('hidden');
        document.getElementById('tablesScreen').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'block';
        
        document.getElementById('passwordInput').value = '';
      }
    };
    
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      
      setTimeout(() => {
        errorDiv.classList.add('hidden');
      }, 3000);
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ã‚’è¡¨ç¤º
    async function showTablesScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('tablesScreen').style.display = 'block';
      document.getElementById('tablesScreen').classList.remove('hidden');
      document.getElementById('storeNameDisplay').textContent = currentStoreName;
      
      await loadTables();
      startOrdersListener();
    }
    
    // ğŸ†• æ³¨æ–‡ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚’é–‹å§‹ï¼ˆPOSã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    function startOrdersListener() {
      if (ordersListener) {
        ordersListener();
      }
      
      const ordersRef = window.collection(window.db, 'stores', currentStoreId, 'orders');
      
      // POSã¨åŒã˜: å…¨æ³¨æ–‡ã‚’ç›£è¦–ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãªã—ï¼‰
      ordersListener = window.onSnapshot(ordersRef, (snapshot) => {
        console.log('ğŸ“¡ æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿æ›´æ–°æ¤œçŸ¥');
        updateTableStatus(snapshot);
      });
    }
    
    // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
    function updateTableStatus(ordersSnapshot) {
      const pendingTables = new Set();
      
      ordersSnapshot.forEach(doc => {
        const order = doc.data();
        // POSã¨åŒã˜æ¡ä»¶: å‰Šé™¤ã•ã‚Œã¦ãŠã‚‰ãšã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚‚æ”¯æ‰•ã„ã‚‚ã•ã‚Œã¦ã„ãªã„æ³¨æ–‡
        if (order.tableNumber && !order.deleted && !order.cancelledAt && !order.paidAt) {
          pendingTables.add(order.tableNumber);
        }
      });
      
      // ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
      document.querySelectorAll('.table-card').forEach(card => {
        const tableName = card.getAttribute('data-table-name');
        if (pendingTables.has(tableName)) {
          card.classList.add('has-pending-orders');
          
          // ãƒãƒƒã‚¸ãŒãªã‘ã‚Œã°è¿½åŠ 
          if (!card.querySelector('.pending-badge')) {
            const badge = document.createElement('div');
            badge.className = 'pending-badge';
            badge.textContent = 'æ³¨æ–‡ã‚ã‚Š';
            card.appendChild(badge);
          }
        } else {
          card.classList.remove('has-pending-orders');
          const badge = card.querySelector('.pending-badge');
          if (badge) {
            badge.remove();
          }
        }
      });
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadTables() {
      try {
        console.log('ğŸ” ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...');
        const tablesGrid = document.getElementById('tablesGrid');
        tablesGrid.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
        
        // stores/{storeId}/tables ã‹ã‚‰èª­ã¿è¾¼ã¿
        const tablesRef = window.collection(window.db, 'stores', currentStoreId, 'tables');
        const tablesSnapshot = await window.getDocs(tablesRef);
        const tables = [];
        
        tablesSnapshot.forEach(doc => {
          tables.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        console.log('ğŸ“Š å–å¾—ã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«æ•°:', tables.length);
        
        // orderãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã‚½ãƒ¼ãƒˆ
        tables.sort((a, b) => {
          const orderA = a.order || 0;
          const orderB = b.order || 0;
          if (orderA !== orderB) {
            return orderA - orderB;
          }
          return a.name.localeCompare(b.name);
        });
        
        if (tables.length === 0) {
          tablesGrid.innerHTML = '<div style="color: white; text-align: center; padding: 40px;">ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
          return;
        }
        
        tablesGrid.innerHTML = '';
        
        tables.forEach(table => {
          const tableCard = document.createElement('div');
          tableCard.className = 'table-card';
          tableCard.setAttribute('data-table-name', table.name);
          
          tableCard.innerHTML = `
            <div class="table-name">${table.name}</div>
            <div class="table-status">ã‚¿ãƒƒãƒ—ã—ã¦æ³¨æ–‡</div>
          `;
          
          // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒœã‚¿ãƒ³
          const menuBtn = document.createElement('button');
          menuBtn.className = 'checkout-btn';
          menuBtn.textContent = 'ğŸ“± ãƒ¡ãƒ‹ãƒ¥ãƒ¼';
          menuBtn.style.background = '#667eea';
          menuBtn.onclick = (e) => {
            e.stopPropagation();
            openMenu(table.name);
          };
          tableCard.appendChild(menuBtn);
          
          // ğŸ†• ä¼šè¨ˆãƒœã‚¿ãƒ³
          const checkoutBtn = document.createElement('button');
          checkoutBtn.className = 'checkout-btn';
          checkoutBtn.textContent = 'ğŸ’° ä¼šè¨ˆ';
          checkoutBtn.onclick = (e) => {
            e.stopPropagation();
            openCheckoutForTable(table.name);
          };
          tableCard.appendChild(checkoutBtn);
          
          tablesGrid.appendChild(tableCard);
        });
        
        console.log('âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§èª­ã¿è¾¼ã¿å®Œäº†:', tables.length + 'ä»¶');
      } catch (error) {
        console.error('âŒ ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        const tablesGrid = document.getElementById('tablesGrid');
        tablesGrid.innerHTML = '<div style="color: white; text-align: center; padding: 40px;">ãƒ†ãƒ¼ãƒ–ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    }
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‚’é–‹ã
    function openMenu(tableName) {
      console.log('ğŸ“± ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‚’é–‹ã:', tableName);
      
      // menu.htmlã«é·ç§»ï¼ˆstoreIdã¨tableã¨modeã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ¸¡ã™ï¼‰
      const menuUrl = `menu.html?table=${encodeURIComponent(tableName)}&store=${currentStoreId}&mode=handy`;
      
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«åº—èˆ—æƒ…å ±ã‚’ä¿å­˜ï¼ˆmenu.htmlã§ä½¿ç”¨ï¼‰
      sessionStorage.setItem('handyStoreId', currentStoreId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      sessionStorage.setItem('handyTableName', tableName);
      
      console.log('â†’ é·ç§»å…ˆ:', menuUrl);
      window.location.href = menuUrl;
    }
    
    // ğŸ†• ä¼šè¨ˆç”»é¢ã‚’é–‹ãï¼ˆPOSã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Œå…¨ã‚³ãƒ”ãƒ¼ï¼‰
    async function openCheckoutForTable(tableName) {
      try {
        console.log('ğŸ’° ä¼šè¨ˆç”»é¢ã‚’é–‹ã:', tableName);
        
        // POSã¨åŒã˜ã‚¯ã‚¨ãƒª: tableNumberã§æ¤œç´¢ã€statusã¯ä½¿ã‚ãªã„
        const ordersRef = window.collection(window.db, 'stores', currentStoreId, 'orders');
        const ordersQuery = window.query(
          ordersRef,
          window.where('tableNumber', '==', String(tableName))
        );
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        // æ³¨æ–‡ã‚’currentOrdersã«æ ¼ç´ï¼ˆæœªæ‰•ã„æ³¨æ–‡ã®ã¿ï¼‰
        currentOrders = [];
        ordersSnapshot.forEach(doc => {
          const order = { id: doc.id, ...doc.data() };
          // POSã¨åŒã˜æ¡ä»¶: å‰Šé™¤ã•ã‚Œã¦ãŠã‚‰ãšã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚‚æ”¯æ‰•ã„ã‚‚ã•ã‚Œã¦ã„ãªã„æ³¨æ–‡
          if (!order.deleted && !order.cancelledAt && !order.paidAt) {
            currentOrders.push(order);
          }
        });
        
        console.log('ğŸ“¦ å–å¾—ã—ãŸæ³¨æ–‡:', currentOrders.length, 'ä»¶');
        
        if (currentOrders.length === 0) {
          await showCustomConfirm({
            icon: 'ğŸ“‹',
            title: 'æ³¨æ–‡ãªã—',
            message: `${tableName}\nã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“`,
            btnClass: 'modal-btn-success',
            btnText: 'OK'
          });
          return;
        }
        
        // ä¼šè¨ˆå‡¦ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        showCheckoutMenu(tableName);
        
      } catch (error) {
        console.error('âŒ ä¼šè¨ˆç”»é¢è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
        await showCustomConfirm({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'ä¼šè¨ˆç”»é¢ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ',
          btnClass: 'modal-btn-danger',
          btnText: 'OK'
        });
      }
    }
    
    // ğŸ†• ä¼šè¨ˆå‡¦ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºï¼ˆPOSã¨åŒã˜ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼‰
    async function showCheckoutMenu(tableName) {
      console.log('ğŸ’° ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã:', tableName);
      
      // åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
      totalAmountToPay = currentOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      
      // ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      document.getElementById('paymentModal').classList.remove('hidden');
      document.getElementById('selectedTableLabel2').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${tableName}`;
      
      // ç¨ç‡é¸æŠé …ç›®ã‚’ç”Ÿæˆ
      generateTaxRateItems();
      
      // å€¤å¼•ãé¡ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('discountAmount').value = 0;
      updatePaymentTotal();
      
      // æ”¯æ‰•ã„æ–¹æ³•ã®é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
      selectedPaymentMethod = null;
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('completePaymentBtn').disabled = true;
    }
    
    // ğŸ†• ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
    };
    
    // ğŸ†• ç¨ç‡é¸æŠé …ç›®ã‚’ç”Ÿæˆï¼ˆPOSã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼‰
    function generateTaxRateItems() {
      const container = document.getElementById('taxRateItemsList');
      container.innerHTML = '';
      
      let itemIndex = 0;
      
      console.log('ğŸ“‹ ç¨ç‡é¸æŠé …ç›®ã‚’ç”Ÿæˆä¸­:', currentOrders.length, 'ä»¶ã®æ³¨æ–‡');
      
      currentOrders.forEach(order => {
        console.log(`  æ³¨æ–‡#${order.orderNumber}:`, order.items?.length || 0, 'å•†å“');
        
        if (!order.items || !Array.isArray(order.items) || order.items.length === 0) {
          // itemsãŒãªã„å ´åˆã€æ³¨æ–‡å…¨ä½“ã‚’1ã¤ã®é …ç›®ã¨ã—ã¦æ‰±ã†
          const orderName = `æ³¨æ–‡ #${order.orderNumber}`;
          const orderTotal = order.totalAmount || 0;
          console.log(`    â†’ å•†å“ãªã—ã€æ³¨æ–‡å…¨ä½“: ${orderName}, Â¥${orderTotal}`);
          addTaxRateItem(container, orderName, 1, orderTotal, itemIndex, 10);
          itemIndex++;
        } else {
          // å„å•†å“ã‚’è¿½åŠ 
          order.items.forEach(item => {
            const toppingStr = item.toppings || item.toppingDetails || 'ãªã—';
            const itemName = `${item.name} (${toppingStr})`;
            const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
            const defaultTaxRate = item.taxRate || 10;
            console.log(`    å•†å“è¿½åŠ : ${itemName} Ã—${item.quantity}, Â¥${itemTotal}, ç¨ç‡:${defaultTaxRate}%`);
            addTaxRateItem(container, itemName, item.quantity, itemTotal, itemIndex, defaultTaxRate);
            itemIndex++;
          });
          
          // ãƒ¬ã‚¸è¢‹ã‚’è¿½åŠ 
          if (order.bagNeeded && order.bagQuantity > 0) {
            const bagTotal = order.bagPrice || (order.bagQuantity * 3);
            console.log(`  ãƒ¬ã‚¸è¢‹è¿½åŠ : ${order.bagQuantity}æš, é‡‘é¡:${bagTotal}`);
            addTaxRateItem(container, 'ğŸ›ï¸ ãƒ¬ã‚¸è¢‹', order.bagQuantity, bagTotal, itemIndex, 10);
            itemIndex++;
          }
        }
      });
      
      console.log(`âœ… ç¨ç‡é¸æŠé …ç›®ã‚’${itemIndex}å€‹ç”Ÿæˆã—ã¾ã—ãŸ`);
      calculateTaxSummary();
    }
    
    // ğŸ†• ç¨ç‡é¸æŠé …ç›®ã‚’è¿½åŠ ï¼ˆPOSã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼‰
    function addTaxRateItem(container, itemName, quantity, itemTotal, index, defaultTaxRate = 10) {
      console.log(`  addTaxRateItem: ${itemName}, æ•°é‡:${quantity}, é‡‘é¡:${itemTotal}, index:${index}, ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡:${defaultTaxRate}%`);
      
      const itemDiv = document.createElement('div');
      itemDiv.style.cssText = 'padding: 10px; margin-bottom: 8px; background: white; border-radius: 6px; border: 1px solid #ddd;';
      
      const headerDiv = document.createElement('div');
      headerDiv.style.cssText = 'display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; font-size: 14px; cursor: pointer;';
      headerDiv.innerHTML = `
        <span>${itemName} Ã—${quantity}</span>
        <span style="color: #667eea;" id="itemPrice${index}">Â¥${itemTotal.toLocaleString()}</span>
      `;
      
      // å•†å“è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã§é‡‘é¡ç·¨é›†
      headerDiv.onclick = function() {
        // ã‚«ã‚¹ã‚¿ãƒ é‡‘é¡å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        document.getElementById('priceChangeTitle').textContent = `${itemName} Ã—${quantity}`;
        document.getElementById('priceChangeItemInfo').textContent = `${itemName} Ã—${quantity} ã®é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
        document.getElementById('priceChangeCurrentPrice').textContent = `Â¥${itemTotal.toLocaleString()}`;
        document.getElementById('priceChangeInput').value = itemTotal;
        document.getElementById('priceChangeItemId').value = index;
        document.getElementById('priceChangeModal').classList.remove('hidden');
        
        // å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        setTimeout(() => {
          const input = document.getElementById('priceChangeInput');
          input.focus();
          input.select();
        }, 100);
      };
      
      itemDiv.appendChild(headerDiv);
      
      const radioDiv = document.createElement('div');
      radioDiv.style.cssText = 'display: flex; gap: 10px; justify-content: center;';
      
      // 8%ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³
      const label8 = document.createElement('label');
      label8.style.cssText = 'flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 6px 10px; border-radius: 4px; background: #fff3e0; border: 2px solid #FF9800; font-size: 13px;';
      const radio8 = document.createElement('input');
      radio8.type = 'radio';
      radio8.name = `taxRate${index}`;
      radio8.value = '8';
      radio8.checked = (defaultTaxRate === 8);
      radio8.dataset.amount = itemTotal;
      radio8.dataset.index = index;
      radio8.style.cssText = 'margin-right: 5px; width: 18px; height: 18px;';
      radio8.onchange = calculateTaxSummary;
      label8.appendChild(radio8);
      label8.appendChild(document.createTextNode('8%æŒã¡å¸°ã‚Š'));
      
      // 10%ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³
      const label10 = document.createElement('label');
      label10.style.cssText = 'flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 6px 10px; border-radius: 4px; background: #e3f2fd; border: 2px solid #2196F3; font-size: 13px;';
      const radio10 = document.createElement('input');
      radio10.type = 'radio';
      radio10.name = `taxRate${index}`;
      radio10.value = '10';
      radio10.checked = (defaultTaxRate === 10);
      radio10.dataset.amount = itemTotal;
      radio10.dataset.index = index;
      radio10.style.cssText = 'margin-right: 5px; width: 18px; height: 18px;';
      radio10.onchange = calculateTaxSummary;
      label10.appendChild(radio10);
      label10.appendChild(document.createTextNode('10%åº—å†…'));
      
      console.log(`    ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ç”Ÿæˆ: taxRate${index}, 8%=${radio8.checked}, 10%=${radio10.checked}`);
      
      radioDiv.appendChild(label8);
      radioDiv.appendChild(label10);
      itemDiv.appendChild(radioDiv);
      
      container.appendChild(itemDiv);
    }
    
    // ğŸ†• ç¨ç‡åˆ¥é›†è¨ˆã‚’è¨ˆç®—
    function calculateTaxSummary() {
      let tax8Total = 0;
      let tax10Total = 0;
      
      const radios = document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked');
      radios.forEach(radio => {
        const amount = parseFloat(radio.dataset.amount) || 0;
        if (radio.value === '8') {
          tax8Total += amount;
        } else if (radio.value === '10') {
          tax10Total += amount;
        }
      });
      
      document.getElementById('tax8Summary').textContent = 'Â¥' + tax8Total.toLocaleString();
      document.getElementById('tax10Summary').textContent = 'Â¥' + tax10Total.toLocaleString();
      
      // è«‹æ±‚é¡ã‚‚æ›´æ–°
      updatePaymentTotal();
    }
    
    // ğŸ†• å€¤å¼•ãå¾Œã®è«‹æ±‚é¡ã‚’æ›´æ–°
    window.updatePaymentTotal = function() {
      // ç·¨é›†ã•ã‚ŒãŸé‡‘é¡ã‚’å…¨ã¦åˆè¨ˆï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®data-amountã‹ã‚‰å–å¾—ï¼‰
      let total = 0;
      const radios = document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked');
      radios.forEach(radio => {
        total += parseFloat(radio.dataset.amount) || 0;
      });
      
      const discount = parseInt(document.getElementById('discountAmount').value) || 0;
      const finalAmount = Math.max(0, total - discount);
      totalAmountToPay = finalAmount;
      
      document.getElementById('finalPaymentAmount').textContent = 'Â¥' + finalAmount.toLocaleString();
      
      // ç¾é‡‘ã®å ´åˆã¯ãŠã¤ã‚Šè¨ˆç®—ã‚‚æ›´æ–°
      if (selectedPaymentMethod === 'cash') {
        calculateChange();
      }
    };
    
    // ğŸ†• æ”¯æ‰•ã„æ–¹æ³•é¸æŠ
    window.selectPaymentMethod = function(method) {
      selectedPaymentMethod = method;
      
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');
      
      if (method === 'cash') {
        document.getElementById('cashInputSection').classList.remove('hidden');
        document.getElementById('completePaymentBtn').disabled = true;
      } else {
        document.getElementById('cashInputSection').classList.add('hidden');
        document.getElementById('completePaymentBtn').disabled = false;
      }
    };
    
    // ğŸ†• ãŠã¤ã‚Šè¨ˆç®—
    window.calculateChange = function() {
      cashReceived = parseInt(document.getElementById('cashReceived').value) || 0;
      
      // å€¤å¼•ãå¾Œã®é‡‘é¡ã‚’ä½¿ç”¨
      changeAmount = cashReceived - totalAmountToPay;
      
      document.getElementById('changeAmount').textContent = `Â¥${changeAmount.toLocaleString()}`;
      
      document.getElementById('completePaymentBtn').disabled = cashReceived < totalAmountToPay;
    };
    
    // ğŸ†• é‡‘é¡å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closePriceChangeModal = function() {
      document.getElementById('priceChangeModal').classList.add('hidden');
    };
    
    // ğŸ†• é‡‘é¡å¤‰æ›´ã‚’ç¢ºå®š
    window.confirmPriceChange = function() {
      const itemId = document.getElementById('priceChangeItemId').value;
      const newPrice = parseFloat(document.getElementById('priceChangeInput').value) || 0;
      
      console.log('ğŸ’´ é‡‘é¡å¤‰æ›´:', itemId, 'â†’', newPrice);
      
      // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®data-amountã‚’æ›´æ–°
      const radios = document.querySelectorAll(`input[name="taxRate${itemId}"]`);
      radios.forEach(radio => {
        radio.dataset.amount = newPrice;
      });
      
      // è¡¨ç¤ºã‚’æ›´æ–°
      document.getElementById(`itemPrice${itemId}`).textContent = 'Â¥' + newPrice.toLocaleString();
      
      // ç¨ç‡åˆ¥é›†è¨ˆã‚’å†è¨ˆç®—
      calculateTaxSummary();
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      closePriceChangeModal();
    };
    
    // ğŸ†• ä¼šè¨ˆå®Œäº†ï¼ˆPOSã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼‰
    window.completePayment = async function() {
      console.log('ğŸŸ¢ completePaymenté–‹å§‹');
      
      if (!selectedPaymentMethod) {
        await showCustomConfirm({
          icon: 'âš ï¸',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„',
          btnClass: 'modal-btn-danger',
          btnText: 'OK'
        });
        return;
      }
      
      if (selectedPaymentMethod === 'cash' && cashReceived < totalAmountToPay) {
        await showCustomConfirm({
          icon: 'âš ï¸',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'ãŠé ã‹ã‚Šé‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™',
          btnClass: 'modal-btn-danger',
          btnText: 'OK'
        });
        return;
      }
      
      console.log('âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é€šéã€‚ç¨ç‡èª­ã¿å–ã‚Šé–‹å§‹');
      
      try {
        const now = window.Timestamp.now();
        
        // å…¨ã¦ã®æ³¨æ–‡ã«æ”¯æ‰•ã„æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
        for (const order of currentOrders) {
          // ğŸ“ ç·¨é›†ã•ã‚ŒãŸé‡‘é¡ã¨taxRateã‚’æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã«åæ˜ 
          let orderItemIndex = 0;
          const updatedItems = [];
          
          if (order.items && Array.isArray(order.items) && order.items.length > 0) {
            // å„å•†å“ã®ç·¨é›†ã•ã‚ŒãŸé‡‘é¡ã¨taxRateã‚’å–å¾—
            order.items.forEach(item => {
              const radio = document.querySelector(`input[name="taxRate${orderItemIndex}"]:checked`);
              const taxRate = radio ? parseInt(radio.value) : 10;
              const editedTotalPrice = radio ? parseFloat(radio.dataset.amount) : ((item.price + (item.toppingPrice || 0)) * item.quantity);
              
              // å˜ä¾¡ã‚’è¨ˆç®—ï¼ˆç·¨é›†ã•ã‚ŒãŸåˆè¨ˆé‡‘é¡ / æ•°é‡ï¼‰
              const editedUnitPrice = editedTotalPrice / item.quantity;
              
              updatedItems.push({
                ...item,
                price: editedUnitPrice - (item.toppingPrice || 0), // ãƒˆãƒƒãƒ”ãƒ³ã‚°ä¾¡æ ¼ã‚’å¼•ã„ãŸåŸºæœ¬ä¾¡æ ¼
                taxRate: taxRate,
                takeout: taxRate === 8 // 8%ãªã‚‰æŒã¡å¸°ã‚Šã€10%ãªã‚‰åº—å†…
              });
              
              orderItemIndex++;
            });
          }
          
          // ç·¨é›†ã•ã‚ŒãŸåˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
          let editedTotalAmount = 0;
          if (order.items && Array.isArray(order.items) && order.items.length > 0) {
            updatedItems.forEach((item, idx) => {
              const radio = document.querySelector(`input[name="taxRate${idx}"]:checked`);
              const editedPrice = radio ? parseFloat(radio.dataset.amount) : ((item.price + (item.toppingPrice || 0)) * item.quantity);
              editedTotalAmount += editedPrice;
            });
            
            // ãƒ¬ã‚¸è¢‹ã‚‚åŠ ç®—
            if (order.bagNeeded && order.bagQuantity > 0) {
              const bagRadio = document.querySelector(`input[name="taxRate${orderItemIndex}"]:checked`);
              const bagPrice = bagRadio ? parseFloat(bagRadio.dataset.amount) : (order.bagQuantity * 3);
              editedTotalAmount += bagPrice;
            }
          } else {
            // itemsãŒãªã„å ´åˆã¯æ³¨æ–‡å…¨ä½“ã®ç·¨é›†é¡ã‚’ä½¿ç”¨
            const radio = document.querySelector(`input[name="taxRate0"]:checked`);
            editedTotalAmount = radio ? parseFloat(radio.dataset.amount) : (order.totalAmount || 0);
          }
          
          await window.updateDoc(window.doc(window.db, 'stores', currentStoreId, 'orders', order.id), {
            paidAt: now,
            notifiedPaid: true,
            paymentMethod: selectedPaymentMethod,
            items: updatedItems.length > 0 ? updatedItems : order.items, // ç·¨é›†ã•ã‚ŒãŸå•†å“æƒ…å ±ã‚’ä¿å­˜
            totalAmount: editedTotalAmount // ç·¨é›†ã•ã‚ŒãŸåˆè¨ˆé‡‘é¡ã‚’ä¿å­˜
          });
        }
        
        console.log('ğŸ’° ä¼šè¨ˆå®Œäº†: Firebaseæ›´æ–°å®Œäº†');
        
        await showCustomConfirm({
          icon: 'ğŸ‰',
          title: 'ä¼šè¨ˆå®Œäº†',
          message: `${currentOrders.length}ä»¶ã®æ³¨æ–‡ã‚’ä¼šè¨ˆã—ã¾ã—ãŸ\n\nåˆè¨ˆ: Â¥${totalAmountToPay.toLocaleString()}`,
          btnClass: 'modal-btn-success',
          btnText: 'OK'
        });
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closePaymentModal();
        
        // ç¾åœ¨ã®æ³¨æ–‡ã‚’ã‚¯ãƒªã‚¢
        currentOrders = [];
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
        await loadTables();
        
      } catch (error) {
        console.error('âŒ ä¼šè¨ˆå®Œäº†ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomConfirm({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'ä¼šè¨ˆã®å®Œäº†ã«å¤±æ•—ã—ã¾ã—ãŸ',
          btnClass: 'modal-btn-danger',
          btnText: 'OK'
        });
      }
    };
    
    
    // ğŸ†• æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼ˆPOSã¨å®Œå…¨ã«åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    window.cancelOrdersForTable = async function() {
      closePaymentModal();
      
      const confirmed = await showCustomConfirm({
        icon: 'â¸ï¸',
        title: 'æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
        message: `${currentOrders.length}ä»¶ã®æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ`,
        btnClass: 'modal-btn-danger',
        btnText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
      });
      
      if (!confirmed) return;
      
      try {
        for (const order of currentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          // POSã¨åŒã˜: cancelledAtã‚’è¨­å®šï¼ˆstatusã¯ä½¿ã‚ãªã„ï¼‰
          await window.updateDoc(orderRef, {
            cancelledAt: window.Timestamp.now()
          });
        }
        
        await showCustomConfirm({
          icon: 'â¸ï¸',
          title: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ',
          message: `${currentOrders.length}ä»¶ã®æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ`,
          btnClass: 'modal-btn-success',
          btnText: 'OK'
        });
        
        currentOrders = [];
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
        await loadTables();
        
      } catch (error) {
        console.error('âŒ æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomConfirm({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'æ³¨æ–‡ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ',
          btnClass: 'modal-btn-danger',
          btnText: 'OK'
        });
      }
    };
    
    // ğŸ†• æ³¨æ–‡å‰Šé™¤ï¼ˆPOSã¨å®Œå…¨ã«åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    window.deleteOrdersForTable = async function() {
      closePaymentModal();
      
      const confirmed = await showCustomConfirm({
        icon: 'ğŸ—‘ï¸',
        title: 'æ³¨æ–‡å‰Šé™¤',
        message: `${currentOrders.length}ä»¶ã®æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“`,
        btnClass: 'modal-btn-danger',
        btnText: 'å‰Šé™¤'
      });
      
      if (!confirmed) return;
      
      try {
        for (const order of currentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          // POSã¨åŒã˜: deletedãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ï¼ˆç‰©ç†å‰Šé™¤ã¯ã—ãªã„ï¼‰
          await window.updateDoc(orderRef, {
            deleted: true,
            deletedAt: window.Timestamp.now()
          });
        }
        
        await showCustomConfirm({
          icon: 'ğŸ—‘ï¸',
          title: 'å‰Šé™¤ã—ã¾ã—ãŸ',
          message: `${currentOrders.length}ä»¶ã®æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`,
          btnClass: 'modal-btn-success',
          btnText: 'OK'
        });
        
        currentOrders = [];
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
        await loadTables();
        
      } catch (error) {
        console.error('âŒ æ³¨æ–‡å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomConfirm({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'æ³¨æ–‡ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ',
          btnClass: 'modal-btn-danger',
          btnText: 'OK'
        });
      }
    };
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚: FirebaseåˆæœŸåŒ–ã‚’å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œ
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('ğŸ“± ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•');
      
      // FirebaseåˆæœŸåŒ–ã‚’å¾…ã¤
      while (!window.firebaseReady || !window.db) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      console.log('âœ… Firebaseæº–å‚™å®Œäº†ã€åº—èˆ—ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã™');
      
      // åº—èˆ—ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
      await loadStoreList();
      
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å¾©å…ƒ
      const savedStoreId = sessionStorage.getItem('handyStoreId');
      const savedStoreName = sessionStorage.getItem('handyStoreName');
      
      if (savedStoreId && savedStoreName && storesData[savedStoreId]) {
        currentStoreId = savedStoreId;
        currentStoreName = savedStoreName;
        
        console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å¾©å…ƒ:', currentStoreName);
        showTablesScreen();
      }
    });
  </script>
</body>
</html>
