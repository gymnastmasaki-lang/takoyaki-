<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>„Éè„É≥„Éá„Ç£„Ç∑„Çπ„ÉÜ„É†</title>
  <!-- ========== üì¶ Service Worker ÁôªÈå≤Ôºà„Ç™„Éï„É©„Ç§„É≥ÂØæÂøúÔºâ ========== -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(reg => console.log('‚úÖ SWÁôªÈå≤ÂÆå‰∫Ü:', reg.scope))
          .catch(err => console.warn('‚ö†Ô∏è SWÁôªÈå≤Â§±Êïó:', err));
      });
    }
  </script>
  <!-- ========== üì¶ „Åì„Åì„Åæ„Åß ========== -->
  
  <!-- Â§ñÈÉ®„É©„Ç§„Éñ„É©„É™ -->
  <!-- QR„Ç≥„Éº„ÉâÁîüÊàê -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- HTML to Canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- „Éó„É™„É≥„Çø„ÉºÁî®„É©„Ç§„Éñ„É©„É™Ôºà„É≠„Éº„Ç´„É´ÂÆüË£ÖÔºâ -->
  <script>
    // StarWebPrint‰∫íÊèõ„ÅÆ„Éì„É´„ÉÄ„Éº„ÇØ„É©„ÇπÔºàÁ∞°ÊòìÁâàÔºâ
    class StarWebPrintBuilder {
      constructor() {
        this.commands = [];
      }
      
      createInitializationElement() {
        this.commands.push('\x1b\x40'); // ÂàùÊúüÂåñ
        return this;
      }
      
      createAlignmentElement(options) {
        const alignMap = { left: '\x1b\x61\x00', center: '\x1b\x61\x01', right: '\x1b\x61\x02' };
        this.commands.push(alignMap[options.position] || alignMap.left);
        return this;
      }
      
      createTextElement(options) {
        let cmd = '';
        if (options.emphasis) cmd += '\x1b\x45\x01'; // Âº∑Ë™øON
        if (options.width === 2 && options.height === 2) cmd += '\x1d\x21\x11'; // 2ÂÄç
        else if (options.width === 2) cmd += '\x1d\x21\x10'; // ÂπÖ2ÂÄç
        else if (options.height === 2) cmd += '\x1d\x21\x01'; // È´ò„Åï2ÂÄç
        else cmd += '\x1d\x21\x00'; // ÈÄöÂ∏∏
        
        if (options.invert) cmd += '\x1d\x42\x01'; // ÂèçËª¢ON
        if (options.data) cmd += options.data;
        if (options.invert) cmd += '\x1d\x42\x00'; // ÂèçËª¢OFF
        if (options.emphasis === false) cmd += '\x1b\x45\x00'; // Âº∑Ë™øOFF
        
        this.commands.push(cmd);
        return this;
      }
      
      createRuledLineElement(options) {
        const lines = { thin: '--------------------------------\n', medium: '================================\n', thick: '################################\n' };
        this.commands.push(lines[options.thickness] || lines.thin);
        return this;
      }
      
      createCutPaperElement(options) {
        if (options.feed) this.commands.push('\n\n\n');
        this.commands.push('\x1d\x56\x00'); // „Ç´„ÉÉ„Éà
        return this;
      }
      
      createPeripheralElement(options) {
        return this; // „Éñ„Ç∂„ÉºÁ≠â„ÅØÁúÅÁï•
      }
      
      toString() {
        return this.commands.join('');
      }
    }
    
    // StarWebPrintTrader‰∫íÊèõ„ÇØ„É©„Çπ
    class StarWebPrintTrader {
      constructor(options) {
        this.url = options.url;
        this.onReceive = null;
        this.onError = null;
      }
      
      async sendMessage(request) {
        try {
          const response = await fetch(this.url, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain; charset=utf-8' },
            body: request
          });
          
          if (response.ok && this.onReceive) {
            this.onReceive({ status: 'success' });
          } else if (this.onError) {
            this.onError({ status: response.status + ' ' + response.statusText });
          }
        } catch (error) {
          if (this.onError) {
            this.onError({ status: error.message });
          }
        }
      }
    }
    
    // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
    window.StarWebPrintBuilder = StarWebPrintBuilder;
    window.StarWebPrintTrader = StarWebPrintTrader;
  </script>
  
  <!-- „Åù„ÅÆ‰ªñ„ÅÆ„É©„Ç§„Éñ„É©„É™ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <!-- „Çø„ÉÉ„ÉóÈü≥ -->
  <script>
    // AudioContext„Çí‰ΩøÁî®„Åó„Åü„Çø„ÉÉ„ÉóÈü≥ÁîüÊàê
    let audioContext = null;
    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }
    function playTapSound() {
      initAudio();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* „É≠„Ç∞„Ç§„É≥ÁîªÈù¢ */
    .login-screen {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .login-screen h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 28px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .login-btn:active {
      transform: scale(0.98);
    }
    
    /* „ÉÜ„Éº„Éñ„É´‰∏ÄË¶ßÁîªÈù¢ */
    .tables-screen {
      display: none;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .header h2 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .header .store-info {
      color: #666;
      font-size: 14px;
    }
    
    .header-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .logout-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .sales-btn {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .settings-btn {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .instant-checkout-card {
      grid-column: span 2;
      padding: 20px;
    }
    
    .table-card {
      background: white;
      border-radius: 15px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    
    .table-memo-display {
      font-size: 10px;
      color: #5c6bc0;
      background: #e8eaf6;
      border-radius: 6px;
      padding: 3px 7px;
      margin-top: 6px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: pre-line;
      line-height: 1.3;
      word-break: break-all;
    }
    
    .table-memo-btn {
      position: absolute;
      bottom: 8px;
      right: 8px;
      background: rgba(102,126,234,0.15);
      border: none;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      padding: 3px 6px;
      color: #667eea;
      z-index: 2;
    }
    .table-memo-btn:hover { background: rgba(102,126,234,0.3); }
    
    /* „É°„É¢„ÅÇ„Çä„ÉÜ„Éº„Éñ„É´„Ç´„Éº„Éâ„ÅÆËâ≤ */
    .table-card.has-memo {
      border: 3px solid #9c27b0 !important;
      background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%) !important;
    }
    .table-card.has-memo .table-name { color: #6a1b9a !important; }
    
    /* „É°„É¢„É¢„Éº„ÉÄ„É´ */
    #tableMemoModal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      z-index: 9999;
      align-items: center;
      justify-content: center;
    }
    #tableMemoModal.active { display: flex; }
    .table-memo-modal-inner {
      background: white;
      border-radius: 16px;
      padding: 28px;
      width: 340px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .table-memo-modal-inner h3 { margin: 0 0 14px; font-size: 18px; color: #333; }
    .table-memo-modal-inner textarea {
      width: 100%;
      box-sizing: border-box;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px;
      font-size: 14px;
      resize: vertical;
      min-height: 120px;
      outline: none;
      font-family: inherit;
    }
    .table-memo-modal-inner textarea:focus { border-color: #667eea; }
    .table-memo-modal-btns { display: flex; gap: 10px; margin-top: 16px; }
    .table-memo-modal-btns button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: bold;
      cursor: pointer;
    }
    .btn-memo-save { background: #667eea; color: white; }
    .btn-memo-clear { background: #ff7043; color: white; }
    .btn-memo-cancel { background: #e0e0e0; color: #555; }
    
    .table-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .table-card:active {
      transform: translateY(-2px);
    }
    
    .table-card.has-pending-orders {
      background: linear-gradient(135deg, #fff4e6 0%, #ffe0b2 100%);
      border: 2px solid #ff9800;
    }
    
    .table-card.has-pending-orders .table-name {
      color: #f57c00;
    }
    
    .table-card.has-pending-orders .pending-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff9800;
      color: white;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
    }
    
    .status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
    }
    
    .unpaid-badge {
      background: #f57c00;
      color: white;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }
    
    .table-card .table-name {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
      word-break: break-all;
      line-height: 1.3;
    }
    
    .table-card .table-status {
      font-size: 12px;
      color: #999;
    }
    
    .checkout-btn {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .checkout-btn:active {
      transform: scale(0.95);
    }
    
    /* ‰øÆÊ≠£ÁÆáÊâÄ: hidden„ÇØ„É©„Çπ„ÅÆÂÆöÁæ©„ÇíÊòéÁ¢∫„Å´„Åô„Çã */
    .hidden {
      display: none !important;
    }
    
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }
    
    /* Â£≤‰∏ä„É¢„Éº„ÉÄ„É´Áî®CSS */
    .sales-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    
    .sales-modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    .sales-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .sales-modal-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    
    .sales-modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .sales-modal-close:hover {
      color: #333;
    }
    
    .custom-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10002;
      align-items: center;
      justify-content: center;
    }
    
    .custom-modal-box {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .modal-icon {
      font-size: 64px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 15px;
      color: #333;
    }
    
    .modal-message {
      text-align: center;
      font-size: 16px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.6;
      white-space: pre-line;
    }
    
    .modal-buttons {
      display: flex;
      gap: 15px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 18px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .modal-btn:active {
      transform: scale(0.95);
    }
    
    .modal-btn-cancel {
      background: #e0e0e0;
      color: #333;
    }
    
    .modal-btn-cancel:hover {
      background: #d0d0d0;
    }
    
    .modal-btn-danger {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
    }
    
    .modal-btn-success {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    /* ‰øÆÊ≠£ÁÆáÊâÄ: .modal-overlay„ÅÆdisplayË®≠ÂÆö„Çí‰øÆÊ≠£ */
    .modal-overlay {
      display: flex; /* none„Åã„ÇâÂ§âÊõ¥„ÄÇË°®Á§∫ÈùûË°®Á§∫„ÅØ.hidden„ÇØ„É©„Çπ„ÅßÂà∂Âæ°„Åô„Çã */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10001;
      align-items: center;
      justify-content: center;
    }
    
    .modal {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal h3 {
      margin: 0 0 20px 0;
      color: #333;
      font-size: 24px;
      text-align: center;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .payment-methods {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .payment-method-btn {
      padding: 15px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .payment-method-btn:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    
    .payment-method-btn.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .cash-input-section {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    
    .cash-input-section label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    
    .cash-input-section input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 18px;
      text-align: center;
    }
    
    .change-display {
      margin-top: 15px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
    }
    
    .change-amount {
      color: #4CAF50;
      font-size: 20px;
    }
    
    .order-selection-btn {
      width: 100%;
      padding: 20px;
      margin-bottom: 15px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
    }
    
    .order-selection-btn:hover {
      border-color: #667eea;
      background: #f8f9ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .order-selection-btn:active {
      transform: translateY(0);
    }
    
    /* üÜï „É¢„Éº„ÉÄ„É´ÂÖ±ÈÄö„Çπ„Çø„Ç§„É´ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10001;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
    }
    
    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 20px;
    }
    
    .modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 28px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.2s;
      line-height: 1;
    }
    
    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .modal-footer {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    /* üÜï Ê©üËÉΩ„Çµ„Éñ„É°„Éã„É•„Éº */
    .header-buttons {
      position: relative;
      display: flex;
      gap: 10px;
    }
    
    .functions-submenu {
      position: absolute;
      top: 45px;
      left: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      margin-top: 8px;
      min-width: 220px;
      z-index: 1000;
      overflow: hidden;
      border: 1px solid rgba(102, 126, 234, 0.1);
    }
    
    .functions-submenu button {
      width: 100%;
      padding: 14px 18px;
      background: white;
      border: none;
      border-left: 3px solid transparent;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .functions-submenu button::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: transform 0.2s ease;
    }
    
    .functions-submenu button:first-child {
      border-radius: 12px 12px 0 0;
    }
    
    .functions-submenu button:last-child {
      border-radius: 0 0 12px 12px;
    }
    
    .functions-submenu button:hover {
      background: linear-gradient(90deg, rgba(102, 126, 234, 0.08) 0%, rgba(255, 255, 255, 0) 100%);
      border-left-color: #667eea;
      padding-left: 22px;
    }
    
    .functions-submenu button:hover::before {
      transform: scale(1.3);
    }
    
    .functions-submenu button:active {
      background: linear-gradient(90deg, rgba(102, 126, 234, 0.12) 0%, rgba(255, 255, 255, 0) 100%);
      transform: scale(0.98);
    }
    
    /* üÜï POS„É¢„Éº„ÉÄ„É´Áî®„Çπ„Çø„Ç§„É´ */
    .pos-iframe-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }
    
    .pos-iframe-modal.active {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .pos-iframe-container {
      width: 95%;
      height: 95%;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
    }
    
    .pos-iframe-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .pos-iframe-header h3 {
      margin: 0;
      font-size: 18px;
    }
    
    .pos-iframe-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .pos-iframe-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .pos-iframe-content {
      flex: 1;
      width: 100%;
      border: none;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
  
  <!-- „Ç´„Çπ„Çø„É†„Ç¢„É©„Éº„Éà/Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
  <script>
    // „Ç´„Çπ„Çø„É†„Ç¢„É©„Éº„ÉàË°®Á§∫Èñ¢Êï∞
    window.showCustomAlert = function(message, title = '„ÅäÁü•„Çâ„Åõ') {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease-out;
        padding: 20px;
      `;
      
      const alertBox = document.createElement('div');
      alertBox.style.cssText = `
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 24px;
        padding: 40px;
        max-width: 450px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        border: 2px solid rgba(255,255,255,0.2);
        animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      `;
      
      alertBox.innerHTML = `
        <h3 style="color: white; font-size: 24px; font-weight: bold; margin-bottom: 16px; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
          ${title}
        </h3>
        <p style="color: rgba(255,255,255,0.95); font-size: 16px; margin-bottom: 30px; text-align: center; line-height: 1.7; white-space: pre-line;">
          ${message}
        </p>
        <button style="width: 100%; padding: 14px; background: white; color: #667eea; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s;">
          OK
        </button>
      `;
      
      overlay.appendChild(alertBox);
      document.body.appendChild(overlay);
      
      const closeAlert = () => {
        overlay.style.animation = 'fadeOut 0.2s ease-out';
        setTimeout(() => overlay.remove(), 200);
      };
      
      alertBox.querySelector('button').onclick = closeAlert;
      overlay.onclick = (e) => {
        if (e.target === overlay) closeAlert();
      };
    };
    
    // „Ç´„Çπ„Çø„É†Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞Ë°®Á§∫Èñ¢Êï∞
    window.showCustomConfirm = function(message, title = 'Á¢∫Ë™ç') {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.7);
          backdrop-filter: blur(8px);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          animation: fadeIn 0.3s ease-out;
          padding: 20px;
        `;
        
        const confirmBox = document.createElement('div');
        confirmBox.style.cssText = `
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border-radius: 24px;
          padding: 40px;
          max-width: 450px;
          width: 90%;
          box-shadow: 0 20px 60px rgba(0,0,0,0.4);
          border: 2px solid rgba(255,255,255,0.2);
          animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        `;
        
        confirmBox.innerHTML = `
          <h3 style="color: white; font-size: 24px; font-weight: bold; margin-bottom: 16px; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
            ${title}
          </h3>
          <p style="color: rgba(255,255,255,0.95); font-size: 16px; margin-bottom: 30px; text-align: center; line-height: 1.7; white-space: pre-line;">
            ${message}
          </p>
          <div style="display: flex; gap: 12px;">
            <button class="cancel-btn" style="flex: 1; padding: 14px; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s;">
              „Ç≠„É£„É≥„Çª„É´
            </button>
            <button class="ok-btn" style="flex: 1; padding: 14px; background: white; color: #667eea; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s;">
              OK
            </button>
          </div>
        `;
        
        overlay.appendChild(confirmBox);
        document.body.appendChild(overlay);
        
        const closeConfirm = (result) => {
          overlay.style.animation = 'fadeOut 0.2s ease-out';
          setTimeout(() => {
            overlay.remove();
            resolve(result);
          }, 200);
        };
        
        confirmBox.querySelector('.ok-btn').onclick = () => closeConfirm(true);
        confirmBox.querySelector('.cancel-btn').onclick = () => closeConfirm(false);
        overlay.onclick = (e) => {
          if (e.target === overlay) closeConfirm(false);
        };
      });
    };
  </script>
  
</head>
<body>
  <div class="container">
    <div class="login-screen" id="loginScreen">
      <h1>„Éè„É≥„Éá„Ç£„Ç∑„Çπ„ÉÜ„É†</h1>
      <div id="errorMessage" class="error-message hidden"></div>
      
      <div class="form-group">
        <label for="storeSelect">Â∫óËàó„ÇíÈÅ∏Êäû</label>
        <select id="storeSelect">
          <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="passwordInput">„Éë„Çπ„ÉØ„Éº„Éâ</label>
        <input type="password" id="passwordInput" placeholder="„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ">
      </div>
      
      <button class="login-btn" onclick="playTapSound(); handleLogin()">„É≠„Ç∞„Ç§„É≥</button>
    </div>
    
    <div class="tables-screen" id="tablesScreen">
      <div class="header">
        <h2 id="storeNameDisplay">Â∫óËàóÂêç</h2>
        <div class="store-info">„ÉÜ„Éº„Éñ„É´„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
        <div class="header-buttons">
          <button class="sales-btn" onclick="playTapSound(); toggleFunctionsMenu()">Ê©üËÉΩ ‚ñº</button>
          <button class="settings-btn" onclick="playTapSound(); window.open('https://gymnastmasaki-lang.github.io/takoyaki-/kanri.html', '_blank')">Ë®≠ÂÆö</button>
          <button class="logout-btn" onclick="playTapSound(); handleLogout()">„É≠„Ç∞„Ç¢„Ç¶„Éà</button>
        </div>
        <!-- üÜï Ê©üËÉΩ„Çµ„Éñ„É°„Éã„É•„Éº -->
        <div id="functionsSubMenu" class="functions-submenu" style="display: none;">
          <button onclick="playTapSound(); window.open('https://gymnastmasaki-lang.github.io/takoyaki-/kintai.html', '_blank')" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;">Âã§ÊÄ†</button>
          <button onclick="playTapSound(); showSalesModal()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;">Â£≤‰∏ä</button>
          <button onclick="playTapSound(); showHistoryModal()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;">Â±•Ê≠¥</button>
          <button onclick="playTapSound(); showExpenseModal()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;">ÊîØÂá∫</button>
          <button onclick="playTapSound(); openDrawerDirect()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;">„Éâ„É≠„Ç¢Èñã</button>
          <button onclick="playTapSound(); showDrawerSettings()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;">„Éâ„É≠„Ç¢Ë®≠ÂÆö</button>
          <button onclick="playTapSound(); showMonthlyReportModal()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;">ÊúàÊ¨°</button>
          <button onclick="playTapSound(); showBulkInventoryModal()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;">Âú®Â∫´‰∏ÄÊã¨Ë®≠ÂÆö</button>
        </div>
      </div>
      
      <div class="tables-grid" id="tablesGrid">
        <div class="loading">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
      </div>
    </div>
  </div>
  
  <div id="customConfirmModal" class="custom-modal-overlay">
    <div class="custom-modal-box">
      <div class="modal-icon" id="modalIcon">‚ö†</div>
      <div class="modal-title" id="modalTitle">Á¢∫Ë™ç</div>
      <div class="modal-message" id="modalMessage">Êú¨ÂΩì„Å´ÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="playTapSound(); closeCustomModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="modal-btn modal-btn-danger" id="modalConfirmBtn" onclick="playTapSound(); confirmCustomModal()">ÂÆüË°å</button>
      </div>
    </div>
  </div>
  
  <!-- Ê≥®ÊñáÈÅ∏Êäû„É¢„Éº„ÉÄ„É´ -->
  <div id="orderSelectionModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>Ê≥®Êñá„ÇíÈÅ∏Êäû</h3>
      <p id="orderSelectionTableName" style="color: #666; margin-bottom: 20px; text-align: center; font-size: 18px; font-weight: bold;">„ÉÜ„Éº„Éñ„É´</p>
      <div id="ordersList" style="max-height: 60vh; overflow-y: auto;"></div>
      <div style="margin-top: 20px;">
        <button class="btn btn-secondary" style="width: 100%;" onclick="playTapSound(); closeOrderSelectionModal()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>
  
  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3> ‰ºöË®àÂá¶ÁêÜ</h3>
      <p id="selectedTableLabel2" style="color: #666; margin-bottom: 20px;">„ÉÜ„Éº„Éñ„É´</p>
      
      <div id="taxRateSection" style="margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px; border-left: 4px solid #4CAF50; max-height: 300px; overflow-y: auto;">
        <h4 style="margin: 0 0 15px 0; color: #2e7d32; font-size: 16px;">ÂêÑÂïÜÂìÅ„ÅÆÁ®éÁéá„ÇíÈÅ∏Êäû</h4>
        <div id="taxRateItemsList"></div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #4CAF50; font-weight: bold; font-size: 14px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>8%ÂØæË±°:</span>
            <span id="tax8Summary" style="color: #FF9800;">¬•0</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>10%ÂØæË±°:</span>
            <span id="tax10Summary" style="color: #2196F3;">¬•0</span>
          </div>
        </div>
      </div>
      
      <div class="payment-methods">
        <button class="payment-method-btn" onclick="playTapSound(); selectPaymentMethod('cash')">
          üíµ ÁèæÈáë
        </button>
        <button class="payment-method-btn" onclick="playTapSound(); selectPaymentMethod('emoney')">
           ÈõªÂ≠ê„Éû„Éç„Éº
        </button>
        <button class="payment-method-btn" onclick="playTapSound(); selectPaymentMethod('credit')">
          „ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„Éâ
        </button>
      </div>
      
      <div id="cashInputSection" class="cash-input-section hidden">
        <label>„ÅäÈ†ê„Åã„ÇäÈáëÈ°ç</label>
        <input type="number" id="cashReceived" placeholder="0" oninput="calculateChange()">
        <div class="change-display" id="changeDisplay">
          „Åä„Å§„Çä: <span class="change-amount" id="changeAmount">¬•0</span>
        </div>
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 10px;">
        <label style="font-weight: bold; color: #856404;">ÂÄ§Âºï„ÅçÈáëÈ°ç</label>
        <input type="number" id="discountAmount" placeholder="0" value="0" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ffc107; border-radius: 8px; margin-top: 8px;" oninput="updatePaymentTotal()">
        <div style="text-align: center; margin-top: 10px; font-size: 18px; font-weight: bold; color: #333;">
          Ë´ãÊ±ÇÈ°ç: <span id="finalPaymentAmount" style="color: #4CAF50;">¬•0</span>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;" id="mainButtons">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="playTapSound(); processPayment()" id="paymentBtn" disabled> ‰ºöË®à</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white;" onclick="playTapSound(); completeOrdersForTable()">‚úÖ ÂÆå‰∫Ü</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white;" onclick="playTapSound(); cancelOrdersForTable()">‚è∏ „Ç≠„É£„É≥„Çª„É´</button>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="playTapSound(); deleteOrdersForTable()">üóë ÂâäÈô§</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="playTapSound(); closePaymentModal()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>

  <div id="priceChangeModal" class="modal-overlay hidden">
    <div class="modal">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 50px; margin-bottom: 10px;">üí¥</div>
        <h3 style="margin: 0; font-size: 20px; color: #333;" id="priceChangeTitle">ÈáëÈ°ç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ</h3>
      </div>
      
      <div style="background: #f5f5f5; border-radius: 10px; padding: 15px; margin: 20px 0; text-align: center;">
        <div style="color: #666; margin-bottom: 10px;" id="priceChangeItemInfo"></div>
        <div style="font-size: 18px; font-weight: bold; color: #333;">
          ÁèæÂú®: <span id="priceChangeCurrentPrice"></span>
        </div>
      </div>
      
      <div style="margin: 20px 0;">
        <input type="number" id="priceChangeInput" placeholder="Êñ∞„Åó„ÅÑÈáëÈ°ç„ÇíÂÖ•Âäõ" style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 24px; text-align: center;">
      </div>
      
      <input type="hidden" id="priceChangeItemId">
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="playTapSound(); closePriceChangeModal()">„Ç≠„É£„É≥„Çª„É´</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="playTapSound(); confirmPriceChange()">‚úì Â§âÊõ¥</button>
      </div>
    </div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { initializeFirestore, persistentLocalCache, persistentMultipleTabManager, collection, query, getDocs, doc, getDoc, setDoc, where, onSnapshot, updateDoc, deleteDoc, Timestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = initializeFirestore(app, {
      localCache: persistentLocalCache({
        tabManager: persistentMultipleTabManager()
      })
    });
    
    // „Ç∞„É≠„Éº„Éê„É´„Å´ÂÖ¨Èñã
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.onSnapshot = onSnapshot;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.Timestamp = Timestamp;
    window.orderBy = orderBy;
    window.limit = limit;
    
    // Â∫óËàóÂà•„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥ÂèÇÁÖß„ÇíÂèñÂæó
    window.getStoreCollection = function(collectionName) {
      console.log('üîç HANDY getStoreCollectionÂëº„Å≥Âá∫„Åó');
      console.log('   „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥Âêç:', collectionName);
      console.log('   window.currentStoreId:', window.currentStoreId);
      console.log('   typeof:', typeof window.currentStoreId);
      
      // currentStoreId„Åånull„Åæ„Åü„ÅØÁ©∫„ÅÆÂ†¥Âêà„ÅØÊóß„Éë„Çπ„Çí‰ΩøÁî®
      if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
        const oldPathMap = {
          "menus": "menu",
          "employees": "kintai_employees",
          "attendance": "kintai_attendance",
          "orders": "orders",
          "tables": "tables"
        };
        const path = oldPathMap[collectionName] || collectionName;
        console.log('   ‚Üí Êóß„Éë„Çπ‰ΩøÁî®:', path);
        return collection(db, path);
      }
      console.log('   ‚Üí Êñ∞„Éë„Çπ‰ΩøÁî®: stores/' + window.currentStoreId + '/' + collectionName);
      return collection(db, "stores", window.currentStoreId, collectionName);
    };

    // Â∫óËàóÂà•„Éâ„Ç≠„É•„É°„É≥„ÉàÂèÇÁÖß„ÇíÂèñÂæó
    window.getStoreDoc = function(collectionName, docId) {
      console.log('üîç HANDY getStoreDocÂëº„Å≥Âá∫„Åó');
      console.log('   „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥Âêç:', collectionName, '„Éâ„Ç≠„É•„É°„É≥„ÉàID:', docId);
      console.log('   window.currentStoreId:', window.currentStoreId);
      
      // currentStoreId„Åånull„Åæ„Åü„ÅØÁ©∫„ÅÆÂ†¥Âêà„ÅØÊóß„Éë„Çπ„Çí‰ΩøÁî®
      if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
        const oldPathMap = {
          "menus": "menu",
          "employees": "kintai_employees",
          "attendance": "kintai_attendance",
          "orders": "orders",
          "tables": "tables"
        };
        const path = oldPathMap[collectionName] || collectionName;
        console.log('   ‚Üí Êóß„Éë„Çπ‰ΩøÁî®:', path + '/' + docId);
        return doc(db, path, docId);
      }
      console.log('   ‚Üí Êñ∞„Éë„Çπ‰ΩøÁî®: stores/' + window.currentStoreId + '/' + collectionName + '/' + docId);
      return doc(db, "stores", window.currentStoreId, collectionName, docId);
    };
    
    console.log('‚úÖ FirebaseÂàùÊúüÂåñÂÆå‰∫Ü');
    
    window.firebaseReady = true;
    window.dispatchEvent(new Event('firebaseReady'));

    // ========== üì° „Ç™„Éï„É©„Ç§„É≥/„Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖãÁÆ°ÁêÜ ==========
    function showOfflineBanner() {
      let banner = document.getElementById('offline-banner');
      if (!banner) {
        banner = document.createElement('div');
        banner.id = 'offline-banner';
        banner.style.cssText = `
          position: fixed; top: 0; left: 0; right: 0; z-index: 99999;
          background: #e74c3c; color: white; text-align: center;
          padding: 10px 16px; font-size: 14px; font-weight: bold;
          box-shadow: 0 2px 8px rgba(0,0,0,0.3);
          display: flex; align-items: center; justify-content: center; gap: 8px;
        `;
        document.body.appendChild(banner);
      }
      banner.innerHTML = '‚ö†Ô∏è „Ç™„Éï„É©„Ç§„É≥‰∏≠ ‚Äî Ê≥®Êñá„ÅØËá™Âãï‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ„Éç„ÉÉ„ÉàÂæ©ÊóßÂæå„Å´Ëá™ÂãïÈÄÅ‰ø°„Åï„Çå„Åæ„Åô„ÄÇ';
      banner.style.display = 'flex';
    }
    function hideOfflineBanner() {
      const banner = document.getElementById('offline-banner');
      if (banner) banner.style.display = 'none';
    }
    function showRestoredBanner() {
      let banner = document.getElementById('offline-banner');
      if (!banner) {
        banner = document.createElement('div');
        banner.id = 'offline-banner';
        banner.style.cssText = `
          position: fixed; top: 0; left: 0; right: 0; z-index: 99999;
          text-align: center; padding: 10px 16px; font-size: 14px; font-weight: bold;
          box-shadow: 0 2px 8px rgba(0,0,0,0.3);
          display: flex; align-items: center; justify-content: center; gap: 8px;
        `;
        document.body.appendChild(banner);
      }
      banner.style.background = '#27ae60';
      banner.innerHTML = '‚úÖ „Ç™„É≥„É©„Ç§„É≥Âæ©Êóß ‚Äî Êú™ÈÄÅ‰ø°„ÅÆÊ≥®Êñá„Çí„Çµ„Éº„Éê„Éº„Å∏ÂêåÊúü‰∏≠...';
      banner.style.display = 'flex';
      setTimeout(() => { banner.style.display = 'none'; }, 5000);
    }

    if (!navigator.onLine) showOfflineBanner();
    window.addEventListener('offline', () => { showOfflineBanner(); });
    window.addEventListener('online', () => { showRestoredBanner(); });
    // ========== üì° „Åì„Åì„Åæ„Åß ==========
  </script>
  
  <script>
    // ========== ‚è∞ JST3ÊôÇÂü∫Ê∫ñ„Éò„É´„Éë„Éº ==========
    window.getBusinessDay = function(date) {
      const d = date || new Date();
      const JST = 9 * 60 * 60 * 1000;
      const jstMs = d.getTime() + JST;
      const jstMidnightMs = jstMs - (jstMs % (24 * 60 * 60 * 1000));
      const boundary = new Date(jstMidnightMs + (3 * 60 * 60 * 1000) - JST);
      const base = d < boundary
        ? new Date(boundary.getTime() - 24 * 60 * 60 * 1000)
        : boundary;
      const jstBase = new Date(base.getTime() + JST);
      return {
        date: base,
        year:  jstBase.getUTCFullYear(),
        month: jstBase.getUTCMonth() + 1,
        day:   jstBase.getUTCDate(),
        str:   `${jstBase.getUTCFullYear()}-${String(jstBase.getUTCMonth()+1).padStart(2,'0')}-${String(jstBase.getUTCDate()).padStart(2,'0')}`
      };
    };
    // ========== ‚è∞ JST3ÊôÇÂü∫Ê∫ñ„Éò„É´„Éë„Éº„Åì„Åì„Åæ„Åß ==========
  </script>

  <script>
    let currentStoreId = null;
    let currentStoreName = null;
    let storesData = {};
    let ordersListener = null;
    let currentOrders = [];
    let currentTableSettings = null;  // üÜï ÁèæÂú®„ÅÆ„ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö
    let isInstantCheckoutMode = false;  // Âç≥‰ºöË®à„É¢„Éº„Éâ„Éï„É©„Ç∞
    
    let selectedPaymentMethod = null;
    let totalAmountToPay = 0;
    let cashReceived = 0;
    let changeAmount = 0;
    let customModalResolve = null;
    
    // üÜï „Ç∞„É≠„Éº„Éê„É´„Éá„Éï„Ç©„É´„ÉàÁ®éÁéá
    let globalDefaultTaxRate = 10;
    
    // üÜï „Ç´„Çπ„Çø„É†„Ç¢„É©„Éº„ÉàÈñ¢Êï∞Ôºà„Ç™„Ç∑„É£„É¨Áâà„ÉªÁµµÊñáÂ≠ó„Å™„ÅóÔºâ
    window.showCustomAlert = function(options) {
      return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.id = 'customAlertModal';
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
          background: rgba(0,0,0,0.7); display: flex; align-items: center; 
          justify-content: center; z-index: 999999; animation: fadeIn 0.2s;
        `;
        
        const title = options.title || 'ÈÄöÁü•';
        const message = options.message || '';
        const type = options.type || 'info'; // 'success', 'error', 'warning', 'info'
        const confirmText = options.confirmText || 'OK';
        const cancelText = options.cancelText;
        const showCancel = !!cancelText;
        
        // „Çø„Ç§„Éó„Å´„Çà„ÇãËâ≤ÂàÜ„Åë
        let gradient = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        let iconColor = '#667eea';
        if (type === 'success') {
          gradient = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
          iconColor = '#4CAF50';
        } else if (type === 'error') {
          gradient = 'linear-gradient(135deg, #f44336 0%, #c62828 100%)';
          iconColor = '#f44336';
        } else if (type === 'warning') {
          gradient = 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
          iconColor = '#FF9800';
        }
        
        modal.innerHTML = `
          <div style="
            background: ${gradient};
            border-radius: 24px; padding: 0; max-width: 500px; width: 90%;
            box-shadow: 0 25px 60px rgba(0,0,0,0.4); overflow: hidden;
            animation: slideUp 0.3s;
          ">
            <div style="background: white; padding: 32px; border-radius: 0 0 24px 24px;">
              <div style="text-align: center; margin-bottom: 24px;">
                <div style="width: 60px; height: 60px; margin: 0 auto 16px; background: ${iconColor}20; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                  <div style="width: 30px; height: 30px; border: 4px solid ${iconColor}; border-radius: 50%;"></div>
                </div>
                <h3 style="font-size: 24px; font-weight: bold; color: #333; margin-bottom: 8px;">
                  ${title}
                </h3>
                <div style="color: #666; font-size: 16px; line-height: 1.6;">
                  ${message}
                </div>
              </div>
              
              <div style="display: flex; gap: 12px; margin-top: 24px;">
                ${showCancel ? `
                  <button id="customAlertCancel" style="
                    flex: 1; padding: 16px; font-size: 16px; font-weight: bold;
                    border: 2px solid #ddd; border-radius: 12px; cursor: pointer;
                    background: white; color: #666; transition: all 0.2s;
                  " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                    ${cancelText}
                  </button>
                ` : ''}
                <button id="customAlertConfirm" style="
                  flex: 1; padding: 16px; font-size: 16px; font-weight: bold;
                  border: none; border-radius: 12px; cursor: pointer;
                  background: ${gradient};
                  color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                  transition: all 0.2s;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.5)'" 
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'">
                  ${confirmText}
                </button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('customAlertConfirm').onclick = () => {
          modal.remove();
          resolve(true);
        };
        
        if (showCancel) {
          document.getElementById('customAlertCancel').onclick = () => {
            modal.remove();
            resolve(false);
          };
        }
      });
    };
    
    // üÜï Á®éÈ°çË®àÁÆóÈñ¢Êï∞
    function getTaxAmount(item, quantity = 1) {
      const taxType = item.taxType || 'inclusive';
      const basePrice = item.price + (item.toppingPrice || 0);
      
      // „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö„Å´Âü∫„Å•„ÅÑ„Å¶ÈÅ©Áî®Á®éÁéá„ÇíÊ±∫ÂÆö
      const taxRate = getApplicableTaxRate(item, currentTableSettings);
      
      if (taxType === 'exclusive') {
        return Math.floor(basePrice * quantity * taxRate / 100);
      } else {
        const totalWithTax = basePrice * quantity;
        const totalWithoutTax = Math.floor(totalWithTax / (1 + taxRate / 100));
        return totalWithTax - totalWithoutTax;
      }
    }
    
    // üÜï ÈÅ©Áî®Á®éÁéá„ÇíÊ±∫ÂÆö„Åô„ÇãÈñ¢Êï∞
    function getApplicableTaxRate(item, tableSettings) {
      // „É¨„Ç∏Ë¢ã„ÅØÂ∏∏„Å´10%
      if (item.name?.includes('„É¨„Ç∏Ë¢ã') || item.name?.includes('Ë¢ã')) {
        return 10;
      }
      
      // foodType„ÇíÊ±∫ÂÆö
      let foodType = item.foodType || 'food';
      if (!item.foodType) {
        if (item.category === 'ÂåÖÊùê' || item.name?.includes('ÂåÖÊùê') || item.name?.includes('„É¨„Ç∏Ë¢ã') || item.name?.includes('Ë¢ã')) {
          foodType = 'non-food';
        }
      }
      
      // „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö„ÅåÊúâÂäπ„Å™Â†¥Âêà
      if (tableSettings && tableSettings.taxRule && tableSettings.taxRule !== 'none') {
        const taxRule = tableSettings.taxRule;
        
        switch(taxRule) {
          case 'takeout':
            return (foodType === 'food') ? 8 : 10;
          case 'dine-in':
            return 10;
          default:
            if (item.taxRate !== undefined && item.taxRate !== null) {
              return item.taxRate;
            }
            return (foodType === 'non-food') ? globalDefaultTaxRate : 8;
        }
      }
      
      // „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö„Åå„Å™„ÅÑÂ†¥Âêà
      if (item.taxRate !== undefined && item.taxRate !== null) {
        return item.taxRate;
      }
      
      return (foodType === 'non-food') ? 10 : 8;
    }
    
    function showCustomConfirm(options) {
      return new Promise((resolve) => {
        customModalResolve = resolve;
        const modal = document.getElementById('customConfirmModal');
        const icon = document.getElementById('modalIcon');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        
        icon.textContent = options.icon || '‚ö†';
        title.textContent = options.title || 'Á¢∫Ë™ç';
        message.textContent = options.message || 'Êú¨ÂΩì„Å´ÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü';
        
        confirmBtn.className = 'modal-btn ' + (options.btnClass || 'modal-btn-danger');
        confirmBtn.textContent = options.btnText || 'ÂÆüË°å';
        
        modal.style.display = 'flex';
      });
    }
    
    function closeCustomModal() {
      document.getElementById('customConfirmModal').style.display = 'none';
      if (customModalResolve) {
        customModalResolve(false);
        customModalResolve = null;
      }
    }
    
    function confirmCustomModal() {
      document.getElementById('customConfirmModal').style.display = 'none';
      if (customModalResolve) {
        customModalResolve(true);
        customModalResolve = null;
      }
    }
    
    /**
     * üÜï ÂïÜÂìÅ„ÅÆÈÅ©Áî®Á®éÁéá„ÇíÊ±∫ÂÆöÔºà„ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö„Å®foodType„ÇíËÄÉÊÖÆÔºâ
     * üî• ÊîπÂñÑ: „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆöÔºàtakeout/dine-inÔºâ„ÅåÊúâÂäπ„Å™Â†¥Âêà„ÄÅÂïÜÂìÅ„ÅÆtaxRate„Çà„Çä„ÇÇfoodType„ÇíÂÑ™ÂÖà
     */
    function getApplicableTaxRate(item, tableSettings) {
      // üî• ÁâπÂà•Âá¶ÁêÜ: „É¨„Ç∏Ë¢ã„ÅØÂ∏∏„Å´10%ÔºàÊúÄÂÑ™ÂÖàÔºâ
      if (item.name?.includes('„É¨„Ç∏Ë¢ã') || item.name?.includes('üõç') || item.name?.includes('Ë¢ã')) {
        console.log(`üî• „É¨„Ç∏Ë¢ãÂà§ÂÆö: ${item.name} ‚Üí Âº∑Âà∂ÁöÑ„Å´10%`);
        return 10;
      }
      
      // üÜï foodType„ÇíÊ±∫ÂÆöÔºàÊú™Ë®≠ÂÆö„ÅÆÂ†¥Âêà„ÅØcategory„Åã„ÇâÊé®Ê∏¨Ôºâ
      let foodType = item.foodType;
      if (!foodType) {
        // „Ç´„ÉÜ„Ç¥„É™„Åå„ÄåÂåÖÊùê„Äç„Åæ„Åü„ÅØÂïÜÂìÅÂêç„Å´„ÄåÂåÖÊùê„Äç„ÇíÂê´„ÇÄÂ†¥Âêà„ÅØÈ£üÊùê‰ª•Â§ñ
        if (item.category === 'ÂåÖÊùê' || item.name?.includes('ÂåÖÊùê')) {
          foodType = 'non-food';
          console.log(`‚ö† foodTypeÊú™Ë®≠ÂÆö ‚Üí category/name(${item.category}/${item.name})„Åã„ÇâÊé®Ê∏¨: non-foodÔºàÈ£üÊùê‰ª•Â§ñÔºâ`);
        } else {
          foodType = 'food';  // „Éá„Éï„Ç©„É´„Éà„ÅØÈ£üÊùê
          console.log(`‚ö† foodTypeÊú™Ë®≠ÂÆö ‚Üí „Éá„Éï„Ç©„É´„Éà: foodÔºàÈ£üÊùêÔºâ, ÂïÜÂìÅÂêç: ${item.name}`);
        }
      } else {
        console.log(`‚úÖ foodTypeË®≠ÂÆöÊ∏à„Åø: ${foodType} (ÂïÜÂìÅ: ${item.name})`);
      }
      
      // üî• ÊîπÂñÑ: „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö„ÅåÊúâÂäπÔºàtakeout/dine-inÔºâ„Å™Â†¥Âêà„ÄÅfoodType„ÇíÂÑ™ÂÖà
      if (tableSettings && tableSettings.taxRule && tableSettings.taxRule !== 'none') {
        const taxRule = tableSettings.taxRule;
        console.log(`[Á®éÁéáÊ±∫ÂÆö] ÂïÜÂìÅ: ${item.name}, foodType: ${foodType}, taxRule: ${taxRule}`);
        
        switch(taxRule) {
          case 'takeout':
            // „ÉÜ„Ç§„ÇØ„Ç¢„Ç¶„Éà: È£üÊùê„ÅØ8%„ÄÅÈ£üÊùê‰ª•Â§ñ„ÅØ10%
            const takeoutRate = (foodType === 'food') ? 8 : 10;
            console.log(`  ‚Üí „ÉÜ„Ç§„ÇØ„Ç¢„Ç¶„Éà„É¢„Éº„Éâ: ${foodType === 'food' ? 'È£üÊùê(8%)' : 'È£üÊùê‰ª•Â§ñ(10%)'} = ${takeoutRate}%`);
            return takeoutRate;
          
          case 'dine-in':
            // Â∫óÂÜÖÈ£≤È£üÂèä„Å≥È£üÊùê‰ª•Â§ñ: ÂÖ®ÈÉ®10%
            console.log(`  ‚Üí Â∫óÂÜÖÈ£≤È£üÂèä„Å≥È£üÊùê‰ª•Â§ñ„É¢„Éº„Éâ: 10%`);
            return 10;
          
          default:
            // ‰∏çÊòé„Å™taxRule: ÂïÜÂìÅ„ÅÆtaxRate„ÇíÂÑ™ÂÖà„ÄÅÊú™Ë®≠ÂÆö„Å™„ÇâfoodType„Åã„ÇâÊé®Ê∏¨
            if (item.taxRate !== undefined && item.taxRate !== null) {
              console.log(`  ‚Üí ‰∏çÊòé„Å™taxRule: ${taxRule} ‚Üí ÂïÜÂìÅ„ÅÆtaxRate: ${item.taxRate}%`);
              return item.taxRate;
            }
            const defaultRate = (foodType === 'non-food') ? 10 : 8;
            console.log(`  ‚Üí ‰∏çÊòé„Å™taxRule: ${taxRule}, taxRateÊú™Ë®≠ÂÆö ‚Üí foodType(${foodType})„Åã„Çâ: ${defaultRate}%`);
            return defaultRate;
        }
      }
      
      // „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö„Åå„Å™„ÅÑ„ÄÅ„Åæ„Åü„ÅØtaxRule„Åå'none'„ÅÆÂ†¥Âêà„ÅØÂïÜÂìÅ„ÅÆ„Éá„Éï„Ç©„É´„ÉàÁ®éÁéá„Çí‰ΩøÁî®
      // ÂïÜÂìÅ„ÅÆtaxRate„ÇíÂÑ™ÂÖà‰ΩøÁî®
      if (item.taxRate !== undefined && item.taxRate !== null) {
        console.log(`[Á®éÁéáÊ±∫ÂÆö] „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö„Å™„Åó ‚Üí ÂïÜÂìÅ„ÅÆtaxRate: ${item.taxRate}%`);
        return item.taxRate;
      }
      
      // taxRate„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅfoodType„Åã„ÇâÊé®Ê∏¨ÔºàÈ£üÊùê:8%, È£üÊùê‰ª•Â§ñ:10%Ôºâ
      const inferredRate = (foodType === 'non-food') ? 10 : 8;
      console.log(`[Á®éÁéáÊ±∫ÂÆö] „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö„Å™„Åó„ÄÅtaxRateÊú™Ë®≠ÂÆö ‚Üí foodType(${foodType})„Åã„ÇâÊé®Ê∏¨: ${inferredRate}%`);
      return inferredRate;
    }
    
    /**
     * üÜï „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö„ÇíÂèñÂæó
     */
    async function getTableSettings(tableId) {
      if (!tableId || !currentStoreId) {
        return null;
      }
      
      try {
        const tableDocRef = window.doc(window.db, 'stores', currentStoreId, 'tableSettings', tableId);
        const tableDoc = await window.getDoc(tableDocRef);
        
        if (tableDoc.exists()) {
          console.log('„ÉÜ„Éº„Éñ„É´Ë®≠ÂÆöÂèñÂæó:', tableId, tableDoc.data());
          return tableDoc.data();
        }
        console.log('„ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö„Å™„Åó:', tableId);
        return null;
      } catch (e) {
        console.error('‚ùå „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆöÂèñÂæó„Ç®„É©„Éº:', e);
        return null;
      }
    }
    
    async function loadStoreList() {
      try {
        const storesQuery = window.query(
          window.collection(window.db, 'stores'),
          window.where('isActive', '==', true)
        );
        const storesSnapshot = await window.getDocs(storesQuery);
        const storeSelect = document.getElementById('storeSelect');
        
        storeSelect.innerHTML = '<option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>';
        storesData = {};
        
        storesSnapshot.forEach(doc => {
          const storeData = doc.data();
          const storeId = doc.id;
          const storeName = storeData.storeName || doc.id;
          const password = storeData.storePassword || '';
          
          storesData[storeId] = {
            storeName: storeName,
            password: String(password),
            isActive: true
          };
          
          const option = document.createElement('option');
          option.value = storeId;
          option.textContent = storeName;
          storeSelect.appendChild(option);
        });
      } catch (error) {
        console.error('‚ùå Â∫óËàó„É™„Çπ„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
        showError('Â∫óËàó„É™„Çπ„Éà„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }
    }
    
    window.handleLogin = async function() {
      playTapSound();
      const storeSelect = document.getElementById('storeSelect');
      const passwordInput = document.getElementById('passwordInput');
      const storeId = storeSelect.value;
      const inputPassword = passwordInput.value.trim();
      
      if (!storeId) {
        showError('Â∫óËàó„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }
      if (!inputPassword) {
        showError('„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
        return;
      }
      
      const storeInfo = storesData[storeId];
      if (inputPassword !== storeInfo.password) {
        showError('„Éë„Çπ„ÉØ„Éº„Éâ„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
        return;
      }
      
      currentStoreId = storeId;
      window.currentStoreId = storeId; // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å®„Åó„Å¶Ë®≠ÂÆö
      currentStoreName = storeInfo.storeName;
      sessionStorage.setItem('handyStoreId', storeId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      
      // üÜï „É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„Çí‰øùÂ≠òÔºàPOSËá™Âãï„É≠„Ç∞„Ç§„É≥Áî®Ôºâ
      window.saveLoginInfo(storeId, inputPassword);
      
      console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
      console.log('üìç HANDY Â∫óËàóIDË®≠ÂÆöÂÆå‰∫Ü');
      console.log('   currentStoreId:', currentStoreId);
      console.log('   window.currentStoreId:', window.currentStoreId);
      console.log('   currentStoreName:', currentStoreName);
      console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
      
      showTablesScreen();
    };
    
    window.handleLogout = async function() {
      playTapSound();
      const confirmed = await showCustomConfirm({
        icon: 'üö™',
        title: '„É≠„Ç∞„Ç¢„Ç¶„Éà',
        message: '„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü',
        btnClass: 'modal-btn-danger',
        btnText: '„É≠„Ç∞„Ç¢„Ç¶„Éà'
      });
      
      if (confirmed) {
        if (ordersListener) ordersListener();
        sessionStorage.removeItem('handyStoreId');
        sessionStorage.removeItem('handyStoreName');
        location.reload();
      }
    };
    
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => errorDiv.classList.add('hidden'), 3000);
    }
    
    async function showTablesScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('tablesScreen').style.display = 'block';
      document.getElementById('tablesScreen').classList.remove('hidden');
      document.getElementById('storeNameDisplay').textContent = currentStoreName;
      
      await loadTables();
      startOrdersListener();
      startTablesListener();
      
      // üÜï Âú®Â∫´„Éë„Éç„É´„ÇíÂàùÊúüÂåñ
      updateInventoryPanel();
      watchInventoryChanges();
    }
    
    function startOrdersListener() {
      if (ordersListener) ordersListener();
      const ordersRef = window.getStoreCollection('orders');
      ordersListener = window.onSnapshot(ordersRef, (snapshot) => {
        updateTableStatus(snapshot);
      });
    }

    // tables„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Çí„É™„Ç¢„É´„Çø„Ç§„É†Áõ£Ë¶ñÔºà„É°„É¢Â§âÊõ¥„ÇíÂç≥ÊôÇÂèçÊò†Ôºâ
    let tablesListener = null;
    function startTablesListener() {
      if (tablesListener) tablesListener();
      const tablesRef = window.getStoreCollection('tables');
      tablesListener = window.onSnapshot(tablesRef, (snapshot) => {
        snapshot.docChanges().forEach(change => {
          const data = change.doc.data();
          if (!data.name) return;
          // _tableMemoIds„Å®„Ç≠„É£„ÉÉ„Ç∑„É•„ÇÇÊõ¥Êñ∞
          if (!window._tableMemoIds) window._tableMemoIds = {};
          if (!window._tableMemos) window._tableMemos = {};
          window._tableMemoIds[data.name] = change.doc.id;
          window._tableMemos[data.name] = data.staffMemo || '';
          _applyMemoToCard(data.name, data.staffMemo || '');
        });
      });
    }
    
    function updateTableStatus(ordersSnapshot) {
      const unpaidTables = new Set();  // Ê≥®Êñá„ÅÇ„ÇäÔºàÊú™‰ºöË®àÔºâ
      const completedUnpaidTables = new Set();  // ÂÆå‰∫ÜÊ∏à„Åø„Å†„ÅåÊú™‰ºöË®à
      const hasIncompleteOrders = new Set();  // Êú™ÂÆå‰∫Ü„ÅÆÊ≥®Êñá„Åå„ÅÇ„Çã„ÉÜ„Éº„Éñ„É´
      
      console.log('„ÉÜ„Éº„Éñ„É´„Çπ„ÉÜ„Éº„Çø„ÇπÊõ¥Êñ∞ÈñãÂßã');
      
      ordersSnapshot.forEach(doc => {
        const order = doc.data();
        console.log('Ê≥®Êñá„ÉÅ„Çß„ÉÉ„ÇØ:', {
          id: doc.id,
          table: order.tableNumber,
          deleted: order.deleted,
          cancelled: !!order.cancelledAt,
          paid: !!order.paidAt,
          completed: !!order.completedAt
        });
        
        if (order.tableNumber && !order.deleted && !order.cancelledAt) {
          // ‰ºöË®àÊ∏à„Åø„Åß„Å™„ÅÑÊ≥®Êñá
          if (!order.paidAt) {
            unpaidTables.add(order.tableNumber);
            
            // ÂÆå‰∫ÜÊ∏à„Åø„Å†„ÅåÊú™‰ºöË®à
            if (order.completedAt) {
              completedUnpaidTables.add(order.tableNumber);
              console.log('‚ö† Êú™‰ºöË®à„ÉÜ„Éº„Éñ„É´Áô∫Ë¶ã:', order.tableNumber);
            } else {
              // Êú™ÂÆå‰∫Ü„ÅÆÊ≥®Êñá„Åå„ÅÇ„Çã
              hasIncompleteOrders.add(order.tableNumber);
              console.log('üìù Êú™ÂÆå‰∫ÜÊ≥®Êñá„ÅÇ„Çä:', order.tableNumber);
            }
          }
        }
      });
      
      console.log('üìä „Çπ„ÉÜ„Éº„Çø„ÇπÈõÜË®à:', {
        Êú™‰ºöË®à„ÉÜ„Éº„Éñ„É´: Array.from(completedUnpaidTables),
        Ê≥®Êñá„ÅÇ„Çä„ÉÜ„Éº„Éñ„É´: Array.from(unpaidTables),
        Êú™ÂÆå‰∫ÜÊ≥®Êñá„ÅÇ„Çä: Array.from(hasIncompleteOrders)
      });
      
      document.querySelectorAll('.table-card').forEach(card => {
        const tableName = card.getAttribute('data-table-name');
        
        // Êó¢Â≠ò„ÅÆ„Éê„ÉÉ„Ç∏„Çí„Åô„Åπ„Å¶ÂâäÈô§
        card.querySelectorAll('.pending-badge, .status-badge, .unpaid-badge').forEach(badge => badge.remove());
        
        if (unpaidTables.has(tableName)) {
          // Ê≥®Êñá„ÅÇ„Çä ‚Üí ËÉåÊôØ„Çí„Ç™„É¨„É≥„Ç∏„Å´
          card.classList.add('has-pending-orders');
          
          // „ÄåÊ≥®Êñá„ÅÇ„Çä„Äç„Éê„ÉÉ„Ç∏„ÇíËøΩÂä†ÔºàÊú™ÂÆå‰∫Ü„ÅÆÊ≥®Êñá„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„ÅøÔºâ
          if (hasIncompleteOrders.has(tableName)) {
            const orderBadge = document.createElement('div');
            orderBadge.className = 'pending-badge';
            orderBadge.textContent = 'Ê≥®Êñá„ÅÇ„Çä';
            orderBadge.style.cssText = 'position: absolute; top: 10px; right: 10px; background: #ff9800; color: white; font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: bold;';
            card.appendChild(orderBadge);
            console.log('‚úÖ Ê≥®Êñá„ÅÇ„Çä„Éê„ÉÉ„Ç∏ËøΩÂä†:', tableName);
          }
          
          // „ÄåÊú™‰ºöË®à„Äç„Éê„ÉÉ„Ç∏„ÇíËøΩÂä†ÔºàÂ∏∏„Å´Ë°®Á§∫Ôºâ
          const unpaidBadge = document.createElement('div');
          unpaidBadge.className = 'unpaid-badge';
          unpaidBadge.textContent = 'Êú™‰ºöË®à';
          unpaidBadge.style.cssText = 'position: absolute; top: 10px; left: 10px; background: #f57c00; color: white; font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: bold; animation: pulse 2s infinite;';
          card.appendChild(unpaidBadge);
          console.log('‚úÖ Êú™‰ºöË®à„Éê„ÉÉ„Ç∏ËøΩÂä†:', tableName);
        } else {
          // Á©∫Â∏≠ ‚Üí „Éê„ÉÉ„Ç∏„Å™„Åó
          card.classList.remove('has-pending-orders');
          console.log(' Á©∫Â∏≠:', tableName);
        }
      });
    }
    
    async function loadTables() {
      try {
        const tablesGrid = document.getElementById('tablesGrid');
        tablesGrid.innerHTML = '<div class="loading">Ë™≠„ÅøËæº„Åø‰∏≠...</div>';
        
        const tablesRef = window.getStoreCollection('tables');
        const tablesSnapshot = await window.getDocs(tablesRef);
        const tables = [];
        
        tablesSnapshot.forEach(doc => {
          tables.push({ id: doc.id, ...doc.data() });
        });
        
        // üîß „ÄåÂç≥‰ºöË®à„Äç„ÅØ„Éú„Çø„É≥„Å®„Åó„Å¶Âà•ÈÄîËøΩÂä†„Åô„Çã„ÅÆ„Åß„ÄÅ„ÉÜ„Éº„Éñ„É´‰∏ÄË¶ß„Åã„ÇâÈô§Â§ñ
        const filteredTables = tables.filter(t => t.name !== 'Âç≥‰ºöË®à');
        tables.length = 0;
        filteredTables.forEach(t => tables.push(t));
        
        tables.sort((a, b) => (a.order || 0) - (b.order || 0) || a.name.localeCompare(b.name));
        
        if (tables.length === 0) {
          tablesGrid.innerHTML = '<div style="color: white; text-align: center; padding: 40px;">„ÉÜ„Éº„Éñ„É´„ÅåÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì</div>';
          return;
        }
        
        tablesGrid.innerHTML = '';
        
        // Âç≥‰ºöË®à„Éú„Çø„É≥„ÇíÊúÄÂàù„Å´ËøΩÂä†
        const instantCheckoutCard = document.createElement('div');
        instantCheckoutCard.className = 'table-card instant-checkout-card';
        instantCheckoutCard.style.background = 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
        instantCheckoutCard.style.color = 'white';
        instantCheckoutCard.innerHTML = `
          <div class="table-name" style="color: white; font-weight: bold;">Âç≥‰ºöË®à</div>
          <div class="table-status" style="color: rgba(255,255,255,0.9);">„Çø„ÉÉ„Éó„Åó„Å¶Ê≥®Êñá</div>
        `;
        instantCheckoutCard.onclick = () => { 
          playTapSound(); 
          openInstantCheckout(); 
        };
        tablesGrid.appendChild(instantCheckoutCard);
        
        // „ÉÜ„Éº„Éñ„É´ID„Çí‰øùÂ≠òÔºà„É°„É¢‰øùÂ≠òÊôÇ„Å´‰ΩøÁî®Ôºâ
        if (!window._tableMemoIds) window._tableMemoIds = {};
        tables.forEach(t => { window._tableMemoIds[t.name] = t.id; });
        
        tables.forEach(table => {
          const tableCard = document.createElement('div');
          tableCard.className = 'table-card';
          tableCard.setAttribute('data-table-name', table.name);
          tableCard.innerHTML = `
            <div class="table-name">${table.name}</div>
            <div class="table-status">„Çø„ÉÉ„Éó„Åó„Å¶Ê≥®Êñá</div>
          `;
          
          // üÜï „ÉÜ„Éº„Éñ„É´„Ç´„Éº„ÉâËá™‰Ωì„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„Å®„Åç„Å´„É°„Éã„É•„ÉºÁîªÈù¢„Å´ÈÅ∑Áßª
          tableCard.onclick = () => { 
            playTapSound(); 
            openMenu(table.name); 
          };
          
          // üìù „É°„É¢„Éú„Çø„É≥
          const memoBtn = document.createElement('button');
          memoBtn.className = 'table-memo-btn';
          memoBtn.title = '„É°„É¢';
          memoBtn.textContent = 'üìù';
          memoBtn.onclick = (e) => { e.stopPropagation(); openTableMemoModal(table.name, e); };
          tableCard.appendChild(memoBtn);
          
          // ‰øùÂ≠òÊ∏à„Åø„É°„É¢„ÇíÂèçÊò†ÔºàËâ≤Â§âÊõ¥„ÇÇÂê´„ÇÄÔºâ
          const savedMemo = table.staffMemo || (window._tableMemos && window._tableMemos[table.name]) || '';
          if (savedMemo) {
            window._tableMemos[table.name] = savedMemo;
            tableCard.classList.add('has-memo');
            const memoEl = document.createElement('div');
            memoEl.className = 'table-memo-display';
            memoEl.textContent = savedMemo;
            tableCard.appendChild(memoEl);
          }
          
          const menuBtn = document.createElement('button');
          menuBtn.className = 'checkout-btn';
          menuBtn.textContent = '„É°„Éã„É•„Éº';
          menuBtn.style.background = '#667eea';
          menuBtn.onclick = (e) => { e.stopPropagation(); playTapSound(); openMenu(table.name); };
          tableCard.appendChild(menuBtn);
          
          const receiptPreviewBtn = document.createElement('button');
          receiptPreviewBtn.className = 'checkout-btn';
          receiptPreviewBtn.textContent = '‰ºöË®àÁ•®';
          receiptPreviewBtn.style.background = '#9C27B0';
          receiptPreviewBtn.onclick = (e) => { e.stopPropagation(); playTapSound(); showReceiptPreview(table.name); };
          tableCard.appendChild(receiptPreviewBtn);
          
          const checkoutBtn = document.createElement('button');
          checkoutBtn.className = 'checkout-btn';
          checkoutBtn.textContent = '‰ºöË®à';
          checkoutBtn.onclick = (e) => { e.stopPropagation(); playTapSound(); openCheckoutForTable(table.name); };
          tableCard.appendChild(checkoutBtn);
          
          tablesGrid.appendChild(tableCard);
        });
      } catch (error) {
        console.error('‚ùå „ÉÜ„Éº„Éñ„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      }
    }
    
    function openMenu(tableName) {
      console.log('„É°„Éã„É•„Éº„ÇíÈñã„Åè:', {
        tableName: tableName,
        currentStoreId: currentStoreId,
        currentStoreName: currentStoreName
      });
      
      // Â∫óËàóID„Çí„Çª„ÉÉ„Ç∑„Éß„É≥„Çπ„Éà„É¨„Éº„Ç∏„Å´‰øùÂ≠òÔºàmenu.html„Åß‰ΩøÁî®Ôºâ
      sessionStorage.setItem('handyStoreId', currentStoreId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      sessionStorage.setItem('handyTableName', tableName);
      
      const menuUrl = `menu.html?table=${encodeURIComponent(tableName)}&store=${currentStoreId}&mode=handy`;
      console.log(' ÈÅ∑ÁßªÂÖàURL:', menuUrl);
      window.location.href = menuUrl;
    }
    
    async function openCheckoutForTable(tableName) {
      try {
        const ordersRef = window.getStoreCollection('orders');
        const ordersQuery = window.query(ordersRef, window.where('tableNumber', '==', String(tableName)));
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        currentOrders = [];
        ordersSnapshot.forEach(doc => {
          const order = { id: doc.id, ...doc.data() };
          if (!order.deleted && !order.cancelledAt && !order.paidAt) {
            currentOrders.push(order);
          }
        });
        
        // Ê≥®ÊñáÁï™Âè∑„Åß„ÇΩ„Éº„Éà
        currentOrders.sort((a, b) => (a.orderNumber || 0) - (b.orderNumber || 0));
        
        if (currentOrders.length === 0) {
          await showCustomAlert({ icon: '', title: 'Ê≥®Êñá„Å™„Åó', message: `${tableName}\n„Åì„ÅÆ„ÉÜ„Éº„Éñ„É´„Å´„ÅØÊ≥®Êñá„Åå„ÅÇ„Çä„Åæ„Åõ„Çì`, btnClass: 'modal-btn-success' });
          return;
        }
        
        // Ë§áÊï∞Ê≥®Êñá„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÈÅ∏ÊäûÁîªÈù¢„ÇíË°®Á§∫
        if (currentOrders.length > 1) {
          showOrderSelectionModal(tableName);
        } else {
          showCheckoutMenu(tableName, [currentOrders[0]]);
        }
      } catch (error) {
        console.error('‚ùå ‰ºöË®àÁîªÈù¢Ë°®Á§∫„Ç®„É©„Éº:', error);
      }
    }
    
    // ‰ºöË®àÁ•®„Éó„É¨„Éì„É•„ÉºË°®Á§∫Ôºà‰ºöË®àÂá¶ÁêÜ„Å™„ÅóÔºâ
    async function showReceiptPreview(tableName) {
      try {
        console.log('‰ºöË®àÁ•®Ë°®Á§∫ÈñãÂßã:', tableName);
        
        const ordersRef = window.getStoreCollection('orders');
        const ordersQuery = window.query(ordersRef, window.where('tableNumber', '==', String(tableName)));
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        const orders = [];
        ordersSnapshot.forEach(doc => {
          const order = { id: doc.id, ...doc.data() };
          if (!order.deleted && !order.cancelledAt && !order.paidAt) {
            orders.push(order);
          }
        });
        
        if (orders.length === 0) {
          await showCustomAlert({ 
            icon: '', 
            title: 'Ê≥®Êñá„Å™„Åó', 
            message: `${tableName}\n„Åì„ÅÆ„ÉÜ„Éº„Éñ„É´„Å´„ÅØÊ≥®Êñá„Åå„ÅÇ„Çä„Åæ„Åõ„Çì`, 
            btnClass: 'modal-btn-success' 
          });
          return;
        }
        
        // Ê≥®ÊñáÁï™Âè∑„Åß„ÇΩ„Éº„Éà
        orders.sort((a, b) => (a.orderNumber || 0) - (b.orderNumber || 0));
        
        // Ê≥®ÊñáÁï™Âè∑„ÇíÂèñÂæóÔºàÊúÄÂàù„ÅÆÊ≥®Êñá„ÅÆÁï™Âè∑„Çí‰ΩøÁî®Ôºâ
        const orderNumber = orders[0].orderNumber || Date.now().toString().slice(-6);
        
        // Á®éÁéáÂà•ÈõÜË®à
        let tax8Total = 0;
        let tax10Total = 0;
        orders.forEach(order => {
          tax8Total += (order.tax8Total || 0);
          tax10Total += (order.tax10Total || 0);
        });
        
        // ÂêàË®àÈáëÈ°ç„ÇíË®àÁÆó
        const totalAmount = orders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
        
        // „É¨„Ç∏Ë¢ãÊÉÖÂ†±„ÇíÂèñÂæó
        let bagNeeded = false;
        let bagQuantity = 0;
        let bagPrice = 0;
        orders.forEach(order => {
          if (order.bagNeeded) {
            bagNeeded = true;
            bagQuantity += (order.bagQuantity || 0);
            bagPrice += (order.bagPrice || 0);
          }
        });
        
        // „É¨„Ç∑„Éº„Éà„Éá„Éº„Çø„Çí‰ΩúÊàê
        const receiptData = {
          orderNum: orderNumber,
          orderNumber: orderNumber,
          tableNumber: tableName,
          items: [],
          tax8Total: tax8Total,
          tax10Total: tax10Total,
          total: totalAmount,
          timestamp: Date.now(),
          bagNeeded: bagNeeded,
          bagQuantity: bagQuantity,
          bagPrice: bagPrice,
          paymentMethod: 'ÔºàÊú™‰ºöË®àÔºâ'
        };
        
        // ÂïÜÂìÅ„Éá„Éº„Çø„ÅÆÊï¥ÂΩ¢
        orders.forEach(order => {
          if (order.items && Array.isArray(order.items)) {
            order.items.forEach(item => {
              const itemData = {
                name: item.name,
                toppings: item.toppings || '„Å™„Åó',
                price: item.price,
                basePrice: item.basePrice || item.price,
                toppingPrice: item.toppingPrice || 0,
                quantity: item.quantity
              };
              
              // „Éà„ÉÉ„Éî„É≥„Ç∞Ë©≥Á¥∞„Çí‰øùÊåÅ
              if (item.toppingDetails && Array.isArray(item.toppingDetails)) {
                itemData.toppingDetails = item.toppingDetails;
              } else if (item.toppingsData && Array.isArray(item.toppingsData)) {
                itemData.toppingsData = item.toppingsData;
              } else if (item.toppingsList && Array.isArray(item.toppingsList)) {
                itemData.toppingsList = item.toppingsList;
              }
              
              receiptData.items.push(itemData);
            });
          }
        });
        
        console.log('‰ºöË®àÁ•®„Éá„Éº„Çø:', receiptData);
        
        // „É¨„Ç∑„Éº„ÉàË°®Á§∫
        showReceiptDisplay(receiptData);
        
      } catch (error) {
        console.error('‰ºöË®àÁ•®Ë°®Á§∫„Ç®„É©„Éº:', error);
        await showCustomAlert({
          icon: '‚ö†Ô∏è',
          title: '„Ç®„É©„Éº',
          message: '‰ºöË®àÁ•®„ÅÆË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message,
          btnClass: 'modal-btn-danger'
        });
      }
    }
    
    // Ê≥®ÊñáÈÅ∏Êäû„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
    function showOrderSelectionModal(tableName) {
      const modal = document.getElementById('orderSelectionModal');
      document.getElementById('orderSelectionTableName').textContent = `„ÉÜ„Éº„Éñ„É´ ${tableName}`;
      
      const ordersList = document.getElementById('ordersList');
      ordersList.innerHTML = '';
      
      // ÂÖ®Ê≥®Êñá„Åæ„Å®„ÇÅ„Å¶‰ºöË®à„Éú„Çø„É≥
      const allOrdersBtn = document.createElement('button');
      allOrdersBtn.className = 'order-selection-btn';
      allOrdersBtn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
      allOrdersBtn.style.color = 'white';
      allOrdersBtn.style.fontWeight = 'bold';
      
      // Êú™ÂÆå‰∫Ü„Å®ÂÆå‰∫ÜÊ∏à„Åø„ÅÆ‰ª∂Êï∞„ÇíË®àÁÆó
      const incompleteCount = currentOrders.filter(o => !o.completedAt).length;
      const completeCount = currentOrders.filter(o => o.completedAt).length;
      const statusText = incompleteCount > 0 && completeCount > 0 
        ? ` (Êú™ÂÆå‰∫Ü ${incompleteCount}‰ª∂ / ÂÆå‰∫ÜÊ∏à„Åø ${completeCount}‰ª∂)`
        : incompleteCount > 0 
        ? ` (Êú™ÂÆå‰∫Ü ${incompleteCount}‰ª∂)`
        : completeCount > 0 
        ? ` (ÂÆå‰∫ÜÊ∏à„Åø ${completeCount}‰ª∂)`
        : '';
      
      allOrdersBtn.innerHTML = `
        <div style="font-size: 20px; margin-bottom: 8px;">ÂÖ®Ê≥®Êñá„Åæ„Å®„ÇÅ„Å¶‰ºöË®à</div>
        <div style="font-size: 16px;">ÂêàË®à ${currentOrders.length} ‰ª∂${statusText} - ¬•${currentOrders.reduce((sum, o) => sum + (o.totalAmount || 0), 0).toLocaleString()}</div>
      `;
      allOrdersBtn.onclick = () => {
        modal.classList.add('hidden');
        showCheckoutMenu(tableName, currentOrders);
      };
      ordersList.appendChild(allOrdersBtn);
      
      // ÂÄãÂà•Ê≥®Êñá„Éú„Çø„É≥
      currentOrders.forEach((order, index) => {
        const orderBtn = document.createElement('button');
        orderBtn.className = 'order-selection-btn';
        orderBtn.style.position = 'relative';  // „Éê„ÉÉ„Ç∏„ÅÆÈÖçÁΩÆ„ÅÆ„Åü„ÇÅ
        
        const itemsText = order.items && Array.isArray(order.items)
          ? order.items.map(item => `${item.name} x${item.quantity || 1}`).join(', ')
          : 'Ê≥®ÊñáÂÜÖÂÆπ„Å™„Åó';
        
        // Êú™ÂÆå‰∫Ü„Åã„Å©„ÅÜ„Åã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
        const isIncomplete = !order.completedAt;
        const statusBadge = isIncomplete 
          ? '<span style="position: absolute; top: 10px; right: 10px; background: #ff9800; color: white; font-size: 11px; padding: 4px 10px; border-radius: 12px; font-weight: bold;">Êú™ÂÆå‰∫Ü</span>'
          : '<span style="position: absolute; top: 10px; right: 10px; background: #4CAF50; color: white; font-size: 11px; padding: 4px 10px; border-radius: 12px; font-weight: bold;">ÂÆå‰∫ÜÊ∏à„Åø</span>';
        
        orderBtn.innerHTML = `
          ${statusBadge}
          <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">Ê≥®Êñá #${order.orderNumber || (index + 1)}</div>
          <div style="font-size: 14px; color: #666; margin-bottom: 8px;">${itemsText}</div>
          <div style="font-size: 16px; color: #4CAF50; font-weight: bold;">¬•${(order.totalAmount || 0).toLocaleString()}</div>
        `;
        orderBtn.onclick = () => {
          modal.classList.add('hidden');
          showCheckoutMenu(tableName, [order]);
        };
        ordersList.appendChild(orderBtn);
      });
      
      modal.classList.remove('hidden');
    }
    
    window.closeOrderSelectionModal = function() {
      document.getElementById('orderSelectionModal').classList.add('hidden');
    };
    
    async function showCheckoutMenu(tableName, selectedOrders = null) {
      // selectedOrders„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Çå„Å∞„Åù„Çå„Çí‰ΩøÁî®„ÄÅ„Å™„Åë„Çå„Å∞currentOrdersÂÖ®„Å¶
      const ordersToCheckout = selectedOrders || currentOrders;
      
      totalAmountToPay = ordersToCheckout.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      const paymentModal = document.getElementById('paymentModal');
      paymentModal.classList.remove('hidden');
      
      // Ê≥®ÊñáÁï™Âè∑„ÇíË°®Á§∫
      let orderNumbersText = '';
      if (ordersToCheckout.length === 1) {
        orderNumbersText = ` - Ê≥®Êñá #${ordersToCheckout[0].orderNumber || '1'}`;
      } else if (ordersToCheckout.length > 1) {
        const orderNums = ordersToCheckout.map(o => `#${o.orderNumber || '?'}`).join(', ');
        orderNumbersText = ` - ${orderNums}`;
      }
      
      document.getElementById('selectedTableLabel2').textContent = `„ÉÜ„Éº„Éñ„É´ ${tableName}${orderNumbersText}`;
      
      // ÈÅ∏Êäû„Åï„Çå„ÅüÊ≥®Êñá„Çí„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å´‰øùÂ≠òÔºà‰ºöË®àÂá¶ÁêÜ„Åß‰ΩøÁî®Ôºâ
      window.ordersToCheckout = ordersToCheckout;
      
      // üÜï „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö„ÇíÂèñÂæó
      currentTableSettings = await getTableSettings(tableName);
      console.log('„ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö:', tableName, currentTableSettings);
      
      generateTaxRateItems(ordersToCheckout, tableName);
      document.getElementById('discountAmount').value = 0;
      updatePaymentTotal();
      
      selectedPaymentMethod = null;
      document.querySelectorAll('.payment-method-btn').forEach(btn => btn.classList.remove('selected'));
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('paymentBtn').disabled = true;
    }
    
    window.closePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
    };
    
    function generateTaxRateItems(ordersToProcess = null, tableName = '') {
      const container = document.getElementById('taxRateItemsList');
      container.innerHTML = '';
      let itemIndex = 0;
      
      const orders = ordersToProcess || currentOrders;
      
      orders.forEach(order => {
        if (!order.items || order.items.length === 0) {
          // Ê≥®ÊñáÂÖ®‰Ωì„Å®„Åó„Å¶Êâ±„ÅÜÂ†¥ÂêàÔºàÂè§„ÅÑÂΩ¢ÂºèÔºâ
          // „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö„Å´Âü∫„Å•„ÅÑ„Å¶„Éá„Éï„Ç©„É´„ÉàÁ®éÁéá„ÇíÊ±∫ÂÆö„Åô„Çã„Åå„ÄÅÂïÜÂìÅ„Åå„Å™„ÅÑ„ÅÆ„Åß10%„Å®„Åô„Çã
          const defaultTaxRate = 10;
          addTaxRateItem(container, `Ê≥®Êñá #${order.orderNumber}`, 1, order.totalAmount || 0, itemIndex, defaultTaxRate, 'inclusive');
          itemIndex++;
        } else {
          order.items.forEach(item => {
            const toppingStr = item.toppings || item.toppingDetails || '„Å™„Åó';
            // üÜï Â§ñÁ®é„ÅÆÂ†¥Âêà„ÅØÊú¨‰Ωì‰æ°Ê†º„ÄÅÂÜÖÁ®é„ÅÆÂ†¥Âêà„ÅØÁ®éËæº‰æ°Ê†º
            const itemBasePrice = item.price + (item.toppingPrice || 0);
            const itemTotal = itemBasePrice * item.quantity;
            
            // üÜï „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö„Å®foodType„Å´Âü∫„Å•„ÅÑ„Å¶Á®éÁéá„ÇíÊ±∫ÂÆö
            const itemTaxRate = getApplicableTaxRate(item, currentTableSettings);
            console.log(`‚úÖ ÈÅ©Áî®Á®éÁéá: ${itemTaxRate}% (ÂïÜÂìÅ: ${item.name}, foodType: ${item.foodType || 'food'}, taxRule: ${currentTableSettings?.taxRule || 'none'})`);
            
            // üÜï taxType„ÇíÊ∏°„ÅôÔºà„Éá„Éï„Ç©„É´„Éà„ÅØÂÜÖÁ®éÔºâ
            addTaxRateItem(container, `${item.name} (${toppingStr})`, item.quantity, itemTotal, itemIndex, itemTaxRate, item.taxType || 'inclusive');
            itemIndex++;
          });
          
          // üõç „É¨„Ç∏Ë¢ãÊÉÖÂ†±„ÅÆË©≥Á¥∞„Éá„Éê„ÉÉ„Ç∞
          console.log('üõçüõçüõç „É¨„Ç∏Ë¢ã„ÉÅ„Çß„ÉÉ„ÇØÈñãÂßã üõçüõçüõç');
          console.log('  order:', order);
          console.log('  order.bagNeeded:', order.bagNeeded, '(Âûã:', typeof order.bagNeeded, ')');
          console.log('  order.bagQuantity:', order.bagQuantity, '(Âûã:', typeof order.bagQuantity, ')');
          console.log('  order.bagPrice:', order.bagPrice, '(Âûã:', typeof order.bagPrice, ')');
          console.log('  Êù°‰ª∂1 (bagNeeded):', order.bagNeeded);
          console.log('  Êù°‰ª∂2 (bagQuantity > 0):', order.bagQuantity > 0);
          console.log('  ‰∏°ÊñπÊ∫Ä„Åü„Åô:', order.bagNeeded && order.bagQuantity > 0);
          
          if (order.bagNeeded && order.bagQuantity > 0) {
            console.log('‚úÖ‚úÖ‚úÖ „É¨„Ç∏Ë¢ã„ÇíËøΩÂä†„Åó„Åæ„ÅôÔºÅ');
            console.log('  Êï∞Èáè:', order.bagQuantity);
            console.log('  ‰æ°Ê†º:', order.bagPrice || (order.bagQuantity * 3));
            addTaxRateItem(container, 'üõç „É¨„Ç∏Ë¢ã', order.bagQuantity, order.bagPrice || (order.bagQuantity * 3), itemIndex, 10, 'inclusive');
            itemIndex++;
          } else {
            console.log('‚ùå‚ùå‚ùå „É¨„Ç∏Ë¢ã„ÅØËøΩÂä†„Åï„Çå„Åæ„Åõ„Çì');
            console.log('  ÁêÜÁî±: bagNeeded=' + order.bagNeeded + ', bagQuantity=' + order.bagQuantity);
          }
        }
      });
      calculateTaxSummary();
    }
    
    function addTaxRateItem(container, itemName, quantity, itemTotal, index, defaultTaxRate, taxType = 'inclusive') {
      // üÜï Â§ñÁ®é„ÅÆÂ†¥Âêà„ÅØÁ®éËæº‰æ°Ê†º„ÇíË®àÁÆóÔºàitemTotal„ÅØÊú¨‰Ωì‰æ°Ê†ºÔºâ
      let displayTotal = itemTotal;
      if (taxType === 'exclusive') {
        // Â§ñÁ®é„ÅÆÂ†¥Âêà„ÄÅitemTotal„ÅØÊú¨‰Ωì‰æ°Ê†º„Å™„ÅÆ„ÅßÁ®é„ÇíÂä†ÁÆó
        displayTotal = itemTotal + Math.floor(itemTotal * (defaultTaxRate / 100));
        console.log(`üÜï Â§ñÁ®éË®àÁÆó: Êú¨‰Ωì${itemTotal}ÂÜÜ + Á®é${Math.floor(itemTotal * (defaultTaxRate / 100))}ÂÜÜ ‚Üí ${displayTotal}ÂÜÜÔºàÁ®éÁéá${defaultTaxRate}%Ôºâ`);
      }
      
      const itemDiv = document.createElement('div');
      itemDiv.style.cssText = 'padding: 10px; margin-bottom: 8px; background: white; border-radius: 6px; border: 1px solid #ddd;';
      
      const headerDiv = document.createElement('div');
      headerDiv.style.cssText = 'display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; font-size: 14px; cursor: pointer;';
      headerDiv.innerHTML = `<span>${itemName} √ó${quantity}</span><span style="color: #667eea;" id="itemPrice${index}">¬•${displayTotal.toLocaleString()}</span>`;
      
      headerDiv.onclick = function() {
        document.getElementById('priceChangeTitle').textContent = itemName;
        document.getElementById('priceChangeCurrentPrice').textContent = `¬•${displayTotal.toLocaleString()}`;
        document.getElementById('priceChangeInput').value = displayTotal;
        document.getElementById('priceChangeItemId').value = index;
        document.getElementById('priceChangeModal').classList.remove('hidden');
      };
      
      const radioDiv = document.createElement('div');
      radioDiv.style.cssText = 'display: flex; gap: 10px; justify-content: center;';
      
      const radio8 = createRadio(index, 8, displayTotal, defaultTaxRate === 8, itemTotal, taxType);
      const radio10 = createRadio(index, 10, displayTotal, defaultTaxRate === 10, itemTotal, taxType);
      
      radioDiv.appendChild(createRadioLabel(radio8, '8%ÊåÅ„Å°Â∏∞„Çä', '#fff3e0', '#FF9800'));
      radioDiv.appendChild(createRadioLabel(radio10, '10%Â∫óÂÜÖ', '#e3f2fd', '#2196F3'));
      
      itemDiv.appendChild(headerDiv);
      itemDiv.appendChild(radioDiv);
      container.appendChild(itemDiv);
    }
    
    function createRadio(index, rate, amount, checked, baseAmount = null, taxType = 'inclusive') {
      const radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = `taxRate${index}`;
      radio.value = rate;
      radio.checked = checked;
      radio.dataset.amount = amount;
      radio.dataset.taxType = taxType;  // üÜï taxType„Çí‰øùÂ≠ò
      radio.dataset.baseAmount = baseAmount || amount;  // üÜï Êú¨‰Ωì‰æ°Ê†º„Çí‰øùÂ≠ò
      radio.style.marginRight = '5px';
      
      // üÜï Â§ñÁ®é„ÅÆÂ†¥Âêà„ÅØÁ®éÁéáÂ§âÊõ¥ÊôÇ„Å´ÈáëÈ°ç„ÇíÂÜçË®àÁÆó
      radio.onchange = function() {
        if (taxType === 'exclusive') {
          const newAmount = parseInt(radio.dataset.baseAmount) + Math.floor(parseInt(radio.dataset.baseAmount) * (rate / 100));
          // Âêå„Åò„Ç∞„É´„Éº„Éó„ÅÆÂÖ®„É©„Ç∏„Ç™„Éú„Çø„É≥„ÅÆamount„ÇíÊõ¥Êñ∞
          document.querySelectorAll(`input[name="taxRate${index}"]`).forEach(r => {
            r.dataset.amount = newAmount;
          });
          document.getElementById('itemPrice' + index).textContent = '¬•' + newAmount.toLocaleString();
          console.log(`Â§ñÁ®é${rate}%„Å´Â§âÊõ¥: ${radio.dataset.baseAmount}ÂÜÜ ‚Üí ${newAmount}ÂÜÜ`);
        }
        calculateTaxSummary();
      };
      
      return radio;
    }
    
    function createRadioLabel(radio, text, bg, border) {
      const label = document.createElement('label');
      label.style.cssText = `flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 6px 10px; border-radius: 4px; background: ${bg}; border: 2px solid ${border}; font-size: 13px;`;
      label.appendChild(radio);
      label.appendChild(document.createTextNode(text));
      return label;
    }
    
    function calculateTaxSummary() {
      let tax8 = 0, tax10 = 0;
      document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked').forEach(r => {
        if (r.value === '8') tax8 += parseFloat(r.dataset.amount);
        else tax10 += parseFloat(r.dataset.amount);
      });
      document.getElementById('tax8Summary').textContent = '¬•' + tax8.toLocaleString();
      document.getElementById('tax10Summary').textContent = '¬•' + tax10.toLocaleString();
      updatePaymentTotal();
    }
    
    window.updatePaymentTotal = function() {
      let total = 0;
      document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked').forEach(r => total += parseFloat(r.dataset.amount));
      const final = Math.max(0, total - (parseInt(document.getElementById('discountAmount').value) || 0));
      totalAmountToPay = final;
      document.getElementById('finalPaymentAmount').textContent = '¬•' + final.toLocaleString();
      if (selectedPaymentMethod === 'cash') calculateChange();
    };
    

    window.selectPaymentMethod = function(method) {
      playTapSound();
      selectedPaymentMethod = method;
      document.querySelectorAll('.payment-method-btn').forEach(btn => btn.classList.toggle('selected', btn.innerText.includes(method === 'cash' ? 'ÁèæÈáë' : method === 'emoney' ? 'ÈõªÂ≠ê' : '„ÇØ„É¨„Ç∏„ÉÉ„Éà')));
      document.getElementById('cashInputSection').classList.toggle('hidden', method !== 'cash');
      document.getElementById('paymentBtn').disabled = method === 'cash';
    };
    
    window.calculateChange = function() {
      cashReceived = parseInt(document.getElementById('cashReceived').value) || 0;
      changeAmount = cashReceived - totalAmountToPay;
      document.getElementById('changeAmount').textContent = `¬•${changeAmount.toLocaleString()}`;
      document.getElementById('paymentBtn').disabled = cashReceived < totalAmountToPay;
    };
    
    window.confirmPriceChange = function() {
      const itemId = document.getElementById('priceChangeItemId').value;
      const newPrice = parseFloat(document.getElementById('priceChangeInput').value) || 0;
      document.querySelectorAll(`input[name="taxRate${itemId}"]`).forEach(r => r.dataset.amount = newPrice);
      document.getElementById(`itemPrice${itemId}`).textContent = '¬•' + newPrice.toLocaleString();
      calculateTaxSummary();
      document.getElementById('priceChangeModal').classList.add('hidden');
    };
    
    window.closePriceChangeModal = function() {
      document.getElementById('priceChangeModal').classList.add('hidden');
    };

    // „Ç´„Çπ„Çø„É†„Ç¢„É©„Éº„ÉàÔºàOK „Éú„Çø„É≥„ÅÆ„ÅøÔºâ
    function showCustomAlert(options) {
      return new Promise((resolve) => {
        const modal = document.getElementById('customConfirmModal');
        const icon = document.getElementById('modalIcon');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const buttonsContainer = document.querySelector('.modal-buttons');
        
        icon.textContent = options.icon || '';
        title.textContent = options.title || '„ÅäÁü•„Çâ„Åõ';
        message.textContent = options.message || '';
        
        buttonsContainer.innerHTML = `
          <button class="modal-btn ${options.btnClass || 'modal-btn-primary'}" onclick="playTapSound(); closeCustomAlert()">${options.btnText || 'OK'}</button>
        `;
        
        window.closeCustomAlert = function() {
          modal.style.display = 'none';
          resolve(true);
        };
        
        modal.style.display = 'flex';
      });
    }

    // ‰ºöË®àÂá¶ÁêÜÔºàÂ£≤‰∏ä„ÉªÂÆ¢Êï∞„ÇíPOS„Å´ÂèçÊò†Ôºâ- „ÉØ„É≥„Çø„ÉÉ„Éó„ÅßÂÆåÁµê
    window.processPayment = async function() {
      playTapSound();
      
      if (!selectedPaymentMethod) {
        await showCustomAlert({ icon: '‚ö†', title: '„Ç®„É©„Éº', message: 'ÊîØÊâï„ÅÑÊñπÊ≥ï„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', btnClass: 'modal-btn-danger' });
        return;
      }
      
      if (selectedPaymentMethod === 'cash' && cashReceived < totalAmountToPay) {
        await showCustomAlert({ icon: '‚ö†', title: '„Ç®„É©„Éº', message: '„ÅäÈ†ê„Åã„ÇäÈáëÈ°ç„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô', btnClass: 'modal-btn-danger' });
        return;
      }
      
      try {
        const now = window.Timestamp.now();
        
        // window.ordersToCheckout„Åã„Çâ‰ºöË®àÂØæË±°„ÅÆÊ≥®Êñá„ÇíÂèñÂæó
        const ordersToProcess = window.ordersToCheckout || currentOrders;
        
        // ÂÄ§Âºï„ÅçÈáëÈ°ç„ÇíÂèñÂæó
        const discountAmount = parseInt(document.getElementById('discountAmount').value) || 0;
        
        // Á®éÁéáÂà•ÈõÜË®à
        let tax8Total = 0;
        let tax10Total = 0;
        const radios = document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked');
        radios.forEach(radio => {
          const amount = parseFloat(radio.dataset.amount) || 0;
          const taxRate = radio.value;
          if (taxRate === '8') {
            tax8Total += amount;
          } else if (taxRate === '10') {
            tax10Total += amount;
          }
        });
        
        // ÂÄ§Âºï„ÅçÂæå„ÅÆÈáëÈ°çÔºàtotalAmountToPay„ÅØÊó¢„Å´ÂÄ§Âºï„ÅçÂæåÔºâ
        const totalBeforeDiscount = tax8Total + tax10Total;
        
        // ÂïÜÂìÅÁÇπÊï∞„ÇíË®àÁÆó
        let itemCount = 0;
        ordersToProcess.forEach(order => {
          if (order.items && Array.isArray(order.items)) {
            order.items.forEach(item => {
              itemCount += item.quantity || 0;
            });
          } else {
            itemCount += 1;
          }
        });
        
        console.log(' ‰ºöË®àÂá¶ÁêÜÈñãÂßã:', {
          totalAmount: totalAmountToPay,
          ÂÄ§Âºï„ÅçÂâçÈáëÈ°ç: totalBeforeDiscount,
          ÂÄ§Âºï„ÅçÈáëÈ°ç: discountAmount,
          ÂÄ§Âºï„ÅçÂæåÈáëÈ°ç: totalAmountToPay,
          paymentMethod: selectedPaymentMethod,
          itemCount: itemCount,
          tax8Total: tax8Total,
          tax10Total: tax10Total,
          customerCount: 1,
          ordersCount: ordersToProcess.length,
          storeId: currentStoreId
        });
        
        // ÊîØÊâï„ÅÑÊñπÊ≥ï„ÇíÊó•Êú¨Ë™û„Å´Â§âÊèõ
        let paymentMethodJP = 'ÁèæÈáë';
        if (selectedPaymentMethod === 'emoney') paymentMethodJP = 'ÈõªÂ≠ê„Éû„Éç„Éº';
        else if (selectedPaymentMethod === 'credit') paymentMethodJP = '„ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„Éâ';
        
        // Firestore„ÅÆÊ≥®Êñá„Å´paidAt„ÄÅcompletedAt„ÄÅdeleted„Éï„É©„Ç∞„ÇíË®≠ÂÆöÔºà‰ºöË®àÂÆå‰∫Ü„ÅßÂâäÈô§Ôºâ
        for (const order of ordersToProcess) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          await window.updateDoc(orderRef, {
            paidAt: now,
            completedAt: now,
            deleted: true,  // ‰ºöË®àÂÆå‰∫Ü„ÅßÂâäÈô§
            deletedAt: now,
            paymentMethod: paymentMethodJP,
            discountAmount: discountAmount,  // ÂÄ§Âºï„ÅçÈáëÈ°ç„Çí‰øùÂ≠ò
            totalAmount: totalAmountToPay,  // ÂÄ§Âºï„ÅçÂæå„ÅÆÈáëÈ°ç„ÅßtotalAmount„ÇíÊõ¥Êñ∞
            originalAmount: totalBeforeDiscount,  // ÂÖÉ„ÅÆÈáëÈ°ç„Çí‰øùÂ≠ò
            notifiedPaid: true,
            tax8Total: tax8Total,
            tax10Total: tax10Total
          });
          console.log('‚úÖ Ê≥®Êñá„Çí‰ºöË®àÊ∏à„ÅøÔºÜÂâäÈô§:', order.id, 'ÈáëÈ°ç:', totalAmountToPay);
        }
        
        // Â£≤‰∏ä„ÇíPOS„Å´ÂèçÊò†
        const dateStr = getBusinessDateStr();
        console.log('üìÖ Âñ∂Ê•≠Êó•:', dateStr);
        
        const dailySalesRef = window.doc(window.db, 'stores', currentStoreId, 'dailySales', dateStr);
        const dailySalesDoc = await window.getDoc(dailySalesRef);
        
        const currentData = dailySalesDoc.exists() ? dailySalesDoc.data() : {
          totalSales: 0,
          customerCount: 0,
          totalItems: 0,
          cashSales: 0,
          emoneSales: 0,
          creditSales: 0,
          tax8Total: 0,
          tax10Total: 0,
          totalDiscount: 0  // ÂÄ§Âºï„ÅçÂêàË®à
        };
        
        console.log('üìä ÁèæÂú®„ÅÆdailySales:', currentData);
        
        const updateData = {
          totalSales: (currentData.totalSales || 0) + totalAmountToPay,
          customerCount: (currentData.customerCount || 0) + 1,
          totalItems: (currentData.totalItems || 0) + itemCount,
          cashSales: (currentData.cashSales || 0) + (selectedPaymentMethod === 'cash' ? totalAmountToPay : 0),
          emoneSales: (currentData.emoneSales || 0) + (selectedPaymentMethod === 'emoney' ? totalAmountToPay : 0),
          creditSales: (currentData.creditSales || 0) + (selectedPaymentMethod === 'credit' ? totalAmountToPay : 0),
          tax8Total: (currentData.tax8Total || 0) + tax8Total,
          tax10Total: (currentData.tax10Total || 0) + tax10Total,
          totalDiscount: (currentData.totalDiscount || 0) + discountAmount,  // ÂÄ§Âºï„ÅçÂêàË®à„Å´Âä†ÁÆó
          updatedAt: now
        };
        
        console.log('üìä Êõ¥Êñ∞„Åô„ÇãdailySales:', updateData);
        
        await window.setDoc(dailySalesRef, updateData, { merge: true });
        
        console.log('‚úÖ Â£≤‰∏ä„ÇíPOS„Å´ÂèçÊò†„Åó„Åæ„Åó„ÅüÔºàÂÄ§Âºï„Åç: ¬•' + discountAmount.toLocaleString() + 'Ôºâ');
        
        // ÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
        let message = `‰ºöË®à„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü„ÄÇ\n\nÂ£≤‰∏ä: ¬•${totalAmountToPay.toLocaleString()}`;
        if (discountAmount > 0) {
          message += `\nÂÄ§Âºï„Åç: ¬•${discountAmount.toLocaleString()}`;
        }
        message += `\nÂÆ¢Êï∞: +1\n\nÊ≥®Êñá„ÅØËá™ÂãïÁöÑ„Å´ÂâäÈô§„Åï„Çå„Åæ„Åó„Åü„ÄÇ`;
        
        // üÜï ‰ºöË®àÂÆå‰∫ÜÊôÇ„Å´„É¨„Ç∑„Éº„Éà„ÉªÈ†òÂèéÊõ∏Ë°®Á§∫„ÅÆÈÅ∏ÊäûËÇ¢„ÇíË°®Á§∫
        const checkoutData = {
          totalAmount: totalAmountToPay,
          discountAmount: discountAmount,
          originalAmount: totalBeforeDiscount,
          paymentMethod: paymentMethodJP,
          tax8Total: tax8Total,
          tax10Total: tax10Total,
          orders: ordersToProcess,
          timestamp: now
        };
        
        await showCheckoutCompleteOptions(checkoutData);
        
        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        closePaymentModal();
        
        // „ÉÜ„Éº„Éñ„É´‰∏ÄË¶ß„ÇíÊõ¥Êñ∞
        await loadTables();
      } catch (error) {
        console.error('‚ùå ‰ºöË®àÂá¶ÁêÜ„Ç®„É©„Éº:', error);
        await showCustomAlert({ 
          icon: '‚ùå', 
          title: '„Ç®„É©„Éº', 
          message: '‰ºöË®àÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    // üÜï ‰ºöË®àÂÆå‰∫ÜÂæå„Å´„É¨„Ç∑„Éº„Éà„ÉªÈ†òÂèéÊõ∏Ë°®Á§∫„ÅÆÈÅ∏ÊäûËÇ¢„ÇíË°®Á§∫
    async function showCheckoutCompleteOptions(checkoutData) {
      return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.6);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 100000;
        `;
        
        const content = document.createElement('div');
        content.style.cssText = `
          background: white;
          border-radius: 20px;
          padding: 30px;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        `;
        
        let message = `‰ºöË®à„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü\n\nÂ£≤‰∏ä: ¬•${checkoutData.totalAmount.toLocaleString()}`;
        if (checkoutData.discountAmount > 0) {
          message += `\nÂÄ§Âºï„Åç: ¬•${checkoutData.discountAmount.toLocaleString()}`;
        }
        message += `\nÂÆ¢Êï∞: +1`;
        
        content.innerHTML = `
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 50px; margin-bottom: 10px;">‚úÖ</div>
            <div style="font-size: 20px; font-weight: bold; margin-bottom: 10px;">‰ºöË®àÂÆå‰∫Ü</div>
            <div style="white-space: pre-line; color: #666; line-height: 1.6;">${message}</div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <button id="printReceiptBtn" style="
              padding: 15px;
              background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
              color: white;
              border: none;
              border-radius: 10px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            ">„É¨„Ç∑„Éº„ÉàË°®Á§∫</button>
            <button id="printInvoiceBtn" style="
              padding: 15px;
              background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
              color: white;
              border: none;
              border-radius: 10px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
            ">È†òÂèéÊõ∏Ë°®Á§∫</button>
            <button id="closeCheckoutBtn" style="
              padding: 15px;
              background: linear-gradient(135deg, #9E9E9E 0%, #757575 100%);
              color: white;
              border: none;
              border-radius: 10px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(158, 158, 158, 0.3);
            ">Èñâ„Åò„Çã</button>
          </div>
        `;
        
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        // „É¨„Ç∑„Éº„ÉàË°®Á§∫„Éú„Çø„É≥
        document.getElementById('printReceiptBtn').onclick = async () => {
          playTapSound();
          await printCheckoutReceipt(checkoutData);
        };
        
        // È†òÂèéÊõ∏Ë°®Á§∫„Éú„Çø„É≥
        document.getElementById('printInvoiceBtn').onclick = async () => {
          playTapSound();
          await printCheckoutInvoice(checkoutData);
        };
        
        // Èñâ„Åò„Çã„Éú„Çø„É≥
        document.getElementById('closeCheckoutBtn').onclick = () => {
          playTapSound();
          document.body.removeChild(modal);
          resolve();
        };
      });
    }
    
    // üÜï ‰ºöË®àÂæå„ÅÆ„É¨„Ç∑„Éº„ÉàÂç∞Âà∑
    async function printCheckoutReceipt(checkoutData) {
      try {
        console.log('„É¨„Ç∑„Éº„ÉàË°®Á§∫ÈñãÂßã', checkoutData);
        
        //  ‰øÆÊ≠£: orders„Åã„ÇâÊ≥®ÊñáÁï™Âè∑„ÇíÂèñÂæó
        let orderNumber = null;
        
        if (checkoutData.orders && Array.isArray(checkoutData.orders) && checkoutData.orders.length > 0) {
          // ÊúÄÂàù„ÅÆÊ≥®Êñá„ÅÆÊ≥®ÊñáÁï™Âè∑„Çí‰ΩøÁî®
          orderNumber = checkoutData.orders[0].orderNumber;
          console.log('‚úÖ orders[0].orderNumber„Åã„ÇâÂèñÂæó:', orderNumber);
        }
        
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        if (!orderNumber) {
          orderNumber = checkoutData.orderNum || 
                       checkoutData.orderNumber || 
                       checkoutData.orderNo ||
                       (window.currentOrderNumber ? window.currentOrderNumber : null);
        }
        
        // „Åù„Çå„Åß„ÇÇ„Å™„ÅÑÂ†¥Âêà„ÅØ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Éô„Éº„Çπ„ÅÆÁï™Âè∑„ÇíÁîüÊàê
        if (!orderNumber) {
          orderNumber = Date.now().toString().slice(-6);
          console.warn('‚ö†Ô∏è Ê≥®ÊñáÁï™Âè∑„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ„Åü„ÇÅ„ÄÅ‰ªÆÁï™Âè∑„ÇíÁîüÊàê:', orderNumber);
        }
        
        // „ÉÜ„Éº„Éñ„É´Áï™Âè∑„ÇíÂèñÂæó
        let tableNumber = null;
        if (checkoutData.orders && Array.isArray(checkoutData.orders) && checkoutData.orders.length > 0) {
          tableNumber = checkoutData.orders[0].tableNumber;
        }
        
        // üõçÔ∏è „É¨„Ç∏Ë¢ãÊÉÖÂ†±„ÇíÂèñÂæóÔºàorders„Åã„ÇâÔºâ
        let bagNeeded = false;
        let bagQuantity = 0;
        let bagPrice = 0;
        
        if (checkoutData.orders && Array.isArray(checkoutData.orders)) {
          checkoutData.orders.forEach(order => {
            if (order.bagNeeded && order.bagQuantity > 0) {
              bagNeeded = true;
              bagQuantity += order.bagQuantity;
              bagPrice += (order.bagPrice || 0);
            }
          });
        }
        
        console.log('üõçÔ∏è „É¨„Ç∑„Éº„ÉàÁî®„É¨„Ç∏Ë¢ãÊÉÖÂ†±:', { bagNeeded, bagQuantity, bagPrice });
        
        const receiptData = {
          orderNum: orderNumber,
          orderNumber: orderNumber,
          tableNumber: tableNumber || '',
          items: [],
          tax8Total: checkoutData.tax8Total || 0,
          tax10Total: checkoutData.tax10Total || 0,
          total: checkoutData.totalAmount,
          timestamp: checkoutData.timestamp ? (checkoutData.timestamp.toDate ? checkoutData.timestamp.toDate().getTime() : checkoutData.timestamp) : Date.now(),
          bagNeeded: bagNeeded,
          bagQuantity: bagQuantity,
          bagPrice: bagPrice,
          paymentMethod: checkoutData.paymentMethod || ''
        };
        
        // ÂïÜÂìÅ„Éá„Éº„Çø„ÅÆÊï¥ÂΩ¢
        if (checkoutData.orders && Array.isArray(checkoutData.orders)) {
          checkoutData.orders.forEach(order => {
            if (order.items && Array.isArray(order.items)) {
              order.items.forEach(item => {
                const itemData = {
                  name: item.name,
                  toppings: item.toppings || '„Å™„Åó',
                  price: item.price,
                  basePrice: item.basePrice || item.price,
                  toppingPrice: item.toppingPrice || 0,
                  quantity: item.quantity
                };
                
                // „Éà„ÉÉ„Éî„É≥„Ç∞Ë©≥Á¥∞„Çí‰øùÊåÅ
                if (item.toppingDetails && Array.isArray(item.toppingDetails)) {
                  itemData.toppingDetails = item.toppingDetails;
                } else if (item.toppingsData && Array.isArray(item.toppingsData)) {
                  itemData.toppingsData = item.toppingsData;
                } else if (item.toppingsList && Array.isArray(item.toppingsList)) {
                  itemData.toppingsList = item.toppingsList;
                }
                
                receiptData.items.push(itemData);
              });
            }
          });
        }
        
        showReceiptDisplay(receiptData);
        await openCashDrawer();
        
      } catch (e) {
        console.error('„É¨„Ç∑„Éº„ÉàË°®Á§∫„Ç®„É©„Éº:', e);
        await showCustomAlert({
          icon: '',
          title: '„Ç®„É©„Éº',
          message: '„É¨„Ç∑„Éº„ÉàË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message,
          btnClass: 'modal-btn-danger'
        });
      }
    }
    
    // üÜï ‰ºöË®àÂæå„ÅÆÈ†òÂèéÊõ∏Âç∞Âà∑
    async function printCheckoutInvoice(checkoutData) {
      try {
        console.log('È†òÂèéÊõ∏Ë°®Á§∫ÈñãÂßã', checkoutData);
        
        //  ‰øÆÊ≠£: orders„Åã„ÇâÊ≥®ÊñáÁï™Âè∑„ÇíÂèñÂæó
        let orderNumber = null;
        
        if (checkoutData.orders && Array.isArray(checkoutData.orders) && checkoutData.orders.length > 0) {
          // ÊúÄÂàù„ÅÆÊ≥®Êñá„ÅÆÊ≥®ÊñáÁï™Âè∑„Çí‰ΩøÁî®
          orderNumber = checkoutData.orders[0].orderNumber;
          console.log('‚úÖ orders[0].orderNumber„Åã„ÇâÂèñÂæó:', orderNumber);
        }
        
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        if (!orderNumber) {
          orderNumber = checkoutData.orderNum || 
                       checkoutData.orderNumber || 
                       checkoutData.orderNo ||
                       (window.currentOrderNumber ? window.currentOrderNumber : null);
        }
        
        // „Åù„Çå„Åß„ÇÇ„Å™„ÅÑÂ†¥Âêà„ÅØ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Éô„Éº„Çπ„ÅÆÁï™Âè∑„ÇíÁîüÊàê
        if (!orderNumber) {
          orderNumber = Date.now().toString().slice(-6);
          console.warn('‚ö†Ô∏è Ê≥®ÊñáÁï™Âè∑„ÅåË¶ã„Å§„Åã„Çâ„Å™„ÅÑ„Åü„ÇÅ„ÄÅ‰ªÆÁï™Âè∑„ÇíÁîüÊàê:', orderNumber);
        }
        
        // „ÉÜ„Éº„Éñ„É´Áï™Âè∑„ÇíÂèñÂæó
        let tableNumber = null;
        if (checkoutData.orders && Array.isArray(checkoutData.orders) && checkoutData.orders.length > 0) {
          tableNumber = checkoutData.orders[0].tableNumber;
        }
        
        // üõçÔ∏è „É¨„Ç∏Ë¢ãÊÉÖÂ†±„ÇíÂèñÂæóÔºàorders„Åã„ÇâÔºâ
        let bagNeeded = false;
        let bagQuantity = 0;
        let bagPrice = 0;
        
        if (checkoutData.orders && Array.isArray(checkoutData.orders)) {
          checkoutData.orders.forEach(order => {
            if (order.bagNeeded && order.bagQuantity > 0) {
              bagNeeded = true;
              bagQuantity += order.bagQuantity;
              bagPrice += (order.bagPrice || 0);
            }
          });
        }
        
        console.log('üõçÔ∏è È†òÂèéÊõ∏Áî®„É¨„Ç∏Ë¢ãÊÉÖÂ†±:', { bagNeeded, bagQuantity, bagPrice });
        
        const invoiceData = {
          orderNum: orderNumber,
          orderNumber: orderNumber,
          tableNumber: tableNumber || '',
          tax8Total: checkoutData.tax8Total || 0,
          tax10Total: checkoutData.tax10Total || 0,
          total: checkoutData.totalAmount,
          timestamp: checkoutData.timestamp ? (checkoutData.timestamp.toDate ? checkoutData.timestamp.toDate().getTime() : checkoutData.timestamp) : Date.now(),
          bagNeeded: bagNeeded,
          bagQuantity: bagQuantity,
          bagPrice: bagPrice,
          paymentMethod: checkoutData.paymentMethod || ''
        };
        
        showInvoiceDisplay(invoiceData);
        await openCashDrawer();
        
      } catch (e) {
        console.error('È†òÂèéÊõ∏Ë°®Á§∫„Ç®„É©„Éº:', e);
        await showCustomAlert({
          icon: '',
          title: '„Ç®„É©„Éº',
          message: 'È†òÂèéÊõ∏Ë°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message,
          btnClass: 'modal-btn-danger'
        });
      }
    }
    
    // Âñ∂Ê•≠Êó•„ÅÆÊó•‰ªòÊñáÂ≠óÂàó„ÇíÂèñÂæóÔºà3ÊôÇÂü∫Ê∫ñÔºâ
    function getBusinessDateStr() {
      const now = new Date();
      const _bd = window.getBusinessDay(now);
      const year = String(_bd.year);
      const month = String(_bd.month).padStart(2, '0');
      const day = String(_bd.day).padStart(2, '0');
      const dateStr = `${year}-${month}-${day}`;
      
      console.log('üìÖ Âñ∂Ê•≠Êó•Ë®àÁÆó:', {
        ÁèæÂú®ÊôÇÂàª: now.toLocaleString('ja-JP'),
        ÊôÇ: now.getHours(),
        Âñ∂Ê•≠Êó•: dateStr
      });
      
      return dateStr;
    }
    
    // ÂÆå‰∫ÜÂá¶ÁêÜÔºàPOS„ÅÆcompletedAt„Å´Âêà„Çè„Åõ„ÇãÔºâ- „ÉØ„É≥„Çø„ÉÉ„Éó„ÅßÂÆåÁµê
    window.completeOrdersForTable = async function() {
      try {
        playTapSound();
        const now = window.Timestamp.now();
        
        // window.ordersToCheckout„Åã„ÇâÂÆå‰∫ÜÂØæË±°„ÅÆÊ≥®Êñá„ÇíÂèñÂæóÔºà„Å™„Åë„Çå„Å∞currentOrdersÔºâ
        const ordersToComplete = window.ordersToCheckout || currentOrders;
        
        console.log('‚úÖ ÂÆå‰∫ÜÂá¶ÁêÜÈñãÂßã:', {
          ordersCount: ordersToComplete.length,
          orderIds: ordersToComplete.map(o => o.id)
        });
        
        // üÜï Âú®Â∫´„ÇíÊ∏õ„Çâ„ÅôÂá¶ÁêÜ
        for (const order of ordersToComplete) {
          // Ê≥®Êñá„ÇíÂÆå‰∫Ü„Å´„Åô„Çã
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          await window.updateDoc(orderRef, { 
            completedAt: now
          });
          console.log('‚úÖ Ê≥®Êñá„ÇíÂÆå‰∫Ü:', order.id);
          
          // üÜï Âú®Â∫´„ÇíÊ∏õ„Çâ„Åô
          if (order.items && Array.isArray(order.items)) {
            try {
              // Âú®Â∫´Ë®≠ÂÆö„ÇíÂèñÂæó
              const inventoryRef = window.doc(window.db, 'stores', currentStoreId, 'inventory_settings', 'default');
              const inventoryDoc = await window.getDoc(inventoryRef);
              
              if (inventoryDoc.exists()) {
                const inventoryData = inventoryDoc.data().items || {};
                let hasChanges = false;
                
                // ÂêÑÂïÜÂìÅ„ÅÆÂú®Â∫´„ÇíÊ∏õ„Çâ„Åô
                for (const item of order.items) {
                  // „É°„Éã„É•„Éº„Éá„Éº„Çø„Åã„ÇâÂïÜÂìÅID„ÇíÂèñÂæóÔºàÂêçÂâç„ÅßÊ§úÁ¥¢Ôºâ
                  const menuSnapshot = await window.getDocs(window.collection(window.db, 'stores', currentStoreId, 'menus'));
                  let menuId = null;
                  
                  menuSnapshot.forEach(doc => {
                    const menuData = doc.data();
                    if (menuData.name === item.name) {
                      menuId = menuData.id || doc.id;
                    }
                  });
                  
                  if (menuId && inventoryData[menuId]) {
                    const currentStock = inventoryData[menuId].stock;
                    if (currentStock !== undefined && currentStock !== null) {
                      // Âú®Â∫´„ÇíÊ∏õ„Çâ„Åô
                      const quantity = item.quantity || 1;
                      const newStock = Math.max(0, currentStock - quantity);
                      inventoryData[menuId].stock = newStock;
                      hasChanges = true;
                      
                      console.log(` Âú®Â∫´Ê∏õÁÆó: ${item.name} (${menuId}) ${currentStock} ‚Üí ${newStock} (-${quantity})`);
                    }
                  }
                }
                
                // Â§âÊõ¥„Åå„ÅÇ„Çå„Å∞‰øùÂ≠ò
                if (hasChanges) {
                  await window.setDoc(inventoryRef, {
                    items: inventoryData,
                    updatedAt: new Date().toISOString()
                  });
                  console.log('‚úÖ Âú®Â∫´„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü');
                }
              }
            } catch (inventoryError) {
              console.error('‚ö† Âú®Â∫´Êõ¥Êñ∞„Ç®„É©„Éº:', inventoryError);
              // Âú®Â∫´Êõ¥Êñ∞„Ç®„É©„Éº„ÅØËá¥ÂëΩÁöÑ„Åß„Å™„ÅÑ„Åü„ÇÅÁ∂öË°å
            }
          }
        }
        
        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        closePaymentModal();
        
        // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„Çâ„ÉÜ„Éº„Éñ„É´‰∏ÄË¶ß„ÇíÊõ¥Êñ∞ÔºàFirestore„ÅÆÂ§âÊõ¥„ÅåÂèçÊò†„Åï„Çå„Çã„ÅÆ„ÇíÂæÖ„Å§Ôºâ
        await new Promise(resolve => setTimeout(resolve, 500));
        
        await showCustomAlert({ 
          icon: '‚úÖ', 
          title: 'ÂÆå‰∫Ü', 
          message: 'Ê≥®Êñá„ÇíÂÆå‰∫Ü„Å´„Åó„Åæ„Åó„Åü„ÄÇ', 
          btnClass: 'modal-btn-success' 
        });
      } catch (error) {
        console.error('‚ùå ÂÆå‰∫ÜÂá¶ÁêÜ„Ç®„É©„Éº:', error);
        await showCustomAlert({ 
          icon: '‚ùå', 
          title: '„Ç®„É©„Éº', 
          message: 'ÂÆå‰∫ÜÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };

    // „Ç≠„É£„É≥„Çª„É´Âá¶ÁêÜ - „ÉØ„É≥„Çø„ÉÉ„Éó„ÅßÂÆåÁµê
    window.cancelOrdersForTable = async function() {
      try {
        playTapSound();
        const now = window.Timestamp.now();
        
        // window.ordersToCheckout„Åã„Çâ„Ç≠„É£„É≥„Çª„É´ÂØæË±°„ÅÆÊ≥®Êñá„ÇíÂèñÂæóÔºà„Å™„Åë„Çå„Å∞currentOrdersÔºâ
        const ordersToCancel = window.ordersToCheckout || currentOrders;
        
        console.log('‚è∏ „Ç≠„É£„É≥„Çª„É´Âá¶ÁêÜÈñãÂßã:', {
          ordersCount: ordersToCancel.length,
          orderIds: ordersToCancel.map(o => o.id)
        });
        
        for (const order of ordersToCancel) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          await window.updateDoc(orderRef, { 
            cancelledAt: now
          });
          console.log('‚úÖ Ê≥®Êñá„Çí„Ç≠„É£„É≥„Çª„É´:', order.id);
        }
        
        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        closePaymentModal();
        
        // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏ÔºàFirestore„ÅÆÂ§âÊõ¥„ÅåÂèçÊò†„Åï„Çå„Çã„ÅÆ„ÇíÂæÖ„Å§Ôºâ
        await new Promise(resolve => setTimeout(resolve, 500));
        
        await showCustomAlert({ 
          icon: '‚è∏', 
          title: '„Ç≠„É£„É≥„Çª„É´ÂÆå‰∫Ü', 
          message: 'Ê≥®Êñá„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åó„Åü„ÄÇ', 
          btnClass: 'modal-btn-success' 
        });
      } catch (error) {
        console.error('‚ùå „Ç≠„É£„É≥„Çª„É´Âá¶ÁêÜ„Ç®„É©„Éº:', error);
        await showCustomAlert({ 
          icon: '‚ùå', 
          title: '„Ç®„É©„Éº', 
          message: '„Ç≠„É£„É≥„Çª„É´Âá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };

    // ÂâäÈô§Âá¶ÁêÜ - „ÉØ„É≥„Çø„ÉÉ„Éó„ÅßÂÆåÁµê
    window.deleteOrdersForTable = async function() {
      try {
        playTapSound();
        
        // window.ordersToCheckout„Åã„ÇâÂâäÈô§ÂØæË±°„ÅÆÊ≥®Êñá„ÇíÂèñÂæóÔºà„Å™„Åë„Çå„Å∞currentOrdersÔºâ
        const ordersToDelete = window.ordersToCheckout || currentOrders;
        
        console.log('üóë ÂâäÈô§Âá¶ÁêÜÈñãÂßã:', {
          ordersCount: ordersToDelete.length,
          orderIds: ordersToDelete.map(o => o.id)
        });
        
        for (const order of ordersToDelete) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          // Firestore„Åã„ÇâÂÆåÂÖ®„Å´ÂâäÈô§ÔºàPOS„Åã„Çâ„ÇÇÊ∂à„Åà„ÇãÔºâ
          await window.deleteDoc(orderRef);
          console.log('‚úÖ Ê≥®Êñá„ÇíÂâäÈô§:', order.id);
        }
        
        // „É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        closePaymentModal();
        
        // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÊàêÂäü„É°„ÉÉ„Çª„Éº„Ç∏ÔºàFirestore„ÅÆÂ§âÊõ¥„ÅåÂèçÊò†„Åï„Çå„Çã„ÅÆ„ÇíÂæÖ„Å§Ôºâ
        await new Promise(resolve => setTimeout(resolve, 500));
        
        await showCustomAlert({ 
          icon: '‚úÖ', 
          title: 'ÂâäÈô§ÂÆå‰∫Ü', 
          message: 'Ê≥®Êñá„ÇíÂÆåÂÖ®„Å´ÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ\nPOS„Åã„Çâ„ÇÇÂâäÈô§„Åï„Çå„Åæ„Åô„ÄÇ', 
          btnClass: 'modal-btn-success' 
        });
      } catch (error) {
        console.error('‚ùå ÂâäÈô§„Ç®„É©„Éº:', error);
        await showCustomAlert({ 
          icon: '‚ùå', 
          title: '„Ç®„É©„Éº', 
          message: 'ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };

    window.addEventListener('DOMContentLoaded', async () => {
      while (!window.firebaseReady || !window.db) await new Promise(r => setTimeout(r, 100));
      await loadStoreList();
      if (sessionStorage.getItem('handyStoreId')) {
        currentStoreId = sessionStorage.getItem('handyStoreId');
        window.currentStoreId = currentStoreId; // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å®„Åó„Å¶Ë®≠ÂÆö
        currentStoreName = sessionStorage.getItem('handyStoreName');
        
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        console.log('üìç HANDY „Çª„ÉÉ„Ç∑„Éß„É≥„Åã„ÇâÂ∫óËàóIDÂæ©ÂÖÉ');
        console.log('   currentStoreId:', currentStoreId);
        console.log('   window.currentStoreId:', window.currentStoreId);
        console.log('   currentStoreName:', currentStoreName);
        console.log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ');
        
        showTablesScreen();
      }
    });
    
    // ==========  „É™„Ç¢„É´„Çø„Ç§„É†Âú®Â∫´„Éë„Éç„É´ ==========
    
    // Âú®Â∫´„Éë„Éç„É´„ÇíÊõ¥Êñ∞
    async function updateInventoryPanel() {
      try {
        console.log(' Âú®Â∫´„Éë„Éç„É´„ÇíÊõ¥Êñ∞‰∏≠...');
        
        // inventory_settings „ÇíÂèñÂæó
        let inventorySettingsRef;
        if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
          inventorySettingsRef = window.doc(window.db, 'inventory_settings', 'default');
        } else {
          inventorySettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
        }
        
        const inventorySettingsSnap = await window.getDoc(inventorySettingsRef);
        
        if (!inventorySettingsSnap.exists()) {
          console.log('‚ö† Âú®Â∫´Ë®≠ÂÆö„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì');
          document.getElementById('inventoryPanelContent').innerHTML = '<div style="padding: 10px; text-align: center; color: #999;">Âú®Â∫´Ë®≠ÂÆö„Å™„Åó</div>';
          // „Éê„Éº„ÅÆËâ≤„ÇíÈÄöÂ∏∏„Å´Êàª„Åô
          document.getElementById('inventoryPanelBar').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          return;
        }
        
        const inventorySettingsData = inventorySettingsSnap.data();
        const inventoryItems = inventorySettingsData.items || {};
        
        // menus„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Åã„ÇâÂïÜÂìÅÂêç„ÇíÂèñÂæó
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        const idToNameMap = {};
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          const itemId = data.id || doc.id;
          if (data.name) {
            idToNameMap[itemId] = data.name;
          }
        });
        
        // Âú®Â∫´„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂïÜÂìÅ„ÅÆ„ÅøË°®Á§∫ÔºàÂú®Â∫´Â∞ë„ÉªÂìÅÂàá„Çå„ÇíÂÑ™ÂÖàÔºâ
        const lowStockItems = [];
        const outOfStockItems = [];
        const normalStockItems = [];
        
        for (const [itemId, settings] of Object.entries(inventoryItems)) {
          const stock = settings.stock;
          const alertThreshold = settings.alertThreshold;
          const itemName = idToNameMap[itemId] || itemId;
          
          // stock„Åånull„Åß„Å™„ÅÑÔºàÂú®Â∫´ÁÆ°ÁêÜÂØæË±°ÔºâÂ†¥Âêà„ÅÆ„ÅøË°®Á§∫
          if (stock !== null && stock !== undefined) {
            const item = { id: itemId, name: itemName, stock, alertThreshold };
            
            if (stock === 0) {
              outOfStockItems.push(item);
            } else if (alertThreshold !== null && alertThreshold !== undefined && stock <= alertThreshold) {
              lowStockItems.push(item);
            } else {
              normalStockItems.push(item);
            }
          }
        }
        
        // üÜï „Éê„Éº„ÅÆËâ≤„ÇíÂú®Â∫´Áä∂ÊÖã„Å´Âøú„Åò„Å¶Â§âÊõ¥
        const panelBar = document.getElementById('inventoryPanelBar');
        if (outOfStockItems.length > 0) {
          // Âú®Â∫´Âàá„Çå„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØËµ§
          panelBar.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
        } else if (lowStockItems.length > 0) {
          // Âú®Â∫´Â∞ë„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØÈªÑËâ≤
          panelBar.style.background = 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
        } else {
          // ÂïèÈ°å„Å™„Åó„ÅÆÂ†¥Âêà„ÅØÁ¥´ÔºàÈÄöÂ∏∏Ôºâ
          panelBar.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        }
        
        // Ë°®Á§∫Áî®HTMLÁîüÊàê
        let html = '';
        
        // ÂìÅÂàá„ÇåÔºàËµ§Ôºâ
        outOfStockItems.forEach(item => {
          html += `
            <div style="padding: 8px 12px; background: #ffebee; border-left: 4px solid #f44336; margin-bottom: 6px; border-radius: 4px;">
              <div style="font-weight: bold; color: #f44336; font-size: 14px;">${item.name}</div>
              <div style="color: #f44336; font-size: 13px; font-weight: bold;">ÂìÅÂàá</div>
            </div>
          `;
        });
        
        // Âú®Â∫´Â∞ëÔºàÈªÑÔºâ
        lowStockItems.forEach(item => {
          html += `
            <div style="padding: 8px 12px; background: #fff9e6; border-left: 4px solid #ff9800; margin-bottom: 6px; border-radius: 4px;">
              <div style="font-weight: bold; color: #ff9800; font-size: 14px;">${item.name}</div>
              <div style="color: #ff9800; font-size: 13px;">ÊÆã ${item.stock}</div>
            </div>
          `;
        });
        
        if (html === '') {
          html = '<div style="padding: 10px; text-align: center; color: #4caf50; font-weight: bold;">Âú®Â∫´ÂÖÖÂàÜ‚úì</div>';
        }
        
        document.getElementById('inventoryPanelContent').innerHTML = html;
        console.log('‚úÖ Âú®Â∫´„Éë„Éç„É´Êõ¥Êñ∞ÂÆå‰∫Ü');
        
      } catch (error) {
        console.error('‚ùå Âú®Â∫´„Éë„Éç„É´Êõ¥Êñ∞„Ç®„É©„Éº:', error);
      }
    }
    
    // Âú®Â∫´„Éë„Éç„É´„ÅÆË°®Á§∫/ÈùûË°®Á§∫Âàá„ÇäÊõø„Åà
    function toggleInventoryPanel() {
      const panel = document.getElementById('inventoryPanel');
      const arrow = document.getElementById('inventoryPanelArrow');
      const isCollapsed = panel.classList.contains('collapsed');
      
      if (isCollapsed) {
        panel.classList.remove('collapsed');
        panel.style.maxHeight = '400px';
        arrow.textContent = '‚ñº';
      } else {
        panel.classList.add('collapsed');
        panel.style.maxHeight = '45px';
        arrow.textContent = '‚ñ≤';
      }
    }
    
    // inventory_settings„ÅÆÂ§âÊõ¥„Çí„É™„Ç¢„É´„Çø„Ç§„É†Áõ£Ë¶ñ
    function watchInventoryChanges() {
      let inventorySettingsRef;
      if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
        inventorySettingsRef = window.doc(window.db, 'inventory_settings', 'default');
      } else {
        inventorySettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
      }
      
      const unsubscribe = window.onSnapshot(inventorySettingsRef, (doc) => {
        if (doc.exists()) {
          console.log(' Âú®Â∫´„Éá„Éº„Çø„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„Åü');
          updateInventoryPanel();
        }
      });
      
      return unsubscribe;
    }
    
    // ========== üÜï POS„É¢„Éº„ÉÄ„É´Ê©üËÉΩ ==========
    
    // „É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„ÇílocalStorage„Å´‰øùÂ≠ò
    window.saveLoginInfo = function(storeId, password) {
      localStorage.setItem('handy_storeId', storeId);
      localStorage.setItem('handy_password', password);
    };
    
    // ‰øùÂ≠ò„Åï„Çå„Åü„É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„ÇíÂèñÂæó
    window.getSavedLoginInfo = function() {
      return {
        storeId: localStorage.getItem('handy_storeId'),
        password: localStorage.getItem('handy_password')
      };
    };
    
    // Ê©üËÉΩ„É°„Éã„É•„Éº„Çí„Éà„Ç∞„É´
    function toggleFunctionsMenu() {
      const menu = document.getElementById('functionsSubMenu');
      if (menu.style.display === 'none' || menu.style.display === '') {
        menu.style.display = 'block';
      } else {
        menu.style.display = 'none';
      }
    }
    
    // „É°„Éã„É•„ÉºÂ§ñ„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„Åü„ÇâÈñâ„Åò„Çã
    document.addEventListener('click', function(e) {
      const menu = document.getElementById('functionsSubMenu');
      const btn = e.target.closest('.sales-btn');
      if (menu && menu.style.display === 'block' && !menu.contains(e.target) && !btn) {
        menu.style.display = 'none';
      }
    });
    
    // POS„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
    window.openPOSModal = function(modalType) {
      const modal = document.getElementById('posIframeModal');
      const iframe = document.getElementById('posIframe');
      const title = document.getElementById('posModalTitle');
      
      // „Çø„Ç§„Éà„É´„ÇíË®≠ÂÆö
      const titles = {
        'sales': 'Â£≤‰∏ä',
        'expense': 'ÊîØÂá∫',
        'monthly': 'ÊúàÊ¨°',
        'history': 'Â±•Ê≠¥',
        'printer': '„Éó„É™„É≥„ÇøË®≠ÂÆö'
      };
      title.textContent = titles[modalType] || 'POSÊ©üËÉΩ';
      
      // ‰øùÂ≠ò„Åï„Çå„Åü„É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„ÇíÂèñÂæó
      const loginInfo = window.getSavedLoginInfo();
      
      // URL„ÇíÊßãÁØâ
      let url = 'https://gymnastmasaki-lang.github.io/takoyaki-/pos.html';
      const params = new URLSearchParams();
      
      params.append('modal', modalType);
      
      // „É≠„Ç∞„Ç§„É≥ÊÉÖÂ†±„Çí„Éë„É©„É°„Éº„Çø„Å´ËøΩÂä†
      if (loginInfo.storeId && loginInfo.password) {
        params.append('storeId', loginInfo.storeId);
        params.append('password', loginInfo.password);
        params.append('autoLogin', 'true');
      }
      
      if (params.toString()) {
        url += '?' + params.toString();
      }
      
      iframe.src = url;
      modal.classList.add('active');
      
      // Ê©üËÉΩ„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
    };
    
    // „Éâ„É≠„Ç¢Èñã„ÇíÁõ¥Êé•ÂÆüË°å
    window.openDrawerDirect = async function() {
      try {
        const now = new Date();
        const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          const currentCount = data.drawerOpenCount || 0;
          await window.updateDoc(salesRef, {
            drawerOpenCount: currentCount + 1,
            updatedAt: window.Timestamp.now()
          });
        } else {
          await window.setDoc(salesRef, {
            date: dateStr,
            totalSales: 0,
            customerCount: 0,
            drawerOpenCount: 1,
            createdAt: window.Timestamp.now(),
            updatedAt: window.Timestamp.now()
          });
        }
        
        await showCustomAlert({ 
          icon: '', 
          title: 'ÂÆå‰∫Ü', 
          message: '„Éâ„É≠„Ç¢„ÇíÈñã„Åç„Åæ„Åó„Åü', 
          btnClass: 'modal-btn-success' 
        });
        
        // Ê©üËÉΩ„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
        const menu = document.getElementById('functionsSubMenu');
        if (menu) {
          menu.style.display = 'none';
        }
      } catch (e) {
        console.error('„Éâ„É≠„Ç¢Èñã„Ç®„É©„Éº:', e);
        await showCustomAlert({ 
          icon: '', 
          title: '„Ç®„É©„Éº', 
          message: '„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    // üÜï Â£≤‰∏ä„É¢„Éº„ÉÄ„É´„ÇíÁõ¥Êé•Ë°®Á§∫
    
    // üÜï Â£≤‰∏ä„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    window.closeSalesModal = function() {
      document.getElementById('salesModal').style.display = 'none';
    };
    
    // POS„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    window.closePOSModal = function() {
      const modal = document.getElementById('posIframeModal');
      const iframe = document.getElementById('posIframe');
      
      modal.classList.remove('active');
      // iframe„Çí„É™„Çª„ÉÉ„ÉàÔºà„É°„É¢„É™Ëß£ÊîæÔºâ
      setTimeout(() => {
        iframe.src = 'about:blank';
      }, 300);
    };
    
    // ==========  Â£≤‰∏ä„É¢„Éº„ÉÄ„É´Ê©üËÉΩ ==========
    
    // Â£≤‰∏ä„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
    window.showSalesModal = function() {
      document.getElementById('salesModal').style.display = 'flex';
      
      // üÜï Êó•Ë®àË°®„ÅÆÊúàÈÅ∏ÊäûËÇ¢„ÇíÁîüÊàêÔºàÈÅéÂéª12„É∂ÊúàÂàÜÔºâ
      const monthSelect = document.getElementById('dailyReportMonth');
      if (monthSelect) {
        monthSelect.innerHTML = '';
        const now = new Date();
        for (let i = 0; i < 12; i++) {
          const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const year = targetDate.getFullYear();
          const month = targetDate.getMonth() + 1;
          const option = document.createElement('option');
          option.value = `${year}-${String(month).padStart(2, '0')}`;
          option.textContent = `${year}Âπ¥${month}Êúà`;
          if (i === 0) option.selected = true;
          monthSelect.appendChild(option);
        }
      }
      
      calculateSales();
      
      // Ê©üËÉΩ„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
    };
    
    // Â£≤‰∏ä„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    window.closeSalesModal = function() {
      document.getElementById('salesModal').style.display = 'none';
    };
    
    // Â£≤‰∏ä„ÇíË®àÁÆóÔºàÊã°ÂºµÁâà - ÊîØÊâïÊñπÊ≥ïÂà•„ÄÅÁõÆÊ®ôÈÅîÊàêÁéá„ÄÅÁ¥îÂà©ÁõäÔºâ
    window.calculateSales = async function() {
      const container = document.getElementById('salesContent');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">ÈõÜË®à‰∏≠...</div>';
      
      try {
        // Êú¨Êó•„ÅÆÊó•‰ªò„ÇíÂèñÂæóÔºà3ÊôÇÂü∫Ê∫ñÔºâ
        const now = new Date();
        const dateStr = window.getBusinessDay(now).str;
        
        console.log('üìä Â£≤‰∏äÂèñÂæóÊó•‰ªò:', dateStr);
        
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        let totalSales = 0;
        let cashSales = 0;
        let emoneSales = 0;
        let creditSales = 0;
        let orderCount = 0;
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          console.log(' Â£≤‰∏ä„Éá„Éº„Çø:', data);
          totalSales = data.totalSales || 0;
          cashSales = data.cashSales || 0;
          emoneSales = data.emoneSales || 0;
          creditSales = data.creditSales || 0;
          orderCount = data.customerCount || 0;
        } else {
          console.log('‚ö† Â£≤‰∏ä„Éá„Éº„Çø„ÅåÂ≠òÂú®„Åó„Åæ„Åõ„Çì');
        }
        
        // ‰∫∫‰ª∂Ë≤ª„ÇíÂèñÂæó
        let todayLaborCost = 0;
        try {
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.date === dateStr) {
              if (data.totalWage && data.totalWage > 0) {
                todayLaborCost += data.totalWage;
              } else if (data.clockIn && data.clockOut) {
                const clockIn = new Date(`${dateStr} ${data.clockIn}`);
                const clockOut = new Date(`${dateStr} ${data.clockOut}`);
                let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                
                if (data.breakStart1 && data.breakEnd1) {
                  const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                  const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                  workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                }
                if (data.breakStart2 && data.breakEnd2) {
                  const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                  const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                  workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                }
                
                const hourlyRate = data.hourlyRate || 1150;
                todayLaborCost += workHours * hourlyRate;
              }
            }
          });
        } catch (e) {
          console.error('‰∫∫‰ª∂Ë≤ªÂèñÂæó„Ç®„É©„Éº:', e);
        }
        
        // ÊîØÂá∫„ÇíÂèñÂæó
        let todayExpense = 0;
        try {
          const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
          if (expenseDoc.exists()) {
            todayExpense = expenseDoc.data().total || 0;
          }
        } catch (e) {
          console.error('ÊîØÂá∫ÂèñÂæó„Ç®„É©„Éº:', e);
        }
        
        // Á¥îÂà©ÁõäË®àÁÆó
        const grossProfit = totalSales - todayLaborCost;
        const netProfit = totalSales - todayLaborCost - todayExpense;
        const netProfitRate = totalSales > 0 ? (netProfit / totalSales * 100).toFixed(1) : 0;
        const laborCostRate = totalSales > 0 ? (todayLaborCost / totalSales * 100).toFixed(1) : 0;
        const expenseRate = totalSales > 0 ? (todayExpense / totalSales * 100).toFixed(1) : 0;
        
        // Â£≤‰∏äÁõÆÊ®ôÈÅîÊàêÁéá
        const dayOfWeek = now.getDay();
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
        const targetSales = isWeekend ? 70000 : 50000;
        const achievementRate = Math.round((totalSales / targetSales) * 100);
        const rateColor = achievementRate >= 100 ? '#4CAF50' : achievementRate >= 80 ? '#FF9800' : '#f44336';
        const netProfitColor = netProfit >= 0 ? '#4CAF50' : '#f44336';
        
        container.innerHTML = `
          <div style="background: white; border-radius: 12px; padding: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
              <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;">Á∑èÂ£≤‰∏ä</div>
                <div style="font-size: 28px; font-weight: bold;">¬•${totalSales.toLocaleString()}</div>
              </div>
              <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;">ÂÆ¢Êï∞</div>
                <div style="font-size: 28px; font-weight: bold;">${orderCount}‰ª∂</div>
              </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
              <h4 style="margin: 0 0 10px 0;">Â£≤‰∏äÁõÆÊ®ô</h4>
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>ÁõÆÊ®ôÈáëÈ°çÔºà${isWeekend ? 'ÂúüÊó•Á•ù' : 'Âπ≥Êó•'}Ôºâ</span>
                <strong>¬•${targetSales.toLocaleString()}</strong>
              </div>
              <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 32px; font-weight: bold; color: ${rateColor};">${achievementRate}%</div>
                <div style="font-size: 14px; opacity: 0.9;">ÈÅîÊàêÁéá</div>
              </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #FF6B6B 0%, #C92A2A 100%); border-radius: 10px; color: white;">
              <h4 style="margin: 0 0 15px 0;">Êú¨Êó•„ÅÆÁ¥îÂà©Áõä</h4>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                <span>Â£≤‰∏ä</span>
                <strong>¬•${totalSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                <span>‚àí ‰∫∫‰ª∂Ë≤ª${totalSales > 0 ? 'Ôºà' + laborCostRate + '%Ôºâ' : ''}</span>
                <strong>¬•${Math.round(todayLaborCost).toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px;">
                <span>‚àí ÊîØÂá∫${totalSales > 0 ? 'Ôºà' + expenseRate + '%Ôºâ' : ''}</span>
                <strong>¬•${Math.round(todayExpense).toLocaleString()}</strong>
              </div>
              <div style="border-top: 2px solid rgba(255,255,255,0.3); padding-top: 12px;">
                <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                  <div style="font-size: 16px; opacity: 0.9; margin-bottom: 5px;">Á¥îÂà©Áõä</div>
                  <div style="font-size: 32px; font-weight: bold; color: ${netProfitColor};">¬•${Math.round(netProfit).toLocaleString()}</div>
                  <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">Á¥îÂà©ÁõäÁéá: ${netProfitRate}%</div>
                </div>
              </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
              <h4 style="margin: 0 0 15px 0;">ÊîØÊâï„ÅÑÊñπÊ≥ïÂà•</h4>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>ÁèæÈáë</span>
                <strong>¬•${cashSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>„Ç´„Éº„Éâ</span>
                <strong>¬•${creditSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span>ÈõªÂ≠ê„Éû„Éç„Éº</span>
                <strong>¬•${emoneSales.toLocaleString()}</strong>
              </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
              <button onclick="playTapSound(); executeDailySettlement()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(255,107,107,0.3);">
                Á≤æÁÆó„ÇíÂÆüË°å
              </button>
              <div style="margin-bottom: 10px;">
                <label style="display: block; margin-bottom: 5px; color: #333; font-weight: bold;">Êó•Ë®àË°®Âá∫Âäõ„Åô„ÇãÊúà„ÇíÈÅ∏Êäû:</label>
                <select id="dailyReportMonth" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px;">
                  <!-- ÈÅéÂéª12„É∂ÊúàÂàÜ„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÂãïÁöÑ„Å´ÁîüÊàê -->
                </select>
                <button onclick="playTapSound(); generateDailyReportForSelectedMonth()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(76,175,80,0.3);">
                  Êó•Ë®àË°®Âá∫Âäõ
                </button>
              </div>
            </div>
          </div>
        `;
        
        // üÜï ÊúàÈÅ∏ÊäûËÇ¢„ÇíÂÜçÁîüÊàêÔºàHTML„ÇíÂÜçÊßãÁØâ„Åó„ÅüÂæåÔºâ
        const monthSelect = document.getElementById('dailyReportMonth');
        if (monthSelect) {
          monthSelect.innerHTML = '';
          const now = new Date();
          for (let i = 0; i < 12; i++) {
            const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const year = targetDate.getFullYear();
            const month = targetDate.getMonth() + 1;
            const option = document.createElement('option');
            option.value = `${year}-${String(month).padStart(2, '0')}`;
            option.textContent = `${year}Âπ¥${month}Êúà`;
            if (i === 0) option.selected = true;
            monthSelect.appendChild(option);
          }
        }
        
      } catch (e) {
        console.error('Â£≤‰∏äË®àÁÆó„Ç®„É©„Éº:', e);
        container.innerHTML = '<div style="text-align: center; color: red; padding: 20px;">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</div>';
      }
    };
    
    // ==========  Á≤æÁÆóÊ©üËÉΩ ==========
    
    // üÜï Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÈñ¢Êï∞
    window.createAutoBackup = async function() {
      try {
        console.log('üîÑ Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÈñãÂßãÔºà7Êó•„É≠„Éº„ÉÜ„Éº„Ç∑„Éß„É≥Ôºâ');
        
        const { getDocs, setDoc, doc, Timestamp } = window;
        const today = new Date();
        const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
        
        // „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éá„Éº„Çø„ÇíÂèéÈõÜ
        const backupData = {
          timestamp: Timestamp.now(),
          date: dateStr,
          type: 'auto',
          data: {}
        };
        
        // 1. ÂïÜÂìÅ„Éá„Éº„ÇøÔºàmenusÔºâ
        const menusSnapshot = await getDocs(window.getStoreCollection('menus'));
        backupData.data.menus = [];
        menusSnapshot.forEach(docSnap => {
          backupData.data.menus.push({
            id: docSnap.id,
            ...docSnap.data()
          });
        });
        console.log(`üì¶ ÂïÜÂìÅ: ${backupData.data.menus.length}‰ª∂`);
        
        // 2. ÂæìÊ•≠Âì°„Éá„Éº„ÇøÔºàemployeesÔºâ
        const employeesSnapshot = await getDocs(window.getStoreCollection('employees'));
        backupData.data.employees = [];
        employeesSnapshot.forEach(docSnap => {
          backupData.data.employees.push({
            id: docSnap.id,
            ...docSnap.data()
          });
        });
        console.log(`üë• ÂæìÊ•≠Âì°: ${backupData.data.employees.length}Âêç`);
        
        // 3. Ê≥®ÊñáÂ±•Ê≠¥ÔºàordersÔºâ- ÊúÄËøë1000‰ª∂„ÅÆ„Åø
        const ordersCollection = window.getStoreCollection('orders');
        const ordersSnapshot = await getDocs(ordersCollection);
        const ordersList = [];
        ordersSnapshot.forEach(docSnap => {
          const data = docSnap.data();
          ordersList.push({
            id: docSnap.id,
            ...data,
            _timestamp: data.createdAt || data.timestamp || new Date(0)
          });
        });
        
        // Êó•‰ªò„Åß„ÇΩ„Éº„ÉàÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ
        ordersList.sort((a, b) => {
          const timeA = a._timestamp?.toDate ? a._timestamp.toDate() : new Date(a._timestamp);
          const timeB = b._timestamp?.toDate ? b._timestamp.toDate() : new Date(b._timestamp);
          return timeB - timeA;
        });
        
        // ÊúÄÊñ∞1000‰ª∂„ÅÆ„Åø‰øùÂ≠ò
        backupData.data.orders = ordersList.slice(0, 1000).map(item => {
          const { _timestamp, ...rest } = item;
          return rest;
        });
        console.log(`üìù Ê≥®ÊñáÂ±•Ê≠¥: ${backupData.data.orders.length}‰ª∂`);
        
        // 4. Âã§ÊÄ†„Éá„Éº„ÇøÔºàattendanceÔºâ- ÊúÄËøë1000‰ª∂„ÅÆ„Åø
        const attendanceCollection = window.getStoreCollection('attendance');
        const attendanceSnapshot = await getDocs(attendanceCollection);
        const attendanceList = [];
        attendanceSnapshot.forEach(docSnap => {
          const data = docSnap.data();
          attendanceList.push({
            id: docSnap.id,
            ...data,
            _timestamp: data.createdAt || data.timestamp || new Date(0)
          });
        });
        
        // Êó•‰ªò„Åß„ÇΩ„Éº„ÉàÔºàÊñ∞„Åó„ÅÑÈ†ÜÔºâ
        attendanceList.sort((a, b) => {
          const timeA = a._timestamp?.toDate ? a._timestamp.toDate() : new Date(a._timestamp);
          const timeB = b._timestamp?.toDate ? b._timestamp.toDate() : new Date(b._timestamp);
          return timeB - timeA;
        });
        
        // ÊúÄÊñ∞1000‰ª∂„ÅÆ„Åø‰øùÂ≠ò
        backupData.data.attendance = attendanceList.slice(0, 1000).map(item => {
          const { _timestamp, ...rest } = item;
          return rest;
        });
        console.log(`‚è∞ Âã§ÊÄ†: ${backupData.data.attendance.length}‰ª∂`);
        
        // 5. Ë®≠ÂÆö„Éá„Éº„Çø„ÇíÂèñÂæó
        try {
          // „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö
          let tableRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            tableRef = doc(window.db, 'stores', window.currentStoreId, 'table_settings', 'default');
          } else {
            tableRef = doc(window.db, 'table_settings', 'default');
          }
          const tableDoc = await window.getDoc(tableRef);
          backupData.data.table_settings = tableDoc.exists() ? tableDoc.data() : null;
          
          // „É¨„Ç∑„Éº„ÉàË®≠ÂÆö
          let receiptRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            receiptRef = doc(window.db, 'stores', window.currentStoreId, 'receipt_settings', 'default');
          } else {
            receiptRef = doc(window.db, 'receipt_settings', 'default');
          }
          const receiptDoc = await window.getDoc(receiptRef);
          backupData.data.receipt_settings = receiptDoc.exists() ? receiptDoc.data() : null;
          
          // „É°„Éã„É•„ÉºË®≠ÂÆö
          let menuSettingsRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            menuSettingsRef = doc(window.db, 'stores', window.currentStoreId, 'menu_settings', 'default');
          } else {
            menuSettingsRef = doc(window.db, 'menu_settings', 'default');
          }
          const menuSettingsDoc = await window.getDoc(menuSettingsRef);
          backupData.data.menu_settings = menuSettingsDoc.exists() ? menuSettingsDoc.data() : null;
          
          // Âú®Â∫´Ë®≠ÂÆö
          let inventoryRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            inventoryRef = doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
          } else {
            inventoryRef = doc(window.db, 'inventory_settings', 'default');
          }
          const inventoryDoc = await window.getDoc(inventoryRef);
          backupData.data.inventory_settings = inventoryDoc.exists() ? inventoryDoc.data() : null;
          
          // „Ç¢„É©„Éº„ÉàË®≠ÂÆö
          let alertRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            alertRef = doc(window.db, 'stores', window.currentStoreId, 'alert_settings', 'default');
          } else {
            alertRef = doc(window.db, 'alert_settings', 'default');
          }
          const alertDoc = await window.getDoc(alertRef);
          backupData.data.alert_settings = alertDoc.exists() ? alertDoc.data() : null;
          
          // Âñ∂Ê•≠ÊôÇÈñìË®≠ÂÆö
          let businessRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            businessRef = doc(window.db, 'stores', window.currentStoreId, 'business_hours', 'default');
          } else {
            businessRef = doc(window.db, 'business_hours', 'default');
          }
          const businessDoc = await window.getDoc(businessRef);
          backupData.data.business_hours = businessDoc.exists() ? businessDoc.data() : null;
          
          const settingsCount = [
            backupData.data.menu_settings,
            backupData.data.receipt_settings,
            backupData.data.inventory_settings,
            backupData.data.alert_settings,
            backupData.data.business_hours,
            backupData.data.table_settings
          ].filter(s => s !== null).length;
          
          console.log(`‚öôÔ∏è Ë®≠ÂÆö: ${settingsCount}Á®ÆÈ°û`);
        } catch (e) {
          console.error('Ë®≠ÂÆö„Éá„Éº„ÇøÂèñÂæó„Ç®„É©„Éº:', e);
          backupData.data.menu_settings = null;
          backupData.data.receipt_settings = null;
          backupData.data.inventory_settings = null;
          backupData.data.alert_settings = null;
          backupData.data.business_hours = null;
          backupData.data.table_settings = null;
        }
        
        // „ÉÜ„Éº„Éñ„É´„Éá„Éº„ÇøÔºàÂêÑ„ÉÜ„Éº„Éñ„É´„ÅÆ„Éâ„Ç≠„É•„É°„É≥„ÉàÔºâ
        try {
          const tablesSnapshot = await getDocs(window.getStoreCollection('tables'));
          backupData.data.tables = [];
          tablesSnapshot.forEach(docSnap => {
            backupData.data.tables.push({ id: docSnap.id, ...docSnap.data() });
          });
          console.log(`„ÉÜ„Éº„Éñ„É´: ${backupData.data.tables.length}‰ª∂`);
        } catch (e) {
          console.warn('„ÉÜ„Éº„Éñ„É´„Éá„Éº„Çø„ÅÆÂèñÂæó„Å´Â§±Êïó:', e.message);
          backupData.data.tables = [];
        }
        
        // „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰øùÂ≠òÔºà7Êó•„É≠„Éº„ÉÜ„Éº„Ç∑„Éß„É≥Ôºâ
        const dayOfWeek = today.getDay(); // 0=Êó•Êõú, 1=ÊúàÊõú, ..., 6=ÂúüÊõú
        const backupId = `auto_day${dayOfWeek}`; // day0„Äúday6„Åß7Êó•„É≠„Éº„ÉÜ„Éº„Ç∑„Éß„É≥
        
        let backupRef;
        if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
          backupRef = doc(window.db, 'stores', window.currentStoreId, 'backups', backupId);
        } else {
          backupRef = doc(window.db, 'backups', backupId);
        }
        
        await setDoc(backupRef, backupData);
        
        console.log(`‚úÖ Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÂÆå‰∫Ü: ${backupId} (${dateStr})`);
        return true;
      } catch (error) {
        console.error('‚ùå Ëá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Ç®„É©„Éº:', error);
        return false;
      }
    };
    
    window.showSettlementModal = async function() {
      // Ê©üËÉΩ„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('settlementModal').style.display = 'flex';
      
      // üÜï Êó•Ë®àË°®„ÅÆÊúàÈÅ∏ÊäûËÇ¢„ÇíÁîüÊàêÔºàÈÅéÂéª12„É∂ÊúàÂàÜÔºâ
      const monthSelect = document.getElementById('dailyReportMonth');
      if (monthSelect) {
        monthSelect.innerHTML = '';
        const now = new Date();
        for (let i = 0; i < 12; i++) {
          const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const year = targetDate.getFullYear();
          const month = targetDate.getMonth() + 1;
          const option = document.createElement('option');
          option.value = `${year}-${String(month).padStart(2, '0')}`;
          option.textContent = `${year}Âπ¥${month}Êúà`;
          if (i === 0) option.selected = true;
          monthSelect.appendChild(option);
        }
      }
      
      // Êú¨Êó•„ÅÆÊó•‰ªò„Çí„Éá„Éï„Ç©„É´„Éà„Å´Ë®≠ÂÆö
      const now2 = new Date();
      const dateStr = window.getBusinessDay(now2).str;
      document.getElementById('settlementDate').value = dateStr;
      
      // Â£≤‰∏ä„Çµ„Éû„É™„Éº„ÇíË°®Á§∫
      await loadSettlementSummary(dateStr);
    };
    
    window.closeSettlementModal = function() {
      document.getElementById('settlementModal').style.display = 'none';
    };
    
    window.loadSettlementSummary = async function(dateStr) {
      const container = document.getElementById('settlementSummary');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">ÈõÜË®à‰∏≠...</div>';
      
      try {
        // Êó•Ê¨°Â£≤‰∏ä„Éá„Éº„Çø„Åã„ÇâÂèñÂæó
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        let settlementData = {
          totalSales: 0,
          customerCount: 0,
          totalItems: 0,
          cashSales: 0,
          emoneSales: 0,
          creditSales: 0,
          totalDiscount: 0,
          tax8Total: 0,
          tax10Total: 0,
          drawerOpenCount: 0,
          redSlipCount: 0,
          redSlipAmount: 0,
          redSlipTax8Total: 0,
          redSlipTax10Total: 0
        };
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          console.log('üìä dailySales„Éá„Éº„Çø:', data);
          console.log('üîì drawerOpenCount:', data.drawerOpenCount);
          
          settlementData = {
            totalSales: data.totalSales || 0,
            customerCount: data.customerCount || 0,
            totalItems: data.totalItems || 0,
            cashSales: data.cashSales || 0,
            emoneSales: data.emoneSales || 0,
            creditSales: data.creditSales || 0,
            totalDiscount: data.totalDiscount || 0,
            tax8Total: data.tax8Total || 0,
            tax10Total: data.tax10Total || 0,
            drawerOpenCount: data.drawerOpenCount || 0,
            redSlipCount: data.redSlipCount || 0,
            redSlipAmount: data.redSlipAmount || 0,
            redSlipTax8Total: data.redSlipTax8Total || 0,
            redSlipTax10Total: data.redSlipTax10Total || 0
          };
          
          console.log('üìä settlementData:', settlementData);
        }
        
        // settlementData„Çí„Ç∞„É≠„Éº„Éê„É´„Å´‰øùÂ≠ò
        window.currentSettlementData = settlementData;
        window.currentSettlementDate = dateStr;
        
        container.innerHTML = `
          <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 2px solid #ddd;">
              <span style="font-size: 16px;">Á∑èÂ£≤‰∏ä</span>
              <strong style="font-size: 20px; color: #4CAF50;">¬•${settlementData.totalSales.toLocaleString()}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
              <span>ÂÆ¢Êï∞</span>
              <strong>${settlementData.customerCount}ÁµÑ</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
              <span>ÁèæÈáë</span>
              <strong>¬•${settlementData.cashSales.toLocaleString()}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
              <span>„Ç´„Éº„Éâ</span>
              <strong>¬•${settlementData.creditSales.toLocaleString()}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0;">
              <span>ÈõªÂ≠ê„Éû„Éç„Éº</span>
              <strong>¬•${settlementData.emoneSales.toLocaleString()}</strong>
            </div>
          </div>
        `;
      } catch (e) {
        console.error('Á≤æÁÆó„Çµ„Éû„É™„Éº„Ç®„É©„Éº:', e);
        container.innerHTML = '<div style="text-align: center; color: red;">„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü</div>';
      }
    }
    
    // Á≤æÁÆó„ÇíÂÆüË°åÔºàCSV„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÔºâ
    window.confirmSettlement = async function() {
      // FirebaseÂàùÊúüÂåñ„ÇíÂæÖ„Å§
      if (!window.firebaseReady) {
        await new Promise(resolve => {
          window.addEventListener('firebaseReady', resolve, { once: true });
        });
      }
      
      // üÜï „Ç™„Ç∑„É£„É¨„Å™„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÁ¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
      const shouldBackup = await new Promise((resolve) => {
        // „É¢„Éº„ÉÄ„É´HTML‰ΩúÊàê
        const modal = document.createElement('div');
        modal.id = 'backupConfirmModal';
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
          background: rgba(0,0,0,0.7); display: flex; align-items: center; 
          justify-content: center; z-index: 999999; animation: fadeIn 0.2s;
        `;
        
        modal.innerHTML = `
          <div style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px; padding: 0; max-width: 500px; width: 90%;
            max-height: 85vh; display: flex; flex-direction: column;
            box-shadow: 0 25px 60px rgba(0,0,0,0.4); overflow: hidden;
            animation: slideUp 0.3s;
          ">
            <div style="background: white; padding: 32px; border-radius: 0 0 24px 24px; overflow-y: auto; flex: 1;">
              <div style="text-align: center; margin-bottom: 24px;">
                <h3 style="font-size: 22px; font-weight: bold; color: #333; margin-bottom: 8px;">
                  Á≤æÁÆó„ÇíÂÆüË°å„Åô„ÇãÂâç„Å´„ÄÅ„Éá„Éº„Çø„ÅÆËá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÅãÔºü
                </h3>
              </div>
              
              <div style="background: #f0f7ff; border-left: 4px solid #667eea; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <div style="font-weight: bold; color: #667eea; margin-bottom: 10px; font-size: 15px;">„ÄêÊé®Â•®: „ÅØ„ÅÑ„Äë</div>
                <div style="color: #555; font-size: 13px; line-height: 1.6;">
                  ‰ª•‰∏ã„Åå„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åï„Çå„Åæ„ÅôÔºö<br>
                  ‚Ä¢ ÂïÜÂìÅ<br>
                  ‚Ä¢ ÂæìÊ•≠Âì°<br>
                  ‚Ä¢ Ê≥®ÊñáÂ±•Ê≠¥<br>
                  ‚Ä¢ Âã§ÊÄ†„Éá„Éº„Çø<br>
                  ‚Ä¢ ÂïÜÂìÅ„Ç´„ÉÜ„Ç¥„É™Ë®≠ÂÆö<br>
                  ‚Ä¢ „É¨„Ç∑„Éº„ÉàË®≠ÂÆö<br>
                  ‚Ä¢ Âú®Â∫´Ë®≠ÂÆö<br>
                  ‚Ä¢ „Ç¢„É©„Éº„ÉàË®≠ÂÆö<br>
                  ‚Ä¢ Âñ∂Ê•≠ÊôÇÈñìË®≠ÂÆö<br>
                  ‚Ä¢ „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö<br><br>
                  Ë™§„Å£„Å¶ÂâäÈô§„Åó„ÅüÂ†¥Âêà„Å´Âæ©ÂÖÉ„Åß„Åç„Åæ„Åô„ÄÇ<br>
                  ÈÅéÂéª7Êó•ÂàÜ„ÅÆ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅåËá™Âãï‰øùÊåÅ„Åï„Çå„Åæ„Åô„ÄÇ
                </div>
              </div>
              
              <div style="background: #fff9e6; border-left: 4px solid #ff9800; padding: 14px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-weight: bold; color: #ff9800; margin-bottom: 6px; font-size: 14px;">„Äê„ÅÑ„ÅÑ„Åà„ÇíÈÅ∏Êäû„Åó„ÅüÂ†¥Âêà„Äë</div>
                <div style="color: #666; font-size: 13px;">„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Å™„Åó„ÅßÁ≤æÁÆó„ÇíÂÆüË°å„Åó„Åæ„Åô</div>
              </div>
              
              <div style="display: flex; gap: 12px; position: sticky; bottom: 0; background: white; padding: 10px 0 0 0;">
                <button id="backupNoBtn" style="
                  flex: 1; padding: 16px; font-size: 16px; font-weight: bold;
                  border: 2px solid #ddd; border-radius: 12px; cursor: pointer;
                  background: white; color: #666; transition: all 0.2s;
                " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                  „ÅÑ„ÅÑ„Åà
                </button>
                <button id="backupYesBtn" style="
                  flex: 1; padding: 16px; font-size: 16px; font-weight: bold;
                  border: none; border-radius: 12px; cursor: pointer;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                  transition: all 0.2s;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.5)'" 
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'">
                  „ÅØ„ÅÑÔºàÊé®Â•®Ôºâ
                </button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        const yesBtn = document.getElementById('backupYesBtn');
        const noBtn = document.getElementById('backupNoBtn');
        
        const handleYes = () => {
          playTapSound();
          yesBtn.removeEventListener('click', handleYes);
          noBtn.removeEventListener('click', handleNo);
          modal.remove();
          resolve(true);
        };
        
        const handleNo = () => {
          playTapSound();
          yesBtn.removeEventListener('click', handleYes);
          noBtn.removeEventListener('click', handleNo);
          modal.remove();
          resolve(false);
        };
        
        yesBtn.addEventListener('click', handleYes);
        noBtn.addEventListener('click', handleNo);
      });
      
      if (shouldBackup) {
        console.log(' „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê„Åó„Åæ„Åô');
        const backupSuccess = await window.createAutoBackup();
        if (!backupSuccess) {
          const continueAnyway = await showCustomAlert({
            title: '„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Ç®„É©„Éº',
            message: '„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n\n„Åù„Çå„Åß„ÇÇÁ≤æÁÆó„ÇíÁ∂ö„Åë„Åæ„Åô„ÅãÔºü',
            type: 'warning',
            confirmText: 'Á∂ö„Åë„Çã',
            cancelText: '„Ç≠„É£„É≥„Çª„É´'
          });
          if (!continueAnyway) {
            return;
          }
        } else {
          console.log('‚úÖ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ΩúÊàêÂÆå‰∫Ü - Á≤æÁÆó„ÇíÁ∂öË°å„Åó„Åæ„Åô');
        }
      } else {
        console.log('‚ö† „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶Á≤æÁÆó„ÇíÂÆüË°å„Åó„Åæ„Åô');
      }
      
      try {
        const settlementData = window.currentSettlementData;
        const dateStr = window.currentSettlementDate;
        
        if (!settlementData) {
          await showCustomAlert({
            title: '„Ç®„É©„Éº',
            message: 'Á≤æÁÆó„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì',
            type: 'error'
          });
          return;
        }
        
        console.log('üîç Á≤æÁÆó„Ç∏„É£„Éº„Éä„É´ÁîüÊàêÈñãÂßã');
        console.log('üìä settlementData:', settlementData);
        
        // ===== ÁèæÂú®ÊôÇÂàª„ÇíÂèñÂæó =====
        const now = new Date();
        const outputTime = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        
        // ===== ÊãÖÂΩìËÄÖ„ÇíÂèñÂæó =====
        const staffSelect = document.getElementById('staffSelect');
        const staffName = staffSelect.value || 'Êú™ÈÅ∏Êäû';
        
        // ===== dailySales„Åã„ÇâÂü∫Êú¨„Éá„Éº„Çø„ÇíÂèñÂæó =====
        const customerCount = settlementData.customerCount || 0;
        const totalItems = settlementData.totalItems || 0;
        const totalSales = settlementData.totalSales || 0;
        const averageSpend = customerCount > 0 ? Math.round(totalSales / customerCount) : 0;
        
        // ===== Â£≤‰∏äÂÜÖË®≥ =====
        const cashSales = settlementData.cashSales || 0;
        const emoneSales = settlementData.emoneSales || 0;
        const creditSales = settlementData.creditSales || 0;
        const discountTotal = settlementData.totalDiscount || 0;
        
        // ===== Á®éÈáëÂÜÖË®≥ÔºàÂÜÖÁ®éÔºâ =====
        const tax8TotalWithTax = settlementData.tax8Total || 0;  // 8%ÂïÜÂìÅÂêàË®àÔºàÁ®éËæºÔºâ
        const tax10TotalWithTax = settlementData.tax10Total || 0; // 10%ÂïÜÂìÅÂêàË®àÔºàÁ®éËæºÔºâ
        
        // Á®éÊäú‰æ°Ê†º„ÇíË®àÁÆóÔºàÂÜÖÁ®é„Å™„ÅÆ„ÅßÁ®éËæº‰æ°Ê†º„Åã„ÇâÈÄÜÁÆóÔºâ
        const tax8Excluded = Math.floor(tax8TotalWithTax / 1.08);  // 8%ÂïÜÂìÅÂêàË®àÔºàÁ®éÊäúÔºâ
        const tax10Excluded = Math.floor(tax10TotalWithTax / 1.10); // 10%ÂïÜÂìÅÂêàË®àÔºàÁ®éÊäúÔºâ
        
        // Ê∂àË≤ªÁ®éÈ°ç„ÇíË®àÁÆó
        const tax8Amount = tax8TotalWithTax - tax8Excluded;  // 8%„ÅÆÊ∂àË≤ªÁ®é
        const tax10Amount = tax10TotalWithTax - tax10Excluded; // 10%„ÅÆÊ∂àË≤ªÁ®é
        
        // ÂêàË®à
        const totalTax = tax8Amount + tax10Amount;  // Ê∂àË≤ªÁ®é„ÅÆÂêàË®à
        const taxExcludedTotal = tax8Excluded + tax10Excluded;  // Á®éÊäúÂêàË®à
        const taxIncludedTotal = tax8TotalWithTax + tax10TotalWithTax;  // Á®éËæºÂêàË®àÔºà8%„Å®10%„ÅÆÂêàË®àÔºâ
        
        // üÜï ÂÜÖÁ®é„ÉªÂ§ñÁ®é„ÅÆÂÜÖË®≥„ÇíÊ≥®Êñá„Éá„Éº„Çø„Åã„ÇâÈõÜË®à
        let tax8InclusiveTotal = 0;
        let tax10InclusiveTotal = 0;
        let tax8ExclusiveTotal = 0;
        let tax10ExclusiveTotal = 0;
        // üÜï Ëµ§‰ºùÁ•®„ÅÆÂÜÖÁ®é„ÉªÂ§ñÁ®é„ÅØdailySales„Åã„ÇâÂèñÂæó
        let redSlipTax8Inclusive = settlementData.redSlipTax8Inclusive || 0;
        let redSlipTax10Inclusive = settlementData.redSlipTax10Inclusive || 0;
        let redSlipTax8Exclusive = settlementData.redSlipTax8Exclusive || 0;
        let redSlipTax10Exclusive = settlementData.redSlipTax10Exclusive || 0;
        
        // dailySales„Å´‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØredSlips„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Åã„ÇâË®àÁÆóÔºàÂæåÊñπ‰∫íÊèõÊÄßÔºâ
        const needCalculateRedSlip = (redSlipTax8Inclusive === 0 && redSlipTax8Exclusive === 0 && 
                                      redSlipTax10Inclusive === 0 && redSlipTax10Exclusive === 0) &&
                                     (settlementData.redSlipCount > 0);
        
        try {
          const ordersQuery = window.query(
            window.getStoreCollection('orders'),
            window.where('paidAt', '!=', null)
          );
          const ordersSnapshot = await window.getDocs(ordersQuery);
          
          ordersSnapshot.forEach(doc => {
            const data = doc.data();
            if (!data.paidAt || !data.items) return;
            
            const orderDate = data.paidAt.toDate();
            const orderDateStr = window.getBusinessDay(orderDate).str;
            
            if (orderDateStr === dateStr) {
              data.items.forEach(item => {
                const taxType = item.taxType || 'inclusive';
                const taxAmount = getTaxAmount(item, item.quantity || 1);
                
                if ((item.taxRate || 10) === 8) {
                  if (taxType === 'exclusive') {
                    tax8ExclusiveTotal += taxAmount;
                  } else {
                    tax8InclusiveTotal += taxAmount;
                  }
                } else {
                  if (taxType === 'exclusive') {
                    tax10ExclusiveTotal += taxAmount;
                  } else {
                    tax10InclusiveTotal += taxAmount;
                  }
                }
              });
            }
          });
          
          // üÜï Ëµ§‰ºùÁ•®„ÅÆÂÜÖÁ®é„ÉªÂ§ñÁ®é„ÇíredSlips„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Åã„ÇâË®àÁÆóÔºàdailySales„Å´‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥ÂêàÔºâ
          if (needCalculateRedSlip) {
            console.log('‚ö†Ô∏è dailySales„Å´Ëµ§‰ºùÁ•®„ÅÆÂÜÖÁ®é„ÉªÂ§ñÁ®é„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åü„ÇÅ„ÄÅredSlips„Åã„ÇâË®àÁÆó„Åó„Åæ„Åô');
            try {
              const redSlipsSnapshot = await window.getDocs(window.getStoreCollection('redSlips'));
              redSlipsSnapshot.forEach(doc => {
                const data = doc.data();
                if (!data.businessDate || data.businessDate !== dateStr || !data.items) return;
                
                data.items.forEach(item => {
                  const taxType = item.taxType || 'inclusive';
                  const taxAmount = getTaxAmount(item, item.quantity || 1);
                  
                  if ((item.taxRate || 10) === 8) {
                    if (taxType === 'exclusive') {
                      redSlipTax8Exclusive += taxAmount;
                    } else {
                      redSlipTax8Inclusive += taxAmount;
                    }
                  } else {
                    if (taxType === 'exclusive') {
                      redSlipTax10Exclusive += taxAmount;
                    } else {
                      redSlipTax10Inclusive += taxAmount;
                    }
                  }
                });
              });
              console.log('‚úÖ redSlips„Åã„ÇâË®àÁÆóÂÆå‰∫Ü:', {
                redSlipTax8Inclusive,
                redSlipTax8Exclusive,
                redSlipTax10Inclusive,
                redSlipTax10Exclusive
              });
            } catch (e) {
              console.error('redSlipsÂèñÂæó„Ç®„É©„Éº:', e);
            }
          }
          
          console.log(' ÂÜÖÁ®é„ÉªÂ§ñÁ®é„ÅÆÂÜÖË®≥:', {
            tax8Inclusive: tax8InclusiveTotal,
            tax8Exclusive: tax8ExclusiveTotal,
            tax10Inclusive: tax10InclusiveTotal,
            tax10Exclusive: tax10ExclusiveTotal
          });
        } catch (e) {
          console.error('ÂÜÖÁ®é„ÉªÂ§ñÁ®éÈõÜË®à„Ç®„É©„Éº:', e);
        }
        
        // ===== „Éâ„É≠„Ç¢„Ç™„Éº„Éó„É≥Êï∞ =====
        const drawerOpenCount = settlementData.drawerOpenCount || 0;
        console.log('üîì Á≤æÁÆóÊôÇ„ÅÆdrawerOpenCount:', drawerOpenCount);
        console.log('üìä settlementDataÂÖ®‰Ωì:', settlementData);
        
        // ===== üÜï Ëµ§‰ºùÁ•®ÊÉÖÂ†±„ÇíÂèñÂæó =====
        let redSlipCount = settlementData.redSlipCount || 0;
        let redSlipAmount = settlementData.redSlipAmount || 0;
        let redSlipTax8Total = settlementData.redSlipTax8Total || 0;
        let redSlipTax10Total = settlementData.redSlipTax10Total || 0;
        
        // üî• dailySales„Å´Ëµ§‰ºùÁ•®„Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÄÅredSlips„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Åã„ÇâÁõ¥Êé•ÈõÜË®à
        if (redSlipCount === 0) {
          console.log('‚ö†Ô∏è dailySales„Å´Ëµ§‰ºùÁ•®„Éá„Éº„Çø„Åå„Å™„ÅÑ„Åü„ÇÅ„ÄÅredSlips„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Åã„ÇâÁõ¥Êé•ÈõÜË®à„Åó„Åæ„Åô');
          try {
            const redSlipsSnapshot = await window.getDocs(window.getStoreCollection('redSlips'));
            redSlipsSnapshot.forEach(doc => {
              const data = doc.data();
              if (!data.businessDate || data.businessDate !== dateStr) return;
              
              redSlipCount++;
              redSlipAmount += data.totalAmount || 0;
              
              if (data.items && Array.isArray(data.items)) {
                data.items.forEach(item => {
                  const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
                  const itemTaxRate = item.taxRate || (item.takeout ? 8 : 10);
                  
                  if (itemTaxRate === 8) {
                    redSlipTax8Total += itemTotal;
                  } else {
                    redSlipTax10Total += itemTotal;
                  }
                });
              }
            });
            console.log('‚úÖ redSlips„Åã„ÇâÈõÜË®àÂÆå‰∫Ü:', {
              redSlipCount,
              redSlipAmount,
              redSlipTax8Total,
              redSlipTax10Total
            });
          } catch (e) {
            console.error('redSlipsÈõÜË®à„Ç®„É©„Éº:', e);
          }
        }
        
        console.log('üî¥ Ëµ§‰ºùÁ•®‰ª∂Êï∞:', redSlipCount);
        console.log('üî¥ Ëµ§‰ºùÁ•®ÈáëÈ°ç:', redSlipAmount);
        console.log('üî¥ Ëµ§‰ºùÁ•®8%Á®éÈáë:', redSlipTax8Total);
        console.log('üî¥ Ëµ§‰ºùÁ•®10%Á®éÈáë:', redSlipTax10Total);
        
        // ===== ÊîØÂá∫„ÇíÂèñÂæó =====
        let expenseTotal = 0;
        try {
          const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
          if (expenseDoc.exists()) {
            expenseTotal = expenseDoc.data().total || 0;
            console.log('üí∏ ÊîØÂá∫:', expenseTotal);
          }
        } catch (e) {
          console.error('ÊîØÂá∫ÂèñÂæó„Ç®„É©„Éº:', e);
        }
        
        // ===== ‰∫∫‰ª∂Ë≤ª„ÇíÂèñÂæó =====
        let laborCost = 0;
        try {
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(docData => {
            const data = docData.data();
            if (data.date === dateStr) {
              // Êó¢„Å´Ë®àÁÆóÊ∏à„Åø„ÅÆÁ∑èË≥ÉÈáë„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®
              if (data.totalWage && data.totalWage > 0) {
                laborCost += data.totalWage;
              } else if (data.clockIn && data.clockOut) {
                // Á∑èË≥ÉÈáë„Åå„Å™„ÅÑÂ†¥Âêà„ÅØË®àÁÆó„Åô„Çã
                const clockIn = new Date(`${dateStr} ${data.clockIn}`);
                const clockOut = new Date(`${dateStr} ${data.clockOut}`);
                let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                
                // ‰ºëÊÜ©ÊôÇÈñì„ÇíÂºï„Åè
                if (data.breakStart1 && data.breakEnd1) {
                  const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                  const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                  workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                }
                if (data.breakStart2 && data.breakEnd2) {
                  const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                  const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                  workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                }
                
                const hourlyRate = data.hourlyRate || 1150;
                
                // Ââ≤Â¢óË≥ÉÈáë„ÅÆË®àÁÆó
                let totalWage = 0;
                const isHoliday = data.isHoliday || false;
                
                // ÊôÇÈñì„Åî„Å®„Å´Ââ≤Â¢óÁéá„ÇíË®àÁÆó
                let currentTime = new Date(clockIn);
                const endTime = new Date(clockOut);
                
                while (currentTime < endTime) {
                  const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                  const segmentEnd = nextHour > endTime ? endTime : nextHour;
                  
                  // ‰ºëÊÜ©ÊôÇÈñì„ÇíÈô§Â§ñ
                  let isBreak = false;
                  if (data.breakStart1 && data.breakEnd1) {
                    const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                    const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                    if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                      isBreak = true;
                    }
                  }
                  if (data.breakStart2 && data.breakEnd2) {
                    const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                    const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                    if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                      isBreak = true;
                    }
                  }
                  
                  if (!isBreak) {
                    const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                    const hour = currentTime.getHours();
                    
                    let rate = 1.0;
                    if (isHoliday) {
                      // ‰ºëÊó•Âá∫Âã§: Âü∫Êú¨35%Â¢ó
                      rate = 1.35;
                      // 22ÊôÇÔΩû5ÊôÇ„ÅØÊ∑±Â§úÂâ≤Â¢ó25%„ÇíËøΩÂä†ÔºàÂêàË®à60%Â¢óÔºâ
                      if (hour >= 22 || hour < 5) {
                        rate = 1.60;
                      }
                    } else {
                      // Âπ≥Êó•: 22ÊôÇÔΩû5ÊôÇ„ÅØÊ∑±Â§úÂâ≤Â¢ó25%
                      if (hour >= 22 || hour < 5) {
                        rate = 1.25;
                      }
                    }
                    
                    totalWage += segmentHours * hourlyRate * rate;
                  }
                  
                  currentTime = segmentEnd;
                }
                
                laborCost += totalWage;
              }
            }
          });
          console.log('üë∑ ‰∫∫‰ª∂Ë≤ª:', laborCost);
        } catch (e) {
          console.error('‰∫∫‰ª∂Ë≤ªÂèñÂæó„Ç®„É©„Éº:', e);
        }
        
        // ÂÄ§Âºï„Åç„ÉªÊîØÂá∫„ÇíÂºï„ÅÑ„ÅüÊúÄÁµÇÂêàË®àÂ£≤‰∏ä
        const finalTotalSales = taxIncludedTotal - discountTotal - expenseTotal;
        
        // ===== „Éá„Éê„ÉÉ„Ç∞„É≠„Ç∞ =====
        console.log('üìÖ Êó•‰ªò:', dateStr);
        console.log('üïê Âá∫ÂäõÊôÇÂàª:', outputTime);
        console.log('üë• ÂÆ¢Êï∞:', customerCount);
        console.log(' Á∑èÂ£≤‰∏äÁÇπÊï∞:', totalItems);
        console.log(' Âπ≥ÂùáÂÆ¢Âçò‰æ°:', averageSpend);
        console.log('üíµ ÂêàË®àÂ£≤‰∏ä:', totalSales);
        console.log('üí∏ ÂÄ§Âºï„Åç:', discountTotal);
        console.log('üè™ 8%ÂïÜÂìÅÔºàÁ®éËæºÔºâ:', tax8TotalWithTax);
        console.log('üè™ 8%ÂïÜÂìÅÔºàÁ®éÊäúÔºâ:', tax8Excluded);
        console.log('üè™ 8%Ê∂àË≤ªÁ®é:', tax8Amount);
        console.log('üè™ 10%ÂïÜÂìÅÔºàÁ®éËæºÔºâ:', tax10TotalWithTax);
        console.log('üè™ 10%ÂïÜÂìÅÔºàÁ®éÊäúÔºâ:', tax10Excluded);
        console.log('üè™ 10%Ê∂àË≤ªÁ®é:', tax10Amount);
        console.log('üîì „Éâ„É≠„Ç¢„Ç™„Éº„Éó„É≥Êï∞:', drawerOpenCount);
        console.log('üë§ ÊãÖÂΩìËÄÖ:', staffName);
        
        // ===== „Ç∏„É£„Éº„Éä„É´„ÉÜ„Ç≠„Çπ„Éà„ÇíÁîüÊàê =====
        const journalText = `
=====================================
      Á≤æÁÆó„Ç∏„É£„Éº„Éä„É´
=====================================
Âá∫ÂäõÊôÇÂàª: ${outputTime}
ÂÆ¢Êï∞: ${customerCount}ÁµÑ
Á∑èÂ£≤‰∏äÁÇπÊï∞: ${totalItems}ÁÇπ
Âπ≥ÂùáÂÆ¢Âçò‰æ°: ¬•${averageSpend.toLocaleString()}
ÂêàË®àÂ£≤‰∏ä: ¬•${totalSales.toLocaleString()}

-------------------------------------
Â£≤‰∏äÂÜÖË®≥
-------------------------------------
ÁèæÈáë: ¬•${cashSales.toLocaleString()}
ÈõªÂ≠ê„Éû„Éç„Éº: ¬•${emoneSales.toLocaleString()}
„ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„Éâ: ¬•${creditSales.toLocaleString()}
ÂÄ§Âºï„Åç: ¬•${discountTotal.toLocaleString()}

-------------------------------------
Á®éÈáëÂÜÖË®≥
-------------------------------------
8%„ÅÆÂïÜÂìÅÂêàË®àÔºàÁ®éÊäúÔºâ: ¬•${tax8Excluded.toLocaleString()}
8%„ÅÆÂïÜÂìÅÂêàË®àÔºàÁ®éËæºÔºâ: ¬•${tax8TotalWithTax.toLocaleString()}
8%„ÅÆÊ∂àË≤ªÁ®é: ¬•${tax8Amount.toLocaleString()}
  ÂÜÖÁ®é: ¬•${tax8InclusiveTotal.toLocaleString()}
  Â§ñÁ®é: ¬•${tax8ExclusiveTotal.toLocaleString()}

10%„ÅÆÂïÜÂìÅÂêàË®àÔºàÁ®éÊäúÔºâ: ¬•${tax10Excluded.toLocaleString()}
10%„ÅÆÂïÜÂìÅÂêàË®àÔºàÁ®éËæºÔºâ: ¬•${tax10TotalWithTax.toLocaleString()}
10%„ÅÆÊ∂àË≤ªÁ®é: ¬•${tax10Amount.toLocaleString()}
  ÂÜÖÁ®é: ¬•${tax10InclusiveTotal.toLocaleString()}
  Â§ñÁ®é: ¬•${tax10ExclusiveTotal.toLocaleString()}

Ê∂àË≤ªÁ®é„ÅÆÂêàË®à: ¬•${totalTax.toLocaleString()}
Á®éÊäúÂêàË®à: ¬•${taxExcludedTotal.toLocaleString()}
Á®éËæºÂêàË®à: ¬•${taxIncludedTotal.toLocaleString()}

ÊîØÂá∫: ¬•${expenseTotal.toLocaleString()}
ÂêàË®àÂ£≤‰∏ä: ¬•${(taxIncludedTotal - expenseTotal).toLocaleString()}
${redSlipCount > 0 ? `
-------------------------------------
Ëµ§‰ºùÁ•®„ÅÆÁ®éÈáëÂÜÖË®≥
-------------------------------------
8%„ÅÆËµ§‰ºùÁ•®ÔºàÁ®éÊäúÔºâ: -¬•${Math.floor(redSlipTax8Total / 1.08).toLocaleString()}
8%„ÅÆËµ§‰ºùÁ•®ÔºàÁ®éËæºÔºâ: -¬•${redSlipTax8Total.toLocaleString()}
8%„ÅÆËµ§‰ºùÁ•®„ÅÆÊ∂àË≤ªÁ®é: -¬•${(redSlipTax8Total - Math.floor(redSlipTax8Total / 1.08)).toLocaleString()}
  ÂÜÖÁ®é: -¬•${redSlipTax8Inclusive.toLocaleString()}
  Â§ñÁ®é: -¬•${redSlipTax8Exclusive.toLocaleString()}

10%„ÅÆËµ§‰ºùÁ•®ÔºàÁ®éÊäúÔºâ: -¬•${Math.floor(redSlipTax10Total / 1.10).toLocaleString()}
10%„ÅÆËµ§‰ºùÁ•®ÔºàÁ®éËæºÔºâ: -¬•${redSlipTax10Total.toLocaleString()}
10%„ÅÆËµ§‰ºùÁ•®„ÅÆÊ∂àË≤ªÁ®é: -¬•${(redSlipTax10Total - Math.floor(redSlipTax10Total / 1.10)).toLocaleString()}
  ÂÜÖÁ®é: -¬•${redSlipTax10Inclusive.toLocaleString()}
  Â§ñÁ®é: -¬•${redSlipTax10Exclusive.toLocaleString()}

Ëµ§‰ºùÁ•®Ê∂àË≤ªÁ®é„ÅÆÂêàË®à: -¬•${((redSlipTax8Total - Math.floor(redSlipTax8Total / 1.08)) + (redSlipTax10Total - Math.floor(redSlipTax10Total / 1.10))).toLocaleString()}
Ëµ§‰ºùÁ•®Á®éÊäúÂêàË®à: -¬•${(Math.floor(redSlipTax8Total / 1.08) + Math.floor(redSlipTax10Total / 1.10)).toLocaleString()}
Ëµ§‰ºùÁ•®Á®éËæºÂêàË®à: -¬•${(redSlipTax8Total + redSlipTax10Total).toLocaleString()}
` : ''}

-------------------------------------
„Åù„ÅÆ‰ªñ
-------------------------------------
„Éâ„É≠„Ç¢„Ç™„Éº„Éó„É≥Êï∞: ${drawerOpenCount}Âõû
Ëµ§‰ºùÁ•®‰ª∂Êï∞: ${redSlipCount}‰ª∂
Ëµ§‰ºùÁ•®ÈáëÈ°ç: ¬•${redSlipAmount.toLocaleString()}
‰∫∫‰ª∂Ë≤ª: ¬•${Math.round(laborCost).toLocaleString()}
ÊãÖÂΩìËÄÖ: ${staffName}

=====================================
`;
        
        // ===== HTMLË¶ÅÁ¥†„Çí‰ΩúÊàê„Åó„Å¶PNGÁîªÂÉè„Å®„Åó„Å¶‰øùÂ≠ò =====
        const journalDiv = document.createElement('div');
        journalDiv.style.cssText = `
          font-family: 'Courier New', monospace;
          font-size: 14px;
          line-height: 1.6;
          padding: 30px;
          background: white;
          color: black;
          white-space: pre-wrap;
          width: 800px;
          position: absolute;
          left: -9999px;
        `;
        
        // HTML„Å®„Åó„Å¶ÁîüÊàê„Åó„ÄÅÊîØÂá∫„Å®ÂêàË®àÂ£≤‰∏ä„ÇíËµ§Ëâ≤„Å´„Åô„Çã
        journalDiv.innerHTML = journalText
          .replace(/^(ÊîØÂá∫: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>')
          .replace(/^(ÂêàË®àÂ£≤‰∏ä: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>');
        
        document.body.appendChild(journalDiv);
        
        // html2canvas„ÅßÁîªÂÉèÂåñ
        const canvas = await html2canvas(journalDiv, {
          scale: 2,
          backgroundColor: '#ffffff',
          logging: false
        });
        
        // PNGÁîªÂÉè„Å®„Åó„Å¶„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `Á≤æÁÆó„Ç∏„É£„Éº„Éä„É´_${dateStr}.png`;
          link.click();
          URL.revokeObjectURL(url);
          document.body.removeChild(journalDiv);
        });
        
        // ===== Á≤æÁÆóË®òÈå≤„ÇíFirebase„Å´‰øùÂ≠ò =====
        await window.addDoc(window.getStoreCollection('settlements'), {
          date: dateStr,
          outputTime: outputTime,
          timestamp: window.Timestamp.now(),
          customerCount: customerCount,
          totalItems: totalItems,
          averageSpend: averageSpend,
          totalSales: totalSales,
          cashSales: cashSales,
          emoneSales: emoneSales,
          creditSales: creditSales,
          discountTotal: discountTotal,
          tax8TotalWithTax: tax8TotalWithTax,
          tax8Excluded: tax8Excluded,
          tax8Amount: tax8Amount,
          tax10TotalWithTax: tax10TotalWithTax,
          tax10Excluded: tax10Excluded,
          tax10Amount: tax10Amount,
          totalTax: totalTax,
          taxExcludedTotal: taxExcludedTotal,
          taxIncludedTotal: taxIncludedTotal,
          drawerOpenCount: drawerOpenCount,
          redSlipCount: redSlipCount,  // üÜï Ëµ§‰ºùÁ•®‰ª∂Êï∞
          redSlipAmount: redSlipAmount,  // üÜï Ëµ§‰ºùÁ•®ÈáëÈ°ç
          redSlipTax8Total: redSlipTax8Total,  // üÜï Ëµ§‰ºùÁ•®8%Á®éÈáë
          redSlipTax10Total: redSlipTax10Total,  // üÜï Ëµ§‰ºùÁ•®10%Á®éÈáë
          staffName: staffName,
          aiComment: ""
        });
        
        console.log('‚úÖ Á≤æÁÆó„Ç∏„É£„Éº„Éä„É´ÁîüÊàêÂÆå‰∫Ü');
        closeSettlementModal();
        
      } catch (e) {
        console.error('‚ùå Á≤æÁÆó„Ç®„É©„Éº:', e);
        await showCustomAlert({
          title: '„Ç®„É©„Éº',
          message: 'Á≤æÁÆó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message,
          type: 'error'
        });
      }
    };
    
    // Á≤æÁÆó„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    window.closeSettlementModal = function() {
      document.getElementById('settlementModal').classList.add('hidden');
    };
    
    // ===== ÊîØÂá∫Ê©üËÉΩ =====
    let expenseRows = [];
    let currentExpenseDate = null;
    
    // ÊîØÂá∫„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
    window.showExpenseModal = async function() {
      const now = new Date();
      // JST 3:00„Çí„Ç®„Éù„ÉÉ„ÇØ„Éü„É™Áßí„ÅßÊ≠£Á¢∫„Å´Ë®àÁÆóÔºàsetHours„ÅØ„É≠„Éº„Ç´„É´„Çø„Ç§„É†‰æùÂ≠ò„ÅÆ„Åü„ÇÅ‰ΩøÁî®„Åó„Å™„ÅÑÔºâ
      const jstOffsetMs = 9 * 60 * 60 * 1000;
      const jstNowMs = now.getTime() + jstOffsetMs;
      const jstMidnightMs = jstNowMs - (jstNowMs % (24 * 60 * 60 * 1000));
      let todayStart = new Date(jstMidnightMs + (3 * 60 * 60 * 1000) - jstOffsetMs);
      if (now < todayStart) todayStart = new Date(todayStart.getTime() - 24 * 60 * 60 * 1000);
      const jstTodayStart = new Date(todayStart.getTime() + jstOffsetMs);
      
      const year = jstTodayStart.getUTCFullYear();
      const month = String(jstTodayStart.getUTCMonth() + 1).padStart(2, '0');
      const day = String(jstTodayStart.getUTCDate()).padStart(2, '0');
      currentExpenseDate = `${year}-${month}-${day}`;
      
      // Êó•‰ªòÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Å´Êú¨Êó•„ÅÆÊó•‰ªò„ÇíË®≠ÂÆö
      document.getElementById('expenseDateInput').value = currentExpenseDate;
      
      console.log('üìÖ ÊîØÂá∫„É¢„Éº„ÉÄ„É´Ë°®Á§∫ - Êú¨Êó•„ÅÆÊó•‰ªò:', currentExpenseDate);
      console.log('üìÖ ÁèæÂú®ÊôÇÂàª(JST):', jstNow.toLocaleString('ja-JP'));
      
      // Firebase„Åã„ÇâÊú¨Êó•„ÅÆÊîØÂá∫„Éá„Éº„Çø„ÇíÂèñÂæó
      await loadExpensesByDate();
      
      document.getElementById('expenseModal').classList.remove('hidden');
    };
    
    // Êó•‰ªòÂ§âÊõ¥ÊôÇ„Å´„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„ÇÄ
    window.loadExpensesByDate = async function() {
      const selectedDate = document.getElementById('expenseDateInput').value;
      if (!selectedDate) {
        console.warn('‚ö† Êó•‰ªò„ÅåÈÅ∏Êäû„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
        return;
      }
      
      currentExpenseDate = selectedDate;
      console.log('üìÖ Êó•‰ªòÂ§âÊõ¥ - ÈÅ∏Êäû„Åï„Çå„ÅüÊó•‰ªò:', currentExpenseDate);
      
      try {
        const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', currentExpenseDate));
        
        if (expenseDoc.exists()) {
          const data = expenseDoc.data();
          expenseRows = data.items || [];
          console.log('‚úÖ Êó¢Â≠ò„ÅÆÊîØÂá∫„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø:', currentExpenseDate, '‰ª∂Êï∞:', expenseRows.length);
          console.log('„Éá„Éº„ÇøÂÜÖÂÆπ:', expenseRows);
        } else {
          // Êñ∞Ë¶è„ÅÆÂ†¥Âêà„ÅØÂàùÊúüË°å„ÇíËøΩÂä†
          console.log('üìù Êñ∞Ë¶è‰ΩúÊàê:', currentExpenseDate);
          expenseRows = [
            { storeName: '', category: '', detail: '', amount: 0 },
            { storeName: '', category: '', detail: '', amount: 0 },
            { storeName: '', category: '', detail: '', amount: 0 }
          ];
        }
      } catch (e) {
        console.error('‚ùå ÊîØÂá∫„Éá„Éº„ÇøË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
        expenseRows = [
          { storeName: '', category: '', detail: '', amount: 0 },
          { storeName: '', category: '', detail: '', amount: 0 },
          { storeName: '', category: '', detail: '', amount: 0 }
        ];
      }
      
      renderExpenseTable();
    };
    
    // ÊîØÂá∫„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    window.closeExpenseModal = function() {
      document.getElementById('expenseModal').classList.add('hidden');
      
      // URL„Éë„É©„É°„Éº„Çø„Åß„É¢„Éº„ÉÄ„É´„ÇíÈñã„ÅÑ„ÅüÂ†¥Âêà„ÅØ„Çø„Éñ„ÇíÈñâ„Åò„Çã
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('modal') === 'expense') {
        window.close();
      }
    };
    
    // ÊîØÂá∫Ë°å„ÇíËøΩÂä†
    window.addExpenseRow = function() {
      expenseRows.push({
        storeName: '',
        category: '',
        detail: '',
        amount: 0
      });
      renderExpenseTable();
    };
    
    // ÊîØÂá∫Ë°å„ÇíÂâäÈô§
    window.deleteExpenseRow = function(index) {
      expenseRows.splice(index, 1);
      renderExpenseTable();
    };
    
    // ÊîØÂá∫„ÉÜ„Éº„Éñ„É´„ÇíÊèèÁîª
    // ÂãòÂÆöÁßëÁõÆ„Å®Á®éÁéá„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞
    const categoryTaxRates = {
      'ÊùêÊñôË≤ª': 8,
      'È£üË≤ª': 8,
      'Êé•ÂæÖ‰∫§ÈöõË≤ª': 8,
      'ÁßüÁ®éÂÖ¨Ë™≤': 8,
      'Êó•Áî®ÂìÅ': 10,
      'ÈõëË≤ª„ÉªÈõëÂìÅ': 10,
      'Ê∞¥ÂÖâÁÜ±Ë≤ª': 10,
      '‰∫§ÈÄöË≤ª10%': 10,
      '„Åù„ÅÆ‰ªñ': 10
    };
    
    function renderExpenseTable() {
      const tbody = document.getElementById('expenseTableBody');
      tbody.innerHTML = '';
      
      expenseRows.forEach((row, index) => {
        const taxRate = categoryTaxRates[row.category] || 10;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding: 8px; border: 1px solid #ddd;">
            <input type="text" value="${row.storeName}" onchange="playTapSound(); updateExpenseRow(${index}, 'storeName', this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <select onchange="playTapSound(); updateExpenseRow(${index}, 'category', this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">ÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ</option>
              <option value="ÊùêÊñôË≤ª" ${row.category === 'ÊùêÊñôË≤ª' ? 'selected' : ''}>ÊùêÊñôË≤ªÔºà8%Ôºâ</option>
              <option value="Êó•Áî®ÂìÅ" ${row.category === 'Êó•Áî®ÂìÅ' ? 'selected' : ''}>Êó•Áî®ÂìÅÔºà10%Ôºâ</option>
              <option value="ÈõëË≤ª„ÉªÈõëÂìÅ" ${row.category === 'ÈõëË≤ª„ÉªÈõëÂìÅ' ? 'selected' : ''}>ÈõëË≤ª„ÉªÈõëÂìÅÔºà10%Ôºâ</option>
              <option value="È£üË≤ª" ${row.category === 'È£üË≤ª' ? 'selected' : ''}>È£üË≤ªÔºà8%Ôºâ</option>
              <option value="Êé•ÂæÖ‰∫§ÈöõË≤ª" ${row.category === 'Êé•ÂæÖ‰∫§ÈöõË≤ª' ? 'selected' : ''}>Êé•ÂæÖ‰∫§ÈöõË≤ªÔºà8%Ôºâ</option>
              <option value="Ê∞¥ÂÖâÁÜ±Ë≤ª" ${row.category === 'Ê∞¥ÂÖâÁÜ±Ë≤ª' ? 'selected' : ''}>Ê∞¥ÂÖâÁÜ±Ë≤ªÔºà10%Ôºâ</option>
              <option value="ÁßüÁ®éÂÖ¨Ë™≤" ${row.category === 'ÁßüÁ®éÂÖ¨Ë™≤' ? 'selected' : ''}>ÁßüÁ®éÂÖ¨Ë™≤</option>
              <option value="‰∫§ÈÄöË≤ª10%" ${row.category === '‰∫§ÈÄöË≤ª10%' ? 'selected' : ''}>‰∫§ÈÄöË≤ªÔºà10%Ôºâ</option>
              <option value="„Åù„ÅÆ‰ªñ" ${row.category === '„Åù„ÅÆ‰ªñ' ? 'selected' : ''}>„Åù„ÅÆ‰ªñÔºà10%Ôºâ</option>
            </select>
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <input type="text" value="${row.detail}" onchange="playTapSound(); updateExpenseRow(${index}, 'detail', this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <input type="number" value="${row.amount}" onchange="playTapSound(); updateExpenseRow(${index}, 'amount', parseFloat(this.value) || 0)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
            <button onclick="playTapSound(); deleteExpenseRow(${index})" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">ÂâäÈô§</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      updateExpenseTotal();
    }
    
    // ÊîØÂá∫Ë°å„ÇíÊõ¥Êñ∞
    window.updateExpenseRow = function(index, field, value) {
      expenseRows[index][field] = value;
      
      // ÁßüÁ®éÂÖ¨Ë™≤„ÇíÈÅ∏Êäû„Åó„ÅüÂ†¥Âêà„ÄÅË©≥Á¥∞„Çí„ÄåËªΩÊ≤πÂºïÂèñÁ®é„Äç„Å´Ë®≠ÂÆö
      if (field === 'category' && value === 'ÁßüÁ®éÂÖ¨Ë™≤') {
        expenseRows[index]['detail'] = 'ËªΩÊ≤πÂºïÂèñÁ®é';
      }
      
      updateExpenseTotal();
      renderExpenseTable(); // „ÉÜ„Éº„Éñ„É´„ÇíÂÜçÊèèÁîª
    };
    
    // ÊîØÂá∫ÂêàË®à„ÇíÊõ¥Êñ∞
    function updateExpenseTotal() {
      const total = expenseRows.reduce((sum, row) => sum + (parseFloat(row.amount) || 0), 0);
      document.getElementById('expenseTotal').textContent = total.toLocaleString();
    }
    
    // ÊîØÂá∫„Çí‰øùÂ≠ò
    window.saveExpenses = async function() {
      try {
        console.log(' ÊîØÂá∫„Çí‰øùÂ≠ò‰∏≠ - Êó•‰ªò:', currentExpenseDate);
        console.log(' ‰øùÂ≠ò„Éá„Éº„Çø:', expenseRows);
        
        // Á©∫Ë°å„ÇíÈô§Â§ñ
        const validRows = expenseRows.filter(row => 
          row.storeName || row.category || row.detail || row.amount
        );
        
        const total = validRows.reduce((sum, row) => sum + (parseFloat(row.amount) || 0), 0);
        
        const currentStaff = document.getElementById('staffSelect')?.value || 'POSÂÖ•Âäõ';
        
        await window.setDoc(window.getStoreDoc('expenses', currentExpenseDate), {
          date: currentExpenseDate,
          staff: currentStaff,
          items: validRows,
          total: total,
          updatedAt: window.Timestamp.now()
        });
        
        console.log('‚úÖ ÊîØÂá∫‰øùÂ≠òÂÆå‰∫Ü - Êó•‰ªò:', currentExpenseDate, '‰ª∂Êï∞:', validRows.length, 'ÂêàË®à:', total);
        await showCustomAlert({
          title: '‰øùÂ≠òÂÆå‰∫Ü',
          message: `ÊîØÂá∫„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü
Êó•‰ªò: ${currentExpenseDate}
‰ª∂Êï∞: ${validRows.length}‰ª∂
ÂêàË®à: ¬•${total.toLocaleString()}`,
          type: 'success'
        });
        closeExpenseModal();
        
      } catch (e) {
        console.error('‚ùå ÊîØÂá∫‰øùÂ≠ò„Ç®„É©„Éº:', e);
        await showCustomAlert({
          title: '„Ç®„É©„Éº',
          message: 'ÊîØÂá∫„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message,
          type: 'error'
        });
      }
    };
    
    // ÊîØÂá∫„ÇíExcelÂΩ¢Âºè„ÅßÂá∫ÂäõÔºàkeihi.html„Å®Âêå„ÅòÂΩ¢ÂºèÔºâ
    window.exportExpensesToCSV = async function() {
      try {
        console.log('üìÑ ÊîØÂá∫ExcelÂá∫ÂäõÈñãÂßã');
        
        if (expenseRows.length === 0) {
          await showCustomAlert({
            title: 'Ë≠¶Âëä',
            message: 'Âá∫Âäõ„Åô„ÇãÊîØÂá∫„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
            type: 'warning'
          });
          return;
        }
        
        // ÂãòÂÆöÁßëÁõÆ„Å®Á®éÁéá„ÅÆ„Éû„ÉÉ„Éî„É≥„Ç∞
        const categoryTaxRates = {
          'ÊùêÊñôË≤ª': 8,
          'È£üË≤ª': 8,
          'Êé•ÂæÖ‰∫§ÈöõË≤ª': 8,
          'ÁßüÁ®éÂÖ¨Ë™≤': 8,
          'Êó•Áî®ÂìÅ': 10,
          'ÈõëË≤ª„ÉªÈõëÂìÅ': 10,
          'Ê∞¥ÂÖâÁÜ±Ë≤ª': 10,
          '‰∫§ÈÄöË≤ª10%': 10,
          '„Åù„ÅÆ‰ªñ': 10
        };
        
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        
        // Excel„Éá„Éº„Çø‰ΩúÊàê
        const excelData = [];
        
        // „Éò„ÉÉ„ÉÄ„Éº
        excelData.push(['ÁµåË≤ªÊòéÁ¥∞Êõ∏', '', '', '', '']);
        excelData.push([`${year}Âπ¥${month}Êúà`, '', '', '', '']);
        excelData.push(['Âá∫ÂäõÊó•ÊôÇ:', new Date().toLocaleString('ja-JP'), '', '', '']);
        excelData.push(['', '', '', '', '']);
        
        // 8%Âå∫ÂàÜ
        excelData.push(['„Äê8%Âå∫ÂàÜ„Äë', '', '', '', '']);
        excelData.push(['Êó•‰ªò', 'Â∫óÂêç', 'ÂãòÂÆöÁßëÁõÆ', 'Ë©≥Á¥∞', 'ÈáëÈ°ç']);
        
        const tax8Items = expenseRows.filter(e => 
          e.category === 'ÊùêÊñôË≤ª' || e.category === 'È£üË≤ª' || e.category === 'Êé•ÂæÖ‰∫§ÈöõË≤ª'
        );
        let tax8Total = 0;
        
        tax8Items.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax8Total += item.amount;
        });
        
        excelData.push(['', '', '', '8%ÂêàË®à:', tax8Total]);
        excelData.push(['', '', '', '', '']);
        
        // 10%Âå∫ÂàÜ
        excelData.push(['„Äê10%Âå∫ÂàÜ„Äë', '', '', '', '']);
        excelData.push(['Êó•‰ªò', 'Â∫óÂêç', 'ÂãòÂÆöÁßëÁõÆ', 'Ë©≥Á¥∞', 'ÈáëÈ°ç']);
        
        const tax10Items = expenseRows.filter(e => 
          e.category === 'Êó•Áî®ÂìÅ' || e.category === 'ÈõëË≤ª„ÉªÈõëÂìÅ' || 
          e.category === 'Ê∞¥ÂÖâÁÜ±Ë≤ª' || e.category === '„Åù„ÅÆ‰ªñ'
        );
        let tax10Total = 0;
        
        tax10Items.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax10Total += item.amount;
        });
        
        excelData.push(['', '', '', '10%ÂêàË®à:', tax10Total]);
        excelData.push(['', '', '', '', '']);
        
        // ÁßüÁ®éÂÖ¨Ë™≤Âå∫ÂàÜ
        excelData.push(['„ÄêÁßüÁ®éÂÖ¨Ë™≤Âå∫ÂàÜ„Äë', '', '', '', '']);
        excelData.push(['Êó•‰ªò', 'Â∫óÂêç', 'ÂãòÂÆöÁßëÁõÆ', 'Ë©≥Á¥∞', 'ÈáëÈ°ç']);
        
        const sozeikokaItems = expenseRows.filter(e => e.category === 'ÁßüÁ®éÂÖ¨Ë™≤');
        let sozeikokaTotal = 0;
        
        sozeikokaItems.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          sozeikokaTotal += item.amount;
        });
        
        excelData.push(['', '', '', 'ÁßüÁ®éÂÖ¨Ë™≤ÂêàË®à:', sozeikokaTotal]);
        excelData.push(['', '', '', '', '']);
        
        // ‰∫§ÈÄöË≤ªÔºà10%ÔºâÂå∫ÂàÜ
        excelData.push(['„Äê‰∫§ÈÄöË≤ªÔºà10%ÔºâÂå∫ÂàÜ„Äë', '', '', '', '']);
        excelData.push(['Êó•‰ªò', 'Â∫óÂêç', 'ÂãòÂÆöÁßëÁõÆ', 'Ë©≥Á¥∞', 'ÈáëÈ°ç']);
        
        const transport10Items = expenseRows.filter(e => e.category === '‰∫§ÈÄöË≤ª10%');
        let transport10Total = 0;
        
        transport10Items.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          transport10Total += item.amount;
        });
        
        excelData.push(['', '', '', '‰∫§ÈÄöË≤ªÔºà10%ÔºâÂêàË®à:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        
        // Á∑èÂêàË®à
        const grandTotal = tax8Total + tax10Total + sozeikokaTotal + transport10Total;
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', '8%ÂêàË®àÈáëÈ°ç:', tax8Total]);
        excelData.push(['', '', '', '10%ÂêàË®àÈáëÈ°ç:', tax10Total]);
        excelData.push(['', '', '', 'ÁßüÁ®éÂÖ¨Ë™≤ÂêàË®àÈáëÈ°ç:', sozeikokaTotal]);
        excelData.push(['', '', '', '‰∫§ÈÄöË≤ªÔºà10%ÔºâÂêàË®àÈáëÈ°ç:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', 'ÂêàË®à:', grandTotal]);
        
        // SheetJS„ÅßExcelÁîüÊàê
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // ÂàóÂπÖË®≠ÂÆö
        ws['!cols'] = [
          { wch: 10 },  // Êó•‰ªò
          { wch: 15 },  // Â∫óÂêç
          { wch: 15 },  // ÂãòÂÆöÁßëÁõÆ
          { wch: 25 },  // Ë©≥Á¥∞
          { wch: 12 }   // ÈáëÈ°ç
        ];
        
        // ÁΩ´Á∑ö„Å®„Çπ„Çø„Ç§„É´Ë®≠ÂÆö
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        for (let R = range.s.r; R <= range.e.r; R++) {
          for (let C = range.s.c; C <= range.e.c; C++) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            
            if (!ws[cellAddress]) {
              ws[cellAddress] = { t: 's', v: '' };
            }
            
            if (!ws[cellAddress].s) {
              ws[cellAddress].s = {};
            }
            
            // ÁΩ´Á∑ö
            ws[cellAddress].s.border = {
              top: { style: 'thin', color: { rgb: '000000' } },
              bottom: { style: 'thin', color: { rgb: '000000' } },
              left: { style: 'thin', color: { rgb: '000000' } },
              right: { style: 'thin', color: { rgb: '000000' } }
            };
            
            // „Éò„ÉÉ„ÉÄ„ÉºË°å„ÅÆ„Çπ„Çø„Ç§„É´
            if (R === 0 || (excelData[R] && excelData[R][0] && excelData[R][0].includes('„Äê'))) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'D3D3D3' }
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
            }
            
            // ÂêàË®àË°å„ÅÆ„Çπ„Çø„Ç§„É´Ôºà8%„ÄÅ10%„ÄÅ‰∫§ÈÄöË≤ª„ÅÆÂêÑÂå∫ÂàÜÔºâ
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%ÂêàË®à:' || excelData[R][3] === '10%ÂêàË®à:' || 
                 excelData[R][3] === 'ÁßüÁ®éÂÖ¨Ë™≤ÂêàË®à:' || excelData[R][3] === '‰∫§ÈÄöË≤ªÔºà10%ÔºâÂêàË®à:')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFE599' }  // ËñÑ„ÅÑÈªÑËâ≤
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
              // ÈáëÈ°çÂàó„ÅØÂè≥ÂØÑ„Åõ
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // ÊúÄÁµÇÂêàË®àË°å„ÅÆ„Çπ„Çø„Ç§„É´Ôºà8%ÂêàË®àÈáëÈ°ç„ÄÅ10%ÂêàË®àÈáëÈ°ç„ÄÅ‰∫§ÈÄöË≤ªÂêàË®àÈáëÈ°ç„ÄÅÂêàË®àÔºâ
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%ÂêàË®àÈáëÈ°ç:' || excelData[R][3] === '10%ÂêàË®àÈáëÈ°ç:' || 
                 excelData[R][3] === 'ÁßüÁ®éÂÖ¨Ë™≤ÂêàË®àÈáëÈ°ç:' || excelData[R][3] === '‰∫§ÈÄöË≤ªÔºà10%ÔºâÂêàË®àÈáëÈ°ç:' ||
                 excelData[R][3] === 'ÂêàË®à:')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFC7CE' }  // ËñÑ„ÅÑ„Éî„É≥„ÇØ
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
              // ÈáëÈ°çÂàó„ÅØÂè≥ÂØÑ„Åõ
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // „ÄåÂêàË®à:„ÄçË°å„ÅØÁâπ„Å´Âº∑Ë™ø
            if (excelData[R] && excelData[R][3] === 'ÂêàË®à:') {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFB6C1' }  // ÊøÉ„ÅÑ„Éî„É≥„ÇØ
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 14,
                color: { rgb: 'FF0000' }  // Ëµ§ÊñáÂ≠ó
              };
            }
          }
        }
        
        XLSX.utils.book_append_sheet(wb, ws, 'ÁµåË≤ªÊòéÁ¥∞');
        
        const fileName = `ÁµåË≤ªÊòéÁ¥∞_${year}Âπ¥${month}Êúà.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        console.log('‚úÖ ÁµåË≤ªExcelÂá∫ÂäõÂÆå‰∫Ü:', fileName);
        await showCustomAlert({
          title: 'Âá∫ÂäõÂÆå‰∫Ü',
          message: `ÁµåË≤ª„ÇíÂá∫Âäõ„Åó„Åæ„Åó„ÅüÔºÅ
${fileName}`,
          type: 'success'
        });
        
      } catch (e) {
        console.error('‚ùå ÁµåË≤ªÂá∫Âäõ„Ç®„É©„Éº:', e);
        await showCustomAlert({
          title: '„Ç®„É©„Éº',
          message: 'ÁµåË≤ª„ÅÆÂá∫Âäõ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message,
          type: 'error'
        });
      }
    };
    
    // ===== ÊúàÊ¨°ÁµåË≤ªÂá∫ÂäõÊ©üËÉΩÔºà1Êó•„Åã„Çâ„ÅÆÈõÜË®àÔºâ =====
    window.exportMonthlyExpenses = async function(year = null, month = null) {
      try {
        console.log('üìä ÊúàÊ¨°ÁµåË≤ªÂá∫ÂäõÈñãÂßã');
        
        // „Éá„Éï„Ç©„É´„ÉàÂÄ§„ÇíË®≠ÂÆöÔºàÂºïÊï∞„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÂΩìÊúàÔºâ
        if (!year || !month) {
          const now = new Date();
          // JST 3:00„Çí„Ç®„Éù„ÉÉ„ÇØ„Éü„É™Áßí„ÅßÊ≠£Á¢∫„Å´Ë®àÁÆó
          const jstOffsetMs = 9 * 60 * 60 * 1000;
          const jstNowMs = now.getTime() + jstOffsetMs;
          const jstMidnightMs = jstNowMs - (jstNowMs % (24 * 60 * 60 * 1000));
          let todayStart = new Date(jstMidnightMs + (3 * 60 * 60 * 1000) - jstOffsetMs);
          if (now < todayStart) todayStart = new Date(todayStart.getTime() - 24 * 60 * 60 * 1000);
          const jstTodayStart = new Date(todayStart.getTime() + jstOffsetMs);
          
          year = jstTodayStart.getUTCFullYear();
          month = jstTodayStart.getUTCMonth() + 1;
        }
        
        console.log(`üìä ÁµåË≤ªÂá∫Âäõ: ${year}Âπ¥${month}Êúà`);
        
        // Êúà„ÅÆÂÖ®„Éá„Éº„Çø„ÇíÂèñÂæó
        const expensesSnapshot = await window.getDocs(window.getStoreCollection('expenses'));
        
        const monthlyExpenses = [];
        expensesSnapshot.forEach(doc => {
          const data = doc.data();
          const date = data.date;
          
          // ÁèæÂú®„ÅÆÊúà„ÅÆ„Éá„Éº„Çø„ÅÆ„Åø
          if (date && date.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
            if (data.items && Array.isArray(data.items)) {
              data.items.forEach(item => {
                monthlyExpenses.push({
                  date: date,
                  staff: data.staff || '‰∏çÊòé',
                  storeName: item.storeName,
                  category: item.category,
                  detail: item.detail,
                  amount: item.amount
                });
              });
            }
          }
        });
        
        // Êó•‰ªòÈ†Ü„Å´„ÇΩ„Éº„Éà
        monthlyExpenses.sort((a, b) => a.date.localeCompare(b.date));
        
        console.log('ÂèñÂæó„Åó„Åü„Éá„Éº„Çø:', monthlyExpenses.length, '‰ª∂');
        
        if (monthlyExpenses.length === 0) {
          await showCustomAlert({
            title: 'Ë≠¶Âëä',
            message: 'Âá∫Âäõ„Åô„ÇãÁµåË≤ª„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì',
            type: 'warning'
          });
          return;
        }
        
        // Excel„Éá„Éº„Çø‰ΩúÊàê
        const excelData = [];
        
        // „Éò„ÉÉ„ÉÄ„Éº
        excelData.push(['ÁµåË≤ªÊòéÁ¥∞Êõ∏', '', '', '', '', '']);
        excelData.push([`${year}Âπ¥${month}Êúà`, '', '', '', '', '']);
        excelData.push(['Âá∫ÂäõÊó•ÊôÇ:', new Date().toLocaleString('ja-JP'), '', '', '', '']);
        excelData.push(['', '', '', '', '', '']);
        
        // 8%Âå∫ÂàÜ
        excelData.push(['„Äê8%Âå∫ÂàÜ„Äë', '', '', '', '', '']);
        excelData.push(['Êó•‰ªò', 'Â∫óÂêç', 'ÂãòÂÆöÁßëÁõÆ', 'Ë©≥Á¥∞', 'ÈáëÈ°ç']);
        
        const tax8Items = monthlyExpenses.filter(e => 
          e.category === 'ÊùêÊñôË≤ª' || e.category === 'È£üË≤ª' || e.category === 'Êé•ÂæÖ‰∫§ÈöõË≤ª'
        );
        let tax8Total = 0;
        
        tax8Items.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax8Total += item.amount;
        });
        
        excelData.push(['', '', '', '8%ÂêàË®à:', tax8Total]);
        excelData.push(['', '', '', '', '']);
        
        // 10%Âå∫ÂàÜ
        excelData.push(['„Äê10%Âå∫ÂàÜ„Äë', '', '', '', '', '']);
        excelData.push(['Êó•‰ªò', 'Â∫óÂêç', 'ÂãòÂÆöÁßëÁõÆ', 'Ë©≥Á¥∞', 'ÈáëÈ°ç']);
        
        const tax10Items = monthlyExpenses.filter(e => 
          e.category === 'Êó•Áî®ÂìÅ' || e.category === 'ÈõëË≤ª„ÉªÈõëÂìÅ' || 
          e.category === 'Ê∞¥ÂÖâÁÜ±Ë≤ª' || e.category === '„Åù„ÅÆ‰ªñ'
        );
        let tax10Total = 0;
        
        tax10Items.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax10Total += item.amount;
        });
        
        excelData.push(['', '', '', '10%ÂêàË®à:', tax10Total]);
        excelData.push(['', '', '', '', '']);
        
        // ÁßüÁ®éÂÖ¨Ë™≤Âå∫ÂàÜ
        excelData.push(['„ÄêÁßüÁ®éÂÖ¨Ë™≤Âå∫ÂàÜ„Äë', '', '', '', '', '']);
        excelData.push(['Êó•‰ªò', 'Â∫óÂêç', 'ÂãòÂÆöÁßëÁõÆ', 'Ë©≥Á¥∞', 'ÈáëÈ°ç']);
        
        const sozeikokaItems = monthlyExpenses.filter(e => e.category === 'ÁßüÁ®éÂÖ¨Ë™≤');
        let sozeikokaTotal = 0;
        
        sozeikokaItems.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          sozeikokaTotal += item.amount;
        });
        
        excelData.push(['', '', '', 'ÁßüÁ®éÂÖ¨Ë™≤ÂêàË®à:', sozeikokaTotal]);
        excelData.push(['', '', '', '', '']);
        
        // ‰∫§ÈÄöË≤ªÔºà10%ÔºâÂå∫ÂàÜ
        excelData.push(['„Äê‰∫§ÈÄöË≤ªÔºà10%ÔºâÂå∫ÂàÜ„Äë', '', '', '', '', '']);
        excelData.push(['Êó•‰ªò', 'Â∫óÂêç', 'ÂãòÂÆöÁßëÁõÆ', 'Ë©≥Á¥∞', 'ÈáëÈ°ç']);
        
        const transport10Items = monthlyExpenses.filter(e => e.category === '‰∫§ÈÄöË≤ª10%');
        let transport10Total = 0;
        
        transport10Items.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          transport10Total += item.amount;
        });
        
        excelData.push(['', '', '', '‰∫§ÈÄöË≤ªÔºà10%ÔºâÂêàË®à:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        
        // Á∑èÂêàË®à
        const grandTotal = tax8Total + tax10Total + sozeikokaTotal + transport10Total;
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', '8%ÂêàË®àÈáëÈ°ç:', tax8Total]);
        excelData.push(['', '', '', '10%ÂêàË®àÈáëÈ°ç:', tax10Total]);
        excelData.push(['', '', '', 'ÁßüÁ®éÂÖ¨Ë™≤ÂêàË®àÈáëÈ°ç:', sozeikokaTotal]);
        excelData.push(['', '', '', '‰∫§ÈÄöË≤ªÔºà10%ÔºâÂêàË®àÈáëÈ°ç:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', 'ÂêàË®à:', grandTotal]);
        
        // SheetJS„ÅßExcelÁîüÊàê
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // ÂàóÂπÖË®≠ÂÆö
        ws['!cols'] = [
          { wch: 10 },  // Êó•‰ªò
          { wch: 15 },  // Â∫óÂêç
          { wch: 15 },  // ÂãòÂÆöÁßëÁõÆ
          { wch: 25 },  // Ë©≥Á¥∞
          { wch: 12 }   // ÈáëÈ°ç
        ];
        
        // ÁΩ´Á∑ö„Å®„Çπ„Çø„Ç§„É´Ë®≠ÂÆö
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        for (let R = range.s.r; R <= range.e.r; ++R) {
          for (let C = range.s.c; C <= range.e.c; ++C) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            
            if (!ws[cellAddress]) continue;
            
            // Âü∫Êú¨„ÅÆÁΩ´Á∑ö
            ws[cellAddress].s = ws[cellAddress].s || {};
            ws[cellAddress].s.border = {
              top: { style: 'thin', color: { rgb: '000000' } },
              bottom: { style: 'thin', color: { rgb: '000000' } },
              left: { style: 'thin', color: { rgb: '000000' } },
              right: { style: 'thin', color: { rgb: '000000' } }
            };
            
            // „Éò„ÉÉ„ÉÄ„ÉºË°å„ÅÆ„Çπ„Çø„Ç§„É´
            if (R === 0) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'ADD8E6' }  // ËñÑ„ÅÑÈùí
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 16
              };
            }
            
            // Âå∫ÂàÜ„Çø„Ç§„Éà„É´Ë°å„ÅÆ„Çπ„Çø„Ç§„É´Ôºà„Äê8%Âå∫ÂàÜ„Äë„Å™„Å©Ôºâ
            if (excelData[R] && excelData[R][0] && excelData[R][0].startsWith('„Äê')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFFF99' }  // ËñÑ„ÅÑÈªÑËâ≤
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
            }
            
            // Âàó„Éò„ÉÉ„ÉÄ„ÉºË°å„ÅÆ„Çπ„Çø„Ç§„É´ÔºàÊó•‰ªò„ÄÅÂ∫óÂêç„ÄÅÂãòÂÆöÁßëÁõÆ„ÄÅË©≥Á¥∞„ÄÅÈáëÈ°çÔºâ
            if (excelData[R] && excelData[R][0] === 'Êó•‰ªò') {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'D3D3D3' }  // ÁÅ∞Ëâ≤
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
            }
            
            // ÂêàË®àË°å„ÅÆ„Çπ„Çø„Ç§„É´Ôºà8%ÂêàË®à„ÄÅ10%ÂêàË®à„Å™„Å©Ôºâ
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%ÂêàË®à:' || excelData[R][3] === '10%ÂêàË®à:' ||
                 excelData[R][3] === 'ÁßüÁ®éÂÖ¨Ë™≤ÂêàË®à:' || excelData[R][3] === '‰∫§ÈÄöË≤ªÔºà10%ÔºâÂêàË®à:')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFE4B5' }  // ËñÑ„ÅÑ„Ç™„É¨„É≥„Ç∏
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
              // ÈáëÈ°çÂàó„ÅØÂè≥ÂØÑ„Åõ
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // ÊúÄÁµÇÂêàË®àË°å„ÅÆ„Çπ„Çø„Ç§„É´Ôºà8%ÂêàË®àÈáëÈ°ç„ÄÅ10%ÂêàË®àÈáëÈ°ç„ÄÅ‰∫§ÈÄöË≤ªÂêàË®àÈáëÈ°ç„ÄÅÂêàË®àÔºâ
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%ÂêàË®àÈáëÈ°ç:' || excelData[R][3] === '10%ÂêàË®àÈáëÈ°ç:' || 
                 excelData[R][3] === 'ÁßüÁ®éÂÖ¨Ë™≤ÂêàË®àÈáëÈ°ç:' || excelData[R][3] === '‰∫§ÈÄöË≤ªÔºà10%ÔºâÂêàË®àÈáëÈ°ç:' ||
                 excelData[R][3] === 'ÂêàË®à:')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFC7CE' }  // ËñÑ„ÅÑ„Éî„É≥„ÇØ
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
              // ÈáëÈ°çÂàó„ÅØÂè≥ÂØÑ„Åõ
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // „ÄåÂêàË®à:„ÄçË°å„ÅØÁâπ„Å´Âº∑Ë™ø
            if (excelData[R] && excelData[R][3] === 'ÂêàË®à:') {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFB6C1' }  // ÊøÉ„ÅÑ„Éî„É≥„ÇØ
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 14,
                color: { rgb: 'FF0000' }  // Ëµ§ÊñáÂ≠ó
              };
            }
          }
        }
        
        XLSX.utils.book_append_sheet(wb, ws, 'ÁµåË≤ªÊòéÁ¥∞');
        
        const fileName = `ÁµåË≤ªÊòéÁ¥∞_${year}Âπ¥${month}Êúà_ÊúàÊ¨°ÈõÜË®à.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        console.log('‚úÖ ÊúàÊ¨°ÁµåË≤ªExcelÂá∫ÂäõÂÆå‰∫Ü:', fileName);
        await showCustomAlert({
          title: 'Âá∫ÂäõÂÆå‰∫Ü',
          message: `ÊúàÊ¨°ÁµåË≤ª„ÇíÂá∫Âäõ„Åó„Åæ„Åó„ÅüÔºÅ
${fileName}

ÈõÜË®àÊúüÈñì: ${year}Âπ¥${month}Êúà1Êó•„ÄúÁèæÂú®`,
          type: 'success'
        });
        
      } catch (e) {
        console.error('‚ùå ÊúàÊ¨°ÁµåË≤ªÂá∫Âäõ„Ç®„É©„Éº:', e);
        await showCustomAlert({
          title: '„Ç®„É©„Éº',
          message: 'ÊúàÊ¨°ÁµåË≤ª„ÅÆÂá∫Âäõ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message,
          type: 'error'
        });
      }
    };
    
    // ÁµåË≤ªÂá∫Âäõ„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
    window.showExpenseExportModal = function() {
      // Âπ¥„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÁîüÊàêÔºà2020Âπ¥„Åã„ÇâÁèæÂú®„ÅÆÂπ¥„Åæ„ÅßÔºâ
      const currentYear = new Date().getFullYear();
      const yearSelect = document.getElementById('expenseExportYear');
      yearSelect.innerHTML = '';
      
      for (let year = currentYear; year >= 2020; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + 'Âπ¥';
        yearSelect.appendChild(option);
      }
      
      // ÁèæÂú®„ÅÆÊúà„ÇíÈÅ∏ÊäûÁä∂ÊÖã„Å´„Åô„Çã
      const currentMonth = new Date().getMonth() + 1;
      document.getElementById('expenseExportMonth').value = currentMonth;
      
      // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
      document.getElementById('expenseExportModal').style.display = 'flex';
    };
    
    // ÁµåË≤ªÂá∫Âäõ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    window.closeExpenseExportModal = function() {
      document.getElementById('expenseExportModal').style.display = 'none';
    };
    
    // ÁµåË≤ªÂá∫Âäõ„ÇíÂÆüË°å
    window.confirmExpenseExport = async function() {
      const year = parseInt(document.getElementById('expenseExportYear').value);
      const month = parseInt(document.getElementById('expenseExportMonth').value);
      
      closeExpenseExportModal();
      await exportMonthlyExpenses(year, month);
    };
    
    // ===== Êó•Ë®àË°®ÁîüÊàêÊ©üËÉΩ =====
    // üÜï ÈÅ∏Êäû„Åï„Çå„ÅüÊúà„ÅÆÊó•Ë®àË°®„ÇíÂá∫Âäõ
    window.generateDailyReportForSelectedMonth = async function() {
      try {
        const monthSelect = document.getElementById('dailyReportMonth');
        if (!monthSelect || !monthSelect.value) {
          await showCustomAlert({
            title: 'Ë≠¶Âëä',
            message: 'Êúà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
            type: 'warning'
          });
          return;
        }
        
        const [year, month] = monthSelect.value.split('-').map(Number);
        await generateDailyReport(year, month);
      } catch (e) {
        console.error('‚ùå Êó•Ë®àË°®ÁîüÊàê„Ç®„É©„Éº:', e);
        await showCustomAlert({
          title: '„Ç®„É©„Éº',
          message: 'Êó•Ë®àË°®„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message,
          type: 'error'
        });
      }
    };
    
    window.generateDailyReport = async function(targetYear = null, targetMonth = null) {
      try {
        console.log('üìä Êó•Ë®àË°®ÁîüÊàêÈñãÂßã');
        
        // üÜï ÂºïÊï∞„ÅßÂπ¥Êúà„ÅåÊåáÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØÂΩìÊúà„Çí‰ΩøÁî®
        const now = new Date();
        const year = targetYear !== null ? targetYear : now.getFullYear();
        const month = targetMonth !== null ? targetMonth : (now.getMonth() + 1);
        
        // Êúà„ÅÆÊúÄÂàù„ÅÆÊó•„Å®ÊúÄÂæå„ÅÆÊó•„ÇíË®àÁÆó
        const firstDay = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0);
        const daysInMonth = lastDay.getDate();
        
        console.log(`${year}Âπ¥${month}Êúà„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó‰∏≠...`);
        
        // Firestore„Åã„ÇâÂΩìÊúà„ÅÆ„Éá„Éº„Çø„ÇíÂèñÂæó
        const dailySalesSnapshot = await window.getDocs(window.getStoreCollection('dailySales'));
        
        // Êó•‰ªò„Åî„Å®„Å´„Éá„Éº„Çø„ÇíÊï¥ÁêÜ
        const salesByDate = {};
        dailySalesSnapshot.forEach(doc => {
          const data = doc.data();
          const date = data.date;
          
          // ÂΩìÊúà„ÅÆ„Éá„Éº„Çø„ÅÆ„Åø
          if (date && date.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
            salesByDate[date] = data;
          }
        });
        
        console.log('ÂèñÂæó„Åó„Åü„Éá„Éº„Çø:', salesByDate);
        
        // Excel„Éá„Éº„Çø„Çí‰ΩúÊàê
        const excelData = [];
        
        // „Éò„ÉÉ„ÉÄ„ÉºË°å1Ôºà„Çø„Ç§„Éà„É´Ôºâ
        excelData.push(['', 'Â£≤‰∏äÊó•Ë®àË°®', '', '', '', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', '', '', '', '', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', `${year}-${String(month).padStart(2, '0')}-01`, '', '', '', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', '', '', '', '', '', '', '', '', '', '', '', '', '']);
        
        // „Éò„ÉÉ„ÉÄ„ÉºË°å2ÔºàÂàóÂêçÔºâ
        excelData.push(['', 'Êó•', 'ÊõúÊó•', '‰ºùÁ•®Êï∞', 'ÁèæÈáë', '„Ç´„Éº„Éâ', 'ÈõªÂ≠ê„Éû„Éç„Éº', 'Â£≤‰∏äÂêàË®à', '‰∫∫‰ª∂Ë≤ª', '‰∫∫‰ª∂Ë≤ª%', 'ÊîØÊâï„ÅÑ', 'Á¥îÂ£≤‰∏ä', 'TOTALÁ≤óÂà©', 'Â§©Ê∞ó']);
        
        // ÊõúÊó•ÈÖçÂàó
        const weekDays = ['Êó•', 'Êúà', 'ÁÅ´', 'Ê∞¥', 'Êú®', 'Èáë', 'Âúü'];
        
        // Á¥ØË®àÁ≤óÂà©
        let totalGrossProfit = 0;
        
        // ÂêàË®àÁî®„ÅÆÂ§âÊï∞
        let sumCustomerCount = 0;
        let sumCashSales = 0;
        let sumCreditSales = 0;
        let sumEmoneSales = 0;
        let sumTotalSales = 0;
        let sumLaborCost = 0;
        let sumPayment = 0;
        let sumNetSales = 0;
        
        // ÂêÑÊó•„ÅÆ„Éá„Éº„Çø
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const date = new Date(year, month - 1, day);
          const weekDay = weekDays[date.getDay()];
          
          const data = salesByDate[dateStr];
          
          if (data) {
            // „Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà
            const customerCount = data.customerCount || 0;
            const cashSales = data.cashSales || 0;
            const creditSales = data.creditSales || 0;
            const emoneSales = data.emoneSales || 0;
            const totalSales = cashSales + creditSales + emoneSales;
            
            // ‰∫∫‰ª∂Ë≤ª„Çíkintai_attendance„Åã„ÇâÂèñÂæó
            let laborCost = 0;
            try {
              const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
              attendanceSnapshot.forEach(docData => {
                const attData = docData.data();
                if (attData.date === dateStr) {
                  // Êó¢„Å´Ë®àÁÆóÊ∏à„Åø„ÅÆÁ∑èË≥ÉÈáë„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®
                  if (attData.totalWage && attData.totalWage > 0) {
                    laborCost += attData.totalWage;
                  } else if (attData.clockIn && attData.clockOut) {
                    // Á∑èË≥ÉÈáë„Åå„Å™„ÅÑÂ†¥Âêà„ÅØË®àÁÆó„Åô„Çã
                    const clockIn = new Date(`${dateStr} ${attData.clockIn}`);
                    const clockOut = new Date(`${dateStr} ${attData.clockOut}`);
                    let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                    
                    if (attData.breakStart1 && attData.breakEnd1) {
                      const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                      const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                      workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                    }
                    if (attData.breakStart2 && attData.breakEnd2) {
                      const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                      const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                      workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                    }
                    
                    const hourlyRate = attData.hourlyRate || 1150;
                    
                    // Ââ≤Â¢óË≥ÉÈáë„ÅÆË®àÁÆó
                    let totalWage = 0;
                    const isHoliday = attData.isHoliday || false;
                    
                    // ÊôÇÈñì„Åî„Å®„Å´Ââ≤Â¢óÁéá„ÇíË®àÁÆó
                    let currentTime = new Date(clockIn);
                    const endTime = new Date(clockOut);
                    
                    while (currentTime < endTime) {
                      const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                      const segmentEnd = nextHour > endTime ? endTime : nextHour;
                      
                      // ‰ºëÊÜ©ÊôÇÈñì„ÇíÈô§Â§ñ
                      let isBreak = false;
                      if (attData.breakStart1 && attData.breakEnd1) {
                        const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                        const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                        if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                          isBreak = true;
                        }
                      }
                      if (attData.breakStart2 && attData.breakEnd2) {
                        const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                        const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                        if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                          isBreak = true;
                        }
                      }
                      
                      if (!isBreak) {
                        const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                        const hour = currentTime.getHours();
                        
                        let rate = 1.0;
                        if (isHoliday) {
                          // ‰ºëÊó•Âá∫Âã§: Âü∫Êú¨35%Â¢ó
                          rate = 1.35;
                          // 22ÊôÇÔΩû5ÊôÇ„ÅØÊ∑±Â§úÂâ≤Â¢ó25%„ÇíËøΩÂä†ÔºàÂêàË®à60%Â¢óÔºâ
                          if (hour >= 22 || hour < 5) {
                            rate = 1.60;
                          }
                        } else {
                          // Âπ≥Êó•: 22ÊôÇÔΩû5ÊôÇ„ÅØÊ∑±Â§úÂâ≤Â¢ó25%
                          if (hour >= 22 || hour < 5) {
                            rate = 1.25;
                          }
                        }
                        
                        totalWage += segmentHours * hourlyRate * rate;
                      }
                      
                      currentTime = segmentEnd;
                    }
                    
                    laborCost += totalWage;
                  }
                }
              });
            } catch (e) {
              console.error('‰∫∫‰ª∂Ë≤ªÂèñÂæó„Ç®„É©„Éº:', e);
            }
            
            const laborCostPercent = totalSales > 0 ? Math.round(laborCost / totalSales * 100) : 0;
            
            // ÊîØÂá∫„Çíexpenses„Åã„ÇâÂèñÂæó
            let payment = 0;
            try {
              const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
              if (expenseDoc.exists()) {
                payment = expenseDoc.data().total || 0;
              }
            } catch (e) {
              console.error('ÊîØÂá∫ÂèñÂæó„Ç®„É©„Éº:', e);
            }
            
            // Á¥îÂ£≤‰∏ä
            const netSales = totalSales - laborCost - payment;
            
            // Á¥ØË®àÁ≤óÂà©
            totalGrossProfit += netSales;
            
            // ÂêàË®à„Å´Âä†ÁÆó
            sumCustomerCount += customerCount;
            sumCashSales += cashSales;
            sumCreditSales += creditSales;
            sumEmoneSales += emoneSales;
            sumTotalSales += totalSales;
            sumLaborCost += laborCost;
            sumPayment += payment;
            sumNetSales += netSales;
            
            excelData.push([
              '',
              date,
              weekDay,
              customerCount,
              cashSales,
              creditSales,
              emoneSales,
              totalSales,
              Math.round(laborCost),
              laborCostPercent + '%',  // %Ë®òÂè∑„Çí‰ªò„Åë„Çã
              payment,
              Math.round(netSales),
              Math.round(totalGrossProfit),
              '' // Â§©Ê∞ó„ÅØÊâãÂãïÂÖ•Âäõ
            ]);
          } else {
            // „Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥ÂêàÔºàÁ©∫Ë°åÔºâ
            excelData.push([
              '',
              date,
              weekDay,
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              ''
            ]);
          }
        }
        
        // ÂêàË®àË°å„ÇíËøΩÂä†
        const avgLaborCostPercent = sumTotalSales > 0 ? Math.round(sumLaborCost / sumTotalSales * 100) : 0;
        excelData.push([
          '',
          '',
          'ÂêàË®à',
          sumCustomerCount,
          sumCashSales,
          sumCreditSales,
          sumEmoneSales,
          sumTotalSales,
          Math.round(sumLaborCost),
          avgLaborCostPercent + '%',
          sumPayment,
          Math.round(sumNetSales),
          '', // TOTALÁ≤óÂà©„ÅØÊúÄÂæå„ÅÆË°å„ÅÆÂÄ§
          ''
        ]);
        
        console.log('Excel„Éá„Éº„Çø‰ΩúÊàêÂÆå‰∫Ü:', excelData.length, 'Ë°å');
        
        // SheetJS„ÅßExcel„Éï„Ç°„Ç§„É´„ÇíÁîüÊàê
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // ÂàóÂπÖ„ÇíË®≠ÂÆö
        ws['!cols'] = [
          { wch: 3 },  // AÂàó
          { wch: 12 }, // BÂàóÔºàÊó•‰ªòÔºâ
          { wch: 5 },  // CÂàóÔºàÊõúÊó•Ôºâ
          { wch: 8 },  // DÂàóÔºà‰ºùÁ•®Êï∞Ôºâ
          { wch: 10 }, // EÂàóÔºàÁèæÈáëÔºâ
          { wch: 10 }, // FÂàóÔºà„Ç´„Éº„ÉâÔºâ
          { wch: 10 }, // GÂàóÔºàpaypayÔºâ
          { wch: 10 }, // HÂàóÔºàÂ£≤‰∏äÂêàË®àÔºâ
          { wch: 10 }, // IÂàóÔºà‰∫∫‰ª∂Ë≤ªÔºâ
          { wch: 10 }, // JÂàóÔºà‰∫∫‰ª∂Ë≤ª%Ôºâ
          { wch: 10 }, // KÂàóÔºàÊîØÊâï„ÅÑÔºâ
          { wch: 10 }, // LÂàóÔºàÁ¥îÂ£≤‰∏äÔºâ
          { wch: 12 }, // MÂàóÔºàTOTALÁ≤óÂà©Ôºâ
          { wch: 10 }  // NÂàóÔºàÂ§©Ê∞óÔºâ
        ];
        
        // üÜï ÂÖ®„Çª„É´„Å´ÁΩ´Á∑ö„Å®„Çπ„Çø„Ç§„É´„ÇíË®≠ÂÆö
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        for (let R = range.s.r; R <= range.e.r; R++) {
          for (let C = range.s.c; C <= range.e.c; C++) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            
            // „Çª„É´„ÅåÂ≠òÂú®„Åó„Å™„ÅÑÂ†¥Âêà„ÅØ‰ΩúÊàê
            if (!ws[cellAddress]) {
              ws[cellAddress] = { t: 's', v: '' };
            }
            
            // „Çπ„Çø„Ç§„É´„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÇíÂàùÊúüÂåñ
            if (!ws[cellAddress].s) {
              ws[cellAddress].s = {};
            }
            
            // ÁΩ´Á∑ö„ÇíË®≠ÂÆö
            ws[cellAddress].s.border = {
              top: { style: 'thin', color: { rgb: '000000' } },
              bottom: { style: 'thin', color: { rgb: '000000' } },
              left: { style: 'thin', color: { rgb: '000000' } },
              right: { style: 'thin', color: { rgb: '000000' } }
            };
            
            // „Éò„ÉÉ„ÉÄ„ÉºË°åÔºà5Ë°åÁõÆ = R=4Ôºâ„ÅÆ„Çπ„Çø„Ç§„É´
            if (R === 4) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'D3D3D3' }
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
              ws[cellAddress].s.alignment = {
                horizontal: 'center',
                vertical: 'center'
              };
            }
            
            // ÂêàË®àË°åÔºàÊúÄÁµÇË°åÔºâ„ÅÆ„Çπ„Çø„Ç§„É´
            if (R === range.e.r) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFFFCC' }
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
            }
            
            // Êï∞ÂÄ§„Çª„É´„ÅÆÂè≥ÂØÑ„Åõ
            if (C >= 3 && C <= 12 && R >= 5) {
              if (!ws[cellAddress].s.alignment) {
                ws[cellAddress].s.alignment = {};
              }
              ws[cellAddress].s.alignment.horizontal = 'right';
            }
          }
        }
        
        XLSX.utils.book_append_sheet(wb, ws, 'Â£≤‰∏äÊó•Ë®àË°®');
        
        // „Éï„Ç°„Ç§„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
        const fileName = `Êó•Ë®àË°®${year}Âπ¥${month}Êúà.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        console.log('‚úÖ Êó•Ë®àË°®Âá∫ÂäõÂÆå‰∫Ü:', fileName);
        await showCustomAlert({
          title: 'Âá∫ÂäõÂÆå‰∫Ü',
          message: `Êó•Ë®àË°®„ÇíÂá∫Âäõ„Åó„Åæ„Åó„ÅüÔºÅ
${fileName}`,
          type: 'success'
        });
        
      } catch (e) {
        console.error('‚ùå Êó•Ë®àË°®ÁîüÊàê„Ç®„É©„Éº:', e);
        await showCustomAlert({
          title: '„Ç®„É©„Éº',
          message: 'Êó•Ë®àË°®„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message,
          type: 'error'
        });
      }
    };
    
    // ========== Â±•Ê≠¥Ê©üËÉΩ ==========
    
    let historyOrders = [];
    
    window.showHistoryModal = async function() {
      // Ê©üËÉΩ„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('historyModal').style.display = 'flex';
      await loadHistory();
    };
    
    window.closeHistoryModal = function() {
      document.getElementById('historyModal').style.display = 'none';
    };
    
    // Âú®Â∫´„ÇíÊàª„ÅôÂá¶ÁêÜ
    async function restoreInventoryFromRedSlip(items) {
      try {
        console.log('üì¶ Âú®Â∫´„ÇíÊàª„ÅôÂá¶ÁêÜÈñãÂßã');
        
        // Âú®Â∫´Ë®≠ÂÆö„ÇíÂèñÂæó
        const inventoryRef = window.getStoreDoc('inventory_settings', 'default');
        const inventoryDoc = await window.getDoc(inventoryRef);
        
        if (!inventoryDoc.exists()) {
          console.log('‚ö†Ô∏è Âú®Â∫´Ë®≠ÂÆö„ÅåÂ≠òÂú®„Åó„Å™„ÅÑ„Åü„ÇÅ„ÄÅÂú®Â∫´„ÇíÊàª„ÅôÂá¶ÁêÜ„Çí„Çπ„Ç≠„ÉÉ„Éó');
          return;
        }
        
        const inventorySettings = inventoryDoc.data().items || {};
        let updated = false;
        
        // ÂêÑÂïÜÂìÅ„ÅÆÂú®Â∫´„ÇíÊàª„Åô
        items.forEach(item => {
          const menuItemId = item.menuItemId || item.id;
          if (!menuItemId) {
            console.warn('‚ö†Ô∏è menuItemId„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', item);
            return;
          }
          
          if (inventorySettings[menuItemId] && inventorySettings[menuItemId].stock !== null && inventorySettings[menuItemId].stock !== undefined) {
            const currentStock = inventorySettings[menuItemId].stock;
            const returnQuantity = item.quantity || 1;
            inventorySettings[menuItemId].stock = currentStock + returnQuantity;
            updated = true;
            console.log(`‚úÖ ${item.name}: ${currentStock} ‚Üí ${inventorySettings[menuItemId].stock} (+${returnQuantity})`);
          }
        });
        
        // Âú®Â∫´Ë®≠ÂÆö„Çí‰øùÂ≠ò
        if (updated) {
          await window.setDoc(inventoryRef, {
            items: inventorySettings,
            updatedAt: window.Timestamp.now()
          });
          console.log('‚úÖ Âú®Â∫´„ÇíÊàª„Åó„Åæ„Åó„Åü');
        } else {
          console.log('‚ö†Ô∏è Êàª„ÅôÂú®Â∫´„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü');
        }
        
      } catch (e) {
        console.error('‚ùå Âú®Â∫´„ÇíÊàª„ÅôÂá¶ÁêÜ„Ç®„É©„Éº:', e);
        // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÇÇÂá¶ÁêÜ„ÅØÁ∂öË°å
      }
    }
    
    // Ëµ§‰ºùÁ•®„É¨„Ç∑„Éº„Éà„ÇíÂç∞Âà∑
    async function printRedSlipReceipt(orderData) {
      try {
        console.log('üñ®Ô∏è Ëµ§‰ºùÁ•®„É¨„Ç∑„Éº„ÉàÂç∞Âà∑ÈñãÂßã');
        
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        // 58mmÂπÖË®≠ÂÆö
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        // „Éò„ÉÉ„ÉÄ„Éº
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2, invert: true});
        builder.createTextElement({data: '  Ëµ§‰ºùÁ•®  \n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1, invert: false});
        
        const storeName = window.receiptSettings?.storeName || 'Á≤â„ÇÇ„ÇìÂ±ã ÂÖ´';
        const branchName = window.receiptSettings?.branchName || '‰∏ãËµ§Â°öÂ∫ó';
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: storeName + '\n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createTextElement({data: branchName + '\n'});
        
        const address = window.receiptSettings?.address || 'Êù±‰∫¨ÈÉΩÊùøÊ©ãÂå∫Ëµ§Â°öÊñ∞Áî∫';
        const phone = window.receiptSettings?.phone || '03-XXXX-XXXX';
        builder.createTextElement({data: address + '\n'});
        builder.createTextElement({data: 'TEL: ' + phone + '\n'});
        
        builder.createRuledLineElement({thickness: 'thin'});
        
        // Êó•ÊôÇÊÉÖÂ†±
        builder.createAlignmentElement({position: 'left'});
        const now = new Date();
        const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        builder.createTextElement({data: `Áô∫Ë°åÊó•ÊôÇ: ${dateStr}\n`});
        
        const orderDate = orderData.timestamp?.toDate() || new Date();
        const orderDateStr = `${orderDate.getFullYear()}/${String(orderDate.getMonth()+1).padStart(2,'0')}/${String(orderDate.getDate()).padStart(2,'0')} ${String(orderDate.getHours()).padStart(2,'0')}:${String(orderDate.getMinutes()).padStart(2, '0')}`;
        builder.createTextElement({data: `ÂÖÉÊ≥®ÊñáÊó•ÊôÇ: ${orderDateStr}\n`});
        builder.createTextElement({data: `„ÉÜ„Éº„Éñ„É´: ${orderData.tableNumber}\n`});
        builder.createTextElement({data: `Ê≥®ÊñáNo: ${orderData.orderNumber}\n`});
        
        builder.createRuledLineElement({thickness: 'thin'});
        
        // ÂïÜÂìÅÊòéÁ¥∞Ôºà„Éû„Ç§„Éä„ÇπË°®Á§∫Ôºâ
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 1, height: 1});
        builder.createTextElement({data: 'ËøîÂìÅÂïÜÂìÅ\n'});
        builder.createTextElement({emphasis: false});
        builder.createAlignmentElement({position: 'left'});
        
        let total = 0;
        orderData.items.forEach(item => {
          const subtotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
          total += subtotal;
          
          const itemName = item.name.length > 16 ? item.name.substring(0, 15) + '‚Ä¶' : item.name;
          builder.createTextElement({data: `${itemName}\n`});
          
          const priceInfo = `-@${item.price} x${item.quantity}`;
          const subtotalStr = `-${subtotal.toLocaleString()}ÂÜÜ`;
          const spaces = ' '.repeat(Math.max(1, 32 - priceInfo.length - subtotalStr.length));
          builder.createTextElement({data: `${priceInfo}${spaces}${subtotalStr}\n`});
          
          // „Éà„ÉÉ„Éî„É≥„Ç∞Ë°®Á§∫
          if (item.toppings && item.toppings !== '„Å™„Åó') {
            builder.createTextElement({data: ` TP:${item.toppings}\n`});
          }
        });
        
        builder.createRuledLineElement({thickness: 'medium'});
        
        // ÂêàË®àÔºà„Éû„Ç§„Éä„ÇπË°®Á§∫Ôºâ
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `ËøîÈáëÈ°ç -${total.toLocaleString()}ÂÜÜ\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        builder.createRuledLineElement({thickness: 'medium'});
        
        // „Éï„ÉÉ„Çø„Éº
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({data: '\nËµ§‰ºùÁ•®\n'});
        builder.createTextElement({data: 'Â£≤‰∏äÂèñÊ∂à\n\n\n'});
        
        builder.createCutPaperElement({feed: true});
        
        // Âç∞Âà∑ÂÆüË°å
        await sendPrintRequest(
          builder,
          (response) => {
            console.log('‚úÖ Ëµ§‰ºùÁ•®„É¨„Ç∑„Éº„ÉàÂç∞Âà∑ÊàêÂäü');
          },
          (response) => {
            console.error('‚ùå Ëµ§‰ºùÁ•®„É¨„Ç∑„Éº„ÉàÂç∞Âà∑„Ç®„É©„Éº:', response);
          }
        );
        
      } catch (e) {
        console.error('‚ùå Ëµ§‰ºùÁ•®„É¨„Ç∑„Éº„ÉàÂç∞Âà∑„Ç®„É©„Éº:', e);
        // Âç∞Âà∑„Ç®„É©„Éº„Åß„ÇÇÂá¶ÁêÜ„ÅØÁ∂öË°å
      }
    }
    
    // Â£≤‰∏ä„Éá„Éº„Çø„ÇíÊõ¥Êñ∞ÔºàËµ§‰ºùÁ•®ÂàÜ„Çí„Éû„Ç§„Éä„ÇπÔºâ
    async function updateSalesForRedSlip(orderData) {
      try {
        console.log('üìä Â£≤‰∏ä„Éá„Éº„ÇøÊõ¥Êñ∞ÈñãÂßã');
        
        // Âñ∂Ê•≠Êó•„ÇíË®àÁÆóÔºàÂçàÂâç3ÊôÇÂü∫Ê∫ñÔºâ
        const orderDate = orderData.paidAt?.toDate() || orderData.timestamp?.toDate() || new Date();
        const dateKey = window.getBusinessDay(orderDate).str;
        
        // Â£≤‰∏ä„Éá„Éº„Çø„ÇíÂèñÂæó
        const salesRef = window.getStoreDoc('daily_sales', dateKey);
        const salesDoc = await window.getDoc(salesRef);
        
        if (!salesDoc.exists()) {
          console.warn('‚ö†Ô∏è Â£≤‰∏ä„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', dateKey);
          return;
        }
        
        const salesData = salesDoc.data();
        
        // Ëµ§‰ºùÁ•®„ÅÆ„Ç´„Ç¶„É≥„Éà„Å®ÈáëÈ°ç„ÇíÊõ¥Êñ∞
        const redSlipCount = (salesData.redSlipCount || 0) + 1;
        const redSlipAmount = (salesData.redSlipAmount || 0) + orderData.totalAmount;
        
        // Á®éÁéáÂà•„ÅÆËµ§‰ºùÁ•®ÈáëÈ°ç„ÇíË®àÁÆó
        let redSlipTax8Total = salesData.redSlipTax8Total || 0;
        let redSlipTax10Total = salesData.redSlipTax10Total || 0;
        
        orderData.items.forEach(item => {
          const subtotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
          if (item.taxRate === 8) {
            redSlipTax8Total += subtotal;
          } else {
            redSlipTax10Total += subtotal;
          }
        });
        
        // Â£≤‰∏ä„Éá„Éº„Çø„ÇíÊõ¥Êñ∞
        await window.updateDoc(salesRef, {
          redSlipCount: redSlipCount,
          redSlipAmount: redSlipAmount,
          redSlipTax8Total: redSlipTax8Total,
          redSlipTax10Total: redSlipTax10Total,
          updatedAt: window.Timestamp.now()
        });
        
        console.log('‚úÖ Â£≤‰∏ä„Éá„Éº„ÇøÊõ¥Êñ∞ÂÆå‰∫Ü');
        
      } catch (e) {
        console.error('‚ùå Â£≤‰∏ä„Éá„Éº„ÇøÊõ¥Êñ∞„Ç®„É©„Éº:', e);
        // „Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Å¶„ÇÇÂá¶ÁêÜ„ÅØÁ∂öË°å
      }
    }
    
    async function loadHistory() {
      try {
        const q = window.query(
          window.getStoreCollection('orders'),
          window.orderBy('timestamp', 'desc'),
          window.limit(100)
        );
        const ordersSnapshot = await window.getDocs(q);
        historyOrders = [];
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          historyOrders.push({
            id: doc.id,
            orderNumber: data.orderNumber || 0,
            timestamp: data.timestamp,
            tableNumber: data.tableNumber || '',
            items: data.items || [],
            totalAmount: data.totalAmount || 0,
            paymentMethod: data.paymentMethod || 'cash',
            paidAt: data.paidAt || null,
            completedAt: data.completedAt || null
          });
        });
        
        filterHistory();
      } catch (e) {
        console.error('Â±•Ê≠¥Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
        await showCustomAlert({ 
          icon: '', 
          title: '„Ç®„É©„Éº', 
          message: 'Â±•Ê≠¥„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 
          btnClass: 'modal-btn-danger' 
        });
      }
    }
    
    window.filterHistory = function() {
      const dateFilter = document.getElementById('historyDateFilter').value;
      const statusFilter = document.getElementById('historyStatusFilter').value;
      const now = new Date();
      
      let filtered = historyOrders.filter(order => {
        const orderDate = order.timestamp.toDate();
        
        let dateMatch = true;
        if (dateFilter === 'today') {
          const jstOffsetMs = 9 * 60 * 60 * 1000;
          const jstNowMs = now.getTime() + jstOffsetMs;
          const jstMidnightMs = jstNowMs - (jstNowMs % (24 * 60 * 60 * 1000));
          let todayStart = new Date(jstMidnightMs + (3 * 60 * 60 * 1000) - jstOffsetMs);
          if (now < todayStart) todayStart = new Date(todayStart.getTime() - 24 * 60 * 60 * 1000);
          const todayEnd = new Date(todayStart.getTime() + 24 * 60 * 60 * 1000);
          dateMatch = orderDate >= todayStart && orderDate < todayEnd;
        } else if (dateFilter === 'yesterday') {
          const jstOffsetMs = 9 * 60 * 60 * 1000;
          const jstNowMs = now.getTime() + jstOffsetMs;
          const jstMidnightMs = jstNowMs - (jstNowMs % (24 * 60 * 60 * 1000));
          let todayStart = new Date(jstMidnightMs + (3 * 60 * 60 * 1000) - jstOffsetMs);
          if (now < todayStart) todayStart = new Date(todayStart.getTime() - 24 * 60 * 60 * 1000);
          const yesterdayStart = new Date(todayStart.getTime() - 24 * 60 * 60 * 1000);
          const yesterdayEnd = todayStart;
          dateMatch = orderDate >= yesterdayStart && orderDate < yesterdayEnd;
        } else if (dateFilter === 'week') {
          const weekAgo = new Date(now);
          weekAgo.setDate(weekAgo.getDate() - 7);
          dateMatch = orderDate >= weekAgo;
        } else if (dateFilter === 'month') {
          const monthStart = new Date(now);
          monthStart.setDate(1);
          monthStart.setHours(0, 0, 0, 0);
          dateMatch = orderDate >= monthStart;
        }
        
        let statusMatch = true;
        if (statusFilter === 'deleted') {
          statusMatch = order.deleted === true;
        } else if (statusFilter === 'paid') {
          statusMatch = order.paidAt !== null && !order.deleted;
        } else if (statusFilter === 'completed') {
          statusMatch = order.completedAt !== null && !order.deleted;
        }
        
        return dateMatch && statusMatch;
      });
      
      displayHistory(filtered);
    };
    
    function displayHistory(orders) {
      const container = document.getElementById('historyList');
      
      if (orders.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">Ë©≤ÂΩì„Åô„ÇãÂ±•Ê≠¥„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>';
        return;
      }
      
      container.innerHTML = '';
      
      orders.forEach(order => {
        const card = document.createElement('div');
        card.style.cssText = `
          background: white;
          border-radius: 12px;
          padding: 15px;
          margin-bottom: 15px;
          border: 2px solid #ddd;
        `;
        
        const orderDate = order.timestamp.toDate();
        const dateStr = orderDate.toLocaleString('ja-JP');
        
        const paymentMethodNames = {
          'cash': 'ÁèæÈáë',
          'emoney': 'ÈõªÂ≠ê„Éû„Éç„Éº',
          'credit': '„ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„Éâ'
        };
        const paymentMethodLabel = paymentMethodNames[order.paymentMethod] || 'ÁèæÈáë';
        
        let itemsHtml = '';
        order.items.forEach(item => {
          itemsHtml += `<div style="padding: 5px 0; border-bottom: 1px solid #eee;">
            ${item.name} √ó${item.quantity} - ¬•${((item.price + (item.toppingPrice || 0)) * item.quantity).toLocaleString()}
          </div>`;
        });
        
        // „Çπ„ÉÜ„Éº„Çø„Çπ„Éê„ÉÉ„Ç∏
        let badges = [];
        if (order.deleted) badges.push('<span style="background: #666; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">ÂâäÈô§Ê∏à„Åø</span>');
        if (order.paidAt) badges.push('<span style="background: #2196F3; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">‰ºöË®àÊ∏à</span>');
        if (order.completedAt) badges.push('<span style="background: #4CAF50; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">ÂÆå‰∫Ü</span>');
        if (order.cancelledAt) badges.push('<span style="background: #f44336; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">„Ç≠„É£„É≥„Çª„É´</span>');
        
        // „Éú„Çø„É≥‰ΩúÊàê
        let buttonsHtml = `
          <div style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 2px solid #eee; flex-wrap: wrap;">
            <button onclick="playTapSound(); editOrderFromHistory('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;"> Á∑®ÈõÜ</button>
            ${order.paidAt ? `
              <button onclick="playTapSound(); redSlipFromHistory('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;"> Ëµ§‰ºùÁ•®</button>
            ` : `
              ${!order.deleted ? `
                <button onclick="playTapSound(); deleteOrderFromHistory('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">üóë ÂèñÊ∂à</button>
              ` : `
                <button onclick="playTapSound(); restoreOrderFromHistory('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">Âæ©ÂÖÉ</button>
              `}
            `}
            ${order.paidAt ? `
              <button onclick="playTapSound(); reprintReceipt('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">„É¨„Ç∑„Éº„ÉàË°®Á§∫</button>
              <button onclick="playTapSound(); reprintInvoice('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">È†òÂèéÊõ∏Ë°®Á§∫</button>
            ` : ''}
          </div>
        `;
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div>
              <strong style="font-size: 18px; color: #667eea;">#${order.orderNumber}</strong>
              <span style="margin-left: 10px; color: #666;">${order.tableNumber}</span>
            </div>
            <div>${badges.join('')}</div>
          </div>
          <div style="font-size: 12px; color: #999; margin-bottom: 10px;">
            ${dateStr}
            ${order.paidAt ? `<span style="margin-left: 15px; padding: 4px 8px; background: #e3f2fd; color: #1976d2; border-radius: 4px; font-weight: bold;">${paymentMethodLabel}</span>` : ''}
          </div>
          <div style="margin-bottom: 10px; max-height: 150px; overflow-y: auto;">${itemsHtml}</div>
          <div style="text-align: right; font-size: 18px; font-weight: bold; color: #667eea; padding-top: 10px; border-top: 2px solid #eee;">
            ÂêàË®à: ¬•${order.totalAmount.toLocaleString()}
          </div>
          ${buttonsHtml}
        `;
        
        container.appendChild(card);
      });
    }
    
    window.refreshHistory = async function() {
      await loadHistory();
    };
    
    // ========== Ëµ§‰ºùÁ•®Ê©üËÉΩ ==========
    window.redSlipFromHistory = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        if (!orderDoc.exists()) {
          await showCustomAlert({ title: '„Ç®„É©„Éº', message: 'Ê≥®Êñá„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', btnClass: 'modal-btn-danger' });
          return;
        }
        
        const orderData = { id: orderDoc.id, ...orderDoc.data() };
        
        if (!orderData.paidAt) {
          await showCustomAlert({ title: '„Ç®„É©„Éº', message: '‰ºöË®àÊ∏à„Åø„ÅÆÊ≥®Êñá„ÅÆ„ÅøËµ§‰ºùÁ•®„Åß„Åç„Åæ„Åô', btnClass: 'modal-btn-danger' });
          return;
        }
        
        const confirmed = await showCustomConfirm({
          title: 'Ëµ§‰ºùÁ•®Á¢∫Ë™ç',
          message: `Ê≥®Êñá #${orderData.orderNumber} „ÇíËµ§‰ºùÁ•®„ÅßÂÆåÂÖ®ÂèñÊ∂à„Åó„Åæ„Åô„Åã?\n\nÈáëÈ°ç: ¬•${orderData.totalAmount.toLocaleString()}\n\nÈáçË¶Å„Å™Ê≥®ÊÑè‰∫ãÈ†Ö:\n„ÉªÂ£≤‰∏ä„Åã„ÇâÂÆåÂÖ®„Å´Èô§Â§ñ„Åï„Çå„Åæ„Åô\n„ÉªÂú®Â∫´„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂïÜÂìÅ„ÅØÂú®Â∫´„ÅåÊàª„Çä„Åæ„Åô\n„ÉªËµ§‰ºùÁ•®„É¨„Ç∑„Éº„Éà„ÅåÂç∞Âà∑„Åï„Çå„Åæ„Åô\n„ÉªÂÆ¢Êï∞„ÇÇÊ∏õÂ∞ë„Åó„Åæ„Åô\n„ÉªÂæ©ÂÖÉ„Åß„Åç„Åæ„Åõ„Çì\n„Éª„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì`,
          confirmText: 'Ëµ§‰ºùÁ•®„ÇíÂàá„Çã',
          cancelText: '„Ç≠„É£„É≥„Çª„É´'
        });
        
        if (!confirmed) return;
        
        // ‰ºöË®àÊó•ÊôÇ„Åã„ÇâÂñ∂Ê•≠Êó•„ÇíË®àÁÆóÔºà3ÊôÇÂü∫Ê∫ñÔºâ
        const paidDate = orderData.paidAt.toDate();
        const dateStr = window.getBusinessDay(paidDate).str;
        
        // dailySales„ÇíÂèñÂæó
        const dailySalesRef = window.getStoreDoc('dailySales', dateStr);
        const dailySalesDoc = await window.getDoc(dailySalesRef);
        
        if (!dailySalesDoc.exists()) {
          await showCustomAlert({ title: '„Ç®„É©„Éº', message: '„Åì„ÅÆÂñ∂Ê•≠Êó•„ÅÆdailySales„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', btnClass: 'modal-btn-danger' });
          return;
        }
        
        const dailyData = dailySalesDoc.data();
        const totalAmount = orderData.totalAmount || 0;
        
        // Á®éÁéáË®àÁÆó
        let tax8Total = 0;
        let tax10Total = 0;
        // üÜï ÂÜÖÁ®é„ÉªÂ§ñÁ®é„ÇíÂå∫Âà•„Åó„Å¶Ë®àÁÆó
        let tax8Inclusive = 0;
        let tax10Inclusive = 0;
        let tax8Exclusive = 0;
        let tax10Exclusive = 0;
        
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
            let itemTaxRate = item.taxRate || (item.takeout ? 8 : 10);
            const taxType = item.taxType || 'inclusive';  // „Éá„Éï„Ç©„É´„Éà„ÅØÂÜÖÁ®é
            const taxAmount = getTaxAmount(item, item.quantity || 1);
            
            if (itemTaxRate === 8) {
              tax8Total += itemTotal;
              if (taxType === 'exclusive') {
                tax8Exclusive += taxAmount;
              } else {
                tax8Inclusive += taxAmount;
              }
            } else {
              tax10Total += itemTotal;
              if (taxType === 'exclusive') {
                tax10Exclusive += taxAmount;
              } else {
                tax10Inclusive += taxAmount;
              }
            }
          });
        }
        
        // ÊîØÊâï„ÅÑÊñπÊ≥ïÂà•„ÅÆÈáëÈ°ç
        let cashSales = 0, emoneSales = 0, creditSales = 0;
        const paymentMethod = orderData.paymentMethod || '';
        if (paymentMethod === 'ÁèæÈáë' || paymentMethod === 'cash') cashSales = totalAmount;
        else if (paymentMethod === 'ÈõªÂ≠ê„Éû„Éç„Éº' || paymentMethod === 'emoney') emoneSales = totalAmount;
        else if (paymentMethod === '„ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„Éâ' || paymentMethod === 'credit') creditSales = totalAmount;
        
        // ÂïÜÂìÅÊï∞„ÇíË®àÁÆó
        let totalItems = 0;
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            totalItems += item.quantity || 0;
          });
        }
        
        // üÜï Âú®Â∫´„ÇíÊàª„ÅôÂá¶ÁêÜ
        await restoreInventoryFromRedSlip(orderData.items);
        
        // dailySales„Åã„ÇâÊ∏õÁÆó
        const updateData = {
          totalSales: Math.max(0, (dailyData.totalSales || 0) - totalAmount),
          customerCount: Math.max(0, (dailyData.customerCount || 0) - 1),
          totalItems: Math.max(0, (dailyData.totalItems || 0) - totalItems),
          cashSales: Math.max(0, (dailyData.cashSales || 0) - cashSales),
          emoneSales: Math.max(0, (dailyData.emoneSales || 0) - emoneSales),
          creditSales: Math.max(0, (dailyData.creditSales || 0) - creditSales),
          tax8Total: Math.max(0, (dailyData.tax8Total || 0) - tax8Total),
          tax10Total: Math.max(0, (dailyData.tax10Total || 0) - tax10Total),
          redSlipCount: (dailyData.redSlipCount || 0) + 1,
          redSlipAmount: (dailyData.redSlipAmount || 0) + totalAmount,
          redSlipTax8Total: (dailyData.redSlipTax8Total || 0) + tax8Total,
          redSlipTax10Total: (dailyData.redSlipTax10Total || 0) + tax10Total,
          // üÜï ÂÜÖÁ®é„ÉªÂ§ñÁ®é„Çí‰øùÂ≠ò
          redSlipTax8Inclusive: (dailyData.redSlipTax8Inclusive || 0) + tax8Inclusive,
          redSlipTax10Inclusive: (dailyData.redSlipTax10Inclusive || 0) + tax10Inclusive,
          redSlipTax8Exclusive: (dailyData.redSlipTax8Exclusive || 0) + tax8Exclusive,
          redSlipTax10Exclusive: (dailyData.redSlipTax10Exclusive || 0) + tax10Exclusive
        };
        
        await window.updateDoc(dailySalesRef, updateData);
        
        // redSlips„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Å´‰øùÂ≠ò
        const redSlipData = {
          ...orderData,
          redSlippedAt: window.Timestamp.now(),
          redSlippedBy: window.currentStoreId,
          businessDate: dateStr,
          originalOrderId: orderData.id,
          calculatedTax8Total: tax8Total,
          calculatedTax10Total: tax10Total
        };
        
        const redSlipRef = window.doc(window.collection(window.db, 'stores', window.currentStoreId, 'redSlips'));
        await window.setDoc(redSlipRef, redSlipData);
        
        // üÜï Ëµ§‰ºùÁ•®„É¨„Ç∑„Éº„Éà„ÇíÂç∞Âà∑
        await printRedSlipReceipt(orderData);
        
        // Ê≥®Êñá„ÇíÂâäÈô§
        await window.deleteDoc(window.getStoreDoc('orders', orderData.id));
        
        await showCustomAlert({ title: 'Ëµ§‰ºùÁ•®ÂÆå‰∫Ü', message: `Ê≥®Êñá #${orderData.orderNumber} „ÇíËµ§‰ºùÁ•®„ÅßÂèñ„ÇäÊ∂à„Åó„Åæ„Åó„Åü\n\nÈáëÈ°ç: ¬•${totalAmount.toLocaleString()}\n\nÂ£≤‰∏ä„ÉªÂÆ¢Êï∞„Åã„ÇâÈô§Â§ñ„Åï„Çå„Åæ„Åó„Åü`, btnClass: 'modal-btn-primary' });
        
        // Â±•Ê≠¥„ÇíÂÜçË™≠„ÅøËæº„Åø
        await loadHistory();
        
      } catch (e) {
        console.error('Ëµ§‰ºùÁ•®„Ç®„É©„Éº:', e);
        await showCustomAlert({
          title: '„Ç®„É©„Éº',
          message: 'Ëµ§‰ºùÁ•®Âá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message,
          type: 'error'
        });
      }
    };
    
    // ========== „É¨„Ç∑„Éº„Éà„ÉªÈ†òÂèéÊõ∏Ë°®Á§∫Ê©üËÉΩ ==========
    window.reprintReceipt = async function(orderId) {
      try {
        const order = historyOrders.find(o => o.id === orderId);
        if (!order) {
          await showCustomAlert({
            icon: '‚ö†Ô∏è',
            title: '„Ç®„É©„Éº',
            message: 'Ê≥®Êñá„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì',
            btnClass: 'modal-btn-danger'
          });
          return;
        }
        
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        const orderData = orderDoc.exists() ? orderDoc.data() : {};
        
        // Ê≥®ÊñáÁï™Âè∑„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        let orderNumber = order.orderNumber || orderData.orderNumber || Date.now().toString().slice(-6);
        
        const receiptData = {
          orderNum: orderNumber,
          orderNumber: orderNumber,
          tableNumber: order.tableNumber || orderData.tableNumber || '',
          timestamp: order.timestamp?.toDate?.() || new Date(),
          items: order.items || [],
          total: order.totalAmount || 0,
          tax8Total: orderData.tax8Total || order.tax8Total || 0,
          tax10Total: orderData.tax10Total || order.tax10Total || 0,
          bagNeeded: orderData.bagNeeded || order.bagNeeded || false,
          bagQuantity: orderData.bagQuantity || order.bagQuantity || 0,
          bagPrice: orderData.bagPrice || order.bagPrice || 0,
          paymentMethod: order.paymentMethod || orderData.paymentMethod || ''
        };
        
        await showReceiptDisplay(receiptData);
        
      } catch (error) {
        console.error('„É¨„Ç∑„Éº„ÉàË°®Á§∫„Ç®„É©„Éº:', error);
        await showCustomAlert({
          icon: '‚ùå',
          title: '„Ç®„É©„Éº',
          message: '„É¨„Ç∑„Éº„Éà„ÅÆË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü',
          btnClass: 'modal-btn-danger'
        });
      }
    };
    
    window.reprintInvoice = async function(orderId) {
      try {
        const order = historyOrders.find(o => o.id === orderId);
        if (!order) {
          await showCustomAlert({
            icon: '‚ö†Ô∏è',
            title: '„Ç®„É©„Éº',
            message: 'Ê≥®Êñá„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì',
            btnClass: 'modal-btn-danger'
          });
          return;
        }
        
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        const orderData = orderDoc.exists() ? orderDoc.data() : {};
        
        // Ê≥®ÊñáÁï™Âè∑„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        let orderNumber = order.orderNumber || orderData.orderNumber || Date.now().toString().slice(-6);
        
        const invoiceData = {
          orderNum: orderNumber,
          orderNumber: orderNumber,
          tableNumber: order.tableNumber || orderData.tableNumber || '',
          timestamp: order.timestamp?.toDate?.() || new Date(),
          items: order.items || [],
          total: order.totalAmount || 0,
          tax8Total: orderData.tax8Total || order.tax8Total || 0,
          tax10Total: orderData.tax10Total || order.tax10Total || 0,
          bagNeeded: orderData.bagNeeded || order.bagNeeded || false,
          bagQuantity: orderData.bagQuantity || order.bagQuantity || 0,
          bagPrice: orderData.bagPrice || order.bagPrice || 0,
          paymentMethod: order.paymentMethod || orderData.paymentMethod || ''
        };
        
        await showInvoiceDisplay(invoiceData);
        
      } catch (error) {
        console.error('È†òÂèéÊõ∏Ë°®Á§∫„Ç®„É©„Éº:', error);
        await showCustomAlert({
          icon: '‚ùå',
          title: '„Ç®„É©„Éº',
          message: 'È†òÂèéÊõ∏„ÅÆË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü',
          btnClass: 'modal-btn-danger'
        });
      }
    };
    
    // ========== Â±•Ê≠¥„Åã„ÇâÊ≥®ÊñáÁ∑®ÈõÜ ==========
    
    let currentEditingOrder = null;
    
    window.editOrderFromHistory = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        if (!orderDoc.exists()) {
          await showCustomAlert({ icon: '‚ö†', title: '„Ç®„É©„Éº', message: 'Ê≥®Êñá„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', btnClass: 'modal-btn-danger' });
          return;
        }
        
        const orderData = orderDoc.data();
        
        currentEditingOrder = {
          id: orderId,
          ...orderData,
          originalTotalAmount: orderData.totalAmount,
          originalPaymentMethod: orderData.paymentMethod
        };
        
        // ÊîØÊâïÊñπÊ≥ï„ÅÆÈÅ∏ÊäûËÇ¢
        const paymentMethods = {
          'cash': 'ÁèæÈáë',
          'emoney': 'ÈõªÂ≠ê„Éû„Éç„Éº',
          'credit': '„ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„Éâ'
        };
        
        let paymentMethodOptions = '';
        Object.keys(paymentMethods).forEach(method => {
          const selected = orderData.paymentMethod === method ? 'selected' : '';
          paymentMethodOptions += `<option value="${method}" ${selected}>${paymentMethods[method]}</option>`;
        });
        
        // ÂïÜÂìÅ„É™„Çπ„Éà
        let itemsHtml = '';
        if (orderData.items && orderData.items.length > 0) {
          orderData.items.forEach((item, index) => {
            // „Éà„ÉÉ„Éî„É≥„Ç∞Ë°®Á§∫
            let toppingsHtml = '';
            if (item.toppingDetails && item.toppingDetails.length > 0) {
              const groupedBySet = {};
              item.toppingDetails.forEach(detail => {
                if (!groupedBySet[detail.setName]) {
                  groupedBySet[detail.setName] = [];
                }
                groupedBySet[detail.setName].push(detail.optionName);
              });
              
              toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
                return `
                  <div style="font-size: 12px; color: #666; font-weight: bold; margin-top: 5px;">${setName}</div>
                  ${options.map(opt => `<div style="font-size: 12px; color: #666; margin-left: 10px;">„Éª${opt}</div>`).join('')}
                `;
              }).join('');
            } else if (item.toppingsData && item.toppingsData.length > 0) {
              const groupedBySet = {};
              item.toppingsData.forEach(topping => {
                const setName = topping.setName || '„Éà„ÉÉ„Éî„É≥„Ç∞';
                if (!groupedBySet[setName]) {
                  groupedBySet[setName] = [];
                }
                groupedBySet[setName].push(topping.name);
              });
              
              toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
                return `
                  <div style="font-size: 12px; color: #666; font-weight: bold; margin-top: 5px;">${setName}</div>
                  ${options.map(opt => `<div style="font-size: 12px; color: #666; margin-left: 10px;">„Éª${opt}</div>`).join('')}
                `;
              }).join('');
            } else if (item.toppings && item.toppings !== '„Å™„Åó' && item.toppings !== 'Ê®ôÊ∫ñ„Éà„ÉÉ„Éî„É≥„Ç∞') {
              toppingsHtml = `<div style="font-size: 12px; color: #666;">„Éà„ÉÉ„Éî„É≥„Ç∞: ${item.toppings}</div>`;
            }
            
            itemsHtml += `
              <div style="padding: 10px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong>${item.name}</strong>
                    ${toppingsHtml}
                  </div>
                  <button onclick="playTapSound(); removeItemFromOrder(${index})" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">ÂâäÈô§</button>
                </div>
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                  <label>Êï∞Èáè:</label>
                  <input type="number" value="${item.quantity}" onchange="playTapSound(); updateItemQuantity(${index}, this.value)" min="1" style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                  <span style="margin-left: auto; font-weight: bold;">¬•${((item.price + (item.toppingPrice || 0)) * item.quantity).toLocaleString()}</span>
                </div>
              </div>
            `;
          });
        }
        
        const content = document.getElementById('editOrderContent');
        content.innerHTML = `
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Ê≥®ÊñáÁï™Âè∑</label>
            <div style="font-size: 24px; color: #667eea;">#${orderData.orderNumber || 0}</div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">„ÉÜ„Éº„Éñ„É´Áï™Âè∑</label>
            <input type="text" id="editTableNumber" value="${orderData.tableNumber || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÊîØÊâïÊñπÊ≥ï</label>
            <select id="editPaymentMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
              ${paymentMethodOptions}
            </select>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">Ê≥®ÊñáÂïÜÂìÅ</label>
            ${itemsHtml || '<div style="text-align: center; padding: 20px; color: #999;">ÂïÜÂìÅ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>'}
          </div>
          
          <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; text-align: right;">
            <span style="font-size: 18px; font-weight: bold;">ÂêàË®à: </span>
            <span id="editTotalAmount" style="font-size: 24px; font-weight: bold; color: #1976d2;">¬•${(orderData.totalAmount || 0).toLocaleString()}</span>
          </div>
        `;
        
        // „Éú„Çø„É≥„ÇíÂãïÁöÑ„Å´ÁîüÊàê
        const buttonsContainer = document.getElementById('editOrderButtons');
        if (orderData.paidAt) {
          // ‰ºöË®àÊ∏à„ÅøÊ≥®ÊñáÔºöËµ§‰ºùÁ•®
          buttonsContainer.innerHTML = `
            <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="playTapSound(); saveOrderEdit()">‰øùÂ≠ò</button>
            <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="playTapSound(); redSlipFromEdit()"> Ëµ§‰ºùÁ•®</button>
            <button class="btn btn-secondary" style="flex: 1;" onclick="playTapSound(); closeEditOrderModal()">„Ç≠„É£„É≥„Çª„É´</button>
          `;
        } else {
          // Êú™‰ºöË®àÊ≥®Êñá
          if (orderData.deleted) {
            // ÂâäÈô§Ê∏à„ÅøÊú™‰ºöË®àÊ≥®ÊñáÔºöÂæ©ÂÖÉÂèØËÉΩ
            buttonsContainer.innerHTML = `
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="playTapSound(); saveOrderEdit()">‰øùÂ≠ò</button>
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white;" onclick="playTapSound(); restoreOrder()">Ê≥®Êñá„ÇíÂæ©ÂÖÉ</button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="playTapSound(); closeEditOrderModal()">„Ç≠„É£„É≥„Çª„É´</button>
            `;
          } else {
            // ÈÄöÂ∏∏„ÅÆÊú™‰ºöË®àÊ≥®ÊñáÔºöÂèñÊ∂àÂèØËÉΩ
            buttonsContainer.innerHTML = `
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="playTapSound(); saveOrderEdit()">‰øùÂ≠ò</button>
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="playTapSound(); deleteOrderFromEdit()">üóë Ê≥®ÊñáÂèñÊ∂à</button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="playTapSound(); closeEditOrderModal()">„Ç≠„É£„É≥„Çª„É´</button>
            `;
          }
        }
        
        document.getElementById('editOrderModal').style.display = 'flex';
        
      } catch (e) {
        console.error('Ê≥®ÊñáÁ∑®ÈõÜ„Ç®„É©„Éº:', e);
        await showCustomAlert({
          title: '„Ç®„É©„Éº',
          message: 'Ê≥®Êñá„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message,
          type: 'error'
        });
      }
    };
    
    // Ê≥®ÊñáÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    window.closeEditOrderModal = function() {
      document.getElementById('editOrderModal').style.display = 'none';
      currentEditingOrder = null;
    };
    
    // ÂïÜÂìÅ„ÇíÊ≥®Êñá„Åã„ÇâÂâäÈô§
    window.removeItemFromOrder = async function(index) {
      if (!currentEditingOrder) return;
      
      const item = currentEditingOrder.items[index];
      const itemName = item.name || 'ÂïÜÂìÅ';
      const itemPrice = (item.price + (item.toppingPrice || 0)) * item.quantity;
      
      const confirmed = confirm(`${itemName}\n¬•${itemPrice.toLocaleString()}\n\n„Åì„ÅÆÂïÜÂìÅ„ÇíÊ≥®Êñá„Åã„ÇâÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`);
      
      if (confirmed) {
        try {
          // ÂïÜÂìÅ„ÇíÈÖçÂàó„Åã„ÇâÂâäÈô§
          currentEditingOrder.items.splice(index, 1);
          
          // ÂêàË®àÈáëÈ°ç„ÇíÂÜçË®àÁÆó
          let total = 0;
          let tax8Total = 0;
          let tax10Total = 0;
          
          currentEditingOrder.items.forEach(item => {
            const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
            total += itemTotal;
            
            // Á®éÁéáÂà•ÈõÜË®à
            if (item.taxRate === 8) {
              tax8Total += itemTotal;
            } else {
              tax10Total += itemTotal;
            }
          });
          
          currentEditingOrder.totalAmount = total;
          currentEditingOrder.tax8Total = tax8Total;
          currentEditingOrder.tax10Total = tax10Total;
          
          // Firestore„Å´‰øùÂ≠ò
          await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), {
            items: currentEditingOrder.items,
            totalAmount: total,
            tax8Total: tax8Total,
            tax10Total: tax10Total,
            updatedAt: window.Timestamp.now()
          });
          
          // Ë°®Á§∫„ÇíÊõ¥Êñ∞Ôºà„É¢„Éº„ÉÄ„É´„ÇíÂÜçÊèèÁîªÔºâ
          editOrderFromHistory(currentEditingOrder.id);
          
          await showCustomAlert({ icon: '', title: '„ÅäÁü•„Çâ„Åõ', message: 'ÂïÜÂìÅ„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü', btnClass: 'modal-btn-primary' });
          
        } catch (e) {
          console.error('ÂïÜÂìÅÂâäÈô§„Ç®„É©„Éº:', e);
          await showCustomAlert({
            title: '„Ç®„É©„Éº',
            message: 'ÂïÜÂìÅ„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message,
            type: 'error'
          });
        }
      }
    };
    
    // ÂïÜÂìÅ„ÅÆÊï∞Èáè„ÇíÊõ¥Êñ∞
    window.updateItemQuantity = function(index, newQuantity) {
      if (!currentEditingOrder) return;
      
      const quantity = parseInt(newQuantity) || 1;
      currentEditingOrder.items[index].quantity = quantity;
      
      // ÂêàË®àÈáëÈ°ç„ÇíÂÜçË®àÁÆó
      let total = 0;
      currentEditingOrder.items.forEach(item => {
        total += (item.price + (item.toppingPrice || 0)) * item.quantity;
      });
      currentEditingOrder.totalAmount = total;
      
      // ÂêàË®àÈáëÈ°ç„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
      document.getElementById('editTotalAmount').textContent = `¬•${total.toLocaleString()}`;
    };
    
    // Ê≥®Êñá„ÅÆÂ§âÊõ¥„Çí‰øùÂ≠ò
    window.saveOrderEdit = async function() {
      if (!currentEditingOrder) return;
      
      try {
        const tableNumber = document.getElementById('editTableNumber').value;
        const paymentMethod = document.getElementById('editPaymentMethod').value;
        
        const oldPaymentMethod = currentEditingOrder.originalPaymentMethod || currentEditingOrder.paymentMethod;
        const oldTotalAmount = currentEditingOrder.originalTotalAmount || currentEditingOrder.totalAmount;
        const newTotalAmount = currentEditingOrder.totalAmount;
        
        // ÂÖÉ„ÅÆpaidAt„Åæ„Åü„ÅØtimestamp„Åã„ÇâÊó•‰ªò„ÇíÂèñÂæó
        let originalDateStr = null;
        let isUnpaidOrder = false;
        
        try {
          let dateToUse = null;
          
          if (currentEditingOrder.paidAt) {
            dateToUse = currentEditingOrder.paidAt.toDate();
          } else if (currentEditingOrder.timestamp) {
            dateToUse = currentEditingOrder.timestamp.toDate();
            isUnpaidOrder = true;
          }
          
          if (dateToUse) {
            originalDateStr = window.getBusinessDay(dateToUse).str;
          } else {
            throw new Error('paidAt„ÇÇtimestamp„ÇÇÂ≠òÂú®„Åó„Åæ„Åõ„Çì');
          }
        } catch (error) {
          console.error('Êó•‰ªò„ÅÆÂ§âÊèõ„Ç®„É©„Éº:', error);
          await showCustomAlert({ icon: '', title: '„ÅäÁü•„Çâ„Åõ', message: 'Êó•‰ªò„ÅÆÂèñÂæó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇÊ≥®Êñá„Éá„Éº„Çø„ÅÆ„ÅøÊõ¥Êñ∞„Åó„Åæ„Åô„ÄÇ', btnClass: 'modal-btn-primary' });
          
          await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), {
            tableNumber: tableNumber,
            paymentMethod: paymentMethod,
            items: currentEditingOrder.items,
            totalAmount: currentEditingOrder.totalAmount
          });
          
          closeEditOrderModal();
          await loadHistory();
          return;
        }
        
        // Ê≥®Êñá„ÇíÊõ¥Êñ∞
        const orderUpdates = {
          tableNumber: tableNumber,
          paymentMethod: paymentMethod,
          items: currentEditingOrder.items,
          totalAmount: currentEditingOrder.totalAmount,
          tax8Total: currentEditingOrder.tax8Total || 0,
          tax10Total: currentEditingOrder.tax10Total || 0
        };
        
        // Êú™‰ºöË®à„ÅÆÊ≥®Êñá„ÇíÁ∑®ÈõÜ„Åó„ÅüÂ†¥Âêà„ÅØ„ÄÅ‰ºöË®àÊ∏à„Åø„Å´„Åô„Çã
        if (isUnpaidOrder) {
          orderUpdates.paidAt = currentEditingOrder.timestamp;
          orderUpdates.notifiedPaid = true;
          
          await showCustomAlert({ icon: '', title: '„ÅäÁü•„Çâ„Åõ', message: `Ê≥®Êñá„ÇíÊõ¥Êñ∞„Åó„ÄÅ‰ºöË®àÊ∏à„Åø„Å®„Åó„Åæ„Åó„Åü\n\n‰ºöË®àÊó•ÊôÇ: ${originalDateStr}`, btnClass: 'modal-btn-primary' });
        }
        
        await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), orderUpdates);
        
        // dailySales„Éá„Éº„Çø„ÅÆ‰øÆÊ≠£
        if (currentEditingOrder.paidAt || isUnpaidOrder) {
          await updateDailySalesForEdit(originalDateStr, oldPaymentMethod, oldTotalAmount, paymentMethod, newTotalAmount, currentEditingOrder);
        }
        
        await showCustomAlert({ icon: '', title: '„ÅäÁü•„Çâ„Åõ', message: 'Ê≥®Êñá„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', btnClass: 'modal-btn-primary' });
        
        closeEditOrderModal();
        await loadHistory();
        
      } catch (e) {
        console.error('Ê≥®Êñá‰øùÂ≠ò„Ç®„É©„Éº:', e);
        await showCustomAlert({
          title: '„Ç®„É©„Éº',
          message: 'Ê≥®Êñá„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message,
          type: 'error'
        });
      }
    };
    
    // dailySales„Éá„Éº„Çø„ÇíÁ∑®ÈõÜÊôÇ„Å´Êõ¥Êñ∞
    async function updateDailySalesForEdit(dateStr, oldMethod, oldAmount, newMethod, newAmount, order) {
      try {
        const dailySalesRef = window.getStoreDoc('dailySales', dateStr);
        const dailySalesDoc = await window.getDoc(dailySalesRef);
        
        if (!dailySalesDoc.exists()) {
          console.warn('dailySales„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì:', dateStr);
          return;
        }
        
        const dailyData = dailySalesDoc.data();
        
        // Êóß„Éá„Éº„Çø„ÇíÊ∏õÁÆó
        const oldCash = (oldMethod === 'cash') ? oldAmount : 0;
        const oldEmone = (oldMethod === 'emoney') ? oldAmount : 0;
        const oldCredit = (oldMethod === 'credit') ? oldAmount : 0;
        
        // Êñ∞„Éá„Éº„Çø„ÇíÂä†ÁÆó
        const newCash = (newMethod === 'cash') ? newAmount : 0;
        const newEmone = (newMethod === 'emoney') ? newAmount : 0;
        const newCredit = (newMethod === 'credit') ? newAmount : 0;
        
        // Á®éÈáë„ÅÆÂ∑ÆÂàÜ„ÇíË®àÁÆó
        const oldTax8 = order.originalTax8Total || 0;
        const oldTax10 = order.originalTax10Total || 0;
        const newTax8 = order.tax8Total || 0;
        const newTax10 = order.tax10Total || 0;
        
        const updateData = {
          totalSales: (dailyData.totalSales || 0) - oldAmount + newAmount,
          cashSales: (dailyData.cashSales || 0) - oldCash + newCash,
          emoneSales: (dailyData.emoneSales || 0) - oldEmone + newEmone,
          creditSales: (dailyData.creditSales || 0) - oldCredit + newCredit,
          tax8Total: (dailyData.tax8Total || 0) - oldTax8 + newTax8,
          tax10Total: (dailyData.tax10Total || 0) - oldTax10 + newTax10
        };
        
        await window.updateDoc(dailySalesRef, updateData);
      } catch (e) {
        console.error('dailySalesÊõ¥Êñ∞„Ç®„É©„Éº:', e);
      }
    }
    
    // Á∑®ÈõÜÁîªÈù¢„Åã„ÇâËµ§‰ºùÁ•®
    window.redSlipFromEdit = async function() {
      if (!currentEditingOrder) return;
      closeEditOrderModal();
      await redSlipFromHistory(currentEditingOrder.id);
    };
    
    // Á∑®ÈõÜÁîªÈù¢„Åã„ÇâÊ≥®ÊñáÂèñÊ∂à
    window.deleteOrderFromEdit = async function() {
      if (!currentEditingOrder) return;
      const confirmed = confirm(`Ê≥®Êñá #${currentEditingOrder.orderNumber} „ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åô„ÅãÔºü`);
      if (confirmed) {
        closeEditOrderModal();
        await deleteOrderFromHistory(currentEditingOrder.id);
      }
    };
    
    // Ê≥®Êñá„ÇíÂæ©ÂÖÉ
    window.restoreOrder = async function() {
      if (!currentEditingOrder) return;
      const confirmed = await showCustomAlert({
        title: 'Ê≥®Êñá„ÇíÂæ©ÂÖÉ',
        message: `Ê≥®Êñá #${currentEditingOrder.orderNumber} „ÇíÂæ©ÂÖÉ„Åó„Åæ„Åô„Åã?`,
        type: 'warning',
        confirmText: 'Âæ©ÂÖÉ',
        cancelText: '„Ç≠„É£„É≥„Çª„É´'
      });
      if (confirmed) {
        closeEditOrderModal();
        await restoreOrderFromHistory(currentEditingOrder.id);
      }
    };
    
    // Ê≥®Êñá„ÇíÂèñÊ∂àÔºàÂâäÈô§Ê∏à„Åø„Éï„É©„Ç∞„ÇíÁ´ã„Å¶„ÇãÔºâ
    window.deleteOrderFromHistory = async function(orderId) {
      try {
        const confirmed = confirm('„Åì„ÅÆÊ≥®Êñá„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åô„ÅãÔºü');
        if (!confirmed) return;
        
        await window.updateDoc(window.getStoreDoc('orders', orderId), {
          deleted: true,
          deletedAt: window.Timestamp.now()
        });
        
        await showCustomAlert({ icon: '', title: '„ÅäÁü•„Çâ„Åõ', message: 'Ê≥®Êñá„ÇíÂèñ„ÇäÊ∂à„Åó„Åæ„Åó„Åü', btnClass: 'modal-btn-primary' });
        await loadHistory();
      } catch (e) {
        console.error('Ê≥®ÊñáÂèñÊ∂à„Ç®„É©„Éº:', e);
        await showCustomAlert({
          title: '„Ç®„É©„Éº',
          message: 'Ê≥®Êñá„ÅÆÂèñ„ÇäÊ∂à„Åó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message,
          type: 'error'
        });
      }
    };
    
    // Ê≥®Êñá„ÇíÂæ©ÂÖÉ
    window.restoreOrderFromHistory = async function(orderId) {
      try {
        const confirmed = await showCustomAlert({
          title: 'Ê≥®Êñá„ÇíÂæ©ÂÖÉ',
          message: '„Åì„ÅÆÊ≥®Êñá„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åô„Åã?',
          type: 'warning',
          confirmText: 'Âæ©ÂÖÉ',
          cancelText: '„Ç≠„É£„É≥„Çª„É´'
        });
        if (!confirmed) return;
        
        await window.updateDoc(window.getStoreDoc('orders', orderId), {
          deleted: false,
          deletedAt: null
        });
        
        await showCustomAlert({ icon: '', title: '„ÅäÁü•„Çâ„Åõ', message: 'Ê≥®Êñá„ÇíÂæ©ÂÖÉ„Åó„Åæ„Åó„Åü', btnClass: 'modal-btn-primary' });
        await loadHistory();
      } catch (e) {
        console.error('Ê≥®ÊñáÂæ©ÂÖÉ„Ç®„É©„Éº:', e);
        await showCustomAlert({
          title: '„Ç®„É©„Éº',
          message: 'Ê≥®Êñá„ÅÆÂæ©ÂÖÉ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + e.message,
          type: 'error'
        });
      }
    };
    
    
    // ========== üí∏ ÊîØÂá∫Ê©üËÉΩ ==========
    
    window.showExpenseModal = async function() {
      // Ê©üËÉΩ„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('expenseModal').style.display = 'flex';
      
      // Êú¨Êó•„ÅÆÊó•‰ªò„Çí„Éá„Éï„Ç©„É´„Éà„Å´Ë®≠ÂÆö
      const now = new Date();
      const dateStr = window.getBusinessDay(now).str;
      document.getElementById('expenseDateInput').value = dateStr;
      
      await loadExpensesByDate();
    };
    
    window.closeExpenseModal = function() {
      document.getElementById('expenseModal').style.display = 'none';
    };
    
    window.loadExpensesByDate = async function() {
      const dateStr = document.getElementById('expenseDateInput').value;
      if (!dateStr) return;
      
      try {
        const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
        const tbody = document.getElementById('expenseTableBody');
        tbody.innerHTML = '';
        
        if (expenseDoc.exists()) {
          const data = expenseDoc.data();
          const items = data.items || [];
          
          items.forEach(item => {
            addExpenseRowWithData(item);
          });
        } else {
          addExpenseRow();
        }
        
        calculateExpenseTotal();
      } catch (e) {
        console.error('ÊîØÂá∫Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
        addExpenseRow();
      }
    };
    
    window.addExpenseRow = function() {
      addExpenseRowWithData({});
    };
    
    function addExpenseRowWithData(data) {
      const tbody = document.getElementById('expenseTableBody');
      const row = tbody.insertRow();
      row.innerHTML = `
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="text" value="${data.storeName || ''}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Â∫óÂêç">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <select style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="ÂéüÊùêÊñôË≤ª" ${data.category === 'ÂéüÊùêÊñôË≤ª' ? 'selected' : ''}>ÂéüÊùêÊñôË≤ª</option>
            <option value="ÂÖâÁÜ±Ë≤ª" ${data.category === 'ÂÖâÁÜ±Ë≤ª' ? 'selected' : ''}>ÂÖâÁÜ±Ë≤ª</option>
            <option value="Ê∂àËÄóÂìÅË≤ª" ${data.category === 'Ê∂àËÄóÂìÅË≤ª' ? 'selected' : ''}>Ê∂àËÄóÂìÅË≤ª</option>
            <option value="„Åù„ÅÆ‰ªñ" ${data.category === '„Åù„ÅÆ‰ªñ' ? 'selected' : ''}>„Åù„ÅÆ‰ªñ</option>
          </select>
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="text" value="${data.detail || ''}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="Ë©≥Á¥∞">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="number" value="${data.amount || ''}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="ÈáëÈ°ç" onchange="playTapSound(); calculateExpenseTotal()">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
          <button onclick="playTapSound(); this.closest('tr').remove(); calculateExpenseTotal();" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">ÂâäÈô§</button>
        </td>
      `;
    }
    
    function calculateExpenseTotal() {
      const tbody = document.getElementById('expenseTableBody');
      const rows = tbody.querySelectorAll('tr');
      let total = 0;
      
      rows.forEach(row => {
        const amountInput = row.querySelector('input[type="number"]');
        const amount = parseInt(amountInput.value) || 0;
        total += amount;
      });
      
      document.getElementById('expenseTotal').textContent = total.toLocaleString();
    }
    
    window.saveExpenses = async function() {
      const dateStr = document.getElementById('expenseDateInput').value;
      if (!dateStr) {
        await showCustomAlert({ icon: '', title: '„Ç®„É©„Éº', message: 'Êó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ', btnClass: 'modal-btn-danger' });
        return;
      }
      
      const tbody = document.getElementById('expenseTableBody');
      const rows = tbody.querySelectorAll('tr');
      const items = [];
      let total = 0;
      
      rows.forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        const storeName = inputs[0].value;
        const category = inputs[1].value;
        const detail = inputs[2].value;
        const amount = parseInt(inputs[3].value) || 0;
        
        if (storeName || category || detail || amount) {
          items.push({ storeName, category, detail, amount });
          total += amount;
        }
      });
      
      try {
        await window.setDoc(window.getStoreDoc('expenses', dateStr), {
          date: dateStr,
          items: items,
          total: total,
          updatedAt: window.Timestamp.now()
        });
        
        await showCustomAlert({ 
          icon: '', 
          title: '‰øùÂ≠òÂÆå‰∫Ü', 
          message: 'ÊîØÂá∫„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü', 
          btnClass: 'modal-btn-success' 
        });
      } catch (e) {
        console.error('ÊîØÂá∫‰øùÂ≠ò„Ç®„É©„Éº:', e);
        await showCustomAlert({ 
          icon: '', 
          title: '„Ç®„É©„Éº', 
          message: 'ÊîØÂá∫„ÅÆ‰øùÂ≠ò„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    // ========== üìä ÊúàÊ¨°„É¨„Éù„Éº„ÉàÊ©üËÉΩ ==========
    
    window.showMonthlyReportModal = function() {
      // Ê©üËÉΩ„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('monthlyReportModal').style.display = 'flex';
      
      // „Éá„Éï„Ç©„É´„Éà„Åß‰ªäÊúà„ÅÆÁØÑÂõ≤„ÇíË®≠ÂÆö
      const now = new Date();
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      
      document.getElementById('reportStartDate').value = `${firstDay.getFullYear()}-${String(firstDay.getMonth()+1).padStart(2,'0')}-${String(firstDay.getDate()).padStart(2,'0')}`;
      document.getElementById('reportEndDate').value = `${lastDay.getFullYear()}-${String(lastDay.getMonth()+1).padStart(2,'0')}-${String(lastDay.getDate()).padStart(2,'0')}`;
    };
    
    window.closeMonthlyReportModal = function() {
      document.getElementById('monthlyReportModal').style.display = 'none';
    };
    
    // ===== ÊúüÈñì„Ç∏„É£„Éº„Éä„É´ÁîüÊàê =====
    window.generatePeriodJournal = async function() {
      try {
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;
        
        if (!startDate || !endDate) {
          await showCustomAlert({
            title: 'Ë≠¶Âëä',
            message: 'ÈñãÂßãÊó•„Å®ÁµÇ‰∫ÜÊó•„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
            type: 'warning'
          });
          return;
        }
        
        if (startDate > endDate) {
          await showCustomAlert({
            title: 'Ë≠¶Âëä',
            message: 'ÈñãÂßãÊó•„ÅØÁµÇ‰∫ÜÊó•„Çà„ÇäÂâç„ÅÆÊó•‰ªò„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
            type: 'warning'
          });
          return;
        }
        
        console.log(`üìä ÊúüÈñì„Ç∏„É£„Éº„Éä„É´ÁîüÊàê: ${startDate} ÔΩû ${endDate}`);
        
        const container = document.getElementById('monthlyReportContent');
        container.innerHTML = '<div style="text-align: center; padding: 40px;">„Ç∏„É£„Éº„Éä„É´ÁîüÊàê‰∏≠...</div>';
        
        // ÊúüÈñìÂÜÖ„ÅÆÂÖ®Êó•‰ªò„ÇíÁîüÊàê
        const start = new Date(startDate);
        const end = new Date(endDate);
        const dates = [];
        
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
          dates.push(dateStr);
        }
        
        // ÂêÑÊó•‰ªò„ÅÆÂ£≤‰∏ä„Éá„Éº„Çø„ÇíÂèñÂæó„Åó„Å¶ÂêàË®à
        let totalCustomerCount = 0;
        let totalItems = 0;
        let totalCashSales = 0;
        let totalEmoneSales = 0;
        let totalCreditSales = 0;
        let totalDiscount = 0;
        let totalTax8 = 0;
        let totalTax10 = 0;
        let totalDrawerOpen = 0;
        let totalRedSlipCount = 0;  // üÜï Ëµ§‰ºùÁ•®‰ª∂Êï∞
        let totalRedSlipAmount = 0;  // üÜï Ëµ§‰ºùÁ•®ÈáëÈ°ç
        let totalRedSlipTax8 = 0;  // üÜï Ëµ§‰ºùÁ•®8%Á®éÈáë
        let totalRedSlipTax10 = 0;  // üÜï Ëµ§‰ºùÁ•®10%Á®éÈáë
        let totalRedSlipTax8Inclusive = 0;  // üÜï Ëµ§‰ºùÁ•®8%ÂÜÖÁ®é
        let totalRedSlipTax10Inclusive = 0;  // üÜï Ëµ§‰ºùÁ•®10%ÂÜÖÁ®é
        let totalRedSlipTax8Exclusive = 0;  // üÜï Ëµ§‰ºùÁ•®8%Â§ñÁ®é
        let totalRedSlipTax10Exclusive = 0;  // üÜï Ëµ§‰ºùÁ•®10%Â§ñÁ®é
        let totalExpense = 0;
        let totalLaborCost = 0;
        const itemCounts = {}; // ÂïÜÂìÅÂà•„Ç´„Ç¶„É≥„Éà
        
        // orders„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Åã„ÇâÁõ¥Êé•ÂïÜÂìÅ„Éá„Éº„Çø„ÇíÈõÜË®à
        const ordersQuery = window.query(
          window.getStoreCollection('orders'),
          window.where('paidAt', '!=', null)
        );
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          // paidAt„Çí‰ΩøÁî®„Åó„Å¶‰ºöË®àÊó•ÊôÇ„ÇíÂèñÂæó
          if (!data.paidAt) return;
          
          const orderDate = data.paidAt.toDate();
          const orderDateStr = window.getBusinessDay(orderDate).str;
          
          // ÊúüÈñìÂÜÖ„ÅÆÊ≥®Êñá„ÅÆ„Åø
          if (dates.includes(orderDateStr) && data.items) {
            data.items.forEach(item => {
              itemCounts[item.name] = (itemCounts[item.name] || 0) + (item.quantity || 1);
            });
          }
        });
        
        console.log(' orders„Åã„ÇâÈõÜË®à„Åó„ÅüÂïÜÂìÅ„Éá„Éº„Çø:', itemCounts);
        
        for (const dateStr of dates) {
          // Â£≤‰∏ä„Éá„Éº„Çø
          const salesDoc = await window.getDoc(window.getStoreDoc('dailySales', dateStr));
          if (salesDoc.exists()) {
            const data = salesDoc.data();
            totalCustomerCount += data.customerCount || 0;
            totalItems += data.totalItems || 0;
            totalCashSales += data.cashSales || 0;
            totalEmoneSales += data.emoneSales || 0;
            totalCreditSales += data.creditSales || 0;
            totalDiscount += data.totalDiscount || 0;
            totalTax8 += data.tax8Total || 0;
            totalTax10 += data.tax10Total || 0;
            totalDrawerOpen += data.drawerOpenCount || 0;
            totalRedSlipCount += data.redSlipCount || 0;  // üÜï Ëµ§‰ºùÁ•®‰ª∂Êï∞
            totalRedSlipAmount += data.redSlipAmount || 0;  // üÜï Ëµ§‰ºùÁ•®ÈáëÈ°ç
            totalRedSlipTax8 += data.redSlipTax8Total || 0;  // üÜï Ëµ§‰ºùÁ•®8%Á®éÈáë
            totalRedSlipTax10 += data.redSlipTax10Total || 0;  // üÜï Ëµ§‰ºùÁ•®10%Á®éÈáë
            totalRedSlipTax8Inclusive += data.redSlipTax8Inclusive || 0;  // üÜï Ëµ§‰ºùÁ•®8%ÂÜÖÁ®é
            totalRedSlipTax10Inclusive += data.redSlipTax10Inclusive || 0;  // üÜï Ëµ§‰ºùÁ•®10%ÂÜÖÁ®é
            totalRedSlipTax8Exclusive += data.redSlipTax8Exclusive || 0;  // üÜï Ëµ§‰ºùÁ•®8%Â§ñÁ®é
            totalRedSlipTax10Exclusive += data.redSlipTax10Exclusive || 0;  // üÜï Ëµ§‰ºùÁ•®10%Â§ñÁ®é
          }
          
          // ÊîØÂá∫„Éá„Éº„Çø
          const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
          if (expenseDoc.exists()) {
            totalExpense += expenseDoc.data().total || 0;
          }
          
          // ‰∫∫‰ª∂Ë≤ª„Éá„Éº„Çø
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(doc => {
            const attData = doc.data();
            if (attData.date === dateStr) {
              // Êó¢„Å´Ë®àÁÆóÊ∏à„Åø„ÅÆÁ∑èË≥ÉÈáë„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØ„Åù„Çå„Çí‰ΩøÁî®
              if (attData.totalWage && attData.totalWage > 0) {
                totalLaborCost += attData.totalWage;
              } else if (attData.clockIn && attData.clockOut) {
                // Á∑èË≥ÉÈáë„Åå„Å™„ÅÑÂ†¥Âêà„ÅØË®àÁÆó„Åô„Çã
                const clockIn = new Date(`${dateStr} ${attData.clockIn}`);
                const clockOut = new Date(`${dateStr} ${attData.clockOut}`);
                let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                
                if (attData.breakStart1 && attData.breakEnd1) {
                  const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                  const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                  workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                }
                if (attData.breakStart2 && attData.breakEnd2) {
                  const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                  const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                  workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                }
                
                const hourlyRate = attData.hourlyRate || 1150;
                
                // Ââ≤Â¢óË≥ÉÈáë„ÅÆË®àÁÆó
                let totalWage = 0;
                const isHoliday = attData.isHoliday || false;
                
                // ÊôÇÈñì„Åî„Å®„Å´Ââ≤Â¢óÁéá„ÇíË®àÁÆó
                let currentTime = new Date(clockIn);
                const endTime = new Date(clockOut);
                
                while (currentTime < endTime) {
                  const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                  const segmentEnd = nextHour > endTime ? endTime : nextHour;
                  
                  // ‰ºëÊÜ©ÊôÇÈñì„ÇíÈô§Â§ñ
                  let isBreak = false;
                  if (attData.breakStart1 && attData.breakEnd1) {
                    const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                    const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                    if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                      isBreak = true;
                    }
                  }
                  if (attData.breakStart2 && attData.breakEnd2) {
                    const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                    const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                    if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                      isBreak = true;
                    }
                  }
                  
                  if (!isBreak) {
                    const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                    const hour = currentTime.getHours();
                    
                    let rate = 1.0;
                    if (isHoliday) {
                      // ‰ºëÊó•Âá∫Âã§: Âü∫Êú¨35%Â¢ó
                      rate = 1.35;
                      // 22ÊôÇÔΩû5ÊôÇ„ÅØÊ∑±Â§úÂâ≤Â¢ó25%„ÇíËøΩÂä†ÔºàÂêàË®à60%Â¢óÔºâ
                      if (hour >= 22 || hour < 5) {
                        rate = 1.60;
                      }
                    } else {
                      // Âπ≥Êó•: 22ÊôÇÔΩû5ÊôÇ„ÅØÊ∑±Â§úÂâ≤Â¢ó25%
                      if (hour >= 22 || hour < 5) {
                        rate = 1.25;
                      }
                    }
                    
                    totalWage += segmentHours * hourlyRate * rate;
                  }
                  
                  currentTime = segmentEnd;
                }
                
                totalLaborCost += totalWage;
              }
            }
          });
        }
        
        // Ë®àÁÆó
        const totalSales = totalCashSales + totalEmoneSales + totalCreditSales;
        const averageSpend = totalCustomerCount > 0 ? Math.round(totalSales / totalCustomerCount) : 0;
        
        // üÜï Â§ñÁ®é„ÉªÂÜÖÁ®é„ÇíÂå∫Âà•„Åó„Å¶Ë®àÁÆó
        // Ê≥®Êñá„Éá„Éº„Çø„Åã„ÇâÂ§ñÁ®é„Å®ÂÜÖÁ®é„ÇíÂàÜÈõ¢
        let tax8InclusiveTotal = 0;
        let tax10InclusiveTotal = 0;
        let tax8ExclusiveTotal = 0;
        let tax10ExclusiveTotal = 0;
        // üÜï Ëµ§‰ºùÁ•®„ÅÆÂÜÖÁ®é„ÉªÂ§ñÁ®é„ÅØÊó¢„Å´dailySales„Åã„ÇâÂèñÂæóÊ∏à„Åø
        // (totalRedSlipTax8Inclusive, totalRedSlipTax10Inclusive, 
        //  totalRedSlipTax8Exclusive, totalRedSlipTax10Exclusive)
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          if (!data.paidAt || !data.items) return;
          
          const orderDate = data.paidAt.toDate();
          const orderDateStr = window.getBusinessDay(orderDate).str;
          
          if (dates.includes(orderDateStr)) {
            data.items.forEach(item => {
              const taxType = item.taxType || 'inclusive';
              const taxAmount = getTaxAmount(item, item.quantity || 1);
              
              if ((item.taxRate || 10) === 8) {
                if (taxType === 'exclusive') {
                  tax8ExclusiveTotal += taxAmount;
                } else {
                  tax8InclusiveTotal += taxAmount;
                }
              } else {
                if (taxType === 'exclusive') {
                  tax10ExclusiveTotal += taxAmount;
                } else {
                  tax10InclusiveTotal += taxAmount;
                }
              }
            });
          }
        });
        
        // üÜï Ëµ§‰ºùÁ•®„ÅÆÂÜÖÁ®é„ÉªÂ§ñÁ®é„ÅådailySales„Å´‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥Âêà„ÅØredSlips„Åã„ÇâË®àÁÆó
        if ((totalRedSlipTax8Inclusive === 0 && totalRedSlipTax8Exclusive === 0 && 
             totalRedSlipTax10Inclusive === 0 && totalRedSlipTax10Exclusive === 0) &&
            totalRedSlipCount > 0) {
          console.log('‚ö†Ô∏è dailySales„Å´Ëµ§‰ºùÁ•®„ÅÆÂÜÖÁ®é„ÉªÂ§ñÁ®é„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åü„ÇÅ„ÄÅredSlips„Åã„ÇâË®àÁÆó„Åó„Åæ„Åô');
          try {
            const redSlipsSnapshot = await window.getDocs(window.getStoreCollection('redSlips'));
            redSlipsSnapshot.forEach(doc => {
              const data = doc.data();
              if (!data.businessDate || !dates.includes(data.businessDate) || !data.items) return;
              
              data.items.forEach(item => {
                const taxType = item.taxType || 'inclusive';
                const taxAmount = getTaxAmount(item, item.quantity || 1);
                
                if ((item.taxRate || 10) === 8) {
                  if (taxType === 'exclusive') {
                    totalRedSlipTax8Exclusive += taxAmount;
                  } else {
                    totalRedSlipTax8Inclusive += taxAmount;
                  }
                } else {
                  if (taxType === 'exclusive') {
                    totalRedSlipTax10Exclusive += taxAmount;
                  } else {
                    totalRedSlipTax10Inclusive += taxAmount;
                  }
                }
              });
            });
            console.log('‚úÖ redSlips„Åã„ÇâË®àÁÆóÂÆå‰∫Ü:', {
              totalRedSlipTax8Inclusive,
              totalRedSlipTax8Exclusive,
              totalRedSlipTax10Inclusive,
              totalRedSlipTax10Exclusive
            });
          } catch (e) {
            console.error('redSlipsÂèñÂæó„Ç®„É©„Éº:', e);
          }
        }
        
        // ÊóßË®àÁÆóÔºà‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
        const tax8Excluded = Math.floor(totalTax8 / 1.08);
        const tax10Excluded = Math.floor(totalTax10 / 1.10);
        const tax8Amount = totalTax8 - tax8Excluded;
        const tax10Amount = totalTax10 - tax10Excluded;
        const totalTax = tax8Amount + tax10Amount;
        const taxExcludedTotal = tax8Excluded + tax10Excluded;
        const taxIncludedTotal = totalTax8 + totalTax10;
        const finalTotalSales = taxIncludedTotal - totalDiscount - totalExpense;
        
        const now = new Date();
        const outputTime = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        
        // „Ç∏„É£„Éº„Éä„É´„ÉÜ„Ç≠„Çπ„Éà„ÇíÁîüÊàê
        const journalText = `
=====================================
      ÊúüÈñì„Ç∏„É£„Éº„Éä„É´
=====================================
ÊúüÈñì: ${startDate} ÔΩû ${endDate}
Âá∫ÂäõÊôÇÂàª: ${outputTime}
ÂÆ¢Êï∞: ${totalCustomerCount}ÁµÑ
Á∑èÂ£≤‰∏äÁÇπÊï∞: ${totalItems}ÁÇπ
Âπ≥ÂùáÂÆ¢Âçò‰æ°: ¬•${averageSpend.toLocaleString()}
ÂêàË®àÂ£≤‰∏ä: ¬•${totalSales.toLocaleString()}

-------------------------------------
Â£≤‰∏äÂÜÖË®≥
-------------------------------------
ÁèæÈáë: ¬•${totalCashSales.toLocaleString()}
ÈõªÂ≠ê„Éû„Éç„Éº: ¬•${totalEmoneSales.toLocaleString()}
„ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„Éâ: ¬•${totalCreditSales.toLocaleString()}
ÂÄ§Âºï„Åç: ¬•${totalDiscount.toLocaleString()}

-------------------------------------
Á®éÈáëÂÜÖË®≥
-------------------------------------
„Äê8%ËªΩÊ∏õÁ®éÁéá„Äë
ÂÜÖÁ®é„ÅÆÊ∂àË≤ªÁ®é: ¬•${tax8InclusiveTotal.toLocaleString()}
Â§ñÁ®é„ÅÆÊ∂àË≤ªÁ®é: ¬•${tax8ExclusiveTotal.toLocaleString()}
8%ÂêàË®à: ¬•${(tax8InclusiveTotal + tax8ExclusiveTotal).toLocaleString()}

„Äê10%Ê®ôÊ∫ñÁ®éÁéá„Äë
ÂÜÖÁ®é„ÅÆÊ∂àË≤ªÁ®é: ¬•${tax10InclusiveTotal.toLocaleString()}
Â§ñÁ®é„ÅÆÊ∂àË≤ªÁ®é: ¬•${tax10ExclusiveTotal.toLocaleString()}
10%ÂêàË®à: ¬•${(tax10InclusiveTotal + tax10ExclusiveTotal).toLocaleString()}

Ê∂àË≤ªÁ®é„ÅÆÂêàË®à: ¬•${(tax8InclusiveTotal + tax8ExclusiveTotal + tax10InclusiveTotal + tax10ExclusiveTotal).toLocaleString()}
Á®éÊäúÂêàË®à: ¬•${taxExcludedTotal.toLocaleString()}
Á®éËæºÂêàË®à: ¬•${taxIncludedTotal.toLocaleString()}

ÊîØÂá∫: ¬•${totalExpense.toLocaleString()}
ÂêàË®àÂ£≤‰∏ä: ¬•${(taxIncludedTotal - totalExpense).toLocaleString()}
${totalRedSlipCount > 0 ? `
-------------------------------------
Ëµ§‰ºùÁ•®„ÅÆÁ®éÈáëÂÜÖË®≥
-------------------------------------
8%„ÅÆËµ§‰ºùÁ•®ÔºàÁ®éÊäúÔºâ: -¬•${Math.floor(totalRedSlipTax8 / 1.08).toLocaleString()}
8%„ÅÆËµ§‰ºùÁ•®ÔºàÁ®éËæºÔºâ: -¬•${totalRedSlipTax8.toLocaleString()}
8%„ÅÆËµ§‰ºùÁ•®„ÅÆÊ∂àË≤ªÁ®é: -¬•${(totalRedSlipTax8 - Math.floor(totalRedSlipTax8 / 1.08)).toLocaleString()}
  ÂÜÖÁ®é: -¬•${totalRedSlipTax8Inclusive.toLocaleString()}
  Â§ñÁ®é: -¬•${totalRedSlipTax8Exclusive.toLocaleString()}

10%„ÅÆËµ§‰ºùÁ•®ÔºàÁ®éÊäúÔºâ: -¬•${Math.floor(totalRedSlipTax10 / 1.10).toLocaleString()}
10%„ÅÆËµ§‰ºùÁ•®ÔºàÁ®éËæºÔºâ: -¬•${totalRedSlipTax10.toLocaleString()}
10%„ÅÆËµ§‰ºùÁ•®„ÅÆÊ∂àË≤ªÁ®é: -¬•${(totalRedSlipTax10 - Math.floor(totalRedSlipTax10 / 1.10)).toLocaleString()}
  ÂÜÖÁ®é: -¬•${totalRedSlipTax10Inclusive.toLocaleString()}
  Â§ñÁ®é: -¬•${totalRedSlipTax10Exclusive.toLocaleString()}

Ëµ§‰ºùÁ•®Ê∂àË≤ªÁ®é„ÅÆÂêàË®à: -¬•${((totalRedSlipTax8 - Math.floor(totalRedSlipTax8 / 1.08)) + (totalRedSlipTax10 - Math.floor(totalRedSlipTax10 / 1.10))).toLocaleString()}
Ëµ§‰ºùÁ•®Á®éÊäúÂêàË®à: -¬•${(Math.floor(totalRedSlipTax8 / 1.08) + Math.floor(totalRedSlipTax10 / 1.10)).toLocaleString()}
Ëµ§‰ºùÁ•®Á®éËæºÂêàË®à: -¬•${(totalRedSlipTax8 + totalRedSlipTax10).toLocaleString()}
` : ''}

-------------------------------------
„Åù„ÅÆ‰ªñ
-------------------------------------
„Éâ„É≠„Ç¢„Ç™„Éº„Éó„É≥Êï∞: ${totalDrawerOpen}Âõû
Ëµ§‰ºùÁ•®‰ª∂Êï∞: ${totalRedSlipCount}‰ª∂
Ëµ§‰ºùÁ•®ÈáëÈ°ç: ¬•${totalRedSlipAmount.toLocaleString()}
‰∫∫‰ª∂Ë≤ª: ¬•${Math.round(totalLaborCost).toLocaleString()}

=====================================
`;
        
        // PNGÁîªÂÉè„Å®„Åó„Å¶‰øùÂ≠ò
        const journalDiv = document.createElement('div');
        journalDiv.style.cssText = `
          font-family: 'Courier New', monospace;
          font-size: 14px;
          line-height: 1.6;
          padding: 30px;
          background: white;
          color: black;
          white-space: pre-wrap;
          position: absolute;
          left: -9999px;
        `;
        
        // HTML„Å®„Åó„Å¶ÁîüÊàê„Åó„ÄÅÊîØÂá∫„Å®ÂêàË®àÂ£≤‰∏ä„ÇíËµ§Ëâ≤„Å´„Åô„Çã
        journalDiv.innerHTML = journalText
          .replace(/^(ÊîØÂá∫: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>')
          .replace(/^(ÂêàË®àÂ£≤‰∏ä: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>');
        
        document.body.appendChild(journalDiv);
        
        const canvas = await html2canvas(journalDiv, {
          backgroundColor: '#ffffff',
          scale: 2
        });
        
        document.body.removeChild(journalDiv);
        
        const link = document.createElement('a');
        link.download = `ÊúüÈñì„Ç∏„É£„Éº„Éä„É´_${startDate}_${endDate}.png`;
        link.href = canvas.toDataURL();
        link.click();
        
        console.log('‚úÖ ÊúüÈñì„Ç∏„É£„Éº„Éä„É´ÁîüÊàêÂÆå‰∫Ü');
        
        // ÂïÜÂìÅ„Ç´„Ç¶„É≥„Éà„Çí„ÇΩ„Éº„ÉàÔºàË≤©Â£≤Êï∞„ÅåÂ§ö„ÅÑÈ†ÜÔºâ
        const sortedItems = Object.entries(itemCounts).sort((a, b) => b[1] - a[1]);
        console.log('üìä ÈõÜË®à„Åï„Çå„ÅüÂïÜÂìÅ„Éá„Éº„Çø:', itemCounts);
        console.log('üìä „ÇΩ„Éº„ÉàÂæå„ÅÆÂïÜÂìÅ„Éá„Éº„Çø:', sortedItems);
        
        // ÂïÜÂìÅ„Ç´„Ç¶„É≥„Éà„ÅÆHTMLÁîüÊàê
        let itemCountsHtml = '';
        sortedItems.forEach(([itemName, count]) => {
          itemCountsHtml += `
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
              <span>${itemName}</span>
              <strong>${count}ÂÄã</strong>
            </div>
          `;
        });
        
        // „Çµ„Éû„É™„ÉºË°®Á§∫
        container.innerHTML = `
          <div style="padding: 20px;">
            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border-radius: 12px; margin-bottom: 20px;">
              <div style="font-size: 18px; margin-bottom: 10px;">‚úÖ „Ç∏„É£„Éº„Éä„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü</div>
              <div style="font-size: 14px; opacity: 0.9;">ÊúüÈñì: ${startDate} ÔΩû ${endDate}</div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
              <h4 style="margin: 0 0 15px 0; color: #333;">ÊúüÈñì„Çµ„Éû„É™„Éº</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Á∑èÂ£≤‰∏ä</div>
                  <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">¬•${(totalCashSales + totalEmoneSales + totalCreditSales).toLocaleString()}</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ÂÆ¢Êï∞</div>
                  <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${totalCustomerCount}ÁµÑ</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Ë≤©Â£≤ÁÇπÊï∞</div>
                  <div style="font-size: 24px; font-weight: bold; color: #FF9800;">${totalItems}ÁÇπ</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Âπ≥ÂùáÂÆ¢Âçò‰æ°</div>
                  <div style="font-size: 24px; font-weight: bold; color: #9C27B0;">¬•${totalCustomerCount > 0 ? Math.round((totalCashSales + totalEmoneSales + totalCreditSales) / totalCustomerCount).toLocaleString() : 0}</div>
                </div>
              </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
              <h4 style="margin: 0 0 15px 0; color: #333;">ÊîØÊâïÊñπÊ≥ïÂà•</h4>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>ÁèæÈáë</span>
                <strong>¬•${totalCashSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>ÈõªÂ≠ê„Éû„Éç„Éº</span>
                <strong>¬•${totalEmoneSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span>„ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„Éâ</span>
                <strong>¬•${totalCreditSales.toLocaleString()}</strong>
              </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
              <h4 style="margin: 0 0 15px 0; color: #333;">ÂïÜÂìÅÂà•Ë≤©Â£≤Êï∞</h4>
              <div style="max-height: 300px; overflow-y: auto;">
                ${itemCountsHtml || '<div style="text-align: center; color: #999;">„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>'}
              </div>
            </div>
          </div>
        `;
        
      } catch (e) {
        console.error('‚ùå ÊúüÈñì„Ç∏„É£„Éº„Éä„É´ÁîüÊàê„Ç®„É©„Éº:', e);
        await showCustomAlert({
          title: '„Ç®„É©„Éº',
          message: 'ÊúüÈñì„Ç∏„É£„Éº„Éä„É´„ÅÆÁîüÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü',
          type: 'error'
        });
      }
    };
    
    // üÜï Á≤æÁÆó„ÇíÂÆüË°åÔºàCSV„ÉÄ„Ç¶„É≥„É≠„Éº„ÉâÔºâ

    // üÜï Êú¨Êó•„ÅÆÁ≤æÁÆó„ÇíÁõ¥Êé•ÂÆüË°åÔºàÂ£≤‰∏ä„É¢„Éº„ÉÄ„É´„Åã„ÇâÔºâ
    window.executeDailySettlement = async function() {
      try {
        // üÜï „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„ÉóÁ¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
        const shouldBackup = await new Promise((resolve) => {
          const modal = document.createElement('div');
          modal.id = 'backupConfirmModal';
          modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); display: flex; align-items: center; 
            justify-content: center; z-index: 999999; animation: fadeIn 0.2s;
          `;
          
          modal.innerHTML = `
            <div style="
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              border-radius: 24px; padding: 0; max-width: 500px; width: 90%;
              max-height: 85vh; display: flex; flex-direction: column;
              box-shadow: 0 25px 60px rgba(0,0,0,0.4); overflow: hidden;
              animation: slideUp 0.3s;
            ">
              <div style="background: white; padding: 32px; border-radius: 0 0 24px 24px; overflow-y: auto; flex: 1;">
                <div style="text-align: center; margin-bottom: 24px;">
                  <h3 style="font-size: 22px; font-weight: bold; color: #333; margin-bottom: 8px;">
                    Á≤æÁÆó„ÇíÂÆüË°å„Åô„ÇãÂâç„Å´„ÄÅ„Éá„Éº„Çø„ÅÆËá™Âãï„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê„Åó„Åæ„Åô„ÅãÔºü
                  </h3>
                </div>
                
                <div style="background: #f0f7ff; border-left: 4px solid #667eea; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                  <div style="font-weight: bold; color: #667eea; margin-bottom: 10px; font-size: 15px;">„ÄêÊé®Â•®: „ÅØ„ÅÑ„Äë</div>
                  <div style="color: #555; font-size: 13px; line-height: 1.6;">
                    ‰ª•‰∏ã„Åå„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Åï„Çå„Åæ„ÅôÔºö<br>
                    ‚Ä¢ ÂïÜÂìÅ<br>
                    ‚Ä¢ ÂæìÊ•≠Âì°<br>
                    ‚Ä¢ Ê≥®ÊñáÂ±•Ê≠¥<br>
                    ‚Ä¢ Âã§ÊÄ†„Éá„Éº„Çø<br>
                    ‚Ä¢ ÂïÜÂìÅ„Ç´„ÉÜ„Ç¥„É™Ë®≠ÂÆö<br>
                    ‚Ä¢ „É¨„Ç∑„Éº„ÉàË®≠ÂÆö<br>
                    ‚Ä¢ Âú®Â∫´Ë®≠ÂÆö<br>
                    ‚Ä¢ „Ç¢„É©„Éº„ÉàË®≠ÂÆö<br>
                    ‚Ä¢ Âñ∂Ê•≠ÊôÇÈñìË®≠ÂÆö<br>
                    ‚Ä¢ „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö<br><br>
                    Ë™§„Å£„Å¶ÂâäÈô§„Åó„ÅüÂ†¥Âêà„Å´Âæ©ÂÖÉ„Åß„Åç„Åæ„Åô„ÄÇ<br>
                    ÈÅéÂéª7Êó•ÂàÜ„ÅÆ„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅåËá™Âãï‰øùÊåÅ„Åï„Çå„Åæ„Åô„ÄÇ
                  </div>
                </div>
                
                <div style="background: #fff9e6; border-left: 4px solid #ff9800; padding: 14px; border-radius: 8px; margin-bottom: 20px;">
                  <div style="font-weight: bold; color: #ff9800; margin-bottom: 6px; font-size: 14px;">„Äê„ÅÑ„ÅÑ„Åà„ÇíÈÅ∏Êäû„Åó„ÅüÂ†¥Âêà„Äë</div>
                  <div style="color: #666; font-size: 13px;">„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Å™„Åó„ÅßÁ≤æÁÆó„ÇíÂÆüË°å„Åó„Åæ„Åô</div>
                </div>
                
                <div style="display: flex; gap: 12px; position: sticky; bottom: 0; background: white; padding: 10px 0 0 0;">
                  <button id="backupNoBtn" style="
                    flex: 1; padding: 16px; font-size: 16px; font-weight: bold;
                    border: 2px solid #ddd; border-radius: 12px; cursor: pointer;
                    background: white; color: #666; transition: all 0.2s;
                  " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                    „ÅÑ„ÅÑ„Åà
                  </button>
                  <button id="backupYesBtn" style="
                    flex: 1; padding: 16px; font-size: 16px; font-weight: bold;
                    border: none; border-radius: 12px; cursor: pointer;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                    transition: all 0.2s;
                  " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.5)'" 
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'">
                    „ÅØ„ÅÑÔºàÊé®Â•®Ôºâ
                  </button>
                </div>
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          
          const yesBtn = document.getElementById('backupYesBtn');
          const noBtn = document.getElementById('backupNoBtn');
          
          const handleYes = () => {
            playTapSound();
            yesBtn.removeEventListener('click', handleYes);
            noBtn.removeEventListener('click', handleNo);
            modal.remove();
            resolve(true);
          };
          
          const handleNo = () => {
            playTapSound();
            yesBtn.removeEventListener('click', handleYes);
            noBtn.removeEventListener('click', handleNo);
            modal.remove();
            resolve(false);
          };
          
          yesBtn.addEventListener('click', handleYes);
          noBtn.addEventListener('click', handleNo);
        });
        
        if (shouldBackup) {
          console.log(' „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí‰ΩúÊàê„Åó„Åæ„Åô');
          const backupSuccess = await window.createAutoBackup();
          if (!backupSuccess) {
            const continueAnyway = await showCustomAlert({
              title: '„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Ç®„É©„Éº',
              message: '„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n\n„Åù„Çå„Åß„ÇÇÁ≤æÁÆó„ÇíÁ∂ö„Åë„Åæ„Åô„ÅãÔºü',
              type: 'warning',
              confirmText: 'Á∂ö„Åë„Çã',
              cancelText: '„Ç≠„É£„É≥„Çª„É´'
            });
            if (!continueAnyway) {
              return;
            }
          } else {
            console.log('‚úÖ „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó‰ΩúÊàêÂÆå‰∫Ü - Á≤æÁÆó„ÇíÁ∂öË°å„Åó„Åæ„Åô');
          }
        } else {
          console.log('‚ö†Ô∏è „Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Çí„Çπ„Ç≠„ÉÉ„Éó„Åó„Å¶Á≤æÁÆó„ÇíÂÆüË°å„Åó„Åæ„Åô');
        }
        
        // Êú¨Êó•„ÅÆÊó•‰ªò„ÇíÂèñÂæóÔºà3ÊôÇÂü∫Ê∫ñÔºâ
        const now = new Date();
        const dateStr = window.getBusinessDay(now).str;
        
        await executeSettlement(dateStr);
        
      } catch (e) {
        console.error('‚ùå Á≤æÁÆó„Ç®„É©„Éº:', e);
        await showCustomAlert({
          title: '„Ç®„É©„Éº',
          message: 'Á≤æÁÆóÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü',
          type: 'error'
        });
      }
    };
    
    // Á≤æÁÆóÂá¶ÁêÜ„ÅÆÂÖ±ÈÄöÈñ¢Êï∞
    async function executeSettlement(dateStr) {
        
        // Á¢∫Ë™ç„ÉÄ„Ç§„Ç¢„É≠„Ç∞
        const confirmed = await showCustomAlert({
          title: 'Á≤æÁÆó„ÇíÂÆüË°å',
          message: `${dateStr}„ÅÆÁ≤æÁÆó„ÇíÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü\n„Ç∏„É£„Éº„Éä„É´„Éï„Ç°„Ç§„É´ÔºàPNGÂΩ¢ÂºèÔºâ„Åå„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åï„Çå„Åæ„Åô„ÄÇ`,
          type: 'warning',
          confirmText: 'ÂÆüË°å',
          cancelText: '„Ç≠„É£„É≥„Çª„É´'
        });
        
        if (!confirmed) return;
        
        // Â£≤‰∏ä„Éá„Éº„Çø„ÇíÂèñÂæó
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        if (!salesDoc.exists()) {
          await showCustomAlert({
            title: '„Ç®„É©„Éº',
            message: 'ÊåáÂÆöÊó•„ÅÆÂ£≤‰∏ä„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì',
            type: 'error'
          });
          return;
        }
        
        const settlementData = salesDoc.data();
        
        // ÁèæÂú®ÊôÇÂàª„ÇíÂèñÂæó
        const now = new Date();
        const outputTime = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        
        // Âü∫Êú¨„Éá„Éº„Çø„ÇíÂèñÂæó
        const customerCount = settlementData.customerCount || 0;
        const totalItems = settlementData.totalItems || 0;
        const totalSales = settlementData.totalSales || 0;
        const averageSpend = customerCount > 0 ? Math.round(totalSales / customerCount) : 0;
        
        const cashSales = settlementData.cashSales || 0;
        const emoneSales = settlementData.emoneSales || 0;
        const creditSales = settlementData.creditSales || 0;
        const discountTotal = settlementData.totalDiscount || 0;
        
        const tax8Total = settlementData.tax8Total || 0;
        const tax10Total = settlementData.tax10Total || 0;
        
        // üÜï Ëµ§‰ºùÁ•®ÊÉÖÂ†±„ÇíÂèñÂæó
        const redSlipCount = settlementData.redSlipCount || 0;
        const redSlipAmount = settlementData.redSlipAmount || 0;
        const redSlipTax8Total = settlementData.redSlipTax8Total || 0;
        const redSlipTax10Total = settlementData.redSlipTax10Total || 0;
        console.log('üî¥ Ëµ§‰ºùÁ•®‰ª∂Êï∞:', redSlipCount);
        console.log('üî¥ Ëµ§‰ºùÁ•®ÈáëÈ°ç:', redSlipAmount);
        console.log('üî¥ Ëµ§‰ºùÁ•®8%Á®éÈáë:', redSlipTax8Total);
        console.log('üî¥ Ëµ§‰ºùÁ•®10%Á®éÈáë:', redSlipTax10Total);
        
        // ÂÜÖÁ®é„ÉªÂ§ñÁ®é„ÅÆÂÜÖË®≥„ÇíÊ≥®Êñá„Éá„Éº„Çø„Åã„ÇâÈõÜË®à
        let tax8InclusiveTotal = 0;
        let tax10InclusiveTotal = 0;
        let tax8ExclusiveTotal = 0;
        let tax10ExclusiveTotal = 0;
        // üÜï Ëµ§‰ºùÁ•®„ÅÆÂÜÖÁ®é„ÉªÂ§ñÁ®é„ÇídailySales„Åã„ÇâÂèñÂæó
        let redSlipTax8Inclusive = settlementData.redSlipTax8Inclusive || 0;
        let redSlipTax10Inclusive = settlementData.redSlipTax10Inclusive || 0;
        let redSlipTax8Exclusive = settlementData.redSlipTax8Exclusive || 0;
        let redSlipTax10Exclusive = settlementData.redSlipTax10Exclusive || 0;
        
        const ordersQuery = window.query(
          window.getStoreCollection('orders'),
          window.where('paidAt', '!=', null)
        );
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          if (!data.paidAt || !data.items) return;
          
          const orderDate = data.paidAt.toDate();
          const orderDateStr = window.getBusinessDay(orderDate).str;
          
          if (orderDateStr === dateStr) {
            data.items.forEach(item => {
              const taxType = item.taxType || 'inclusive';
              const taxAmount = getTaxAmount(item, item.quantity || 1);
              
              if ((item.taxRate || 10) === 8) {
                if (taxType === 'exclusive') {
                  tax8ExclusiveTotal += taxAmount;
                } else {
                  tax8InclusiveTotal += taxAmount;
                }
              } else {
                if (taxType === 'exclusive') {
                  tax10ExclusiveTotal += taxAmount;
                } else {
                  tax10InclusiveTotal += taxAmount;
                }
              }
            });
          }
        });
        
        // üÜï Ëµ§‰ºùÁ•®„ÅÆÂÜÖÁ®é„ÉªÂ§ñÁ®é„ÇíredSlips„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Åã„ÇâË®àÁÆóÔºàdailySales„Å´‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂ†¥ÂêàÔºâ
        const needCalculateRedSlip = (redSlipTax8Inclusive === 0 && redSlipTax8Exclusive === 0 && 
                                      redSlipTax10Inclusive === 0 && redSlipTax10Exclusive === 0) &&
                                     (redSlipCount > 0);
        
        if (needCalculateRedSlip) {
          console.log('‚ö†Ô∏è dailySales„Å´Ëµ§‰ºùÁ•®„ÅÆÂÜÖÁ®é„ÉªÂ§ñÁ®é„Åå‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑ„Åü„ÇÅ„ÄÅredSlips„Åã„ÇâË®àÁÆó„Åó„Åæ„Åô');
          try {
            const redSlipsSnapshot = await window.getDocs(window.getStoreCollection('redSlips'));
            redSlipsSnapshot.forEach(doc => {
              const data = doc.data();
              if (!data.businessDate || data.businessDate !== dateStr || !data.items) return;
              
              data.items.forEach(item => {
                const taxType = item.taxType || 'inclusive';
                const taxAmount = getTaxAmount(item, item.quantity || 1);
                
                if ((item.taxRate || 10) === 8) {
                  if (taxType === 'exclusive') {
                    redSlipTax8Exclusive += taxAmount;
                  } else {
                    redSlipTax8Inclusive += taxAmount;
                  }
                } else {
                  if (taxType === 'exclusive') {
                    redSlipTax10Exclusive += taxAmount;
                  } else {
                    redSlipTax10Inclusive += taxAmount;
                  }
                }
              });
            });
            console.log('‚úÖ redSlips„Åã„ÇâË®àÁÆóÂÆå‰∫Ü:', {
              redSlipTax8Inclusive,
              redSlipTax8Exclusive,
              redSlipTax10Inclusive,
              redSlipTax10Exclusive
            });
          } catch (e) {
            console.error('redSlipsÂèñÂæó„Ç®„É©„Éº:', e);
          }
        }
        
        // Á®éÈáëË®àÁÆó
        const tax8Excluded = Math.floor(tax8Total / 1.08);
        const tax10Excluded = Math.floor(tax10Total / 1.10);
        const tax8Amount = tax8Total - tax8Excluded;
        const tax10Amount = tax10Total - tax10Excluded;
        const totalTax = tax8Amount + tax10Amount;
        const taxExcludedTotal = tax8Excluded + tax10Excluded;
        const taxIncludedTotal = tax8Total + tax10Total;
        
        // „Ç∏„É£„Éº„Éä„É´HTMLÁîüÊàê
        const journalHtml = `
          <div style="font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6; padding: 30px; background: white; width: 600px;">
            <div style="text-align: center; font-size: 20px; font-weight: bold; margin-bottom: 20px;">
              Á≤æÁÆó„Ç∏„É£„Éº„Éä„É´
            </div>
            <div style="text-align: center; margin-bottom: 30px; color: #666;">
              Âá∫ÂäõÊó•ÊôÇ: ${outputTime}
            </div>
            
            <div style="border-top: 2px solid #333; border-bottom: 2px solid #333; padding: 15px 0; margin: 20px 0;">
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>Âñ∂Ê•≠Êó•:</span>
                <strong>${dateStr}</strong>
              </div>
            </div>
            
            <div style="margin: 20px 0;">
              <div style="font-weight: bold; margin-bottom: 10px;">Âü∫Êú¨ÊÉÖÂ†±</div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>ÂÆ¢Êï∞:</span>
                <span>${customerCount}‰∫∫</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>ÂïÜÂìÅÊï∞:</span>
                <span>${totalItems}ÂÄã</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>ÂÆ¢Âçò‰æ°:</span>
                <span>¬•${averageSpend.toLocaleString()}</span>
              </div>
            </div>
            
            <div style="margin: 20px 0; border-top: 1px dashed #999; padding-top: 15px;">
              <div style="font-weight: bold; margin-bottom: 10px;">Â£≤‰∏äÂÜÖË®≥</div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>ÁèæÈáë:</span>
                <span>¬•${cashSales.toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>ÈõªÂ≠ê„Éû„Éç„Éº:</span>
                <span>¬•${emoneSales.toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>„ÇØ„É¨„Ç∏„ÉÉ„Éà„Ç´„Éº„Éâ:</span>
                <span>¬•${creditSales.toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>ÂÄ§Âºï:</span>
                <span>-¬•${discountTotal.toLocaleString()}</span>
              </div>
            </div>
            
            <div style="margin: 20px 0; border-top: 1px dashed #999; padding-top: 15px;">
              <div style="font-weight: bold; margin-bottom: 10px;">Á®éÈáëÂÜÖË®≥</div>
              <div style="margin-left: 10px;">
                <div style="font-weight: bold; margin: 10px 0;">8%„ÅÆÂïÜÂìÅ</div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>„ÄÄÁ®éÊäú:</span>
                  <span>¬•${tax8Excluded.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>„ÄÄÁ®éËæº:</span>
                  <span>¬•${tax8Total.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>„ÄÄÊ∂àË≤ªÁ®é:</span>
                  <span>¬•${tax8Amount.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0; margin-left: 15px;">
                  <span>ÂÜÖÁ®é:</span>
                  <span>¬•${tax8InclusiveTotal.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0; margin-left: 15px;">
                  <span>Â§ñÁ®é:</span>
                  <span>¬•${tax8ExclusiveTotal.toLocaleString()}</span>
                </div>
                
                <div style="font-weight: bold; margin: 10px 0;">10%„ÅÆÂïÜÂìÅ</div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>„ÄÄÁ®éÊäú:</span>
                  <span>¬•${tax10Excluded.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>„ÄÄÁ®éËæº:</span>
                  <span>¬•${tax10Total.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>„ÄÄÊ∂àË≤ªÁ®é:</span>
                  <span>¬•${tax10Amount.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0; margin-left: 15px;">
                  <span>ÂÜÖÁ®é:</span>
                  <span>¬•${tax10InclusiveTotal.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0; margin-left: 15px;">
                  <span>Â§ñÁ®é:</span>
                  <span>¬•${tax10ExclusiveTotal.toLocaleString()}</span>
                </div>
              </div>
            </div>
            
            <div style="margin: 20px 0; border-top: 2px solid #333; padding-top: 15px;">
              <div style="display: flex; justify-content: space-between; margin: 8px 0; font-size: 16px;">
                <span>Ê∂àË≤ªÁ®é„ÅÆÂêàË®à:</span>
                <strong>¬•${totalTax.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 8px 0; font-size: 16px;">
                <span>Á®éÊäúÂêàË®à:</span>
                <strong>¬•${taxExcludedTotal.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 8px 0; font-size: 18px; font-weight: bold;">
                <span>Á®éËæºÂêàË®à:</span>
                <strong style="font-size: 24px;">¬•${taxIncludedTotal.toLocaleString()}</strong>
              </div>
            </div>
            
            ${redSlipCount > 0 ? `
            <div style="margin: 20px 0; border-top: 1px dashed #999; padding-top: 15px;">
              <div style="font-weight: bold; margin-bottom: 10px; color: #d32f2f;">üî¥ Ëµ§‰ºùÁ•®„ÅÆÁ®éÈáëÂÜÖË®≥</div>
              <div style="margin-left: 10px;">
                <div style="font-weight: bold; margin: 10px 0;">8%„ÅÆËµ§‰ºùÁ•®</div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>„ÄÄÁ®éÊäú:</span>
                  <span>-¬•${Math.floor(redSlipTax8Total / 1.08).toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>„ÄÄÁ®éËæº:</span>
                  <span>-¬•${redSlipTax8Total.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>„ÄÄÊ∂àË≤ªÁ®é:</span>
                  <span>-¬•${(redSlipTax8Total - Math.floor(redSlipTax8Total / 1.08)).toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0; margin-left: 15px;">
                  <span>ÂÜÖÁ®é:</span>
                  <span>-¬•${redSlipTax8Inclusive.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0; margin-left: 15px;">
                  <span>Â§ñÁ®é:</span>
                  <span>-¬•${redSlipTax8Exclusive.toLocaleString()}</span>
                </div>
                
                <div style="font-weight: bold; margin: 10px 0;">10%„ÅÆËµ§‰ºùÁ•®</div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>„ÄÄÁ®éÊäú:</span>
                  <span>-¬•${Math.floor(redSlipTax10Total / 1.10).toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>„ÄÄÁ®éËæº:</span>
                  <span>-¬•${redSlipTax10Total.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>„ÄÄÊ∂àË≤ªÁ®é:</span>
                  <span>-¬•${(redSlipTax10Total - Math.floor(redSlipTax10Total / 1.10)).toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0; margin-left: 15px;">
                  <span>ÂÜÖÁ®é:</span>
                  <span>-¬•${redSlipTax10Inclusive.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0; margin-left: 15px;">
                  <span>Â§ñÁ®é:</span>
                  <span>-¬•${redSlipTax10Exclusive.toLocaleString()}</span>
                </div>
              </div>
              
              <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd;">
                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                  <span>Ëµ§‰ºùÁ•®Ê∂àË≤ªÁ®é„ÅÆÂêàË®à:</span>
                  <strong>-¬•${((redSlipTax8Total - Math.floor(redSlipTax8Total / 1.08)) + (redSlipTax10Total - Math.floor(redSlipTax10Total / 1.10))).toLocaleString()}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                  <span>Ëµ§‰ºùÁ•®Á®éÊäúÂêàË®à:</span>
                  <strong>-¬•${(Math.floor(redSlipTax8Total / 1.08) + Math.floor(redSlipTax10Total / 1.10)).toLocaleString()}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                  <span>Ëµ§‰ºùÁ•®Á®éËæºÂêàË®à:</span>
                  <strong>-¬•${(redSlipTax8Total + redSlipTax10Total).toLocaleString()}</strong>
                </div>
              </div>
            </div>
            ` : ''}
            
            <div style="margin: 20px 0; border-top: 1px dashed #999; padding-top: 15px;">
              <div style="font-weight: bold; margin-bottom: 10px;">„Åù„ÅÆ‰ªñ</div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>Ëµ§‰ºùÁ•®‰ª∂Êï∞:</span>
                <span>${redSlipCount}‰ª∂</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>Ëµ§‰ºùÁ•®ÈáëÈ°ç:</span>
                <span>¬•${redSlipAmount.toLocaleString()}</span>
              </div>
            </div>
          </div>
        `;
        
        // HTML2Canvas„ÅßÁîªÂÉèÂåñ
        const journalDiv = document.createElement('div');
        journalDiv.innerHTML = journalHtml;
        journalDiv.style.position = 'absolute';
        journalDiv.style.left = '-9999px';
        document.body.appendChild(journalDiv);
        
        const canvas = await html2canvas(journalDiv, {
          backgroundColor: '#ffffff',
          scale: 2
        });
        
        document.body.removeChild(journalDiv);
        
        const link = document.createElement('a');
        link.download = `Á≤æÁÆó„Ç∏„É£„Éº„Éä„É´_${dateStr}.png`;
        link.href = canvas.toDataURL();
        link.click();
        
        await showCustomAlert({
          title: 'ÂÆå‰∫Ü',
          message: 'Á≤æÁÆó„Ç∏„É£„Éº„Éä„É´„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åó„Åü',
          type: 'success'
        });
    }
    
    // üÜï Êó•Ë®àË°®Âá∫Âäõ

    
    // üÜï Âç∞Âà∑„É™„ÇØ„Ç®„Çπ„Éà„ÇíÈÄÅ‰ø°„Åô„ÇãÂÖ±ÈÄöÈñ¢Êï∞
    async function sendPrintRequest(builder, onSuccess, onError) {
      try {
        const request = builder.toString();
        
        if (PRINTER_CONNECTION_TYPE === 'ethernet' || PRINTER_CONNECTION_TYPE === 'wifi') {
          // HTTPSÁí∞Â¢É„Åß„ÅØWi-Fi/LANÂç∞Âà∑„Åß„Åç„Å™„ÅÑ„Åì„Å®„ÇíÈÄöÁü•
          if (window.location.protocol === 'https:') {
            throw new Error('HTTPSÁí∞Â¢É„Åß„ÅØWi-Fi/LANÂç∞Âà∑„ÅØÂà∂Èôê„Åï„Çå„Åæ„Åô„ÄÇHTTP„Åß„Ç¢„ÇØ„Çª„Çπ„Åô„Çã„Åã„ÄÅBluetooth„Éó„É™„É≥„Çø„Éº„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ');
          }
          
          // Wi-Fi/LANÂç∞Âà∑
          const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
          const trader = new StarWebPrintTrader({url: url});
          
          trader.onReceive = onSuccess;
          trader.onError = onError;
          
          await trader.sendMessage(request);
        } else if (PRINTER_CONNECTION_TYPE === 'bluetooth' && BLUETOOTH_CHARACTERISTIC) {
          // BluetoothÂç∞Âà∑
          const encoder = new TextEncoder();
          const data = encoder.encode(request);
          await BLUETOOTH_CHARACTERISTIC.writeValue(data);
          if (onSuccess) onSuccess({ status: 'success' });
        } else {
          throw new Error('„Éó„É™„É≥„Çø„Éº„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
        }
      } catch (error) {
        console.error('Âç∞Âà∑„Ç®„É©„Éº:', error);
        if (onError) onError({ status: error.message });
      }
    }
    
    // ========== üñ® „Éó„É™„É≥„ÇøË®≠ÂÆöÊ©üËÉΩ ==========
    
    // „Éó„É™„É≥„ÇøË®≠ÂÆö„ÅÆ„Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
    let PRINTER_IP = localStorage.getItem('printerIP') || '192.168.1.100';
    let PRINTER_CONNECTION_TYPE = localStorage.getItem('printerConnectionType') || 'ethernet';
    let BLUETOOTH_DEVICE = null;
    let BLUETOOTH_CHARACTERISTIC = null;
    
    window.selectConnectionType = function(type) {
      PRINTER_CONNECTION_TYPE = type;
      
      const ethernetBtn = document.getElementById('connectionTypeEthernet');
      const bluetoothBtn = document.getElementById('connectionTypeBluetooth');
      const usbBtn = document.getElementById('connectionTypeUsb');
      const proxyBtn = document.getElementById('connectionTypeProxy');
      const ethernetSettings = document.getElementById('ethernetSettings');
      const bluetoothSettings = document.getElementById('bluetoothSettings');
      const usbSettings = document.getElementById('usbSettings');
      const proxySettings = document.getElementById('proxySettings');
      
      // „Åô„Åπ„Å¶„ÅÆ„Éú„Çø„É≥„Çí„É™„Çª„ÉÉ„Éà
      [ethernetBtn, bluetoothBtn, usbBtn, proxyBtn].forEach(btn => {
        if (btn) {
          btn.style.background = 'white';
          btn.style.color = '#666';
          btn.style.borderColor = '#ddd';
        }
      });
      
      // „Åô„Åπ„Å¶„ÅÆË®≠ÂÆö„Çª„ÇØ„Ç∑„Éß„É≥„ÇíÈùûË°®Á§∫
      if (ethernetSettings) ethernetSettings.style.display = 'none';
      if (bluetoothSettings) bluetoothSettings.style.display = 'none';
      if (usbSettings) usbSettings.style.display = 'none';
      if (proxySettings) proxySettings.style.display = 'none';
      
      if (type === 'ethernet') {
        if (ethernetBtn) {
          ethernetBtn.style.background = '#667eea';
          ethernetBtn.style.color = 'white';
          ethernetBtn.style.borderColor = '#667eea';
        }
        if (ethernetSettings) ethernetSettings.style.display = 'block';
      } else if (type === 'bluetooth') {
        if (bluetoothBtn) {
          bluetoothBtn.style.background = '#667eea';
          bluetoothBtn.style.color = 'white';
          bluetoothBtn.style.borderColor = '#667eea';
        }
        if (bluetoothSettings) bluetoothSettings.style.display = 'block';
      } else if (type === 'usb') {
        if (usbBtn) {
          usbBtn.style.background = '#667eea';
          usbBtn.style.color = 'white';
          usbBtn.style.borderColor = '#667eea';
        }
        if (usbSettings) usbSettings.style.display = 'block';
      } else if (type === 'proxy') {
        if (proxyBtn) {
          proxyBtn.style.background = '#667eea';
          proxyBtn.style.color = 'white';
          proxyBtn.style.borderColor = '#667eea';
        }
        if (proxySettings) proxySettings.style.display = 'block';
      }
    };
    
    window.showBluetoothSearchGuide = function() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;';
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <div style="text-align: center; margin-bottom: 25px;">
            <div style="width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 50%; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold;">
              BT
            </div>
            <h3 style="font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #333;">Bluetooth„Éó„É™„É≥„Çø„ÅÆÊ§úÁ¥¢</h3>
          </div>
          
          <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
            <p style="font-size: 15px; color: #555; margin-bottom: 12px; line-height: 1.6;">
              „Åì„ÅÆÂæå„ÄÅ„Éñ„É©„Ç¶„Ç∂„ÅÆ„Éö„Ç¢Ë®≠ÂÆöÁîªÈù¢„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ
            </p>
            <p style="font-size: 14px; color: #666; line-height: 1.6;">
              <strong style="color: #333;">Á¢∫Ë™ç‰∫ãÈ†ÖÔºö</strong><br>
              ‚Ä¢ „Éó„É™„É≥„Çø„ÅÆÈõªÊ∫ê„ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã<br>
              ‚Ä¢ Bluetooth„ÅåON„Å´„Å™„Å£„Å¶„ÅÑ„Çã<br>
              ‚Ä¢ „Éö„Ç¢„É™„É≥„Ç∞„É¢„Éº„Éâ„Å´„Å™„Å£„Å¶„ÅÑ„Çã
            </p>
          </div>
          
          <div style="display: flex; gap: 12px;">
            <button onclick="playTapSound(); this.closest('.modal-overlay').remove()" style="flex: 1; padding: 15px; font-size: 16px; font-weight: bold; border: 2px solid #ddd; background: white; color: #666; border-radius: 10px; cursor: pointer;">
              „Ç≠„É£„É≥„Çª„É´
            </button>
            <button onclick="playTapSound(); this.closest('.modal-overlay').remove(); window.startBluetoothSearch();" style="flex: 1; padding: 15px; font-size: 16px; font-weight: bold; border: none; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 15px rgba(33,150,243,0.3);">
              Ê§úÁ¥¢ÈñãÂßã
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    };
    
    window.startBluetoothSearch = async function() {
      try {
        console.log('Bluetooth„Éó„É™„É≥„Çø„ÇíÊ§úÁ¥¢‰∏≠...');
        
        const device = await navigator.bluetooth.requestDevice({
          filters: [
            { services: ['000018f0-0000-1000-8000-00805f9b34fb'] },
          ],
          optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });
        
        console.log('„Éá„Éê„Ç§„ÇπÁô∫Ë¶ã:', device.name);
        
        const server = await device.gatt.connect();
        console.log('GATTÊé•Á∂öÊàêÂäü');
        
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        console.log('„Çµ„Éº„Éì„ÇπÂèñÂæóÊàêÂäü');
        
        const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
        console.log('CharacteristicÂèñÂæóÊàêÂäü');
        
        BLUETOOTH_DEVICE = device;
        BLUETOOTH_CHARACTERISTIC = characteristic;
        
        document.getElementById('bluetoothDeviceInfo').style.display = 'block';
        document.getElementById('bluetoothDeviceName').textContent = device.name || '‰∏çÊòé„Å™„Éá„Éê„Ç§„Çπ';
        
        localStorage.setItem('bluetoothDeviceName', device.name || '');
        
        await showCustomAlert({ 
          icon: '', 
          title: 'Êé•Á∂öÊàêÂäü', 
          message: 'Bluetooth„Éó„É™„É≥„Çø„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü\n' + (device.name || '‰∏çÊòé„Å™„Éá„Éê„Ç§„Çπ'), 
          btnClass: 'modal-btn-success' 
        });
        
      } catch (error) {
        console.error('BluetoothÊé•Á∂ö„Ç®„É©„Éº:', error);
        
        if (error.name === 'NotFoundError') {
          await showCustomAlert({ 
            icon: '', 
            title: '„Éá„Éê„Ç§„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì', 
            message: 'Bluetooth„Éó„É™„É≥„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\n\n„Éó„É™„É≥„Çø„ÅÆÈõªÊ∫ê„ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ', 
            btnClass: 'modal-btn-danger' 
          });
        } else if (error.name === 'SecurityError' || error.name === 'NotAllowedError') {
          console.log('Ê§úÁ¥¢„Åå„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åó„Åü');
        } else {
          await showCustomAlert({ 
            icon: '', 
            title: 'Êé•Á∂ö„Ç®„É©„Éº', 
            message: 'Bluetooth„Éó„É™„É≥„Çø„ÅÆÊ§úÁ¥¢„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n\n„Éñ„É©„Ç¶„Ç∂„ÅåBluetoothÂØæÂøú„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàChrome„ÄÅEdgeÊé®Â•®Ôºâ', 
            btnClass: 'modal-btn-danger' 
          });
        }
      }
    };
    
    window.searchBluetoothPrinter = function() {
      showBluetoothSearchGuide();
    };
    
    function createESCPOSCommand(text) {
      const encoder = new TextEncoder();
      const commands = [];
      
      commands.push(new Uint8Array([0x1B, 0x40]));
      commands.push(encoder.encode(text));
      commands.push(new Uint8Array([0x0A, 0x0A, 0x0A]));
      commands.push(new Uint8Array([0x1D, 0x56, 0x00]));
      
      const totalLength = commands.reduce((sum, cmd) => sum + cmd.length, 0);
      const result = new Uint8Array(totalLength);
      let offset = 0;
      for (const cmd of commands) {
        result.set(cmd, offset);
        offset += cmd.length;
      }
      
      return result;
    }
    
    async function printViaBluetooth(text) {
      if (!BLUETOOTH_CHARACTERISTIC) {
        throw new Error('Bluetooth„Éó„É™„É≥„Çø„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
      }
      
      try {
        const command = createESCPOSCommand(text);
        
        const chunkSize = 512;
        for (let i = 0; i < command.length; i += chunkSize) {
          const chunk = command.slice(i, Math.min(i + chunkSize, command.length));
          await BLUETOOTH_CHARACTERISTIC.writeValue(chunk);
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        console.log('BluetoothÂç∞Âà∑ÂÆå‰∫Ü');
      } catch (error) {
        console.error('BluetoothÂç∞Âà∑„Ç®„É©„Éº:', error);
        throw error;
      }
    }
    
    // ========================================
    // USBÊé•Á∂öÊ©üËÉΩ
    // ========================================
    
    let USB_DEVICE = null;
    
    // USBÊé•Á∂ö„ÅÆmCprint3„Éó„É™„É≥„Çø„Éº„ÇíÊ§úÁ¥¢„Åó„Å¶Êé•Á∂ö
    window.connectUSBPrinter = async function() {
      if (!navigator.usb) {
        await showCustomAlert({
          icon: '',
          title: '„Ç®„É©„Éº',
          message: '„Åì„ÅÆ„Éñ„É©„Ç¶„Ç∂„ÅØWebUSB API„Å´ÂØæÂøú„Åó„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ\nChrome„Åæ„Åü„ÅØEdge„Çí„Åî‰ΩøÁî®„Åè„Å†„Åï„ÅÑ„ÄÇ',
          btnClass: 'modal-btn-danger'
        });
        return;
      }
      
      try {
        console.log('üîç USB„Éó„É™„É≥„Çø„ÇíÊ§úÁ¥¢‰∏≠...');
        
        // USB„Éá„Éê„Ç§„Çπ„ÇíË¶ÅÊ±ÇÔºà„É¶„Éº„Ç∂„Éº„Åå„Éá„Éê„Ç§„Çπ„ÇíÈÅ∏ÊäûÔºâ
        const device = await navigator.usb.requestDevice({
          filters: [
            { vendorId: 0x0519 }, // Star Micronics Vendor ID
            { vendorId: 0x0519, productId: 0x0001 } // mCprint3
          ]
        });
        
        console.log('‚úÖ USB„Éá„Éê„Ç§„ÇπÊ§úÂá∫:', device.productName);
        
        // „Éá„Éê„Ç§„Çπ„ÇíÈñã„Åè
        await device.open();
        console.log('üìÇ „Éá„Éê„Ç§„Çπ„Çí„Ç™„Éº„Éó„É≥„Åó„Åæ„Åó„Åü');
        
        // „Ç≥„É≥„Éï„Ç£„Ç∞„É¨„Éº„Ç∑„Éß„É≥„ÇíÈÅ∏Êäû
        if (device.configuration === null) {
          await device.selectConfiguration(1);
          console.log('‚öôÔ∏è „Ç≥„É≥„Éï„Ç£„Ç∞„É¨„Éº„Ç∑„Éß„É≥ÈÅ∏ÊäûÂÆå‰∫Ü');
        }
        
        // „Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ„Çí„ÇØ„É¨„Éº„É†
        await device.claimInterface(0);
        console.log('üîó „Ç§„É≥„Çø„Éº„Éï„Çß„Éº„ÇπÊé•Á∂öÂÆå‰∫Ü');
        
        USB_DEVICE = device;
        
        // „Éá„Éê„Ç§„ÇπÂêç„ÇíË°®Á§∫
        document.getElementById('usbDeviceInfo').style.display = 'block';
        document.getElementById('usbDeviceName').textContent = device.productName || 'mC-Print3';
        
        // localStorage„Å´‰øùÂ≠ò
        localStorage.setItem('usbDeviceName', device.productName || 'mC-Print3');
        
        await showCustomAlert({
          icon: '',
          title: 'Êé•Á∂öÊàêÂäü',
          message: 'USB„Éó„É™„É≥„Çø„Å´Êé•Á∂ö„Åó„Åæ„Åó„Åü\n' + (device.productName || 'mC-Print3'),
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('‚ùå USBÊé•Á∂ö„Ç®„É©„Éº:', error);
        
        if (error.name === 'NotFoundError') {
          await showCustomAlert({
            icon: '',
            title: '„Éá„Éê„Ç§„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì',
            message: 'USB„Éó„É™„É≥„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\n\nÁ¢∫Ë™ç‰∫ãÈ†Ö:\n1. USB„Ç±„Éº„Éñ„É´„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Çã„Åã\n2. „Éó„É™„É≥„Çø„Éº„ÅÆÈõªÊ∫ê„ÅåÂÖ•„Å£„Å¶„ÅÑ„Çã„Åã',
            btnClass: 'modal-btn-danger'
          });
        } else if (error.name === 'SecurityError' || error.name === 'NotAllowedError') {
          console.log('Ê§úÁ¥¢„Åå„Ç≠„É£„É≥„Çª„É´„Åï„Çå„Åæ„Åó„Åü');
        } else {
          await showCustomAlert({
            icon: '',
            title: 'Êé•Á∂ö„Ç®„É©„Éº',
            message: 'USB„Éó„É™„É≥„Çø„ÅÆÊé•Á∂ö„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ\n\n„Éñ„É©„Ç¶„Ç∂„ÅåWebUSBÂØæÂøú„ÅãÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàChrome„ÄÅEdgeÊé®Â•®Ôºâ',
            btnClass: 'modal-btn-danger'
          });
        }
      }
    };
    
    // USBÁµåÁî±„ÅßÂç∞Âà∑
    async function printViaUSB(text) {
      if (!USB_DEVICE) {
        throw new Error('USB„Éó„É™„É≥„Çø„ÅåÊé•Á∂ö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
      }
      
      try {
        const command = createESCPOSCommand(text);
        
        console.log('üì§ USBÂç∞Âà∑„Éá„Éº„ÇøÈÄÅ‰ø°‰∏≠... (' + command.length + ' bytes)');
        await USB_DEVICE.transferOut(1, command);
        
        console.log('‚úÖ USBÂç∞Âà∑ÂÆå‰∫Ü');
      } catch (error) {
        console.error('‚ùå USBÂç∞Âà∑„Ç®„É©„Éº:', error);
        
        // „Éá„Éê„Ç§„Çπ„Çí„ÇØ„É≠„Éº„Ç∫„Åó„Å¶ÂÜçÊé•Á∂ö„Çí‰øÉ„Åô
        if (USB_DEVICE) {
          try {
            await USB_DEVICE.close();
          } catch (e) {
            console.error('„Éá„Éê„Ç§„Çπ„ÇØ„É≠„Éº„Ç∫„Ç®„É©„Éº:', e);
          }
          USB_DEVICE = null;
        }
        
        throw error;
      }
    }
    
    window.showPrinterSettings = function() {
      // Ê©üËÉΩ„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('printerIPInput').value = PRINTER_IP;
      
      // „Éó„É≠„Ç≠„Ç∑URL„ÅÆÂæ©ÂÖÉ
      const savedProxyURL = localStorage.getItem('printerProxyURL') || 'http://192.168.1.100:3000';
      const proxyInput = document.getElementById('printerProxyInput');
      if (proxyInput) {
        proxyInput.value = savedProxyURL;
      }
      
      selectConnectionType(PRINTER_CONNECTION_TYPE);
      
      // Bluetooth„Éá„Éê„Ç§„ÇπÊÉÖÂ†±„ÅÆÂæ©ÂÖÉ
      const savedDeviceName = localStorage.getItem('bluetoothDeviceName');
      if (savedDeviceName && PRINTER_CONNECTION_TYPE === 'bluetooth') {
        document.getElementById('bluetoothDeviceInfo').style.display = 'block';
        document.getElementById('bluetoothDeviceName').textContent = savedDeviceName + ' (ÂÜçÊé•Á∂ö„ÅåÂøÖË¶Å)';
      }
      
      // USB„Éá„Éê„Ç§„ÇπÊÉÖÂ†±„ÅÆÂæ©ÂÖÉ
      const savedUsbName = localStorage.getItem('usbDeviceName');
      if (savedUsbName && PRINTER_CONNECTION_TYPE === 'usb') {
        document.getElementById('usbDeviceInfo').style.display = 'block';
        document.getElementById('usbDeviceName').textContent = savedUsbName + ' (ÂÜçÊé•Á∂ö„ÅåÂøÖË¶Å)';
      }
      
      document.getElementById('printerSettingsModal').style.display = 'flex';
      document.getElementById('printerTestResult').style.display = 'none';
    };
    
    window.closePrinterSettingsModal = function() {
      document.getElementById('printerSettingsModal').style.display = 'none';
    };
    
    window.savePrinterSettings = async function() {
      if (PRINTER_CONNECTION_TYPE === 'ethernet') {
        const newIP = document.getElementById('printerIPInput').value.trim();
        
        const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
        if (!ipPattern.test(newIP)) {
          await showCustomAlert({ 
            icon: '', 
            title: '„Ç®„É©„Éº', 
            message: 'Ê≠£„Åó„ÅÑIP„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n‰æã: 192.168.1.100', 
            btnClass: 'modal-btn-danger' 
          });
          return;
        }
        
        PRINTER_IP = newIP;
        localStorage.setItem('printerIP', newIP);
        localStorage.setItem('printerConnectionType', 'ethernet');
        
        await showCustomAlert({ 
          icon: '', 
          title: '‰øùÂ≠òÂÆå‰∫Ü', 
          message: '„Éó„É™„É≥„ÇøË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü\nÊé•Á∂öÊñπÂºè: WiFi/LAN\nIP: ' + newIP, 
          btnClass: 'modal-btn-success' 
        });
      } else if (PRINTER_CONNECTION_TYPE === 'bluetooth') {
        if (!BLUETOOTH_DEVICE) {
          await showCustomAlert({ 
            icon: '', 
            title: '„Ç®„É©„Éº', 
            message: 'Bluetooth„Éó„É™„É≥„Çø„ÇíÊ§úÁ¥¢„Åó„Å¶Êé•Á∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 
            btnClass: 'modal-btn-danger' 
          });
          return;
        }
        
        localStorage.setItem('printerConnectionType', 'bluetooth');
        await showCustomAlert({ 
          icon: '', 
          title: '‰øùÂ≠òÂÆå‰∫Ü', 
          message: '„Éó„É™„É≥„ÇøË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü\nÊé•Á∂öÊñπÂºè: Bluetooth\n„Éá„Éê„Ç§„Çπ: ' + (BLUETOOTH_DEVICE.name || '‰∏çÊòé'), 
          btnClass: 'modal-btn-success' 
        });
      } else if (PRINTER_CONNECTION_TYPE === 'usb') {
        if (!USB_DEVICE) {
          await showCustomAlert({ 
            icon: '', 
            title: '„Ç®„É©„Éº', 
            message: 'USB„Éó„É™„É≥„Çø„ÇíÊé•Á∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 
            btnClass: 'modal-btn-danger' 
          });
          return;
        }
        
        localStorage.setItem('printerConnectionType', 'usb');
        await showCustomAlert({ 
          icon: '', 
          title: '‰øùÂ≠òÂÆå‰∫Ü', 
          message: '„Éó„É™„É≥„ÇøË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü\nÊé•Á∂öÊñπÂºè: USB\n„Éá„Éê„Ç§„Çπ: ' + (USB_DEVICE.productName || 'mC-Print3'), 
          btnClass: 'modal-btn-success' 
        });
      } else if (PRINTER_CONNECTION_TYPE === 'proxy') {
        const proxyURL = document.getElementById('printerProxyInput').value.trim();
        
        if (!proxyURL.startsWith('http://') && !proxyURL.startsWith('https://')) {
          await showCustomAlert({ 
            icon: '', 
            title: '„Ç®„É©„Éº', 
            message: 'Ê≠£„Åó„ÅÑURL„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ\n‰æã: http://192.168.1.100:3000', 
            btnClass: 'modal-btn-danger' 
          });
          return;
        }
        
        localStorage.setItem('printerProxyURL', proxyURL);
        localStorage.setItem('printerConnectionType', 'proxy');
        
        await showCustomAlert({ 
          icon: '', 
          title: '‰øùÂ≠òÂÆå‰∫Ü', 
          message: '„Éó„É™„É≥„ÇøË®≠ÂÆö„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü\nÊé•Á∂öÊñπÂºè: „Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éê„Éº\nURL: ' + proxyURL, 
          btnClass: 'modal-btn-success' 
        });
      }
      
      closePrinterSettingsModal();
    };
    
    window.testPrinterConnection = async function() {
      const resultDiv = document.getElementById('printerTestResult');
      
      resultDiv.style.display = 'block';
      resultDiv.style.background = '#FFF9C4';
      resultDiv.style.color = '#F57F17';
      resultDiv.textContent = 'Êé•Á∂ö„ÉÜ„Çπ„Éà‰∏≠...';
      
      try {
        if (PRINTER_CONNECTION_TYPE === 'bluetooth') {
          if (!BLUETOOTH_CHARACTERISTIC) {
            resultDiv.style.background = '#FFCDD2';
            resultDiv.style.color = '#C62828';
            resultDiv.innerHTML = 'Bluetooth„Éó„É™„É≥„Çø„ÅåÊú™Êé•Á∂ö<br>ÂÖà„Å´„Éó„É™„É≥„Çø„ÇíÊ§úÁ¥¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            return;
          }
          
          await printViaBluetooth('=== Êé•Á∂ö„ÉÜ„Çπ„Éà ===\nÂç∞Âà∑ÊàêÂäüÔºÅ\n\n');
          
          resultDiv.style.background = '#C8E6C9';
          resultDiv.style.color = '#2E7D32';
          resultDiv.innerHTML = 'Êé•Á∂öÊàêÂäüÔºÅ<br>Bluetooth„Éó„É™„É≥„Çø„Å®ÈÄö‰ø°„Åß„Åç„Åæ„Åó„Åü';
          
        } else if (PRINTER_CONNECTION_TYPE === 'usb') {
          if (!USB_DEVICE) {
            resultDiv.style.background = '#FFCDD2';
            resultDiv.style.color = '#C62828';
            resultDiv.innerHTML = 'USB„Éó„É™„É≥„Çø„ÅåÊú™Êé•Á∂ö<br>ÂÖà„Å´„Éó„É™„É≥„Çø„ÇíÊé•Á∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            return;
          }
          
          await printViaUSB('=== Êé•Á∂ö„ÉÜ„Çπ„Éà ===\nÂç∞Âà∑ÊàêÂäüÔºÅ\n\n');
          
          resultDiv.style.background = '#C8E6C9';
          resultDiv.style.color = '#2E7D32';
          resultDiv.innerHTML = '‚úÖ Êé•Á∂öÊàêÂäüÔºÅ<br>USB„Éó„É™„É≥„Çø„Å®ÈÄö‰ø°„Åß„Åç„Åæ„Åó„Åü';
          
        } else if (PRINTER_CONNECTION_TYPE === 'proxy') {
          // „Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éê„ÉºÊé•Á∂ö„ÉÜ„Çπ„Éà
          const proxyURL = document.getElementById('printerProxyInput').value.trim();
          
          const response = await fetch(`${proxyURL}/health`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const data = await response.json();
          
          resultDiv.style.background = '#C8E6C9';
          resultDiv.style.color = '#2E7D32';
          resultDiv.innerHTML = `‚úÖ Êé•Á∂öÊàêÂäüÔºÅ<br>„Çµ„Éº„Éê„Éº: ${data.serverIP}:${data.serverPort}<br>„Éó„É™„É≥„Çø„ÉºÊï∞: ${data.printers}`;
          
        } else {
          // EthernetÊé•Á∂ö„ÉÜ„Çπ„Éà
          const testIP = document.getElementById('printerIPInput').value.trim();
          
          // IP„Ç¢„Éâ„É¨„Çπ„ÅÆ„Éê„É™„Éá„Éº„Ç∑„Éß„É≥
          const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
          if (!ipPattern.test(testIP)) {
            resultDiv.style.background = '#FFCDD2';
            resultDiv.style.color = '#C62828';
            resultDiv.innerHTML = '‚ùå „Ç®„É©„Éº<br>Ê≠£„Åó„ÅÑIP„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
            return;
          }
          
          // HTTPS„Åã„ÇâHTTP„Å∏„ÅÆ„É™„ÇØ„Ç®„Çπ„Éà„ÉÅ„Çß„ÉÉ„ÇØ
          if (window.location.protocol === 'https:') {
            resultDiv.style.background = '#FFF9C4';
            resultDiv.style.color = '#F57F17';
            resultDiv.innerHTML = '‚ö†Ô∏è HTTPSÁí∞Â¢É„Åß„ÅØWi-Fi/LANÂç∞Âà∑„ÅØÂà∂Èôê„Åï„Çå„Åæ„Åô<br><small>HTTP„Çµ„Ç§„Éà„Åß„Ç¢„ÇØ„Çª„Çπ„Åô„Çã„Åã„ÄÅBluetooth„Éó„É™„É≥„Çø„Éº„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ</small>';
            return;
          }
          
          // StarWebPrintBuilder„ÅåÂà©Áî®ÂèØËÉΩ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
          if (typeof StarWebPrintBuilder === 'undefined' || typeof StarWebPrintTrader === 'undefined') {
            resultDiv.style.background = '#FFF9C4';
            resultDiv.style.color = '#F57F17';
            resultDiv.innerHTML = '‚ö†Ô∏è WiFi/LANÊé•Á∂ö„ÉÜ„Çπ„Éà„ÅØÁèæÂú®Âà©Áî®„Åß„Åç„Åæ„Åõ„Çì<br><small>StarWebPrint„É©„Ç§„Éñ„É©„É™„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ<br>„Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éê„Éº„Åæ„Åü„ÅØBluetooth„Çí„ÅîÂà©Áî®„Åè„Å†„Åï„ÅÑ„ÄÇ</small>';
            console.error('StarWebPrintÊú™ÂÆöÁæ©:', {
              Builder: typeof StarWebPrintBuilder,
              Trader: typeof StarWebPrintTrader
            });
            return;
          }
          
          const builder = new StarWebPrintBuilder();
          builder.createInitializationElement();
          builder.createTextElement({data: '=== Êé•Á∂ö„ÉÜ„Çπ„Éà ===\n'});
          builder.createTextElement({data: 'Âç∞Âà∑ÊàêÂäüÔºÅ\n\n'});
          builder.createCutPaperElement({feed: true});
          
          const url = `http://${testIP}/StarWebPRNT/SendMessage`;
          const request = builder.toString();
          
          const trader = new StarWebPrintTrader({url: url});
          
          trader.onReceive = function(response) {
            console.log('‚úÖ Êé•Á∂ö„ÉÜ„Çπ„ÉàÊàêÂäü:', response);
            resultDiv.style.background = '#C8E6C9';
            resultDiv.style.color = '#2E7D32';
            resultDiv.innerHTML = '‚úÖ Êé•Á∂öÊàêÂäüÔºÅ<br>„Éó„É™„É≥„Çø„Å®ÈÄö‰ø°„Åß„Åç„Åæ„Åó„Åü';
          };
          
          trader.onError = function(response) {
            console.error('‚ùå Êé•Á∂ö„ÉÜ„Çπ„ÉàÂ§±Êïó:', response);
            resultDiv.style.background = '#FFCDD2';
            resultDiv.style.color = '#C62828';
            resultDiv.innerHTML = `‚ùå Êé•Á∂öÂ§±Êïó<br>${response.status || '„Éó„É™„É≥„Çø„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì'}<br><small>IP„Ç¢„Éâ„É¨„Çπ„Å®„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>`;
          };
          
          await trader.sendMessage(request);
        }
        
      } catch (error) {
        console.error('Êé•Á∂ö„ÉÜ„Çπ„Éà„Ç®„É©„Éº:', error);
        resultDiv.style.background = '#FFCDD2';
        resultDiv.style.color = '#C62828';
        resultDiv.innerHTML = '„Ç®„É©„Éº<br>' + error.message;
      }
    };
    
    // ========================================
    // üóÑÔ∏è „Éâ„É≠„Ç¢Ë®≠ÂÆöÊ©üËÉΩ
    // ========================================
    
    // WiFiËá™ÂãïË®≠ÂÆöÔºà„Éì„Ç∏„Éç„Çπ„É¢„Éá„É´Áî®Ôºâ
    window.showDrawerSettings = function() {
      playTapSound();
      const menu = document.getElementById('functionsSubMenu');
      if (menu) menu.style.display = 'none';
      
      // Êñ∞„Åó„ÅÑWiFiËá™ÂãïË®≠ÂÆö„ÇíÈñã„Åè
      openWiFiSetup();
    };
    
    // WiFiËá™ÂãïË®≠ÂÆöÊ©üËÉΩ
    window.openWiFiSetup = function() {
      document.getElementById('wifiAutoSetupModal').style.display = 'flex';
      document.getElementById('wifiSetupResult').style.display = 'none';
      
      // ÁèæÂú®„ÅÆ„Éâ„É≠„Ç¢IPË®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
      document.getElementById('drawerIpInput').value = localStorage.getItem('drawerIp') || '';
      
      // ÁèæÂú®„ÅÆWiFiÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
      checkCurrentWiFiStatus();
    };

    window.closeWiFiSetup = function() {
      document.getElementById('wifiAutoSetupModal').style.display = 'none';
    };
    
    window.closeDrawerSettingsModal = function() {
      // ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„Åô
      closeWiFiSetup();
    };

    // ÁèæÂú®„ÅÆWiFiÁä∂ÊÖã„ÇíÁ¢∫Ë™ç
    async function checkCurrentWiFiStatus() {
      const statusDiv = document.getElementById('currentWiFiStatus');
      const drawerIp = localStorage.getItem('drawerIp');
      
      if (!drawerIp) {
        statusDiv.innerHTML = '‚ùå „Éâ„É≠„Ç¢IP„ÅåÊú™Ë®≠ÂÆö„Åß„Åô<br><small style="font-size: 12px;">‰∏ãË®ò„Åß„Éâ„É≠„Ç¢IP„Ç¢„Éâ„É¨„Çπ„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>';
        return;
      }

      statusDiv.innerHTML = 'üîç Êé•Á∂öÁ¢∫Ë™ç‰∏≠...';
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 3000);
        
        const response = await fetch(`http://${drawerIp}:3000/wifi/status`, {
          method: 'GET',
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        const data = await response.json();
        
        if (data.success && data.wifi) {
          if (data.wifi.ssid) {
            statusDiv.innerHTML = `
              ‚úÖ WiFiÊé•Á∂öÊ∏à„Åø<br>
              <small style="font-size: 12px;">SSID: ${data.wifi.ssid}</small><br>
              <small style="font-size: 12px;">IP: ${data.wifi.ip || 'ÂèñÂæó‰∏≠...'}</small>
            `;
          } else {
            statusDiv.innerHTML = '‚ö†Ô∏è WiFiÊú™Êé•Á∂ö<br><small style="font-size: 12px;">‰∏ãË®ò„Éï„Ç©„Éº„É†„Åã„ÇâË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>';
          }
        } else {
          statusDiv.innerHTML = '‚ùì Áä∂ÊÖã‰∏çÊòé';
        }
      } catch (error) {
        statusDiv.innerHTML = `
          ‚ùå Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì<br>
          <small style="font-size: 12px;">Raspberry Pi„ÅÆÈõªÊ∫ê„Å®IP„Ç¢„Éâ„É¨„Çπ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>
        `;
      }
    }

    // „Éâ„É≠„Ç¢IP„Ç¢„Éâ„É¨„Çπ„Çí‰øùÂ≠ò
    window.saveDrawerIP = async function() {
      const ip = document.getElementById('drawerIpInput').value.trim();
      const resultDiv = document.getElementById('wifiSetupResult');
      
      if (!ip) {
        resultDiv.style.display = 'block';
        resultDiv.style.background = '#fff3cd';
        resultDiv.style.color = '#856404';
        resultDiv.textContent = '‚ö†Ô∏è IP„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        return;
      }
      
      const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
      if (!ipPattern.test(ip)) {
        resultDiv.style.display = 'block';
        resultDiv.style.background = '#f8d7da';
        resultDiv.style.color = '#721c24';
        resultDiv.innerHTML = '‚ùå Ê≠£„Åó„ÅÑIP„Ç¢„Éâ„É¨„Çπ„ÅÆÂΩ¢Âºè„ÅßÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ<br><small>Ôºà‰æã: 192.168.1.100Ôºâ</small>';
        return;
      }
      
      localStorage.setItem('drawerIp', ip);
      localStorage.setItem('drawerDuration', '500');
      
      resultDiv.style.display = 'block';
      resultDiv.style.background = '#d4edda';
      resultDiv.style.color = '#155724';
      resultDiv.textContent = '‚úÖ „Éâ„É≠„Ç¢IP„Ç¢„Éâ„É¨„Çπ„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü: ' + ip;
      
      // WiFiÁä∂ÊÖã„ÇíÂÜçÁ¢∫Ë™ç
      setTimeout(() => {
        checkCurrentWiFiStatus();
      }, 1000);
    };
    
    // WiFiË®≠ÂÆö„Çí‰øùÂ≠òÔºà‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
    window.saveDrawerSettings = async function() {
      await saveDrawerIP();
    };

    // WiFiË®≠ÂÆö„Çí‰øùÂ≠ò
    window.saveWiFiSettings = async function() {
      const ssid = document.getElementById('wifiSSID').value.trim();
      const password = document.getElementById('wifiPassword').value;
      const resultDiv = document.getElementById('wifiSetupResult');
      const drawerIp = localStorage.getItem('drawerIp');
      
      if (!drawerIp) {
        resultDiv.style.display = 'block';
        resultDiv.style.background = '#f8d7da';
        resultDiv.style.color = '#721c24';
        resultDiv.innerHTML = '‚ùå „Ç®„É©„Éº: „Éâ„É≠„Ç¢IP„ÅåÊú™Ë®≠ÂÆö„Åß„Åô<br><small style="font-size: 12px;">‰∏äË®ò„ÅÆ„Äå„Éâ„É≠„Ç¢IP„Ç¢„Éâ„É¨„Çπ„Äç„ÇíÂÖà„Å´Ë®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>';
        return;
      }

      if (!ssid) {
        resultDiv.style.display = 'block';
        resultDiv.style.background = '#fff3cd';
        resultDiv.style.color = '#856404';
        resultDiv.textContent = '‚ö†Ô∏è WiFiÂêçÔºàSSIDÔºâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        return;
      }
      
      if (!password) {
        resultDiv.style.display = 'block';
        resultDiv.style.background = '#fff3cd';
        resultDiv.style.color = '#856404';
        resultDiv.textContent = '‚ö†Ô∏è WiFi„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ';
        return;
      }
      
      resultDiv.style.display = 'block';
      resultDiv.style.background = '#cff4fc';
      resultDiv.style.color = '#055160';
      resultDiv.textContent = '‚è≥ WiFiË®≠ÂÆö„ÇíÈÄÅ‰ø°‰∏≠...';
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);
        
        const response = await fetch(`http://${drawerIp}:3000/wifi/configure`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ssid, password }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);
        const data = await response.json();
        
        if (data.success) {
          resultDiv.style.background = '#d4edda';
          resultDiv.style.color = '#155724';
          resultDiv.innerHTML = `
            ‚úÖ ${data.message}<br>
            <small style="font-size: 12px;">WiFi„Å´Êé•Á∂ö„Åó„Å¶„ÅÑ„Åæ„ÅôÔºàÊï∞Áßí„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑÔºâ</small>
          `;
          
          setTimeout(() => {
            checkCurrentWiFiStatus();
          }, 5000);
        } else {
          resultDiv.style.background = '#f8d7da';
          resultDiv.style.color = '#721c24';
          resultDiv.innerHTML = `
            ‚ùå Ë®≠ÂÆö„Ç®„É©„Éº: ${data.error}<br>
            <small style="font-size: 12px;">SSID„Å®„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>
          `;
        }
      } catch (error) {
        resultDiv.style.background = '#f8d7da';
        resultDiv.style.color = '#721c24';
        if (error.name === 'AbortError') {
          resultDiv.innerHTML = `
            ‚ùå „Çø„Ç§„É†„Ç¢„Ç¶„Éà<br>
            <small style="font-size: 12px;">Raspberry Pi„Å®„ÅÆÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>
          `;
        } else {
          resultDiv.innerHTML = `
            ‚ùå Êé•Á∂ö„Ç®„É©„Éº: ${error.message}<br>
            <small style="font-size: 12px;">Raspberry Pi„ÅÆÈõªÊ∫ê„Å®IP„Ç¢„Éâ„É¨„Çπ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ</small>
          `;
        }
      }
    };
    
    window.testDrawerConnection = async function() {
      const ip = localStorage.getItem('drawerIp');
      const resultDiv = document.getElementById('wifiSetupResult');
      
      if (!ip) {
        await showCustomAlert({ icon: '‚ö†Ô∏è', title: 'ÂÖ•Âäõ„Ç®„É©„Éº', message: 'IP„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', btnClass: 'modal-btn-danger' });
        return;
      }
      
      resultDiv.style.display = 'block';
      resultDiv.style.background = '#cff4fc';
      resultDiv.style.color = '#055160';
      resultDiv.innerHTML = '„ÉÜ„Çπ„Éà‰∏≠...„Éâ„É≠„Ç¢„ÇíÈñã„Åç„Åæ„Åô...';
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`http://${ip}:3000/open`, {
          method: 'POST',
          signal: controller.signal,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ duration: 500 })
        });
        
        clearTimeout(timeoutId);
        
        if (response.ok) {
          resultDiv.style.background = '#d4edda';
          resultDiv.style.color = '#155724';
          resultDiv.innerHTML = '‚úÖ Êé•Á∂öÊàêÂäüÔºÅ„Éâ„É≠„Ç¢„ÅåÈñã„Åç„Åæ„Åó„Åü';
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        resultDiv.style.background = '#f8d7da';
        resultDiv.style.color = '#721c24';
        
        if (error.name === 'AbortError') {
          resultDiv.innerHTML = '‚ùå „Çø„Ç§„É†„Ç¢„Ç¶„Éà: „Éâ„É≠„Ç¢„Å´Êé•Á∂ö„Åß„Åç„Åæ„Åõ„Çì„Åß„Åó„Åü';
        } else {
          resultDiv.innerHTML = '‚ùå Êé•Á∂öÂ§±Êïó: ' + error.message;
        }
      }
    };
    
    // ========================================
    // üì¶ Âú®Â∫´‰∏ÄÊã¨Ë®≠ÂÆöÊ©üËÉΩ
    // ========================================
    
    // Âú®Â∫´‰∏ÄÊã¨Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
    window.showBulkInventoryModal = function() {
      playTapSound();
      
      // Ê©üËÉΩ„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
      const functionsMenu = document.getElementById('functionsSubMenu');
      if (functionsMenu) {
        functionsMenu.style.display = 'none';
      }
      
      document.getElementById('bulkInventoryModal').style.display = 'flex';
    };
    
    // Âú®Â∫´‰∏ÄÊã¨Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
    window.closeBulkInventoryModal = function() {
      document.getElementById('bulkInventoryModal').style.display = 'none';
    };
    
    // ÂÖ®ÂïÜÂìÅ„Çí‰∏ÄÊã¨„ÅßÂìÅÂàá„Çå„Å´„Åô„Çã
    window.bulkSetInventoryToZero = async function() {
      const confirmed = await showCustomConfirm(
        'ÂÖ®ÂïÜÂìÅ„ÇíÂìÅÂàá„ÇåÔºàÂú®Â∫´0Ôºâ„Å´Ë®≠ÂÆö„Åó„Åæ„Åô„ÅãÔºü\n\n‰ºëÊ•≠Êó•„Å™„Å©„Å´‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ',
        'ÂÖ®ÂïÜÂìÅÂìÅÂàá'
      );
      if (!confirmed) return;
      
      try {
        // ÂÖ®ÂïÜÂìÅ„ÇíÂèñÂæó
        const menusRef = getStoreCollection('menus');
        const menusSnapshot = await getDocs(menusRef);
        
        // Âú®Â∫´Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
        const inventoryRef = getStoreDoc('inventory_settings', 'default');
        const inventorySnap = await getDoc(inventoryRef);
        const inventorySettings = inventorySnap.exists() ? inventorySnap.data().items || {} : {};
        
        // ÂÖ®ÂïÜÂìÅ„ÇíÂú®Â∫´0„Å´Ë®≠ÂÆö
        const newSettings = { ...inventorySettings };
        let count = 0;
        
        menusSnapshot.forEach(doc => {
          const data = doc.data();
          const itemId = data.id || doc.id;
          
          newSettings[itemId] = {
            ...newSettings[itemId],
            stock: 0
          };
          count++;
        });
        
        // ‰øùÂ≠ò
        await setDoc(inventoryRef, {
          items: newSettings,
          updatedAt: new Date().toISOString()
        });
        
        showCustomAlert(`${count}‰ª∂„ÅÆÂïÜÂìÅ„ÇíÂìÅÂàá„Çå„Å´Ë®≠ÂÆö„Åó„Åæ„Åó„Åü`, 'ÂÆå‰∫Ü');
        console.log('‚úÖ ÂÖ®ÂïÜÂìÅÂìÅÂàá„ÇåË®≠ÂÆöÂÆå‰∫Ü:', count, '‰ª∂');
        
        closeBulkInventoryModal();
      } catch (error) {
        console.error('‚ùå ÂÖ®ÂïÜÂìÅÂìÅÂàá„ÇåË®≠ÂÆö„Ç®„É©„Éº:', error);
        showCustomAlert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message, '„Ç®„É©„Éº');
      }
    };
    
    // ÂÖ®ÂïÜÂìÅ„Çí‰∏ÄÊã¨„ÅßÂæ©Ê¥ª„Åï„Åõ„ÇãÔºàÂú®Â∫´0„ÇíËß£Èô§Ôºâ
    window.bulkClearInventoryZero = async function() {
      const confirmed = await showCustomConfirm(
        'ÂÖ®ÂïÜÂìÅ„ÅÆÂìÅÂàá„Çå„ÇíËß£Èô§„Åó„Åæ„Åô„ÅãÔºü\n\nÂÖ®„Å¶„ÅÆÂïÜÂìÅ„ÅåÁÑ°ÈôêÂú®Â∫´ÔºàÊú™Ë®≠ÂÆöÔºâ„Å´Êàª„Çä„Åæ„Åô„ÄÇ\n„Åì„ÅÆÊìç‰Ωú„ÅØÂèñ„ÇäÊ∂à„Åõ„Åæ„Åõ„Çì„ÄÇ',
        'ÂÖ®ÂïÜÂìÅÂæ©Ê¥ª'
      );
      if (!confirmed) return;
      
      try {
        // ÂÖ®ÂïÜÂìÅ„ÇíÂèñÂæó
        const menusRef = getStoreCollection('menus');
        const menusSnapshot = await getDocs(menusRef);
        
        // Âú®Â∫´Ë®≠ÂÆö„ÇíË™≠„ÅøËæº„Åø
        const inventoryRef = getStoreDoc('inventory_settings', 'default');
        const inventorySnap = await getDoc(inventoryRef);
        const inventorySettings = inventorySnap.exists() ? inventorySnap.data().items || {} : {};
        
        // Âú®Â∫´0„ÅÆÂïÜÂìÅ„ÇíÁÑ°ÈôêÂú®Â∫´„Å´Êàª„Åô
        const newSettings = { ...inventorySettings };
        let count = 0;
        
        menusSnapshot.forEach(doc => {
          const data = doc.data();
          const itemId = data.id || doc.id;
          
          // Âú®Â∫´„Åå0„ÅÆÂïÜÂìÅ„ÅÆ„ÅøÂØæË±°
          if (newSettings[itemId]?.stock === 0) {
            newSettings[itemId] = {
              ...newSettings[itemId],
              stock: null,
              alertThreshold: null
            };
            count++;
          }
        });
        
        // ‰øùÂ≠ò
        await setDoc(inventoryRef, {
          items: newSettings,
          updatedAt: new Date().toISOString()
        });
        
        showCustomAlert(`${count}‰ª∂„ÅÆÂïÜÂìÅ„ÇíÂæ©Ê¥ª„Åï„Åõ„Åæ„Åó„Åü`, 'ÂÆå‰∫Ü');
        console.log('‚úÖ ÂÖ®ÂïÜÂìÅÂæ©Ê¥ªÂÆå‰∫Ü:', count, '‰ª∂');
        
        closeBulkInventoryModal();
      } catch (error) {
        console.error('‚ùå ÂÖ®ÂïÜÂìÅÂæ©Ê¥ª„Ç®„É©„Éº:', error);
        showCustomAlert('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü: ' + error.message, '„Ç®„É©„Éº');
      }
    };
    
    // ========================================
    // Âç≥‰ºöË®àÊ©üËÉΩ
    // ========================================
    
    // Âç≥‰ºöË®à„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
    window.openInstantCheckout = async function() {
      console.log('Âç≥‰ºöË®à„É¢„Éº„Éâ„ÇíÈñãÂßã');
      playTapSound();
      
      // Ê©üËÉΩ„É°„Éã„É•„Éº„ÇíÈñâ„Åò„Çã
      const functionsMenu = document.getElementById('functionsSubMenu');
      if (functionsMenu) {
        functionsMenu.style.display = 'none';
      }
      
      try {
        // Âç≥‰ºöË®à„É¢„Éº„Éâ„Éï„É©„Ç∞„ÇíË®≠ÂÆö
        isInstantCheckoutMode = true;
        
        // POS„É¢„Éº„ÉÄ„É´„ÇíÈñã„ÅÑ„Å¶menu.html„ÇíË°®Á§∫ÔºàÂç≥‰ºöË®à„É¢„Éº„ÉâÔºâ
        const modal = document.getElementById('posIframeModal');
        const iframe = document.getElementById('posIframe');
        const modalTitle = document.getElementById('posModalTitle');
        
        if (modal && iframe && modalTitle) {
          // „É¢„Éº„ÉÄ„É´„Çø„Ç§„Éà„É´„ÇíË®≠ÂÆö
          modalTitle.textContent = 'Âç≥‰ºöË®à';
          
          // menu.html„ÇíÂç≥‰ºöË®à„É¢„Éº„Éâ„ÅßÈñã„Åè
          const menuUrl = `menu.html?table=Âç≥‰ºöË®à&store=${currentStoreId}&mode=handy&instant=true`;
          console.log('üì± menu.html„ÇíÈñã„Åè:', menuUrl);
          iframe.src = menuUrl;
          
          // „É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
          modal.classList.add('active');
        }
        
      } catch (error) {
        console.error('‚ùå Âç≥‰ºöË®à„É¢„Éº„ÉâËµ∑Âãï„Ç®„É©„Éº:', error);
        await showCustomAlert({
          title: '„Ç®„É©„Éº',
          message: 'Âç≥‰ºöË®à„É¢„Éº„Éâ„ÅÆËµ∑Âãï„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message,
          type: 'error'
        });
      }
    };
    
    // Âç≥‰ºöË®àÂá¶ÁêÜ(POS„Åã„ÇâÁßªÊ§ç)- iframeÂÜÖ„Åã„Çâ„ÅÆÊ≥®ÊñáÂÆå‰∫ÜÊôÇ„Å´Âëº„Å∞„Çå„Çã
    window.processInstantCheckout = async function(orderData) {
      console.log('Âç≥‰ºöË®àÂá¶ÁêÜÈñãÂßã');
      console.log('Âèó‰ø°„Åó„ÅüÁîü„Éá„Éº„Çø:', orderData);
      console.log('üõç Âèó‰ø°„Åó„Åü„É¨„Ç∏Ë¢ãÊÉÖÂ†±ÔºàÁîü„Éá„Éº„ÇøÔºâ:', {
        bagNeeded: orderData.bagNeeded,
        bagQuantity: orderData.bagQuantity,
        bagPrice: orderData.bagPrice
      });
      
      try {
        // „É¨„Ç∏Ë¢ãÊÉÖÂ†±„ÇíÁ¢∫ÂÆü„Å´orderData„Å´Âê´„ÇÅ„Çã
        const processedOrderData = {
          ...orderData,
          bagNeeded: orderData.bagNeeded || false,
          bagQuantity: orderData.bagQuantity || 0,
          bagPrice: orderData.bagPrice || 0
        };
        
        console.log('‚úÖ Âá¶ÁêÜÂæå„ÅÆ„É¨„Ç∏Ë¢ãÊÉÖÂ†±:', {
          bagNeeded: processedOrderData.bagNeeded,
          bagQuantity: processedOrderData.bagQuantity,
          bagPrice: processedOrderData.bagPrice
        });
        
        console.log('üì¶ ÂÆåÂÖ®„Å™processedOrderData:', processedOrderData);
        
        // currentOrders„Å´Ë®≠ÂÆö
        currentOrders = [processedOrderData];
        console.log('currentOrders„Å´Ë®≠ÂÆöÂÆå‰∫Ü:', currentOrders);
        
        // POS„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
        const modal = document.getElementById('posIframeModal');
        if (modal) {
          modal.classList.remove('active');
        }
        
        // Âç≥‰ºöË®à„Éï„É©„Ç∞„ÇíË®≠ÂÆöÔºà„É¨„Ç∏Ë¢ãÊÉÖÂ†±„ÇÇ‰øùÂ≠òÔºâ
        const orderRef = doc(db, 'stores', currentStoreId, 'orders', orderData.id);
        await updateDoc(orderRef, {
          directPayment: true,
          handyOrder: true,
          bagNeeded: processedOrderData.bagNeeded,
          bagQuantity: processedOrderData.bagQuantity,
          bagPrice: processedOrderData.bagPrice
        });
        
        console.log(' Firestore„Å´‰øùÂ≠ò„Åó„Åü„É¨„Ç∏Ë¢ãÊÉÖÂ†±:', {
          bagNeeded: processedOrderData.bagNeeded,
          bagQuantity: processedOrderData.bagQuantity,
          bagPrice: processedOrderData.bagPrice
        });
        
        // „ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö„ÇíÂèñÂæó
        currentTableSettings = await getTableSettings('Âç≥‰ºöË®à');
        console.log('„ÉÜ„Éº„Éñ„É´Ë®≠ÂÆö(Âç≥‰ºöË®à):', currentTableSettings);
        
        // ‰ºöË®à„É¢„Éº„ÉÄ„É´„ÇíË°®Á§∫
        setTimeout(() => {
          // Ê≥®ÊñáÁï™Âè∑„ÇíË°®Á§∫
          document.getElementById('selectedTableLabel2').textContent = `Âç≥‰ºöË®à - Ê≥®Êñá #${orderData.orderNumber || '1'}`;
          
          // Á®éÁéá„Ç¢„Ç§„ÉÜ„É†„ÇíÁîüÊàêÔºà„É¨„Ç∏Ë¢ãÊÉÖÂ†±„ÇíÂê´„ÇÄÔºâ
          console.log('üìùüìùüìù generateTaxRateItems„ÇíÂëº„Å≥Âá∫„Åó„Åæ„Åô üìùüìùüìù');
          console.log('Ê∏°„Åô„Éá„Éº„Çø:', processedOrderData);
          console.log('Ê∏°„Åô„É¨„Ç∏Ë¢ãÊÉÖÂ†±:', {
            bagNeeded: processedOrderData.bagNeeded,
            bagQuantity: processedOrderData.bagQuantity,
            bagPrice: processedOrderData.bagPrice
          });
          generateTaxRateItems([processedOrderData], 'Âç≥‰ºöË®à');
          
          document.getElementById('discountAmount').value = '0';
          updatePaymentTotal();
          document.getElementById('paymentModal').classList.remove('hidden');
          selectedPaymentMethod = null;
          document.querySelectorAll('.payment-method-btn').forEach(btn => {
            btn.classList.remove('selected');
          });
          document.getElementById('cashInputSection').classList.add('hidden');
          document.getElementById('completePaymentBtn').disabled = true;
        }, 500);
        
        // Âç≥‰ºöË®à„É¢„Éº„Éâ„Çí„É™„Çª„ÉÉ„Éà
        isInstantCheckoutMode = false;
        
      } catch (error) {
        console.error('‚ùå Âç≥‰ºöË®àÂá¶ÁêÜ„Ç®„É©„Éº:', error);
        await showCustomAlert({
          title: '„Ç®„É©„Éº',
          message: 'Âç≥‰ºöË®à„ÅÆÂá¶ÁêÜ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + error.message,
          type: 'error'
        });
      }
    };
    
    // menu.html„Åã„Çâ„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÂèó‰ø°
    window.addEventListener('message', function(event) {
      console.log('üì® „É°„ÉÉ„Çª„Éº„Ç∏Âèó‰ø°:', event.data);
      
      if (event.data && event.data.type === 'orderCreated' && isInstantCheckoutMode) {
        // Âç≥‰ºöË®à„É¢„Éº„Éâ„ÅßÊ≥®Êñá„Åå‰ΩúÊàê„Åï„Çå„ÅüÂ†¥Âêà
        console.log('Âç≥‰ºöË®à„É¢„Éº„Éâ: Ê≥®Êñá‰ΩúÊàê„ÇíÊ§úÁü•');
        console.log('üõç „É¨„Ç∏Ë¢ãÊÉÖÂ†±:', {
          bagNeeded: event.data.order.bagNeeded,
          bagQuantity: event.data.order.bagQuantity,
          bagPrice: event.data.order.bagPrice
        });
        processInstantCheckout(event.data.order);
      }
    });
  
  </script>
  
  <!-- Â£≤‰∏ä„É¢„Éº„ÉÄ„É´ -->
  <!-- „É™„Ç¢„É´„Çø„Ç§„É†Âú®Â∫´„Éë„Éç„É´ -->
  <div id="inventoryPanel" style="position: fixed; bottom: 20px; right: 20px; width: 300px; max-height: 400px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 9999; overflow: hidden; transition: all 0.3s ease;">
    <div id="inventoryPanelBar" onclick="playTapSound(); toggleInventoryPanel()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.3s ease;">
      <div style="font-weight: bold; color: white; font-size: 15px;"> Âú®Â∫´Áä∂Ê≥Å</div>
      <div id="inventoryPanelArrow" style="color: white; font-size: 18px;">‚ñº</div>
    </div>
    <div id="inventoryPanelContent" style="max-height: 350px; overflow-y: auto; padding: 10px;">
      <div style="padding: 10px; text-align: center; color: #999;">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
    </div>
  </div>
  
  <!-- üÜï Â£≤‰∏ä„É¢„Éº„ÉÄ„É´ -->
  <div id="salesModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3 id="salesModalTitle">Êú¨Êó•„ÅÆÂ£≤‰∏ä</h3>
        <button class="modal-close" onclick="playTapSound(); closeSalesModal()">√ó</button>
      </div>
      <div id="salesContent" style="padding: 20px; max-height: 60vh; overflow-y: auto;">
        <div style="text-align: center; padding: 20px;">Ë™≠„ÅøËæº„Åø‰∏≠...</div>
      </div>
      <div class="modal-footer" style="display: flex !important; gap: 10px; justify-content: flex-end; padding: 20px; border-top: 1px solid #ddd;">
        <button class="btn btn-secondary" style="padding: 12px 24px;" onclick="playTapSound(); closeSalesModal()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>
  
  <!-- Á≤æÁÆó„É¢„Éº„ÉÄ„É´ -->
  <div id="settlementModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 style="color: #ff6b6b;">Á≤æÁÆóÁ¢∫Ë™ç</h3>
        <button class="modal-close" onclick="playTapSound(); closeSettlementModal()">√ó</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
          <p style="margin: 0 0 10px 0; font-weight: bold; color: #856404;">Ê≥®ÊÑè‰∫ãÈ†Ö:</p>
          <ul style="margin: 0; padding-left: 20px; color: #856404;">
            <li>Êú¨Êó•„ÅÆÂ£≤‰∏ä„Éá„Éº„Çø„ÇíÁ¢∫ÂÆö„Åó„Åæ„Åô</li>
            <li>Á≤æÁÆó„Ç∏„É£„Éº„Éä„É´ÔºàPNGÁîªÂÉèÔºâ„Çí„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„Åæ„Åô</li>
            <li>Â£≤‰∏ä„ÅØÂçàÂâç3ÊôÇ„Å´Ëá™ÂãïÁöÑ„Å´„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åô</li>
          </ul>
        </div>
        <div style="margin: 20px 0;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">Á≤æÁÆóÊó•‰ªò„ÇíÈÅ∏Êäû</label>
          <input type="date" id="settlementDate" onchange="playTapSound(); loadSettlementSummary(this.value)" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
          <p style="font-size: 12px; color: #666; margin-top: 5px;">‚Äª Êò®Êó•„ÅÆÁ≤æÁÆó„Çí‰∏ä„ÅíÂøò„Çå„ÅüÂ†¥Âêà„Å™„Å©„ÄÅÈÅéÂéª„ÅÆÊó•‰ªò„ÇíÈÅ∏Êäû„Åß„Åç„Åæ„Åô</p>
        </div>
        <div id="settlementSummary" style="margin: 20px 0;"></div>
      </div>
      <div class="modal-footer" style="display: flex; flex-direction: column; gap: 10px;">
        <button class="btn" style="width: 100%; background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%); color: white;" onclick="playTapSound(); confirmSettlement()">Á≤æÁÆó„ÇíÂÆüË°å</button>
        <div style="margin-bottom: 10px;">
          <label style="display: block; margin-bottom: 5px; color: #333; font-weight: bold;">Êó•Ë®àË°®Âá∫Âäõ„Åô„ÇãÊúà„ÇíÈÅ∏Êäû:</label>
          <select id="dailyReportMonth" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px;">
            <!-- ÈÅéÂéª12„É∂ÊúàÂàÜ„ÅÆÈÅ∏ÊäûËÇ¢„ÇíÂãïÁöÑ„Å´ÁîüÊàê -->
          </select>
          <button class="btn" style="width: 100%; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="playTapSound(); generateDailyReportForSelectedMonth()">Êó•Ë®àË°®Âá∫Âäõ</button>
        </div>
        <button class="btn btn-secondary" style="width: 100%;" onclick="playTapSound(); closeSettlementModal()">„Ç≠„É£„É≥„Çª„É´</button>
      </div>
    </div>
  </div>
  
  <!-- Â±•Ê≠¥„É¢„Éº„ÉÄ„É´ -->
  <div id="historyModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3>Ê≥®ÊñáÂ±•Ê≠¥</h3>
        <button class="modal-close" onclick="playTapSound(); closeHistoryModal()">√ó</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap;">
          <select id="historyDateFilter" onchange="playTapSound(); filterHistory()" style="padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
            <option value="today">‰ªäÊó•</option>
            <option value="yesterday">Êò®Êó•</option>
            <option value="week">‰ªäÈÄ±</option>
            <option value="month">‰ªäÊúà</option>
            <option value="all">ÂÖ®ÊúüÈñì</option>
          </select>
          <select id="historyStatusFilter" onchange="playTapSound(); filterHistory()" style="padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
            <option value="all">„Åô„Åπ„Å¶</option>
            <option value="deleted">ÂâäÈô§Ê∏à„Åø</option>
            <option value="paid">‰ºöË®àÊ∏à„Åø</option>
            <option value="completed">ÂÆå‰∫Ü</option>
          </select>
          <button onclick="playTapSound(); refreshHistory()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;">Êõ¥Êñ∞</button>
        </div>
        <div id="historyList" style="max-height: 60vh; overflow-y: auto;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="playTapSound(); closeHistoryModal()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>
  
  <!-- Ê≥®ÊñáÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ -->
  <div id="editOrderModal" class="modal-overlay" style="display: none;z-index: 99999; ">
    <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3> Ê≥®ÊñáÁ∑®ÈõÜ</h3>
        <button class="modal-close" onclick="playTapSound(); closeEditOrderModal()">√ó</button>
      </div>
      <div style="padding: 20px;">
        <div id="editOrderContent" style="margin: 20px 0;">
          <!-- JavaScript„ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
        </div>
      </div>
      <div class="modal-footer">
        <div id="editOrderButtons" style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
          <!-- JavaScript„ÅßÂãïÁöÑ„Å´ÁîüÊàê -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- ÊîØÂá∫„É¢„Éº„ÉÄ„É´ -->
  <div id="expenseModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3 style="color: #f093fb;">ÊîØÂá∫ÂÖ•Âäõ</h3>
        <button class="modal-close" onclick="playTapSound(); closeExpenseModal()">√ó</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; gap: 15px;">
          <label style="font-weight: bold; font-size: 16px;">Êó•‰ªò:</label>
          <input type="date" id="expenseDateInput" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 16px; flex: 1;" onchange="playTapSound(); loadExpensesByDate()" />
        </div>
        <div style="margin: 20px 0;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #f5f5f5;">
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Â∫óÂêç</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">ÂãòÂÆöÁßëÁõÆ</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">Ë©≥Á¥∞</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">ÈáëÈ°ç</th>
                <th style="padding: 10px; border: 1px solid #ddd; width: 60px;"></th>
              </tr>
            </thead>
            <tbody id="expenseTableBody"></tbody>
          </table>
          <button class="btn" style="margin-top: 10px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="playTapSound(); addExpenseRow()">Ôºã Ë°å„ÇíËøΩÂä†</button>
          <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; text-align: right;">
            <span style="font-size: 18px; font-weight: bold;">ÂêàË®à: ¬•</span>
            <span id="expenseTotal" style="font-size: 24px; font-weight: bold; color: #f093fb;">0</span>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
        <button class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="playTapSound(); saveExpenses()">‰øùÂ≠ò</button>
        <button class="btn btn-secondary" onclick="playTapSound(); closeExpenseModal()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>
  
  <!-- ÊúàÊ¨°„É¨„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´ -->
  <div id="monthlyReportModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3>ÊúàÊ¨°</h3>
        <button class="modal-close" onclick="playTapSound(); closeMonthlyReportModal()">√ó</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÈñãÂßãÊó•</label>
            <input type="date" id="reportStartDate" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
          </div>
          <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ÁµÇ‰∫ÜÊó•</label>
            <input type="date" id="reportEndDate" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
          </div>
          <button onclick="playTapSound(); generatePeriodJournal()" style="padding: 12px 24px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px;">„Ç∏„É£„Éº„Éä„É´ÁîüÊàê</button>
          </div>
        <div id="monthlyReportContent"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="playTapSound(); closeMonthlyReportModal()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>
  
  <!-- „Éâ„É≠„Ç¢Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
  <!-- WiFiËá™ÂãïË®≠ÂÆö„É¢„Éº„ÉÄ„É´Ôºà„Éì„Ç∏„Éç„Çπ„É¢„Éá„É´Áî®Ôºâ -->
  <div id="wifiAutoSetupModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <h3 style="font-size: 28px; font-weight: bold; text-align: center; margin-bottom: 10px; color: #667eea;">
         WiFiË®≠ÂÆö
      </h3>
      <p style="text-align: center; color: #666; margin-bottom: 30px; font-size: 14px;">
        Â∫óËàó„ÅÆWiFiÊÉÖÂ†±„ÇíÂÖ•Âäõ„Åó„Å¶Raspberry Pi„Å´Êé•Á∂ö„Åó„Åæ„Åô
      </p>
      
      <!-- „Çπ„ÉÜ„ÉÉ„Éó1: „Éâ„É≠„Ç¢IP„Ç¢„Éâ„É¨„ÇπË®≠ÂÆö -->
      <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
        <h4 style="font-size: 16px; font-weight: bold; margin-bottom: 15px; color: #333;">
          „Çπ„ÉÜ„ÉÉ„Éó1: „Éâ„É≠„Ç¢IP„Ç¢„Éâ„É¨„Çπ
        </h4>
        <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #333; font-size: 14px;">
          Raspberry Pi„ÅÆIP„Ç¢„Éâ„É¨„Çπ
        </label>
        <div style="display: flex; gap: 10px;">
          <input 
            type="text" 
            id="drawerIpInput" 
            placeholder="‰æã: 192.168.1.100"
            style="flex: 1; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px;"
          >
          <button 
            onclick="playTapSound(); saveDrawerIP()" 
            style="padding: 15px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 14px; font-weight: bold; cursor: pointer; white-space: nowrap;"
          >
            ‰øùÂ≠ò
          </button>
        </div>
        <small style="display: block; margin-top: 5px; color: #999; font-size: 12px;">
          üí° Raspberry Pi„ÅÆÁÆ°ÁêÜÁîªÈù¢„Å´Ë°®Á§∫„Åï„Çå„Å¶„ÅÑ„ÇãIP„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ
        </small>
      </div>
      
      <!-- „Çπ„ÉÜ„ÉÉ„Éó2: WiFiË®≠ÂÆö -->
      <div style="background: #e7f3ff; padding: 20px; border-radius: 10px; margin-bottom: 25px;">
        <h4 style="font-size: 16px; font-weight: bold; margin-bottom: 15px; color: #333;">
          „Çπ„ÉÜ„ÉÉ„Éó2: WiFiË®≠ÂÆö
        </h4>
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #333; font-size: 14px;">
            WiFiÂêçÔºàSSIDÔºâ
          </label>
          <input 
            type="text" 
            id="wifiSSID" 
            placeholder="‰æã: MyShop-WiFi"
            style="width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px;"
          >
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 8px; color: #333; font-size: 14px;">
            WiFi„Éë„Çπ„ÉØ„Éº„Éâ
          </label>
          <input 
            type="password" 
            id="wifiPassword" 
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            style="width: 100%; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px;"
          >
        </div>

        <div style="background: white; border-left: 4px solid #2196F3; padding: 12px; margin-bottom: 15px; border-radius: 5px;">
          <p style="margin: 0; color: #1976D2; font-size: 12px;">
            üí° <strong>„Éí„É≥„Éà:</strong> WiFi„É´„Éº„Çø„Éº„ÅÆË£èÈù¢„ÇÑÂÅ¥Èù¢„Å´Ë®òËºâ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô
          </p>
        </div>
        
        <button 
          onclick="playTapSound(); saveWiFiSettings()" 
          style="width: 100%; padding: 18px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer;"
        >
           WiFiË®≠ÂÆö„ÇíÈÄÅ‰ø°
        </button>
      </div>
      
      <div id="wifiSetupResult" style="display: none; padding: 15px; border-radius: 10px; margin-bottom: 20px; font-size: 14px;"></div>
      
      <!-- „Çπ„ÉÜ„ÉÉ„Éó3: „ÉÜ„Çπ„Éà -->
      <div style="display: flex; gap: 10px; margin-bottom: 20px;">
        <button 
          onclick="playTapSound(); testDrawerConnection()" 
          style="flex: 1; padding: 18px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer;"
        >
           „Éâ„É≠„Ç¢„ÉÜ„Çπ„Éà
        </button>
        <button 
          onclick="playTapSound(); closeWiFiSetup()" 
          style="flex: 0.4; padding: 18px; background: #6c757d; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer;"
        >
          Èñâ„Åò„Çã
        </button>
      </div>

      <div style="padding: 15px; background: #f8f9fa; border-radius: 10px;">
        <p style="margin: 0 0 10px 0; font-size: 13px; color: #666; font-weight: bold;">
          ÁèæÂú®„ÅÆÁä∂ÊÖã:
        </p>
        <p id="currentWiFiStatus" style="margin: 0; font-size: 13px; color: #495057;">
          Á¢∫Ë™ç‰∏≠...
        </p>
      </div>
    </div>
  </div>
  
  <!-- Êóß„Éâ„É≠„Ç¢Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´Ôºà‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„Åô„ÅåÈùûË°®Á§∫Ôºâ -->
  <div id="drawerSettingsModal" style="display: none;"></div>
  
  <!-- „Éó„É™„É≥„ÇøË®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
  <div id="printerSettingsModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <h3 style="font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 15px; color: #333;">„Éó„É™„É≥„ÇøË®≠ÂÆö</h3>
      <p style="text-align: center; font-size: 16px; color: #666; margin-bottom: 30px;">TSP650II / mC-Print3 / BluetoothÂØæÂøú</p>
      
      <!-- Êé•Á∂öÊñπÂºèÈÅ∏Êäû -->
      <div style="margin-bottom: 25px;">
        <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">Êé•Á∂öÊñπÂºè</label>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
          <button id="connectionTypeEthernet" onclick="playTapSound(); selectConnectionType('ethernet')" 
                  style="padding: 15px 10px; border: 2px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">
            WiFi/LAN
          </button>
          <button id="connectionTypeBluetooth" onclick="playTapSound(); selectConnectionType('bluetooth')" 
                  style="padding: 15px 10px; border: 2px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">
            Bluetooth
          </button>
          <button id="connectionTypeUsb" onclick="playTapSound(); selectConnectionType('usb')" 
                  style="padding: 15px 10px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">
            USBÊé•Á∂ö
          </button>
          <button id="connectionTypeProxy" onclick="playTapSound(); selectConnectionType('proxy')" 
                  style="padding: 15px 10px; border: 2px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">
            „Éó„É≠„Ç≠„Ç∑
          </button>
        </div>
      </div>
      
      <!-- EthernetË®≠ÂÆö -->
      <div id="ethernetSettings" style="display: block;">
        <div style="margin-bottom: 25px;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">„Éó„É™„É≥„ÇøIP„Ç¢„Éâ„É¨„Çπ</label>
          <input type="text" id="printerIPInput" placeholder="‰æã: 192.168.1.100" 
                 style="width: 100%; padding: 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
          <div style="margin-top: 8px; font-size: 14px; color: #666;">
            „Éó„É™„É≥„Çø„ÅÆIP„Ç¢„Éâ„É¨„Çπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ<br>
            <small style="color: #999;">‚Äª„Éó„É™„É≥„Çø„ÅÆË®≠ÂÆöÂç∞Âà∑„ÅßÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô</small>
          </div>
        </div>
      </div>
      
      <!-- BluetoothË®≠ÂÆö -->
      <div id="bluetoothSettings" style="display: none;">
        <div style="margin-bottom: 25px;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">Bluetooth„Éó„É™„É≥„Çø</label>
          <button onclick="playTapSound(); searchBluetoothPrinter()" 
                  style="width: 100%; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; box-shadow: 0 4px 15px rgba(33,150,243,0.3);">
            „Éó„É™„É≥„Çø„ÇíÊ§úÁ¥¢
          </button>
          <div id="bluetoothDeviceInfo" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 8px; display: none;">
            <div style="font-weight: bold; color: #333;">Êé•Á∂öÊ∏à„Åø„Éó„É™„É≥„Çø:</div>
            <div id="bluetoothDeviceName" style="color: #666; margin-top: 5px;">„Å™„Åó</div>
          </div>
          <div style="margin-top: 8px; font-size: 14px; color: #666;">
            ESC/POSÂØæÂøú„ÅÆBluetooth„Éó„É™„É≥„Çø„ÇíÊ§úÁ¥¢„Åó„Åæ„Åô<br>
            <small style="color: #999;">‚ÄªChrome„ÄÅEdge„ÅßÂà©Áî®ÂèØËÉΩ</small>
          </div>
        </div>
      </div>
      
      <!-- USBË®≠ÂÆö -->
      <div id="usbSettings" style="display: none;">
        <div style="margin-bottom: 25px;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">USB„Éó„É™„É≥„Çø</label>
          <button onclick="playTapSound(); connectUSBPrinter()" 
                  style="width: 100%; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; box-shadow: 0 4px 15px rgba(255,152,0,0.3);">
            „Éó„É™„É≥„Çø„ÇíÊé•Á∂ö
          </button>
          <div id="usbDeviceInfo" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 8px; display: none;">
            <div style="font-weight: bold; color: #333;">Êé•Á∂öÊ∏à„Åø„Éó„É™„É≥„Çø:</div>
            <div id="usbDeviceName" style="color: #666; margin-top: 5px;">„Å™„Åó</div>
          </div>
          <div style="margin-top: 8px; font-size: 14px; color: #666;">
            mC-Print3„ÇíUSB„Ç±„Éº„Éñ„É´„ÅßÊé•Á∂ö„Åó„Å¶„Åè„Å†„Åï„ÅÑ<br>
            <small style="color: #999;">‚ÄªChrome„ÄÅEdge„ÅßÂà©Áî®ÂèØËÉΩ</small>
          </div>
        </div>
      </div>
      
      <!-- „Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éê„ÉºË®≠ÂÆö -->
      <div id="proxySettings" style="display: none;">
        <div style="margin-bottom: 25px;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">„Éó„É≠„Ç≠„Ç∑„Çµ„Éº„Éê„ÉºURL</label>
          <input type="text" id="printerProxyInput" placeholder="‰æã: http://192.168.1.100:3000" 
                 style="width: 100%; padding: 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
          <div style="margin-top: 8px; font-size: 14px; color: #666;">
            PC„ÅßNode.js„Çµ„Éº„Éê„Éº„ÇíËµ∑Âãï„Åó„Å¶URL„ÇíÂÖ•Âäõ<br>
            <small style="color: #999;">‚Äª„Çµ„Éº„Éê„ÉºËµ∑ÂãïÊôÇ„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</small>
          </div>
        </div>
      </div>
      
      <div style="margin-bottom: 25px;">
        <button onclick="playTapSound(); testPrinterConnection()" id="testConnectionBtn"
                style="width: 100%; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; box-shadow: 0 4px 15px rgba(76,175,80,0.3);">
          Êé•Á∂ö„ÉÜ„Çπ„Éà
        </button>
        <div id="printerTestResult" style="margin-top: 10px; padding: 10px; border-radius: 8px; display: none;"></div>
      </div>
      
      <div style="display: flex; gap: 15px; margin-top: 30px;">
        <button onclick="playTapSound(); closePrinterSettingsModal()" 
                style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: #e0e0e0; color: #666;">
          „Ç≠„É£„É≥„Çª„É´
        </button>
        <button onclick="playTapSound(); savePrinterSettings()" 
                style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          ‰øùÂ≠ò
        </button>
      </div>
    </div>
  </div>
  
  <!-- üÜï Âú®Â∫´‰∏ÄÊã¨Ë®≠ÂÆö„É¢„Éº„ÉÄ„É´ -->
  <div id="bulkInventoryModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Âú®Â∫´‰∏ÄÊã¨Ë®≠ÂÆö</h3>
        <button class="modal-close" onclick="playTapSound(); closeBulkInventoryModal()">√ó</button>
      </div>
      <div style="padding: 30px;">
        <div style="text-align: center; margin-bottom: 30px;">
          <p style="font-size: 16px; color: #666; line-height: 1.6;">
            ‰ºëÊ•≠Êó•„ÇÑËá®ÊôÇ‰ºëÊ•≠ÊôÇ„Å´‰ΩøÁî®„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ<br>
            ÂÖ®ÂïÜÂìÅ„ÅÆÂú®Â∫´Áä∂ÊÖã„Çí‰∏ÄÊã¨„ÅßÂ§âÊõ¥„Åß„Åç„Åæ„Åô„ÄÇ
          </p>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 15px;">
          <button 
            onclick="playTapSound(); bulkSetInventoryToZero()" 
            style="width: 100%; padding: 20px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(244,67,54,0.3);">
            ÂÖ®ÂïÜÂìÅ„ÇíÂìÅÂàá„Çå„Å´„Åô„Çã
          </button>
          
          <button 
            onclick="playTapSound(); bulkClearInventoryZero()" 
            style="width: 100%; padding: 20px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(255,152,0,0.3);">
            ÂÖ®ÂïÜÂìÅ„ÇíÂæ©Ê¥ª„Åï„Åõ„Çã
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="playTapSound(); closeBulkInventoryModal()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>
  
  <!-- üÜï POS„É¢„Éº„ÉÄ„É´ -->
  <div id="posIframeModal" class="pos-iframe-modal">
    <div class="pos-iframe-container">
      <div class="pos-iframe-header">
        <h3 id="posModalTitle">POSÊ©üËÉΩ</h3>
        <button class="pos-iframe-close" onclick="playTapSound(); closePOSModal()">√ó</button>
      </div>
      <iframe id="posIframe" class="pos-iframe-content" src="about:blank"></iframe>
    </div>
  </div>
  
  <!-- „É¨„Ç∑„Éº„ÉàË°®Á§∫„Ç∑„Çπ„ÉÜ„É† (v3 - ÂÆåÂÖ®‰øÆÊ≠£Áâà) -->
  <script src="receipt-display-functions-v4.js"></script>
  
  <!-- „É¢„Éê„Ç§„É´„Éó„É™„É≥„Çø„ÉºÁµ±ÂêàÔºàÁîªÂÉè‰øùÂ≠òÔºÜÂç∞Âà∑Ôºâ -->
  <script>
  // „É¢„Éê„Ç§„É´„Éó„É™„É≥„Çø„ÉºÁµ±ÂêàÊ©üËÉΩÔºàpos.html„Å®Âêå„Åò„Ç≥„Éº„ÉâÔºâ
  async function openReceiptDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('ReceiptStorage', 1);
      request.onerror = () => reject(request.error);
      request.onsuccess = () => resolve(request.result);
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains('receipts')) {
          db.createObjectStore('receipts', { keyPath: 'id' });
        }
      };
    });
  }

  window.autoSaveReceiptImage = async function(type, data) {
    try {
      console.log(' „É¨„Ç∑„Éº„ÉàÁîªÂÉèËá™Âãï‰øùÂ≠ò:', type);
      const modalId = type === 'receipt' ? 'receiptDisplayModal' : 'invoiceDisplayModal';
      const modal = document.getElementById(modalId);
      if (!modal) return;
      const receiptContent = modal.querySelector('[style*="background: white"]') || modal.querySelector('div');
      if (!receiptContent) return;
      const canvas = await html2canvas(receiptContent, { backgroundColor: '#ffffff', scale: 2, logging: false });
      const imageData = canvas.toDataURL('image/png');
      const db = await openReceiptDB();
      const tx = db.transaction('receipts', 'readwrite');
      const store = tx.objectStore('receipts');
      await store.add({ id: Date.now(), type: type, orderNumber: data.orderNum || data.orderNumber, imageData: imageData, timestamp: Date.now() });
      console.log('‚úÖ ‰øùÂ≠òÂÆå‰∫Ü');
      const notification = document.createElement('div');
      notification.style.cssText = 'position: fixed; bottom: 20px; right: 20px; background: #4CAF50; color: white; padding: 15px 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100001; font-weight: bold;';
      notification.textContent = ' „É¨„Ç∑„Éº„ÉàÁîªÂÉè„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü';
      document.body.appendChild(notification);
      setTimeout(() => notification.remove(), 3000);
    } catch (error) {
      console.error('‰øùÂ≠ò„Ç®„É©„Éº:', error);
    }
  };

  window.showSavedReceipts = async function() {
    try {
      const db = await openReceiptDB();
      const tx = db.transaction('receipts', 'readonly');
      const store = tx.objectStore('receipts');
      const allReceipts = await new Promise((resolve, reject) => {
        const request = store.getAll();
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
      if (allReceipts.length === 0) { alert('‰øùÂ≠ò„Åï„Çå„Å¶„ÅÑ„Çã„É¨„Ç∑„Éº„Éà„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì'); return; }
      const modal = document.createElement('div');
      modal.id = 'savedReceiptsModal';
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100000;';
      const content = document.createElement('div');
      content.style.cssText = 'background: white; border-radius: 20px; padding: 40px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto;';
      let html = '<h2 style="text-align: center; margin-bottom: 30px;">‰øùÂ≠òÊ∏à„Åø„É¨„Ç∑„Éº„Éà</h2><div style="display: grid; gap: 15px;">';
      allReceipts.reverse().forEach(receipt => {
        const date = new Date(receipt.timestamp);
        const dateStr = `${date.getMonth()+1}/${date.getDate()} ${String(date.getHours()).padStart(2,'0')}:${String(date.getMinutes()).padStart(2,'0')}`;
        html += `<div style="border: 2px solid #ddd; border-radius: 10px; padding: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
          <div style="flex: 1;"><div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${receipt.type === 'receipt' ? '„É¨„Ç∑„Éº„Éà' : 'È†òÂèéÊõ∏'} #${receipt.orderNumber || '„Å™„Åó'}</div><div style="color: #666; font-size: 14px;">${dateStr}</div></div>
          <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button onclick="previewReceipt(${receipt.id})" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">„Éó„É¨„Éì„É•„Éº</button>
            <button onclick="downloadSavedReceipt(${receipt.id})" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">Âç∞Âà∑Áî®DL</button>
            <button onclick="deleteSavedReceipt(${receipt.id})" style="padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">ÂâäÈô§</button>
          </div></div>`;
      });
      html += '</div><button onclick="document.getElementById(\'savedReceiptsModal\').remove()" style="width: 100%; margin-top: 20px; padding: 15px; background: #9E9E9E; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">Èñâ„Åò„Çã</button>';
      content.innerHTML = html;
      modal.appendChild(content);
      document.body.appendChild(modal);
    } catch (error) {
      console.error('„Ç®„É©„Éº:', error);
      alert('„É¨„Ç∑„Éº„Éà‰∏ÄË¶ß„ÅÆË°®Á§∫„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
  };

  window.previewReceipt = async function(id) {
    try {
      const db = await openReceiptDB();
      const tx = db.transaction('receipts', 'readonly');
      const store = tx.objectStore('receipts');
      const receipt = await new Promise((resolve, reject) => {
        const request = store.get(id);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
      if (!receipt) { alert('„É¨„Ç∑„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'); return; }
      const modal = document.createElement('div');
      modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 100001;';
      modal.innerHTML = `<div style="max-width: 90%; max-height: 90%; overflow: auto; background: white; padding: 20px; border-radius: 10px;">
        <img src="${receipt.imageData}" style="max-width: 100%; height: auto;">
        <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; margin-top: 20px; padding: 15px; background: #9E9E9E; color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold;">Èñâ„Åò„Çã</button></div>`;
      document.body.appendChild(modal);
    } catch (error) {
      console.error('„Ç®„É©„Éº:', error);
      alert('„Éó„É¨„Éì„É•„Éº„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
  };

  window.downloadSavedReceipt = async function(id) {
    try {
      const db = await openReceiptDB();
      const tx = db.transaction('receipts', 'readonly');
      const store = tx.objectStore('receipts');
      const receipt = await new Promise((resolve, reject) => {
        const request = store.get(id);
        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
      });
      if (!receipt) { alert('„É¨„Ç∑„Éº„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'); return; }
      const link = document.createElement('a');
      link.download = `${receipt.type}_${receipt.orderNumber || 'none'}_${receipt.timestamp}.png`;
      link.href = receipt.imageData;
      link.click();
      showPrintInstructions();
    } catch (error) {
      console.error('„Ç®„É©„Éº:', error);
      alert('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
  };

  window.deleteSavedReceipt = async function(id) {
    try {
      if (!confirm('„Åì„ÅÆ„É¨„Ç∑„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) return;
      const db = await openReceiptDB();
      const tx = db.transaction('receipts', 'readwrite');
      const store = tx.objectStore('receipts');
      await new Promise((resolve, reject) => {
        const request = store.delete(id);
        request.onsuccess = () => resolve();
        request.onerror = () => reject(request.error);
      });
      alert('ÂâäÈô§„Åó„Åæ„Åó„Åü');
      document.getElementById('savedReceiptsModal')?.remove();
      showSavedReceipts();
    } catch (error) {
      console.error('„Ç®„É©„Éº:', error);
      alert('ÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
  };

  function showPrintInstructions() {
    const modal = document.createElement('div');
    modal.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 100002;';
    modal.innerHTML = `<h3 style="text-align: center; margin-bottom: 20px;">Âç∞Âà∑ÊñπÊ≥ï</h3>
      <div style="background: #e7f3ff; padding: 15px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #2196F3;">
        <p style="margin: 0 0 10px 0; font-weight: bold;">„Çπ„Éû„Éõ„ÅÆÂ†¥Âêà:</p>
        <ol style="margin: 0; padding-left: 20px; font-size: 14px;"><li>„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Åó„ÅüÁîªÂÉè„ÇíÈñã„Åè</li><li>ÂÖ±Êúâ„Éú„Çø„É≥„Çí„Çø„ÉÉ„Éó</li><li>„ÄåÂç∞Âà∑„Äç„ÇíÈÅ∏Êäû</li><li>Bluetooth„Éó„É™„É≥„Çø„Éº„ÇíÈÅ∏Êäû</li></ol>
      </div>
      <div style="background: #fff3cd; padding: 12px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
        <p style="margin: 0; font-size: 13px;"><strong>„Åä„Åô„Åô„ÇÅ„Éó„É™„É≥„Çø„Éº:</strong> Phomemo M02ProÔºàÁ¥Ñ¬•4,500Ôºâ</p>
      </div>
      <button onclick="this.parentElement.remove()" style="width: 100%; padding: 15px; background: #4CAF50; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">OK</button>`;
    document.body.appendChild(modal);
    setTimeout(() => modal.remove(), 8000);
  }
  
  console.log('‚úÖ „É¢„Éê„Ç§„É´„Éó„É™„É≥„Çø„ÉºÁµ±ÂêàÊ©üËÉΩ Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü');
  </script>

  <!-- ========== „ÉÜ„Éº„Éñ„É´„É°„É¢Ê©üËÉΩ ========== -->
  <div id="tableMemoModal">
    <div class="table-memo-modal-inner">
      <h3 id="tableMemoModalTitle">üìù „ÉÜ„Éº„Éñ„É´„É°„É¢</h3>
      <textarea id="tableMemoTextarea" placeholder="‰æãÔºö14:30Êù•Â∫ó&#10;Â±±Áî∞Êßò 3Âêç&#10;„Ç¢„É¨„É´„ÇÆ„ÉºÔºö„Åà„Å≥"></textarea>
      <div class="table-memo-modal-btns">
        <button class="btn-memo-save" onclick="saveTableMemo()">‰øùÂ≠ò</button>
        <button class="btn-memo-clear" onclick="clearTableMemo()">„ÇØ„É™„Ç¢</button>
        <button class="btn-memo-cancel" onclick="closeTableMemoModal()">Èñâ„Åò„Çã</button>
      </div>
    </div>
  </div>

  <script>
  // ===== „ÉÜ„Éº„Éñ„É´„É°„É¢Ê©üËÉΩ (handy) =====
  if (!window._tableMemos) window._tableMemos = {};
  let _memoCurrentTable = null;
  
  function openTableMemoModal(tableName, e) {
    if (e) e.stopPropagation();
    _memoCurrentTable = tableName;
    document.getElementById('tableMemoModalTitle').textContent = 'üìù ' + tableName + ' „É°„É¢';
    const saved = window._tableMemos[tableName] || '';
    document.getElementById('tableMemoTextarea').value = saved;
    document.getElementById('tableMemoModal').classList.add('active');
    setTimeout(() => document.getElementById('tableMemoTextarea').focus(), 100);
  }
  
  function closeTableMemoModal() {
    document.getElementById('tableMemoModal').classList.remove('active');
    _memoCurrentTable = null;
  }
  
  async function saveTableMemo() {
    if (!_memoCurrentTable) return;
    const text = document.getElementById('tableMemoTextarea').value.trim();
    window._tableMemos[_memoCurrentTable] = text;
    // tables„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„ÅÆstaffMemo„Éï„Ç£„Éº„É´„Éâ„Å´‰øùÂ≠òÔºàpos„Å®ÂÖ±ÈÄöÔºâ
    try {
      const tableId = window._tableMemoIds && window._tableMemoIds[_memoCurrentTable];
      if (tableId) {
        await window.setDoc(window.getStoreDoc('tables', tableId), {
          staffMemo: text,
          updatedAt: window.Timestamp.now()
        }, { merge: true });
      }
    } catch(err) { console.warn('„É°„É¢‰øùÂ≠ò„Ç®„É©„ÉºÔºà„É≠„Éº„Ç´„É´„ÅÆ„ÅøÔºâ:', err); }
    _applyMemoToCard(_memoCurrentTable, text);
    closeTableMemoModal();
  }
  
  async function clearTableMemo() {
    if (!_memoCurrentTable) return;
    document.getElementById('tableMemoTextarea').value = '';
    window._tableMemos[_memoCurrentTable] = '';
    try {
      const tableId = window._tableMemoIds && window._tableMemoIds[_memoCurrentTable];
      if (tableId) {
        await window.setDoc(window.getStoreDoc('tables', tableId), {
          staffMemo: '',
          updatedAt: window.Timestamp.now()
        }, { merge: true });
      }
    } catch(err) { console.warn('„É°„É¢ÂâäÈô§„Ç®„É©„Éº:', err); }
    _applyMemoToCard(_memoCurrentTable, '');
    closeTableMemoModal();
  }
  
  function _applyMemoToCard(tableName, text) {
    document.querySelectorAll('.table-card').forEach(card => {
      if (card.getAttribute('data-table-name') !== tableName) return;
      let memoEl = card.querySelector('.table-memo-display');
      if (text) {
        card.classList.add('has-memo');
        if (!memoEl) {
          memoEl = document.createElement('div');
          memoEl.className = 'table-memo-display';
          card.appendChild(memoEl);
        }
        memoEl.textContent = text;
      } else {
        card.classList.remove('has-memo');
        if (memoEl) memoEl.remove();
      }
    });
  }
  
  async function loadAllTableMemos() {
    try {
      if (!window._tableMemoIds) window._tableMemoIds = {};
      // tables„Ç≥„É¨„ÇØ„Ç∑„Éß„É≥„Åã„ÇâstaffMemo„ÇíË™≠„ÅøËæº„ÅøÔºàpos„Å®ÂÖ±ÈÄö„Éá„Éº„ÇøÔºâ
      const snap = await window.getDocs(window.getStoreCollection('tables'));
      snap.forEach(doc => {
        const data = doc.data();
        if (data.name) {
          window._tableMemoIds[data.name] = doc.id;
          window._tableMemos[data.name] = data.staffMemo || '';
        }
      });
      Object.entries(window._tableMemos).forEach(([tableName, text]) => {
        if (text) _applyMemoToCard(tableName, text);
      });
    } catch(err) { console.warn('„É°„É¢Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', err); }
  }
  
  document.getElementById('tableMemoModal').addEventListener('click', function(e) {
    if (e.target === this) closeTableMemoModal();
  });
  
  window.addEventListener('load', () => {
    setTimeout(loadAllTableMemos, 2500);
  });
  </script>
  
</body>
</html>