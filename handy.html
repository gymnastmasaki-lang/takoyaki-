<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </title>
  <!-- ã‚¿ãƒƒãƒ—éŸ³ -->
  <script>
    // AudioContextã‚’ä½¿ç”¨ã—ãŸã‚¿ãƒƒãƒ—éŸ³ç”Ÿæˆ
    let audioContext = null;
    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }
    function playTapSound() {
      initAudio();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    .login-screen {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .login-screen h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 28px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .login-btn:active {
      transform: scale(0.98);
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ */
    .tables-screen {
      display: none;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .header h2 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .header .store-info {
      color: #666;
      font-size: 14px;
    }
    
    .header-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .logout-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .sales-btn {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .settings-btn {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .table-card {
      background: white;
      border-radius: 15px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    
    .table-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .table-card:active {
      transform: translateY(-2px);
    }
    
    .table-card.has-pending-orders {
      background: linear-gradient(135deg, #fff4e6 0%, #ffe0b2 100%);
      border: 2px solid #ff9800;
    }
    
    .table-card.has-pending-orders .table-name {
      color: #f57c00;
    }
    
    .table-card.has-pending-orders .pending-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff9800;
      color: white;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
    }
    
    .status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
    }
    
    .unpaid-badge {
      background: #f57c00;
      color: white;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }
    
    .table-card .table-name {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .table-card .table-status {
      font-size: 12px;
      color: #999;
    }
    
    .checkout-btn {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .checkout-btn:active {
      transform: scale(0.95);
    }
    
    /* ğŸ†• POSãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .pos-iframe-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }
    
    .pos-iframe-modal.active {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .pos-iframe-container {
      width: 95%;
      height: 95%;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
    }
    
    .pos-iframe-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .pos-iframe-header h3 {
      margin: 0;
      font-size: 18px;
    }
    
    .pos-iframe-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .pos-iframe-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .pos-iframe-content {
      flex: 1;
      width: 100%;
      border: none;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç¶™ç¶š */
    .hidden {
      display: none !important;
    }
    
    /* æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .functions-menu {
      position: relative;
      display: inline-block;
    }
    
    .functions-submenu {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background: white;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      margin-top: 5px;
      min-width: 200px;
      z-index: 1000;
    }
    
    .functions-submenu button {
      width: 100%;
      padding: 12px 15px;
      background: white;
      border: none;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      color: #333;
      transition: background 0.2s;
    }
    
    .functions-submenu button:first-child {
      border-radius: 8px 8px 0 0;
    }
    
    .functions-submenu button:last-child {
      border-radius: 0 0 8px 8px;
    }
    
    .functions-submenu button:hover {
      background: #f5f5f5;
    }
    
    .functions-submenu button:active {
      background: #e0e0e0;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div id="loginScreen" class="login-screen">
      <h1>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </h1>
      <div class="form-group">
        <label for="storeSelect">åº—èˆ—é¸æŠ</label>
        <select id="storeSelect">
          <option value="">åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
      <div class="form-group">
        <label for="passwordInput">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      </div>
      <button class="login-btn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ -->
    <div id="tablesScreen" class="tables-screen">
      <div class="header">
        <h2>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </h2>
        <div class="store-info" id="storeInfo">åº—èˆ—: -</div>
        <div class="header-buttons">
          <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
          <div class="functions-menu">
            <button class="sales-btn" onclick="toggleFunctionsMenu()">æ©Ÿèƒ½ â–¼</button>
            <div id="functionsSubMenu" class="functions-submenu">
              <button onclick="openPOSModal('drawer')">ğŸ’° ãƒ‰ãƒ­ã‚¢é–‹</button>
              <button onclick="openPOSModal('sales')">ğŸ“Š å£²ä¸Š</button>
              <button onclick="openPOSModal('expense')">ğŸ’¸ æ”¯å‡º</button>
              <button onclick="openPOSModal('kintai')">â° å‹¤æ€ </button>
              <button onclick="openPOSModal('monthly')">ğŸ“… æœˆæ¬¡</button>
              <button onclick="openPOSModal('history')">ğŸ“œ å±¥æ­´</button>
              <button onclick="openPOSModal('printer')">ğŸ–¨ï¸ ãƒ—ãƒªãƒ³ã‚¿è¨­å®š</button>
            </div>
          </div>
          <button class="settings-btn" onclick="openPOSModal('settings')">è¨­å®š</button>
        </div>
      </div>
      
      <div class="tables-grid" id="tablesGrid">
        <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
      </div>
    </div>
  </div>

  <!-- ğŸ†• POSãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="posIframeModal" class="pos-iframe-modal">
    <div class="pos-iframe-container">
      <div class="pos-iframe-header">
        <h3 id="posModalTitle">POSæ©Ÿèƒ½</h3>
        <button class="pos-iframe-close" onclick="closePOSModal()">Ã—</button>
      </div>
      <iframe id="posIframe" class="pos-iframe-content" src="about:blank"></iframe>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc, doc, Timestamp, onSnapshot, addDoc, orderBy, getDoc, setDoc, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.db = db;
    window.storage = storage;
    window.auth = auth;
    window.signOut = signOut;
    window.storageRef = ref;
    window.uploadBytes = uploadBytes;
    window.getDownloadURL = getDownloadURL;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.updateDoc = updateDoc;
    window.doc = doc;
    window.Timestamp = Timestamp;
    window.onSnapshot = onSnapshot;
    window.addDoc = addDoc;
    window.orderBy = orderBy;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.limit = limit;
    window.deleteDoc = deleteDoc;
    
    // åº—èˆ—åˆ¥ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    window.getStoreCollection = function(collectionName) {
      if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
        const oldPathMap = {
          'menus': 'menu',
          'employees': 'kintai_employees',
          'attendance': 'kintai_attendance'
        };
        const path = oldPathMap[collectionName] || collectionName;
        return window.collection(window.db, path);
      }
      return window.collection(window.db, 'stores', window.currentStoreId, collectionName);
    };
    
    window.getStoreDoc = function(collectionName, docId) {
      if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
        const oldPathMap = {
          'menus': 'menu',
          'employees': 'kintai_employees',
          'attendance': 'kintai_attendance'
        };
        return window.doc(window.db, oldPathMap[collectionName] || collectionName, docId);
      }
      return window.doc(window.db, 'stores', window.currentStoreId, collectionName, docId);
    };
    
    // ğŸ†• ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’localStorageã«ä¿å­˜
    window.saveLoginInfo = function(storeId, password) {
      localStorage.setItem('handy_storeId', storeId);
      localStorage.setItem('handy_password', password);
    };
    
    // ğŸ†• ä¿å­˜ã•ã‚ŒãŸãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å–å¾—
    window.getSavedLoginInfo = function() {
      return {
        storeId: localStorage.getItem('handy_storeId'),
        password: localStorage.getItem('handy_password')
      };
    };
    
    // åˆæœŸåŒ–å‡¦ç†
    window.addEventListener('DOMContentLoaded', async () => {
      // FirebaseåˆæœŸåŒ–å¾…æ©Ÿ
      while (!window.firebaseReady || !window.db) {
        await new Promise(r => setTimeout(r, 100));
      }
      
      await loadStoreList();
      
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰åº—èˆ—æƒ…å ±ã‚’å¾©å…ƒ
      const savedStoreId = sessionStorage.getItem('handyStoreId');
      const savedStoreName = sessionStorage.getItem('handyStoreName');
      
      if (savedStoreId && savedStoreName) {
        currentStoreId = savedStoreId;
        window.currentStoreId = savedStoreId;
        currentStoreName = savedStoreName;
        
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('ğŸ“ HANDY ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰åº—èˆ—IDå¾©å…ƒ');
        console.log('   currentStoreId:', currentStoreId);
        console.log('   window.currentStoreId:', window.currentStoreId);
        console.log('   currentStoreName:', currentStoreName);
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        
        showTablesScreen();
      }
    });
  </script>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentStoreId = null;
    let currentStoreName = null;
    let currentUser = null;
    let currentPassword = null;
    let unsubscribeOrders = null;
    let unsubscribeInventory = null;
    let storesData = {};

    // åº—èˆ—ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadStoreList() {
      try {
        const storesQuery = window.query(
          window.collection(window.db, 'stores'),
          window.where('isActive', '==', true)
        );
        const storesSnapshot = await window.getDocs(storesQuery);
        const storeSelect = document.getElementById('storeSelect');
        
        storeSelect.innerHTML = '<option value="">åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        storesData = {};
        
        storesSnapshot.forEach(doc => {
          const storeData = doc.data();
          const storeId = doc.id;
          const storeName = storeData.storeName || doc.id;
          const password = storeData.storePassword || '';
          
          storesData[storeId] = {
            storeName: storeName,
            password: String(password),
            isActive: true
          };
          
          const option = document.createElement('option');
          option.value = storeId;
          option.textContent = storeName;
          storeSelect.appendChild(option);
        });
      } catch (error) {
        console.error('âŒ åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        alert('åº—èˆ—ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    async function login() {
      const storeSelect = document.getElementById('storeSelect');
      const passwordInput = document.getElementById('passwordInput');
      const storeId = storeSelect.value;
      const inputPassword = passwordInput.value.trim();
      
      if (!storeId) {
        alert('åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      if (!inputPassword) {
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      const storeInfo = storesData[storeId];
      if (inputPassword !== storeInfo.password) {
        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      currentStoreId = storeId;
      window.currentStoreId = storeId;
      currentStoreName = storeInfo.storeName;
      sessionStorage.setItem('handyStoreId', storeId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log('ğŸ“ HANDY åº—èˆ—IDè¨­å®šå®Œäº†');
      console.log('   currentStoreId:', currentStoreId);
      console.log('   window.currentStoreId:', window.currentStoreId);
      console.log('   currentStoreName:', currentStoreName);
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      
      // ğŸ†• ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’ä¿å­˜
      window.saveLoginInfo(storeId, inputPassword);
      
      document.getElementById('storeInfo').textContent = `åº—èˆ—: ${currentStoreName}`;
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('tablesScreen').style.display = 'block';
      
      loadTables();
      startOrdersListener();
      updateInventoryPanel();
      unsubscribeInventory = watchInventoryChanges();
    }

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    function logout() {
      if (unsubscribeOrders) unsubscribeOrders();
      if (unsubscribeInventory) unsubscribeInventory();
      
      window.currentStoreId = null;
      currentUser = null;
      currentPassword = null;
      currentStoreId = null;
      currentStoreName = null;
      
      sessionStorage.removeItem('handyStoreId');
      sessionStorage.removeItem('handyStoreName');
      
      document.getElementById('tablesScreen').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('passwordInput').value = '';
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«ç”»é¢ã‚’è¡¨ç¤º
    async function showTablesScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('tablesScreen').style.display = 'block';
      document.getElementById('storeInfo').textContent = `åº—èˆ—: ${currentStoreName}`;
      
      await loadTables();
      startOrdersListener();
      updateInventoryPanel();
      unsubscribeInventory = watchInventoryChanges();
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadTables() {
      const grid = document.getElementById('tablesGrid');
      grid.innerHTML = '';
      
      try {
        const tablesRef = window.getStoreCollection('tables');
        const snapshot = await window.getDocs(tablesRef);
        
        snapshot.forEach(doc => {
          const table = doc.data();
          const card = createTableCard(doc.id, table);
          grid.appendChild(card);
        });
        
      } catch (e) {
        console.error('ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
    function createTableCard(tableId, tableData) {
      const card = document.createElement('div');
      card.className = 'table-card';
      card.onclick = () => openTableOrder(tableId);
      
      const hasPendingOrders = tableData.hasPendingOrders || false;
      const isUnpaid = tableData.status === 'unpaid';
      
      if (hasPendingOrders) {
        card.classList.add('has-pending-orders');
      }
      
      let badge = '';
      if (hasPendingOrders) {
        badge = '<div class="pending-badge">æœªé€ä¿¡</div>';
      } else if (isUnpaid) {
        badge = '<div class="status-badge unpaid-badge">æœªä¼šè¨ˆ</div>';
      }
      
      card.innerHTML = `
        ${badge}
        <div class="table-name">${tableData.name || tableId}</div>
        <div class="table-status">${tableData.status === 'available' ? 'ç©ºå¸­' : 'ä½¿ç”¨ä¸­'}</div>
      `;
      
      return card;
    }

    // æ³¨æ–‡ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
    function startOrdersListener() {
      const tablesRef = window.getStoreCollection('tables');
      unsubscribeOrders = window.onSnapshot(tablesRef, (snapshot) => {
        snapshot.docChanges().forEach((change) => {
          if (change.type === 'modified') {
            loadTables();
          }
        });
      });
    }

    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ³¨æ–‡ç”»é¢ã‚’é–‹ã
    function openTableOrder(tableId) {
      window.location.href = `https://gymnastmasaki-lang.github.io/takoyaki-/order.html?table=${tableId}`;
    }

    // ğŸ†• POSãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openPOSModal = function(modalType) {
      const modal = document.getElementById('posIframeModal');
      const iframe = document.getElementById('posIframe');
      const title = document.getElementById('posModalTitle');
      
      // ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
      const titles = {
        'drawer': 'ğŸ’° ãƒ‰ãƒ­ã‚¢é–‹',
        'sales': 'ğŸ“Š å£²ä¸Š',
        'expense': 'ğŸ’¸ æ”¯å‡º',
        'kintai': 'â° å‹¤æ€ ',
        'monthly': 'ğŸ“… æœˆæ¬¡',
        'history': 'ğŸ“œ å±¥æ­´',
        'printer': 'ğŸ–¨ï¸ ãƒ—ãƒªãƒ³ã‚¿è¨­å®š',
        'settings': 'âš™ï¸ è¨­å®š'
      };
      title.textContent = titles[modalType] || 'POSæ©Ÿèƒ½';
      
      // ä¿å­˜ã•ã‚ŒãŸãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å–å¾—
      const loginInfo = window.getSavedLoginInfo();
      
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ§‹ç¯‰ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å«ã‚ã‚‹ï¼‰
      let url = 'https://gymnastmasaki-lang.github.io/takoyaki-/pos.html';
      const params = new URLSearchParams();
      
      if (modalType && modalType !== 'settings') {
        params.append('modal', modalType);
      }
      
      // ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¿½åŠ 
      if (loginInfo.storeId && loginInfo.password) {
        params.append('storeId', loginInfo.storeId);
        params.append('password', loginInfo.password);
        params.append('autoLogin', 'true');
      }
      
      if (params.toString()) {
        url += '?' + params.toString();
      }
      
      iframe.src = url;
      modal.classList.add('active');
      
      // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
    };

    // ğŸ†• POSãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closePOSModal = function() {
      const modal = document.getElementById('posIframeModal');
      const iframe = document.getElementById('posIframe');
      
      modal.classList.remove('active');
      // iframeã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ¡ãƒ¢ãƒªè§£æ”¾ï¼‰
      setTimeout(() => {
        iframe.src = 'about:blank';
      }, 300);
    };

    // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãƒˆã‚°ãƒ«
    function toggleFunctionsMenu() {
      const menu = document.getElementById('functionsSubMenu');
      if (menu.style.display === 'none' || menu.style.display === '') {
        menu.style.display = 'block';
      } else {
        menu.style.display = 'none';
      }
    }

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
    document.addEventListener('click', function(e) {
      const menu = document.getElementById('functionsSubMenu');
      const btn = e.target.closest('.sales-btn');
      if (menu && menu.style.display === 'block' && !menu.contains(e.target) && !btn) {
        menu.style.display = 'none';
      }
    });

    // åœ¨åº«ãƒ‘ãƒãƒ«æ›´æ–°ï¼ˆç°¡ç•¥ç‰ˆï¼‰
    function updateInventoryPanel() {
      // æ—¢å­˜ã®åœ¨åº«ãƒ‘ãƒãƒ«ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚ã‚‹å ´åˆã¯ã“ã“ã«è¿½åŠ 
    }

    function watchInventoryChanges() {
      // æ—¢å­˜ã®åœ¨åº«ç›£è¦–ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚ã‚‹å ´åˆã¯ã“ã“ã«è¿½åŠ 
      return () => {}; // unsubscribeé–¢æ•°
    }
  </script>

  <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åœ¨åº«ãƒ‘ãƒãƒ«ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰ -->
  <div id="inventoryPanel" style="position: fixed; bottom: 20px; right: 20px; width: 300px; max-height: 400px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 9999; overflow: hidden; transition: all 0.3s ease; display: none;">
    <div id="inventoryPanelBar" onclick="toggleInventoryPanel()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;">
      <div style="font-weight: bold; color: white; font-size: 15px;">ğŸ“¦ åœ¨åº«çŠ¶æ³</div>
      <div id="inventoryPanelArrow" style="color: white; font-size: 18px;">â–¼</div>
    </div>
    <div id="inventoryPanelContent" style="max-height: 350px; overflow-y: auto; padding: 10px;">
      <div style="padding: 10px; text-align: center; color: #999;">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>

</body>
</html>
