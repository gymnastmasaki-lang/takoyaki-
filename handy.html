<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ  - ä¿®æ­£ç‰ˆ</title>
  <style>
    /* CSSã¯å‰å›æä¾›ã—ãŸã‚‚ã®ã‚’ãƒ™ãƒ¼ã‚¹ã«ã€å¿…è¦ãªç®‡æ‰€ã®ã¿ç¶­æŒ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 600px; margin: 0 auto; }
    .login-screen, .header, .table-card, .modal { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .hidden { display: none !important; }
    .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
    .table-card { text-align: center; cursor: pointer; position: relative; }
    .table-card.has-pending-orders { background: #fff4e6; border: 2px solid #ff9800; }
    .checkout-btn { width: 100%; padding: 10px; margin-top: 8px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ */
    .modal-overlay, .custom-modal-overlay {
      display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 1000;
      align-items: center; justify-content: center;
    }
    .modal { width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
    .btn { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
    .btn-primary { background: #667eea; color: white; }
    .btn-secondary { background: #e0e0e0; }
    .btn-danger { background: #f44336; color: white; }
    .btn-success { background: #4CAF50; color: white; }
  </style>
</head>
<body>
  <div class="container">
    <div id="loginScreen" class="login-screen">
      <h1 style="text-align:center; color:#667eea; margin-bottom:20px;">ğŸ½ï¸ ãƒãƒ³ãƒ‡ã‚£</h1>
      <select id="storeSelect" style="width:100%; padding:12px; margin-bottom:15px;"></select>
      <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width:100%; padding:12px; margin-bottom:15px;">
      <button class="btn-primary" style="width:100%; padding:15px;" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <div id="tablesScreen" class="hidden">
      <div class="header" style="margin-bottom:20px;">
        <h2 id="storeNameDisplay">åº—èˆ—å</h2>
        <button class="btn-danger" onclick="handleLogout()" style="margin-top:10px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <div id="tablesGrid" class="tables-grid"></div>
    </div>
  </div>

  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3 style="text-align:center; margin-bottom:15px;">ğŸ’° ä¼šè¨ˆãƒ»æ³¨æ–‡ç®¡ç†</h3>
      <p id="targetTableLabel" style="font-weight:bold; text-align:center; margin-bottom:15px;"></p>
      
      <div style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:15px;">
        <div id="orderItemsSummary" style="font-size:14px; margin-bottom:10px;"></div>
        <div style="border-top:1px solid #ddd; padding-top:10px; font-weight:bold; text-align:right;">
          åˆè¨ˆ: <span id="finalTotalLabel" style="font-size:18px; color:#4CAF50;">Â¥0</span>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <button class="btn btn-success" onclick="completePayment('cash')">âœ… ç¾é‡‘ä¼šè¨ˆ</button>
        <button class="btn btn-primary" onclick="completePayment('credit')">ğŸ’³ ï½¶ï½°ï¾„ï¾/é›»å­</button>
        <button class="btn btn-secondary" onclick="cancelOrders()">â¸ï¸ ï½·ï½¬ï¾ï½¾ï¾™</button>
        <button class="btn btn-danger" onclick="deleteOrders()">ğŸ—‘ï¸ å‰Šé™¤</button>
      </div>
      <button class="btn btn-secondary" style="width:100%; margin-top:15px;" onclick="closePaymentModal()">æˆ»ã‚‹</button>
    </div>
  </div>

  <div id="customConfirmModal" class="custom-modal-overlay hidden">
    <div class="modal" style="text-align:center;">
      <div id="modalIcon" style="font-size:40px;">âš ï¸</div>
      <h3 id="modalTitle">ç¢ºèª</h3>
      <p id="modalMessage" style="margin:15px 0; color:#666;"></p>
      <div style="display:flex; gap:10px;">
        <button id="modalCancelBtn" class="btn btn-secondary" style="flex:1;" onclick="closeCustomModal()">ã„ã„ãˆ</button>
        <button id="modalConfirmBtn" class="btn btn-danger" style="flex:1;">ã¯ã„</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc, addDoc, serverTimestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨é–¢æ•°ã®å…¬é–‹
    let currentStoreId = null;
    let currentTable = null;
    let currentOrders = [];

    // --- ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ---
    window.showCustomConfirm = ({icon, title, message, btnText, btnClass}) => {
      return new Promise((resolve) => {
        const modal = document.getElementById('customConfirmModal');
        document.getElementById('modalIcon').textContent = icon || 'âš ï¸';
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalMessage').textContent = message;
        const confirmBtn = document.getElementById('modalConfirmBtn');
        confirmBtn.textContent = btnText || 'ã¯ã„';
        confirmBtn.className = `btn ${btnClass || 'btn-danger'}`;
        
        confirmBtn.onclick = () => { modal.classList.add('hidden'); resolve(true); };
        modal.classList.remove('hidden');
      });
    };

    window.closeCustomModal = () => document.getElementById('customConfirmModal').classList.add('hidden');

    // --- ä¼šè¨ˆå‡¦ç† (å£²ä¸Šåæ˜ å¯¾å¿œ) ---
    window.completePayment = async (method) => {
      const confirmed = await showCustomConfirm({
        icon: 'ğŸ’°', title: 'ä¼šè¨ˆç¢ºå®š', message: 'ä¼šè¨ˆã‚’å®Œäº†ã—ã¦å£²ä¸Šã«è¨ˆä¸Šã—ã¾ã™ã‹ï¼Ÿ', btnClass: 'btn-success', btnText: 'ä¼šè¨ˆã™ã‚‹'
      });
      if (!confirmed) return;

      try {
        const batchPromises = [];
        const now = serverTimestamp();
        let totalSales = 0;

        for (const order of currentOrders) {
          // 1. æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
          const orderRef = doc(db, 'stores', currentStoreId, 'orders', order.id);
          batchPromises.push(updateDoc(orderRef, { paidAt: now, paymentMethod: method }));
          totalSales += (order.totalAmount || 0);
        }

        // 2. å£²ä¸Šãƒ‡ãƒ¼ã‚¿(sales)ã¸åæ˜ 
        const salesRef = collection(db, 'stores', currentStoreId, 'sales');
        batchPromises.push(addDoc(salesRef, {
          amount: totalSales,
          method: method,
          createdAt: now,
          type: 'order',
          tableName: currentTable
        }));

        await Promise.all(batchPromises);
        
        await showCustomConfirm({ icon: 'âœ…', title: 'å®Œäº†', message: 'ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸ', btnClass: 'btn-primary', btnText: 'OK' });
        location.reload(); // ãƒ†ãƒ¼ãƒ–ãƒ«ç”»é¢ã¸æˆ»ã‚‹
      } catch (e) { alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ'); }
    };

    // --- å‰Šé™¤å‡¦ç† (å³æ™‚åæ˜ ãƒ»è‡ªå‹•æˆ»ã‚Š) ---
    window.deleteOrders = async () => {
      const confirmed = await showCustomConfirm({
        icon: 'ğŸ—‘ï¸', title: 'å‰Šé™¤ç¢ºèª', message: 'ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ³¨æ–‡ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ', btnClass: 'btn-danger', btnText: 'å‰Šé™¤'
      });
      if (!confirmed) return;

      try {
        const promises = currentOrders.map(order => 
          updateDoc(doc(db, 'stores', currentStoreId, 'orders', order.id), { deleted: true })
        );
        await Promise.all(promises);
        
        await showCustomConfirm({ icon: 'ğŸ—‘ï¸', title: 'å‰Šé™¤å®Œäº†', message: 'æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', btnClass: 'btn-primary', btnText: 'OK' });
        location.reload(); 
      } catch (e) { alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    };

    // --- ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç† ---
    window.cancelOrders = async () => {
      const confirmed = await showCustomConfirm({
        icon: 'â¸ï¸', title: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèª', message: 'æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ‰±ã„ã«ã—ã¾ã™ã‹ï¼Ÿ', btnClass: 'btn-secondary', btnText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Ÿè¡Œ'
      });
      if (!confirmed) return;

      try {
        const promises = currentOrders.map(order => 
          updateDoc(doc(db, 'stores', currentStoreId, 'orders', order.id), { cancelledAt: serverTimestamp() })
        );
        await Promise.all(promises);
        await showCustomConfirm({ icon: 'OK', title: 'å®Œäº†', message: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ', btnClass: 'btn-primary', btnText: 'OK' });
        location.reload();
      } catch (e) { alert('å¤±æ•—ã—ã¾ã—ãŸ'); }
    };

    // --- ãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ»è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ ---
    window.openCheckoutForTable = async (tableName) => {
      currentTable = tableName;
      const q = query(collection(db, 'stores', currentStoreId, 'orders'), 
                where('tableNumber', '==', String(tableName)),
                where('paidAt', '==', null),
                where('deleted', '==', false),
                where('cancelledAt', '==', null));
      
      const snap = await getDocs(q);
      currentOrders = snap.docs.map(d => ({id: d.id, ...d.data()}));
      
      if (currentOrders.length === 0) return alert('æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“');

      document.getElementById('targetTableLabel').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ«: ${tableName}`;
      const total = currentOrders.reduce((s, o) => s + (o.totalAmount || 0), 0);
      document.getElementById('finalTotalLabel').textContent = `Â¥${total.toLocaleString()}`;
      
      document.getElementById('paymentModal').classList.remove('hidden');
    };

    window.closePaymentModal = () => document.getElementById('paymentModal').classList.add('hidden');

    // --- ãƒ­ã‚°ã‚¤ãƒ³ãƒ»åˆæœŸåŒ– (ç•¥) ---
    window.handleLogin = async () => {
      const sid = document.getElementById('storeSelect').value;
      if (!sid) return;
      currentStoreId = sid;
      sessionStorage.setItem('handyStoreId', sid);
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('tablesScreen').classList.remove('hidden');
      loadTables();
    };

    async function loadTables() {
      const snap = await getDocs(collection(db, 'stores', currentStoreId, 'tables'));
      const grid = document.getElementById('tablesGrid');
      grid.innerHTML = '';
      snap.forEach(d => {
        const t = d.data();
        const card = document.createElement('div');
        card.className = 'table-card';
        card.innerHTML = `<h3>${t.name}</h3><button class="checkout-btn btn-success" onclick="openCheckoutForTable('${t.name}')">ä¼šè¨ˆ/ç®¡ç†</button>`;
        grid.appendChild(card);
      });
    }

    // åˆæœŸåŒ–å®Ÿè¡Œ
    (async () => {
      const snap = await getDocs(query(collection(db, 'stores'), where('isActive', '==', true)));
      const sel = document.getElementById('storeSelect');
      snap.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id; opt.textContent = d.data().storeName;
        sel.appendChild(opt);
      });
    })();
  </script>
</body>
</html>