<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ  - ä¼šè¨ˆæ©Ÿèƒ½ä»˜ã</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    .login-screen {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .login-screen h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 28px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .login-btn:active {
      transform: scale(0.98);
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ */
    .tables-screen {
      display: none;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .header h2 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    /* ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
    .mode-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .mode-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .mode-btn.active {
      background: #667eea;
      color: white;
    }
    
    .mode-btn:active {
      transform: scale(0.95);
    }
    
    .store-info {
      color: #666;
      font-size: 14px;
    }
    
    .logout-btn {
      margin-top: 15px;
      padding: 10px 20px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
    }
    
    .logout-btn:active {
      transform: scale(0.98);
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .table-card {
      background: white;
      border-radius: 15px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    
    .table-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .table-card:active {
      transform: translateY(-2px);
    }
    
    .table-card .table-name {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .table-card .table-status {
      font-size: 12px;
      color: #999;
    }
    
    /* ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .table-card.payment-mode {
      cursor: default;
      padding: 20px;
    }
    
    .table-card.has-orders {
      border: 3px solid #4CAF50;
    }
    
    .table-card.has-incomplete-orders {
      border: 3px solid #FF9800 !important;
      background: #fff3e0;
    }
    
    .table-card.all-paid {
      border: 3px solid #2196F3;
    }
    
    .table-card .order-info {
      margin-top: 10px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 12px;
    }
    
    .table-card .order-total {
      font-size: 20px;
      font-weight: bold;
      color: #4CAF50;
      margin: 10px 0;
    }
    
    .table-card .payment-btn {
      width: 100%;
      padding: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .table-card .payment-btn:active {
      transform: scale(0.95);
    }
    
    .table-card .no-orders {
      color: #999;
      font-size: 12px;
      margin-top: 10px;
    }
    
    .table-card .status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    
    .table-card .status-badge.paid {
      background: #2196F3;
      color: white;
    }
    
    .table-card .status-badge.incomplete {
      background: #FF9800;
      color: white;
    }
    
    .hidden {
      display: none !important;
    }
    
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }
    
    /* ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .custom-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.2s ease-out;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    .custom-modal-box {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-icon {
      font-size: 60px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      color: #333;
      margin-bottom: 15px;
    }
    
    .modal-message {
      font-size: 16px;
      text-align: center;
      color: #666;
      margin-bottom: 25px;
      white-space: pre-line;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modal-btn:active {
      transform: scale(0.95);
    }
    
    .modal-btn-cancel {
      background: #e0e0e0;
      color: #666;
    }
    
    .modal-btn-success {
      background: #4CAF50;
      color: white;
    }
    
    .modal-btn-danger {
      background: #f44336;
      color: white;
    }
    
    /* ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« */
    .payment-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 9999;
      animation: fadeIn 0.2s ease-out;
    }
    
    .payment-modal {
      position: fixed;
      top: 0;
      right: -100%;
      width: 100%;
      max-width: 500px;
      height: 100%;
      background: white;
      box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
      transition: right 0.3s ease-out;
      overflow-y: auto;
      z-index: 10000;
    }
    
    .payment-modal.show {
      right: 0;
    }
    
    .payment-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    
    .payment-header h2 {
      font-size: 20px;
      margin: 0;
    }
    
    .close-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-btn:active {
      transform: scale(0.9);
    }
    
    .payment-content {
      padding: 20px;
    }
    
    .order-item {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    
    .order-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #ddd;
    }
    
    .order-number {
      font-weight: bold;
      color: #667eea;
    }
    
    .order-time {
      color: #999;
      font-size: 12px;
    }
    
    .item-list {
      margin-bottom: 10px;
    }
    
    .item-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .item-row:last-child {
      border-bottom: none;
    }
    
    .item-name {
      flex: 1;
      font-size: 14px;
    }
    
    .item-price {
      font-weight: bold;
      color: #333;
    }
    
    .item-checkbox {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background: white;
      border-radius: 8px;
      margin-top: 5px;
      cursor: pointer;
    }
    
    .item-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .item-checkbox label {
      cursor: pointer;
      user-select: none;
      flex: 1;
    }
    
    .order-total-section {
      background: #fff3e0;
      padding: 15px;
      border-radius: 10px;
      margin-top: 10px;
    }
    
    .order-total-row {
      display: flex;
      justify-content: space-between;
      font-size: 18px;
      font-weight: bold;
      color: #FF9800;
    }
    
    .payment-summary {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 16px;
    }
    
    .summary-row.total {
      font-size: 28px;
      font-weight: bold;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 2px solid rgba(255, 255, 255, 0.3);
    }
    
    .payment-methods {
      margin-bottom: 20px;
    }
    
    .payment-methods h3 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #333;
    }
    
    .payment-method-btn {
      width: 100%;
      padding: 15px;
      margin-bottom: 10px;
      border: 2px solid #ddd;
      background: white;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .payment-method-btn:active {
      transform: scale(0.98);
    }
    
    .payment-method-btn.selected {
      border-color: #4CAF50;
      background: #e8f5e9;
      color: #4CAF50;
    }
    
    .payment-method-icon {
      font-size: 24px;
    }
    
    .cash-input-group {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background: #f5f5f5;
      border-radius: 10px;
    }
    
    .cash-input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    
    .cash-input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 18px;
      text-align: right;
    }
    
    .quick-amounts {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    
    .quick-amount-btn {
      padding: 10px;
      background: white;
      border: 2px solid #667eea;
      color: #667eea;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .quick-amount-btn:active {
      transform: scale(0.95);
    }
    
    .change-display {
      display: none;
      margin-top: 15px;
      padding: 15px;
      background: #fff3e0;
      border-radius: 10px;
      text-align: center;
    }
    
    .change-label {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .change-amount {
      font-size: 32px;
      font-weight: bold;
      color: #FF9800;
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .action-btn {
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .action-btn:active {
      transform: scale(0.95);
    }
    
    .btn-complete {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      grid-column: 1 / -1;
    }
    
    .btn-cancel {
      background: #FF9800;
      color: white;
    }
    
    .btn-delete {
      background: #f44336;
      color: white;
    }
    
    .btn-adjust {
      background: #2196F3;
      color: white;
    }
    
    .btn-discount {
      background: #9C27B0;
      color: white;
    }
    
    .btn-payment {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      grid-column: 1 / -1;
      font-size: 18px;
      padding: 18px;
    }
    
    /* é‡‘é¡èª¿æ•´ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .adjust-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 11000;
      justify-content: center;
      align-items: center;
    }
    
    .adjust-modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
    }
    
    .adjust-modal h3 {
      font-size: 20px;
      margin-bottom: 20px;
      text-align: center;
      color: #333;
    }
    
    .adjust-input-group {
      margin-bottom: 20px;
    }
    
    .adjust-input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    
    .adjust-input-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 18px;
      text-align: right;
    }
    
    .adjust-buttons {
      display: flex;
      gap: 10px;
    }
    
    .adjust-buttons button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .btn-adjust-cancel {
      background: #e0e0e0;
      color: #666;
    }
    
    .btn-adjust-confirm {
      background: #4CAF50;
      color: white;
    }
  </style>
</head>
<body>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc, doc, Timestamp, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.updateDoc = updateDoc;
    window.doc = doc;
    window.Timestamp = Timestamp;
    window.onSnapshot = onSnapshot;
    window.firebaseReady = true;
    
    console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†');
  </script>

  <div class="container">
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div class="login-screen" id="loginScreen">
      <h1>ğŸœ ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </h1>
      <div class="form-group">
        <label>åº—èˆ—ã‚’é¸æŠ</label>
        <select id="storeSelect">
          <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
        </select>
      </div>
      <button class="login-btn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ -->
    <div class="tables-screen" id="tablesScreen">
      <div class="header">
        <h2 id="headerTitle">ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </h2>
        <div class="mode-toggle">
          <button class="mode-btn active" id="orderModeBtn" onclick="switchMode('order')">æ³¨æ–‡ãƒ¢ãƒ¼ãƒ‰</button>
          <button class="mode-btn" id="paymentModeBtn" onclick="switchMode('payment')">ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰</button>
        </div>
        <div class="store-info" id="storeInfo">åº—èˆ—: æœªé¸æŠ</div>
        <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>

      <div class="tables-grid" id="tablesGrid">
        <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
      </div>
    </div>
  </div>

  <!-- ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="custom-modal-overlay" id="customModal">
    <div class="custom-modal-box">
      <div class="modal-icon" id="modalIcon">âœ…</div>
      <div class="modal-title" id="modalTitle">ç¢ºèª</div>
      <div class="modal-message" id="modalMessage">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeCustomModal(false)">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-success" id="modalConfirmBtn" onclick="closeCustomModal(true)">OK</button>
      </div>
    </div>
  </div>

  <!-- ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="payment-modal-overlay" id="paymentModalOverlay" onclick="closePaymentModal()"></div>
  <div class="payment-modal" id="paymentModal">
    <div class="payment-header">
      <h2 id="paymentTableName">ãƒ†ãƒ¼ãƒ–ãƒ« 1</h2>
      <button class="close-btn" onclick="closePaymentModal()">Ã—</button>
    </div>
    <div class="payment-content" id="paymentContent">
      <!-- æ³¨æ–‡è©³ç´°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
    </div>
  </div>

  <!-- é‡‘é¡èª¿æ•´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="adjust-modal" id="adjustModal">
    <div class="adjust-modal-content">
      <h3 id="adjustModalTitle">é‡‘é¡å¤‰æ›´</h3>
      <div class="adjust-input-group">
        <label id="adjustInputLabel">æ–°ã—ã„é‡‘é¡ã‚’å…¥åŠ›</label>
        <input type="number" id="adjustInput" placeholder="0">
      </div>
      <div class="adjust-buttons">
        <button class="btn-adjust-cancel" onclick="closeAdjustModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-adjust-confirm" onclick="confirmAdjustment()">ç¢ºå®š</button>
      </div>
    </div>
  </div>

  <!-- ã‚¿ãƒƒãƒ—éŸ³ç”¨ã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª -->
  <audio id="tapSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=" type="audio/wav">
  </audio>

  <script>
    // ========== ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ==========
    let storesData = {};
    let currentStoreId = null;
    let currentStoreName = null;
    let currentMode = 'order'; // 'order' or 'payment'
    let tablesData = [];
    let ordersData = {};
    let currentPaymentOrders = [];
    let selectedPaymentMethod = null;
    let itemCheckStatus = {};
    let modalResolve = null;
    let ordersListener = null;
    let adjustmentType = null; // 'price' or 'discount'
    let currentAdjustOrderId = null;
    
    // ========== ã‚¿ãƒƒãƒ—éŸ³å†ç”Ÿ ==========
    function playTapSound() {
      const audio = document.getElementById('tapSound');
      audio.currentTime = 0;
      audio.play().catch(e => console.log('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', e));
    }
    
    // ========== åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ ==========
    async function loadStoreList() {
      try {
        console.log('ğŸª åº—èˆ—ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...');
        
        const storesRef = window.collection(window.db, 'stores');
        const storesSnapshot = await window.getDocs(storesRef);
        
        storesData = {};
        storesSnapshot.forEach(doc => {
          storesData[doc.id] = doc.data();
        });
        
        console.log('âœ… åº—èˆ—ãƒªã‚¹ãƒˆ:', storesData);
        
        const storeSelect = document.getElementById('storeSelect');
        storeSelect.innerHTML = '<option value="">åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        
        Object.keys(storesData).forEach(storeId => {
          const store = storesData[storeId];
          const option = document.createElement('option');
          option.value = storeId;
          option.textContent = store.name || storeId;
          storeSelect.appendChild(option);
        });
        
      } catch (error) {
        console.error('âŒ åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // ========== ãƒ­ã‚°ã‚¤ãƒ³ ==========
    function login() {
      playTapSound();
      const storeSelect = document.getElementById('storeSelect');
      const selectedStoreId = storeSelect.value;
      
      if (!selectedStoreId) {
        alert('åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      currentStoreId = selectedStoreId;
      currentStoreName = storesData[selectedStoreId].name;
      
      sessionStorage.setItem('handyStoreId', currentStoreId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      
      console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³:', currentStoreName);
      
      showTablesScreen();
    }
    
    // ========== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ==========
    async function logout() {
      playTapSound();
      const confirmed = await showCustomModal({
        icon: 'ğŸšª',
        title: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
        message: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ',
        btnText: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
        btnClass: 'modal-btn-danger'
      });
      
      if (confirmed) {
        // ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
        if (ordersListener) {
          ordersListener();
          ordersListener = null;
        }
        
        sessionStorage.removeItem('handyStoreId');
        sessionStorage.removeItem('handyStoreName');
        location.reload();
      }
    }
    
    // ========== ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢è¡¨ç¤º ==========
    async function showTablesScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('tablesScreen').style.display = 'block';
      document.getElementById('headerTitle').textContent = currentStoreName + ' - ãƒãƒ³ãƒ‡ã‚£';
      document.getElementById('storeInfo').textContent = 'åº—èˆ—: ' + currentStoreName;
      
      await loadTables();
      startOrdersListener();
    }
    
    // ========== ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿ ==========
    async function loadTables() {
      try {
        console.log('ğŸª‘ ãƒ†ãƒ¼ãƒ–ãƒ«æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...');
        
        const tablesRef = window.collection(window.db, 'stores', currentStoreId, 'tables');
        const tablesSnapshot = await window.getDocs(tablesRef);
        
        tablesData = [];
        tablesSnapshot.forEach(doc => {
          tablesData.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        tablesData.sort((a, b) => (a.order || 0) - (b.order || 0));
        
        console.log('âœ… ãƒ†ãƒ¼ãƒ–ãƒ«:', tablesData);
        
        renderTables();
        
      } catch (error) {
        console.error('âŒ ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // ========== æ³¨æ–‡ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼ ==========
    function startOrdersListener() {
      if (ordersListener) {
        ordersListener();
      }
      
      console.log('ğŸ‘‚ æ³¨æ–‡ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹');
      
      const ordersRef = window.collection(window.db, 'stores', currentStoreId, 'orders');
      const q = window.query(ordersRef, window.where('deleted', '!=', true));
      
      ordersListener = window.onSnapshot(q, (snapshot) => {
        console.log('ğŸ”„ æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿æ›´æ–°:', snapshot.size, 'ä»¶');
        
        ordersData = {};
        snapshot.forEach(doc => {
          const order = {
            id: doc.id,
            ...doc.data()
          };
          
          const tableId = order.tableId;
          if (!ordersData[tableId]) {
            ordersData[tableId] = [];
          }
          ordersData[tableId].push(order);
        });
        
        console.log('ğŸ“¦ æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿:', ordersData);
        
        renderTables();
      }, (error) => {
        console.error('âŒ æ³¨æ–‡ãƒªã‚¹ãƒŠãƒ¼ã‚¨ãƒ©ãƒ¼:', error);
      });
    }
    
    // ========== ãƒ†ãƒ¼ãƒ–ãƒ«æç”» ==========
    function renderTables() {
      const grid = document.getElementById('tablesGrid');
      grid.innerHTML = '';
      
      tablesData.forEach(table => {
        const card = document.createElement('div');
        card.className = 'table-card';
        
        if (currentMode === 'payment') {
          card.classList.add('payment-mode');
          renderPaymentCard(card, table);
        } else {
          card.onclick = () => {
            playTapSound();
            window.location.href = `order.html?store=${currentStoreId}&table=${table.id}`;
          };
          
          const name = document.createElement('div');
          name.className = 'table-name';
          name.textContent = table.name || `ãƒ†ãƒ¼ãƒ–ãƒ« ${table.id}`;
          card.appendChild(name);
          
          const status = document.createElement('div');
          status.className = 'table-status';
          status.textContent = 'æ³¨æ–‡å¯èƒ½';
          card.appendChild(status);
        }
        
        grid.appendChild(card);
      });
    }
    
    // ========== ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ç”¨ã‚«ãƒ¼ãƒ‰æç”» ==========
    function renderPaymentCard(card, table) {
      const orders = ordersData[table.id] || [];
      const activeOrders = orders.filter(o => !o.paidAt && !o.cancelledAt && !o.deleted);
      
      const name = document.createElement('div');
      name.className = 'table-name';
      name.textContent = table.name || `ãƒ†ãƒ¼ãƒ–ãƒ« ${table.id}`;
      card.appendChild(name);
      
      if (activeOrders.length === 0) {
        const noOrders = document.createElement('div');
        noOrders.className = 'no-orders';
        noOrders.textContent = 'æ³¨æ–‡ãªã—';
        card.appendChild(noOrders);
        return;
      }
      
      const totalAmount = activeOrders.reduce((sum, order) => {
        return sum + (order.totalAmount || 0);
      }, 0);
      
      const hasIncomplete = activeOrders.some(o => !o.completedAt);
      
      if (hasIncomplete) {
        card.classList.add('has-incomplete-orders');
        const badge = document.createElement('div');
        badge.className = 'status-badge incomplete';
        badge.textContent = 'æœªå®Œäº†';
        card.appendChild(badge);
      } else {
        card.classList.add('has-orders');
      }
      
      const info = document.createElement('div');
      info.className = 'order-info';
      info.textContent = `${activeOrders.length}ä»¶ã®æ³¨æ–‡`;
      card.appendChild(info);
      
      const total = document.createElement('div');
      total.className = 'order-total';
      total.textContent = 'Â¥' + totalAmount.toLocaleString();
      card.appendChild(total);
      
      const btn = document.createElement('button');
      btn.className = 'payment-btn';
      btn.textContent = 'ä¼šè¨ˆã™ã‚‹';
      btn.onclick = (e) => {
        e.stopPropagation();
        playTapSound();
        openPaymentModal(table, activeOrders);
      };
      card.appendChild(btn);
    }
    
    // ========== ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ ==========
    function switchMode(mode) {
      playTapSound();
      currentMode = mode;
      
      document.getElementById('orderModeBtn').classList.toggle('active', mode === 'order');
      document.getElementById('paymentModeBtn').classList.toggle('active', mode === 'payment');
      
      renderTables();
    }
    
    // ========== ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« ==========
    function showCustomModal(options) {
      return new Promise((resolve) => {
        modalResolve = resolve;
        
        document.getElementById('modalIcon').textContent = options.icon || 'âœ…';
        document.getElementById('modalTitle').textContent = options.title || 'ç¢ºèª';
        document.getElementById('modalMessage').textContent = options.message || '';
        
        const confirmBtn = document.getElementById('modalConfirmBtn');
        confirmBtn.textContent = options.btnText || 'OK';
        confirmBtn.className = 'modal-btn ' + (options.btnClass || 'modal-btn-success');
        
        document.getElementById('customModal').style.display = 'flex';
      });
    }
    
    function closeCustomModal(result) {
      playTapSound();
      document.getElementById('customModal').style.display = 'none';
      if (modalResolve) {
        modalResolve(result);
        modalResolve = null;
      }
    }
    
    // ========== ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« ==========
    function openPaymentModal(table, orders) {
      currentPaymentOrders = orders;
      itemCheckStatus = {};
      
      document.getElementById('paymentTableName').textContent = table.name || `ãƒ†ãƒ¼ãƒ–ãƒ« ${table.id}`;
      
      let content = '';
      
      // æ³¨æ–‡è©³ç´°
      orders.forEach(order => {
        content += `<div class="order-item">`;
        content += `<div class="order-item-header">`;
        content += `<span class="order-number">æ³¨æ–‡ #${order.orderNumber || order.id.slice(-4)}</span>`;
        content += `<span class="order-time">${formatTime(order.createdAt)}</span>`;
        content += `</div>`;
        
        content += `<div class="item-list">`;
        (order.items || []).forEach((item, idx) => {
          const itemId = `${order.id}-${idx}`;
          itemCheckStatus[itemId] = item.served || false;
          
          content += `<div class="item-checkbox">`;
          content += `<input type="checkbox" id="check-${itemId}" ${item.served ? 'checked' : ''} onchange="toggleItemCheck('${itemId}')">`;
          content += `<label for="check-${itemId}">`;
          content += `<div class="item-name">${item.name} x${item.quantity}</div>`;
          content += `</label>`;
          content += `<div class="item-price">Â¥${((item.price || 0) * item.quantity).toLocaleString()}</div>`;
          content += `</div>`;
        });
        content += `</div>`;
        
        content += `<div class="order-total-section">`;
        content += `<div class="order-total-row">`;
        content += `<span>å°è¨ˆ</span>`;
        content += `<span>Â¥${(order.totalAmount || 0).toLocaleString()}</span>`;
        content += `</div>`;
        content += `</div>`;
        
        content += `</div>`;
      });
      
      // åˆè¨ˆé‡‘é¡
      const totalAmount = orders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      const orderCount = orders.length;
      
      content += `<div class="payment-summary">`;
      content += `<div class="summary-row"><span>æ³¨æ–‡ä»¶æ•°</span><span>${orderCount}ä»¶</span></div>`;
      content += `<div class="summary-row total"><span>åˆè¨ˆ</span><span>Â¥${totalAmount.toLocaleString()}</span></div>`;
      content += `</div>`;
      
      // æ”¯æ‰•ã„æ–¹æ³•
      content += `<div class="payment-methods">`;
      content += `<h3>æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠ</h3>`;
      content += `<button class="payment-method-btn" id="methodCash" onclick="selectPaymentMethod('cash')">`;
      content += `<span class="payment-method-icon">ğŸ’µ</span><span>ç¾é‡‘</span>`;
      content += `</button>`;
      content += `<button class="payment-method-btn" id="methodCard" onclick="selectPaymentMethod('card')">`;
      content += `<span class="payment-method-icon">ğŸ’³</span><span>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</span>`;
      content += `</button>`;
      content += `<button class="payment-method-btn" id="methodEmoney" onclick="selectPaymentMethod('emoney')">`;
      content += `<span class="payment-method-icon">ğŸ“±</span><span>é›»å­ãƒãƒãƒ¼</span>`;
      content += `</button>`;
      content += `</div>`;
      
      // ç¾é‡‘å…¥åŠ›
      content += `<div class="cash-input-group" id="cashInputGroup">`;
      content += `<label>ãŠé ã‹ã‚Šé‡‘é¡</label>`;
      content += `<input type="number" id="cashReceived" placeholder="0" oninput="calculateChange()">`;
      content += `<div class="quick-amounts">`;
      content += `<button class="quick-amount-btn" onclick="setQuickAmount(1000)">1,000å††</button>`;
      content += `<button class="quick-amount-btn" onclick="setQuickAmount(2000)">2,000å††</button>`;
      content += `<button class="quick-amount-btn" onclick="setQuickAmount(5000)">5,000å††</button>`;
      content += `<button class="quick-amount-btn" onclick="setQuickAmount(10000)">10,000å††</button>`;
      content += `<button class="quick-amount-btn" onclick="setQuickAmount(0)">ã‚¯ãƒªã‚¢</button>`;
      content += `<button class="quick-amount-btn" onclick="setQuickAmount(${totalAmount})">ãƒ”ãƒƒã‚¿ãƒª</button>`;
      content += `</div>`;
      content += `</div>`;
      
      // ãŠé‡£ã‚Šè¡¨ç¤º
      content += `<div class="change-display" id="changeDisplay">`;
      content += `<div class="change-label">ãŠé‡£ã‚Š</div>`;
      content += `<div class="change-amount" id="changeAmount">Â¥0</div>`;
      content += `</div>`;
      
      // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
      content += `<div class="action-buttons">`;
      content += `<button class="action-btn btn-adjust" onclick="openAdjustModal('price')">ğŸ’° é‡‘é¡å¤‰æ›´</button>`;
      content += `<button class="action-btn btn-discount" onclick="openAdjustModal('discount')">ğŸ·ï¸ å€¤å¼•ã</button>`;
      content += `<button class="action-btn btn-complete" id="completeBtn" onclick="markOrderComplete()">âœ… å®Œäº†</button>`;
      content += `<button class="action-btn btn-cancel" onclick="cancelOrder()">â¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>`;
      content += `<button class="action-btn btn-delete" onclick="deleteOrder()">ğŸ—‘ å‰Šé™¤</button>`;
      content += `<button class="action-btn btn-payment" id="paymentBtn" onclick="completePayment()" disabled style="opacity: 0.5;">ğŸ’³ ä¼šè¨ˆå®Œäº†</button>`;
      content += `</div>`;
      
      document.getElementById('paymentContent').innerHTML = content;
      
      document.getElementById('paymentModalOverlay').style.display = 'block';
      document.getElementById('paymentModal').classList.add('show');
      
      updateCompleteButton();
    }
    
    function closePaymentModal() {
      playTapSound();
      document.getElementById('paymentModalOverlay').style.display = 'none';
      document.getElementById('paymentModal').classList.remove('show');
      selectedPaymentMethod = null;
    }
    
    // ========== æ™‚åˆ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ==========
    function formatTime(timestamp) {
      if (!timestamp) return '';
      const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
      const h = date.getHours().toString().padStart(2, '0');
      const m = date.getMinutes().toString().padStart(2, '0');
      return `${h}:${m}`;
    }
    
    // ========== ãƒã‚§ãƒƒã‚¯å‡¦ç† ==========
    function toggleItemCheck(itemId) {
      playTapSound();
      itemCheckStatus[itemId] = !itemCheckStatus[itemId];
      updateCompleteButton();
    }
    
    function updateCompleteButton() {
      const completeBtn = document.getElementById('completeBtn');
      const allChecked = Object.values(itemCheckStatus).every(v => v);
      
      if (allChecked) {
        completeBtn.disabled = false;
        completeBtn.style.opacity = '1';
      } else {
        completeBtn.disabled = true;
        completeBtn.style.opacity = '0.5';
      }
    }
    
    // ========== æ”¯æ‰•ã„æ–¹æ³•é¸æŠ ==========
    function selectPaymentMethod(method) {
      playTapSound();
      selectedPaymentMethod = method;
      
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      const paymentBtn = document.getElementById('paymentBtn');
      paymentBtn.disabled = false;
      paymentBtn.style.opacity = '1';
      
      if (method === 'cash') {
        document.getElementById('methodCash').classList.add('selected');
        document.getElementById('cashInputGroup').style.display = 'block';
        document.getElementById('changeDisplay').style.display = 'block';
      } else if (method === 'card') {
        document.getElementById('methodCard').classList.add('selected');
        document.getElementById('cashInputGroup').style.display = 'none';
        document.getElementById('changeDisplay').style.display = 'none';
      } else if (method === 'emoney') {
        document.getElementById('methodEmoney').classList.add('selected');
        document.getElementById('cashInputGroup').style.display = 'none';
        document.getElementById('changeDisplay').style.display = 'none';
      }
    }
    
    // ========== ç¾é‡‘ã‚¯ã‚¤ãƒƒã‚¯å…¥åŠ› ==========
    function setQuickAmount(amount) {
      playTapSound();
      document.getElementById('cashReceived').value = amount;
      calculateChange();
    }
    
    function calculateChange() {
      const totalAmount = currentPaymentOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      const received = parseInt(document.getElementById('cashReceived').value) || 0;
      const change = received - totalAmount;
      
      const changeElement = document.getElementById('changeAmount');
      changeElement.textContent = 'Â¥' + Math.max(0, change).toLocaleString();
      
      if (change < 0) {
        changeElement.style.color = '#f44336';
      } else {
        changeElement.style.color = '#FF9800';
      }
    }
    
    // ========== é‡‘é¡èª¿æ•´ãƒ¢ãƒ¼ãƒ€ãƒ« ==========
    function openAdjustModal(type) {
      playTapSound();
      adjustmentType = type;
      
      if (currentPaymentOrders.length === 0) return;
      
      currentAdjustOrderId = currentPaymentOrders[0].id;
      const currentAmount = currentPaymentOrders[0].totalAmount || 0;
      
      const modal = document.getElementById('adjustModal');
      const title = document.getElementById('adjustModalTitle');
      const label = document.getElementById('adjustInputLabel');
      const input = document.getElementById('adjustInput');
      
      if (type === 'price') {
        title.textContent = 'é‡‘é¡å¤‰æ›´';
        label.textContent = 'æ–°ã—ã„é‡‘é¡ã‚’å…¥åŠ›';
        input.value = currentAmount;
      } else {
        title.textContent = 'å€¤å¼•ã';
        label.textContent = 'å€¤å¼•ãé¡ã‚’å…¥åŠ›';
        input.value = '';
      }
      
      modal.style.display = 'flex';
    }
    
    function closeAdjustModal() {
      playTapSound();
      document.getElementById('adjustModal').style.display = 'none';
    }
    
    async function confirmAdjustment() {
      playTapSound();
      
      const input = document.getElementById('adjustInput');
      const value = parseInt(input.value) || 0;
      
      if (value < 0) {
        alert('æ­£ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', currentAdjustOrderId);
        
        if (adjustmentType === 'price') {
          await window.updateDoc(orderRef, {
            totalAmount: value,
            adjustedAt: window.Timestamp.now()
          });
          
          await showCustomModal({
            icon: 'âœ…',
            title: 'é‡‘é¡å¤‰æ›´å®Œäº†',
            message: `é‡‘é¡ã‚’Â¥${value.toLocaleString()}ã«å¤‰æ›´ã—ã¾ã—ãŸ`,
            btnText: 'OK',
            btnClass: 'modal-btn-success'
          });
        } else {
          const currentAmount = currentPaymentOrders[0].totalAmount || 0;
          const newAmount = Math.max(0, currentAmount - value);
          
          await window.updateDoc(orderRef, {
            totalAmount: newAmount,
            discount: value,
            adjustedAt: window.Timestamp.now()
          });
          
          await showCustomModal({
            icon: 'âœ…',
            title: 'å€¤å¼•ãå®Œäº†',
            message: `Â¥${value.toLocaleString()}ã‚’å€¤å¼•ãã—ã¾ã—ãŸ\næ–°ã—ã„é‡‘é¡: Â¥${newAmount.toLocaleString()}`,
            btnText: 'OK',
            btnClass: 'modal-btn-success'
          });
        }
        
        closeAdjustModal();
        closePaymentModal();
        
      } catch (error) {
        console.error('âŒ èª¿æ•´ã‚¨ãƒ©ãƒ¼:', error);
        alert('èª¿æ•´å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      }
    }
    
    // ========== ä¼šè¨ˆå®Œäº† ==========
    async function completePayment() {
      playTapSound();
      
      if (!selectedPaymentMethod) {
        alert('æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      const totalAmount = currentPaymentOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      
      if (selectedPaymentMethod === 'cash') {
        const received = parseInt(document.getElementById('cashReceived').value) || 0;
        
        if (received < totalAmount) {
          alert('ãŠé ã‹ã‚Šé‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
          return;
        }
        
        const change = received - totalAmount;
        
        const confirmed = await showCustomModal({
          icon: 'ğŸ’°',
          title: 'ä¼šè¨ˆå®Œäº†ç¢ºèª',
          message: `æ”¯æ‰•ã„æ–¹æ³•: ç¾é‡‘\nåˆè¨ˆ: Â¥${totalAmount.toLocaleString()}\nãŠé ã‹ã‚Š: Â¥${received.toLocaleString()}\nãŠé‡£ã‚Š: Â¥${change.toLocaleString()}\n\nä¼šè¨ˆã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ`,
          btnText: 'å®Œäº†',
          btnClass: 'modal-btn-success'
        });
        
        if (!confirmed) return;
      } else {
        const methodName = selectedPaymentMethod === 'card' ? 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰' : 'é›»å­ãƒãƒãƒ¼';
        
        const confirmed = await showCustomModal({
          icon: 'ğŸ’³',
          title: 'ä¼šè¨ˆå®Œäº†ç¢ºèª',
          message: `æ”¯æ‰•ã„æ–¹æ³•: ${methodName}\nåˆè¨ˆ: Â¥${totalAmount.toLocaleString()}\n\nä¼šè¨ˆã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ`,
          btnText: 'å®Œäº†',
          btnClass: 'modal-btn-success'
        });
        
        if (!confirmed) return;
      }
      
      try {
        const now = window.Timestamp.now();
        
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          await window.updateDoc(orderRef, {
            paidAt: now,
            completedAt: now,
            paymentMethod: selectedPaymentMethod
          });
        }
        
        console.log('âœ… ä¼šè¨ˆå®Œäº†:', currentPaymentOrders.length, 'ä»¶');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'ä¼šè¨ˆå®Œäº†',
          message: `ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸ\n\n${currentPaymentOrders.length}ä»¶ã®æ³¨æ–‡ã‚’å‡¦ç†ã—ã¾ã—ãŸ`,
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ ä¼šè¨ˆã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¼šè¨ˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      }
    }
    
    // ========== æ³¨æ–‡å®Œäº† ==========
    async function markOrderComplete() {
      playTapSound();
      
      const allChecked = Object.values(itemCheckStatus).every(v => v);
      
      if (!allChecked) {
        alert('å…¨ã¦ã®å•†å“ã‚’æä¾›ã—ã¦ã‹ã‚‰ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„');
        return;
      }
      
      const confirmed = await showCustomModal({
        icon: 'âœ…',
        title: 'æ³¨æ–‡å®Œäº†ç¢ºèª',
        message: 'å…¨ã¦ã®å•†å“ã‚’æä¾›æ¸ˆã¿ã«ã—ã¦ã€æ³¨æ–‡ã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ',
        btnText: 'å®Œäº†',
        btnClass: 'modal-btn-success'
      });
      
      if (!confirmed) return;
      
      try {
        const now = window.Timestamp.now();
        
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          const updatedItems = order.items.map(item => ({
            ...item,
            served: true
          }));
          
          await window.updateDoc(orderRef, {
            completedAt: now,
            items: updatedItems
          });
        }
        
        console.log('âœ… æ³¨æ–‡å®Œäº†:', currentPaymentOrders.length, 'ä»¶');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'æ³¨æ–‡å®Œäº†',
          message: 'æ³¨æ–‡ãŒå®Œäº†ã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ å®Œäº†ã‚¨ãƒ©ãƒ¼:', error);
        alert('å®Œäº†å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      }
    }
    
    // ========== ã‚­ãƒ£ãƒ³ã‚»ãƒ« ==========
    async function cancelOrder() {
      playTapSound();
      
      const confirmed = await showCustomModal({
        icon: 'â¸',
        title: 'æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèª',
        message: 'ã“ã®æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ',
        btnText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
        btnClass: 'modal-btn-danger'
      });
      
      if (!confirmed) return;
      
      try {
        const now = window.Timestamp.now();
        
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          await window.updateDoc(orderRef, {
            cancelledAt: now
          });
        }
        
        console.log('âœ… æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«:', currentPaymentOrders.length, 'ä»¶');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†',
          message: 'æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      }
    }
    
    // ========== å‰Šé™¤ ==========
    async function deleteOrder() {
      playTapSound();
      
      const confirmed = await showCustomModal({
        icon: 'ğŸ—‘',
        title: 'æ³¨æ–‡å‰Šé™¤ç¢ºèª',
        message: 'ã“ã®æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼‰',
        btnText: 'å‰Šé™¤',
        btnClass: 'modal-btn-danger'
      });
      
      if (!confirmed) return;
      
      try {
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          await window.updateDoc(orderRef, {
            deleted: true,
            deletedAt: window.Timestamp.now()
          });
        }
        
        console.log('âœ… æ³¨æ–‡å‰Šé™¤:', currentPaymentOrders.length, 'ä»¶');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'å‰Šé™¤å®Œäº†',
          message: 'æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('å‰Šé™¤å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      }
    }
    
    // ========== ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ ==========
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('ğŸ“± ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•');
      
      while (!window.firebaseReady || !window.db) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      console.log('âœ… Firebaseæº–å‚™å®Œäº†ã€åº—èˆ—ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã™');
      
      await loadStoreList();
      
      const savedStoreId = sessionStorage.getItem('handyStoreId');
      const savedStoreName = sessionStorage.getItem('handyStoreName');
      
      if (savedStoreId && savedStoreName && storesData[savedStoreId]) {
        currentStoreId = savedStoreId;
        currentStoreName = savedStoreName;
        
        console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å¾©å…ƒ:', currentStoreName);
        showTablesScreen();
      }
    });
  </script>
</body>
</html>
