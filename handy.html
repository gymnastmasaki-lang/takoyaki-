<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    .login-screen {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .login-screen h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 28px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .login-btn:active {
      transform: scale(0.98);
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ */
    .tables-screen {
      display: none;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .header h2 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .header .store-info {
      color: #666;
      font-size: 14px;
    }
    
    .logout-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .table-card {
      background: white;
      border-radius: 15px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    
    .table-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .table-card:active {
      transform: translateY(-2px);
    }
    
    .table-card .table-name {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .table-card .table-status {
      font-size: 12px;
      color: #999;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ã«ä¼šè¨ˆãƒœã‚¿ãƒ³ã‚’è¿½åŠ  */
    .table-card .checkout-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
      z-index: 10;
    }
    
    .table-card .checkout-btn:hover {
      background: #45a049;
    }
    
    /* ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« */
    .checkout-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      z-index: 1000;
      overflow-y: auto;
      padding: 20px;
    }
    
    .checkout-modal-content {
      background: white;
      max-width: 600px;
      margin: 0 auto;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    
    .checkout-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #eee;
    }
    
    .checkout-header h2 {
      color: #667eea;
      font-size: 24px;
    }
    
    .close-checkout {
      background: #f44336;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    /* æ³¨æ–‡æ˜ç´° */
    .order-details {
      background: #f5f5f5;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #ddd;
    }
    
    .order-item:last-child {
      border-bottom: none;
    }
    
    .item-info {
      flex: 1;
    }
    
    .item-name {
      font-weight: bold;
      color: #333;
    }
    
    .item-quantity {
      color: #666;
      font-size: 14px;
    }
    
    .item-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .item-price {
      font-weight: bold;
      color: #667eea;
      font-size: 18px;
      margin-right: 10px;
    }
    
    .edit-price-btn {
      background: #2196F3;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      cursor: pointer;
    }
    
    /* é‡‘é¡å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .price-edit-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 2000;
      align-items: center;
      justify-content: center;
    }
    
    .price-edit-content {
      background: white;
      padding: 30px;
      border-radius: 15px;
      max-width: 400px;
      width: 90%;
    }
    
    .price-edit-content h3 {
      color: #2196F3;
      margin-bottom: 20px;
    }
    
    .price-edit-input {
      width: 100%;
      padding: 15px;
      font-size: 24px;
      border: 2px solid #ddd;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .price-edit-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .price-edit-buttons button {
      padding: 15px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .price-edit-buttons .confirm {
      background: #4CAF50;
      color: white;
    }
    
    .price-edit-buttons .cancel {
      background: #f44336;
      color: white;
    }
    
    /* åˆè¨ˆé‡‘é¡ */
    .total-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    
    .total-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 16px;
    }
    
    .total-row.main {
      font-size: 24px;
      font-weight: bold;
      padding-top: 10px;
      border-top: 2px solid rgba(255,255,255,0.3);
    }
    
    /* å€¤å¼•ãã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .discount-section {
      background: #fff3cd;
      border: 2px solid #ffc107;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .discount-section h3 {
      color: #ff9800;
      margin-bottom: 10px;
      font-size: 18px;
    }
    
    .discount-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .discount-input-group input {
      flex: 1;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .discount-input-group button {
      padding: 12px 20px;
      background: #ff9800;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .discount-input-group button:hover {
      background: #f57c00;
    }
    
    .current-discount {
      color: #666;
      font-size: 14px;
      margin-top: 5px;
    }
    
    /* æ”¯æ‰•ã„æ–¹æ³•é¸æŠ */
    .payment-methods {
      margin-bottom: 20px;
    }
    
    .payment-methods h3 {
      color: #333;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .payment-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    
    .payment-btn {
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
    }
    
    .payment-btn:hover {
      border-color: #667eea;
      background: #f5f5ff;
    }
    
    .payment-btn.selected {
      border-color: #667eea;
      background: #667eea;
      color: white;
    }
    
    .payment-btn-icon {
      font-size: 24px;
    }
    
    /* ç¾é‡‘æ‰•ã„ãŠã¤ã‚Šè¨ˆç®— */
    .cash-payment-section {
      display: none;
      background: #e8f5e9;
      border: 2px solid #4CAF50;
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
    }
    
    .cash-payment-section h4 {
      color: #2e7d32;
      margin-bottom: 10px;
    }
    
    .cash-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .cash-input-group input {
      flex: 1;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 18px;
    }
    
    .change-display {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      color: #2e7d32;
    }
    
    .change-display .label {
      font-size: 14px;
      color: #666;
      margin-bottom: 5px;
    }
    
    /* ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    
    .action-btn {
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .action-btn:active {
      transform: scale(0.95);
    }
    
    .action-btn.complete {
      background: #4CAF50;
      color: white;
    }
    
    .action-btn.complete:hover {
      background: #45a049;
    }
    
    .action-btn.cancel {
      background: #f44336;
      color: white;
    }
    
    .action-btn.cancel:hover {
      background: #da190b;
    }
    
    .action-btn.delete {
      background: #ff9800;
      color: white;
    }
    
    .action-btn.delete:hover {
      background: #f57c00;
    }
    
    .hidden {
      display: none !important;
    }
    
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .success-message {
      background: #e8f5e9;
      color: #2e7d32;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }
    
    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ */
    @media (max-width: 480px) {
      .payment-options {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div class="login-screen" id="loginScreen">
      <h1>ğŸ½ï¸ ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </h1>
      <div id="errorMessage" class="error-message hidden"></div>
      
      <div class="form-group">
        <label for="storeSelect">åº—èˆ—ã‚’é¸æŠ</label>
        <select id="storeSelect">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="passwordInput">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      </div>
      
      <button class="login-btn" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    
    <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ -->
    <div class="tables-screen" id="tablesScreen">
      <div class="header">
        <h2 id="storeNameDisplay">åº—èˆ—å</h2>
        <div class="store-info">ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        <button class="logout-btn" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      
      <div class="tables-grid" id="tablesGrid">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>
  
  <!-- ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="checkout-modal" id="checkoutModal">
    <div class="checkout-modal-content">
      <div class="checkout-header">
        <h2 id="checkoutTableName">ãƒ†ãƒ¼ãƒ–ãƒ« ä¼šè¨ˆ</h2>
        <button class="close-checkout" onclick="closeCheckoutModal()">é–‰ã˜ã‚‹</button>
      </div>
      
      <div id="checkoutMessage" class="hidden"></div>
      
      <!-- æ³¨æ–‡æ˜ç´° -->
      <div class="order-details" id="orderDetails">
        <div class="loading" style="color: #666;">æ³¨æ–‡ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      
      <!-- å€¤å¼•ãã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="discount-section">
        <h3>ğŸ’° å€¤å¼•ã</h3>
        <div class="discount-input-group">
          <input type="number" id="discountAmount" placeholder="å€¤å¼•ãé¡ã‚’å…¥åŠ›" min="0">
          <button onclick="applyDiscount()">é©ç”¨</button>
        </div>
        <div class="current-discount" id="currentDiscount">å€¤å¼•ãé¡: Â¥0</div>
      </div>
      
      <!-- åˆè¨ˆé‡‘é¡ -->
      <div class="total-section">
        <div class="total-row">
          <span>å°è¨ˆ:</span>
          <span id="subtotalAmount">Â¥0</span>
        </div>
        <div class="total-row">
          <span>å€¤å¼•ã:</span>
          <span id="discountDisplay">-Â¥0</span>
        </div>
        <div class="total-row main">
          <span>åˆè¨ˆ:</span>
          <span id="totalAmount">Â¥0</span>
        </div>
      </div>
      
      <!-- æ”¯æ‰•ã„æ–¹æ³•é¸æŠ -->
      <div class="payment-methods">
        <h3>ğŸ’³ æ”¯æ‰•ã„æ–¹æ³•</h3>
        <div class="payment-options">
          <button class="payment-btn" onclick="selectPaymentMethod('cash')">
            <span class="payment-btn-icon">ğŸ’µ</span>
            <span>ç¾é‡‘</span>
          </button>
          <button class="payment-btn" onclick="selectPaymentMethod('emoney')">
            <span class="payment-btn-icon">ğŸ“±</span>
            <span>é›»å­ãƒãƒãƒ¼</span>
          </button>
          <button class="payment-btn" onclick="selectPaymentMethod('credit')">
            <span class="payment-btn-icon">ğŸ’³</span>
            <span>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</span>
          </button>
        </div>
        
        <!-- ç¾é‡‘æ‰•ã„ãŠã¤ã‚Šè¨ˆç®— -->
        <div class="cash-payment-section" id="cashPaymentSection">
          <h4>ğŸ’´ ãŠé ã‹ã‚Šé‡‘é¡</h4>
          <div class="cash-input-group">
            <input type="number" id="receivedAmount" placeholder="ãŠé ã‹ã‚Šé‡‘é¡ã‚’å…¥åŠ›" min="0" oninput="updateChange()">
          </div>
          <div class="change-display">
            <div class="label">ãŠã¤ã‚Š</div>
            <div id="changeAmount">Â¥0</div>
          </div>
        </div>
      </div>
      
      <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
      <div class="action-buttons">
        <button class="action-btn complete" onclick="completeCheckout()">
          âœ… å®Œäº†
        </button>
        <button class="action-btn cancel" onclick="closeCheckoutModal()">
          âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button class="action-btn delete" onclick="deleteOrder()">
          ğŸ—‘ï¸ å‰Šé™¤
        </button>
      </div>
    </div>
  </div>
  
  <!-- é‡‘é¡å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="price-edit-modal" id="priceEditModal">
    <div class="price-edit-content">
      <h3>ğŸ’° é‡‘é¡å¤‰æ›´</h3>
      <div style="margin-bottom: 15px;">
        <div style="font-weight: bold; color: #333;">å•†å“å: <span id="editItemName"></span></div>
        <div style="color: #666; font-size: 14px;">å…ƒã®é‡‘é¡: Â¥<span id="editOriginalPrice"></span></div>
      </div>
      <input type="number" id="newPriceInput" class="price-edit-input" placeholder="æ–°ã—ã„é‡‘é¡ã‚’å…¥åŠ›" min="0">
      <div class="price-edit-buttons">
        <button class="confirm" onclick="confirmPriceEdit()">å¤‰æ›´</button>
        <button class="cancel" onclick="closePriceEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, getDocs, doc, getDoc, where, updateDoc, deleteDoc, Timestamp, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.doc = doc;
    window.getDoc = getDoc;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.Timestamp = Timestamp;
    window.addDoc = addDoc;
    
    console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†');
    
    // FirebaseåˆæœŸåŒ–å®Œäº†ã‚’é€šçŸ¥
    window.firebaseReady = true;
    window.dispatchEvent(new Event('firebaseReady'));
  </script>
  
  <script>
    let currentStoreId = null;
    let currentStoreName = null;
    let storesData = {}; // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    
    // ä¼šè¨ˆé–¢é€£ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let currentCheckoutTable = null;
    let currentOrderData = null;
    let currentDiscount = 0;
    let selectedPaymentMethod = null;
    let editingItemIndex = null;
    
    // åº—èˆ—ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
    async function loadStoreList() {
      try {
        console.log('ğŸ“‹ åº—èˆ—ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ä¸­...');
        const storesQuery = window.query(
          window.collection(window.db, 'stores'),
          window.where('isActive', '==', true)
        );
        const storesSnapshot = await window.getDocs(storesQuery);
        const storeSelect = document.getElementById('storeSelect');
        
        storeSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        storesData = {};
        
        storesSnapshot.forEach(doc => {
          const storeData = doc.data();
          const storeId = doc.id;
          const storeName = storeData.storeName || doc.id;
          const password = storeData.storePassword || '';
          
          // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
          storesData[storeId] = {
            storeName: storeName,
            password: String(password),
            isActive: true
          };
          
          // ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã«è¿½åŠ 
          const option = document.createElement('option');
          option.value = storeId;
          option.textContent = storeName;
          storeSelect.appendChild(option);
          
          console.log('ğŸ“ åº—èˆ—è¿½åŠ :', storeName, '(ID:', storeId, ')');
        });
        
        console.log('âœ… åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å®Œäº†:', Object.keys(storesData).length, 'åº—èˆ—');
      } catch (error) {
        console.error('âŒ åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        showError('åº—èˆ—ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
    
    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    window.handleLogin = async function() {
      const storeSelect = document.getElementById('storeSelect');
      const passwordInput = document.getElementById('passwordInput');
      
      const storeId = storeSelect.value;
      const inputPassword = passwordInput.value.trim();
      
      console.log('ğŸ” ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œ:', storeId);
      
      if (!storeId) {
        showError('åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!inputPassword) {
        showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      const storeInfo = storesData[storeId];
      if (!storeInfo) {
        showError('åº—èˆ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
      if (inputPassword !== storeInfo.password) {
        console.error('âŒ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä¸ä¸€è‡´');
        showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
      currentStoreId = storeId;
      currentStoreName = storeInfo.storeName;
      sessionStorage.setItem('handyStoreId', storeId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      
      console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', currentStoreName);
      console.log('   currentStoreId:', currentStoreId);
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ã‚’è¡¨ç¤º
      showTablesScreen();
    };
    
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
    window.handleLogout = function() {
      if (confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
        sessionStorage.removeItem('handyStoreId');
        sessionStorage.removeItem('handyStoreName');
        
        currentStoreId = null;
        currentStoreName = null;
        
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('tablesScreen').classList.add('hidden');
        document.getElementById('tablesScreen').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'block';
        
        document.getElementById('passwordInput').value = '';
      }
    };
    
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      
      setTimeout(() => {
        errorDiv.classList.add('hidden');
      }, 3000);
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ã‚’è¡¨ç¤º
    async function showTablesScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('tablesScreen').style.display = 'block';
      document.getElementById('tablesScreen').classList.remove('hidden');
      document.getElementById('storeNameDisplay').textContent = currentStoreName;
      
      await loadTables();
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadTables() {
      try {
        console.log('ğŸ” ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...');
        const tablesGrid = document.getElementById('tablesGrid');
        tablesGrid.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
        
        // stores/{storeId}/tables ã‹ã‚‰èª­ã¿è¾¼ã¿
        const tablesRef = window.collection(window.db, 'stores', currentStoreId, 'tables');
        const tablesSnapshot = await window.getDocs(tablesRef);
        const tables = [];
        
        tablesSnapshot.forEach(doc => {
          tables.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        console.log('ğŸ“Š å–å¾—ã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«æ•°:', tables.length);
        
        // orderãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã‚½ãƒ¼ãƒˆ
        tables.sort((a, b) => {
          const orderA = a.order || 0;
          const orderB = b.order || 0;
          if (orderA !== orderB) {
            return orderA - orderB;
          }
          return a.name.localeCompare(b.name);
        });
        
        if (tables.length === 0) {
          tablesGrid.innerHTML = '<div style="color: white; text-align: center; padding: 40px;">ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
          return;
        }
        
        tablesGrid.innerHTML = '';
        
        tables.forEach(table => {
          const tableCard = document.createElement('div');
          tableCard.className = 'table-card';
          
          tableCard.innerHTML = `
            <button class="checkout-btn" onclick="openCheckout('${table.name}'); event.stopPropagation();">ğŸ’° ä¼šè¨ˆ</button>
            <div class="table-name">${table.name}</div>
            <div class="table-status">ã‚¿ãƒƒãƒ—ã—ã¦æ³¨æ–‡</div>
          `;
          
          // ã‚«ãƒ¼ãƒ‰å…¨ä½“ã‚’ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã¸
          tableCard.onclick = (e) => {
            if (e.target.classList.contains('checkout-btn')) return;
            openMenu(table.name);
          };
          
          tablesGrid.appendChild(tableCard);
        });
        
        console.log('âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§èª­ã¿è¾¼ã¿å®Œäº†:', tables.length + 'ä»¶');
      } catch (error) {
        console.error('âŒ ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        const tablesGrid = document.getElementById('tablesGrid');
        tablesGrid.innerHTML = '<div style="color: white; text-align: center; padding: 40px;">ãƒ†ãƒ¼ãƒ–ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    }
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‚’é–‹ã
    function openMenu(tableName) {
      console.log('ğŸ“± ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‚’é–‹ã:', tableName);
      
      // menu.htmlã«é·ç§»ï¼ˆstoreIdã¨tableã¨modeã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ¸¡ã™ï¼‰
      const menuUrl = `menu.html?table=${encodeURIComponent(tableName)}&store=${currentStoreId}&mode=handy`;
      
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«åº—èˆ—æƒ…å ±ã‚’ä¿å­˜ï¼ˆmenu.htmlã§ä½¿ç”¨ï¼‰
      sessionStorage.setItem('handyStoreId', currentStoreId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      sessionStorage.setItem('handyTableName', tableName);
      
      console.log('â†’ é·ç§»å…ˆ:', menuUrl);
      window.location.href = menuUrl;
    }
    
    // ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openCheckout = async function(tableName) {
      console.log('ğŸ’° ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã:', tableName);
      currentCheckoutTable = tableName;
      currentDiscount = 0;
      selectedPaymentMethod = null;
      
      document.getElementById('checkoutTableName').textContent = `${tableName} ä¼šè¨ˆ`;
      document.getElementById('checkoutModal').style.display = 'block';
      
      // å€¤å¼•ãã‚’ãƒªã‚»ãƒƒãƒˆ
      document.getElementById('discountAmount').value = '';
      document.getElementById('currentDiscount').textContent = 'å€¤å¼•ãé¡: Â¥0';
      
      // æ”¯æ‰•ã„æ–¹æ³•ã®é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll('.payment-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // ç¾é‡‘æ‰•ã„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
      document.getElementById('cashPaymentSection').style.display = 'none';
      document.getElementById('receivedAmount').value = '';
      document.getElementById('changeAmount').textContent = 'Â¥0';
      
      // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      await loadOrderData(tableName);
    };
    
    // ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeCheckoutModal = function() {
      document.getElementById('checkoutModal').style.display = 'none';
      currentCheckoutTable = null;
      currentOrderData = null;
    };
    
    // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆPOSã¨åŒã˜ãƒ‘ã‚¹ã§èª­ã¿è¾¼ã‚€ï¼‰
    async function loadOrderData(tableName) {
      try {
        console.log('ğŸ“‹ æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­:', tableName);
        console.log('   åº—èˆ—ID:', currentStoreId);
        console.log('   ãƒ‘ã‚¹: stores/' + currentStoreId + '/orders');
        
        // POSã¨åŒã˜ãƒ‘ã‚¹ã§æ³¨æ–‡ã‚’æ¤œç´¢
        const ordersRef = window.collection(window.db, 'stores', currentStoreId, 'orders');
        const q = window.query(
          ordersRef,
          window.where('table', '==', tableName),
          window.where('status', '==', 'active')
        );
        
        const querySnapshot = await window.getDocs(q);
        console.log('   æ¤œç´¢çµæœä»¶æ•°:', querySnapshot.size);
        
        if (querySnapshot.empty) {
          console.log('âš ï¸ æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          document.getElementById('orderDetails').innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          updateTotalDisplay(0, 0);
          return;
        }
        
        // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        let orderDoc = null;
        querySnapshot.forEach(doc => {
          orderDoc = { id: doc.id, ...doc.data() };
          console.log('   æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿:', orderDoc);
        });
        
        if (!orderDoc) {
          document.getElementById('orderDetails').innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          updateTotalDisplay(0, 0);
          return;
        }
        
        currentOrderData = orderDoc;
        console.log('âœ… æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ');
        
        // æ³¨æ–‡æ˜ç´°ã‚’è¡¨ç¤º
        displayOrderDetails(orderDoc);
        
      } catch (error) {
        console.error('âŒ æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('orderDetails').innerHTML = '<div style="color: #f44336; text-align: center; padding: 20px;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ<br>' + error.message + '</div>';
      }
    }
    
    // æ³¨æ–‡æ˜ç´°ã‚’è¡¨ç¤º
    function displayOrderDetails(orderData) {
      const orderDetails = document.getElementById('orderDetails');
      orderDetails.innerHTML = '';
      
      if (!orderData.items || orderData.items.length === 0) {
        orderDetails.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        updateTotalDisplay(0, 0);
        return;
      }
      
      let subtotal = 0;
      
      orderData.items.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'order-item';
        
        const itemPrice = item.price * item.quantity;
        subtotal += itemPrice;
        
        itemDiv.innerHTML = `
          <div class="item-info">
            <div class="item-name">${item.name}</div>
            <div class="item-quantity">æ•°é‡: ${item.quantity} Ã— Â¥${item.price.toLocaleString()}</div>
          </div>
          <div class="item-actions">
            <div class="item-price">Â¥${itemPrice.toLocaleString()}</div>
            <button class="edit-price-btn" onclick="openPriceEdit(${index})">å¤‰æ›´</button>
          </div>
        `;
        
        orderDetails.appendChild(itemDiv);
      });
      
      updateTotalDisplay(subtotal, currentDiscount);
    }
    
    // åˆè¨ˆé‡‘é¡è¡¨ç¤ºã‚’æ›´æ–°
    function updateTotalDisplay(subtotal, discount) {
      const total = Math.max(0, subtotal - discount);
      
      document.getElementById('subtotalAmount').textContent = `Â¥${subtotal.toLocaleString()}`;
      document.getElementById('discountDisplay').textContent = `-Â¥${discount.toLocaleString()}`;
      document.getElementById('totalAmount').textContent = `Â¥${total.toLocaleString()}`;
      
      // ãŠã¤ã‚Šè¨ˆç®—ã‚’æ›´æ–°
      if (selectedPaymentMethod === 'cash') {
        updateChange();
      }
    }
    
    // å€¤å¼•ãã‚’é©ç”¨
    window.applyDiscount = function() {
      const discountInput = document.getElementById('discountAmount');
      const discountValue = parseInt(discountInput.value) || 0;
      
      if (discountValue < 0) {
        showCheckoutMessage('å€¤å¼•ãé¡ã¯0ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      currentDiscount = discountValue;
      document.getElementById('currentDiscount').textContent = `å€¤å¼•ãé¡: Â¥${discountValue.toLocaleString()}`;
      
      // åˆè¨ˆé‡‘é¡ã‚’æ›´æ–°
      if (currentOrderData && currentOrderData.items) {
        let subtotal = 0;
        currentOrderData.items.forEach(item => {
          subtotal += item.price * item.quantity;
        });
        updateTotalDisplay(subtotal, currentDiscount);
      }
      
      showCheckoutMessage(`å€¤å¼•ã Â¥${discountValue.toLocaleString()} ã‚’é©ç”¨ã—ã¾ã—ãŸ`, 'success');
    };
    
    // æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠ
    window.selectPaymentMethod = function(method) {
      selectedPaymentMethod = method;
      
      // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‹ã‚‰é¸æŠçŠ¶æ…‹ã‚’è§£é™¤
      document.querySelectorAll('.payment-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸãƒœã‚¿ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
      event.target.closest('.payment-btn').classList.add('selected');
      
      // ç¾é‡‘æ‰•ã„ã®å ´åˆã¯ãŠã¤ã‚Šè¨ˆç®—ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
      const cashSection = document.getElementById('cashPaymentSection');
      if (method === 'cash') {
        cashSection.style.display = 'block';
      } else {
        cashSection.style.display = 'none';
      }
      
      const methodNames = {
        'cash': 'ç¾é‡‘',
        'emoney': 'é›»å­ãƒãƒãƒ¼',
        'credit': 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰'
      };
      
      console.log('ğŸ’³ æ”¯æ‰•ã„æ–¹æ³•é¸æŠ:', methodNames[method]);
    };
    
    // ãŠã¤ã‚Šè¨ˆç®—ã‚’æ›´æ–°
    window.updateChange = function() {
      const receivedInput = document.getElementById('receivedAmount');
      const receivedAmount = parseInt(receivedInput.value) || 0;
      
      // åˆè¨ˆé‡‘é¡ã‚’å–å¾—
      const totalText = document.getElementById('totalAmount').textContent;
      const totalAmount = parseInt(totalText.replace(/[^0-9]/g, '')) || 0;
      
      const change = receivedAmount - totalAmount;
      
      const changeDisplay = document.getElementById('changeAmount');
      if (change >= 0) {
        changeDisplay.textContent = `Â¥${change.toLocaleString()}`;
        changeDisplay.style.color = '#2e7d32';
      } else {
        changeDisplay.textContent = `ä¸è¶³: Â¥${Math.abs(change).toLocaleString()}`;
        changeDisplay.style.color = '#f44336';
      }
    };
    
    // é‡‘é¡å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openPriceEdit = function(itemIndex) {
      if (!currentOrderData || !currentOrderData.items || !currentOrderData.items[itemIndex]) {
        return;
      }
      
      editingItemIndex = itemIndex;
      const item = currentOrderData.items[itemIndex];
      
      document.getElementById('editItemName').textContent = item.name;
      document.getElementById('editOriginalPrice').textContent = item.price.toLocaleString();
      document.getElementById('newPriceInput').value = item.price;
      
      document.getElementById('priceEditModal').style.display = 'flex';
    };
    
    // é‡‘é¡å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closePriceEditModal = function() {
      document.getElementById('priceEditModal').style.display = 'none';
      editingItemIndex = null;
    };
    
    // é‡‘é¡å¤‰æ›´ã‚’ç¢ºå®š
    window.confirmPriceEdit = async function() {
      if (editingItemIndex === null || !currentOrderData) {
        return;
      }
      
      const newPrice = parseInt(document.getElementById('newPriceInput').value) || 0;
      
      if (newPrice < 0) {
        alert('é‡‘é¡ã¯0ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        currentOrderData.items[editingItemIndex].price = newPrice;
        
        // Firestoreã«ä¿å­˜
        const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', currentOrderData.id);
        await window.updateDoc(orderRef, {
          items: currentOrderData.items
        });
        
        console.log('âœ… é‡‘é¡ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
        showCheckoutMessage(`é‡‘é¡ã‚’ Â¥${newPrice.toLocaleString()} ã«å¤‰æ›´ã—ã¾ã—ãŸ`, 'success');
        
        // è¡¨ç¤ºã‚’æ›´æ–°
        displayOrderDetails(currentOrderData);
        
        closePriceEditModal();
        
      } catch (error) {
        console.error('âŒ é‡‘é¡å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', error);
        alert('é‡‘é¡ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };
    
    // ä¼šè¨ˆå®Œäº†
    window.completeCheckout = async function() {
      if (!currentOrderData) {
        showCheckoutMessage('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
      }
      
      if (!selectedPaymentMethod) {
        showCheckoutMessage('æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
        return;
      }
      
      // ç¾é‡‘æ‰•ã„ã®å ´åˆã¯ãŠã¤ã‚Šãƒã‚§ãƒƒã‚¯
      if (selectedPaymentMethod === 'cash') {
        const receivedAmount = parseInt(document.getElementById('receivedAmount').value) || 0;
        const totalText = document.getElementById('totalAmount').textContent;
        const totalAmount = parseInt(totalText.replace(/[^0-9]/g, '')) || 0;
        
        if (receivedAmount < totalAmount) {
          showCheckoutMessage('ãŠé ã‹ã‚Šé‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™', 'error');
          return;
        }
      }
      
      try {
        // åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
        let subtotal = 0;
        currentOrderData.items.forEach(item => {
          subtotal += item.price * item.quantity;
        });
        const totalAmount = Math.max(0, subtotal - currentDiscount);
        
        console.log('ğŸ’° ä¼šè¨ˆå®Œäº†å‡¦ç†é–‹å§‹');
        console.log('   ãƒ†ãƒ¼ãƒ–ãƒ«:', currentCheckoutTable);
        console.log('   å°è¨ˆ:', subtotal);
        console.log('   å€¤å¼•ã:', currentDiscount);
        console.log('   åˆè¨ˆ:', totalAmount);
        console.log('   æ”¯æ‰•ã„æ–¹æ³•:', selectedPaymentMethod);
        
        // æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ completed ã«æ›´æ–°
        const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', currentOrderData.id);
        await window.updateDoc(orderRef, {
          status: 'completed',
          paymentMethod: selectedPaymentMethod,
          discount: currentDiscount,
          totalAmount: totalAmount,
          completedAt: window.Timestamp.now()
        });
        
        // å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        const salesRef = window.collection(window.db, 'stores', currentStoreId, 'sales');
        await window.addDoc(salesRef, {
          table: currentCheckoutTable,
          items: currentOrderData.items,
          subtotal: subtotal,
          discount: currentDiscount,
          totalAmount: totalAmount,
          paymentMethod: selectedPaymentMethod,
          completedAt: window.Timestamp.now(),
          date: new Date().toISOString().split('T')[0]
        });
        
        console.log('âœ… ä¼šè¨ˆå®Œäº†');
        showCheckoutMessage('ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
        
        setTimeout(() => {
          closeCheckoutModal();
        }, 1500);
        
      } catch (error) {
        console.error('âŒ ä¼šè¨ˆå®Œäº†ã‚¨ãƒ©ãƒ¼:', error);
        showCheckoutMessage('ä¼šè¨ˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
      }
    };
    
    // æ³¨æ–‡å‰Šé™¤
    window.deleteOrder = async function() {
      if (!currentOrderData) {
        showCheckoutMessage('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'error');
        return;
      }
      
      if (!confirm(`${currentCheckoutTable}ã®æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        return;
      }
      
      try {
        console.log('ğŸ—‘ï¸ æ³¨æ–‡å‰Šé™¤:', currentOrderData.id);
        
        const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', currentOrderData.id);
        await window.deleteDoc(orderRef);
        
        console.log('âœ… æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        showCheckoutMessage('æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
        
        setTimeout(() => {
          closeCheckoutModal();
        }, 1500);
        
      } catch (error) {
        console.error('âŒ æ³¨æ–‡å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        showCheckoutMessage('æ³¨æ–‡å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
      }
    };
    
    // ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    function showCheckoutMessage(message, type) {
      const messageDiv = document.getElementById('checkoutMessage');
      messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
      messageDiv.textContent = message;
      messageDiv.classList.remove('hidden');
      
      setTimeout(() => {
        messageDiv.classList.add('hidden');
      }, 3000);
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚: FirebaseåˆæœŸåŒ–ã‚’å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œ
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('ğŸ“± ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•');
      
      // FirebaseåˆæœŸåŒ–ã‚’å¾…ã¤
      while (!window.firebaseReady || !window.db) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      console.log('âœ… Firebaseæº–å‚™å®Œäº†ã€åº—èˆ—ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã™');
      
      // åº—èˆ—ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
      await loadStoreList();
      
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å¾©å…ƒ
      const savedStoreId = sessionStorage.getItem('handyStoreId');
      const savedStoreName = sessionStorage.getItem('handyStoreName');
      
      if (savedStoreId && savedStoreName && storesData[savedStoreId]) {
        currentStoreId = savedStoreId;
        currentStoreName = savedStoreName;
        
        console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å¾©å…ƒ:', currentStoreName);
        showTablesScreen();
      }
    });
  </script>
</body>
</html>
