<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ  - POSå®Œå…¨åŒæœŸç‰ˆ</title>
  <style>
    /* ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–ã‚¹ã‚¿ã‚¤ãƒ« */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f0f2f5; color: #333; padding: 10px; }
    .container { max-width: 500px; margin: 0 auto; }
    .hidden { display: none !important; }
    
    /* ã‚«ãƒ¼ãƒ‰ãƒ‡ã‚¶ã‚¤ãƒ³ */
    .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px; }
    .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; margin-bottom: 8px; }
    .btn-primary { background: #4a90e2; color: white; }
    .btn-success { background: #4caf50; color: white; }
    .btn-danger { background: #f44336; color: white; }
    .btn-warning { background: #ff9800; color: white; }
    .btn-secondary { background: #e0e0e0; color: #333; }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚°ãƒªãƒƒãƒ‰ */
    .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
    .table-card { background: white; border-radius: 10px; padding: 20px 10px; text-align: center; border: 2px solid #ddd; position: relative; }
    .table-card.active { border-color: #ff9800; background: #fff8e1; }
    .table-name { font-size: 18px; font-weight: bold; }
    .status-badge { font-size: 10px; color: #ff9800; margin-top: 5px; }

    /* ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; padding: 10px; }
    .modal { background: white; width: 100%; max-width: 400px; border-radius: 16px; padding: 20px; max-height: 90vh; overflow-y: auto; }
    
    .item-list { border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; max-height: 150px; overflow-y: auto; }
    .item-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-size: 14px; }
    .clickable-item { color: #4a90e2; text-decoration: underline; }

    .price-summary { background: #f8f9fa; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 15px; }
    .total-label { font-size: 14px; color: #666; }
    .total-value { font-size: 28px; font-weight: bold; color: #d32f2f; }

    .payment-methods { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
    .method-btn { padding: 12px 5px; border: 2px solid #ddd; border-radius: 8px; background: white; font-weight: bold; font-size: 13px; }
    .method-btn.selected { border-color: #4a90e2; background: #eef6ff; color: #4a90e2; }

    input[type="number"] { width: 100%; padding: 10px; font-size: 18px; border: 1px solid #ddd; border-radius: 6px; text-align: right; }
  </style>
</head>
<body>

<div class="container">
  <div id="loginScreen" class="card">
    <h2 style="text-align:center; margin-bottom:20px;">ãƒãƒ³ãƒ‡ã‚£ä¼šè¨ˆã‚·ã‚¹ãƒ†ãƒ </h2>
    <div style="margin-bottom:15px;">
      <label>åº—èˆ—é¸æŠ</label>
      <select id="storeSelect" style="width:100%; padding:12px; margin-top:5px;"></select>
    </div>
    <div style="margin-bottom:15px;">
      <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input type="password" id="passwordInput" style="width:100%; padding:12px; margin-top:5px;">
    </div>
    <button class="btn btn-primary" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>

  <div id="tablesScreen" class="hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
      <h3 id="displayStoreName">---</h3>
      <button class="btn btn-secondary" style="width:auto; margin:0; padding:5px 10px;" onclick="handleLogout()">è§£é™¤</button>
    </div>
    <div id="tablesGrid" class="tables-grid"></div>
  </div>
</div>

<div id="paymentModal" class="modal-overlay hidden">
  <div class="modal">
    <h3 style="text-align:center; margin-bottom:10px;">ä¼šè¨ˆç®¡ç†</h3>
    <p id="modalTableName" style="text-align:center; font-weight:bold; margin-bottom:10px;"></p>

    <div class="item-list" id="orderItemsList"></div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
      <span>å€¤å¼•ã:</span>
      <input type="number" id="discountInput" value="0" style="width:120px;" oninput="updateTotal()">
    </div>

    <div class="price-summary">
      <div class="total-label">æœ€çµ‚ã”è«‹æ±‚é¡</div>
      <div class="total-value" id="totalDisplay">Â¥0</div>
    </div>

    <div class="payment-methods">
      <button class="method-btn" onclick="setMethod('cash', this)">ğŸ’´ ç¾é‡‘</button>
      <button class="method-btn" onclick="setMethod('emoney', this)">ğŸ’³ é›»å­</button>
      <button class="method-btn" onclick="setMethod('credit', this)">ğŸ’³ ã‚«ãƒ¼ãƒ‰</button>
    </div>

    <div id="cashArea" class="hidden" style="background:#e8f5e9; padding:10px; border-radius:8px; margin-bottom:15px;">
      <label>ãŠé ã‹ã‚Š</label>
      <input type="number" id="cashReceived" placeholder="0" oninput="calcChange()">
      <div style="text-align:right; margin-top:5px; font-weight:bold;">
        ãŠã¤ã‚Š: <span id="changeDisplay" style="color:#d32f2f;">Â¥0</span>
      </div>
    </div>

    <button id="executeBtn" class="btn btn-success" disabled onclick="completeFlow()">ä¼šè¨ˆã‚’å®Œäº†ã—ã¦å‰Šé™¤</button>
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
      <button class="btn btn-warning" onclick="statusUpdate('cancelledAt')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-danger" onclick="statusUpdate('deleted')">æ³¨æ–‡å‰Šé™¤</button>
    </div>
    <button class="btn btn-secondary" onclick="closePayment()">æˆ»ã‚‹</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, doc, updateDoc, setDoc, getDoc, serverTimestamp, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
    authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
    projectId: "takoyaki-order-system-bacd7",
    storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
    messagingSenderId: "104494752890",
    appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let currentStoreId, storesData = {}, activeOrders = [], currentTableName, selectedMethod = '', rawTotal = 0;

  // --- åˆæœŸèª­è¾¼ ---
  window.onload = async () => {
    const q = query(collection(db, 'stores'), where('isActive', '==', true));
    const snap = await getDocs(q);
    const sel = document.getElementById('storeSelect');
    snap.forEach(d => {
      storesData[d.id] = { name: d.data().storeName, pass: String(d.data().storePassword) };
      sel.innerHTML += `<option value="${d.id}">${d.data().storeName}</option>`;
    });
    if(sessionStorage.getItem('handyStoreId')) {
      currentStoreId = sessionStorage.getItem('handyStoreId');
      showTables();
    }
  };

  // --- ãƒ­ã‚°ã‚¤ãƒ³/ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ---
  window.handleLogin = () => {
    const id = document.getElementById('storeSelect').value;
    if(document.getElementById('passwordInput').value === storesData[id].pass) {
      currentStoreId = id;
      sessionStorage.setItem('handyStoreId', id);
      showTables();
    } else alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
  };
  window.handleLogout = () => { sessionStorage.clear(); location.reload(); };

  // --- ãƒ†ãƒ¼ãƒ–ãƒ«ç›£è¦– ---
  function showTables() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('tablesScreen').classList.remove('hidden');
    document.getElementById('displayStoreName').textContent = storesData[currentStoreId].name;
    
    // æ³¨æ–‡çŠ¶æ³ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
    onSnapshot(collection(db, 'stores', currentStoreId, 'orders'), async (snap) => {
      const occupied = new Set();
      snap.forEach(d => {
        const data = d.data();
        if(!data.paidAt && !data.deleted && !data.cancelledAt) occupied.add(String(data.tableNumber));
      });
      
      const tSnap = await getDocs(collection(db, 'stores', currentStoreId, 'tables'));
      const grid = document.getElementById('tablesGrid');
      grid.innerHTML = '';
      tSnap.docs.map(d => d.data()).sort((a,b)=>(a.order||0)-(b.order||0)).forEach(t => {
        const isActive = occupied.has(t.name);
        grid.innerHTML += `
          <div class="table-card ${isActive ? 'active' : ''}" onclick="openPayment('${t.name}')">
            <div class="table-name">${t.name}</div>
            <div class="status-badge">${isActive ? 'â— æ³¨æ–‡ã‚ã‚Š' : 'ç©ºå¸­'}</div>
          </div>`;
      });
    });
  }

  // --- ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«å±•é–‹ ---
  window.openPayment = async (tName) => {
    currentTableName = tName;
    const q = query(collection(db, 'stores', currentStoreId, 'orders'), 
                where('tableNumber', '==', String(tName)));
    const snap = await getDocs(q);
    activeOrders = snap.docs.map(d => ({id: d.id, ...d.data()}))
                      .filter(o => !o.paidAt && !o.deleted && !o.cancelledAt);
    
    if(!activeOrders.length) return;
    
    document.getElementById('modalTableName').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ«: ${tName}`;
    renderItems();
    document.getElementById('paymentModal').classList.remove('hidden');
  };

  // æ˜ç´°è¡¨ç¤º & é‡‘é¡å¤‰æ›´ç§»æ¤
  function renderItems() {
    const list = document.getElementById('orderItemsList');
    list.innerHTML = '';
    rawTotal = 0;
    activeOrders.forEach((order, oIdx) => {
      (order.items||[]).forEach((item, iIdx) => {
        const price = (item.price + (item.toppingPrice||0)) * item.quantity;
        rawTotal += price;
        const row = document.createElement('div');
        row.className = 'item-row';
        row.innerHTML = `
          <span class="clickable-item" onclick="editItemPrice(${oIdx}, ${iIdx})">${item.name} x${item.quantity}</span>
          <span>Â¥${price.toLocaleString()}</span>`;
        list.appendChild(row);
      });
    });
    updateTotal();
  }

  // é‡‘é¡å¤‰æ›´æ©Ÿèƒ½ (POSç§»æ¤)
  window.editItemPrice = async (oIdx, iIdx) => {
    const item = activeOrders[oIdx].items[iIdx];
    const newPrice = prompt(`${item.name} ã®æ–°ã—ã„å˜ä¾¡ã‚’å…¥åŠ›`, item.price);
    if(newPrice !== null && !isNaN(newPrice)) {
      item.price = parseInt(newPrice);
      const newOrderTotal = activeOrders[oIdx].items.reduce((s, i) => s + ((i.price + (i.toppingPrice||0)) * i.quantity), 0);
      await updateDoc(doc(db, 'stores', currentStoreId, 'orders', activeOrders[oIdx].id), {
        items: activeOrders[oIdx].items,
        totalAmount: newOrderTotal
      });
      renderItems();
    }
  };

  window.updateTotal = () => {
    const discount = parseInt(document.getElementById('discountInput').value) || 0;
    const final = Math.max(0, rawTotal - discount);
    document.getElementById('totalDisplay').textContent = `Â¥${final.toLocaleString()}`;
    document.getElementById('totalDisplay').dataset.value = final;
    if(selectedMethod === 'cash') calcChange();
  };

  window.setMethod = (m, btn) => {
    selectedMethod = m;
    document.querySelectorAll('.method-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    document.getElementById('cashArea').classList.toggle('hidden', m !== 'cash');
    document.getElementById('executeBtn').disabled = (m === 'cash');
  };

  window.calcChange = () => {
    const total = parseInt(document.getElementById('totalDisplay').dataset.value);
    const rec = parseInt(document.getElementById('cashReceived').value) || 0;
    const diff = rec - total;
    document.getElementById('changeDisplay').textContent = `Â¥${diff.toLocaleString()}`;
    document.getElementById('executeBtn').disabled = diff < 0;
  };

  // --- ã€é‡è¦ã€‘ä¼šè¨ˆå®Œäº†ãƒ•ãƒ­ãƒ¼ï¼ˆå£²ä¸Šåæ˜  ï¼‹ å‰Šé™¤é€£å‹•ï¼‰ ---
  window.completeFlow = async () => {
    if(!confirm('ä¼šè¨ˆã‚’ç¢ºå®šã—ã€ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;

    try {
      const finalAmt = parseInt(document.getElementById('totalDisplay').dataset.value);
      const now = new Date();
      
      // å–¶æ¥­æ—¥è¨ˆç®— (POSã¨åŒä¸€: 3æ™‚åŒºåˆ‡ã‚Š)
      const bizDate = new Date(now);
      if(bizDate.getHours() < 3) bizDate.setDate(bizDate.getDate() - 1);
      const dateStr = `${bizDate.getFullYear()}-${String(bizDate.getMonth()+1).padStart(2,'0')}-${String(bizDate.getDate()).padStart(2,'0')}`;

      // 1. å£²ä¸Šé›†è¨ˆè¨ˆç®—
      let t8 = 0, t10 = 0, tItems = 0;
      activeOrders.forEach(o => {
        (o.items||[]).forEach(i => {
          const p = (i.price + (i.toppingPrice||0)) * i.quantity;
          if(i.taxRate === 8 || currentTableName === 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ') t8 += p;
          else t10 += p;
          tItems += i.quantity;
        });
      });

      // 2. POSå£²ä¸Šãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–° (dailySales)
      const salesRef = doc(db, 'stores', currentStoreId, 'dailySales', dateStr);
      const salesDoc = await getDoc(salesRef);
      const updates = {
        totalSales: increment(finalAmt),
        customerCount: increment(1), // å®¢æ•°åæ˜ 
        totalItems: increment(tItems),
        tax8Total: increment(t8),
        tax10Total: increment(t10),
        updatedAt: serverTimestamp()
      };
      if(selectedMethod === 'cash') updates.cashSales = increment(finalAmt);
      if(selectedMethod === 'emoney') updates.emoneSales = increment(finalAmt);
      if(selectedMethod === 'credit') updates.creditSales = increment(finalAmt);

      if(salesDoc.exists()) await updateDoc(salesRef, updates);
      else await setDoc(salesRef, { date: dateStr, ...updates, createdAt: serverTimestamp() });

      // 3. æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ã€Œå®Œäº† ï¼‹ å‰Šé™¤ã€ã«æ›´æ–° (POSå´ã‹ã‚‰ã‚‚æ¶ˆãˆã‚‹)
      for(const o of activeOrders) {
        await updateDoc(doc(db, 'stores', currentStoreId, 'orders', o.id), {
          paidAt: serverTimestamp(),
          paymentMethod: selectedMethod,
          status: 'paid',
          deleted: true // å®Œäº†ã¨åŒæ™‚ã«å‰Šé™¤
        });
      }

      // 4. å®Œäº†é€šçŸ¥ â†’ é–‰ã˜ã¦æˆ»ã‚‹
      alert('ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚\nå£²ä¸Šã«è¨ˆä¸Šã—ã€æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚');
      closePayment();

    } catch(e) {
      alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
    }
  };

  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³
  window.statusUpdate = async (field) => {
    if(!confirm('å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) return;
    for(const o of activeOrders) {
      const up = {};
      if(field === 'deleted') up.deleted = true;
      else up[field] = serverTimestamp();
      await updateDoc(doc(db, 'stores', currentStoreId, 'orders', o.id), up);
    }
    closePayment();
  };

  window.closePayment = () => {
    document.getElementById('paymentModal').classList.add('hidden');
    // å…¥åŠ›ãƒªã‚»ãƒƒãƒˆ
    document.getElementById('discountInput').value = 0;
    document.getElementById('cashReceived').value = '';
    selectedMethod = '';
    document.querySelectorAll('.method-btn').forEach(b => b.classList.remove('selected'));
  };

</script>
</body>
</html>