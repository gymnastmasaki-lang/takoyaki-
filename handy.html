<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ハンディシステム</title>
  <style>
    /* 元のhandy.htmlのスタイルを完全維持 */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 600px; margin: 0 auto; }
    .login-screen { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .login-screen h1 { text-align: center; color: #667eea; margin-bottom: 30px; font-size: 28px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; color: #666; font-size: 14px; }
    .form-group select, .form-group input { width: 100%; padding: 15px; border: 2px solid #eee; border-radius: 12px; font-size: 16px; outline: none; transition: border-color 0.3s; }
    .form-group select:focus, .form-group input:focus { border-color: #667eea; }
    .login-btn { width: 100%; padding: 15px; background: #667eea; color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(102,126,234,0.4); }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; color: white; }
    .store-info { display: flex; align-items: center; gap: 10px; }
    .logout-btn { background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 14px; cursor: pointer; }
    .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; }
    .table-card { background: white; border-radius: 20px; padding: 20px; text-align: center; cursor: pointer; box-shadow: 0 10px 20px rgba(0,0,0,0.1); border: 3px solid transparent; transition: transform 0.2s, border-color 0.2s; }
    .table-card.occupied { border-color: #FF9800; background: #FFF3E0; }
    .table-card h3 { font-size: 20px; margin-bottom: 5px; color: #333; }
    .table-card .status { font-size: 12px; color: #999; }
    .table-card.occupied .status { color: #FF9800; font-weight: bold; }
    .order-screen { display: none; }
    .category-tabs { display: flex; gap: 10px; overflow-x: auto; margin-bottom: 20px; padding-bottom: 5px; }
    .category-tab { padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border-radius: 30px; cursor: pointer; white-space: nowrap; font-weight: bold; }
    .category-tab.active { background: white; color: #667eea; }
    .menu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-bottom: 100px; }
    .menu-item { background: white; border-radius: 20px; padding: 15px; text-align: center; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .menu-item .item-name { font-weight: bold; margin-bottom: 5px; color: #333; }
    .menu-item .item-price { color: #667eea; font-weight: bold; }
    .cart-bar { position: fixed; bottom: 20px; left: 20px; right: 20px; background: white; border-radius: 20px; padding: 15px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 100; display: none; }
    .cart-info .count { font-weight: bold; color: #667eea; margin-right: 10px; }
    .cart-info .total { font-weight: bold; font-size: 18px; }
    .order-confirm-btn { background: #4CAF50; color: white; border: none; padding: 12px 25px; border-radius: 12px; font-weight: bold; cursor: pointer; }
    
    /* 会計モーダル */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .payment-modal { background: white; border-radius: 25px; width: 100%; max-width: 500px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
    .payment-modal h2 { text-align: center; margin-bottom: 20px; color: #333; }
    .order-summary { background: #f9f9f9; border-radius: 15px; padding: 20px; margin-bottom: 20px; max-height: 200px; overflow-y: auto; }
    .summary-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
    .summary-total { border-top: 2px solid #eee; margin-top: 10px; padding-top: 10px; font-weight: bold; font-size: 20px; color: #d32f2f; display: flex; justify-content: space-between; }
    .payment-methods { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .method-btn { padding: 15px 5px; border: 2px solid #eee; border-radius: 15px; cursor: pointer; text-align: center; font-weight: bold; transition: all 0.2s; background: white; }
    .method-btn.active { border-color: #667eea; background: #f0f4ff; color: #667eea; }
    .cash-input-area { margin-bottom: 20px; }
    .cash-input-area input { width: 100%; padding: 15px; font-size: 24px; text-align: right; border: 2px solid #eee; border-radius: 15px; margin-top: 5px; }
    .change-display { text-align: right; font-size: 18px; font-weight: bold; margin-top: 10px; color: #4CAF50; }
    .payment-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .payment-btn { padding: 15px; border-radius: 15px; border: none; font-weight: bold; font-size: 16px; cursor: pointer; }
    .btn-cancel { background: #eee; color: #666; }
    .btn-execute { background: #4CAF50; color: white; grid-column: span 1; }
    .btn-execute:disabled { background: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>
  <div class="container">
    <div id="loginScreen" class="login-screen">
      <h1>ハンディシステム</h1>
      <div class="form-group">
        <label>店舗を選択</label>
        <select id="storeSelect"></select>
      </div>
      <div class="form-group">
        <label>パスワード</label>
        <input type="password" id="passwordInput" placeholder="店舗パスワードを入力">
      </div>
      <button class="login-btn" onclick="handleLogin()">ログイン</button>
    </div>

    <div id="mainScreen" style="display: none;">
      <div class="header">
        <div class="store-info">
          <span id="currentStoreName" style="font-weight: bold; font-size: 18px;"></span>
        </div>
        <button class="logout-btn" onclick="handleLogout()">ログアウト</button>
      </div>
      <div id="tablesGrid" class="tables-grid"></div>
    </div>

    <div id="orderScreen" class="order-screen">
      <div class="header">
        <div style="display: flex; align-items: center; gap: 15px;">
          <button style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;" onclick="backToTables()">←</button>
          <h2 id="currentTableName"></h2>
        </div>
        <button class="logout-btn" style="background: #FF9800;" onclick="openPaymentModal()">会計・管理</button>
      </div>
      <div id="categoryTabs" class="category-tabs"></div>
      <div id="menuGrid" class="menu-grid"></div>
    </div>
  </div>

  <div id="cartBar" class="cart-bar">
    <div class="cart-info">
      <span id="cartCount" class="count">0点</span>
      <span id="cartTotal" class="total">¥0</span>
    </div>
    <button class="order-confirm-btn" onclick="sendOrder()">注文を送信</button>
  </div>

  <div id="paymentModal" class="modal-overlay">
    <div class="payment-modal">
      <h2 id="modalTitle">会計管理</h2>
      <div class="order-summary" id="orderSummary"></div>
      <div style="margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;">
        <span>値引き:</span>
        <input type="number" id="discountInput" style="width: 100px; padding: 5px; text-align: right;" value="0" oninput="updatePaymentUI()">
      </div>
      <div class="summary-total">
        <span>合計</span>
        <span id="paymentTotalAmount">¥0</span>
      </div>
      <div class="payment-methods">
        <div class="method-btn active" id="method-cash" onclick="setPaymentMethod('cash')">現金</div>
        <div class="method-btn" id="method-credit" onclick="setPaymentMethod('credit')">カード</div>
        <div class="method-btn" id="method-emoney" onclick="setPaymentMethod('emoney')">電子マネー</div>
      </div>
      <div id="cashInputArea" class="cash-input-area">
        <label>お預かり</label>
        <input type="number" id="cashReceived" placeholder="金額を入力" oninput="updatePaymentUI()">
        <div id="changeAmount" class="change-display">おつり: ¥0</div>
      </div>
      <div class="payment-actions">
        <button class="payment-btn btn-cancel" onclick="closePaymentModal()">戻る</button>
        <button class="payment-btn btn-execute" id="executePaymentBtn" onclick="completeCheckout()">会計完了</button>
      </div>
      <button class="payment-btn btn-cancel" style="width: 100%; margin-top: 10px; background: #f44336; color: white;" onclick="deleteOrdersForTable()">注文を完全に削除</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc, setDoc, getDoc, onSnapshot, serverTimestamp, increment, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db; window.doc = doc; window.updateDoc = updateDoc; window.setDoc = setDoc; window.getDoc = getDoc; window.Timestamp = Timestamp; window.increment = increment; window.serverTimestamp = serverTimestamp;
    window.firebaseReady = true;
  </script>

  <script>
    // --- 状態管理 ---
    let currentStoreId = null;
    let currentTable = null;
    let cart = [];
    let storesData = {};
    let currentOrders = [];
    let selectedMethod = 'cash';

    // --- 【注文機能】元のコードを完全維持 ---
    async function loadStoreList() {
      const q = query(collection(window.db, "stores"), where("isActive", "==", true));
      const snap = await getDocs(q);
      const select = document.getElementById('storeSelect');
      snap.forEach(doc => {
        storesData[doc.id] = { name: doc.data().storeName, password: doc.data().storePassword };
        const opt = document.createElement('option');
        opt.value = doc.id; opt.textContent = doc.data().storeName;
        select.appendChild(opt);
      });
    }

    window.handleLogin = async function() {
      const storeId = document.getElementById('storeSelect').value;
      const pass = document.getElementById('passwordInput').value;
      if (storesData[storeId] && String(storesData[storeId].password) === pass) {
        currentStoreId = storeId;
        sessionStorage.setItem('handyStoreId', storeId);
        sessionStorage.setItem('handyStoreName', storesData[storeId].name);
        loadTables();
      } else { alert('パスワードが正しくありません'); }
    };

    async function loadTables() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainScreen').style.display = 'block';
      document.getElementById('currentStoreName').textContent = sessionStorage.getItem('handyStoreName');
      
      const q = query(collection(window.db, "stores", currentStoreId, "tables"));
      const snap = await getDocs(q);
      const grid = document.getElementById('tablesGrid');
      grid.innerHTML = '';
      
      onSnapshot(collection(window.db, "stores", currentStoreId, "orders"), (orderSnap) => {
        const activeTables = new Set();
        orderSnap.forEach(doc => {
          const data = doc.data();
          if (!data.paidAt && !data.deleted && !data.cancelledAt) activeTables.add(String(data.tableNumber));
        });
        
        grid.innerHTML = '';
        snap.docs.map(d => d.data()).sort((a,b) => (a.order||0)-(b.order||0)).forEach(table => {
          const isOccupied = activeTables.has(String(table.name));
          const card = document.createElement('div');
          card.className = `table-card ${isOccupied ? 'occupied' : ''}`;
          card.onclick = () => openOrderScreen(table.name);
          card.innerHTML = `<h3>${table.name}</h3><div class="status">${isOccupied ? '注文あり' : '空席'}</div>`;
          grid.appendChild(card);
        });
      });
    }

    window.openOrderScreen = async function(tableName) {
      currentTable = tableName;
      document.getElementById('mainScreen').style.display = 'none';
      document.getElementById('orderScreen').style.display = 'block';
      document.getElementById('currentTableName').textContent = tableName;
      cart = []; updateCartUI(); loadMenu();
    };

    async function loadMenu() {
      const q = query(collection(window.db, "stores", currentStoreId, "menu"), where("available", "==", true));
      const snap = await getDocs(q);
      const grid = document.getElementById('menuGrid');
      grid.innerHTML = '';
      snap.forEach(doc => {
        const item = doc.data();
        const card = document.createElement('div');
        card.className = 'menu-item';
        card.onclick = () => addToCart(item);
        card.innerHTML = `<div class="item-name">${item.name}</div><div class="item-price">¥${item.price.toLocaleString()}</div>`;
        grid.appendChild(card);
      });
    }

    function addToCart(item) {
      const existing = cart.find(i => i.name === item.name);
      if (existing) existing.quantity++;
      else cart.push({ ...item, quantity: 1 });
      updateCartUI();
    }

    function updateCartUI() {
      const bar = document.getElementById('cartBar');
      if (cart.length === 0) { bar.style.display = 'none'; return; }
      bar.style.display = 'flex';
      const count = cart.reduce((sum, i) => sum + i.quantity, 0);
      const total = cart.reduce((sum, i) => sum + (i.price * i.quantity), 0);
      document.getElementById('cartCount').textContent = `${count}点`;
      document.getElementById('cartTotal').textContent = `¥${total.toLocaleString()}`;
    }

    window.sendOrder = async function() {
      try {
        const orderData = {
          tableNumber: currentTable,
          items: cart,
          totalAmount: cart.reduce((sum, i) => sum + (i.price * i.quantity), 0),
          createdAt: window.serverTimestamp(),
          status: 'pending'
        };
        await window.setDoc(window.doc(collection(window.db, 'stores', currentStoreId, 'orders')), orderData);
        alert('注文を送信しました');
        cart = []; updateCartUI();
      } catch (e) { console.error(e); }
    };

    window.backToTables = () => {
      document.getElementById('orderScreen').style.display = 'none';
      document.getElementById('mainScreen').style.display = 'block';
      cart = []; updateCartUI();
    };

    // --- 【会計・管理ロジック】pos.html から完全移植 ---
    window.openPaymentModal = async function() {
      const q = query(collection(window.db, 'stores', currentStoreId, 'orders'), where('tableNumber', '==', currentTable));
      const snap = await getDocs(q);
      currentOrders = snap.docs.map(d => ({ id: d.id, ...d.data() })).filter(o => !o.paidAt && !o.deleted && !o.cancelledAt);
      
      if (currentOrders.length === 0) { alert('未会計の注文はありません'); return; }
      
      const summary = document.getElementById('orderSummary');
      summary.innerHTML = '';
      let total = 0;
      currentOrders.forEach(order => {
        order.items.forEach(item => {
          const subtotal = item.price * (item.quantity || 1);
          total += subtotal;
          summary.innerHTML += `<div class="summary-item"><span>${item.name} x${item.quantity || 1}</span><span>¥${subtotal.toLocaleString()}</span></div>`;
        });
      });
      
      document.getElementById('paymentTotalAmount').dataset.rawTotal = total;
      updatePaymentUI();
      document.getElementById('paymentModal').style.display = 'flex';
    };

    window.setPaymentMethod = function(method) {
      selectedMethod = method;
      document.querySelectorAll('.method-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`method-${method}`).classList.add('active');
      document.getElementById('cashInputArea').style.display = (method === 'cash') ? 'block' : 'none';
      updatePaymentUI();
    };

    window.updatePaymentUI = function() {
      const rawTotal = parseInt(document.getElementById('paymentTotalAmount').dataset.rawTotal);
      const discount = parseInt(document.getElementById('discountInput').value) || 0;
      const finalTotal = Math.max(0, rawTotal - discount);
      document.getElementById('paymentTotalAmount').textContent = `¥${finalTotal.toLocaleString()}`;
      
      if (selectedMethod === 'cash') {
        const received = parseInt(document.getElementById('cashReceived').value) || 0;
        const change = received - finalTotal;
        document.getElementById('changeAmount').textContent = `おつり: ¥${Math.max(0, change).toLocaleString()}`;
        document.getElementById('executePaymentBtn').disabled = (received < finalTotal);
      } else {
        document.getElementById('executePaymentBtn').disabled = false;
      }
    };

    window.completeCheckout = async function() {
      try {
        const finalAmount = parseInt(document.getElementById('paymentTotalAmount').textContent.replace(/[¥,]/g, ''));
        const now = new Date();
        const bizDate = new Date(now); if (bizDate.getHours() < 3) bizDate.setDate(bizDate.getDate() - 1);
        const dateStr = `${bizDate.getFullYear()}-${String(bizDate.getMonth() + 1).padStart(2, '0')}-${String(bizDate.getDate()).padStart(2, '0')}`;

        // 売上集計 (pos.htmlの移植)
        let tax8Total = 0, tax10Total = 0, totalItems = 0;
        currentOrders.forEach(o => o.items.forEach(i => {
          const p = i.price * (i.quantity || 1);
          if (i.taxRate === 8) tax8Total += p; else tax10Total += p;
          totalItems += (i.quantity || 1);
        }));

        const salesRef = window.doc(window.db, 'stores', currentStoreId, 'dailySales', dateStr);
        const updateData = {
          totalSales: window.increment(finalAmount),
          customerCount: window.increment(1),
          totalItems: window.increment(totalItems),
          tax8Total: window.increment(tax8Total),
          tax10Total: window.increment(tax10Total),
          updatedAt: window.serverTimestamp()
        };
        if (selectedMethod === 'cash') updateData.cashSales = window.increment(finalAmount);
        else if (selectedMethod === 'credit') updateData.creditSales = window.increment(finalAmount);
        else updateData.emoneySales = window.increment(finalAmount);

        const sSnap = await window.getDoc(salesRef);
        if (sSnap.exists()) await window.updateDoc(salesRef, updateData);
        else await window.setDoc(salesRef, { date: dateStr, ...updateData, createdAt: window.serverTimestamp() });

        // 注文データ更新（削除フラグを立ててPOS画面からも消す）
        for (const order of currentOrders) {
          await window.updateDoc(window.doc(window.db, 'stores', currentStoreId, 'orders', order.id), {
            paidAt: window.serverTimestamp(),
            paymentMethod: selectedMethod,
            deleted: true
          });
        }

        alert('会計を完了しました。売上が記録され、注文データが削除されました。');
        closePaymentModal();
        backToTables();
      } catch (e) { console.error(e); alert('会計処理中にエラーが発生しました'); }
    };

    window.deleteOrdersForTable = async function() {
      if (!confirm('売上に計上せず、このテーブルの注文を完全に削除しますか？')) return;
      for (const order of currentOrders) {
        await window.updateDoc(window.doc(window.db, 'stores', currentStoreId, 'orders', order.id), { deleted: true });
      }
      alert('削除しました');
      closePaymentModal();
      backToTables();
    };

    window.closePaymentModal = () => { document.getElementById('paymentModal').style.display = 'none'; };

    window.handleLogout = () => { sessionStorage.clear(); location.reload(); };

    window.addEventListener('DOMContentLoaded', async () => {
      while (!window.firebaseReady) await new Promise(r => setTimeout(r, 100));
      await loadStoreList();
      if (sessionStorage.getItem('handyStoreId')) {
        currentStoreId = sessionStorage.getItem('handyStoreId');
        loadTables();
      }
    });
  </script>
</body>
</html>