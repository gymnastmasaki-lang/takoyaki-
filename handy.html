<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </title>
  
  <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <!-- QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- HTML to Canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ç”¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆãƒ­ãƒ¼ã‚«ãƒ«å®Ÿè£…ï¼‰ -->
  <script>
    // StarWebPrintäº’æ›ã®ãƒ“ãƒ«ãƒ€ãƒ¼ã‚¯ãƒ©ã‚¹ï¼ˆç°¡æ˜“ç‰ˆï¼‰
    class StarWebPrintBuilder {
      constructor() {
        this.commands = [];
      }
      
      createInitializationElement() {
        this.commands.push('\x1b\x40'); // åˆæœŸåŒ–
        return this;
      }
      
      createAlignmentElement(options) {
        const alignMap = { left: '\x1b\x61\x00', center: '\x1b\x61\x01', right: '\x1b\x61\x02' };
        this.commands.push(alignMap[options.position] || alignMap.left);
        return this;
      }
      
      createTextElement(options) {
        let cmd = '';
        if (options.emphasis) cmd += '\x1b\x45\x01'; // å¼·èª¿ON
        if (options.width === 2 && options.height === 2) cmd += '\x1d\x21\x11'; // 2å€
        else if (options.width === 2) cmd += '\x1d\x21\x10'; // å¹…2å€
        else if (options.height === 2) cmd += '\x1d\x21\x01'; // é«˜ã•2å€
        else cmd += '\x1d\x21\x00'; // é€šå¸¸
        
        if (options.invert) cmd += '\x1d\x42\x01'; // åè»¢ON
        if (options.data) cmd += options.data;
        if (options.invert) cmd += '\x1d\x42\x00'; // åè»¢OFF
        if (options.emphasis === false) cmd += '\x1b\x45\x00'; // å¼·èª¿OFF
        
        this.commands.push(cmd);
        return this;
      }
      
      createRuledLineElement(options) {
        const lines = { thin: '--------------------------------\n', medium: '================================\n', thick: '################################\n' };
        this.commands.push(lines[options.thickness] || lines.thin);
        return this;
      }
      
      createCutPaperElement(options) {
        if (options.feed) this.commands.push('\n\n\n');
        this.commands.push('\x1d\x56\x00'); // ã‚«ãƒƒãƒˆ
        return this;
      }
      
      createPeripheralElement(options) {
        return this; // ãƒ–ã‚¶ãƒ¼ç­‰ã¯çœç•¥
      }
      
      toString() {
        return this.commands.join('');
      }
    }
    
    // StarWebPrintTraderäº’æ›ã‚¯ãƒ©ã‚¹
    class StarWebPrintTrader {
      constructor(options) {
        this.url = options.url;
        this.onReceive = null;
        this.onError = null;
      }
      
      async sendMessage(request) {
        try {
          const response = await fetch(this.url, {
            method: 'POST',
            headers: { 'Content-Type': 'text/plain; charset=utf-8' },
            body: request
          });
          
          if (response.ok && this.onReceive) {
            this.onReceive({ status: 'success' });
          } else if (this.onError) {
            this.onError({ status: response.status + ' ' + response.statusText });
          }
        } catch (error) {
          if (this.onError) {
            this.onError({ status: error.message });
          }
        }
      }
    }
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.StarWebPrintBuilder = StarWebPrintBuilder;
    window.StarWebPrintTrader = StarWebPrintTrader;
  </script>
  
  <!-- ãã®ä»–ã®ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <!-- ã‚¿ãƒƒãƒ—éŸ³ -->
  <script>
    // AudioContextã‚’ä½¿ç”¨ã—ãŸã‚¿ãƒƒãƒ—éŸ³ç”Ÿæˆ
    let audioContext = null;
    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }
    function playTapSound() {
      initAudio();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    .login-screen {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .login-screen h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 28px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .login-btn:active {
      transform: scale(0.98);
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ */
    .tables-screen {
      display: none;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .header h2 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .header .store-info {
      color: #666;
      font-size: 14px;
    }
    
    .header-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .logout-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .sales-btn {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .settings-btn {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .instant-checkout-card {
      grid-column: span 2;
      padding: 20px;
    }
    
    .table-card {
      background: white;
      border-radius: 15px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    
    .table-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .table-card:active {
      transform: translateY(-2px);
    }
    
    .table-card.has-pending-orders {
      background: linear-gradient(135deg, #fff4e6 0%, #ffe0b2 100%);
      border: 2px solid #ff9800;
    }
    
    .table-card.has-pending-orders .table-name {
      color: #f57c00;
    }
    
    .table-card.has-pending-orders .pending-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff9800;
      color: white;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
    }
    
    .status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
    }
    
    .unpaid-badge {
      background: #f57c00;
      color: white;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }
    
    .table-card .table-name {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
      word-break: break-all;
      line-height: 1.3;
    }
    
    .table-card .table-status {
      font-size: 12px;
      color: #999;
    }
    
    .checkout-btn {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .checkout-btn:active {
      transform: scale(0.95);
    }
    
    /* ä¿®æ­£ç®‡æ‰€: hiddenã‚¯ãƒ©ã‚¹ã®å®šç¾©ã‚’æ˜ç¢ºã«ã™ã‚‹ */
    .hidden {
      display: none !important;
    }
    
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }
    
    /* å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨CSS */
    .sales-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    
    .sales-modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    .sales-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .sales-modal-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    
    .sales-modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .sales-modal-close:hover {
      color: #333;
    }
    
    .custom-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10002;
      align-items: center;
      justify-content: center;
    }
    
    .custom-modal-box {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .modal-icon {
      font-size: 64px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 15px;
      color: #333;
    }
    
    .modal-message {
      text-align: center;
      font-size: 16px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.6;
      white-space: pre-line;
    }
    
    .modal-buttons {
      display: flex;
      gap: 15px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 18px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .modal-btn:active {
      transform: scale(0.95);
    }
    
    .modal-btn-cancel {
      background: #e0e0e0;
      color: #333;
    }
    
    .modal-btn-cancel:hover {
      background: #d0d0d0;
    }
    
    .modal-btn-danger {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
    }
    
    .modal-btn-success {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    /* ä¿®æ­£ç®‡æ‰€: .modal-overlayã®displayè¨­å®šã‚’ä¿®æ­£ */
    .modal-overlay {
      display: flex; /* noneã‹ã‚‰å¤‰æ›´ã€‚è¡¨ç¤ºéè¡¨ç¤ºã¯.hiddenã‚¯ãƒ©ã‚¹ã§åˆ¶å¾¡ã™ã‚‹ */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10001;
      align-items: center;
      justify-content: center;
    }
    
    .modal {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal h3 {
      margin: 0 0 20px 0;
      color: #333;
      font-size: 24px;
      text-align: center;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .payment-methods {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .payment-method-btn {
      padding: 15px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .payment-method-btn:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    
    .payment-method-btn.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .cash-input-section {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    
    .cash-input-section label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    
    .cash-input-section input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 18px;
      text-align: center;
    }
    
    .change-display {
      margin-top: 15px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
    }
    
    .change-amount {
      color: #4CAF50;
      font-size: 20px;
    }
    
    .order-selection-btn {
      width: 100%;
      padding: 20px;
      margin-bottom: 15px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
    }
    
    .order-selection-btn:hover {
      border-color: #667eea;
      background: #f8f9ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .order-selection-btn:active {
      transform: translateY(0);
    }
    
    /* ğŸ†• ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10001;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
    }
    
    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 20px;
    }
    
    .modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 28px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.2s;
      line-height: 1;
    }
    
    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .modal-footer {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    /* ğŸ†• æ©Ÿèƒ½ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .header-buttons {
      position: relative;
      display: flex;
      gap: 10px;
    }
    
    .functions-submenu {
      position: absolute;
      top: 45px;
      left: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      margin-top: 8px;
      min-width: 220px;
      z-index: 1000;
      overflow: hidden;
      border: 1px solid rgba(102, 126, 234, 0.1);
    }
    
    .functions-submenu button {
      width: 100%;
      padding: 14px 18px;
      background: white;
      border: none;
      border-left: 3px solid transparent;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .functions-submenu button::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: transform 0.2s ease;
    }
    
    .functions-submenu button:first-child {
      border-radius: 12px 12px 0 0;
    }
    
    .functions-submenu button:last-child {
      border-radius: 0 0 12px 12px;
    }
    
    .functions-submenu button:hover {
      background: linear-gradient(90deg, rgba(102, 126, 234, 0.08) 0%, rgba(255, 255, 255, 0) 100%);
      border-left-color: #667eea;
      padding-left: 22px;
    }
    
    .functions-submenu button:hover::before {
      transform: scale(1.3);
    }
    
    .functions-submenu button:active {
      background: linear-gradient(90deg, rgba(102, 126, 234, 0.12) 0%, rgba(255, 255, 255, 0) 100%);
      transform: scale(0.98);
    }
    
    /* ğŸ†• POSãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .pos-iframe-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }
    
    .pos-iframe-modal.active {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .pos-iframe-container {
      width: 95%;
      height: 95%;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
    }
    
    .pos-iframe-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .pos-iframe-header h3 {
      margin: 0;
      font-size: 18px;
    }
    
    .pos-iframe-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .pos-iframe-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .pos-iframe-content {
      flex: 1;
      width: 100%;
      border: none;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
  
  <!-- ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆ/ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚° -->
  <script>
    // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºé–¢æ•°
    window.showCustomAlert = function(message, title = 'ãŠçŸ¥ã‚‰ã›') {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0,0,0,0.7);
        backdrop-filter: blur(8px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.3s ease-out;
        padding: 20px;
      `;
      
      const alertBox = document.createElement('div');
      alertBox.style.cssText = `
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 24px;
        padding: 40px;
        max-width: 450px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0,0,0,0.4);
        border: 2px solid rgba(255,255,255,0.2);
        animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      `;
      
      alertBox.innerHTML = `
        <h3 style="color: white; font-size: 24px; font-weight: bold; margin-bottom: 16px; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
          ${title}
        </h3>
        <p style="color: rgba(255,255,255,0.95); font-size: 16px; margin-bottom: 30px; text-align: center; line-height: 1.7; white-space: pre-line;">
          ${message}
        </p>
        <button style="width: 100%; padding: 14px; background: white; color: #667eea; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s;">
          OK
        </button>
      `;
      
      overlay.appendChild(alertBox);
      document.body.appendChild(overlay);
      
      const closeAlert = () => {
        overlay.style.animation = 'fadeOut 0.2s ease-out';
        setTimeout(() => overlay.remove(), 200);
      };
      
      alertBox.querySelector('button').onclick = closeAlert;
      overlay.onclick = (e) => {
        if (e.target === overlay) closeAlert();
      };
    };
    
    // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºé–¢æ•°
    window.showCustomConfirm = function(message, title = 'ç¢ºèª') {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.7);
          backdrop-filter: blur(8px);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          animation: fadeIn 0.3s ease-out;
          padding: 20px;
        `;
        
        const confirmBox = document.createElement('div');
        confirmBox.style.cssText = `
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          border-radius: 24px;
          padding: 40px;
          max-width: 450px;
          width: 90%;
          box-shadow: 0 20px 60px rgba(0,0,0,0.4);
          border: 2px solid rgba(255,255,255,0.2);
          animation: slideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        `;
        
        confirmBox.innerHTML = `
          <h3 style="color: white; font-size: 24px; font-weight: bold; margin-bottom: 16px; text-align: center; text-shadow: 0 2px 4px rgba(0,0,0,0.2);">
            ${title}
          </h3>
          <p style="color: rgba(255,255,255,0.95); font-size: 16px; margin-bottom: 30px; text-align: center; line-height: 1.7; white-space: pre-line;">
            ${message}
          </p>
          <div style="display: flex; gap: 12px;">
            <button class="cancel-btn" style="flex: 1; padding: 14px; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s;">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button class="ok-btn" style="flex: 1; padding: 14px; background: white; color: #667eea; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s;">
              OK
            </button>
          </div>
        `;
        
        overlay.appendChild(confirmBox);
        document.body.appendChild(overlay);
        
        const closeConfirm = (result) => {
          overlay.style.animation = 'fadeOut 0.2s ease-out';
          setTimeout(() => {
            overlay.remove();
            resolve(result);
          }, 200);
        };
        
        confirmBox.querySelector('.ok-btn').onclick = () => closeConfirm(true);
        confirmBox.querySelector('.cancel-btn').onclick = () => closeConfirm(false);
        overlay.onclick = (e) => {
          if (e.target === overlay) closeConfirm(false);
        };
      });
    };
  </script>
  
</head>
<body>
  <div class="container">
    <div class="login-screen" id="loginScreen">
      <h1>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </h1>
      <div id="errorMessage" class="error-message hidden"></div>
      
      <div class="form-group">
        <label for="storeSelect">åº—èˆ—ã‚’é¸æŠ</label>
        <select id="storeSelect">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="passwordInput">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      </div>
      
      <button class="login-btn" onclick="playTapSound(); handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    
    <div class="tables-screen" id="tablesScreen">
      <div class="header">
        <h2 id="storeNameDisplay">åº—èˆ—å</h2>
        <div class="store-info">ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        <div class="header-buttons">
          <button class="sales-btn" onclick="playTapSound(); toggleFunctionsMenu()">æ©Ÿèƒ½ â–¼</button>
          <button class="settings-btn" onclick="playTapSound(); window.open('https://gymnastmasaki-lang.github.io/takoyaki-/kanri.html', '_blank')">è¨­å®š</button>
          <button class="logout-btn" onclick="playTapSound(); handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        <!-- ğŸ†• æ©Ÿèƒ½ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div id="functionsSubMenu" class="functions-submenu" style="display: none;">
          <button onclick="playTapSound(); window.open('https://gymnastmasaki-lang.github.io/takoyaki-/kintai.html', '_blank')" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;">å‹¤æ€ </button>
          <button onclick="playTapSound(); showSalesModal()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;">å£²ä¸Š</button>
          <button onclick="playTapSound(); showHistoryModal()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;">å±¥æ­´</button>
          <button onclick="playTapSound(); showExpenseModal()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;">æ”¯å‡º</button>
          <button onclick="playTapSound(); openDrawerDirect()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;">ãƒ‰ãƒ­ã‚¢é–‹</button>
          <button onclick="playTapSound(); showDrawerSettings()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;">ãƒ‰ãƒ­ã‚¢è¨­å®š</button>
          <button onclick="playTapSound(); showMonthlyReportModal()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;">æœˆæ¬¡</button>
          <button onclick="playTapSound(); showBulkInventoryModal()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;">åœ¨åº«ä¸€æ‹¬è¨­å®š</button>
        </div>
      </div>
      
      <div class="tables-grid" id="tablesGrid">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>
  
  <div id="customConfirmModal" class="custom-modal-overlay">
    <div class="custom-modal-box">
      <div class="modal-icon" id="modalIcon">âš </div>
      <div class="modal-title" id="modalTitle">ç¢ºèª</div>
      <div class="modal-message" id="modalMessage">æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="playTapSound(); closeCustomModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-danger" id="modalConfirmBtn" onclick="playTapSound(); confirmCustomModal()">å®Ÿè¡Œ</button>
      </div>
    </div>
  </div>
  
  <!-- æ³¨æ–‡é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="orderSelectionModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ“‹ æ³¨æ–‡ã‚’é¸æŠ</h3>
      <p id="orderSelectionTableName" style="color: #666; margin-bottom: 20px; text-align: center; font-size: 18px; font-weight: bold;">ãƒ†ãƒ¼ãƒ–ãƒ«</p>
      <div id="ordersList" style="max-height: 60vh; overflow-y: auto;"></div>
      <div style="margin-top: 20px;">
        <button class="btn btn-secondary" style="width: 100%;" onclick="playTapSound(); closeOrderSelectionModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  
  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3> ä¼šè¨ˆå‡¦ç†</h3>
      <p id="selectedTableLabel2" style="color: #666; margin-bottom: 20px;">ãƒ†ãƒ¼ãƒ–ãƒ«</p>
      
      <div id="taxRateSection" style="margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px; border-left: 4px solid #4CAF50; max-height: 300px; overflow-y: auto;">
        <h4 style="margin: 0 0 15px 0; color: #2e7d32; font-size: 16px;">å„å•†å“ã®ç¨ç‡ã‚’é¸æŠ</h4>
        <div id="taxRateItemsList"></div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #4CAF50; font-weight: bold; font-size: 14px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>8%å¯¾è±¡:</span>
            <span id="tax8Summary" style="color: #FF9800;">Â¥0</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>10%å¯¾è±¡:</span>
            <span id="tax10Summary" style="color: #2196F3;">Â¥0</span>
          </div>
        </div>
      </div>
      
      <div class="payment-methods">
        <button class="payment-method-btn" onclick="playTapSound(); selectPaymentMethod('cash')">
          ğŸ’µ ç¾é‡‘
        </button>
        <button class="payment-method-btn" onclick="playTapSound(); selectPaymentMethod('emoney')">
           é›»å­ãƒãƒãƒ¼
        </button>
        <button class="payment-method-btn" onclick="playTapSound(); selectPaymentMethod('credit')">
          ğŸ’³ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰
        </button>
      </div>
      
      <div id="cashInputSection" class="cash-input-section hidden">
        <label>ãŠé ã‹ã‚Šé‡‘é¡</label>
        <input type="number" id="cashReceived" placeholder="0" oninput="calculateChange()">
        <div class="change-display" id="changeDisplay">
          ãŠã¤ã‚Š: <span class="change-amount" id="changeAmount">Â¥0</span>
        </div>
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 10px;">
        <label style="font-weight: bold; color: #856404;">å€¤å¼•ãé‡‘é¡</label>
        <input type="number" id="discountAmount" placeholder="0" value="0" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ffc107; border-radius: 8px; margin-top: 8px;" oninput="updatePaymentTotal()">
        <div style="text-align: center; margin-top: 10px; font-size: 18px; font-weight: bold; color: #333;">
          è«‹æ±‚é¡: <span id="finalPaymentAmount" style="color: #4CAF50;">Â¥0</span>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;" id="mainButtons">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="playTapSound(); processPayment()" id="paymentBtn" disabled> ä¼šè¨ˆ</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white;" onclick="playTapSound(); completeOrdersForTable()">âœ… å®Œäº†</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white;" onclick="playTapSound(); cancelOrdersForTable()">â¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="playTapSound(); deleteOrdersForTable()">ğŸ—‘ å‰Šé™¤</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="playTapSound(); closePaymentModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="priceChangeModal" class="modal-overlay hidden">
    <div class="modal">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 50px; margin-bottom: 10px;">ğŸ’´</div>
        <h3 style="margin: 0; font-size: 20px; color: #333;" id="priceChangeTitle">é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h3>
      </div>
      
      <div style="background: #f5f5f5; border-radius: 10px; padding: 15px; margin: 20px 0; text-align: center;">
        <div style="color: #666; margin-bottom: 10px;" id="priceChangeItemInfo"></div>
        <div style="font-size: 18px; font-weight: bold; color: #333;">
          ç¾åœ¨: <span id="priceChangeCurrentPrice"></span>
        </div>
      </div>
      
      <div style="margin: 20px 0;">
        <input type="number" id="priceChangeInput" placeholder="æ–°ã—ã„é‡‘é¡ã‚’å…¥åŠ›" style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 24px; text-align: center;">
      </div>
      
      <input type="hidden" id="priceChangeItemId">
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="playTapSound(); closePriceChangeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="playTapSound(); confirmPriceChange()">âœ“ å¤‰æ›´</button>
      </div>
    </div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, getDocs, doc, getDoc, setDoc, where, onSnapshot, updateDoc, deleteDoc, Timestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.onSnapshot = onSnapshot;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.Timestamp = Timestamp;
    window.orderBy = orderBy;
    window.limit = limit;
    
    // åº—èˆ—åˆ¥ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§ã‚’å–å¾—
    window.getStoreCollection = function(collectionName) {
      console.log('ğŸ” HANDY getStoreCollectionå‘¼ã³å‡ºã—');
      console.log('   ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å:', collectionName);
      console.log('   window.currentStoreId:', window.currentStoreId);
      console.log('   typeof:', typeof window.currentStoreId);
      
      // currentStoreIdãŒnullã¾ãŸã¯ç©ºã®å ´åˆã¯æ—§ãƒ‘ã‚¹ã‚’ä½¿ç”¨
      if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
        const oldPathMap = {
          "menus": "menu",
          "employees": "kintai_employees",
          "attendance": "kintai_attendance",
          "orders": "orders",
          "tables": "tables"
        };
        const path = oldPathMap[collectionName] || collectionName;
        console.log('   â†’ æ—§ãƒ‘ã‚¹ä½¿ç”¨:', path);
        return collection(db, path);
      }
      console.log('   â†’ æ–°ãƒ‘ã‚¹ä½¿ç”¨: stores/' + window.currentStoreId + '/' + collectionName);
      return collection(db, "stores", window.currentStoreId, collectionName);
    };

    // åº—èˆ—åˆ¥ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ã‚’å–å¾—
    window.getStoreDoc = function(collectionName, docId) {
      console.log('ğŸ” HANDY getStoreDocå‘¼ã³å‡ºã—');
      console.log('   ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å:', collectionName, 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID:', docId);
      console.log('   window.currentStoreId:', window.currentStoreId);
      
      // currentStoreIdãŒnullã¾ãŸã¯ç©ºã®å ´åˆã¯æ—§ãƒ‘ã‚¹ã‚’ä½¿ç”¨
      if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
        const oldPathMap = {
          "menus": "menu",
          "employees": "kintai_employees",
          "attendance": "kintai_attendance",
          "orders": "orders",
          "tables": "tables"
        };
        const path = oldPathMap[collectionName] || collectionName;
        console.log('   â†’ æ—§ãƒ‘ã‚¹ä½¿ç”¨:', path + '/' + docId);
        return doc(db, path, docId);
      }
      console.log('   â†’ æ–°ãƒ‘ã‚¹ä½¿ç”¨: stores/' + window.currentStoreId + '/' + collectionName + '/' + docId);
      return doc(db, "stores", window.currentStoreId, collectionName, docId);
    };
    
    console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†');
    
    window.firebaseReady = true;
    window.dispatchEvent(new Event('firebaseReady'));
  </script>
  
  <script>
    let currentStoreId = null;
    let currentStoreName = null;
    let storesData = {};
    let ordersListener = null;
    let currentOrders = [];
    let currentTableSettings = null;  // ğŸ†• ç¾åœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š
    let isInstantCheckoutMode = false;  // ğŸ’³ å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°
    
    let selectedPaymentMethod = null;
    let totalAmountToPay = 0;
    let cashReceived = 0;
    let changeAmount = 0;
    let customModalResolve = null;
    
    // ğŸ†• ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡
    let globalDefaultTaxRate = 10;
    
    // ğŸ†• ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆé–¢æ•°ï¼ˆã‚ªã‚·ãƒ£ãƒ¬ç‰ˆãƒ»çµµæ–‡å­—ãªã—ï¼‰
    window.showCustomAlert = function(options) {
      return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.id = 'customAlertModal';
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
          background: rgba(0,0,0,0.7); display: flex; align-items: center; 
          justify-content: center; z-index: 999999; animation: fadeIn 0.2s;
        `;
        
        const title = options.title || 'é€šçŸ¥';
        const message = options.message || '';
        const type = options.type || 'info'; // 'success', 'error', 'warning', 'info'
        const confirmText = options.confirmText || 'OK';
        const cancelText = options.cancelText;
        const showCancel = !!cancelText;
        
        // ã‚¿ã‚¤ãƒ—ã«ã‚ˆã‚‹è‰²åˆ†ã‘
        let gradient = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        let iconColor = '#667eea';
        if (type === 'success') {
          gradient = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
          iconColor = '#4CAF50';
        } else if (type === 'error') {
          gradient = 'linear-gradient(135deg, #f44336 0%, #c62828 100%)';
          iconColor = '#f44336';
        } else if (type === 'warning') {
          gradient = 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
          iconColor = '#FF9800';
        }
        
        modal.innerHTML = `
          <div style="
            background: ${gradient};
            border-radius: 24px; padding: 0; max-width: 500px; width: 90%;
            box-shadow: 0 25px 60px rgba(0,0,0,0.4); overflow: hidden;
            animation: slideUp 0.3s;
          ">
            <div style="background: white; padding: 32px; border-radius: 0 0 24px 24px;">
              <div style="text-align: center; margin-bottom: 24px;">
                <div style="width: 60px; height: 60px; margin: 0 auto 16px; background: ${iconColor}20; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                  <div style="width: 30px; height: 30px; border: 4px solid ${iconColor}; border-radius: 50%;"></div>
                </div>
                <h3 style="font-size: 24px; font-weight: bold; color: #333; margin-bottom: 8px;">
                  ${title}
                </h3>
                <div style="color: #666; font-size: 16px; line-height: 1.6;">
                  ${message}
                </div>
              </div>
              
              <div style="display: flex; gap: 12px; margin-top: 24px;">
                ${showCancel ? `
                  <button id="customAlertCancel" style="
                    flex: 1; padding: 16px; font-size: 16px; font-weight: bold;
                    border: 2px solid #ddd; border-radius: 12px; cursor: pointer;
                    background: white; color: #666; transition: all 0.2s;
                  " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                    ${cancelText}
                  </button>
                ` : ''}
                <button id="customAlertConfirm" style="
                  flex: 1; padding: 16px; font-size: 16px; font-weight: bold;
                  border: none; border-radius: 12px; cursor: pointer;
                  background: ${gradient};
                  color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                  transition: all 0.2s;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.5)'" 
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'">
                  ${confirmText}
                </button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('customAlertConfirm').onclick = () => {
          modal.remove();
          resolve(true);
        };
        
        if (showCancel) {
          document.getElementById('customAlertCancel').onclick = () => {
            modal.remove();
            resolve(false);
          };
        }
      });
    };
    
    // ğŸ†• ç¨é¡è¨ˆç®—é–¢æ•°
    function getTaxAmount(item, quantity = 1) {
      const taxType = item.taxType || 'inclusive';
      const basePrice = item.price + (item.toppingPrice || 0);
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã«åŸºã¥ã„ã¦é©ç”¨ç¨ç‡ã‚’æ±ºå®š
      const taxRate = getApplicableTaxRate(item, currentTableSettings);
      
      if (taxType === 'exclusive') {
        return Math.floor(basePrice * quantity * taxRate / 100);
      } else {
        const totalWithTax = basePrice * quantity;
        const totalWithoutTax = Math.floor(totalWithTax / (1 + taxRate / 100));
        return totalWithTax - totalWithoutTax;
      }
    }
    
    // ğŸ†• é©ç”¨ç¨ç‡ã‚’æ±ºå®šã™ã‚‹é–¢æ•°
    function getApplicableTaxRate(item, tableSettings) {
      // ãƒ¬ã‚¸è¢‹ã¯å¸¸ã«10%
      if (item.name?.includes('ãƒ¬ã‚¸è¢‹') || item.name?.includes('è¢‹')) {
        return 10;
      }
      
      // foodTypeã‚’æ±ºå®š
      let foodType = item.foodType || 'food';
      if (!item.foodType) {
        if (item.category === 'åŒ…æ' || item.name?.includes('åŒ…æ') || item.name?.includes('ãƒ¬ã‚¸è¢‹') || item.name?.includes('è¢‹')) {
          foodType = 'non-food';
        }
      }
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãŒæœ‰åŠ¹ãªå ´åˆ
      if (tableSettings && tableSettings.taxRule && tableSettings.taxRule !== 'none') {
        const taxRule = tableSettings.taxRule;
        
        switch(taxRule) {
          case 'takeout':
            return (foodType === 'food') ? 8 : 10;
          case 'dine-in':
            return 10;
          default:
            if (item.taxRate !== undefined && item.taxRate !== null) {
              return item.taxRate;
            }
            return (foodType === 'non-food') ? globalDefaultTaxRate : 8;
        }
      }
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãŒãªã„å ´åˆ
      if (item.taxRate !== undefined && item.taxRate !== null) {
        return item.taxRate;
      }
      
      return (foodType === 'non-food') ? 10 : 8;
    }
    
    function showCustomConfirm(options) {
      return new Promise((resolve) => {
        customModalResolve = resolve;
        const modal = document.getElementById('customConfirmModal');
        const icon = document.getElementById('modalIcon');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        
        icon.textContent = options.icon || 'âš ';
        title.textContent = options.title || 'ç¢ºèª';
        message.textContent = options.message || 'æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ';
        
        confirmBtn.className = 'modal-btn ' + (options.btnClass || 'modal-btn-danger');
        confirmBtn.textContent = options.btnText || 'å®Ÿè¡Œ';
        
        modal.style.display = 'flex';
      });
    }
    
    function closeCustomModal() {
      document.getElementById('customConfirmModal').style.display = 'none';
      if (customModalResolve) {
        customModalResolve(false);
        customModalResolve = null;
      }
    }
    
    function confirmCustomModal() {
      document.getElementById('customConfirmModal').style.display = 'none';
      if (customModalResolve) {
        customModalResolve(true);
        customModalResolve = null;
      }
    }
    
    /**
     * ğŸ†• å•†å“ã®é©ç”¨ç¨ç‡ã‚’æ±ºå®šï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã¨foodTypeã‚’è€ƒæ…®ï¼‰
     * ğŸ”¥ æ”¹å–„: ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šï¼ˆtakeout/dine-inï¼‰ãŒæœ‰åŠ¹ãªå ´åˆã€å•†å“ã®taxRateã‚ˆã‚Šã‚‚foodTypeã‚’å„ªå…ˆ
     */
    function getApplicableTaxRate(item, tableSettings) {
      // ğŸ”¥ ç‰¹åˆ¥å‡¦ç†: ãƒ¬ã‚¸è¢‹ã¯å¸¸ã«10%ï¼ˆæœ€å„ªå…ˆï¼‰
      if (item.name?.includes('ãƒ¬ã‚¸è¢‹') || item.name?.includes('ğŸ›') || item.name?.includes('è¢‹')) {
        console.log(`ğŸ”¥ ãƒ¬ã‚¸è¢‹åˆ¤å®š: ${item.name} â†’ å¼·åˆ¶çš„ã«10%`);
        return 10;
      }
      
      // ğŸ†• foodTypeã‚’æ±ºå®šï¼ˆæœªè¨­å®šã®å ´åˆã¯categoryã‹ã‚‰æ¨æ¸¬ï¼‰
      let foodType = item.foodType;
      if (!foodType) {
        // ã‚«ãƒ†ã‚´ãƒªãŒã€ŒåŒ…æã€ã¾ãŸã¯å•†å“åã«ã€ŒåŒ…æã€ã‚’å«ã‚€å ´åˆã¯é£Ÿæä»¥å¤–
        if (item.category === 'åŒ…æ' || item.name?.includes('åŒ…æ')) {
          foodType = 'non-food';
          console.log(`âš  foodTypeæœªè¨­å®š â†’ category/name(${item.category}/${item.name})ã‹ã‚‰æ¨æ¸¬: non-foodï¼ˆé£Ÿæä»¥å¤–ï¼‰`);
        } else {
          foodType = 'food';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é£Ÿæ
          console.log(`âš  foodTypeæœªè¨­å®š â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: foodï¼ˆé£Ÿæï¼‰, å•†å“å: ${item.name}`);
        }
      } else {
        console.log(`âœ… foodTypeè¨­å®šæ¸ˆã¿: ${foodType} (å•†å“: ${item.name})`);
      }
      
      // ğŸ”¥ æ”¹å–„: ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãŒæœ‰åŠ¹ï¼ˆtakeout/dine-inï¼‰ãªå ´åˆã€foodTypeã‚’å„ªå…ˆ
      if (tableSettings && tableSettings.taxRule && tableSettings.taxRule !== 'none') {
        const taxRule = tableSettings.taxRule;
        console.log(`[ç¨ç‡æ±ºå®š] å•†å“: ${item.name}, foodType: ${foodType}, taxRule: ${taxRule}`);
        
        switch(taxRule) {
          case 'takeout':
            // ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ: é£Ÿæã¯8%ã€é£Ÿæä»¥å¤–ã¯10%
            const takeoutRate = (foodType === 'food') ? 8 : 10;
            console.log(`  â†’ ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆãƒ¢ãƒ¼ãƒ‰: ${foodType === 'food' ? 'é£Ÿæ(8%)' : 'é£Ÿæä»¥å¤–(10%)'} = ${takeoutRate}%`);
            return takeoutRate;
          
          case 'dine-in':
            // åº—å†…é£²é£ŸåŠã³é£Ÿæä»¥å¤–: å…¨éƒ¨10%
            console.log(`  â†’ åº—å†…é£²é£ŸåŠã³é£Ÿæä»¥å¤–ãƒ¢ãƒ¼ãƒ‰: 10%`);
            return 10;
          
          default:
            // ä¸æ˜ãªtaxRule: å•†å“ã®taxRateã‚’å„ªå…ˆã€æœªè¨­å®šãªã‚‰foodTypeã‹ã‚‰æ¨æ¸¬
            if (item.taxRate !== undefined && item.taxRate !== null) {
              console.log(`  â†’ ä¸æ˜ãªtaxRule: ${taxRule} â†’ å•†å“ã®taxRate: ${item.taxRate}%`);
              return item.taxRate;
            }
            const defaultRate = (foodType === 'non-food') ? 10 : 8;
            console.log(`  â†’ ä¸æ˜ãªtaxRule: ${taxRule}, taxRateæœªè¨­å®š â†’ foodType(${foodType})ã‹ã‚‰: ${defaultRate}%`);
            return defaultRate;
        }
      }
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãŒãªã„ã€ã¾ãŸã¯taxRuleãŒ'none'ã®å ´åˆã¯å•†å“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡ã‚’ä½¿ç”¨
      // å•†å“ã®taxRateã‚’å„ªå…ˆä½¿ç”¨
      if (item.taxRate !== undefined && item.taxRate !== null) {
        console.log(`[ç¨ç‡æ±ºå®š] ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãªã— â†’ å•†å“ã®taxRate: ${item.taxRate}%`);
        return item.taxRate;
      }
      
      // taxRateãŒãªã„å ´åˆã€foodTypeã‹ã‚‰æ¨æ¸¬ï¼ˆé£Ÿæ:8%, é£Ÿæä»¥å¤–:10%ï¼‰
      const inferredRate = (foodType === 'non-food') ? 10 : 8;
      console.log(`[ç¨ç‡æ±ºå®š] ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãªã—ã€taxRateæœªè¨­å®š â†’ foodType(${foodType})ã‹ã‚‰æ¨æ¸¬: ${inferredRate}%`);
      return inferredRate;
    }
    
    /**
     * ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’å–å¾—
     */
    async function getTableSettings(tableId) {
      if (!tableId || !currentStoreId) {
        return null;
      }
      
      try {
        const tableDocRef = window.doc(window.db, 'stores', currentStoreId, 'tableSettings', tableId);
        const tableDoc = await window.getDoc(tableDocRef);
        
        if (tableDoc.exists()) {
          console.log('ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šå–å¾—:', tableId, tableDoc.data());
          return tableDoc.data();
        }
        console.log('ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãªã—:', tableId);
        return null;
      } catch (e) {
        console.error('âŒ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        return null;
      }
    }
    
    async function loadStoreList() {
      try {
        const storesQuery = window.query(
          window.collection(window.db, 'stores'),
          window.where('isActive', '==', true)
        );
        const storesSnapshot = await window.getDocs(storesQuery);
        const storeSelect = document.getElementById('storeSelect');
        
        storeSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        storesData = {};
        
        storesSnapshot.forEach(doc => {
          const storeData = doc.data();
          const storeId = doc.id;
          const storeName = storeData.storeName || doc.id;
          const password = storeData.storePassword || '';
          
          storesData[storeId] = {
            storeName: storeName,
            password: String(password),
            isActive: true
          };
          
          const option = document.createElement('option');
          option.value = storeId;
          option.textContent = storeName;
          storeSelect.appendChild(option);
        });
      } catch (error) {
        console.error('âŒ åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        showError('åº—èˆ—ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
    
    window.handleLogin = async function() {
      playTapSound();
      const storeSelect = document.getElementById('storeSelect');
      const passwordInput = document.getElementById('passwordInput');
      const storeId = storeSelect.value;
      const inputPassword = passwordInput.value.trim();
      
      if (!storeId) {
        showError('åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      if (!inputPassword) {
        showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      const storeInfo = storesData[storeId];
      if (inputPassword !== storeInfo.password) {
        showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      currentStoreId = storeId;
      window.currentStoreId = storeId; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦è¨­å®š
      currentStoreName = storeInfo.storeName;
      sessionStorage.setItem('handyStoreId', storeId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      
      // ğŸ†• ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’ä¿å­˜ï¼ˆPOSè‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ç”¨ï¼‰
      window.saveLoginInfo(storeId, inputPassword);
      
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log('ğŸ“ HANDY åº—èˆ—IDè¨­å®šå®Œäº†');
      console.log('   currentStoreId:', currentStoreId);
      console.log('   window.currentStoreId:', window.currentStoreId);
      console.log('   currentStoreName:', currentStoreName);
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      
      showTablesScreen();
    };
    
    window.handleLogout = async function() {
      playTapSound();
      const confirmed = await showCustomConfirm({
        icon: 'ğŸšª',
        title: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
        message: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ',
        btnClass: 'modal-btn-danger',
        btnText: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ'
      });
      
      if (confirmed) {
        if (ordersListener) ordersListener();
        sessionStorage.removeItem('handyStoreId');
        sessionStorage.removeItem('handyStoreName');
        location.reload();
      }
    };
    
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => errorDiv.classList.add('hidden'), 3000);
    }
    
    async function showTablesScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('tablesScreen').style.display = 'block';
      document.getElementById('tablesScreen').classList.remove('hidden');
      document.getElementById('storeNameDisplay').textContent = currentStoreName;
      
      await loadTables();
      startOrdersListener();
      
      // ğŸ†• åœ¨åº«ãƒ‘ãƒãƒ«ã‚’åˆæœŸåŒ–
      updateInventoryPanel();
      watchInventoryChanges();
    }
    
    function startOrdersListener() {
      if (ordersListener) ordersListener();
      const ordersRef = window.getStoreCollection('orders');
      ordersListener = window.onSnapshot(ordersRef, (snapshot) => {
        updateTableStatus(snapshot);
      });
    }
    
    function updateTableStatus(ordersSnapshot) {
      const unpaidTables = new Set();  // æ³¨æ–‡ã‚ã‚Šï¼ˆæœªä¼šè¨ˆï¼‰
      const completedUnpaidTables = new Set();  // å®Œäº†æ¸ˆã¿ã ãŒæœªä¼šè¨ˆ
      const hasIncompleteOrders = new Set();  // æœªå®Œäº†ã®æ³¨æ–‡ãŒã‚ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«
      
      console.log('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°é–‹å§‹');
      
      ordersSnapshot.forEach(doc => {
        const order = doc.data();
        console.log('ğŸ“‹ æ³¨æ–‡ãƒã‚§ãƒƒã‚¯:', {
          id: doc.id,
          table: order.tableNumber,
          deleted: order.deleted,
          cancelled: !!order.cancelledAt,
          paid: !!order.paidAt,
          completed: !!order.completedAt
        });
        
        if (order.tableNumber && !order.deleted && !order.cancelledAt) {
          // ä¼šè¨ˆæ¸ˆã¿ã§ãªã„æ³¨æ–‡
          if (!order.paidAt) {
            unpaidTables.add(order.tableNumber);
            
            // å®Œäº†æ¸ˆã¿ã ãŒæœªä¼šè¨ˆ
            if (order.completedAt) {
              completedUnpaidTables.add(order.tableNumber);
              console.log('âš  æœªä¼šè¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ç™ºè¦‹:', order.tableNumber);
            } else {
              // æœªå®Œäº†ã®æ³¨æ–‡ãŒã‚ã‚‹
              hasIncompleteOrders.add(order.tableNumber);
              console.log('ğŸ“ æœªå®Œäº†æ³¨æ–‡ã‚ã‚Š:', order.tableNumber);
            }
          }
        }
      });
      
      console.log('ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é›†è¨ˆ:', {
        æœªä¼šè¨ˆãƒ†ãƒ¼ãƒ–ãƒ«: Array.from(completedUnpaidTables),
        æ³¨æ–‡ã‚ã‚Šãƒ†ãƒ¼ãƒ–ãƒ«: Array.from(unpaidTables),
        æœªå®Œäº†æ³¨æ–‡ã‚ã‚Š: Array.from(hasIncompleteOrders)
      });
      
      document.querySelectorAll('.table-card').forEach(card => {
        const tableName = card.getAttribute('data-table-name');
        
        // æ—¢å­˜ã®ãƒãƒƒã‚¸ã‚’ã™ã¹ã¦å‰Šé™¤
        card.querySelectorAll('.pending-badge, .status-badge, .unpaid-badge').forEach(badge => badge.remove());
        
        if (unpaidTables.has(tableName)) {
          // æ³¨æ–‡ã‚ã‚Š â†’ èƒŒæ™¯ã‚’ã‚ªãƒ¬ãƒ³ã‚¸ã«
          card.classList.add('has-pending-orders');
          
          // ã€Œæ³¨æ–‡ã‚ã‚Šã€ãƒãƒƒã‚¸ã‚’è¿½åŠ ï¼ˆæœªå®Œäº†ã®æ³¨æ–‡ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
          if (hasIncompleteOrders.has(tableName)) {
            const orderBadge = document.createElement('div');
            orderBadge.className = 'pending-badge';
            orderBadge.textContent = 'æ³¨æ–‡ã‚ã‚Š';
            orderBadge.style.cssText = 'position: absolute; top: 10px; right: 10px; background: #ff9800; color: white; font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: bold;';
            card.appendChild(orderBadge);
            console.log('âœ… æ³¨æ–‡ã‚ã‚Šãƒãƒƒã‚¸è¿½åŠ :', tableName);
          }
          
          // ã€Œæœªä¼šè¨ˆã€ãƒãƒƒã‚¸ã‚’è¿½åŠ ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
          const unpaidBadge = document.createElement('div');
          unpaidBadge.className = 'unpaid-badge';
          unpaidBadge.textContent = 'æœªä¼šè¨ˆ';
          unpaidBadge.style.cssText = 'position: absolute; top: 10px; left: 10px; background: #f57c00; color: white; font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: bold; animation: pulse 2s infinite;';
          card.appendChild(unpaidBadge);
          console.log('âœ… æœªä¼šè¨ˆãƒãƒƒã‚¸è¿½åŠ :', tableName);
        } else {
          // ç©ºå¸­ â†’ ãƒãƒƒã‚¸ãªã—
          card.classList.remove('has-pending-orders');
          console.log(' ç©ºå¸­:', tableName);
        }
      });
    }
    
    async function loadTables() {
      try {
        const tablesGrid = document.getElementById('tablesGrid');
        tablesGrid.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
        
        const tablesRef = window.getStoreCollection('tables');
        const tablesSnapshot = await window.getDocs(tablesRef);
        const tables = [];
        
        tablesSnapshot.forEach(doc => {
          tables.push({ id: doc.id, ...doc.data() });
        });
        
        tables.sort((a, b) => (a.order || 0) - (b.order || 0) || a.name.localeCompare(b.name));
        
        if (tables.length === 0) {
          tablesGrid.innerHTML = '<div style="color: white; text-align: center; padding: 40px;">ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
          return;
        }
        
        tablesGrid.innerHTML = '';
        
        // å³ä¼šè¨ˆãƒœã‚¿ãƒ³ã‚’æœ€åˆã«è¿½åŠ 
        const instantCheckoutCard = document.createElement('div');
        instantCheckoutCard.className = 'table-card instant-checkout-card';
        instantCheckoutCard.style.background = 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
        instantCheckoutCard.style.color = 'white';
        instantCheckoutCard.innerHTML = `
          <div class="table-name" style="color: white; font-weight: bold;">å³ä¼šè¨ˆ</div>
          <div class="table-status" style="color: rgba(255,255,255,0.9);">ã‚¿ãƒƒãƒ—ã—ã¦æ³¨æ–‡</div>
        `;
        instantCheckoutCard.onclick = () => { 
          playTapSound(); 
          openInstantCheckout(); 
        };
        tablesGrid.appendChild(instantCheckoutCard);
        
        tables.forEach(table => {
          const tableCard = document.createElement('div');
          tableCard.className = 'table-card';
          tableCard.setAttribute('data-table-name', table.name);
          tableCard.innerHTML = `
            <div class="table-name">${table.name}</div>
            <div class="table-status">ã‚¿ãƒƒãƒ—ã—ã¦æ³¨æ–‡</div>
          `;
          
          // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰è‡ªä½“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã«é·ç§»
          tableCard.onclick = () => { 
            playTapSound(); 
            openMenu(table.name); 
          };
          
          const menuBtn = document.createElement('button');
          menuBtn.className = 'checkout-btn';
          menuBtn.textContent = ' ãƒ¡ãƒ‹ãƒ¥ãƒ¼';
          menuBtn.style.background = '#667eea';
          menuBtn.onclick = (e) => { e.stopPropagation(); playTapSound(); openMenu(table.name); };
          tableCard.appendChild(menuBtn);
          
          const checkoutBtn = document.createElement('button');
          checkoutBtn.className = 'checkout-btn';
          checkoutBtn.textContent = ' ä¼šè¨ˆ';
          checkoutBtn.onclick = (e) => { e.stopPropagation(); playTapSound(); openCheckoutForTable(table.name); };
          tableCard.appendChild(checkoutBtn);
          
          tablesGrid.appendChild(tableCard);
        });
      } catch (error) {
        console.error('âŒ ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    function openMenu(tableName) {
      console.log('ğŸ½ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã:', {
        tableName: tableName,
        currentStoreId: currentStoreId,
        currentStoreName: currentStoreName
      });
      
      // åº—èˆ—IDã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆmenu.htmlã§ä½¿ç”¨ï¼‰
      sessionStorage.setItem('handyStoreId', currentStoreId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      sessionStorage.setItem('handyTableName', tableName);
      
      const menuUrl = `menu.html?table=${encodeURIComponent(tableName)}&store=${currentStoreId}&mode=handy`;
      console.log(' é·ç§»å…ˆURL:', menuUrl);
      window.location.href = menuUrl;
    }
    
    async function openCheckoutForTable(tableName) {
      try {
        const ordersRef = window.getStoreCollection('orders');
        const ordersQuery = window.query(ordersRef, window.where('tableNumber', '==', String(tableName)));
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        currentOrders = [];
        ordersSnapshot.forEach(doc => {
          const order = { id: doc.id, ...doc.data() };
          if (!order.deleted && !order.cancelledAt && !order.paidAt) {
            currentOrders.push(order);
          }
        });
        
        // æ³¨æ–‡ç•ªå·ã§ã‚½ãƒ¼ãƒˆ
        currentOrders.sort((a, b) => (a.orderNumber || 0) - (b.orderNumber || 0));
        
        if (currentOrders.length === 0) {
          await showCustomAlert({ icon: 'ğŸ“‹', title: 'æ³¨æ–‡ãªã—', message: `${tableName}\nã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“`, btnClass: 'modal-btn-success' });
          return;
        }
        
        // è¤‡æ•°æ³¨æ–‡ãŒã‚ã‚‹å ´åˆã¯é¸æŠç”»é¢ã‚’è¡¨ç¤º
        if (currentOrders.length > 1) {
          showOrderSelectionModal(tableName);
        } else {
          showCheckoutMenu(tableName, [currentOrders[0]]);
        }
      } catch (error) {
        console.error('âŒ ä¼šè¨ˆç”»é¢è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // æ³¨æ–‡é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showOrderSelectionModal(tableName) {
      const modal = document.getElementById('orderSelectionModal');
      document.getElementById('orderSelectionTableName').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${tableName}`;
      
      const ordersList = document.getElementById('ordersList');
      ordersList.innerHTML = '';
      
      // å…¨æ³¨æ–‡ã¾ã¨ã‚ã¦ä¼šè¨ˆãƒœã‚¿ãƒ³
      const allOrdersBtn = document.createElement('button');
      allOrdersBtn.className = 'order-selection-btn';
      allOrdersBtn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
      allOrdersBtn.style.color = 'white';
      allOrdersBtn.style.fontWeight = 'bold';
      
      // æœªå®Œäº†ã¨å®Œäº†æ¸ˆã¿ã®ä»¶æ•°ã‚’è¨ˆç®—
      const incompleteCount = currentOrders.filter(o => !o.completedAt).length;
      const completeCount = currentOrders.filter(o => o.completedAt).length;
      const statusText = incompleteCount > 0 && completeCount > 0 
        ? ` (æœªå®Œäº† ${incompleteCount}ä»¶ / å®Œäº†æ¸ˆã¿ ${completeCount}ä»¶)`
        : incompleteCount > 0 
        ? ` (æœªå®Œäº† ${incompleteCount}ä»¶)`
        : completeCount > 0 
        ? ` (å®Œäº†æ¸ˆã¿ ${completeCount}ä»¶)`
        : '';
      
      allOrdersBtn.innerHTML = `
        <div style="font-size: 20px; margin-bottom: 8px;">ğŸ“‹ å…¨æ³¨æ–‡ã¾ã¨ã‚ã¦ä¼šè¨ˆ</div>
        <div style="font-size: 16px;">åˆè¨ˆ ${currentOrders.length} ä»¶${statusText} - Â¥${currentOrders.reduce((sum, o) => sum + (o.totalAmount || 0), 0).toLocaleString()}</div>
      `;
      allOrdersBtn.onclick = () => {
        modal.classList.add('hidden');
        showCheckoutMenu(tableName, currentOrders);
      };
      ordersList.appendChild(allOrdersBtn);
      
      // å€‹åˆ¥æ³¨æ–‡ãƒœã‚¿ãƒ³
      currentOrders.forEach((order, index) => {
        const orderBtn = document.createElement('button');
        orderBtn.className = 'order-selection-btn';
        orderBtn.style.position = 'relative';  // ãƒãƒƒã‚¸ã®é…ç½®ã®ãŸã‚
        
        const itemsText = order.items && Array.isArray(order.items)
          ? order.items.map(item => `${item.name} x${item.quantity || 1}`).join(', ')
          : 'æ³¨æ–‡å†…å®¹ãªã—';
        
        // æœªå®Œäº†ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        const isIncomplete = !order.completedAt;
        const statusBadge = isIncomplete 
          ? '<span style="position: absolute; top: 10px; right: 10px; background: #ff9800; color: white; font-size: 11px; padding: 4px 10px; border-radius: 12px; font-weight: bold;">æœªå®Œäº†</span>'
          : '<span style="position: absolute; top: 10px; right: 10px; background: #4CAF50; color: white; font-size: 11px; padding: 4px 10px; border-radius: 12px; font-weight: bold;">å®Œäº†æ¸ˆã¿</span>';
        
        orderBtn.innerHTML = `
          ${statusBadge}
          <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">æ³¨æ–‡ #${order.orderNumber || (index + 1)}</div>
          <div style="font-size: 14px; color: #666; margin-bottom: 8px;">${itemsText}</div>
          <div style="font-size: 16px; color: #4CAF50; font-weight: bold;">Â¥${(order.totalAmount || 0).toLocaleString()}</div>
        `;
        orderBtn.onclick = () => {
          modal.classList.add('hidden');
          showCheckoutMenu(tableName, [order]);
        };
        ordersList.appendChild(orderBtn);
      });
      
      modal.classList.remove('hidden');
    }
    
    window.closeOrderSelectionModal = function() {
      document.getElementById('orderSelectionModal').classList.add('hidden');
    };
    
    async function showCheckoutMenu(tableName, selectedOrders = null) {
      // selectedOrdersãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°currentOrderså…¨ã¦
      const ordersToCheckout = selectedOrders || currentOrders;
      
      totalAmountToPay = ordersToCheckout.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      const paymentModal = document.getElementById('paymentModal');
      paymentModal.classList.remove('hidden');
      
      // æ³¨æ–‡ç•ªå·ã‚’è¡¨ç¤º
      let orderNumbersText = '';
      if (ordersToCheckout.length === 1) {
        orderNumbersText = ` - æ³¨æ–‡ #${ordersToCheckout[0].orderNumber || '1'}`;
      } else if (ordersToCheckout.length > 1) {
        const orderNums = ordersToCheckout.map(o => `#${o.orderNumber || '?'}`).join(', ');
        orderNumbersText = ` - ${orderNums}`;
      }
      
      document.getElementById('selectedTableLabel2').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${tableName}${orderNumbersText}`;
      
      // é¸æŠã•ã‚ŒãŸæ³¨æ–‡ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ï¼ˆä¼šè¨ˆå‡¦ç†ã§ä½¿ç”¨ï¼‰
      window.ordersToCheckout = ordersToCheckout;
      
      // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’å–å¾—
      currentTableSettings = await getTableSettings(tableName);
      console.log('ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š:', tableName, currentTableSettings);
      
      generateTaxRateItems(ordersToCheckout, tableName);
      document.getElementById('discountAmount').value = 0;
      updatePaymentTotal();
      
      selectedPaymentMethod = null;
      document.querySelectorAll('.payment-method-btn').forEach(btn => btn.classList.remove('selected'));
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('paymentBtn').disabled = true;
    }
    
    window.closePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
    };
    
    function generateTaxRateItems(ordersToProcess = null, tableName = '') {
      const container = document.getElementById('taxRateItemsList');
      container.innerHTML = '';
      let itemIndex = 0;
      
      const orders = ordersToProcess || currentOrders;
      
      orders.forEach(order => {
        if (!order.items || order.items.length === 0) {
          // æ³¨æ–‡å…¨ä½“ã¨ã—ã¦æ‰±ã†å ´åˆï¼ˆå¤ã„å½¢å¼ï¼‰
          // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã«åŸºã¥ã„ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡ã‚’æ±ºå®šã™ã‚‹ãŒã€å•†å“ãŒãªã„ã®ã§10%ã¨ã™ã‚‹
          const defaultTaxRate = 10;
          addTaxRateItem(container, `æ³¨æ–‡ #${order.orderNumber}`, 1, order.totalAmount || 0, itemIndex, defaultTaxRate, 'inclusive');
          itemIndex++;
        } else {
          order.items.forEach(item => {
            const toppingStr = item.toppings || item.toppingDetails || 'ãªã—';
            // ğŸ†• å¤–ç¨ã®å ´åˆã¯æœ¬ä½“ä¾¡æ ¼ã€å†…ç¨ã®å ´åˆã¯ç¨è¾¼ä¾¡æ ¼
            const itemBasePrice = item.price + (item.toppingPrice || 0);
            const itemTotal = itemBasePrice * item.quantity;
            
            // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã¨foodTypeã«åŸºã¥ã„ã¦ç¨ç‡ã‚’æ±ºå®š
            const itemTaxRate = getApplicableTaxRate(item, currentTableSettings);
            console.log(`âœ… é©ç”¨ç¨ç‡: ${itemTaxRate}% (å•†å“: ${item.name}, foodType: ${item.foodType || 'food'}, taxRule: ${currentTableSettings?.taxRule || 'none'})`);
            
            // ğŸ†• taxTypeã‚’æ¸¡ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å†…ç¨ï¼‰
            addTaxRateItem(container, `${item.name} (${toppingStr})`, item.quantity, itemTotal, itemIndex, itemTaxRate, item.taxType || 'inclusive');
            itemIndex++;
          });
          
          // ğŸ› ãƒ¬ã‚¸è¢‹æƒ…å ±ã®è©³ç´°ãƒ‡ãƒãƒƒã‚°
          console.log('ğŸ›ğŸ›ğŸ› ãƒ¬ã‚¸è¢‹ãƒã‚§ãƒƒã‚¯é–‹å§‹ ğŸ›ğŸ›ğŸ›');
          console.log('  order:', order);
          console.log('  order.bagNeeded:', order.bagNeeded, '(å‹:', typeof order.bagNeeded, ')');
          console.log('  order.bagQuantity:', order.bagQuantity, '(å‹:', typeof order.bagQuantity, ')');
          console.log('  order.bagPrice:', order.bagPrice, '(å‹:', typeof order.bagPrice, ')');
          console.log('  æ¡ä»¶1 (bagNeeded):', order.bagNeeded);
          console.log('  æ¡ä»¶2 (bagQuantity > 0):', order.bagQuantity > 0);
          console.log('  ä¸¡æ–¹æº€ãŸã™:', order.bagNeeded && order.bagQuantity > 0);
          
          if (order.bagNeeded && order.bagQuantity > 0) {
            console.log('âœ…âœ…âœ… ãƒ¬ã‚¸è¢‹ã‚’è¿½åŠ ã—ã¾ã™ï¼');
            console.log('  æ•°é‡:', order.bagQuantity);
            console.log('  ä¾¡æ ¼:', order.bagPrice || (order.bagQuantity * 3));
            addTaxRateItem(container, 'ğŸ› ãƒ¬ã‚¸è¢‹', order.bagQuantity, order.bagPrice || (order.bagQuantity * 3), itemIndex, 10, 'inclusive');
            itemIndex++;
          } else {
            console.log('âŒâŒâŒ ãƒ¬ã‚¸è¢‹ã¯è¿½åŠ ã•ã‚Œã¾ã›ã‚“');
            console.log('  ç†ç”±: bagNeeded=' + order.bagNeeded + ', bagQuantity=' + order.bagQuantity);
          }
        }
      });
      calculateTaxSummary();
    }
    
    function addTaxRateItem(container, itemName, quantity, itemTotal, index, defaultTaxRate, taxType = 'inclusive') {
      // ğŸ†• å¤–ç¨ã®å ´åˆã¯ç¨è¾¼ä¾¡æ ¼ã‚’è¨ˆç®—ï¼ˆitemTotalã¯æœ¬ä½“ä¾¡æ ¼ï¼‰
      let displayTotal = itemTotal;
      if (taxType === 'exclusive') {
        // å¤–ç¨ã®å ´åˆã€itemTotalã¯æœ¬ä½“ä¾¡æ ¼ãªã®ã§ç¨ã‚’åŠ ç®—
        displayTotal = itemTotal + Math.floor(itemTotal * (defaultTaxRate / 100));
        console.log(`ğŸ†• å¤–ç¨è¨ˆç®—: æœ¬ä½“${itemTotal}å†† + ç¨${Math.floor(itemTotal * (defaultTaxRate / 100))}å†† â†’ ${displayTotal}å††ï¼ˆç¨ç‡${defaultTaxRate}%ï¼‰`);
      }
      
      const itemDiv = document.createElement('div');
      itemDiv.style.cssText = 'padding: 10px; margin-bottom: 8px; background: white; border-radius: 6px; border: 1px solid #ddd;';
      
      const headerDiv = document.createElement('div');
      headerDiv.style.cssText = 'display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; font-size: 14px; cursor: pointer;';
      headerDiv.innerHTML = `<span>${itemName} Ã—${quantity}</span><span style="color: #667eea;" id="itemPrice${index}">Â¥${displayTotal.toLocaleString()}</span>`;
      
      headerDiv.onclick = function() {
        document.getElementById('priceChangeTitle').textContent = itemName;
        document.getElementById('priceChangeCurrentPrice').textContent = `Â¥${displayTotal.toLocaleString()}`;
        document.getElementById('priceChangeInput').value = displayTotal;
        document.getElementById('priceChangeItemId').value = index;
        document.getElementById('priceChangeModal').classList.remove('hidden');
      };
      
      const radioDiv = document.createElement('div');
      radioDiv.style.cssText = 'display: flex; gap: 10px; justify-content: center;';
      
      const radio8 = createRadio(index, 8, displayTotal, defaultTaxRate === 8, itemTotal, taxType);
      const radio10 = createRadio(index, 10, displayTotal, defaultTaxRate === 10, itemTotal, taxType);
      
      radioDiv.appendChild(createRadioLabel(radio8, '8%æŒã¡å¸°ã‚Š', '#fff3e0', '#FF9800'));
      radioDiv.appendChild(createRadioLabel(radio10, '10%åº—å†…', '#e3f2fd', '#2196F3'));
      
      itemDiv.appendChild(headerDiv);
      itemDiv.appendChild(radioDiv);
      container.appendChild(itemDiv);
    }
    
    function createRadio(index, rate, amount, checked, baseAmount = null, taxType = 'inclusive') {
      const radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = `taxRate${index}`;
      radio.value = rate;
      radio.checked = checked;
      radio.dataset.amount = amount;
      radio.dataset.taxType = taxType;  // ğŸ†• taxTypeã‚’ä¿å­˜
      radio.dataset.baseAmount = baseAmount || amount;  // ğŸ†• æœ¬ä½“ä¾¡æ ¼ã‚’ä¿å­˜
      radio.style.marginRight = '5px';
      
      // ğŸ†• å¤–ç¨ã®å ´åˆã¯ç¨ç‡å¤‰æ›´æ™‚ã«é‡‘é¡ã‚’å†è¨ˆç®—
      radio.onchange = function() {
        if (taxType === 'exclusive') {
          const newAmount = parseInt(radio.dataset.baseAmount) + Math.floor(parseInt(radio.dataset.baseAmount) * (rate / 100));
          // åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã®å…¨ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®amountã‚’æ›´æ–°
          document.querySelectorAll(`input[name="taxRate${index}"]`).forEach(r => {
            r.dataset.amount = newAmount;
          });
          document.getElementById('itemPrice' + index).textContent = 'Â¥' + newAmount.toLocaleString();
          console.log(`å¤–ç¨${rate}%ã«å¤‰æ›´: ${radio.dataset.baseAmount}å†† â†’ ${newAmount}å††`);
        }
        calculateTaxSummary();
      };
      
      return radio;
    }
    
    function createRadioLabel(radio, text, bg, border) {
      const label = document.createElement('label');
      label.style.cssText = `flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 6px 10px; border-radius: 4px; background: ${bg}; border: 2px solid ${border}; font-size: 13px;`;
      label.appendChild(radio);
      label.appendChild(document.createTextNode(text));
      return label;
    }
    
    function calculateTaxSummary() {
      let tax8 = 0, tax10 = 0;
      document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked').forEach(r => {
        if (r.value === '8') tax8 += parseFloat(r.dataset.amount);
        else tax10 += parseFloat(r.dataset.amount);
      });
      document.getElementById('tax8Summary').textContent = 'Â¥' + tax8.toLocaleString();
      document.getElementById('tax10Summary').textContent = 'Â¥' + tax10.toLocaleString();
      updatePaymentTotal();
    }
    
    window.updatePaymentTotal = function() {
      let total = 0;
      document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked').forEach(r => total += parseFloat(r.dataset.amount));
      const final = Math.max(0, total - (parseInt(document.getElementById('discountAmount').value) || 0));
      totalAmountToPay = final;
      document.getElementById('finalPaymentAmount').textContent = 'Â¥' + final.toLocaleString();
      if (selectedPaymentMethod === 'cash') calculateChange();
    };
    
    window.selectPaymentMethod = function(method) {
      playTapSound();
      selectedPaymentMethod = method;
      document.querySelectorAll('.payment-method-btn').forEach(btn => btn.classList.toggle('selected', btn.innerText.includes(method === 'cash' ? 'ç¾é‡‘' : method === 'emoney' ? 'é›»å­' : 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ')));
      document.getElementById('cashInputSection').classList.toggle('hidden', method !== 'cash');
      document.getElementById('paymentBtn').disabled = method === 'cash';
    };
    
    window.calculateChange = function() {
      cashReceived = parseInt(document.getElementById('cashReceived').value) || 0;
      changeAmount = cashReceived - totalAmountToPay;
      document.getElementById('changeAmount').textContent = `Â¥${changeAmount.toLocaleString()}`;
      document.getElementById('paymentBtn').disabled = cashReceived < totalAmountToPay;
    };
    
    window.confirmPriceChange = function() {
      const itemId = document.getElementById('priceChangeItemId').value;
      const newPrice = parseFloat(document.getElementById('priceChangeInput').value) || 0;
      document.querySelectorAll(`input[name="taxRate${itemId}"]`).forEach(r => r.dataset.amount = newPrice);
      document.getElementById(`itemPrice${itemId}`).textContent = 'Â¥' + newPrice.toLocaleString();
      calculateTaxSummary();
      document.getElementById('priceChangeModal').classList.add('hidden');
    };
    
    window.closePriceChangeModal = function() {
      document.getElementById('priceChangeModal').classList.add('hidden');
    };

    // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆOK ãƒœã‚¿ãƒ³ã®ã¿ï¼‰
    function showCustomAlert(options) {
      return new Promise((resolve) => {
        const modal = document.getElementById('customConfirmModal');
        const icon = document.getElementById('modalIcon');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const buttonsContainer = document.querySelector('.modal-buttons');
        
        icon.textContent = options.icon || '';
        title.textContent = options.title || 'ãŠçŸ¥ã‚‰ã›';
        message.textContent = options.message || '';
        
        buttonsContainer.innerHTML = `
          <button class="modal-btn ${options.btnClass || 'modal-btn-primary'}" onclick="playTapSound(); closeCustomAlert()">${options.btnText || 'OK'}</button>
        `;
        
        window.closeCustomAlert = function() {
          modal.style.display = 'none';
          resolve(true);
        };
        
        modal.style.display = 'flex';
      });
    }

    // ä¼šè¨ˆå‡¦ç†ï¼ˆå£²ä¸Šãƒ»å®¢æ•°ã‚’POSã«åæ˜ ï¼‰- ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§å®Œçµ
    window.processPayment = async function() {
      playTapSound();
      
      if (!selectedPaymentMethod) {
        await showCustomAlert({ icon: 'âš ', title: 'ã‚¨ãƒ©ãƒ¼', message: 'æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„', btnClass: 'modal-btn-danger' });
        return;
      }
      
      if (selectedPaymentMethod === 'cash' && cashReceived < totalAmountToPay) {
        await showCustomAlert({ icon: 'âš ', title: 'ã‚¨ãƒ©ãƒ¼', message: 'ãŠé ã‹ã‚Šé‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™', btnClass: 'modal-btn-danger' });
        return;
      }
      
      try {
        const now = window.Timestamp.now();
        
        // window.ordersToCheckoutã‹ã‚‰ä¼šè¨ˆå¯¾è±¡ã®æ³¨æ–‡ã‚’å–å¾—
        const ordersToProcess = window.ordersToCheckout || currentOrders;
        
        // å€¤å¼•ãé‡‘é¡ã‚’å–å¾—
        const discountAmount = parseInt(document.getElementById('discountAmount').value) || 0;
        
        // ç¨ç‡åˆ¥é›†è¨ˆ
        let tax8Total = 0;
        let tax10Total = 0;
        const radios = document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked');
        radios.forEach(radio => {
          const amount = parseFloat(radio.dataset.amount) || 0;
          const taxRate = radio.value;
          if (taxRate === '8') {
            tax8Total += amount;
          } else if (taxRate === '10') {
            tax10Total += amount;
          }
        });
        
        // å€¤å¼•ãå¾Œã®é‡‘é¡ï¼ˆtotalAmountToPayã¯æ—¢ã«å€¤å¼•ãå¾Œï¼‰
        const totalBeforeDiscount = tax8Total + tax10Total;
        
        // å•†å“ç‚¹æ•°ã‚’è¨ˆç®—
        let itemCount = 0;
        ordersToProcess.forEach(order => {
          if (order.items && Array.isArray(order.items)) {
            order.items.forEach(item => {
              itemCount += item.quantity || 0;
            });
          } else {
            itemCount += 1;
          }
        });
        
        console.log(' ä¼šè¨ˆå‡¦ç†é–‹å§‹:', {
          totalAmount: totalAmountToPay,
          å€¤å¼•ãå‰é‡‘é¡: totalBeforeDiscount,
          å€¤å¼•ãé‡‘é¡: discountAmount,
          å€¤å¼•ãå¾Œé‡‘é¡: totalAmountToPay,
          paymentMethod: selectedPaymentMethod,
          itemCount: itemCount,
          tax8Total: tax8Total,
          tax10Total: tax10Total,
          customerCount: 1,
          ordersCount: ordersToProcess.length,
          storeId: currentStoreId
        });
        
        // æ”¯æ‰•ã„æ–¹æ³•ã‚’æ—¥æœ¬èªã«å¤‰æ›
        let paymentMethodJP = 'ç¾é‡‘';
        if (selectedPaymentMethod === 'emoney') paymentMethodJP = 'é›»å­ãƒãƒãƒ¼';
        else if (selectedPaymentMethod === 'credit') paymentMethodJP = 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰';
        
        // Firestoreã®æ³¨æ–‡ã«paidAtã€completedAtã€deletedãƒ•ãƒ©ã‚°ã‚’è¨­å®šï¼ˆä¼šè¨ˆå®Œäº†ã§å‰Šé™¤ï¼‰
        for (const order of ordersToProcess) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          await window.updateDoc(orderRef, {
            paidAt: now,
            completedAt: now,
            deleted: true,  // ä¼šè¨ˆå®Œäº†ã§å‰Šé™¤
            deletedAt: now,
            paymentMethod: paymentMethodJP,
            discountAmount: discountAmount,  // å€¤å¼•ãé‡‘é¡ã‚’ä¿å­˜
            totalAmount: totalAmountToPay,  // å€¤å¼•ãå¾Œã®é‡‘é¡ã§totalAmountã‚’æ›´æ–°
            originalAmount: totalBeforeDiscount,  // å…ƒã®é‡‘é¡ã‚’ä¿å­˜
            notifiedPaid: true,
            tax8Total: tax8Total,
            tax10Total: tax10Total
          });
          console.log('âœ… æ³¨æ–‡ã‚’ä¼šè¨ˆæ¸ˆã¿ï¼†å‰Šé™¤:', order.id, 'é‡‘é¡:', totalAmountToPay);
        }
        
        // å£²ä¸Šã‚’POSã«åæ˜ 
        const dateStr = getBusinessDateStr();
        console.log('ğŸ“… å–¶æ¥­æ—¥:', dateStr);
        
        const dailySalesRef = window.doc(window.db, 'stores', currentStoreId, 'dailySales', dateStr);
        const dailySalesDoc = await window.getDoc(dailySalesRef);
        
        const currentData = dailySalesDoc.exists() ? dailySalesDoc.data() : {
          totalSales: 0,
          customerCount: 0,
          totalItems: 0,
          cashSales: 0,
          emoneSales: 0,
          creditSales: 0,
          tax8Total: 0,
          tax10Total: 0,
          totalDiscount: 0  // å€¤å¼•ãåˆè¨ˆ
        };
        
        console.log('ğŸ“Š ç¾åœ¨ã®dailySales:', currentData);
        
        const updateData = {
          totalSales: (currentData.totalSales || 0) + totalAmountToPay,
          customerCount: (currentData.customerCount || 0) + 1,
          totalItems: (currentData.totalItems || 0) + itemCount,
          cashSales: (currentData.cashSales || 0) + (selectedPaymentMethod === 'cash' ? totalAmountToPay : 0),
          emoneSales: (currentData.emoneSales || 0) + (selectedPaymentMethod === 'emoney' ? totalAmountToPay : 0),
          creditSales: (currentData.creditSales || 0) + (selectedPaymentMethod === 'credit' ? totalAmountToPay : 0),
          tax8Total: (currentData.tax8Total || 0) + tax8Total,
          tax10Total: (currentData.tax10Total || 0) + tax10Total,
          totalDiscount: (currentData.totalDiscount || 0) + discountAmount,  // å€¤å¼•ãåˆè¨ˆã«åŠ ç®—
          updatedAt: now
        };
        
        console.log('ğŸ“Š æ›´æ–°ã™ã‚‹dailySales:', updateData);
        
        await window.setDoc(dailySalesRef, updateData, { merge: true });
        
        console.log('âœ… å£²ä¸Šã‚’POSã«åæ˜ ã—ã¾ã—ãŸï¼ˆå€¤å¼•ã: Â¥' + discountAmount.toLocaleString() + 'ï¼‰');
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        let message = `ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\nå£²ä¸Š: Â¥${totalAmountToPay.toLocaleString()}`;
        if (discountAmount > 0) {
          message += `\nå€¤å¼•ã: Â¥${discountAmount.toLocaleString()}`;
        }
        message += `\nå®¢æ•°: +1\n\næ³¨æ–‡ã¯è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚`;
        
        // ğŸ†• ä¼šè¨ˆå®Œäº†æ™‚ã«ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸è¡¨ç¤ºã®é¸æŠè‚¢ã‚’è¡¨ç¤º
        const checkoutData = {
          totalAmount: totalAmountToPay,
          discountAmount: discountAmount,
          originalAmount: totalBeforeDiscount,
          paymentMethod: paymentMethodJP,
          tax8Total: tax8Total,
          tax10Total: tax10Total,
          orders: ordersToProcess,
          timestamp: now
        };
        
        await showCheckoutCompleteOptions(checkoutData);
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closePaymentModal();
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’æ›´æ–°
        await loadTables();
      } catch (error) {
        console.error('âŒ ä¼šè¨ˆå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert({ 
          icon: 'âŒ', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'ä¼šè¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    // ğŸ†• ä¼šè¨ˆå®Œäº†å¾Œã«ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸è¡¨ç¤ºã®é¸æŠè‚¢ã‚’è¡¨ç¤º
    async function showCheckoutCompleteOptions(checkoutData) {
      return new Promise((resolve) => {
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.6);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 100000;
        `;
        
        const content = document.createElement('div');
        content.style.cssText = `
          background: white;
          border-radius: 20px;
          padding: 30px;
          max-width: 400px;
          width: 90%;
          box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        `;
        
        let message = `ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸ\n\nå£²ä¸Š: Â¥${checkoutData.totalAmount.toLocaleString()}`;
        if (checkoutData.discountAmount > 0) {
          message += `\nå€¤å¼•ã: Â¥${checkoutData.discountAmount.toLocaleString()}`;
        }
        message += `\nå®¢æ•°: +1`;
        
        content.innerHTML = `
          <div style="text-align: center; margin-bottom: 20px;">
            <div style="font-size: 50px; margin-bottom: 10px;">âœ…</div>
            <div style="font-size: 20px; font-weight: bold; margin-bottom: 10px;">ä¼šè¨ˆå®Œäº†</div>
            <div style="white-space: pre-line; color: #666; line-height: 1.6;">${message}</div>
          </div>
          <div style="display: flex; flex-direction: column; gap: 10px;">
            <button id="printReceiptBtn" style="
              padding: 15px;
              background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
              color: white;
              border: none;
              border-radius: 10px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
            ">ğŸ“„ ãƒ¬ã‚·ãƒ¼ãƒˆè¡¨ç¤º</button>
            <button id="printInvoiceBtn" style="
              padding: 15px;
              background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
              color: white;
              border: none;
              border-radius: 10px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
            ">ğŸ§¾ é ˜åæ›¸è¡¨ç¤º</button>
            <button id="closeCheckoutBtn" style="
              padding: 15px;
              background: linear-gradient(135deg, #9E9E9E 0%, #757575 100%);
              color: white;
              border: none;
              border-radius: 10px;
              font-size: 16px;
              font-weight: bold;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(158, 158, 158, 0.3);
            ">é–‰ã˜ã‚‹</button>
          </div>
        `;
        
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        // ãƒ¬ã‚·ãƒ¼ãƒˆè¡¨ç¤ºãƒœã‚¿ãƒ³
        document.getElementById('printReceiptBtn').onclick = async () => {
          playTapSound();
          await printCheckoutReceipt(checkoutData);
        };
        
        // é ˜åæ›¸è¡¨ç¤ºãƒœã‚¿ãƒ³
        document.getElementById('printInvoiceBtn').onclick = async () => {
          playTapSound();
          await printCheckoutInvoice(checkoutData);
        };
        
        // é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
        document.getElementById('closeCheckoutBtn').onclick = () => {
          playTapSound();
          document.body.removeChild(modal);
          resolve();
        };
      });
    }
    
    // ğŸ†• ä¼šè¨ˆå¾Œã®ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·
    async function printCheckoutReceipt(checkoutData) {
      try {
        console.log('ãƒ¬ã‚·ãƒ¼ãƒˆè¡¨ç¤ºé–‹å§‹', checkoutData);
        
        // ğŸ”§ ä¿®æ­£: ordersã‹ã‚‰æ³¨æ–‡ç•ªå·ã‚’å–å¾—
        let orderNumber = null;
        
        if (checkoutData.orders && Array.isArray(checkoutData.orders) && checkoutData.orders.length > 0) {
          // æœ€åˆã®æ³¨æ–‡ã®æ³¨æ–‡ç•ªå·ã‚’ä½¿ç”¨
          orderNumber = checkoutData.orders[0].orderNumber;
          console.log('âœ… orders[0].orderNumberã‹ã‚‰å–å¾—:', orderNumber);
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        if (!orderNumber) {
          orderNumber = checkoutData.orderNum || 
                       checkoutData.orderNumber || 
                       checkoutData.orderNo ||
                       (window.currentOrderNumber ? window.currentOrderNumber : null);
        }
        
        // ãã‚Œã§ã‚‚ãªã„å ´åˆã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ™ãƒ¼ã‚¹ã®ç•ªå·ã‚’ç”Ÿæˆ
        if (!orderNumber) {
          orderNumber = Date.now().toString().slice(-6);
          console.warn('âš ï¸ æ³¨æ–‡ç•ªå·ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ä»®ç•ªå·ã‚’ç”Ÿæˆ:', orderNumber);
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã‚’å–å¾—
        let tableNumber = null;
        if (checkoutData.orders && Array.isArray(checkoutData.orders) && checkoutData.orders.length > 0) {
          tableNumber = checkoutData.orders[0].tableNumber;
        }
        
        const receiptData = {
          orderNum: orderNumber,
          orderNumber: orderNumber,
          tableNumber: tableNumber || '',
          items: [],
          tax8Total: checkoutData.tax8Total || 0,
          tax10Total: checkoutData.tax10Total || 0,
          total: checkoutData.totalAmount,
          timestamp: checkoutData.timestamp ? (checkoutData.timestamp.toDate ? checkoutData.timestamp.toDate().getTime() : checkoutData.timestamp) : Date.now()
        };
        
        // å•†å“ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢
        if (checkoutData.orders && Array.isArray(checkoutData.orders)) {
          checkoutData.orders.forEach(order => {
            if (order.items && Array.isArray(order.items)) {
              order.items.forEach(item => {
                receiptData.items.push({
                  name: item.name,
                  toppings: item.toppings || 'ãªã—',
                  price: item.price + (item.toppingPrice || 0),
                  quantity: item.quantity
                });
              });
            }
          });
        }
        
        showReceiptDisplay(receiptData);
        await openCashDrawer();
        
      } catch (e) {
        console.error('ãƒ¬ã‚·ãƒ¼ãƒˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({
          icon: '',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'ãƒ¬ã‚·ãƒ¼ãƒˆè¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message,
          btnClass: 'modal-btn-danger'
        });
      }
    }
    
    // ğŸ†• ä¼šè¨ˆå¾Œã®é ˜åæ›¸å°åˆ·
    async function printCheckoutInvoice(checkoutData) {
      try {
        console.log('é ˜åæ›¸è¡¨ç¤ºé–‹å§‹', checkoutData);
        
        // ğŸ”§ ä¿®æ­£: ordersã‹ã‚‰æ³¨æ–‡ç•ªå·ã‚’å–å¾—
        let orderNumber = null;
        
        if (checkoutData.orders && Array.isArray(checkoutData.orders) && checkoutData.orders.length > 0) {
          // æœ€åˆã®æ³¨æ–‡ã®æ³¨æ–‡ç•ªå·ã‚’ä½¿ç”¨
          orderNumber = checkoutData.orders[0].orderNumber;
          console.log('âœ… orders[0].orderNumberã‹ã‚‰å–å¾—:', orderNumber);
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        if (!orderNumber) {
          orderNumber = checkoutData.orderNum || 
                       checkoutData.orderNumber || 
                       checkoutData.orderNo ||
                       (window.currentOrderNumber ? window.currentOrderNumber : null);
        }
        
        // ãã‚Œã§ã‚‚ãªã„å ´åˆã¯ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒ™ãƒ¼ã‚¹ã®ç•ªå·ã‚’ç”Ÿæˆ
        if (!orderNumber) {
          orderNumber = Date.now().toString().slice(-6);
          console.warn('âš ï¸ æ³¨æ–‡ç•ªå·ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ä»®ç•ªå·ã‚’ç”Ÿæˆ:', orderNumber);
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã‚’å–å¾—
        let tableNumber = null;
        if (checkoutData.orders && Array.isArray(checkoutData.orders) && checkoutData.orders.length > 0) {
          tableNumber = checkoutData.orders[0].tableNumber;
        }
        
        const invoiceData = {
          orderNum: orderNumber,
          orderNumber: orderNumber,
          tableNumber: tableNumber || '',
          tax8Total: checkoutData.tax8Total || 0,
          tax10Total: checkoutData.tax10Total || 0,
          total: checkoutData.totalAmount,
          timestamp: checkoutData.timestamp ? (checkoutData.timestamp.toDate ? checkoutData.timestamp.toDate().getTime() : checkoutData.timestamp) : Date.now()
        };
        
        showInvoiceDisplay(invoiceData);
        await openCashDrawer();
        
      } catch (e) {
        console.error('é ˜åæ›¸è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({
          icon: '',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'é ˜åæ›¸è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message,
          btnClass: 'modal-btn-danger'
        });
      }
    }
    
    // å–¶æ¥­æ—¥ã®æ—¥ä»˜æ–‡å­—åˆ—ã‚’å–å¾—ï¼ˆ3æ™‚åŸºæº–ï¼‰
    function getBusinessDateStr() {
      const now = new Date();
      let businessDate = new Date(now);
      
      // åˆå‰3æ™‚å‰ãªã‚‰å‰æ—¥ã¨ã™ã‚‹
      if (now.getHours() < 3) {
        businessDate.setDate(businessDate.getDate() - 1);
      }
      
      const year = businessDate.getFullYear();
      const month = String(businessDate.getMonth() + 1).padStart(2, '0');
      const day = String(businessDate.getDate()).padStart(2, '0');
      const dateStr = `${year}-${month}-${day}`;
      
      console.log('ğŸ“… å–¶æ¥­æ—¥è¨ˆç®—:', {
        ç¾åœ¨æ™‚åˆ»: now.toLocaleString('ja-JP'),
        æ™‚: now.getHours(),
        å–¶æ¥­æ—¥: dateStr
      });
      
      return dateStr;
    }
    
    // å®Œäº†å‡¦ç†ï¼ˆPOSã®completedAtã«åˆã‚ã›ã‚‹ï¼‰- ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§å®Œçµ
    window.completeOrdersForTable = async function() {
      try {
        playTapSound();
        const now = window.Timestamp.now();
        
        // window.ordersToCheckoutã‹ã‚‰å®Œäº†å¯¾è±¡ã®æ³¨æ–‡ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°currentOrdersï¼‰
        const ordersToComplete = window.ordersToCheckout || currentOrders;
        
        console.log('âœ… å®Œäº†å‡¦ç†é–‹å§‹:', {
          ordersCount: ordersToComplete.length,
          orderIds: ordersToComplete.map(o => o.id)
        });
        
        // ğŸ†• åœ¨åº«ã‚’æ¸›ã‚‰ã™å‡¦ç†
        for (const order of ordersToComplete) {
          // æ³¨æ–‡ã‚’å®Œäº†ã«ã™ã‚‹
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          await window.updateDoc(orderRef, { 
            completedAt: now
          });
          console.log('âœ… æ³¨æ–‡ã‚’å®Œäº†:', order.id);
          
          // ğŸ†• åœ¨åº«ã‚’æ¸›ã‚‰ã™
          if (order.items && Array.isArray(order.items)) {
            try {
              // åœ¨åº«è¨­å®šã‚’å–å¾—
              const inventoryRef = window.doc(window.db, 'stores', currentStoreId, 'inventory_settings', 'default');
              const inventoryDoc = await window.getDoc(inventoryRef);
              
              if (inventoryDoc.exists()) {
                const inventoryData = inventoryDoc.data().items || {};
                let hasChanges = false;
                
                // å„å•†å“ã®åœ¨åº«ã‚’æ¸›ã‚‰ã™
                for (const item of order.items) {
                  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å•†å“IDã‚’å–å¾—ï¼ˆåå‰ã§æ¤œç´¢ï¼‰
                  const menuSnapshot = await window.getDocs(window.collection(window.db, 'stores', currentStoreId, 'menus'));
                  let menuId = null;
                  
                  menuSnapshot.forEach(doc => {
                    const menuData = doc.data();
                    if (menuData.name === item.name) {
                      menuId = menuData.id || doc.id;
                    }
                  });
                  
                  if (menuId && inventoryData[menuId]) {
                    const currentStock = inventoryData[menuId].stock;
                    if (currentStock !== undefined && currentStock !== null) {
                      // åœ¨åº«ã‚’æ¸›ã‚‰ã™
                      const quantity = item.quantity || 1;
                      const newStock = Math.max(0, currentStock - quantity);
                      inventoryData[menuId].stock = newStock;
                      hasChanges = true;
                      
                      console.log(` åœ¨åº«æ¸›ç®—: ${item.name} (${menuId}) ${currentStock} â†’ ${newStock} (-${quantity})`);
                    }
                  }
                }
                
                // å¤‰æ›´ãŒã‚ã‚Œã°ä¿å­˜
                if (hasChanges) {
                  await window.setDoc(inventoryRef, {
                    items: inventoryData,
                    updatedAt: new Date().toISOString()
                  });
                  console.log('âœ… åœ¨åº«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                }
              }
            } catch (inventoryError) {
              console.error('âš  åœ¨åº«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', inventoryError);
              // åœ¨åº«æ›´æ–°ã‚¨ãƒ©ãƒ¼ã¯è‡´å‘½çš„ã§ãªã„ãŸã‚ç¶šè¡Œ
            }
          }
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closePaymentModal();
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’æ›´æ–°ï¼ˆFirestoreã®å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤ï¼‰
        await new Promise(resolve => setTimeout(resolve, 500));
        
        await showCustomAlert({ 
          icon: 'âœ…', 
          title: 'å®Œäº†', 
          message: 'æ³¨æ–‡ã‚’å®Œäº†ã«ã—ã¾ã—ãŸã€‚', 
          btnClass: 'modal-btn-success' 
        });
      } catch (error) {
        console.error('âŒ å®Œäº†å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert({ 
          icon: 'âŒ', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'å®Œäº†å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç† - ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§å®Œçµ
    window.cancelOrdersForTable = async function() {
      try {
        playTapSound();
        const now = window.Timestamp.now();
        
        // window.ordersToCheckoutã‹ã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯¾è±¡ã®æ³¨æ–‡ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°currentOrdersï¼‰
        const ordersToCancel = window.ordersToCheckout || currentOrders;
        
        console.log('â¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†é–‹å§‹:', {
          ordersCount: ordersToCancel.length,
          orderIds: ordersToCancel.map(o => o.id)
        });
        
        for (const order of ordersToCancel) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          await window.updateDoc(orderRef, { 
            cancelledAt: now
          });
          console.log('âœ… æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«:', order.id);
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closePaymentModal();
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆFirestoreã®å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤ï¼‰
        await new Promise(resolve => setTimeout(resolve, 500));
        
        await showCustomAlert({ 
          icon: 'â¸', 
          title: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†', 
          message: 'æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚', 
          btnClass: 'modal-btn-success' 
        });
      } catch (error) {
        console.error('âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert({ 
          icon: 'âŒ', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };

    // å‰Šé™¤å‡¦ç† - ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§å®Œçµ
    window.deleteOrdersForTable = async function() {
      try {
        playTapSound();
        
        // window.ordersToCheckoutã‹ã‚‰å‰Šé™¤å¯¾è±¡ã®æ³¨æ–‡ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°currentOrdersï¼‰
        const ordersToDelete = window.ordersToCheckout || currentOrders;
        
        console.log('ğŸ—‘ å‰Šé™¤å‡¦ç†é–‹å§‹:', {
          ordersCount: ordersToDelete.length,
          orderIds: ordersToDelete.map(o => o.id)
        });
        
        for (const order of ordersToDelete) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          // Firestoreã‹ã‚‰å®Œå…¨ã«å‰Šé™¤ï¼ˆPOSã‹ã‚‰ã‚‚æ¶ˆãˆã‚‹ï¼‰
          await window.deleteDoc(orderRef);
          console.log('âœ… æ³¨æ–‡ã‚’å‰Šé™¤:', order.id);
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closePaymentModal();
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆFirestoreã®å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤ï¼‰
        await new Promise(resolve => setTimeout(resolve, 500));
        
        await showCustomAlert({ 
          icon: 'âœ…', 
          title: 'å‰Šé™¤å®Œäº†', 
          message: 'æ³¨æ–‡ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã—ãŸã€‚\nPOSã‹ã‚‰ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚', 
          btnClass: 'modal-btn-success' 
        });
      } catch (error) {
        console.error('âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert({ 
          icon: 'âŒ', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };

    window.addEventListener('DOMContentLoaded', async () => {
      while (!window.firebaseReady || !window.db) await new Promise(r => setTimeout(r, 100));
      await loadStoreList();
      if (sessionStorage.getItem('handyStoreId')) {
        currentStoreId = sessionStorage.getItem('handyStoreId');
        window.currentStoreId = currentStoreId; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦è¨­å®š
        currentStoreName = sessionStorage.getItem('handyStoreName');
        
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('ğŸ“ HANDY ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰åº—èˆ—IDå¾©å…ƒ');
        console.log('   currentStoreId:', currentStoreId);
        console.log('   window.currentStoreId:', window.currentStoreId);
        console.log('   currentStoreName:', currentStoreName);
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        
        showTablesScreen();
      }
    });
    
    // ==========  ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åœ¨åº«ãƒ‘ãƒãƒ« ==========
    
    // åœ¨åº«ãƒ‘ãƒãƒ«ã‚’æ›´æ–°
    async function updateInventoryPanel() {
      try {
        console.log(' åœ¨åº«ãƒ‘ãƒãƒ«ã‚’æ›´æ–°ä¸­...');
        
        // inventory_settings ã‚’å–å¾—
        let inventorySettingsRef;
        if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
          inventorySettingsRef = window.doc(window.db, 'inventory_settings', 'default');
        } else {
          inventorySettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
        }
        
        const inventorySettingsSnap = await window.getDoc(inventorySettingsRef);
        
        if (!inventorySettingsSnap.exists()) {
          console.log('âš  åœ¨åº«è¨­å®šãŒå­˜åœ¨ã—ã¾ã›ã‚“');
          document.getElementById('inventoryPanelContent').innerHTML = '<div style="padding: 10px; text-align: center; color: #999;">åœ¨åº«è¨­å®šãªã—</div>';
          // ãƒãƒ¼ã®è‰²ã‚’é€šå¸¸ã«æˆ»ã™
          document.getElementById('inventoryPanelBar').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          return;
        }
        
        const inventorySettingsData = inventorySettingsSnap.data();
        const inventoryItems = inventorySettingsData.items || {};
        
        // menusã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å•†å“åã‚’å–å¾—
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        const idToNameMap = {};
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          const itemId = data.id || doc.id;
          if (data.name) {
            idToNameMap[itemId] = data.name;
          }
        });
        
        // åœ¨åº«ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å•†å“ã®ã¿è¡¨ç¤ºï¼ˆåœ¨åº«å°‘ãƒ»å“åˆ‡ã‚Œã‚’å„ªå…ˆï¼‰
        const lowStockItems = [];
        const outOfStockItems = [];
        const normalStockItems = [];
        
        for (const [itemId, settings] of Object.entries(inventoryItems)) {
          const stock = settings.stock;
          const alertThreshold = settings.alertThreshold;
          const itemName = idToNameMap[itemId] || itemId;
          
          // stockãŒnullã§ãªã„ï¼ˆåœ¨åº«ç®¡ç†å¯¾è±¡ï¼‰å ´åˆã®ã¿è¡¨ç¤º
          if (stock !== null && stock !== undefined) {
            const item = { id: itemId, name: itemName, stock, alertThreshold };
            
            if (stock === 0) {
              outOfStockItems.push(item);
            } else if (alertThreshold !== null && alertThreshold !== undefined && stock <= alertThreshold) {
              lowStockItems.push(item);
            } else {
              normalStockItems.push(item);
            }
          }
        }
        
        // ğŸ†• ãƒãƒ¼ã®è‰²ã‚’åœ¨åº«çŠ¶æ…‹ã«å¿œã˜ã¦å¤‰æ›´
        const panelBar = document.getElementById('inventoryPanelBar');
        if (outOfStockItems.length > 0) {
          // åœ¨åº«åˆ‡ã‚ŒãŒã‚ã‚‹å ´åˆã¯èµ¤
          panelBar.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
        } else if (lowStockItems.length > 0) {
          // åœ¨åº«å°‘ãŒã‚ã‚‹å ´åˆã¯é»„è‰²
          panelBar.style.background = 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
        } else {
          // å•é¡Œãªã—ã®å ´åˆã¯ç´«ï¼ˆé€šå¸¸ï¼‰
          panelBar.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        }
        
        // è¡¨ç¤ºç”¨HTMLç”Ÿæˆ
        let html = '';
        
        // å“åˆ‡ã‚Œï¼ˆèµ¤ï¼‰
        outOfStockItems.forEach(item => {
          html += `
            <div style="padding: 8px 12px; background: #ffebee; border-left: 4px solid #f44336; margin-bottom: 6px; border-radius: 4px;">
              <div style="font-weight: bold; color: #f44336; font-size: 14px;">${item.name}</div>
              <div style="color: #f44336; font-size: 13px; font-weight: bold;">å“åˆ‡</div>
            </div>
          `;
        });
        
        // åœ¨åº«å°‘ï¼ˆé»„ï¼‰
        lowStockItems.forEach(item => {
          html += `
            <div style="padding: 8px 12px; background: #fff9e6; border-left: 4px solid #ff9800; margin-bottom: 6px; border-radius: 4px;">
              <div style="font-weight: bold; color: #ff9800; font-size: 14px;">${item.name}</div>
              <div style="color: #ff9800; font-size: 13px;">æ®‹ ${item.stock}</div>
            </div>
          `;
        });
        
        if (html === '') {
          html = '<div style="padding: 10px; text-align: center; color: #4caf50; font-weight: bold;">åœ¨åº«å……åˆ†âœ“</div>';
        }
        
        document.getElementById('inventoryPanelContent').innerHTML = html;
        console.log('âœ… åœ¨åº«ãƒ‘ãƒãƒ«æ›´æ–°å®Œäº†');
        
      } catch (error) {
        console.error('âŒ åœ¨åº«ãƒ‘ãƒãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // åœ¨åº«ãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    function toggleInventoryPanel() {
      const panel = document.getElementById('inventoryPanel');
      const arrow = document.getElementById('inventoryPanelArrow');
      const isCollapsed = panel.classList.contains('collapsed');
      
      if (isCollapsed) {
        panel.classList.remove('collapsed');
        panel.style.maxHeight = '400px';
        arrow.textContent = 'â–¼';
      } else {
        panel.classList.add('collapsed');
        panel.style.maxHeight = '45px';
        arrow.textContent = 'â–²';
      }
    }
    
    // inventory_settingsã®å¤‰æ›´ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
    function watchInventoryChanges() {
      let inventorySettingsRef;
      if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
        inventorySettingsRef = window.doc(window.db, 'inventory_settings', 'default');
      } else {
        inventorySettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
      }
      
      const unsubscribe = window.onSnapshot(inventorySettingsRef, (doc) => {
        if (doc.exists()) {
          console.log(' åœ¨åº«ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ');
          updateInventoryPanel();
        }
      });
      
      return unsubscribe;
    }
    
    // ========== ğŸ†• POSãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ ==========
    
    // ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’localStorageã«ä¿å­˜
    window.saveLoginInfo = function(storeId, password) {
      localStorage.setItem('handy_storeId', storeId);
      localStorage.setItem('handy_password', password);
    };
    
    // ä¿å­˜ã•ã‚ŒãŸãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å–å¾—
    window.getSavedLoginInfo = function() {
      return {
        storeId: localStorage.getItem('handy_storeId'),
        password: localStorage.getItem('handy_password')
      };
    };
    
    // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãƒˆã‚°ãƒ«
    function toggleFunctionsMenu() {
      const menu = document.getElementById('functionsSubMenu');
      if (menu.style.display === 'none' || menu.style.display === '') {
        menu.style.display = 'block';
      } else {
        menu.style.display = 'none';
      }
    }
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
    document.addEventListener('click', function(e) {
      const menu = document.getElementById('functionsSubMenu');
      const btn = e.target.closest('.sales-btn');
      if (menu && menu.style.display === 'block' && !menu.contains(e.target) && !btn) {
        menu.style.display = 'none';
      }
    });
    
    // POSãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openPOSModal = function(modalType) {
      const modal = document.getElementById('posIframeModal');
      const iframe = document.getElementById('posIframe');
      const title = document.getElementById('posModalTitle');
      
      // ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
      const titles = {
        'sales': 'å£²ä¸Š',
        'expense': 'æ”¯å‡º',
        'monthly': 'æœˆæ¬¡',
        'history': 'å±¥æ­´',
        'printer': 'ãƒ—ãƒªãƒ³ã‚¿è¨­å®š'
      };
      title.textContent = titles[modalType] || 'POSæ©Ÿèƒ½';
      
      // ä¿å­˜ã•ã‚ŒãŸãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å–å¾—
      const loginInfo = window.getSavedLoginInfo();
      
      // URLã‚’æ§‹ç¯‰
      let url = 'https://gymnastmasaki-lang.github.io/takoyaki-/pos.html';
      const params = new URLSearchParams();
      
      params.append('modal', modalType);
      
      // ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¿½åŠ 
      if (loginInfo.storeId && loginInfo.password) {
        params.append('storeId', loginInfo.storeId);
        params.append('password', loginInfo.password);
        params.append('autoLogin', 'true');
      }
      
      if (params.toString()) {
        url += '?' + params.toString();
      }
      
      iframe.src = url;
      modal.classList.add('active');
      
      // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
    };
    
    // ãƒ‰ãƒ­ã‚¢é–‹ã‚’ç›´æ¥å®Ÿè¡Œ
    window.openDrawerDirect = async function() {
      try {
        const now = new Date();
        const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          const currentCount = data.drawerOpenCount || 0;
          await window.updateDoc(salesRef, {
            drawerOpenCount: currentCount + 1,
            updatedAt: window.Timestamp.now()
          });
        } else {
          await window.setDoc(salesRef, {
            date: dateStr,
            totalSales: 0,
            customerCount: 0,
            drawerOpenCount: 1,
            createdAt: window.Timestamp.now(),
            updatedAt: window.Timestamp.now()
          });
        }
        
        await showCustomAlert({ 
          icon: '', 
          title: 'å®Œäº†', 
          message: 'ãƒ‰ãƒ­ã‚¢ã‚’é–‹ãã¾ã—ãŸ', 
          btnClass: 'modal-btn-success' 
        });
        
        // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
        const menu = document.getElementById('functionsSubMenu');
        if (menu) {
          menu.style.display = 'none';
        }
      } catch (e) {
        console.error('ãƒ‰ãƒ­ã‚¢é–‹ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({ 
          icon: '', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    // ğŸ†• å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ç›´æ¥è¡¨ç¤º
    
    // ğŸ†• å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeSalesModal = function() {
      document.getElementById('salesModal').style.display = 'none';
    };
    
    // POSãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closePOSModal = function() {
      const modal = document.getElementById('posIframeModal');
      const iframe = document.getElementById('posIframe');
      
      modal.classList.remove('active');
      // iframeã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ¡ãƒ¢ãƒªè§£æ”¾ï¼‰
      setTimeout(() => {
        iframe.src = 'about:blank';
      }, 300);
    };
    
    // ==========  å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ ==========
    
    // å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showSalesModal = function() {
      document.getElementById('salesModal').style.display = 'flex';
      
      // ğŸ†• æ—¥è¨ˆè¡¨ã®æœˆé¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆéå»12ãƒ¶æœˆåˆ†ï¼‰
      const monthSelect = document.getElementById('dailyReportMonth');
      if (monthSelect) {
        monthSelect.innerHTML = '';
        const now = new Date();
        for (let i = 0; i < 12; i++) {
          const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const year = targetDate.getFullYear();
          const month = targetDate.getMonth() + 1;
          const option = document.createElement('option');
          option.value = `${year}-${String(month).padStart(2, '0')}`;
          option.textContent = `${year}å¹´${month}æœˆ`;
          if (i === 0) option.selected = true;
          monthSelect.appendChild(option);
        }
      }
      
      calculateSales();
      
      // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
    };
    
    // å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeSalesModal = function() {
      document.getElementById('salesModal').style.display = 'none';
    };
    
    // å£²ä¸Šã‚’è¨ˆç®—ï¼ˆæ‹¡å¼µç‰ˆ - æ”¯æ‰•æ–¹æ³•åˆ¥ã€ç›®æ¨™é”æˆç‡ã€ç´”åˆ©ç›Šï¼‰
    window.calculateSales = async function() {
      const container = document.getElementById('salesContent');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">é›†è¨ˆä¸­...</div>';
      
      try {
        // æœ¬æ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆ3æ™‚åŸºæº–ï¼‰
        const now = new Date();
        let today = new Date(now);
        if (now.getHours() < 3) {
          today.setDate(today.getDate() - 1);
        }
        const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
        
        console.log('ğŸ“Š å£²ä¸Šå–å¾—æ—¥ä»˜:', dateStr);
        
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        let totalSales = 0;
        let cashSales = 0;
        let emoneSales = 0;
        let creditSales = 0;
        let orderCount = 0;
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          console.log(' å£²ä¸Šãƒ‡ãƒ¼ã‚¿:', data);
          totalSales = data.totalSales || 0;
          cashSales = data.cashSales || 0;
          emoneSales = data.emoneSales || 0;
          creditSales = data.creditSales || 0;
          orderCount = data.customerCount || 0;
        } else {
          console.log('âš  å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
        }
        
        // äººä»¶è²»ã‚’å–å¾—
        let todayLaborCost = 0;
        try {
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.date === dateStr) {
              if (data.totalWage && data.totalWage > 0) {
                todayLaborCost += data.totalWage;
              } else if (data.clockIn && data.clockOut) {
                const clockIn = new Date(`${dateStr} ${data.clockIn}`);
                const clockOut = new Date(`${dateStr} ${data.clockOut}`);
                let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                
                if (data.breakStart1 && data.breakEnd1) {
                  const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                  const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                  workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                }
                if (data.breakStart2 && data.breakEnd2) {
                  const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                  const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                  workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                }
                
                const hourlyRate = data.hourlyRate || 1150;
                todayLaborCost += workHours * hourlyRate;
              }
            }
          });
        } catch (e) {
          console.error('äººä»¶è²»å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        }
        
        // æ”¯å‡ºã‚’å–å¾—
        let todayExpense = 0;
        try {
          const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
          if (expenseDoc.exists()) {
            todayExpense = expenseDoc.data().total || 0;
          }
        } catch (e) {
          console.error('æ”¯å‡ºå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        }
        
        // ç´”åˆ©ç›Šè¨ˆç®—
        const grossProfit = totalSales - todayLaborCost;
        const netProfit = totalSales - todayLaborCost - todayExpense;
        const netProfitRate = totalSales > 0 ? (netProfit / totalSales * 100).toFixed(1) : 0;
        const laborCostRate = totalSales > 0 ? (todayLaborCost / totalSales * 100).toFixed(1) : 0;
        const expenseRate = totalSales > 0 ? (todayExpense / totalSales * 100).toFixed(1) : 0;
        
        // å£²ä¸Šç›®æ¨™é”æˆç‡
        const dayOfWeek = today.getDay();
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
        const targetSales = isWeekend ? 70000 : 50000;
        const achievementRate = Math.round((totalSales / targetSales) * 100);
        const rateColor = achievementRate >= 100 ? '#4CAF50' : achievementRate >= 80 ? '#FF9800' : '#f44336';
        const netProfitColor = netProfit >= 0 ? '#4CAF50' : '#f44336';
        
        container.innerHTML = `
          <div style="background: white; border-radius: 12px; padding: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
              <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;">ç·å£²ä¸Š</div>
                <div style="font-size: 28px; font-weight: bold;">Â¥${totalSales.toLocaleString()}</div>
              </div>
              <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;">å®¢æ•°</div>
                <div style="font-size: 28px; font-weight: bold;">${orderCount}ä»¶</div>
              </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
              <h4 style="margin: 0 0 10px 0;">å£²ä¸Šç›®æ¨™</h4>
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>ç›®æ¨™é‡‘é¡ï¼ˆ${isWeekend ? 'åœŸæ—¥ç¥' : 'å¹³æ—¥'}ï¼‰</span>
                <strong>Â¥${targetSales.toLocaleString()}</strong>
              </div>
              <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 32px; font-weight: bold; color: ${rateColor};">${achievementRate}%</div>
                <div style="font-size: 14px; opacity: 0.9;">é”æˆç‡</div>
              </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #FF6B6B 0%, #C92A2A 100%); border-radius: 10px; color: white;">
              <h4 style="margin: 0 0 15px 0;">æœ¬æ—¥ã®ç´”åˆ©ç›Š</h4>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                <span>å£²ä¸Š</span>
                <strong>Â¥${totalSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                <span>âˆ’ äººä»¶è²»${totalSales > 0 ? 'ï¼ˆ' + laborCostRate + '%ï¼‰' : ''}</span>
                <strong>Â¥${Math.round(todayLaborCost).toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px;">
                <span>âˆ’ æ”¯å‡º${totalSales > 0 ? 'ï¼ˆ' + expenseRate + '%ï¼‰' : ''}</span>
                <strong>Â¥${Math.round(todayExpense).toLocaleString()}</strong>
              </div>
              <div style="border-top: 2px solid rgba(255,255,255,0.3); padding-top: 12px;">
                <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                  <div style="font-size: 16px; opacity: 0.9; margin-bottom: 5px;">ç´”åˆ©ç›Š</div>
                  <div style="font-size: 32px; font-weight: bold; color: ${netProfitColor};">Â¥${Math.round(netProfit).toLocaleString()}</div>
                  <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">ç´”åˆ©ç›Šç‡: ${netProfitRate}%</div>
                </div>
              </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
              <h4 style="margin: 0 0 15px 0;">æ”¯æ‰•ã„æ–¹æ³•åˆ¥</h4>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>ç¾é‡‘</span>
                <strong>Â¥${cashSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>ã‚«ãƒ¼ãƒ‰</span>
                <strong>Â¥${creditSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span>é›»å­ãƒãƒãƒ¼</span>
                <strong>Â¥${emoneSales.toLocaleString()}</strong>
              </div>
            </div>
            
            <div style="margin-top: 20px; display: flex; flex-direction: column; gap: 10px;">
              <button onclick="playTapSound(); executeDailySettlement()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(255,107,107,0.3);">
                ç²¾ç®—ã‚’å®Ÿè¡Œ
              </button>
              <div style="margin-bottom: 10px;">
                <label style="display: block; margin-bottom: 5px; color: #333; font-weight: bold;">æ—¥è¨ˆè¡¨å‡ºåŠ›ã™ã‚‹æœˆã‚’é¸æŠ:</label>
                <select id="dailyReportMonth" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px;">
                  <!-- éå»12ãƒ¶æœˆåˆ†ã®é¸æŠè‚¢ã‚’å‹•çš„ã«ç”Ÿæˆ -->
                </select>
                <button onclick="playTapSound(); generateDailyReportForSelectedMonth()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(76,175,80,0.3);">
                  æ—¥è¨ˆè¡¨å‡ºåŠ›
                </button>
              </div>
            </div>
          </div>
        `;
        
        // ğŸ†• æœˆé¸æŠè‚¢ã‚’å†ç”Ÿæˆï¼ˆHTMLã‚’å†æ§‹ç¯‰ã—ãŸå¾Œï¼‰
        const monthSelect = document.getElementById('dailyReportMonth');
        if (monthSelect) {
          monthSelect.innerHTML = '';
          const now = new Date();
          for (let i = 0; i < 12; i++) {
            const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
            const year = targetDate.getFullYear();
            const month = targetDate.getMonth() + 1;
            const option = document.createElement('option');
            option.value = `${year}-${String(month).padStart(2, '0')}`;
            option.textContent = `${year}å¹´${month}æœˆ`;
            if (i === 0) option.selected = true;
            monthSelect.appendChild(option);
          }
        }
        
      } catch (e) {
        console.error('å£²ä¸Šè¨ˆç®—ã‚¨ãƒ©ãƒ¼:', e);
        container.innerHTML = '<div style="text-align: center; color: red; padding: 20px;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    };
    
    // ==========  ç²¾ç®—æ©Ÿèƒ½ ==========
    
    // ğŸ†• è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–¢æ•°
    window.createAutoBackup = async function() {
      try {
        console.log('ğŸ”„ è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–‹å§‹ï¼ˆ7æ—¥ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰');
        
        const { getDocs, setDoc, doc, Timestamp } = window;
        const today = new Date();
        const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
        
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
        const backupData = {
          timestamp: Timestamp.now(),
          date: dateStr,
          type: 'auto',
          data: {}
        };
        
        // 1. å•†å“ãƒ‡ãƒ¼ã‚¿ï¼ˆmenusï¼‰
        const menusSnapshot = await getDocs(window.getStoreCollection('menus'));
        backupData.data.menus = [];
        menusSnapshot.forEach(docSnap => {
          backupData.data.menus.push({
            id: docSnap.id,
            ...docSnap.data()
          });
        });
        console.log(`ğŸ“¦ å•†å“: ${backupData.data.menus.length}ä»¶`);
        
        // 2. å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ï¼ˆemployeesï¼‰
        const employeesSnapshot = await getDocs(window.getStoreCollection('employees'));
        backupData.data.employees = [];
        employeesSnapshot.forEach(docSnap => {
          backupData.data.employees.push({
            id: docSnap.id,
            ...docSnap.data()
          });
        });
        console.log(`ğŸ‘¥ å¾“æ¥­å“¡: ${backupData.data.employees.length}å`);
        
        // 3. æ³¨æ–‡å±¥æ­´ï¼ˆordersï¼‰- æœ€è¿‘1000ä»¶ã®ã¿
        const ordersCollection = window.getStoreCollection('orders');
        const ordersSnapshot = await getDocs(ordersCollection);
        const ordersList = [];
        ordersSnapshot.forEach(docSnap => {
          const data = docSnap.data();
          ordersList.push({
            id: docSnap.id,
            ...data,
            _timestamp: data.createdAt || data.timestamp || new Date(0)
          });
        });
        
        // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
        ordersList.sort((a, b) => {
          const timeA = a._timestamp?.toDate ? a._timestamp.toDate() : new Date(a._timestamp);
          const timeB = b._timestamp?.toDate ? b._timestamp.toDate() : new Date(b._timestamp);
          return timeB - timeA;
        });
        
        // æœ€æ–°1000ä»¶ã®ã¿ä¿å­˜
        backupData.data.orders = ordersList.slice(0, 1000).map(item => {
          const { _timestamp, ...rest } = item;
          return rest;
        });
        console.log(`ğŸ“ æ³¨æ–‡å±¥æ­´: ${backupData.data.orders.length}ä»¶`);
        
        // 4. å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ï¼ˆattendanceï¼‰- æœ€è¿‘1000ä»¶ã®ã¿
        const attendanceCollection = window.getStoreCollection('attendance');
        const attendanceSnapshot = await getDocs(attendanceCollection);
        const attendanceList = [];
        attendanceSnapshot.forEach(docSnap => {
          const data = docSnap.data();
          attendanceList.push({
            id: docSnap.id,
            ...data,
            _timestamp: data.createdAt || data.timestamp || new Date(0)
          });
        });
        
        // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
        attendanceList.sort((a, b) => {
          const timeA = a._timestamp?.toDate ? a._timestamp.toDate() : new Date(a._timestamp);
          const timeB = b._timestamp?.toDate ? b._timestamp.toDate() : new Date(b._timestamp);
          return timeB - timeA;
        });
        
        // æœ€æ–°1000ä»¶ã®ã¿ä¿å­˜
        backupData.data.attendance = attendanceList.slice(0, 1000).map(item => {
          const { _timestamp, ...rest } = item;
          return rest;
        });
        console.log(`â° å‹¤æ€ : ${backupData.data.attendance.length}ä»¶`);
        
        // 5. è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        try {
          // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š
          let tableRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            tableRef = doc(window.db, 'stores', window.currentStoreId, 'table_settings', 'default');
          } else {
            tableRef = doc(window.db, 'table_settings', 'default');
          }
          const tableDoc = await window.getDoc(tableRef);
          backupData.data.table_settings = tableDoc.exists() ? tableDoc.data() : null;
          
          // ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®š
          let receiptRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            receiptRef = doc(window.db, 'stores', window.currentStoreId, 'receipt_settings', 'default');
          } else {
            receiptRef = doc(window.db, 'receipt_settings', 'default');
          }
          const receiptDoc = await window.getDoc(receiptRef);
          backupData.data.receipt_settings = receiptDoc.exists() ? receiptDoc.data() : null;
          
          // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®š
          let menuSettingsRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            menuSettingsRef = doc(window.db, 'stores', window.currentStoreId, 'menu_settings', 'default');
          } else {
            menuSettingsRef = doc(window.db, 'menu_settings', 'default');
          }
          const menuSettingsDoc = await window.getDoc(menuSettingsRef);
          backupData.data.menu_settings = menuSettingsDoc.exists() ? menuSettingsDoc.data() : null;
          
          // åœ¨åº«è¨­å®š
          let inventoryRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            inventoryRef = doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
          } else {
            inventoryRef = doc(window.db, 'inventory_settings', 'default');
          }
          const inventoryDoc = await window.getDoc(inventoryRef);
          backupData.data.inventory_settings = inventoryDoc.exists() ? inventoryDoc.data() : null;
          
          // ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
          let alertRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            alertRef = doc(window.db, 'stores', window.currentStoreId, 'alert_settings', 'default');
          } else {
            alertRef = doc(window.db, 'alert_settings', 'default');
          }
          const alertDoc = await window.getDoc(alertRef);
          backupData.data.alert_settings = alertDoc.exists() ? alertDoc.data() : null;
          
          // å–¶æ¥­æ™‚é–“è¨­å®š
          let businessRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            businessRef = doc(window.db, 'stores', window.currentStoreId, 'business_hours', 'default');
          } else {
            businessRef = doc(window.db, 'business_hours', 'default');
          }
          const businessDoc = await window.getDoc(businessRef);
          backupData.data.business_hours = businessDoc.exists() ? businessDoc.data() : null;
          
          const settingsCount = [
            backupData.data.menu_settings,
            backupData.data.receipt_settings,
            backupData.data.inventory_settings,
            backupData.data.alert_settings,
            backupData.data.business_hours,
            backupData.data.table_settings
          ].filter(s => s !== null).length;
          
          console.log(`âš™ï¸ è¨­å®š: ${settingsCount}ç¨®é¡`);
        } catch (e) {
          console.error('è¨­å®šãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
          backupData.data.menu_settings = null;
          backupData.data.receipt_settings = null;
          backupData.data.inventory_settings = null;
          backupData.data.alert_settings = null;
          backupData.data.business_hours = null;
          backupData.data.table_settings = null;
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆå„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰
        try {
          const tablesSnapshot = await getDocs(window.getStoreCollection('tables'));
          backupData.data.tables = [];
          tablesSnapshot.forEach(docSnap => {
            backupData.data.tables.push({ id: docSnap.id, ...docSnap.data() });
          });
          console.log(`ğŸ½ï¸ ãƒ†ãƒ¼ãƒ–ãƒ«: ${backupData.data.tables.length}ä»¶`);
        } catch (e) {
          console.warn('ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—:', e.message);
          backupData.data.tables = [];
        }
        
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ï¼ˆ7æ—¥ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        const dayOfWeek = today.getDay(); // 0=æ—¥æ›œ, 1=æœˆæ›œ, ..., 6=åœŸæ›œ
        const backupId = `auto_day${dayOfWeek}`; // day0ã€œday6ã§7æ—¥ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
        
        let backupRef;
        if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
          backupRef = doc(window.db, 'stores', window.currentStoreId, 'backups', backupId);
        } else {
          backupRef = doc(window.db, 'backups', backupId);
        }
        
        await setDoc(backupRef, backupData);
        
        console.log(`âœ… è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†: ${backupId} (${dateStr})`);
        return true;
      } catch (error) {
        console.error('âŒ è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
        return false;
      }
    };
    
    window.showSettlementModal = async function() {
      // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('settlementModal').style.display = 'flex';
      
      // ğŸ†• æ—¥è¨ˆè¡¨ã®æœˆé¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆéå»12ãƒ¶æœˆåˆ†ï¼‰
      const monthSelect = document.getElementById('dailyReportMonth');
      if (monthSelect) {
        monthSelect.innerHTML = '';
        const now = new Date();
        for (let i = 0; i < 12; i++) {
          const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const year = targetDate.getFullYear();
          const month = targetDate.getMonth() + 1;
          const option = document.createElement('option');
          option.value = `${year}-${String(month).padStart(2, '0')}`;
          option.textContent = `${year}å¹´${month}æœˆ`;
          if (i === 0) option.selected = true;
          monthSelect.appendChild(option);
        }
      }
      
      // æœ¬æ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
      const now2 = new Date();
      let today = new Date(now2);
      if (now2.getHours() < 3) {
        today.setDate(today.getDate() - 1);
      }
      const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      document.getElementById('settlementDate').value = dateStr;
      
      // å£²ä¸Šã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
      await loadSettlementSummary(dateStr);
    };
    
    window.closeSettlementModal = function() {
      document.getElementById('settlementModal').style.display = 'none';
    };
    
    window.loadSettlementSummary = async function(dateStr) {
      const container = document.getElementById('settlementSummary');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">é›†è¨ˆä¸­...</div>';
      
      try {
        // æ—¥æ¬¡å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        let settlementData = {
          totalSales: 0,
          customerCount: 0,
          totalItems: 0,
          cashSales: 0,
          emoneSales: 0,
          creditSales: 0,
          totalDiscount: 0,
          tax8Total: 0,
          tax10Total: 0,
          drawerOpenCount: 0,
          redSlipCount: 0,
          redSlipAmount: 0,
          redSlipTax8Total: 0,
          redSlipTax10Total: 0
        };
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          console.log('ğŸ“Š dailySalesãƒ‡ãƒ¼ã‚¿:', data);
          console.log('ğŸ”“ drawerOpenCount:', data.drawerOpenCount);
          
          settlementData = {
            totalSales: data.totalSales || 0,
            customerCount: data.customerCount || 0,
            totalItems: data.totalItems || 0,
            cashSales: data.cashSales || 0,
            emoneSales: data.emoneSales || 0,
            creditSales: data.creditSales || 0,
            totalDiscount: data.totalDiscount || 0,
            tax8Total: data.tax8Total || 0,
            tax10Total: data.tax10Total || 0,
            drawerOpenCount: data.drawerOpenCount || 0,
            redSlipCount: data.redSlipCount || 0,
            redSlipAmount: data.redSlipAmount || 0,
            redSlipTax8Total: data.redSlipTax8Total || 0,
            redSlipTax10Total: data.redSlipTax10Total || 0
          };
          
          console.log('ğŸ“Š settlementData:', settlementData);
        }
        
        // settlementDataã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜
        window.currentSettlementData = settlementData;
        window.currentSettlementDate = dateStr;
        
        container.innerHTML = `
          <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 2px solid #ddd;">
              <span style="font-size: 16px;">ç·å£²ä¸Š</span>
              <strong style="font-size: 20px; color: #4CAF50;">Â¥${settlementData.totalSales.toLocaleString()}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
              <span>å®¢æ•°</span>
              <strong>${settlementData.customerCount}çµ„</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
              <span>ç¾é‡‘</span>
              <strong>Â¥${settlementData.cashSales.toLocaleString()}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
              <span>ã‚«ãƒ¼ãƒ‰</span>
              <strong>Â¥${settlementData.creditSales.toLocaleString()}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0;">
              <span>é›»å­ãƒãƒãƒ¼</span>
              <strong>Â¥${settlementData.emoneSales.toLocaleString()}</strong>
            </div>
          </div>
        `;
      } catch (e) {
        console.error('ç²¾ç®—ã‚µãƒãƒªãƒ¼ã‚¨ãƒ©ãƒ¼:', e);
        container.innerHTML = '<div style="text-align: center; color: red;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    }
    
    // ç²¾ç®—ã‚’å®Ÿè¡Œï¼ˆCSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
    window.confirmSettlement = async function() {
      // FirebaseåˆæœŸåŒ–ã‚’å¾…ã¤
      if (!window.firebaseReady) {
        await new Promise(resolve => {
          window.addEventListener('firebaseReady', resolve, { once: true });
        });
      }
      
      // ğŸ†• ã‚ªã‚·ãƒ£ãƒ¬ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
      const shouldBackup = await new Promise((resolve) => {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«HTMLä½œæˆ
        const modal = document.createElement('div');
        modal.id = 'backupConfirmModal';
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
          background: rgba(0,0,0,0.7); display: flex; align-items: center; 
          justify-content: center; z-index: 999999; animation: fadeIn 0.2s;
        `;
        
        modal.innerHTML = `
          <div style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px; padding: 0; max-width: 500px; width: 90%;
            max-height: 85vh; display: flex; flex-direction: column;
            box-shadow: 0 25px 60px rgba(0,0,0,0.4); overflow: hidden;
            animation: slideUp 0.3s;
          ">
            <div style="background: white; padding: 32px; border-radius: 0 0 24px 24px; overflow-y: auto; flex: 1;">
              <div style="text-align: center; margin-bottom: 24px;">
                <h3 style="font-size: 22px; font-weight: bold; color: #333; margin-bottom: 8px;">
                  ç²¾ç®—ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ
                </h3>
              </div>
              
              <div style="background: #f0f7ff; border-left: 4px solid #667eea; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                <div style="font-weight: bold; color: #667eea; margin-bottom: 10px; font-size: 15px;">ã€æ¨å¥¨: ã¯ã„ã€‘</div>
                <div style="color: #555; font-size: 13px; line-height: 1.6;">
                  ä»¥ä¸‹ãŒãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã•ã‚Œã¾ã™ï¼š<br>
                  â€¢ å•†å“<br>
                  â€¢ å¾“æ¥­å“¡<br>
                  â€¢ æ³¨æ–‡å±¥æ­´<br>
                  â€¢ å‹¤æ€ ãƒ‡ãƒ¼ã‚¿<br>
                  â€¢ å•†å“ã‚«ãƒ†ã‚´ãƒªè¨­å®š<br>
                  â€¢ ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®š<br>
                  â€¢ åœ¨åº«è¨­å®š<br>
                  â€¢ ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š<br>
                  â€¢ å–¶æ¥­æ™‚é–“è¨­å®š<br>
                  â€¢ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š<br><br>
                  èª¤ã£ã¦å‰Šé™¤ã—ãŸå ´åˆã«å¾©å…ƒã§ãã¾ã™ã€‚<br>
                  éå»7æ—¥åˆ†ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè‡ªå‹•ä¿æŒã•ã‚Œã¾ã™ã€‚
                </div>
              </div>
              
              <div style="background: #fff9e6; border-left: 4px solid #ff9800; padding: 14px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-weight: bold; color: #ff9800; margin-bottom: 6px; font-size: 14px;">ã€ã„ã„ãˆã‚’é¸æŠã—ãŸå ´åˆã€‘</div>
                <div style="color: #666; font-size: 13px;">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã—ã§ç²¾ç®—ã‚’å®Ÿè¡Œã—ã¾ã™</div>
              </div>
              
              <div style="display: flex; gap: 12px; position: sticky; bottom: 0; background: white; padding: 10px 0 0 0;">
                <button id="backupNoBtn" style="
                  flex: 1; padding: 16px; font-size: 16px; font-weight: bold;
                  border: 2px solid #ddd; border-radius: 12px; cursor: pointer;
                  background: white; color: #666; transition: all 0.2s;
                " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                  ã„ã„ãˆ
                </button>
                <button id="backupYesBtn" style="
                  flex: 1; padding: 16px; font-size: 16px; font-weight: bold;
                  border: none; border-radius: 12px; cursor: pointer;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                  transition: all 0.2s;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.5)'" 
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'">
                  ã¯ã„ï¼ˆæ¨å¥¨ï¼‰
                </button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        const yesBtn = document.getElementById('backupYesBtn');
        const noBtn = document.getElementById('backupNoBtn');
        
        const handleYes = () => {
          playTapSound();
          yesBtn.removeEventListener('click', handleYes);
          noBtn.removeEventListener('click', handleNo);
          modal.remove();
          resolve(true);
        };
        
        const handleNo = () => {
          playTapSound();
          yesBtn.removeEventListener('click', handleYes);
          noBtn.removeEventListener('click', handleNo);
          modal.remove();
          resolve(false);
        };
        
        yesBtn.addEventListener('click', handleYes);
        noBtn.addEventListener('click', handleNo);
      });
      
      if (shouldBackup) {
        console.log('ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã™');
        const backupSuccess = await window.createAutoBackup();
        if (!backupSuccess) {
          const continueAnyway = await showCustomAlert({
            title: 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼',
            message: 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nãã‚Œã§ã‚‚ç²¾ç®—ã‚’ç¶šã‘ã¾ã™ã‹ï¼Ÿ',
            type: 'warning',
            confirmText: 'ç¶šã‘ã‚‹',
            cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
          });
          if (!continueAnyway) {
            return;
          }
        } else {
          console.log('âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆå®Œäº† - ç²¾ç®—ã‚’ç¶šè¡Œã—ã¾ã™');
        }
      } else {
        console.log('âš  ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ç²¾ç®—ã‚’å®Ÿè¡Œã—ã¾ã™');
      }
      
      try {
        const settlementData = window.currentSettlementData;
        const dateStr = window.currentSettlementDate;
        
        if (!settlementData) {
          await showCustomAlert({
            title: 'ã‚¨ãƒ©ãƒ¼',
            message: 'ç²¾ç®—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
            type: 'error'
          });
          return;
        }
        
        console.log('ğŸ” ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆé–‹å§‹');
        console.log('ğŸ“Š settlementData:', settlementData);
        
        // ===== ç¾åœ¨æ™‚åˆ»ã‚’å–å¾— =====
        const now = new Date();
        const outputTime = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        
        // ===== æ‹…å½“è€…ã‚’å–å¾— =====
        const staffSelect = document.getElementById('staffSelect');
        const staffName = staffSelect.value || 'æœªé¸æŠ';
        
        // ===== dailySalesã‹ã‚‰åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— =====
        const customerCount = settlementData.customerCount || 0;
        const totalItems = settlementData.totalItems || 0;
        const totalSales = settlementData.totalSales || 0;
        const averageSpend = customerCount > 0 ? Math.round(totalSales / customerCount) : 0;
        
        // ===== å£²ä¸Šå†…è¨³ =====
        const cashSales = settlementData.cashSales || 0;
        const emoneSales = settlementData.emoneSales || 0;
        const creditSales = settlementData.creditSales || 0;
        const discountTotal = settlementData.totalDiscount || 0;
        
        // ===== ç¨é‡‘å†…è¨³ï¼ˆå†…ç¨ï¼‰ =====
        const tax8TotalWithTax = settlementData.tax8Total || 0;  // 8%å•†å“åˆè¨ˆï¼ˆç¨è¾¼ï¼‰
        const tax10TotalWithTax = settlementData.tax10Total || 0; // 10%å•†å“åˆè¨ˆï¼ˆç¨è¾¼ï¼‰
        
        // ç¨æŠœä¾¡æ ¼ã‚’è¨ˆç®—ï¼ˆå†…ç¨ãªã®ã§ç¨è¾¼ä¾¡æ ¼ã‹ã‚‰é€†ç®—ï¼‰
        const tax8Excluded = Math.floor(tax8TotalWithTax / 1.08);  // 8%å•†å“åˆè¨ˆï¼ˆç¨æŠœï¼‰
        const tax10Excluded = Math.floor(tax10TotalWithTax / 1.10); // 10%å•†å“åˆè¨ˆï¼ˆç¨æŠœï¼‰
        
        // æ¶ˆè²»ç¨é¡ã‚’è¨ˆç®—
        const tax8Amount = tax8TotalWithTax - tax8Excluded;  // 8%ã®æ¶ˆè²»ç¨
        const tax10Amount = tax10TotalWithTax - tax10Excluded; // 10%ã®æ¶ˆè²»ç¨
        
        // åˆè¨ˆ
        const totalTax = tax8Amount + tax10Amount;  // æ¶ˆè²»ç¨ã®åˆè¨ˆ
        const taxExcludedTotal = tax8Excluded + tax10Excluded;  // ç¨æŠœåˆè¨ˆ
        const taxIncludedTotal = tax8TotalWithTax + tax10TotalWithTax;  // ç¨è¾¼åˆè¨ˆï¼ˆ8%ã¨10%ã®åˆè¨ˆï¼‰
        
        // ğŸ†• å†…ç¨ãƒ»å¤–ç¨ã®å†…è¨³ã‚’æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é›†è¨ˆ
        let tax8InclusiveTotal = 0;
        let tax10InclusiveTotal = 0;
        let tax8ExclusiveTotal = 0;
        let tax10ExclusiveTotal = 0;
        // ğŸ†• èµ¤ä¼ç¥¨ã®å†…ç¨ãƒ»å¤–ç¨ã¯dailySalesã‹ã‚‰å–å¾—
        let redSlipTax8Inclusive = settlementData.redSlipTax8Inclusive || 0;
        let redSlipTax10Inclusive = settlementData.redSlipTax10Inclusive || 0;
        let redSlipTax8Exclusive = settlementData.redSlipTax8Exclusive || 0;
        let redSlipTax10Exclusive = settlementData.redSlipTax10Exclusive || 0;
        
        // dailySalesã«ä¿å­˜ã•ã‚Œã¦ã„ãªã„å ´åˆã¯redSlipsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰è¨ˆç®—ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
        const needCalculateRedSlip = (redSlipTax8Inclusive === 0 && redSlipTax8Exclusive === 0 && 
                                      redSlipTax10Inclusive === 0 && redSlipTax10Exclusive === 0) &&
                                     (settlementData.redSlipCount > 0);
        
        try {
          const ordersQuery = window.query(
            window.getStoreCollection('orders'),
            window.where('paidAt', '!=', null)
          );
          const ordersSnapshot = await window.getDocs(ordersQuery);
          
          ordersSnapshot.forEach(doc => {
            const data = doc.data();
            if (!data.paidAt || !data.items) return;
            
            const orderDate = data.paidAt.toDate();
            let targetDate = new Date(orderDate);
            if (orderDate.getHours() < 3) {
              targetDate.setDate(targetDate.getDate() - 1);
            }
            
            const orderDateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-${String(targetDate.getDate()).padStart(2, '0')}`;
            
            if (orderDateStr === dateStr) {
              data.items.forEach(item => {
                const taxType = item.taxType || 'inclusive';
                const taxAmount = getTaxAmount(item, item.quantity || 1);
                
                if ((item.taxRate || 10) === 8) {
                  if (taxType === 'exclusive') {
                    tax8ExclusiveTotal += taxAmount;
                  } else {
                    tax8InclusiveTotal += taxAmount;
                  }
                } else {
                  if (taxType === 'exclusive') {
                    tax10ExclusiveTotal += taxAmount;
                  } else {
                    tax10InclusiveTotal += taxAmount;
                  }
                }
              });
            }
          });
          
          // ğŸ†• èµ¤ä¼ç¥¨ã®å†…ç¨ãƒ»å¤–ç¨ã‚’redSlipsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰è¨ˆç®—ï¼ˆdailySalesã«ä¿å­˜ã•ã‚Œã¦ã„ãªã„å ´åˆï¼‰
          if (needCalculateRedSlip) {
            console.log('âš ï¸ dailySalesã«èµ¤ä¼ç¥¨ã®å†…ç¨ãƒ»å¤–ç¨ãŒä¿å­˜ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€redSlipsã‹ã‚‰è¨ˆç®—ã—ã¾ã™');
            try {
              const redSlipsSnapshot = await window.getDocs(window.getStoreCollection('redSlips'));
              redSlipsSnapshot.forEach(doc => {
                const data = doc.data();
                if (!data.businessDate || data.businessDate !== dateStr || !data.items) return;
                
                data.items.forEach(item => {
                  const taxType = item.taxType || 'inclusive';
                  const taxAmount = getTaxAmount(item, item.quantity || 1);
                  
                  if ((item.taxRate || 10) === 8) {
                    if (taxType === 'exclusive') {
                      redSlipTax8Exclusive += taxAmount;
                    } else {
                      redSlipTax8Inclusive += taxAmount;
                    }
                  } else {
                    if (taxType === 'exclusive') {
                      redSlipTax10Exclusive += taxAmount;
                    } else {
                      redSlipTax10Inclusive += taxAmount;
                    }
                  }
                });
              });
              console.log('âœ… redSlipsã‹ã‚‰è¨ˆç®—å®Œäº†:', {
                redSlipTax8Inclusive,
                redSlipTax8Exclusive,
                redSlipTax10Inclusive,
                redSlipTax10Exclusive
              });
            } catch (e) {
              console.error('redSlipså–å¾—ã‚¨ãƒ©ãƒ¼:', e);
            }
          }
          
          console.log(' å†…ç¨ãƒ»å¤–ç¨ã®å†…è¨³:', {
            tax8Inclusive: tax8InclusiveTotal,
            tax8Exclusive: tax8ExclusiveTotal,
            tax10Inclusive: tax10InclusiveTotal,
            tax10Exclusive: tax10ExclusiveTotal
          });
        } catch (e) {
          console.error('å†…ç¨ãƒ»å¤–ç¨é›†è¨ˆã‚¨ãƒ©ãƒ¼:', e);
        }
        
        // ===== ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æ•° =====
        const drawerOpenCount = settlementData.drawerOpenCount || 0;
        console.log('ğŸ”“ ç²¾ç®—æ™‚ã®drawerOpenCount:', drawerOpenCount);
        console.log('ğŸ“Š settlementDataå…¨ä½“:', settlementData);
        
        // ===== ğŸ†• èµ¤ä¼ç¥¨æƒ…å ±ã‚’å–å¾— =====
        let redSlipCount = settlementData.redSlipCount || 0;
        let redSlipAmount = settlementData.redSlipAmount || 0;
        let redSlipTax8Total = settlementData.redSlipTax8Total || 0;
        let redSlipTax10Total = settlementData.redSlipTax10Total || 0;
        
        // ğŸ”¥ dailySalesã«èµ¤ä¼ç¥¨ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã€redSlipsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç›´æ¥é›†è¨ˆ
        if (redSlipCount === 0) {
          console.log('âš ï¸ dailySalesã«èµ¤ä¼ç¥¨ãƒ‡ãƒ¼ã‚¿ãŒãªã„ãŸã‚ã€redSlipsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç›´æ¥é›†è¨ˆã—ã¾ã™');
          try {
            const redSlipsSnapshot = await window.getDocs(window.getStoreCollection('redSlips'));
            redSlipsSnapshot.forEach(doc => {
              const data = doc.data();
              if (!data.businessDate || data.businessDate !== dateStr) return;
              
              redSlipCount++;
              redSlipAmount += data.totalAmount || 0;
              
              if (data.items && Array.isArray(data.items)) {
                data.items.forEach(item => {
                  const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
                  const itemTaxRate = item.taxRate || (item.takeout ? 8 : 10);
                  
                  if (itemTaxRate === 8) {
                    redSlipTax8Total += itemTotal;
                  } else {
                    redSlipTax10Total += itemTotal;
                  }
                });
              }
            });
            console.log('âœ… redSlipsã‹ã‚‰é›†è¨ˆå®Œäº†:', {
              redSlipCount,
              redSlipAmount,
              redSlipTax8Total,
              redSlipTax10Total
            });
          } catch (e) {
            console.error('redSlipsé›†è¨ˆã‚¨ãƒ©ãƒ¼:', e);
          }
        }
        
        console.log('ğŸ”´ èµ¤ä¼ç¥¨ä»¶æ•°:', redSlipCount);
        console.log('ğŸ”´ èµ¤ä¼ç¥¨é‡‘é¡:', redSlipAmount);
        console.log('ğŸ”´ èµ¤ä¼ç¥¨8%ç¨é‡‘:', redSlipTax8Total);
        console.log('ğŸ”´ èµ¤ä¼ç¥¨10%ç¨é‡‘:', redSlipTax10Total);
        
        // ===== æ”¯å‡ºã‚’å–å¾— =====
        let expenseTotal = 0;
        try {
          const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
          if (expenseDoc.exists()) {
            expenseTotal = expenseDoc.data().total || 0;
            console.log('ğŸ’¸ æ”¯å‡º:', expenseTotal);
          }
        } catch (e) {
          console.error('æ”¯å‡ºå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        }
        
        // ===== äººä»¶è²»ã‚’å–å¾— =====
        let laborCost = 0;
        try {
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(docData => {
            const data = docData.data();
            if (data.date === dateStr) {
              // æ—¢ã«è¨ˆç®—æ¸ˆã¿ã®ç·è³ƒé‡‘ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
              if (data.totalWage && data.totalWage > 0) {
                laborCost += data.totalWage;
              } else if (data.clockIn && data.clockOut) {
                // ç·è³ƒé‡‘ãŒãªã„å ´åˆã¯è¨ˆç®—ã™ã‚‹
                const clockIn = new Date(`${dateStr} ${data.clockIn}`);
                const clockOut = new Date(`${dateStr} ${data.clockOut}`);
                let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                
                // ä¼‘æ†©æ™‚é–“ã‚’å¼•ã
                if (data.breakStart1 && data.breakEnd1) {
                  const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                  const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                  workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                }
                if (data.breakStart2 && data.breakEnd2) {
                  const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                  const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                  workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                }
                
                const hourlyRate = data.hourlyRate || 1150;
                
                // å‰²å¢—è³ƒé‡‘ã®è¨ˆç®—
                let totalWage = 0;
                const isHoliday = data.isHoliday || false;
                
                // æ™‚é–“ã”ã¨ã«å‰²å¢—ç‡ã‚’è¨ˆç®—
                let currentTime = new Date(clockIn);
                const endTime = new Date(clockOut);
                
                while (currentTime < endTime) {
                  const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                  const segmentEnd = nextHour > endTime ? endTime : nextHour;
                  
                  // ä¼‘æ†©æ™‚é–“ã‚’é™¤å¤–
                  let isBreak = false;
                  if (data.breakStart1 && data.breakEnd1) {
                    const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                    const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                    if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                      isBreak = true;
                    }
                  }
                  if (data.breakStart2 && data.breakEnd2) {
                    const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                    const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                    if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                      isBreak = true;
                    }
                  }
                  
                  if (!isBreak) {
                    const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                    const hour = currentTime.getHours();
                    
                    let rate = 1.0;
                    if (isHoliday) {
                      // ä¼‘æ—¥å‡ºå‹¤: åŸºæœ¬35%å¢—
                      rate = 1.35;
                      // 22æ™‚ï½5æ™‚ã¯æ·±å¤œå‰²å¢—25%ã‚’è¿½åŠ ï¼ˆåˆè¨ˆ60%å¢—ï¼‰
                      if (hour >= 22 || hour < 5) {
                        rate = 1.60;
                      }
                    } else {
                      // å¹³æ—¥: 22æ™‚ï½5æ™‚ã¯æ·±å¤œå‰²å¢—25%
                      if (hour >= 22 || hour < 5) {
                        rate = 1.25;
                      }
                    }
                    
                    totalWage += segmentHours * hourlyRate * rate;
                  }
                  
                  currentTime = segmentEnd;
                }
                
                laborCost += totalWage;
              }
            }
          });
          console.log('ğŸ‘· äººä»¶è²»:', laborCost);
        } catch (e) {
          console.error('äººä»¶è²»å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        }
        
        // å€¤å¼•ããƒ»æ”¯å‡ºã‚’å¼•ã„ãŸæœ€çµ‚åˆè¨ˆå£²ä¸Š
        const finalTotalSales = taxIncludedTotal - discountTotal - expenseTotal;
        
        // ===== ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° =====
        console.log('ğŸ“… æ—¥ä»˜:', dateStr);
        console.log('ğŸ• å‡ºåŠ›æ™‚åˆ»:', outputTime);
        console.log('ğŸ‘¥ å®¢æ•°:', customerCount);
        console.log(' ç·å£²ä¸Šç‚¹æ•°:', totalItems);
        console.log(' å¹³å‡å®¢å˜ä¾¡:', averageSpend);
        console.log('ğŸ’µ åˆè¨ˆå£²ä¸Š:', totalSales);
        console.log('ğŸ’¸ å€¤å¼•ã:', discountTotal);
        console.log('ğŸª 8%å•†å“ï¼ˆç¨è¾¼ï¼‰:', tax8TotalWithTax);
        console.log('ğŸª 8%å•†å“ï¼ˆç¨æŠœï¼‰:', tax8Excluded);
        console.log('ğŸª 8%æ¶ˆè²»ç¨:', tax8Amount);
        console.log('ğŸª 10%å•†å“ï¼ˆç¨è¾¼ï¼‰:', tax10TotalWithTax);
        console.log('ğŸª 10%å•†å“ï¼ˆç¨æŠœï¼‰:', tax10Excluded);
        console.log('ğŸª 10%æ¶ˆè²»ç¨:', tax10Amount);
        console.log('ğŸ”“ ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æ•°:', drawerOpenCount);
        console.log('ğŸ‘¤ æ‹…å½“è€…:', staffName);
        
        // ===== ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ =====
        const journalText = `
=====================================
      ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«
=====================================
å‡ºåŠ›æ™‚åˆ»: ${outputTime}
å®¢æ•°: ${customerCount}çµ„
ç·å£²ä¸Šç‚¹æ•°: ${totalItems}ç‚¹
å¹³å‡å®¢å˜ä¾¡: Â¥${averageSpend.toLocaleString()}
åˆè¨ˆå£²ä¸Š: Â¥${totalSales.toLocaleString()}

-------------------------------------
å£²ä¸Šå†…è¨³
-------------------------------------
ç¾é‡‘: Â¥${cashSales.toLocaleString()}
é›»å­ãƒãƒãƒ¼: Â¥${emoneSales.toLocaleString()}
ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰: Â¥${creditSales.toLocaleString()}
å€¤å¼•ã: Â¥${discountTotal.toLocaleString()}

-------------------------------------
ç¨é‡‘å†…è¨³
-------------------------------------
8%ã®å•†å“åˆè¨ˆï¼ˆç¨æŠœï¼‰: Â¥${tax8Excluded.toLocaleString()}
8%ã®å•†å“åˆè¨ˆï¼ˆç¨è¾¼ï¼‰: Â¥${tax8TotalWithTax.toLocaleString()}
8%ã®æ¶ˆè²»ç¨: Â¥${tax8Amount.toLocaleString()}
  å†…ç¨: Â¥${tax8InclusiveTotal.toLocaleString()}
  å¤–ç¨: Â¥${tax8ExclusiveTotal.toLocaleString()}

10%ã®å•†å“åˆè¨ˆï¼ˆç¨æŠœï¼‰: Â¥${tax10Excluded.toLocaleString()}
10%ã®å•†å“åˆè¨ˆï¼ˆç¨è¾¼ï¼‰: Â¥${tax10TotalWithTax.toLocaleString()}
10%ã®æ¶ˆè²»ç¨: Â¥${tax10Amount.toLocaleString()}
  å†…ç¨: Â¥${tax10InclusiveTotal.toLocaleString()}
  å¤–ç¨: Â¥${tax10ExclusiveTotal.toLocaleString()}

æ¶ˆè²»ç¨ã®åˆè¨ˆ: Â¥${totalTax.toLocaleString()}
ç¨æŠœåˆè¨ˆ: Â¥${taxExcludedTotal.toLocaleString()}
ç¨è¾¼åˆè¨ˆ: Â¥${taxIncludedTotal.toLocaleString()}

æ”¯å‡º: Â¥${expenseTotal.toLocaleString()}
åˆè¨ˆå£²ä¸Š: Â¥${(taxIncludedTotal - expenseTotal).toLocaleString()}
${redSlipCount > 0 ? `
-------------------------------------
èµ¤ä¼ç¥¨ã®ç¨é‡‘å†…è¨³
-------------------------------------
8%ã®èµ¤ä¼ç¥¨ï¼ˆç¨æŠœï¼‰: -Â¥${Math.floor(redSlipTax8Total / 1.08).toLocaleString()}
8%ã®èµ¤ä¼ç¥¨ï¼ˆç¨è¾¼ï¼‰: -Â¥${redSlipTax8Total.toLocaleString()}
8%ã®èµ¤ä¼ç¥¨ã®æ¶ˆè²»ç¨: -Â¥${(redSlipTax8Total - Math.floor(redSlipTax8Total / 1.08)).toLocaleString()}
  å†…ç¨: -Â¥${redSlipTax8Inclusive.toLocaleString()}
  å¤–ç¨: -Â¥${redSlipTax8Exclusive.toLocaleString()}

10%ã®èµ¤ä¼ç¥¨ï¼ˆç¨æŠœï¼‰: -Â¥${Math.floor(redSlipTax10Total / 1.10).toLocaleString()}
10%ã®èµ¤ä¼ç¥¨ï¼ˆç¨è¾¼ï¼‰: -Â¥${redSlipTax10Total.toLocaleString()}
10%ã®èµ¤ä¼ç¥¨ã®æ¶ˆè²»ç¨: -Â¥${(redSlipTax10Total - Math.floor(redSlipTax10Total / 1.10)).toLocaleString()}
  å†…ç¨: -Â¥${redSlipTax10Inclusive.toLocaleString()}
  å¤–ç¨: -Â¥${redSlipTax10Exclusive.toLocaleString()}

èµ¤ä¼ç¥¨æ¶ˆè²»ç¨ã®åˆè¨ˆ: -Â¥${((redSlipTax8Total - Math.floor(redSlipTax8Total / 1.08)) + (redSlipTax10Total - Math.floor(redSlipTax10Total / 1.10))).toLocaleString()}
èµ¤ä¼ç¥¨ç¨æŠœåˆè¨ˆ: -Â¥${(Math.floor(redSlipTax8Total / 1.08) + Math.floor(redSlipTax10Total / 1.10)).toLocaleString()}
èµ¤ä¼ç¥¨ç¨è¾¼åˆè¨ˆ: -Â¥${(redSlipTax8Total + redSlipTax10Total).toLocaleString()}
` : ''}

-------------------------------------
ãã®ä»–
-------------------------------------
ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æ•°: ${drawerOpenCount}å›
èµ¤ä¼ç¥¨ä»¶æ•°: ${redSlipCount}ä»¶
èµ¤ä¼ç¥¨é‡‘é¡: Â¥${redSlipAmount.toLocaleString()}
äººä»¶è²»: Â¥${Math.round(laborCost).toLocaleString()}
æ‹…å½“è€…: ${staffName}

=====================================
`;
        
        // ===== HTMLè¦ç´ ã‚’ä½œæˆã—ã¦PNGç”»åƒã¨ã—ã¦ä¿å­˜ =====
        const journalDiv = document.createElement('div');
        journalDiv.style.cssText = `
          font-family: 'Courier New', monospace;
          font-size: 14px;
          line-height: 1.6;
          padding: 30px;
          background: white;
          color: black;
          white-space: pre-wrap;
          width: 800px;
          position: absolute;
          left: -9999px;
        `;
        
        // HTMLã¨ã—ã¦ç”Ÿæˆã—ã€æ”¯å‡ºã¨åˆè¨ˆå£²ä¸Šã‚’èµ¤è‰²ã«ã™ã‚‹
        journalDiv.innerHTML = journalText
          .replace(/^(æ”¯å‡º: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>')
          .replace(/^(åˆè¨ˆå£²ä¸Š: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>');
        
        document.body.appendChild(journalDiv);
        
        // html2canvasã§ç”»åƒåŒ–
        const canvas = await html2canvas(journalDiv, {
          scale: 2,
          backgroundColor: '#ffffff',
          logging: false
        });
        
        // PNGç”»åƒã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«_${dateStr}.png`;
          link.click();
          URL.revokeObjectURL(url);
          document.body.removeChild(journalDiv);
        });
        
        // ===== ç²¾ç®—è¨˜éŒ²ã‚’Firebaseã«ä¿å­˜ =====
        await window.addDoc(window.getStoreCollection('settlements'), {
          date: dateStr,
          outputTime: outputTime,
          timestamp: window.Timestamp.now(),
          customerCount: customerCount,
          totalItems: totalItems,
          averageSpend: averageSpend,
          totalSales: totalSales,
          cashSales: cashSales,
          emoneSales: emoneSales,
          creditSales: creditSales,
          discountTotal: discountTotal,
          tax8TotalWithTax: tax8TotalWithTax,
          tax8Excluded: tax8Excluded,
          tax8Amount: tax8Amount,
          tax10TotalWithTax: tax10TotalWithTax,
          tax10Excluded: tax10Excluded,
          tax10Amount: tax10Amount,
          totalTax: totalTax,
          taxExcludedTotal: taxExcludedTotal,
          taxIncludedTotal: taxIncludedTotal,
          drawerOpenCount: drawerOpenCount,
          redSlipCount: redSlipCount,  // ğŸ†• èµ¤ä¼ç¥¨ä»¶æ•°
          redSlipAmount: redSlipAmount,  // ğŸ†• èµ¤ä¼ç¥¨é‡‘é¡
          redSlipTax8Total: redSlipTax8Total,  // ğŸ†• èµ¤ä¼ç¥¨8%ç¨é‡‘
          redSlipTax10Total: redSlipTax10Total,  // ğŸ†• èµ¤ä¼ç¥¨10%ç¨é‡‘
          staffName: staffName,
          aiComment: ""
        });
        
        console.log('âœ… ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆå®Œäº†');
        closeSettlementModal();
        
      } catch (e) {
        console.error('âŒ ç²¾ç®—ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'ç²¾ç®—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message,
          type: 'error'
        });
      }
    };
    
    // ç²¾ç®—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeSettlementModal = function() {
      document.getElementById('settlementModal').classList.add('hidden');
    };
    
    // ===== æ”¯å‡ºæ©Ÿèƒ½ =====
    let expenseRows = [];
    let currentExpenseDate = null;
    
    // æ”¯å‡ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.showExpenseModal = async function() {
      const now = new Date();
      const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
      
      // æœ¬æ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆåˆå‰3æ™‚åŸºæº–ï¼‰
      const todayStart = new Date(jstNow);
      todayStart.setHours(3, 0, 0, 0);
      if (jstNow.getHours() < 3) {
        todayStart.setDate(todayStart.getDate() - 1);
      }
      
      const year = todayStart.getFullYear();
      const month = String(todayStart.getMonth() + 1).padStart(2, '0');
      const day = String(todayStart.getDate()).padStart(2, '0');
      currentExpenseDate = `${year}-${month}-${day}`;
      
      // æ—¥ä»˜å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æœ¬æ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
      document.getElementById('expenseDateInput').value = currentExpenseDate;
      
      console.log('ğŸ“… æ”¯å‡ºãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º - æœ¬æ—¥ã®æ—¥ä»˜:', currentExpenseDate);
      console.log('ğŸ“… ç¾åœ¨æ™‚åˆ»(JST):', jstNow.toLocaleString('ja-JP'));
      
      // Firebaseã‹ã‚‰æœ¬æ—¥ã®æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      await loadExpensesByDate();
      
      document.getElementById('expenseModal').classList.remove('hidden');
    };
    
    // æ—¥ä»˜å¤‰æ›´æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    window.loadExpensesByDate = async function() {
      const selectedDate = document.getElementById('expenseDateInput').value;
      if (!selectedDate) {
        console.warn('âš  æ—¥ä»˜ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      
      currentExpenseDate = selectedDate;
      console.log('ğŸ“… æ—¥ä»˜å¤‰æ›´ - é¸æŠã•ã‚ŒãŸæ—¥ä»˜:', currentExpenseDate);
      
      try {
        const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', currentExpenseDate));
        
        if (expenseDoc.exists()) {
          const data = expenseDoc.data();
          expenseRows = data.items || [];
          console.log('âœ… æ—¢å­˜ã®æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿:', currentExpenseDate, 'ä»¶æ•°:', expenseRows.length);
          console.log('ğŸ“‹ ãƒ‡ãƒ¼ã‚¿å†…å®¹:', expenseRows);
        } else {
          // æ–°è¦ã®å ´åˆã¯åˆæœŸè¡Œã‚’è¿½åŠ 
          console.log('ğŸ“ æ–°è¦ä½œæˆ:', currentExpenseDate);
          expenseRows = [
            { storeName: '', category: '', detail: '', amount: 0 },
            { storeName: '', category: '', detail: '', amount: 0 },
            { storeName: '', category: '', detail: '', amount: 0 }
          ];
        }
      } catch (e) {
        console.error('âŒ æ”¯å‡ºãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        expenseRows = [
          { storeName: '', category: '', detail: '', amount: 0 },
          { storeName: '', category: '', detail: '', amount: 0 },
          { storeName: '', category: '', detail: '', amount: 0 }
        ];
      }
      
      renderExpenseTable();
    };
    
    // æ”¯å‡ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeExpenseModal = function() {
      document.getElementById('expenseModal').classList.add('hidden');
      
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ãŸå ´åˆã¯ã‚¿ãƒ–ã‚’é–‰ã˜ã‚‹
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('modal') === 'expense') {
        window.close();
      }
    };
    
    // æ”¯å‡ºè¡Œã‚’è¿½åŠ 
    window.addExpenseRow = function() {
      expenseRows.push({
        storeName: '',
        category: '',
        detail: '',
        amount: 0
      });
      renderExpenseTable();
    };
    
    // æ”¯å‡ºè¡Œã‚’å‰Šé™¤
    window.deleteExpenseRow = function(index) {
      expenseRows.splice(index, 1);
      renderExpenseTable();
    };
    
    // æ”¯å‡ºãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
    // å‹˜å®šç§‘ç›®ã¨ç¨ç‡ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const categoryTaxRates = {
      'ææ–™è²»': 8,
      'é£Ÿè²»': 8,
      'æ¥å¾…äº¤éš›è²»': 8,
      'ç§Ÿç¨å…¬èª²': 8,
      'æ—¥ç”¨å“': 10,
      'é›‘è²»ãƒ»é›‘å“': 10,
      'æ°´å…‰ç†±è²»': 10,
      'äº¤é€šè²»10%': 10,
      'ãã®ä»–': 10
    };
    
    function renderExpenseTable() {
      const tbody = document.getElementById('expenseTableBody');
      tbody.innerHTML = '';
      
      expenseRows.forEach((row, index) => {
        const taxRate = categoryTaxRates[row.category] || 10;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding: 8px; border: 1px solid #ddd;">
            <input type="text" value="${row.storeName}" onchange="playTapSound(); updateExpenseRow(${index}, 'storeName', this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <select onchange="playTapSound(); updateExpenseRow(${index}, 'category', this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="ææ–™è²»" ${row.category === 'ææ–™è²»' ? 'selected' : ''}>ææ–™è²»ï¼ˆ8%ï¼‰</option>
              <option value="æ—¥ç”¨å“" ${row.category === 'æ—¥ç”¨å“' ? 'selected' : ''}>æ—¥ç”¨å“ï¼ˆ10%ï¼‰</option>
              <option value="é›‘è²»ãƒ»é›‘å“" ${row.category === 'é›‘è²»ãƒ»é›‘å“' ? 'selected' : ''}>é›‘è²»ãƒ»é›‘å“ï¼ˆ10%ï¼‰</option>
              <option value="é£Ÿè²»" ${row.category === 'é£Ÿè²»' ? 'selected' : ''}>é£Ÿè²»ï¼ˆ8%ï¼‰</option>
              <option value="æ¥å¾…äº¤éš›è²»" ${row.category === 'æ¥å¾…äº¤éš›è²»' ? 'selected' : ''}>æ¥å¾…äº¤éš›è²»ï¼ˆ8%ï¼‰</option>
              <option value="æ°´å…‰ç†±è²»" ${row.category === 'æ°´å…‰ç†±è²»' ? 'selected' : ''}>æ°´å…‰ç†±è²»ï¼ˆ10%ï¼‰</option>
              <option value="ç§Ÿç¨å…¬èª²" ${row.category === 'ç§Ÿç¨å…¬èª²' ? 'selected' : ''}>ç§Ÿç¨å…¬èª²</option>
              <option value="äº¤é€šè²»10%" ${row.category === 'äº¤é€šè²»10%' ? 'selected' : ''}>äº¤é€šè²»ï¼ˆ10%ï¼‰</option>
              <option value="ãã®ä»–" ${row.category === 'ãã®ä»–' ? 'selected' : ''}>ãã®ä»–ï¼ˆ10%ï¼‰</option>
            </select>
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <input type="text" value="${row.detail}" onchange="playTapSound(); updateExpenseRow(${index}, 'detail', this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <input type="number" value="${row.amount}" onchange="playTapSound(); updateExpenseRow(${index}, 'amount', parseFloat(this.value) || 0)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
            <button onclick="playTapSound(); deleteExpenseRow(${index})" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      updateExpenseTotal();
    }
    
    // æ”¯å‡ºè¡Œã‚’æ›´æ–°
    window.updateExpenseRow = function(index, field, value) {
      expenseRows[index][field] = value;
      
      // ç§Ÿç¨å…¬èª²ã‚’é¸æŠã—ãŸå ´åˆã€è©³ç´°ã‚’ã€Œè»½æ²¹å¼•å–ç¨ã€ã«è¨­å®š
      if (field === 'category' && value === 'ç§Ÿç¨å…¬èª²') {
        expenseRows[index]['detail'] = 'è»½æ²¹å¼•å–ç¨';
      }
      
      updateExpenseTotal();
      renderExpenseTable(); // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»
    };
    
    // æ”¯å‡ºåˆè¨ˆã‚’æ›´æ–°
    function updateExpenseTotal() {
      const total = expenseRows.reduce((sum, row) => sum + (parseFloat(row.amount) || 0), 0);
      document.getElementById('expenseTotal').textContent = total.toLocaleString();
    }
    
    // æ”¯å‡ºã‚’ä¿å­˜
    window.saveExpenses = async function() {
      try {
        console.log('ğŸ’¾ æ”¯å‡ºã‚’ä¿å­˜ä¸­ - æ—¥ä»˜:', currentExpenseDate);
        console.log('ğŸ’¾ ä¿å­˜ãƒ‡ãƒ¼ã‚¿:', expenseRows);
        
        // ç©ºè¡Œã‚’é™¤å¤–
        const validRows = expenseRows.filter(row => 
          row.storeName || row.category || row.detail || row.amount
        );
        
        const total = validRows.reduce((sum, row) => sum + (parseFloat(row.amount) || 0), 0);
        
        const currentStaff = document.getElementById('staffSelect')?.value || 'POSå…¥åŠ›';
        
        await window.setDoc(window.getStoreDoc('expenses', currentExpenseDate), {
          date: currentExpenseDate,
          staff: currentStaff,
          items: validRows,
          total: total,
          updatedAt: window.Timestamp.now()
        });
        
        console.log('âœ… æ”¯å‡ºä¿å­˜å®Œäº† - æ—¥ä»˜:', currentExpenseDate, 'ä»¶æ•°:', validRows.length, 'åˆè¨ˆ:', total);
        await showCustomAlert({
          title: 'ä¿å­˜å®Œäº†',
          message: `æ”¯å‡ºã‚’ä¿å­˜ã—ã¾ã—ãŸ
æ—¥ä»˜: ${currentExpenseDate}
ä»¶æ•°: ${validRows.length}ä»¶
åˆè¨ˆ: Â¥${total.toLocaleString()}`,
          type: 'success'
        });
        closeExpenseModal();
        
      } catch (e) {
        console.error('âŒ æ”¯å‡ºä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'æ”¯å‡ºã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message,
          type: 'error'
        });
      }
    };
    
    // æ”¯å‡ºã‚’Excelå½¢å¼ã§å‡ºåŠ›ï¼ˆkeihi.htmlã¨åŒã˜å½¢å¼ï¼‰
    window.exportExpensesToCSV = async function() {
      try {
        console.log('ğŸ“„ æ”¯å‡ºExcelå‡ºåŠ›é–‹å§‹');
        
        if (expenseRows.length === 0) {
          await showCustomAlert({
            title: 'è­¦å‘Š',
            message: 'å‡ºåŠ›ã™ã‚‹æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“',
            type: 'warning'
          });
          return;
        }
        
        // å‹˜å®šç§‘ç›®ã¨ç¨ç‡ã®ãƒãƒƒãƒ”ãƒ³ã‚°
        const categoryTaxRates = {
          'ææ–™è²»': 8,
          'é£Ÿè²»': 8,
          'æ¥å¾…äº¤éš›è²»': 8,
          'ç§Ÿç¨å…¬èª²': 8,
          'æ—¥ç”¨å“': 10,
          'é›‘è²»ãƒ»é›‘å“': 10,
          'æ°´å…‰ç†±è²»': 10,
          'äº¤é€šè²»10%': 10,
          'ãã®ä»–': 10
        };
        
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        
        // Excelãƒ‡ãƒ¼ã‚¿ä½œæˆ
        const excelData = [];
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼
        excelData.push(['çµŒè²»æ˜ç´°æ›¸', '', '', '', '']);
        excelData.push([`${year}å¹´${month}æœˆ`, '', '', '', '']);
        excelData.push(['å‡ºåŠ›æ—¥æ™‚:', new Date().toLocaleString('ja-JP'), '', '', '']);
        excelData.push(['', '', '', '', '']);
        
        // 8%åŒºåˆ†
        excelData.push(['ã€8%åŒºåˆ†ã€‘', '', '', '', '']);
        excelData.push(['æ—¥ä»˜', 'åº—å', 'å‹˜å®šç§‘ç›®', 'è©³ç´°', 'é‡‘é¡']);
        
        const tax8Items = expenseRows.filter(e => 
          e.category === 'ææ–™è²»' || e.category === 'é£Ÿè²»' || e.category === 'æ¥å¾…äº¤éš›è²»'
        );
        let tax8Total = 0;
        
        tax8Items.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax8Total += item.amount;
        });
        
        excelData.push(['', '', '', '8%åˆè¨ˆ:', tax8Total]);
        excelData.push(['', '', '', '', '']);
        
        // 10%åŒºåˆ†
        excelData.push(['ã€10%åŒºåˆ†ã€‘', '', '', '', '']);
        excelData.push(['æ—¥ä»˜', 'åº—å', 'å‹˜å®šç§‘ç›®', 'è©³ç´°', 'é‡‘é¡']);
        
        const tax10Items = expenseRows.filter(e => 
          e.category === 'æ—¥ç”¨å“' || e.category === 'é›‘è²»ãƒ»é›‘å“' || 
          e.category === 'æ°´å…‰ç†±è²»' || e.category === 'ãã®ä»–'
        );
        let tax10Total = 0;
        
        tax10Items.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax10Total += item.amount;
        });
        
        excelData.push(['', '', '', '10%åˆè¨ˆ:', tax10Total]);
        excelData.push(['', '', '', '', '']);
        
        // ç§Ÿç¨å…¬èª²åŒºåˆ†
        excelData.push(['ã€ç§Ÿç¨å…¬èª²åŒºåˆ†ã€‘', '', '', '', '']);
        excelData.push(['æ—¥ä»˜', 'åº—å', 'å‹˜å®šç§‘ç›®', 'è©³ç´°', 'é‡‘é¡']);
        
        const sozeikokaItems = expenseRows.filter(e => e.category === 'ç§Ÿç¨å…¬èª²');
        let sozeikokaTotal = 0;
        
        sozeikokaItems.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          sozeikokaTotal += item.amount;
        });
        
        excelData.push(['', '', '', 'ç§Ÿç¨å…¬èª²åˆè¨ˆ:', sozeikokaTotal]);
        excelData.push(['', '', '', '', '']);
        
        // äº¤é€šè²»ï¼ˆ10%ï¼‰åŒºåˆ†
        excelData.push(['ã€äº¤é€šè²»ï¼ˆ10%ï¼‰åŒºåˆ†ã€‘', '', '', '', '']);
        excelData.push(['æ—¥ä»˜', 'åº—å', 'å‹˜å®šç§‘ç›®', 'è©³ç´°', 'é‡‘é¡']);
        
        const transport10Items = expenseRows.filter(e => e.category === 'äº¤é€šè²»10%');
        let transport10Total = 0;
        
        transport10Items.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          transport10Total += item.amount;
        });
        
        excelData.push(['', '', '', 'äº¤é€šè²»ï¼ˆ10%ï¼‰åˆè¨ˆ:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        
        // ç·åˆè¨ˆ
        const grandTotal = tax8Total + tax10Total + sozeikokaTotal + transport10Total;
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', '8%åˆè¨ˆé‡‘é¡:', tax8Total]);
        excelData.push(['', '', '', '10%åˆè¨ˆé‡‘é¡:', tax10Total]);
        excelData.push(['', '', '', 'ç§Ÿç¨å…¬èª²åˆè¨ˆé‡‘é¡:', sozeikokaTotal]);
        excelData.push(['', '', '', 'äº¤é€šè²»ï¼ˆ10%ï¼‰åˆè¨ˆé‡‘é¡:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', 'åˆè¨ˆ:', grandTotal]);
        
        // SheetJSã§Excelç”Ÿæˆ
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // åˆ—å¹…è¨­å®š
        ws['!cols'] = [
          { wch: 10 },  // æ—¥ä»˜
          { wch: 15 },  // åº—å
          { wch: 15 },  // å‹˜å®šç§‘ç›®
          { wch: 25 },  // è©³ç´°
          { wch: 12 }   // é‡‘é¡
        ];
        
        // ç½«ç·šã¨ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        for (let R = range.s.r; R <= range.e.r; R++) {
          for (let C = range.s.c; C <= range.e.c; C++) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            
            if (!ws[cellAddress]) {
              ws[cellAddress] = { t: 's', v: '' };
            }
            
            if (!ws[cellAddress].s) {
              ws[cellAddress].s = {};
            }
            
            // ç½«ç·š
            ws[cellAddress].s.border = {
              top: { style: 'thin', color: { rgb: '000000' } },
              bottom: { style: 'thin', color: { rgb: '000000' } },
              left: { style: 'thin', color: { rgb: '000000' } },
              right: { style: 'thin', color: { rgb: '000000' } }
            };
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«
            if (R === 0 || (excelData[R] && excelData[R][0] && excelData[R][0].includes('ã€'))) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'D3D3D3' }
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
            }
            
            // åˆè¨ˆè¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆ8%ã€10%ã€äº¤é€šè²»ã®å„åŒºåˆ†ï¼‰
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%åˆè¨ˆ:' || excelData[R][3] === '10%åˆè¨ˆ:' || 
                 excelData[R][3] === 'ç§Ÿç¨å…¬èª²åˆè¨ˆ:' || excelData[R][3] === 'äº¤é€šè²»ï¼ˆ10%ï¼‰åˆè¨ˆ:')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFE599' }  // è–„ã„é»„è‰²
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
              // é‡‘é¡åˆ—ã¯å³å¯„ã›
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // æœ€çµ‚åˆè¨ˆè¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆ8%åˆè¨ˆé‡‘é¡ã€10%åˆè¨ˆé‡‘é¡ã€äº¤é€šè²»åˆè¨ˆé‡‘é¡ã€åˆè¨ˆï¼‰
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%åˆè¨ˆé‡‘é¡:' || excelData[R][3] === '10%åˆè¨ˆé‡‘é¡:' || 
                 excelData[R][3] === 'ç§Ÿç¨å…¬èª²åˆè¨ˆé‡‘é¡:' || excelData[R][3] === 'äº¤é€šè²»ï¼ˆ10%ï¼‰åˆè¨ˆé‡‘é¡:' ||
                 excelData[R][3] === 'åˆè¨ˆ:')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFC7CE' }  // è–„ã„ãƒ”ãƒ³ã‚¯
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
              // é‡‘é¡åˆ—ã¯å³å¯„ã›
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // ã€Œåˆè¨ˆ:ã€è¡Œã¯ç‰¹ã«å¼·èª¿
            if (excelData[R] && excelData[R][3] === 'åˆè¨ˆ:') {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFB6C1' }  // æ¿ƒã„ãƒ”ãƒ³ã‚¯
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 14,
                color: { rgb: 'FF0000' }  // èµ¤æ–‡å­—
              };
            }
          }
        }
        
        XLSX.utils.book_append_sheet(wb, ws, 'çµŒè²»æ˜ç´°');
        
        const fileName = `çµŒè²»æ˜ç´°_${year}å¹´${month}æœˆ.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        console.log('âœ… çµŒè²»Excelå‡ºåŠ›å®Œäº†:', fileName);
        await showCustomAlert({
          title: 'å‡ºåŠ›å®Œäº†',
          message: `çµŒè²»ã‚’å‡ºåŠ›ã—ã¾ã—ãŸï¼
${fileName}`,
          type: 'success'
        });
        
      } catch (e) {
        console.error('âŒ çµŒè²»å‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'çµŒè²»ã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message,
          type: 'error'
        });
      }
    };
    
    // ===== æœˆæ¬¡çµŒè²»å‡ºåŠ›æ©Ÿèƒ½ï¼ˆ1æ—¥ã‹ã‚‰ã®é›†è¨ˆï¼‰ =====
    window.exportMonthlyExpenses = async function(year = null, month = null) {
      try {
        console.log('ğŸ“Š æœˆæ¬¡çµŒè²»å‡ºåŠ›é–‹å§‹');
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šï¼ˆå¼•æ•°ãŒãªã„å ´åˆã¯å½“æœˆï¼‰
        if (!year || !month) {
          const now = new Date();
          const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
          
          // ç¾åœ¨ã®å¹´æœˆã‚’å–å¾—ï¼ˆåˆå‰3æ™‚åŸºæº–ï¼‰
          const todayStart = new Date(jstNow);
          todayStart.setHours(3, 0, 0, 0);
          if (jstNow.getHours() < 3) {
            todayStart.setDate(todayStart.getDate() - 1);
          }
          
          year = todayStart.getFullYear();
          month = todayStart.getMonth() + 1;
        }
        
        console.log(`ğŸ“Š çµŒè²»å‡ºåŠ›: ${year}å¹´${month}æœˆ`);
        
        // æœˆã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const expensesSnapshot = await window.getDocs(window.getStoreCollection('expenses'));
        
        const monthlyExpenses = [];
        expensesSnapshot.forEach(doc => {
          const data = doc.data();
          const date = data.date;
          
          // ç¾åœ¨ã®æœˆã®ãƒ‡ãƒ¼ã‚¿ã®ã¿
          if (date && date.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
            if (data.items && Array.isArray(data.items)) {
              data.items.forEach(item => {
                monthlyExpenses.push({
                  date: date,
                  staff: data.staff || 'ä¸æ˜',
                  storeName: item.storeName,
                  category: item.category,
                  detail: item.detail,
                  amount: item.amount
                });
              });
            }
          }
        });
        
        // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
        monthlyExpenses.sort((a, b) => a.date.localeCompare(b.date));
        
        console.log('å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:', monthlyExpenses.length, 'ä»¶');
        
        if (monthlyExpenses.length === 0) {
          await showCustomAlert({
            title: 'è­¦å‘Š',
            message: 'å‡ºåŠ›ã™ã‚‹çµŒè²»ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“',
            type: 'warning'
          });
          return;
        }
        
        // Excelãƒ‡ãƒ¼ã‚¿ä½œæˆ
        const excelData = [];
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼
        excelData.push(['çµŒè²»æ˜ç´°æ›¸', '', '', '', '', '']);
        excelData.push([`${year}å¹´${month}æœˆ`, '', '', '', '', '']);
        excelData.push(['å‡ºåŠ›æ—¥æ™‚:', new Date().toLocaleString('ja-JP'), '', '', '', '']);
        excelData.push(['', '', '', '', '', '']);
        
        // 8%åŒºåˆ†
        excelData.push(['ã€8%åŒºåˆ†ã€‘', '', '', '', '', '']);
        excelData.push(['æ—¥ä»˜', 'åº—å', 'å‹˜å®šç§‘ç›®', 'è©³ç´°', 'é‡‘é¡']);
        
        const tax8Items = monthlyExpenses.filter(e => 
          e.category === 'ææ–™è²»' || e.category === 'é£Ÿè²»' || e.category === 'æ¥å¾…äº¤éš›è²»'
        );
        let tax8Total = 0;
        
        tax8Items.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax8Total += item.amount;
        });
        
        excelData.push(['', '', '', '8%åˆè¨ˆ:', tax8Total]);
        excelData.push(['', '', '', '', '']);
        
        // 10%åŒºåˆ†
        excelData.push(['ã€10%åŒºåˆ†ã€‘', '', '', '', '', '']);
        excelData.push(['æ—¥ä»˜', 'åº—å', 'å‹˜å®šç§‘ç›®', 'è©³ç´°', 'é‡‘é¡']);
        
        const tax10Items = monthlyExpenses.filter(e => 
          e.category === 'æ—¥ç”¨å“' || e.category === 'é›‘è²»ãƒ»é›‘å“' || 
          e.category === 'æ°´å…‰ç†±è²»' || e.category === 'ãã®ä»–'
        );
        let tax10Total = 0;
        
        tax10Items.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax10Total += item.amount;
        });
        
        excelData.push(['', '', '', '10%åˆè¨ˆ:', tax10Total]);
        excelData.push(['', '', '', '', '']);
        
        // ç§Ÿç¨å…¬èª²åŒºåˆ†
        excelData.push(['ã€ç§Ÿç¨å…¬èª²åŒºåˆ†ã€‘', '', '', '', '', '']);
        excelData.push(['æ—¥ä»˜', 'åº—å', 'å‹˜å®šç§‘ç›®', 'è©³ç´°', 'é‡‘é¡']);
        
        const sozeikokaItems = monthlyExpenses.filter(e => e.category === 'ç§Ÿç¨å…¬èª²');
        let sozeikokaTotal = 0;
        
        sozeikokaItems.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          sozeikokaTotal += item.amount;
        });
        
        excelData.push(['', '', '', 'ç§Ÿç¨å…¬èª²åˆè¨ˆ:', sozeikokaTotal]);
        excelData.push(['', '', '', '', '']);
        
        // äº¤é€šè²»ï¼ˆ10%ï¼‰åŒºåˆ†
        excelData.push(['ã€äº¤é€šè²»ï¼ˆ10%ï¼‰åŒºåˆ†ã€‘', '', '', '', '', '']);
        excelData.push(['æ—¥ä»˜', 'åº—å', 'å‹˜å®šç§‘ç›®', 'è©³ç´°', 'é‡‘é¡']);
        
        const transport10Items = monthlyExpenses.filter(e => e.category === 'äº¤é€šè²»10%');
        let transport10Total = 0;
        
        transport10Items.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          transport10Total += item.amount;
        });
        
        excelData.push(['', '', '', 'äº¤é€šè²»ï¼ˆ10%ï¼‰åˆè¨ˆ:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        
        // ç·åˆè¨ˆ
        const grandTotal = tax8Total + tax10Total + sozeikokaTotal + transport10Total;
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', '8%åˆè¨ˆé‡‘é¡:', tax8Total]);
        excelData.push(['', '', '', '10%åˆè¨ˆé‡‘é¡:', tax10Total]);
        excelData.push(['', '', '', 'ç§Ÿç¨å…¬èª²åˆè¨ˆé‡‘é¡:', sozeikokaTotal]);
        excelData.push(['', '', '', 'äº¤é€šè²»ï¼ˆ10%ï¼‰åˆè¨ˆé‡‘é¡:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', 'åˆè¨ˆ:', grandTotal]);
        
        // SheetJSã§Excelç”Ÿæˆ
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // åˆ—å¹…è¨­å®š
        ws['!cols'] = [
          { wch: 10 },  // æ—¥ä»˜
          { wch: 15 },  // åº—å
          { wch: 15 },  // å‹˜å®šç§‘ç›®
          { wch: 25 },  // è©³ç´°
          { wch: 12 }   // é‡‘é¡
        ];
        
        // ç½«ç·šã¨ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        for (let R = range.s.r; R <= range.e.r; ++R) {
          for (let C = range.s.c; C <= range.e.c; ++C) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            
            if (!ws[cellAddress]) continue;
            
            // åŸºæœ¬ã®ç½«ç·š
            ws[cellAddress].s = ws[cellAddress].s || {};
            ws[cellAddress].s.border = {
              top: { style: 'thin', color: { rgb: '000000' } },
              bottom: { style: 'thin', color: { rgb: '000000' } },
              left: { style: 'thin', color: { rgb: '000000' } },
              right: { style: 'thin', color: { rgb: '000000' } }
            };
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«
            if (R === 0) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'ADD8E6' }  // è–„ã„é’
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 16
              };
            }
            
            // åŒºåˆ†ã‚¿ã‚¤ãƒˆãƒ«è¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆã€8%åŒºåˆ†ã€‘ãªã©ï¼‰
            if (excelData[R] && excelData[R][0] && excelData[R][0].startsWith('ã€')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFFF99' }  // è–„ã„é»„è‰²
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
            }
            
            // åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæ—¥ä»˜ã€åº—åã€å‹˜å®šç§‘ç›®ã€è©³ç´°ã€é‡‘é¡ï¼‰
            if (excelData[R] && excelData[R][0] === 'æ—¥ä»˜') {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'D3D3D3' }  // ç°è‰²
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
            }
            
            // åˆè¨ˆè¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆ8%åˆè¨ˆã€10%åˆè¨ˆãªã©ï¼‰
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%åˆè¨ˆ:' || excelData[R][3] === '10%åˆè¨ˆ:' ||
                 excelData[R][3] === 'ç§Ÿç¨å…¬èª²åˆè¨ˆ:' || excelData[R][3] === 'äº¤é€šè²»ï¼ˆ10%ï¼‰åˆè¨ˆ:')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFE4B5' }  // è–„ã„ã‚ªãƒ¬ãƒ³ã‚¸
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
              // é‡‘é¡åˆ—ã¯å³å¯„ã›
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // æœ€çµ‚åˆè¨ˆè¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆ8%åˆè¨ˆé‡‘é¡ã€10%åˆè¨ˆé‡‘é¡ã€äº¤é€šè²»åˆè¨ˆé‡‘é¡ã€åˆè¨ˆï¼‰
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%åˆè¨ˆé‡‘é¡:' || excelData[R][3] === '10%åˆè¨ˆé‡‘é¡:' || 
                 excelData[R][3] === 'ç§Ÿç¨å…¬èª²åˆè¨ˆé‡‘é¡:' || excelData[R][3] === 'äº¤é€šè²»ï¼ˆ10%ï¼‰åˆè¨ˆé‡‘é¡:' ||
                 excelData[R][3] === 'åˆè¨ˆ:')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFC7CE' }  // è–„ã„ãƒ”ãƒ³ã‚¯
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
              // é‡‘é¡åˆ—ã¯å³å¯„ã›
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // ã€Œåˆè¨ˆ:ã€è¡Œã¯ç‰¹ã«å¼·èª¿
            if (excelData[R] && excelData[R][3] === 'åˆè¨ˆ:') {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFB6C1' }  // æ¿ƒã„ãƒ”ãƒ³ã‚¯
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 14,
                color: { rgb: 'FF0000' }  // èµ¤æ–‡å­—
              };
            }
          }
        }
        
        XLSX.utils.book_append_sheet(wb, ws, 'çµŒè²»æ˜ç´°');
        
        const fileName = `çµŒè²»æ˜ç´°_${year}å¹´${month}æœˆ_æœˆæ¬¡é›†è¨ˆ.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        console.log('âœ… æœˆæ¬¡çµŒè²»Excelå‡ºåŠ›å®Œäº†:', fileName);
        await showCustomAlert({
          title: 'å‡ºåŠ›å®Œäº†',
          message: `æœˆæ¬¡çµŒè²»ã‚’å‡ºåŠ›ã—ã¾ã—ãŸï¼
${fileName}

é›†è¨ˆæœŸé–“: ${year}å¹´${month}æœˆ1æ—¥ã€œç¾åœ¨`,
          type: 'success'
        });
        
      } catch (e) {
        console.error('âŒ æœˆæ¬¡çµŒè²»å‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'æœˆæ¬¡çµŒè²»ã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message,
          type: 'error'
        });
      }
    };
    
    // çµŒè²»å‡ºåŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showExpenseExportModal = function() {
      // å¹´ã®é¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆ2020å¹´ã‹ã‚‰ç¾åœ¨ã®å¹´ã¾ã§ï¼‰
      const currentYear = new Date().getFullYear();
      const yearSelect = document.getElementById('expenseExportYear');
      yearSelect.innerHTML = '';
      
      for (let year = currentYear; year >= 2020; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + 'å¹´';
        yearSelect.appendChild(option);
      }
      
      // ç¾åœ¨ã®æœˆã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
      const currentMonth = new Date().getMonth() + 1;
      document.getElementById('expenseExportMonth').value = currentMonth;
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      document.getElementById('expenseExportModal').style.display = 'flex';
    };
    
    // çµŒè²»å‡ºåŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeExpenseExportModal = function() {
      document.getElementById('expenseExportModal').style.display = 'none';
    };
    
    // çµŒè²»å‡ºåŠ›ã‚’å®Ÿè¡Œ
    window.confirmExpenseExport = async function() {
      const year = parseInt(document.getElementById('expenseExportYear').value);
      const month = parseInt(document.getElementById('expenseExportMonth').value);
      
      closeExpenseExportModal();
      await exportMonthlyExpenses(year, month);
    };
    
    // ===== æ—¥è¨ˆè¡¨ç”Ÿæˆæ©Ÿèƒ½ =====
    // ğŸ†• é¸æŠã•ã‚ŒãŸæœˆã®æ—¥è¨ˆè¡¨ã‚’å‡ºåŠ›
    window.generateDailyReportForSelectedMonth = async function() {
      try {
        const monthSelect = document.getElementById('dailyReportMonth');
        if (!monthSelect || !monthSelect.value) {
          await showCustomAlert({
            title: 'è­¦å‘Š',
            message: 'æœˆã‚’é¸æŠã—ã¦ãã ã•ã„',
            type: 'warning'
          });
          return;
        }
        
        const [year, month] = monthSelect.value.split('-').map(Number);
        await generateDailyReport(year, month);
      } catch (e) {
        console.error('âŒ æ—¥è¨ˆè¡¨ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'æ—¥è¨ˆè¡¨ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message,
          type: 'error'
        });
      }
    };
    
    window.generateDailyReport = async function(targetYear = null, targetMonth = null) {
      try {
        console.log('ğŸ“Š æ—¥è¨ˆè¡¨ç”Ÿæˆé–‹å§‹');
        
        // ğŸ†• å¼•æ•°ã§å¹´æœˆãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯å½“æœˆã‚’ä½¿ç”¨
        const now = new Date();
        const year = targetYear !== null ? targetYear : now.getFullYear();
        const month = targetMonth !== null ? targetMonth : (now.getMonth() + 1);
        
        // æœˆã®æœ€åˆã®æ—¥ã¨æœ€å¾Œã®æ—¥ã‚’è¨ˆç®—
        const firstDay = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0);
        const daysInMonth = lastDay.getDate();
        
        console.log(`${year}å¹´${month}æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...`);
        
        // Firestoreã‹ã‚‰å½“æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const dailySalesSnapshot = await window.getDocs(window.getStoreCollection('dailySales'));
        
        // æ—¥ä»˜ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†
        const salesByDate = {};
        dailySalesSnapshot.forEach(doc => {
          const data = doc.data();
          const date = data.date;
          
          // å½“æœˆã®ãƒ‡ãƒ¼ã‚¿ã®ã¿
          if (date && date.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
            salesByDate[date] = data;
          }
        });
        
        console.log('å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:', salesByDate);
        
        // Excelãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
        const excelData = [];
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ1ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‰
        excelData.push(['', 'å£²ä¸Šæ—¥è¨ˆè¡¨', '', '', '', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', '', '', '', '', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', `${year}-${String(month).padStart(2, '0')}-01`, '', '', '', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', '', '', '', '', '', '', '', '', '', '', '', '', '']);
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ2ï¼ˆåˆ—åï¼‰
        excelData.push(['', 'æ—¥', 'æ›œæ—¥', 'ä¼ç¥¨æ•°', 'ç¾é‡‘', 'ã‚«ãƒ¼ãƒ‰', 'é›»å­ãƒãƒãƒ¼', 'å£²ä¸Šåˆè¨ˆ', 'äººä»¶è²»', 'äººä»¶è²»%', 'æ”¯æ‰•ã„', 'ç´”å£²ä¸Š', 'TOTALç²—åˆ©', 'å¤©æ°—']);
        
        // æ›œæ—¥é…åˆ—
        const weekDays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
        
        // ç´¯è¨ˆç²—åˆ©
        let totalGrossProfit = 0;
        
        // åˆè¨ˆç”¨ã®å¤‰æ•°
        let sumCustomerCount = 0;
        let sumCashSales = 0;
        let sumCreditSales = 0;
        let sumEmoneSales = 0;
        let sumTotalSales = 0;
        let sumLaborCost = 0;
        let sumPayment = 0;
        let sumNetSales = 0;
        
        // å„æ—¥ã®ãƒ‡ãƒ¼ã‚¿
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const date = new Date(year, month - 1, day);
          const weekDay = weekDays[date.getDay()];
          
          const data = salesByDate[dateStr];
          
          if (data) {
            // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
            const customerCount = data.customerCount || 0;
            const cashSales = data.cashSales || 0;
            const creditSales = data.creditSales || 0;
            const emoneSales = data.emoneSales || 0;
            const totalSales = cashSales + creditSales + emoneSales;
            
            // äººä»¶è²»ã‚’kintai_attendanceã‹ã‚‰å–å¾—
            let laborCost = 0;
            try {
              const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
              attendanceSnapshot.forEach(docData => {
                const attData = docData.data();
                if (attData.date === dateStr) {
                  // æ—¢ã«è¨ˆç®—æ¸ˆã¿ã®ç·è³ƒé‡‘ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                  if (attData.totalWage && attData.totalWage > 0) {
                    laborCost += attData.totalWage;
                  } else if (attData.clockIn && attData.clockOut) {
                    // ç·è³ƒé‡‘ãŒãªã„å ´åˆã¯è¨ˆç®—ã™ã‚‹
                    const clockIn = new Date(`${dateStr} ${attData.clockIn}`);
                    const clockOut = new Date(`${dateStr} ${attData.clockOut}`);
                    let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                    
                    if (attData.breakStart1 && attData.breakEnd1) {
                      const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                      const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                      workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                    }
                    if (attData.breakStart2 && attData.breakEnd2) {
                      const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                      const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                      workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                    }
                    
                    const hourlyRate = attData.hourlyRate || 1150;
                    
                    // å‰²å¢—è³ƒé‡‘ã®è¨ˆç®—
                    let totalWage = 0;
                    const isHoliday = attData.isHoliday || false;
                    
                    // æ™‚é–“ã”ã¨ã«å‰²å¢—ç‡ã‚’è¨ˆç®—
                    let currentTime = new Date(clockIn);
                    const endTime = new Date(clockOut);
                    
                    while (currentTime < endTime) {
                      const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                      const segmentEnd = nextHour > endTime ? endTime : nextHour;
                      
                      // ä¼‘æ†©æ™‚é–“ã‚’é™¤å¤–
                      let isBreak = false;
                      if (attData.breakStart1 && attData.breakEnd1) {
                        const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                        const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                        if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                          isBreak = true;
                        }
                      }
                      if (attData.breakStart2 && attData.breakEnd2) {
                        const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                        const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                        if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                          isBreak = true;
                        }
                      }
                      
                      if (!isBreak) {
                        const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                        const hour = currentTime.getHours();
                        
                        let rate = 1.0;
                        if (isHoliday) {
                          // ä¼‘æ—¥å‡ºå‹¤: åŸºæœ¬35%å¢—
                          rate = 1.35;
                          // 22æ™‚ï½5æ™‚ã¯æ·±å¤œå‰²å¢—25%ã‚’è¿½åŠ ï¼ˆåˆè¨ˆ60%å¢—ï¼‰
                          if (hour >= 22 || hour < 5) {
                            rate = 1.60;
                          }
                        } else {
                          // å¹³æ—¥: 22æ™‚ï½5æ™‚ã¯æ·±å¤œå‰²å¢—25%
                          if (hour >= 22 || hour < 5) {
                            rate = 1.25;
                          }
                        }
                        
                        totalWage += segmentHours * hourlyRate * rate;
                      }
                      
                      currentTime = segmentEnd;
                    }
                    
                    laborCost += totalWage;
                  }
                }
              });
            } catch (e) {
              console.error('äººä»¶è²»å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
            }
            
            const laborCostPercent = totalSales > 0 ? Math.round(laborCost / totalSales * 100) : 0;
            
            // æ”¯å‡ºã‚’expensesã‹ã‚‰å–å¾—
            let payment = 0;
            try {
              const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
              if (expenseDoc.exists()) {
                payment = expenseDoc.data().total || 0;
              }
            } catch (e) {
              console.error('æ”¯å‡ºå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
            }
            
            // ç´”å£²ä¸Š
            const netSales = totalSales - laborCost - payment;
            
            // ç´¯è¨ˆç²—åˆ©
            totalGrossProfit += netSales;
            
            // åˆè¨ˆã«åŠ ç®—
            sumCustomerCount += customerCount;
            sumCashSales += cashSales;
            sumCreditSales += creditSales;
            sumEmoneSales += emoneSales;
            sumTotalSales += totalSales;
            sumLaborCost += laborCost;
            sumPayment += payment;
            sumNetSales += netSales;
            
            excelData.push([
              '',
              date,
              weekDay,
              customerCount,
              cashSales,
              creditSales,
              emoneSales,
              totalSales,
              Math.round(laborCost),
              laborCostPercent + '%',  // %è¨˜å·ã‚’ä»˜ã‘ã‚‹
              payment,
              Math.round(netSales),
              Math.round(totalGrossProfit),
              '' // å¤©æ°—ã¯æ‰‹å‹•å…¥åŠ›
            ]);
          } else {
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆï¼ˆç©ºè¡Œï¼‰
            excelData.push([
              '',
              date,
              weekDay,
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              ''
            ]);
          }
        }
        
        // åˆè¨ˆè¡Œã‚’è¿½åŠ 
        const avgLaborCostPercent = sumTotalSales > 0 ? Math.round(sumLaborCost / sumTotalSales * 100) : 0;
        excelData.push([
          '',
          '',
          'åˆè¨ˆ',
          sumCustomerCount,
          sumCashSales,
          sumCreditSales,
          sumEmoneSales,
          sumTotalSales,
          Math.round(sumLaborCost),
          avgLaborCostPercent + '%',
          sumPayment,
          Math.round(sumNetSales),
          '', // TOTALç²—åˆ©ã¯æœ€å¾Œã®è¡Œã®å€¤
          ''
        ]);
        
        console.log('Excelãƒ‡ãƒ¼ã‚¿ä½œæˆå®Œäº†:', excelData.length, 'è¡Œ');
        
        // SheetJSã§Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // åˆ—å¹…ã‚’è¨­å®š
        ws['!cols'] = [
          { wch: 3 },  // Aåˆ—
          { wch: 12 }, // Båˆ—ï¼ˆæ—¥ä»˜ï¼‰
          { wch: 5 },  // Cåˆ—ï¼ˆæ›œæ—¥ï¼‰
          { wch: 8 },  // Dåˆ—ï¼ˆä¼ç¥¨æ•°ï¼‰
          { wch: 10 }, // Eåˆ—ï¼ˆç¾é‡‘ï¼‰
          { wch: 10 }, // Fåˆ—ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰
          { wch: 10 }, // Gåˆ—ï¼ˆpaypayï¼‰
          { wch: 10 }, // Håˆ—ï¼ˆå£²ä¸Šåˆè¨ˆï¼‰
          { wch: 10 }, // Iåˆ—ï¼ˆäººä»¶è²»ï¼‰
          { wch: 10 }, // Jåˆ—ï¼ˆäººä»¶è²»%ï¼‰
          { wch: 10 }, // Kåˆ—ï¼ˆæ”¯æ‰•ã„ï¼‰
          { wch: 10 }, // Låˆ—ï¼ˆç´”å£²ä¸Šï¼‰
          { wch: 12 }, // Måˆ—ï¼ˆTOTALç²—åˆ©ï¼‰
          { wch: 10 }  // Nåˆ—ï¼ˆå¤©æ°—ï¼‰
        ];
        
        // ğŸ†• å…¨ã‚»ãƒ«ã«ç½«ç·šã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        for (let R = range.s.r; R <= range.e.r; R++) {
          for (let C = range.s.c; C <= range.e.c; C++) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            
            // ã‚»ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
            if (!ws[cellAddress]) {
              ws[cellAddress] = { t: 's', v: '' };
            }
            
            // ã‚¹ã‚¿ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–
            if (!ws[cellAddress].s) {
              ws[cellAddress].s = {};
            }
            
            // ç½«ç·šã‚’è¨­å®š
            ws[cellAddress].s.border = {
              top: { style: 'thin', color: { rgb: '000000' } },
              bottom: { style: 'thin', color: { rgb: '000000' } },
              left: { style: 'thin', color: { rgb: '000000' } },
              right: { style: 'thin', color: { rgb: '000000' } }
            };
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆ5è¡Œç›® = R=4ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ«
            if (R === 4) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'D3D3D3' }
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
              ws[cellAddress].s.alignment = {
                horizontal: 'center',
                vertical: 'center'
              };
            }
            
            // åˆè¨ˆè¡Œï¼ˆæœ€çµ‚è¡Œï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ«
            if (R === range.e.r) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFFFCC' }
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
            }
            
            // æ•°å€¤ã‚»ãƒ«ã®å³å¯„ã›
            if (C >= 3 && C <= 12 && R >= 5) {
              if (!ws[cellAddress].s.alignment) {
                ws[cellAddress].s.alignment = {};
              }
              ws[cellAddress].s.alignment.horizontal = 'right';
            }
          }
        }
        
        XLSX.utils.book_append_sheet(wb, ws, 'å£²ä¸Šæ—¥è¨ˆè¡¨');
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const fileName = `æ—¥è¨ˆè¡¨${year}å¹´${month}æœˆ.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        console.log('âœ… æ—¥è¨ˆè¡¨å‡ºåŠ›å®Œäº†:', fileName);
        await showCustomAlert({
          title: 'å‡ºåŠ›å®Œäº†',
          message: `æ—¥è¨ˆè¡¨ã‚’å‡ºåŠ›ã—ã¾ã—ãŸï¼
${fileName}`,
          type: 'success'
        });
        
      } catch (e) {
        console.error('âŒ æ—¥è¨ˆè¡¨ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'æ—¥è¨ˆè¡¨ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message,
          type: 'error'
        });
      }
    };
    
    // ========== ğŸ“‹ å±¥æ­´æ©Ÿèƒ½ ==========
    
    let historyOrders = [];
    
    window.showHistoryModal = async function() {
      // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('historyModal').style.display = 'flex';
      await loadHistory();
    };
    
    window.closeHistoryModal = function() {
      document.getElementById('historyModal').style.display = 'none';
    };
    
    // åœ¨åº«ã‚’æˆ»ã™å‡¦ç†
    async function restoreInventoryFromRedSlip(items) {
      try {
        console.log('ğŸ“¦ åœ¨åº«ã‚’æˆ»ã™å‡¦ç†é–‹å§‹');
        
        // åœ¨åº«è¨­å®šã‚’å–å¾—
        const inventoryRef = window.getStoreDoc('inventory_settings', 'default');
        const inventoryDoc = await window.getDoc(inventoryRef);
        
        if (!inventoryDoc.exists()) {
          console.log('âš ï¸ åœ¨åº«è¨­å®šãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€åœ¨åº«ã‚’æˆ»ã™å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—');
          return;
        }
        
        const inventorySettings = inventoryDoc.data().items || {};
        let updated = false;
        
        // å„å•†å“ã®åœ¨åº«ã‚’æˆ»ã™
        items.forEach(item => {
          const menuItemId = item.menuItemId || item.id;
          if (!menuItemId) {
            console.warn('âš ï¸ menuItemIdãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', item);
            return;
          }
          
          if (inventorySettings[menuItemId] && inventorySettings[menuItemId].stock !== null && inventorySettings[menuItemId].stock !== undefined) {
            const currentStock = inventorySettings[menuItemId].stock;
            const returnQuantity = item.quantity || 1;
            inventorySettings[menuItemId].stock = currentStock + returnQuantity;
            updated = true;
            console.log(`âœ… ${item.name}: ${currentStock} â†’ ${inventorySettings[menuItemId].stock} (+${returnQuantity})`);
          }
        });
        
        // åœ¨åº«è¨­å®šã‚’ä¿å­˜
        if (updated) {
          await window.setDoc(inventoryRef, {
            items: inventorySettings,
            updatedAt: window.Timestamp.now()
          });
          console.log('âœ… åœ¨åº«ã‚’æˆ»ã—ã¾ã—ãŸ');
        } else {
          console.log('âš ï¸ æˆ»ã™åœ¨åº«ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        }
        
      } catch (e) {
        console.error('âŒ åœ¨åº«ã‚’æˆ»ã™å‡¦ç†ã‚¨ãƒ©ãƒ¼:', e);
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚å‡¦ç†ã¯ç¶šè¡Œ
      }
    }
    
    // èµ¤ä¼ç¥¨ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å°åˆ·
    async function printRedSlipReceipt(orderData) {
      try {
        console.log('ğŸ–¨ï¸ èµ¤ä¼ç¥¨ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·é–‹å§‹');
        
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        // 58mmå¹…è¨­å®š
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2, invert: true});
        builder.createTextElement({data: '  èµ¤ä¼ç¥¨  \n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1, invert: false});
        
        const storeName = window.receiptSettings?.storeName || 'ç²‰ã‚‚ã‚“å±‹ å…«';
        const branchName = window.receiptSettings?.branchName || 'ä¸‹èµ¤å¡šåº—';
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: storeName + '\n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createTextElement({data: branchName + '\n'});
        
        const address = window.receiptSettings?.address || 'æ±äº¬éƒ½æ¿æ©‹åŒºèµ¤å¡šæ–°ç”º';
        const phone = window.receiptSettings?.phone || '03-XXXX-XXXX';
        builder.createTextElement({data: address + '\n'});
        builder.createTextElement({data: 'TEL: ' + phone + '\n'});
        
        builder.createRuledLineElement({thickness: 'thin'});
        
        // æ—¥æ™‚æƒ…å ±
        builder.createAlignmentElement({position: 'left'});
        const now = new Date();
        const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        builder.createTextElement({data: `ç™ºè¡Œæ—¥æ™‚: ${dateStr}\n`});
        
        const orderDate = orderData.timestamp?.toDate() || new Date();
        const orderDateStr = `${orderDate.getFullYear()}/${String(orderDate.getMonth()+1).padStart(2,'0')}/${String(orderDate.getDate()).padStart(2,'0')} ${String(orderDate.getHours()).padStart(2,'0')}:${String(orderDate.getMinutes()).padStart(2, '0')}`;
        builder.createTextElement({data: `å…ƒæ³¨æ–‡æ—¥æ™‚: ${orderDateStr}\n`});
        builder.createTextElement({data: `ãƒ†ãƒ¼ãƒ–ãƒ«: ${orderData.tableNumber}\n`});
        builder.createTextElement({data: `æ³¨æ–‡No: ${orderData.orderNumber}\n`});
        
        builder.createRuledLineElement({thickness: 'thin'});
        
        // å•†å“æ˜ç´°ï¼ˆãƒã‚¤ãƒŠã‚¹è¡¨ç¤ºï¼‰
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 1, height: 1});
        builder.createTextElement({data: 'è¿”å“å•†å“\n'});
        builder.createTextElement({emphasis: false});
        builder.createAlignmentElement({position: 'left'});
        
        let total = 0;
        orderData.items.forEach(item => {
          const subtotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
          total += subtotal;
          
          const itemName = item.name.length > 16 ? item.name.substring(0, 15) + 'â€¦' : item.name;
          builder.createTextElement({data: `${itemName}\n`});
          
          const priceInfo = `-@${item.price} x${item.quantity}`;
          const subtotalStr = `-${subtotal.toLocaleString()}å††`;
          const spaces = ' '.repeat(Math.max(1, 32 - priceInfo.length - subtotalStr.length));
          builder.createTextElement({data: `${priceInfo}${spaces}${subtotalStr}\n`});
          
          // ãƒˆãƒƒãƒ”ãƒ³ã‚°è¡¨ç¤º
          if (item.toppings && item.toppings !== 'ãªã—') {
            builder.createTextElement({data: ` TP:${item.toppings}\n`});
          }
        });
        
        builder.createRuledLineElement({thickness: 'medium'});
        
        // åˆè¨ˆï¼ˆãƒã‚¤ãƒŠã‚¹è¡¨ç¤ºï¼‰
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `è¿”é‡‘é¡ -${total.toLocaleString()}å††\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        builder.createRuledLineElement({thickness: 'medium'});
        
        // ãƒ•ãƒƒã‚¿ãƒ¼
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({data: '\nèµ¤ä¼ç¥¨\n'});
        builder.createTextElement({data: 'å£²ä¸Šå–æ¶ˆ\n\n\n'});
        
        builder.createCutPaperElement({feed: true});
        
        // å°åˆ·å®Ÿè¡Œ
        await sendPrintRequest(
          builder,
          (response) => {
            console.log('âœ… èµ¤ä¼ç¥¨ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·æˆåŠŸ');
          },
          (response) => {
            console.error('âŒ èµ¤ä¼ç¥¨ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·ã‚¨ãƒ©ãƒ¼:', response);
          }
        );
        
      } catch (e) {
        console.error('âŒ èµ¤ä¼ç¥¨ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        // å°åˆ·ã‚¨ãƒ©ãƒ¼ã§ã‚‚å‡¦ç†ã¯ç¶šè¡Œ
      }
    }
    
    // å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°ï¼ˆèµ¤ä¼ç¥¨åˆ†ã‚’ãƒã‚¤ãƒŠã‚¹ï¼‰
    async function updateSalesForRedSlip(orderData) {
      try {
        console.log('ğŸ“Š å£²ä¸Šãƒ‡ãƒ¼ã‚¿æ›´æ–°é–‹å§‹');
        
        // å–¶æ¥­æ—¥ã‚’è¨ˆç®—ï¼ˆåˆå‰3æ™‚åŸºæº–ï¼‰
        const orderDate = orderData.paidAt?.toDate() || orderData.timestamp?.toDate() || new Date();
        let businessDate = new Date(orderDate);
        if (orderDate.getHours() < 3) {
          businessDate.setDate(businessDate.getDate() - 1);
        }
        businessDate.setHours(0, 0, 0, 0);
        
        const dateKey = `${businessDate.getFullYear()}-${String(businessDate.getMonth() + 1).padStart(2, '0')}-${String(businessDate.getDate()).padStart(2, '0')}`;
        
        // å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const salesRef = window.getStoreDoc('daily_sales', dateKey);
        const salesDoc = await window.getDoc(salesRef);
        
        if (!salesDoc.exists()) {
          console.warn('âš ï¸ å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', dateKey);
          return;
        }
        
        const salesData = salesDoc.data();
        
        // èµ¤ä¼ç¥¨ã®ã‚«ã‚¦ãƒ³ãƒˆã¨é‡‘é¡ã‚’æ›´æ–°
        const redSlipCount = (salesData.redSlipCount || 0) + 1;
        const redSlipAmount = (salesData.redSlipAmount || 0) + orderData.totalAmount;
        
        // ç¨ç‡åˆ¥ã®èµ¤ä¼ç¥¨é‡‘é¡ã‚’è¨ˆç®—
        let redSlipTax8Total = salesData.redSlipTax8Total || 0;
        let redSlipTax10Total = salesData.redSlipTax10Total || 0;
        
        orderData.items.forEach(item => {
          const subtotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
          if (item.taxRate === 8) {
            redSlipTax8Total += subtotal;
          } else {
            redSlipTax10Total += subtotal;
          }
        });
        
        // å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        await window.updateDoc(salesRef, {
          redSlipCount: redSlipCount,
          redSlipAmount: redSlipAmount,
          redSlipTax8Total: redSlipTax8Total,
          redSlipTax10Total: redSlipTax10Total,
          updatedAt: window.Timestamp.now()
        });
        
        console.log('âœ… å£²ä¸Šãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†');
        
      } catch (e) {
        console.error('âŒ å£²ä¸Šãƒ‡ãƒ¼ã‚¿æ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
        // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚å‡¦ç†ã¯ç¶šè¡Œ
      }
    }
    
    async function loadHistory() {
      try {
        const q = window.query(
          window.getStoreCollection('orders'),
          window.orderBy('timestamp', 'desc'),
          window.limit(100)
        );
        const ordersSnapshot = await window.getDocs(q);
        historyOrders = [];
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          historyOrders.push({
            id: doc.id,
            orderNumber: data.orderNumber || 0,
            timestamp: data.timestamp,
            tableNumber: data.tableNumber || '',
            items: data.items || [],
            totalAmount: data.totalAmount || 0,
            paymentMethod: data.paymentMethod || 'cash',
            paidAt: data.paidAt || null,
            completedAt: data.completedAt || null
          });
        });
        
        filterHistory();
      } catch (e) {
        console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({ 
          icon: '', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 
          btnClass: 'modal-btn-danger' 
        });
      }
    }
    
    window.filterHistory = function() {
      const dateFilter = document.getElementById('historyDateFilter').value;
      const statusFilter = document.getElementById('historyStatusFilter').value;
      const now = new Date();
      
      let filtered = historyOrders.filter(order => {
        const orderDate = order.timestamp.toDate();
        
        let dateMatch = true;
        if (dateFilter === 'today') {
          const todayStart = new Date(now);
          todayStart.setHours(3, 0, 0, 0);
          if (now.getHours() < 3) {
            todayStart.setDate(todayStart.getDate() - 1);
          }
          const todayEnd = new Date(todayStart);
          todayEnd.setDate(todayEnd.getDate() + 1);
          dateMatch = orderDate >= todayStart && orderDate < todayEnd;
        } else if (dateFilter === 'yesterday') {
          const yesterdayStart = new Date(now);
          yesterdayStart.setHours(3, 0, 0, 0);
          if (now.getHours() < 3) {
            yesterdayStart.setDate(yesterdayStart.getDate() - 1);
          }
          yesterdayStart.setDate(yesterdayStart.getDate() - 1);
          const yesterdayEnd = new Date(yesterdayStart);
          yesterdayEnd.setDate(yesterdayEnd.getDate() + 1);
          dateMatch = orderDate >= yesterdayStart && orderDate < yesterdayEnd;
        } else if (dateFilter === 'week') {
          const weekAgo = new Date(now);
          weekAgo.setDate(weekAgo.getDate() - 7);
          dateMatch = orderDate >= weekAgo;
        } else if (dateFilter === 'month') {
          const monthStart = new Date(now);
          monthStart.setDate(1);
          monthStart.setHours(0, 0, 0, 0);
          dateMatch = orderDate >= monthStart;
        }
        
        let statusMatch = true;
        if (statusFilter === 'deleted') {
          statusMatch = order.deleted === true;
        } else if (statusFilter === 'paid') {
          statusMatch = order.paidAt !== null && !order.deleted;
        } else if (statusFilter === 'completed') {
          statusMatch = order.completedAt !== null && !order.deleted;
        }
        
        return dateMatch && statusMatch;
      });
      
      displayHistory(filtered);
    };
    
    function displayHistory(orders) {
      const container = document.getElementById('historyList');
      
      if (orders.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">è©²å½“ã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = '';
      
      orders.forEach(order => {
        const card = document.createElement('div');
        card.style.cssText = `
          background: white;
          border-radius: 12px;
          padding: 15px;
          margin-bottom: 15px;
          border: 2px solid #ddd;
        `;
        
        const orderDate = order.timestamp.toDate();
        const dateStr = orderDate.toLocaleString('ja-JP');
        
        const paymentMethodNames = {
          'cash': 'ç¾é‡‘',
          'emoney': 'é›»å­ãƒãƒãƒ¼',
          'credit': 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰'
        };
        const paymentMethodLabel = paymentMethodNames[order.paymentMethod] || 'ç¾é‡‘';
        
        let itemsHtml = '';
        order.items.forEach(item => {
          itemsHtml += `<div style="padding: 5px 0; border-bottom: 1px solid #eee;">
            ${item.name} Ã—${item.quantity} - Â¥${((item.price + (item.toppingPrice || 0)) * item.quantity).toLocaleString()}
          </div>`;
        });
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸
        let badges = [];
        if (order.deleted) badges.push('<span style="background: #666; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">å‰Šé™¤æ¸ˆã¿</span>');
        if (order.paidAt) badges.push('<span style="background: #2196F3; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">ä¼šè¨ˆæ¸ˆ</span>');
        if (order.completedAt) badges.push('<span style="background: #4CAF50; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">å®Œäº†</span>');
        if (order.cancelledAt) badges.push('<span style="background: #f44336; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>');
        
        // ãƒœã‚¿ãƒ³ä½œæˆ
        let buttonsHtml = `
          <div style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 2px solid #eee; flex-wrap: wrap;">
            <button onclick="playTapSound(); editOrderFromHistory('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;"> ç·¨é›†</button>
            ${order.paidAt ? `
              <button onclick="playTapSound(); redSlipFromHistory('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;"> èµ¤ä¼ç¥¨</button>
            ` : `
              ${!order.deleted ? `
                <button onclick="playTapSound(); deleteOrderFromHistory('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">ğŸ—‘ å–æ¶ˆ</button>
              ` : `
                <button onclick="playTapSound(); restoreOrderFromHistory('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">å¾©å…ƒ</button>
              `}
            `}
            ${order.paidAt ? `
              <button onclick="playTapSound(); reprintReceipt('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">ãƒ¬ã‚·ãƒ¼ãƒˆè¡¨ç¤º</button>
              <button onclick="playTapSound(); reprintInvoice('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">é ˜åæ›¸è¡¨ç¤º</button>
            ` : ''}
          </div>
        `;
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div>
              <strong style="font-size: 18px; color: #667eea;">#${order.orderNumber}</strong>
              <span style="margin-left: 10px; color: #666;">${order.tableNumber}</span>
            </div>
            <div>${badges.join('')}</div>
          </div>
          <div style="font-size: 12px; color: #999; margin-bottom: 10px;">
            ${dateStr}
            ${order.paidAt ? `<span style="margin-left: 15px; padding: 4px 8px; background: #e3f2fd; color: #1976d2; border-radius: 4px; font-weight: bold;">ğŸ’³ ${paymentMethodLabel}</span>` : ''}
          </div>
          <div style="margin-bottom: 10px; max-height: 150px; overflow-y: auto;">${itemsHtml}</div>
          <div style="text-align: right; font-size: 18px; font-weight: bold; color: #667eea; padding-top: 10px; border-top: 2px solid #eee;">
            åˆè¨ˆ: Â¥${order.totalAmount.toLocaleString()}
          </div>
          ${buttonsHtml}
        `;
        
        container.appendChild(card);
      });
    }
    
    window.refreshHistory = async function() {
      await loadHistory();
    };
    
    // ========== èµ¤ä¼ç¥¨æ©Ÿèƒ½ ==========
    window.redSlipFromHistory = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        if (!orderDoc.exists()) {
          await showCustomAlert({ title: 'ã‚¨ãƒ©ãƒ¼', message: 'æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', btnClass: 'modal-btn-danger' });
          return;
        }
        
        const orderData = { id: orderDoc.id, ...orderDoc.data() };
        
        if (!orderData.paidAt) {
          await showCustomAlert({ title: 'ã‚¨ãƒ©ãƒ¼', message: 'ä¼šè¨ˆæ¸ˆã¿ã®æ³¨æ–‡ã®ã¿èµ¤ä¼ç¥¨ã§ãã¾ã™', btnClass: 'modal-btn-danger' });
          return;
        }
        
        const confirmed = await showCustomConfirm({
          title: 'èµ¤ä¼ç¥¨ç¢ºèª',
          message: `æ³¨æ–‡ #${orderData.orderNumber} ã‚’èµ¤ä¼ç¥¨ã§å®Œå…¨å–æ¶ˆã—ã¾ã™ã‹?\n\né‡‘é¡: Â¥${orderData.totalAmount.toLocaleString()}\n\né‡è¦ãªæ³¨æ„äº‹é …:\nãƒ»å£²ä¸Šã‹ã‚‰å®Œå…¨ã«é™¤å¤–ã•ã‚Œã¾ã™\nãƒ»åœ¨åº«ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å•†å“ã¯åœ¨åº«ãŒæˆ»ã‚Šã¾ã™\nãƒ»èµ¤ä¼ç¥¨ãƒ¬ã‚·ãƒ¼ãƒˆãŒå°åˆ·ã•ã‚Œã¾ã™\nãƒ»å®¢æ•°ã‚‚æ¸›å°‘ã—ã¾ã™\nãƒ»å¾©å…ƒã§ãã¾ã›ã‚“\nãƒ»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“`,
          confirmText: 'èµ¤ä¼ç¥¨ã‚’åˆ‡ã‚‹',
          cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
        });
        
        if (!confirmed) return;
        
        // ä¼šè¨ˆæ—¥æ™‚ã‹ã‚‰å–¶æ¥­æ—¥ã‚’è¨ˆç®—ï¼ˆ3æ™‚åŸºæº–ï¼‰
        const paidDate = orderData.paidAt.toDate();
        let businessDate = new Date(paidDate);
        
        if (paidDate.getHours() < 3) {
          businessDate.setDate(businessDate.getDate() - 1);
        }
        
        const dateStr = `${businessDate.getFullYear()}-${String(businessDate.getMonth() + 1).padStart(2, '0')}-${String(businessDate.getDate()).padStart(2, '0')}`;
        
        // dailySalesã‚’å–å¾—
        const dailySalesRef = window.getStoreDoc('dailySales', dateStr);
        const dailySalesDoc = await window.getDoc(dailySalesRef);
        
        if (!dailySalesDoc.exists()) {
          await showCustomAlert({ title: 'ã‚¨ãƒ©ãƒ¼', message: 'ã“ã®å–¶æ¥­æ—¥ã®dailySalesãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', btnClass: 'modal-btn-danger' });
          return;
        }
        
        const dailyData = dailySalesDoc.data();
        const totalAmount = orderData.totalAmount || 0;
        
        // ç¨ç‡è¨ˆç®—
        let tax8Total = 0;
        let tax10Total = 0;
        // ğŸ†• å†…ç¨ãƒ»å¤–ç¨ã‚’åŒºåˆ¥ã—ã¦è¨ˆç®—
        let tax8Inclusive = 0;
        let tax10Inclusive = 0;
        let tax8Exclusive = 0;
        let tax10Exclusive = 0;
        
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
            let itemTaxRate = item.taxRate || (item.takeout ? 8 : 10);
            const taxType = item.taxType || 'inclusive';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å†…ç¨
            const taxAmount = getTaxAmount(item, item.quantity || 1);
            
            if (itemTaxRate === 8) {
              tax8Total += itemTotal;
              if (taxType === 'exclusive') {
                tax8Exclusive += taxAmount;
              } else {
                tax8Inclusive += taxAmount;
              }
            } else {
              tax10Total += itemTotal;
              if (taxType === 'exclusive') {
                tax10Exclusive += taxAmount;
              } else {
                tax10Inclusive += taxAmount;
              }
            }
          });
        }
        
        // æ”¯æ‰•ã„æ–¹æ³•åˆ¥ã®é‡‘é¡
        let cashSales = 0, emoneSales = 0, creditSales = 0;
        const paymentMethod = orderData.paymentMethod || '';
        if (paymentMethod === 'ç¾é‡‘' || paymentMethod === 'cash') cashSales = totalAmount;
        else if (paymentMethod === 'é›»å­ãƒãƒãƒ¼' || paymentMethod === 'emoney') emoneSales = totalAmount;
        else if (paymentMethod === 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰' || paymentMethod === 'credit') creditSales = totalAmount;
        
        // å•†å“æ•°ã‚’è¨ˆç®—
        let totalItems = 0;
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            totalItems += item.quantity || 0;
          });
        }
        
        // ğŸ†• åœ¨åº«ã‚’æˆ»ã™å‡¦ç†
        await restoreInventoryFromRedSlip(orderData.items);
        
        // dailySalesã‹ã‚‰æ¸›ç®—
        const updateData = {
          totalSales: Math.max(0, (dailyData.totalSales || 0) - totalAmount),
          customerCount: Math.max(0, (dailyData.customerCount || 0) - 1),
          totalItems: Math.max(0, (dailyData.totalItems || 0) - totalItems),
          cashSales: Math.max(0, (dailyData.cashSales || 0) - cashSales),
          emoneSales: Math.max(0, (dailyData.emoneSales || 0) - emoneSales),
          creditSales: Math.max(0, (dailyData.creditSales || 0) - creditSales),
          tax8Total: Math.max(0, (dailyData.tax8Total || 0) - tax8Total),
          tax10Total: Math.max(0, (dailyData.tax10Total || 0) - tax10Total),
          redSlipCount: (dailyData.redSlipCount || 0) + 1,
          redSlipAmount: (dailyData.redSlipAmount || 0) + totalAmount,
          redSlipTax8Total: (dailyData.redSlipTax8Total || 0) + tax8Total,
          redSlipTax10Total: (dailyData.redSlipTax10Total || 0) + tax10Total,
          // ğŸ†• å†…ç¨ãƒ»å¤–ç¨ã‚’ä¿å­˜
          redSlipTax8Inclusive: (dailyData.redSlipTax8Inclusive || 0) + tax8Inclusive,
          redSlipTax10Inclusive: (dailyData.redSlipTax10Inclusive || 0) + tax10Inclusive,
          redSlipTax8Exclusive: (dailyData.redSlipTax8Exclusive || 0) + tax8Exclusive,
          redSlipTax10Exclusive: (dailyData.redSlipTax10Exclusive || 0) + tax10Exclusive
        };
        
        await window.updateDoc(dailySalesRef, updateData);
        
        // redSlipsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜
        const redSlipData = {
          ...orderData,
          redSlippedAt: window.Timestamp.now(),
          redSlippedBy: window.currentStoreId,
          businessDate: dateStr,
          originalOrderId: orderData.id,
          calculatedTax8Total: tax8Total,
          calculatedTax10Total: tax10Total
        };
        
        const redSlipRef = window.doc(window.collection(window.db, 'stores', window.currentStoreId, 'redSlips'));
        await window.setDoc(redSlipRef, redSlipData);
        
        // ğŸ†• èµ¤ä¼ç¥¨ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å°åˆ·
        await printRedSlipReceipt(orderData);
        
        // æ³¨æ–‡ã‚’å‰Šé™¤
        await window.deleteDoc(window.getStoreDoc('orders', orderData.id));
        
        await showCustomAlert({ title: 'èµ¤ä¼ç¥¨å®Œäº†', message: `æ³¨æ–‡ #${orderData.orderNumber} ã‚’èµ¤ä¼ç¥¨ã§å–ã‚Šæ¶ˆã—ã¾ã—ãŸ\n\né‡‘é¡: Â¥${totalAmount.toLocaleString()}\n\nå£²ä¸Šãƒ»å®¢æ•°ã‹ã‚‰é™¤å¤–ã•ã‚Œã¾ã—ãŸ`, btnClass: 'modal-btn-primary' });
        
        // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
        await loadHistory();
        
      } catch (e) {
        console.error('èµ¤ä¼ç¥¨ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'èµ¤ä¼ç¥¨å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message,
          type: 'error'
        });
      }
    };
    
    // ========== ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸è¡¨ç¤ºæ©Ÿèƒ½ ==========
    window.reprintReceipt = async function(orderId) {
      try {
        const order = historyOrders.find(o => o.id === orderId);
        if (!order) {
          await showCustomAlert({
            icon: 'âš ï¸',
            title: 'ã‚¨ãƒ©ãƒ¼',
            message: 'æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
            btnClass: 'modal-btn-danger'
          });
          return;
        }
        
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        const orderData = orderDoc.exists() ? orderDoc.data() : {};
        
        // æ³¨æ–‡ç•ªå·ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        let orderNumber = order.orderNumber || orderData.orderNumber || Date.now().toString().slice(-6);
        
        const receiptData = {
          orderNum: orderNumber,
          orderNumber: orderNumber,
          tableNumber: order.tableNumber || orderData.tableNumber || '',
          timestamp: order.timestamp?.toDate?.() || new Date(),
          items: order.items || [],
          total: order.totalAmount || 0,
          tax8Total: orderData.tax8Total || order.tax8Total || 0,
          tax10Total: orderData.tax10Total || order.tax10Total || 0
        };
        
        await showReceiptDisplay(receiptData);
        
      } catch (error) {
        console.error('ãƒ¬ã‚·ãƒ¼ãƒˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'ãƒ¬ã‚·ãƒ¼ãƒˆã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ',
          btnClass: 'modal-btn-danger'
        });
      }
    };
    
    window.reprintInvoice = async function(orderId) {
      try {
        const order = historyOrders.find(o => o.id === orderId);
        if (!order) {
          await showCustomAlert({
            icon: 'âš ï¸',
            title: 'ã‚¨ãƒ©ãƒ¼',
            message: 'æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
            btnClass: 'modal-btn-danger'
          });
          return;
        }
        
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        const orderData = orderDoc.exists() ? orderDoc.data() : {};
        
        // æ³¨æ–‡ç•ªå·ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        let orderNumber = order.orderNumber || orderData.orderNumber || Date.now().toString().slice(-6);
        
        const invoiceData = {
          orderNum: orderNumber,
          orderNumber: orderNumber,
          tableNumber: order.tableNumber || orderData.tableNumber || '',
          timestamp: order.timestamp?.toDate?.() || new Date(),
          items: order.items || [],
          total: order.totalAmount || 0,
          tax8Total: orderData.tax8Total || order.tax8Total || 0,
          tax10Total: orderData.tax10Total || order.tax10Total || 0
        };
        
        await showInvoiceDisplay(invoiceData);
        
      } catch (error) {
        console.error('é ˜åæ›¸è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'é ˜åæ›¸ã®è¡¨ç¤ºã«å¤±æ•—ã—ã¾ã—ãŸ',
          btnClass: 'modal-btn-danger'
        });
      }
    };
    
    // ========== å±¥æ­´ã‹ã‚‰æ³¨æ–‡ç·¨é›† ==========
    
    let currentEditingOrder = null;
    
    window.editOrderFromHistory = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        if (!orderDoc.exists()) {
          await showCustomAlert({ icon: 'âš ', title: 'ã‚¨ãƒ©ãƒ¼', message: 'æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', btnClass: 'modal-btn-danger' });
          return;
        }
        
        const orderData = orderDoc.data();
        
        currentEditingOrder = {
          id: orderId,
          ...orderData,
          originalTotalAmount: orderData.totalAmount,
          originalPaymentMethod: orderData.paymentMethod
        };
        
        // æ”¯æ‰•æ–¹æ³•ã®é¸æŠè‚¢
        const paymentMethods = {
          'cash': 'ç¾é‡‘',
          'emoney': 'é›»å­ãƒãƒãƒ¼',
          'credit': 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰'
        };
        
        let paymentMethodOptions = '';
        Object.keys(paymentMethods).forEach(method => {
          const selected = orderData.paymentMethod === method ? 'selected' : '';
          paymentMethodOptions += `<option value="${method}" ${selected}>${paymentMethods[method]}</option>`;
        });
        
        // å•†å“ãƒªã‚¹ãƒˆ
        let itemsHtml = '';
        if (orderData.items && orderData.items.length > 0) {
          orderData.items.forEach((item, index) => {
            // ãƒˆãƒƒãƒ”ãƒ³ã‚°è¡¨ç¤º
            let toppingsHtml = '';
            if (item.toppingDetails && item.toppingDetails.length > 0) {
              const groupedBySet = {};
              item.toppingDetails.forEach(detail => {
                if (!groupedBySet[detail.setName]) {
                  groupedBySet[detail.setName] = [];
                }
                groupedBySet[detail.setName].push(detail.optionName);
              });
              
              toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
                return `
                  <div style="font-size: 12px; color: #666; font-weight: bold; margin-top: 5px;">${setName}</div>
                  ${options.map(opt => `<div style="font-size: 12px; color: #666; margin-left: 10px;">ãƒ»${opt}</div>`).join('')}
                `;
              }).join('');
            } else if (item.toppingsData && item.toppingsData.length > 0) {
              const groupedBySet = {};
              item.toppingsData.forEach(topping => {
                const setName = topping.setName || 'ãƒˆãƒƒãƒ”ãƒ³ã‚°';
                if (!groupedBySet[setName]) {
                  groupedBySet[setName] = [];
                }
                groupedBySet[setName].push(topping.name);
              });
              
              toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
                return `
                  <div style="font-size: 12px; color: #666; font-weight: bold; margin-top: 5px;">${setName}</div>
                  ${options.map(opt => `<div style="font-size: 12px; color: #666; margin-left: 10px;">ãƒ»${opt}</div>`).join('')}
                `;
              }).join('');
            } else if (item.toppings && item.toppings !== 'ãªã—' && item.toppings !== 'æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°') {
              toppingsHtml = `<div style="font-size: 12px; color: #666;">ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${item.toppings}</div>`;
            }
            
            itemsHtml += `
              <div style="padding: 10px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong>${item.name}</strong>
                    ${toppingsHtml}
                  </div>
                  <button onclick="playTapSound(); removeItemFromOrder(${index})" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
                </div>
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                  <label>æ•°é‡:</label>
                  <input type="number" value="${item.quantity}" onchange="playTapSound(); updateItemQuantity(${index}, this.value)" min="1" style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                  <span style="margin-left: auto; font-weight: bold;">Â¥${((item.price + (item.toppingPrice || 0)) * item.quantity).toLocaleString()}</span>
                </div>
              </div>
            `;
          });
        }
        
        const content = document.getElementById('editOrderContent');
        content.innerHTML = `
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ³¨æ–‡ç•ªå·</label>
            <div style="font-size: 24px; color: #667eea;">#${orderData.orderNumber || 0}</div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·</label>
            <input type="text" id="editTableNumber" value="${orderData.tableNumber || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ”¯æ‰•æ–¹æ³•</label>
            <select id="editPaymentMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
              ${paymentMethodOptions}
            </select>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">æ³¨æ–‡å•†å“</label>
            ${itemsHtml || '<div style="text-align: center; padding: 20px; color: #999;">å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>'}
          </div>
          
          <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; text-align: right;">
            <span style="font-size: 18px; font-weight: bold;">åˆè¨ˆ: </span>
            <span id="editTotalAmount" style="font-size: 24px; font-weight: bold; color: #1976d2;">Â¥${(orderData.totalAmount || 0).toLocaleString()}</span>
          </div>
        `;
        
        // ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«ç”Ÿæˆ
        const buttonsContainer = document.getElementById('editOrderButtons');
        if (orderData.paidAt) {
          // ä¼šè¨ˆæ¸ˆã¿æ³¨æ–‡ï¼šèµ¤ä¼ç¥¨
          buttonsContainer.innerHTML = `
            <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="playTapSound(); saveOrderEdit()">ä¿å­˜</button>
            <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="playTapSound(); redSlipFromEdit()"> èµ¤ä¼ç¥¨</button>
            <button class="btn btn-secondary" style="flex: 1;" onclick="playTapSound(); closeEditOrderModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          `;
        } else {
          // æœªä¼šè¨ˆæ³¨æ–‡
          if (orderData.deleted) {
            // å‰Šé™¤æ¸ˆã¿æœªä¼šè¨ˆæ³¨æ–‡ï¼šå¾©å…ƒå¯èƒ½
            buttonsContainer.innerHTML = `
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="playTapSound(); saveOrderEdit()">ä¿å­˜</button>
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white;" onclick="playTapSound(); restoreOrder()">æ³¨æ–‡ã‚’å¾©å…ƒ</button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="playTapSound(); closeEditOrderModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            `;
          } else {
            // é€šå¸¸ã®æœªä¼šè¨ˆæ³¨æ–‡ï¼šå–æ¶ˆå¯èƒ½
            buttonsContainer.innerHTML = `
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="playTapSound(); saveOrderEdit()">ä¿å­˜</button>
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="playTapSound(); deleteOrderFromEdit()">ğŸ—‘ æ³¨æ–‡å–æ¶ˆ</button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="playTapSound(); closeEditOrderModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            `;
          }
        }
        
        document.getElementById('editOrderModal').style.display = 'flex';
        
      } catch (e) {
        console.error('æ³¨æ–‡ç·¨é›†ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'æ³¨æ–‡ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message,
          type: 'error'
        });
      }
    };
    
    // æ³¨æ–‡ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeEditOrderModal = function() {
      document.getElementById('editOrderModal').style.display = 'none';
      currentEditingOrder = null;
    };
    
    // å•†å“ã‚’æ³¨æ–‡ã‹ã‚‰å‰Šé™¤
    window.removeItemFromOrder = async function(index) {
      if (!currentEditingOrder) return;
      
      const item = currentEditingOrder.items[index];
      const itemName = item.name || 'å•†å“';
      const itemPrice = (item.price + (item.toppingPrice || 0)) * item.quantity;
      
      const confirmed = confirm(`${itemName}\nÂ¥${itemPrice.toLocaleString()}\n\nã“ã®å•†å“ã‚’æ³¨æ–‡ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
      
      if (confirmed) {
        try {
          // å•†å“ã‚’é…åˆ—ã‹ã‚‰å‰Šé™¤
          currentEditingOrder.items.splice(index, 1);
          
          // åˆè¨ˆé‡‘é¡ã‚’å†è¨ˆç®—
          let total = 0;
          let tax8Total = 0;
          let tax10Total = 0;
          
          currentEditingOrder.items.forEach(item => {
            const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
            total += itemTotal;
            
            // ç¨ç‡åˆ¥é›†è¨ˆ
            if (item.taxRate === 8) {
              tax8Total += itemTotal;
            } else {
              tax10Total += itemTotal;
            }
          });
          
          currentEditingOrder.totalAmount = total;
          currentEditingOrder.tax8Total = tax8Total;
          currentEditingOrder.tax10Total = tax10Total;
          
          // Firestoreã«ä¿å­˜
          await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), {
            items: currentEditingOrder.items,
            totalAmount: total,
            tax8Total: tax8Total,
            tax10Total: tax10Total,
            updatedAt: window.Timestamp.now()
          });
          
          // è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†æç”»ï¼‰
          editOrderFromHistory(currentEditingOrder.id);
          
          await showCustomAlert({ icon: '', title: 'ãŠçŸ¥ã‚‰ã›', message: 'å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', btnClass: 'modal-btn-primary' });
          
        } catch (e) {
          console.error('å•†å“å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e);
          await showCustomAlert({
            title: 'ã‚¨ãƒ©ãƒ¼',
            message: 'å•†å“ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message,
            type: 'error'
          });
        }
      }
    };
    
    // å•†å“ã®æ•°é‡ã‚’æ›´æ–°
    window.updateItemQuantity = function(index, newQuantity) {
      if (!currentEditingOrder) return;
      
      const quantity = parseInt(newQuantity) || 1;
      currentEditingOrder.items[index].quantity = quantity;
      
      // åˆè¨ˆé‡‘é¡ã‚’å†è¨ˆç®—
      let total = 0;
      currentEditingOrder.items.forEach(item => {
        total += (item.price + (item.toppingPrice || 0)) * item.quantity;
      });
      currentEditingOrder.totalAmount = total;
      
      // åˆè¨ˆé‡‘é¡ã®è¡¨ç¤ºã‚’æ›´æ–°
      document.getElementById('editTotalAmount').textContent = `Â¥${total.toLocaleString()}`;
    };
    
    // æ³¨æ–‡ã®å¤‰æ›´ã‚’ä¿å­˜
    window.saveOrderEdit = async function() {
      if (!currentEditingOrder) return;
      
      try {
        const tableNumber = document.getElementById('editTableNumber').value;
        const paymentMethod = document.getElementById('editPaymentMethod').value;
        
        const oldPaymentMethod = currentEditingOrder.originalPaymentMethod || currentEditingOrder.paymentMethod;
        const oldTotalAmount = currentEditingOrder.originalTotalAmount || currentEditingOrder.totalAmount;
        const newTotalAmount = currentEditingOrder.totalAmount;
        
        // å…ƒã®paidAtã¾ãŸã¯timestampã‹ã‚‰æ—¥ä»˜ã‚’å–å¾—
        let originalDateStr = null;
        let isUnpaidOrder = false;
        
        try {
          let dateToUse = null;
          
          if (currentEditingOrder.paidAt) {
            dateToUse = currentEditingOrder.paidAt.toDate();
          } else if (currentEditingOrder.timestamp) {
            dateToUse = currentEditingOrder.timestamp.toDate();
            isUnpaidOrder = true;
          }
          
          if (dateToUse) {
            let targetDate = new Date(dateToUse);
            
            // åˆå‰3æ™‚ã‚ˆã‚Šå‰ãªã‚‰æ˜¨æ—¥æ‰±ã„
            if (dateToUse.getHours() < 3) {
              targetDate.setDate(targetDate.getDate() - 1);
            }
            
            originalDateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth()+1).padStart(2,'0')}-${String(targetDate.getDate()).padStart(2,'0')}`;
          } else {
            throw new Error('paidAtã‚‚timestampã‚‚å­˜åœ¨ã—ã¾ã›ã‚“');
          }
        } catch (error) {
          console.error('æ—¥ä»˜ã®å¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
          await showCustomAlert({ icon: '', title: 'ãŠçŸ¥ã‚‰ã›', message: 'æ—¥ä»˜ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã®ã¿æ›´æ–°ã—ã¾ã™ã€‚', btnClass: 'modal-btn-primary' });
          
          await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), {
            tableNumber: tableNumber,
            paymentMethod: paymentMethod,
            items: currentEditingOrder.items,
            totalAmount: currentEditingOrder.totalAmount
          });
          
          closeEditOrderModal();
          await loadHistory();
          return;
        }
        
        // æ³¨æ–‡ã‚’æ›´æ–°
        const orderUpdates = {
          tableNumber: tableNumber,
          paymentMethod: paymentMethod,
          items: currentEditingOrder.items,
          totalAmount: currentEditingOrder.totalAmount,
          tax8Total: currentEditingOrder.tax8Total || 0,
          tax10Total: currentEditingOrder.tax10Total || 0
        };
        
        // æœªä¼šè¨ˆã®æ³¨æ–‡ã‚’ç·¨é›†ã—ãŸå ´åˆã¯ã€ä¼šè¨ˆæ¸ˆã¿ã«ã™ã‚‹
        if (isUnpaidOrder) {
          orderUpdates.paidAt = currentEditingOrder.timestamp;
          orderUpdates.notifiedPaid = true;
          
          await showCustomAlert({ icon: '', title: 'ãŠçŸ¥ã‚‰ã›', message: `æ³¨æ–‡ã‚’æ›´æ–°ã—ã€ä¼šè¨ˆæ¸ˆã¿ã¨ã—ã¾ã—ãŸ\n\nä¼šè¨ˆæ—¥æ™‚: ${originalDateStr}`, btnClass: 'modal-btn-primary' });
        }
        
        await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), orderUpdates);
        
        // dailySalesãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£
        if (currentEditingOrder.paidAt || isUnpaidOrder) {
          await updateDailySalesForEdit(originalDateStr, oldPaymentMethod, oldTotalAmount, paymentMethod, newTotalAmount, currentEditingOrder);
        }
        
        await showCustomAlert({ icon: '', title: 'ãŠçŸ¥ã‚‰ã›', message: 'æ³¨æ–‡ã‚’æ›´æ–°ã—ã¾ã—ãŸ', btnClass: 'modal-btn-primary' });
        
        closeEditOrderModal();
        await loadHistory();
        
      } catch (e) {
        console.error('æ³¨æ–‡ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'æ³¨æ–‡ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message,
          type: 'error'
        });
      }
    };
    
    // dailySalesãƒ‡ãƒ¼ã‚¿ã‚’ç·¨é›†æ™‚ã«æ›´æ–°
    async function updateDailySalesForEdit(dateStr, oldMethod, oldAmount, newMethod, newAmount, order) {
      try {
        const dailySalesRef = window.getStoreDoc('dailySales', dateStr);
        const dailySalesDoc = await window.getDoc(dailySalesRef);
        
        if (!dailySalesDoc.exists()) {
          console.warn('dailySalesãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', dateStr);
          return;
        }
        
        const dailyData = dailySalesDoc.data();
        
        // æ—§ãƒ‡ãƒ¼ã‚¿ã‚’æ¸›ç®—
        const oldCash = (oldMethod === 'cash') ? oldAmount : 0;
        const oldEmone = (oldMethod === 'emoney') ? oldAmount : 0;
        const oldCredit = (oldMethod === 'credit') ? oldAmount : 0;
        
        // æ–°ãƒ‡ãƒ¼ã‚¿ã‚’åŠ ç®—
        const newCash = (newMethod === 'cash') ? newAmount : 0;
        const newEmone = (newMethod === 'emoney') ? newAmount : 0;
        const newCredit = (newMethod === 'credit') ? newAmount : 0;
        
        // ç¨é‡‘ã®å·®åˆ†ã‚’è¨ˆç®—
        const oldTax8 = order.originalTax8Total || 0;
        const oldTax10 = order.originalTax10Total || 0;
        const newTax8 = order.tax8Total || 0;
        const newTax10 = order.tax10Total || 0;
        
        const updateData = {
          totalSales: (dailyData.totalSales || 0) - oldAmount + newAmount,
          cashSales: (dailyData.cashSales || 0) - oldCash + newCash,
          emoneSales: (dailyData.emoneSales || 0) - oldEmone + newEmone,
          creditSales: (dailyData.creditSales || 0) - oldCredit + newCredit,
          tax8Total: (dailyData.tax8Total || 0) - oldTax8 + newTax8,
          tax10Total: (dailyData.tax10Total || 0) - oldTax10 + newTax10
        };
        
        await window.updateDoc(dailySalesRef, updateData);
      } catch (e) {
        console.error('dailySalesæ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    // ç·¨é›†ç”»é¢ã‹ã‚‰èµ¤ä¼ç¥¨
    window.redSlipFromEdit = async function() {
      if (!currentEditingOrder) return;
      closeEditOrderModal();
      await redSlipFromHistory(currentEditingOrder.id);
    };
    
    // ç·¨é›†ç”»é¢ã‹ã‚‰æ³¨æ–‡å–æ¶ˆ
    window.deleteOrderFromEdit = async function() {
      if (!currentEditingOrder) return;
      const confirmed = confirm(`æ³¨æ–‡ #${currentEditingOrder.orderNumber} ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ`);
      if (confirmed) {
        closeEditOrderModal();
        await deleteOrderFromHistory(currentEditingOrder.id);
      }
    };
    
    // æ³¨æ–‡ã‚’å¾©å…ƒ
    window.restoreOrder = async function() {
      if (!currentEditingOrder) return;
      const confirmed = await showCustomAlert({
        title: 'æ³¨æ–‡ã‚’å¾©å…ƒ',
        message: `æ³¨æ–‡ #${currentEditingOrder.orderNumber} ã‚’å¾©å…ƒã—ã¾ã™ã‹?`,
        type: 'warning',
        confirmText: 'å¾©å…ƒ',
        cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
      });
      if (confirmed) {
        closeEditOrderModal();
        await restoreOrderFromHistory(currentEditingOrder.id);
      }
    };
    
    // æ³¨æ–‡ã‚’å–æ¶ˆï¼ˆå‰Šé™¤æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ï¼‰
    window.deleteOrderFromHistory = async function(orderId) {
      try {
        const confirmed = confirm('ã“ã®æ³¨æ–‡ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ');
        if (!confirmed) return;
        
        await window.updateDoc(window.getStoreDoc('orders', orderId), {
          deleted: true,
          deletedAt: window.Timestamp.now()
        });
        
        await showCustomAlert({ icon: '', title: 'ãŠçŸ¥ã‚‰ã›', message: 'æ³¨æ–‡ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ', btnClass: 'modal-btn-primary' });
        await loadHistory();
      } catch (e) {
        console.error('æ³¨æ–‡å–æ¶ˆã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'æ³¨æ–‡ã®å–ã‚Šæ¶ˆã—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message,
          type: 'error'
        });
      }
    };
    
    // æ³¨æ–‡ã‚’å¾©å…ƒ
    window.restoreOrderFromHistory = async function(orderId) {
      try {
        const confirmed = await showCustomAlert({
          title: 'æ³¨æ–‡ã‚’å¾©å…ƒ',
          message: 'ã“ã®æ³¨æ–‡ã‚’å¾©å…ƒã—ã¾ã™ã‹?',
          type: 'warning',
          confirmText: 'å¾©å…ƒ',
          cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
        });
        if (!confirmed) return;
        
        await window.updateDoc(window.getStoreDoc('orders', orderId), {
          deleted: false,
          deletedAt: null
        });
        
        await showCustomAlert({ icon: '', title: 'ãŠçŸ¥ã‚‰ã›', message: 'æ³¨æ–‡ã‚’å¾©å…ƒã—ã¾ã—ãŸ', btnClass: 'modal-btn-primary' });
        await loadHistory();
      } catch (e) {
        console.error('æ³¨æ–‡å¾©å…ƒã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'æ³¨æ–‡ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message,
          type: 'error'
        });
      }
    };
    
    
    // ========== ğŸ’¸ æ”¯å‡ºæ©Ÿèƒ½ ==========
    
    window.showExpenseModal = async function() {
      // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('expenseModal').style.display = 'flex';
      
      // æœ¬æ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
      const now = new Date();
      let today = new Date(now);
      if (now.getHours() < 3) {
        today.setDate(today.getDate() - 1);
      }
      const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      document.getElementById('expenseDateInput').value = dateStr;
      
      await loadExpensesByDate();
    };
    
    window.closeExpenseModal = function() {
      document.getElementById('expenseModal').style.display = 'none';
    };
    
    window.loadExpensesByDate = async function() {
      const dateStr = document.getElementById('expenseDateInput').value;
      if (!dateStr) return;
      
      try {
        const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
        const tbody = document.getElementById('expenseTableBody');
        tbody.innerHTML = '';
        
        if (expenseDoc.exists()) {
          const data = expenseDoc.data();
          const items = data.items || [];
          
          items.forEach(item => {
            addExpenseRowWithData(item);
          });
        } else {
          addExpenseRow();
        }
        
        calculateExpenseTotal();
      } catch (e) {
        console.error('æ”¯å‡ºèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        addExpenseRow();
      }
    };
    
    window.addExpenseRow = function() {
      addExpenseRowWithData({});
    };
    
    function addExpenseRowWithData(data) {
      const tbody = document.getElementById('expenseTableBody');
      const row = tbody.insertRow();
      row.innerHTML = `
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="text" value="${data.storeName || ''}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="åº—å">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <select style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="åŸææ–™è²»" ${data.category === 'åŸææ–™è²»' ? 'selected' : ''}>åŸææ–™è²»</option>
            <option value="å…‰ç†±è²»" ${data.category === 'å…‰ç†±è²»' ? 'selected' : ''}>å…‰ç†±è²»</option>
            <option value="æ¶ˆè€—å“è²»" ${data.category === 'æ¶ˆè€—å“è²»' ? 'selected' : ''}>æ¶ˆè€—å“è²»</option>
            <option value="ãã®ä»–" ${data.category === 'ãã®ä»–' ? 'selected' : ''}>ãã®ä»–</option>
          </select>
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="text" value="${data.detail || ''}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="è©³ç´°">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="number" value="${data.amount || ''}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="é‡‘é¡" onchange="playTapSound(); calculateExpenseTotal()">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
          <button onclick="playTapSound(); this.closest('tr').remove(); calculateExpenseTotal();" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
        </td>
      `;
    }
    
    function calculateExpenseTotal() {
      const tbody = document.getElementById('expenseTableBody');
      const rows = tbody.querySelectorAll('tr');
      let total = 0;
      
      rows.forEach(row => {
        const amountInput = row.querySelector('input[type="number"]');
        const amount = parseInt(amountInput.value) || 0;
        total += amount;
      });
      
      document.getElementById('expenseTotal').textContent = total.toLocaleString();
    }
    
    window.saveExpenses = async function() {
      const dateStr = document.getElementById('expenseDateInput').value;
      if (!dateStr) {
        await showCustomAlert({ icon: '', title: 'ã‚¨ãƒ©ãƒ¼', message: 'æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„', btnClass: 'modal-btn-danger' });
        return;
      }
      
      const tbody = document.getElementById('expenseTableBody');
      const rows = tbody.querySelectorAll('tr');
      const items = [];
      let total = 0;
      
      rows.forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        const storeName = inputs[0].value;
        const category = inputs[1].value;
        const detail = inputs[2].value;
        const amount = parseInt(inputs[3].value) || 0;
        
        if (storeName || category || detail || amount) {
          items.push({ storeName, category, detail, amount });
          total += amount;
        }
      });
      
      try {
        await window.setDoc(window.getStoreDoc('expenses', dateStr), {
          date: dateStr,
          items: items,
          total: total,
          updatedAt: window.Timestamp.now()
        });
        
        await showCustomAlert({ 
          icon: '', 
          title: 'ä¿å­˜å®Œäº†', 
          message: 'æ”¯å‡ºã‚’ä¿å­˜ã—ã¾ã—ãŸ', 
          btnClass: 'modal-btn-success' 
        });
      } catch (e) {
        console.error('æ”¯å‡ºä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({ 
          icon: '', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'æ”¯å‡ºã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    // ========== ğŸ“Š æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ==========
    
    window.showMonthlyReportModal = function() {
      // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('monthlyReportModal').style.display = 'flex';
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä»Šæœˆã®ç¯„å›²ã‚’è¨­å®š
      const now = new Date();
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      
      document.getElementById('reportStartDate').value = `${firstDay.getFullYear()}-${String(firstDay.getMonth()+1).padStart(2,'0')}-${String(firstDay.getDate()).padStart(2,'0')}`;
      document.getElementById('reportEndDate').value = `${lastDay.getFullYear()}-${String(lastDay.getMonth()+1).padStart(2,'0')}-${String(lastDay.getDate()).padStart(2,'0')}`;
    };
    
    window.closeMonthlyReportModal = function() {
      document.getElementById('monthlyReportModal').style.display = 'none';
    };
    
    // ===== æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆ =====
    window.generatePeriodJournal = async function() {
      try {
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;
        
        if (!startDate || !endDate) {
          await showCustomAlert({
            title: 'è­¦å‘Š',
            message: 'é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„',
            type: 'warning'
          });
          return;
        }
        
        if (startDate > endDate) {
          await showCustomAlert({
            title: 'è­¦å‘Š',
            message: 'é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„',
            type: 'warning'
          });
          return;
        }
        
        console.log(`ğŸ“Š æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆ: ${startDate} ï½ ${endDate}`);
        
        const container = document.getElementById('monthlyReportContent');
        container.innerHTML = '<div style="text-align: center; padding: 40px;">ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆä¸­...</div>';
        
        // æœŸé–“å†…ã®å…¨æ—¥ä»˜ã‚’ç”Ÿæˆ
        const start = new Date(startDate);
        const end = new Date(endDate);
        const dates = [];
        
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
          dates.push(dateStr);
        }
        
        // å„æ—¥ä»˜ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦åˆè¨ˆ
        let totalCustomerCount = 0;
        let totalItems = 0;
        let totalCashSales = 0;
        let totalEmoneSales = 0;
        let totalCreditSales = 0;
        let totalDiscount = 0;
        let totalTax8 = 0;
        let totalTax10 = 0;
        let totalDrawerOpen = 0;
        let totalRedSlipCount = 0;  // ğŸ†• èµ¤ä¼ç¥¨ä»¶æ•°
        let totalRedSlipAmount = 0;  // ğŸ†• èµ¤ä¼ç¥¨é‡‘é¡
        let totalRedSlipTax8 = 0;  // ğŸ†• èµ¤ä¼ç¥¨8%ç¨é‡‘
        let totalRedSlipTax10 = 0;  // ğŸ†• èµ¤ä¼ç¥¨10%ç¨é‡‘
        let totalRedSlipTax8Inclusive = 0;  // ğŸ†• èµ¤ä¼ç¥¨8%å†…ç¨
        let totalRedSlipTax10Inclusive = 0;  // ğŸ†• èµ¤ä¼ç¥¨10%å†…ç¨
        let totalRedSlipTax8Exclusive = 0;  // ğŸ†• èµ¤ä¼ç¥¨8%å¤–ç¨
        let totalRedSlipTax10Exclusive = 0;  // ğŸ†• èµ¤ä¼ç¥¨10%å¤–ç¨
        let totalExpense = 0;
        let totalLaborCost = 0;
        const itemCounts = {}; // å•†å“åˆ¥ã‚«ã‚¦ãƒ³ãƒˆ
        
        // ordersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç›´æ¥å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
        const ordersQuery = window.query(
          window.getStoreCollection('orders'),
          window.where('paidAt', '!=', null)
        );
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          // paidAtã‚’ä½¿ç”¨ã—ã¦ä¼šè¨ˆæ—¥æ™‚ã‚’å–å¾—
          if (!data.paidAt) return;
          
          const orderDate = data.paidAt.toDate();
          
          // 3æ™‚åŸºæº–ã®å–¶æ¥­æ—¥è¨ˆç®—
          let targetDate = new Date(orderDate);
          if (orderDate.getHours() < 3) {
            targetDate.setDate(targetDate.getDate() - 1);
          }
          
          const orderDateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-${String(targetDate.getDate()).padStart(2, '0')}`;
          
          // æœŸé–“å†…ã®æ³¨æ–‡ã®ã¿
          if (dates.includes(orderDateStr) && data.items) {
            data.items.forEach(item => {
              itemCounts[item.name] = (itemCounts[item.name] || 0) + (item.quantity || 1);
            });
          }
        });
        
        console.log(' ordersã‹ã‚‰é›†è¨ˆã—ãŸå•†å“ãƒ‡ãƒ¼ã‚¿:', itemCounts);
        
        for (const dateStr of dates) {
          // å£²ä¸Šãƒ‡ãƒ¼ã‚¿
          const salesDoc = await window.getDoc(window.getStoreDoc('dailySales', dateStr));
          if (salesDoc.exists()) {
            const data = salesDoc.data();
            totalCustomerCount += data.customerCount || 0;
            totalItems += data.totalItems || 0;
            totalCashSales += data.cashSales || 0;
            totalEmoneSales += data.emoneSales || 0;
            totalCreditSales += data.creditSales || 0;
            totalDiscount += data.totalDiscount || 0;
            totalTax8 += data.tax8Total || 0;
            totalTax10 += data.tax10Total || 0;
            totalDrawerOpen += data.drawerOpenCount || 0;
            totalRedSlipCount += data.redSlipCount || 0;  // ğŸ†• èµ¤ä¼ç¥¨ä»¶æ•°
            totalRedSlipAmount += data.redSlipAmount || 0;  // ğŸ†• èµ¤ä¼ç¥¨é‡‘é¡
            totalRedSlipTax8 += data.redSlipTax8Total || 0;  // ğŸ†• èµ¤ä¼ç¥¨8%ç¨é‡‘
            totalRedSlipTax10 += data.redSlipTax10Total || 0;  // ğŸ†• èµ¤ä¼ç¥¨10%ç¨é‡‘
            totalRedSlipTax8Inclusive += data.redSlipTax8Inclusive || 0;  // ğŸ†• èµ¤ä¼ç¥¨8%å†…ç¨
            totalRedSlipTax10Inclusive += data.redSlipTax10Inclusive || 0;  // ğŸ†• èµ¤ä¼ç¥¨10%å†…ç¨
            totalRedSlipTax8Exclusive += data.redSlipTax8Exclusive || 0;  // ğŸ†• èµ¤ä¼ç¥¨8%å¤–ç¨
            totalRedSlipTax10Exclusive += data.redSlipTax10Exclusive || 0;  // ğŸ†• èµ¤ä¼ç¥¨10%å¤–ç¨
          }
          
          // æ”¯å‡ºãƒ‡ãƒ¼ã‚¿
          const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
          if (expenseDoc.exists()) {
            totalExpense += expenseDoc.data().total || 0;
          }
          
          // äººä»¶è²»ãƒ‡ãƒ¼ã‚¿
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(doc => {
            const attData = doc.data();
            if (attData.date === dateStr) {
              // æ—¢ã«è¨ˆç®—æ¸ˆã¿ã®ç·è³ƒé‡‘ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
              if (attData.totalWage && attData.totalWage > 0) {
                totalLaborCost += attData.totalWage;
              } else if (attData.clockIn && attData.clockOut) {
                // ç·è³ƒé‡‘ãŒãªã„å ´åˆã¯è¨ˆç®—ã™ã‚‹
                const clockIn = new Date(`${dateStr} ${attData.clockIn}`);
                const clockOut = new Date(`${dateStr} ${attData.clockOut}`);
                let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                
                if (attData.breakStart1 && attData.breakEnd1) {
                  const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                  const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                  workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                }
                if (attData.breakStart2 && attData.breakEnd2) {
                  const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                  const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                  workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                }
                
                const hourlyRate = attData.hourlyRate || 1150;
                
                // å‰²å¢—è³ƒé‡‘ã®è¨ˆç®—
                let totalWage = 0;
                const isHoliday = attData.isHoliday || false;
                
                // æ™‚é–“ã”ã¨ã«å‰²å¢—ç‡ã‚’è¨ˆç®—
                let currentTime = new Date(clockIn);
                const endTime = new Date(clockOut);
                
                while (currentTime < endTime) {
                  const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                  const segmentEnd = nextHour > endTime ? endTime : nextHour;
                  
                  // ä¼‘æ†©æ™‚é–“ã‚’é™¤å¤–
                  let isBreak = false;
                  if (attData.breakStart1 && attData.breakEnd1) {
                    const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                    const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                    if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                      isBreak = true;
                    }
                  }
                  if (attData.breakStart2 && attData.breakEnd2) {
                    const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                    const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                    if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                      isBreak = true;
                    }
                  }
                  
                  if (!isBreak) {
                    const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                    const hour = currentTime.getHours();
                    
                    let rate = 1.0;
                    if (isHoliday) {
                      // ä¼‘æ—¥å‡ºå‹¤: åŸºæœ¬35%å¢—
                      rate = 1.35;
                      // 22æ™‚ï½5æ™‚ã¯æ·±å¤œå‰²å¢—25%ã‚’è¿½åŠ ï¼ˆåˆè¨ˆ60%å¢—ï¼‰
                      if (hour >= 22 || hour < 5) {
                        rate = 1.60;
                      }
                    } else {
                      // å¹³æ—¥: 22æ™‚ï½5æ™‚ã¯æ·±å¤œå‰²å¢—25%
                      if (hour >= 22 || hour < 5) {
                        rate = 1.25;
                      }
                    }
                    
                    totalWage += segmentHours * hourlyRate * rate;
                  }
                  
                  currentTime = segmentEnd;
                }
                
                totalLaborCost += totalWage;
              }
            }
          });
        }
        
        // è¨ˆç®—
        const totalSales = totalCashSales + totalEmoneSales + totalCreditSales;
        const averageSpend = totalCustomerCount > 0 ? Math.round(totalSales / totalCustomerCount) : 0;
        
        // ğŸ†• å¤–ç¨ãƒ»å†…ç¨ã‚’åŒºåˆ¥ã—ã¦è¨ˆç®—
        // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¤–ç¨ã¨å†…ç¨ã‚’åˆ†é›¢
        let tax8InclusiveTotal = 0;
        let tax10InclusiveTotal = 0;
        let tax8ExclusiveTotal = 0;
        let tax10ExclusiveTotal = 0;
        // ğŸ†• èµ¤ä¼ç¥¨ã®å†…ç¨ãƒ»å¤–ç¨ã¯æ—¢ã«dailySalesã‹ã‚‰å–å¾—æ¸ˆã¿
        // (totalRedSlipTax8Inclusive, totalRedSlipTax10Inclusive, 
        //  totalRedSlipTax8Exclusive, totalRedSlipTax10Exclusive)
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          if (!data.paidAt || !data.items) return;
          
          const orderDate = data.paidAt.toDate();
          let targetDate = new Date(orderDate);
          if (orderDate.getHours() < 3) {
            targetDate.setDate(targetDate.getDate() - 1);
          }
          
          const orderDateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-${String(targetDate.getDate()).padStart(2, '0')}`;
          
          if (dates.includes(orderDateStr)) {
            data.items.forEach(item => {
              const taxType = item.taxType || 'inclusive';
              const taxAmount = getTaxAmount(item, item.quantity || 1);
              
              if ((item.taxRate || 10) === 8) {
                if (taxType === 'exclusive') {
                  tax8ExclusiveTotal += taxAmount;
                } else {
                  tax8InclusiveTotal += taxAmount;
                }
              } else {
                if (taxType === 'exclusive') {
                  tax10ExclusiveTotal += taxAmount;
                } else {
                  tax10InclusiveTotal += taxAmount;
                }
              }
            });
          }
        });
        
        // ğŸ†• èµ¤ä¼ç¥¨ã®å†…ç¨ãƒ»å¤–ç¨ãŒdailySalesã«ä¿å­˜ã•ã‚Œã¦ã„ãªã„å ´åˆã¯redSlipsã‹ã‚‰è¨ˆç®—
        if ((totalRedSlipTax8Inclusive === 0 && totalRedSlipTax8Exclusive === 0 && 
             totalRedSlipTax10Inclusive === 0 && totalRedSlipTax10Exclusive === 0) &&
            totalRedSlipCount > 0) {
          console.log('âš ï¸ dailySalesã«èµ¤ä¼ç¥¨ã®å†…ç¨ãƒ»å¤–ç¨ãŒä¿å­˜ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€redSlipsã‹ã‚‰è¨ˆç®—ã—ã¾ã™');
          try {
            const redSlipsSnapshot = await window.getDocs(window.getStoreCollection('redSlips'));
            redSlipsSnapshot.forEach(doc => {
              const data = doc.data();
              if (!data.businessDate || !dates.includes(data.businessDate) || !data.items) return;
              
              data.items.forEach(item => {
                const taxType = item.taxType || 'inclusive';
                const taxAmount = getTaxAmount(item, item.quantity || 1);
                
                if ((item.taxRate || 10) === 8) {
                  if (taxType === 'exclusive') {
                    totalRedSlipTax8Exclusive += taxAmount;
                  } else {
                    totalRedSlipTax8Inclusive += taxAmount;
                  }
                } else {
                  if (taxType === 'exclusive') {
                    totalRedSlipTax10Exclusive += taxAmount;
                  } else {
                    totalRedSlipTax10Inclusive += taxAmount;
                  }
                }
              });
            });
            console.log('âœ… redSlipsã‹ã‚‰è¨ˆç®—å®Œäº†:', {
              totalRedSlipTax8Inclusive,
              totalRedSlipTax8Exclusive,
              totalRedSlipTax10Inclusive,
              totalRedSlipTax10Exclusive
            });
          } catch (e) {
            console.error('redSlipså–å¾—ã‚¨ãƒ©ãƒ¼:', e);
          }
        }
        
        // æ—§è¨ˆç®—ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
        const tax8Excluded = Math.floor(totalTax8 / 1.08);
        const tax10Excluded = Math.floor(totalTax10 / 1.10);
        const tax8Amount = totalTax8 - tax8Excluded;
        const tax10Amount = totalTax10 - tax10Excluded;
        const totalTax = tax8Amount + tax10Amount;
        const taxExcludedTotal = tax8Excluded + tax10Excluded;
        const taxIncludedTotal = totalTax8 + totalTax10;
        const finalTotalSales = taxIncludedTotal - totalDiscount - totalExpense;
        
        const now = new Date();
        const outputTime = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        
        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
        const journalText = `
=====================================
      æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«
=====================================
æœŸé–“: ${startDate} ï½ ${endDate}
å‡ºåŠ›æ™‚åˆ»: ${outputTime}
å®¢æ•°: ${totalCustomerCount}çµ„
ç·å£²ä¸Šç‚¹æ•°: ${totalItems}ç‚¹
å¹³å‡å®¢å˜ä¾¡: Â¥${averageSpend.toLocaleString()}
åˆè¨ˆå£²ä¸Š: Â¥${totalSales.toLocaleString()}

-------------------------------------
å£²ä¸Šå†…è¨³
-------------------------------------
ç¾é‡‘: Â¥${totalCashSales.toLocaleString()}
é›»å­ãƒãƒãƒ¼: Â¥${totalEmoneSales.toLocaleString()}
ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰: Â¥${totalCreditSales.toLocaleString()}
å€¤å¼•ã: Â¥${totalDiscount.toLocaleString()}

-------------------------------------
ç¨é‡‘å†…è¨³
-------------------------------------
ã€8%è»½æ¸›ç¨ç‡ã€‘
å†…ç¨ã®æ¶ˆè²»ç¨: Â¥${tax8InclusiveTotal.toLocaleString()}
å¤–ç¨ã®æ¶ˆè²»ç¨: Â¥${tax8ExclusiveTotal.toLocaleString()}
8%åˆè¨ˆ: Â¥${(tax8InclusiveTotal + tax8ExclusiveTotal).toLocaleString()}

ã€10%æ¨™æº–ç¨ç‡ã€‘
å†…ç¨ã®æ¶ˆè²»ç¨: Â¥${tax10InclusiveTotal.toLocaleString()}
å¤–ç¨ã®æ¶ˆè²»ç¨: Â¥${tax10ExclusiveTotal.toLocaleString()}
10%åˆè¨ˆ: Â¥${(tax10InclusiveTotal + tax10ExclusiveTotal).toLocaleString()}

æ¶ˆè²»ç¨ã®åˆè¨ˆ: Â¥${(tax8InclusiveTotal + tax8ExclusiveTotal + tax10InclusiveTotal + tax10ExclusiveTotal).toLocaleString()}
ç¨æŠœåˆè¨ˆ: Â¥${taxExcludedTotal.toLocaleString()}
ç¨è¾¼åˆè¨ˆ: Â¥${taxIncludedTotal.toLocaleString()}

æ”¯å‡º: Â¥${totalExpense.toLocaleString()}
åˆè¨ˆå£²ä¸Š: Â¥${(taxIncludedTotal - totalExpense).toLocaleString()}
${totalRedSlipCount > 0 ? `
-------------------------------------
èµ¤ä¼ç¥¨ã®ç¨é‡‘å†…è¨³
-------------------------------------
8%ã®èµ¤ä¼ç¥¨ï¼ˆç¨æŠœï¼‰: -Â¥${Math.floor(totalRedSlipTax8 / 1.08).toLocaleString()}
8%ã®èµ¤ä¼ç¥¨ï¼ˆç¨è¾¼ï¼‰: -Â¥${totalRedSlipTax8.toLocaleString()}
8%ã®èµ¤ä¼ç¥¨ã®æ¶ˆè²»ç¨: -Â¥${(totalRedSlipTax8 - Math.floor(totalRedSlipTax8 / 1.08)).toLocaleString()}
  å†…ç¨: -Â¥${totalRedSlipTax8Inclusive.toLocaleString()}
  å¤–ç¨: -Â¥${totalRedSlipTax8Exclusive.toLocaleString()}

10%ã®èµ¤ä¼ç¥¨ï¼ˆç¨æŠœï¼‰: -Â¥${Math.floor(totalRedSlipTax10 / 1.10).toLocaleString()}
10%ã®èµ¤ä¼ç¥¨ï¼ˆç¨è¾¼ï¼‰: -Â¥${totalRedSlipTax10.toLocaleString()}
10%ã®èµ¤ä¼ç¥¨ã®æ¶ˆè²»ç¨: -Â¥${(totalRedSlipTax10 - Math.floor(totalRedSlipTax10 / 1.10)).toLocaleString()}
  å†…ç¨: -Â¥${totalRedSlipTax10Inclusive.toLocaleString()}
  å¤–ç¨: -Â¥${totalRedSlipTax10Exclusive.toLocaleString()}

èµ¤ä¼ç¥¨æ¶ˆè²»ç¨ã®åˆè¨ˆ: -Â¥${((totalRedSlipTax8 - Math.floor(totalRedSlipTax8 / 1.08)) + (totalRedSlipTax10 - Math.floor(totalRedSlipTax10 / 1.10))).toLocaleString()}
èµ¤ä¼ç¥¨ç¨æŠœåˆè¨ˆ: -Â¥${(Math.floor(totalRedSlipTax8 / 1.08) + Math.floor(totalRedSlipTax10 / 1.10)).toLocaleString()}
èµ¤ä¼ç¥¨ç¨è¾¼åˆè¨ˆ: -Â¥${(totalRedSlipTax8 + totalRedSlipTax10).toLocaleString()}
` : ''}

-------------------------------------
ãã®ä»–
-------------------------------------
ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æ•°: ${totalDrawerOpen}å›
èµ¤ä¼ç¥¨ä»¶æ•°: ${totalRedSlipCount}ä»¶
èµ¤ä¼ç¥¨é‡‘é¡: Â¥${totalRedSlipAmount.toLocaleString()}
äººä»¶è²»: Â¥${Math.round(totalLaborCost).toLocaleString()}

=====================================
`;
        
        // PNGç”»åƒã¨ã—ã¦ä¿å­˜
        const journalDiv = document.createElement('div');
        journalDiv.style.cssText = `
          font-family: 'Courier New', monospace;
          font-size: 14px;
          line-height: 1.6;
          padding: 30px;
          background: white;
          color: black;
          white-space: pre-wrap;
          position: absolute;
          left: -9999px;
        `;
        
        // HTMLã¨ã—ã¦ç”Ÿæˆã—ã€æ”¯å‡ºã¨åˆè¨ˆå£²ä¸Šã‚’èµ¤è‰²ã«ã™ã‚‹
        journalDiv.innerHTML = journalText
          .replace(/^(æ”¯å‡º: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>')
          .replace(/^(åˆè¨ˆå£²ä¸Š: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>');
        
        document.body.appendChild(journalDiv);
        
        const canvas = await html2canvas(journalDiv, {
          backgroundColor: '#ffffff',
          scale: 2
        });
        
        document.body.removeChild(journalDiv);
        
        const link = document.createElement('a');
        link.download = `æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«_${startDate}_${endDate}.png`;
        link.href = canvas.toDataURL();
        link.click();
        
        console.log('âœ… æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆå®Œäº†');
        
        // å•†å“ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚½ãƒ¼ãƒˆï¼ˆè²©å£²æ•°ãŒå¤šã„é †ï¼‰
        const sortedItems = Object.entries(itemCounts).sort((a, b) => b[1] - a[1]);
        console.log('ğŸ“Š é›†è¨ˆã•ã‚ŒãŸå•†å“ãƒ‡ãƒ¼ã‚¿:', itemCounts);
        console.log('ğŸ“Š ã‚½ãƒ¼ãƒˆå¾Œã®å•†å“ãƒ‡ãƒ¼ã‚¿:', sortedItems);
        
        // å•†å“ã‚«ã‚¦ãƒ³ãƒˆã®HTMLç”Ÿæˆ
        let itemCountsHtml = '';
        sortedItems.forEach(([itemName, count]) => {
          itemCountsHtml += `
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
              <span>${itemName}</span>
              <strong>${count}å€‹</strong>
            </div>
          `;
        });
        
        // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        container.innerHTML = `
          <div style="padding: 20px;">
            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border-radius: 12px; margin-bottom: 20px;">
              <div style="font-size: 18px; margin-bottom: 10px;">âœ… ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ</div>
              <div style="font-size: 14px; opacity: 0.9;">æœŸé–“: ${startDate} ï½ ${endDate}</div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
              <h4 style="margin: 0 0 15px 0; color: #333;">æœŸé–“ã‚µãƒãƒªãƒ¼</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ç·å£²ä¸Š</div>
                  <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">Â¥${(totalCashSales + totalEmoneSales + totalCreditSales).toLocaleString()}</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">å®¢æ•°</div>
                  <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${totalCustomerCount}çµ„</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">è²©å£²ç‚¹æ•°</div>
                  <div style="font-size: 24px; font-weight: bold; color: #FF9800;">${totalItems}ç‚¹</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">å¹³å‡å®¢å˜ä¾¡</div>
                  <div style="font-size: 24px; font-weight: bold; color: #9C27B0;">Â¥${totalCustomerCount > 0 ? Math.round((totalCashSales + totalEmoneSales + totalCreditSales) / totalCustomerCount).toLocaleString() : 0}</div>
                </div>
              </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
              <h4 style="margin: 0 0 15px 0; color: #333;">ğŸ’³ æ”¯æ‰•æ–¹æ³•åˆ¥</h4>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>ç¾é‡‘</span>
                <strong>Â¥${totalCashSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>é›»å­ãƒãƒãƒ¼</span>
                <strong>Â¥${totalEmoneSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</span>
                <strong>Â¥${totalCreditSales.toLocaleString()}</strong>
              </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
              <h4 style="margin: 0 0 15px 0; color: #333;">å•†å“åˆ¥è²©å£²æ•°</h4>
              <div style="max-height: 300px; overflow-y: auto;">
                ${itemCountsHtml || '<div style="text-align: center; color: #999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'}
              </div>
            </div>
          </div>
        `;
        
      } catch (e) {
        console.error('âŒ æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ',
          type: 'error'
        });
      }
    };
    
    // ğŸ†• ç²¾ç®—ã‚’å®Ÿè¡Œï¼ˆCSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰

    // ğŸ†• æœ¬æ—¥ã®ç²¾ç®—ã‚’ç›´æ¥å®Ÿè¡Œï¼ˆå£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ï¼‰
    window.executeDailySettlement = async function() {
      try {
        // ğŸ†• ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        const shouldBackup = await new Promise((resolve) => {
          const modal = document.createElement('div');
          modal.id = 'backupConfirmModal';
          modal.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); display: flex; align-items: center; 
            justify-content: center; z-index: 999999; animation: fadeIn 0.2s;
          `;
          
          modal.innerHTML = `
            <div style="
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              border-radius: 24px; padding: 0; max-width: 500px; width: 90%;
              max-height: 85vh; display: flex; flex-direction: column;
              box-shadow: 0 25px 60px rgba(0,0,0,0.4); overflow: hidden;
              animation: slideUp 0.3s;
            ">
              <div style="background: white; padding: 32px; border-radius: 0 0 24px 24px; overflow-y: auto; flex: 1;">
                <div style="text-align: center; margin-bottom: 24px;">
                  <h3 style="font-size: 22px; font-weight: bold; color: #333; margin-bottom: 8px;">
                    ç²¾ç®—ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ
                  </h3>
                </div>
                
                <div style="background: #f0f7ff; border-left: 4px solid #667eea; padding: 16px; border-radius: 8px; margin-bottom: 16px;">
                  <div style="font-weight: bold; color: #667eea; margin-bottom: 10px; font-size: 15px;">ã€æ¨å¥¨: ã¯ã„ã€‘</div>
                  <div style="color: #555; font-size: 13px; line-height: 1.6;">
                    ä»¥ä¸‹ãŒãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã•ã‚Œã¾ã™ï¼š<br>
                    â€¢ å•†å“<br>
                    â€¢ å¾“æ¥­å“¡<br>
                    â€¢ æ³¨æ–‡å±¥æ­´<br>
                    â€¢ å‹¤æ€ ãƒ‡ãƒ¼ã‚¿<br>
                    â€¢ å•†å“ã‚«ãƒ†ã‚´ãƒªè¨­å®š<br>
                    â€¢ ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®š<br>
                    â€¢ åœ¨åº«è¨­å®š<br>
                    â€¢ ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š<br>
                    â€¢ å–¶æ¥­æ™‚é–“è¨­å®š<br>
                    â€¢ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š<br><br>
                    èª¤ã£ã¦å‰Šé™¤ã—ãŸå ´åˆã«å¾©å…ƒã§ãã¾ã™ã€‚<br>
                    éå»7æ—¥åˆ†ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè‡ªå‹•ä¿æŒã•ã‚Œã¾ã™ã€‚
                  </div>
                </div>
                
                <div style="background: #fff9e6; border-left: 4px solid #ff9800; padding: 14px; border-radius: 8px; margin-bottom: 20px;">
                  <div style="font-weight: bold; color: #ff9800; margin-bottom: 6px; font-size: 14px;">ã€ã„ã„ãˆã‚’é¸æŠã—ãŸå ´åˆã€‘</div>
                  <div style="color: #666; font-size: 13px;">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã—ã§ç²¾ç®—ã‚’å®Ÿè¡Œã—ã¾ã™</div>
                </div>
                
                <div style="display: flex; gap: 12px; position: sticky; bottom: 0; background: white; padding: 10px 0 0 0;">
                  <button id="backupNoBtn" style="
                    flex: 1; padding: 16px; font-size: 16px; font-weight: bold;
                    border: 2px solid #ddd; border-radius: 12px; cursor: pointer;
                    background: white; color: #666; transition: all 0.2s;
                  " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                    ã„ã„ãˆ
                  </button>
                  <button id="backupYesBtn" style="
                    flex: 1; padding: 16px; font-size: 16px; font-weight: bold;
                    border: none; border-radius: 12px; cursor: pointer;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                    transition: all 0.2s;
                  " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.5)'" 
                     onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'">
                    ã¯ã„ï¼ˆæ¨å¥¨ï¼‰
                  </button>
                </div>
              </div>
            </div>
          `;
          
          document.body.appendChild(modal);
          
          const yesBtn = document.getElementById('backupYesBtn');
          const noBtn = document.getElementById('backupNoBtn');
          
          const handleYes = () => {
            playTapSound();
            yesBtn.removeEventListener('click', handleYes);
            noBtn.removeEventListener('click', handleNo);
            modal.remove();
            resolve(true);
          };
          
          const handleNo = () => {
            playTapSound();
            yesBtn.removeEventListener('click', handleYes);
            noBtn.removeEventListener('click', handleNo);
            modal.remove();
            resolve(false);
          };
          
          yesBtn.addEventListener('click', handleYes);
          noBtn.addEventListener('click', handleNo);
        });
        
        if (shouldBackup) {
          console.log('ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã™');
          const backupSuccess = await window.createAutoBackup();
          if (!backupSuccess) {
            const continueAnyway = await showCustomAlert({
              title: 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼',
              message: 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nãã‚Œã§ã‚‚ç²¾ç®—ã‚’ç¶šã‘ã¾ã™ã‹ï¼Ÿ',
              type: 'warning',
              confirmText: 'ç¶šã‘ã‚‹',
              cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
            });
            if (!continueAnyway) {
              return;
            }
          } else {
            console.log('âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆå®Œäº† - ç²¾ç®—ã‚’ç¶šè¡Œã—ã¾ã™');
          }
        } else {
          console.log('âš ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ç²¾ç®—ã‚’å®Ÿè¡Œã—ã¾ã™');
        }
        
        // æœ¬æ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆ3æ™‚åŸºæº–ï¼‰
        const now = new Date();
        let today = new Date(now);
        if (now.getHours() < 3) {
          today.setDate(today.getDate() - 1);
        }
        const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
        
        await executeSettlement(dateStr);
        
      } catch (e) {
        console.error('âŒ ç²¾ç®—ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'ç²¾ç®—å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ',
          type: 'error'
        });
      }
    };
    
    // ç²¾ç®—å‡¦ç†ã®å…±é€šé–¢æ•°
    async function executeSettlement(dateStr) {
        
        // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        const confirmed = await showCustomAlert({
          title: 'ç²¾ç®—ã‚’å®Ÿè¡Œ',
          message: `${dateStr}ã®ç²¾ç®—ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\nã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆPNGå½¢å¼ï¼‰ãŒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚`,
          type: 'warning',
          confirmText: 'å®Ÿè¡Œ',
          cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
        });
        
        if (!confirmed) return;
        
        // å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        if (!salesDoc.exists()) {
          await showCustomAlert({
            title: 'ã‚¨ãƒ©ãƒ¼',
            message: 'æŒ‡å®šæ—¥ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
            type: 'error'
          });
          return;
        }
        
        const settlementData = salesDoc.data();
        
        // ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—
        const now = new Date();
        const outputTime = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        
        // åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const customerCount = settlementData.customerCount || 0;
        const totalItems = settlementData.totalItems || 0;
        const totalSales = settlementData.totalSales || 0;
        const averageSpend = customerCount > 0 ? Math.round(totalSales / customerCount) : 0;
        
        const cashSales = settlementData.cashSales || 0;
        const emoneSales = settlementData.emoneSales || 0;
        const creditSales = settlementData.creditSales || 0;
        const discountTotal = settlementData.totalDiscount || 0;
        
        const tax8Total = settlementData.tax8Total || 0;
        const tax10Total = settlementData.tax10Total || 0;
        
        // ğŸ†• èµ¤ä¼ç¥¨æƒ…å ±ã‚’å–å¾—
        const redSlipCount = settlementData.redSlipCount || 0;
        const redSlipAmount = settlementData.redSlipAmount || 0;
        const redSlipTax8Total = settlementData.redSlipTax8Total || 0;
        const redSlipTax10Total = settlementData.redSlipTax10Total || 0;
        console.log('ğŸ”´ èµ¤ä¼ç¥¨ä»¶æ•°:', redSlipCount);
        console.log('ğŸ”´ èµ¤ä¼ç¥¨é‡‘é¡:', redSlipAmount);
        console.log('ğŸ”´ èµ¤ä¼ç¥¨8%ç¨é‡‘:', redSlipTax8Total);
        console.log('ğŸ”´ èµ¤ä¼ç¥¨10%ç¨é‡‘:', redSlipTax10Total);
        
        // å†…ç¨ãƒ»å¤–ç¨ã®å†…è¨³ã‚’æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é›†è¨ˆ
        let tax8InclusiveTotal = 0;
        let tax10InclusiveTotal = 0;
        let tax8ExclusiveTotal = 0;
        let tax10ExclusiveTotal = 0;
        // ğŸ†• èµ¤ä¼ç¥¨ã®å†…ç¨ãƒ»å¤–ç¨ã‚’dailySalesã‹ã‚‰å–å¾—
        let redSlipTax8Inclusive = settlementData.redSlipTax8Inclusive || 0;
        let redSlipTax10Inclusive = settlementData.redSlipTax10Inclusive || 0;
        let redSlipTax8Exclusive = settlementData.redSlipTax8Exclusive || 0;
        let redSlipTax10Exclusive = settlementData.redSlipTax10Exclusive || 0;
        
        const ordersQuery = window.query(
          window.getStoreCollection('orders'),
          window.where('paidAt', '!=', null)
        );
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          if (!data.paidAt || !data.items) return;
          
          const orderDate = data.paidAt.toDate();
          let targetDate = new Date(orderDate);
          if (orderDate.getHours() < 3) {
            targetDate.setDate(targetDate.getDate() - 1);
          }
          
          const orderDateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-${String(targetDate.getDate()).padStart(2, '0')}`;
          
          if (orderDateStr === dateStr) {
            data.items.forEach(item => {
              const taxType = item.taxType || 'inclusive';
              const taxAmount = getTaxAmount(item, item.quantity || 1);
              
              if ((item.taxRate || 10) === 8) {
                if (taxType === 'exclusive') {
                  tax8ExclusiveTotal += taxAmount;
                } else {
                  tax8InclusiveTotal += taxAmount;
                }
              } else {
                if (taxType === 'exclusive') {
                  tax10ExclusiveTotal += taxAmount;
                } else {
                  tax10InclusiveTotal += taxAmount;
                }
              }
            });
          }
        });
        
        // ğŸ†• èµ¤ä¼ç¥¨ã®å†…ç¨ãƒ»å¤–ç¨ã‚’redSlipsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰è¨ˆç®—ï¼ˆdailySalesã«ä¿å­˜ã•ã‚Œã¦ã„ãªã„å ´åˆï¼‰
        const needCalculateRedSlip = (redSlipTax8Inclusive === 0 && redSlipTax8Exclusive === 0 && 
                                      redSlipTax10Inclusive === 0 && redSlipTax10Exclusive === 0) &&
                                     (redSlipCount > 0);
        
        if (needCalculateRedSlip) {
          console.log('âš ï¸ dailySalesã«èµ¤ä¼ç¥¨ã®å†…ç¨ãƒ»å¤–ç¨ãŒä¿å­˜ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€redSlipsã‹ã‚‰è¨ˆç®—ã—ã¾ã™');
          try {
            const redSlipsSnapshot = await window.getDocs(window.getStoreCollection('redSlips'));
            redSlipsSnapshot.forEach(doc => {
              const data = doc.data();
              if (!data.businessDate || data.businessDate !== dateStr || !data.items) return;
              
              data.items.forEach(item => {
                const taxType = item.taxType || 'inclusive';
                const taxAmount = getTaxAmount(item, item.quantity || 1);
                
                if ((item.taxRate || 10) === 8) {
                  if (taxType === 'exclusive') {
                    redSlipTax8Exclusive += taxAmount;
                  } else {
                    redSlipTax8Inclusive += taxAmount;
                  }
                } else {
                  if (taxType === 'exclusive') {
                    redSlipTax10Exclusive += taxAmount;
                  } else {
                    redSlipTax10Inclusive += taxAmount;
                  }
                }
              });
            });
            console.log('âœ… redSlipsã‹ã‚‰è¨ˆç®—å®Œäº†:', {
              redSlipTax8Inclusive,
              redSlipTax8Exclusive,
              redSlipTax10Inclusive,
              redSlipTax10Exclusive
            });
          } catch (e) {
            console.error('redSlipså–å¾—ã‚¨ãƒ©ãƒ¼:', e);
          }
        }
        
        // ç¨é‡‘è¨ˆç®—
        const tax8Excluded = Math.floor(tax8Total / 1.08);
        const tax10Excluded = Math.floor(tax10Total / 1.10);
        const tax8Amount = tax8Total - tax8Excluded;
        const tax10Amount = tax10Total - tax10Excluded;
        const totalTax = tax8Amount + tax10Amount;
        const taxExcludedTotal = tax8Excluded + tax10Excluded;
        const taxIncludedTotal = tax8Total + tax10Total;
        
        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«HTMLç”Ÿæˆ
        const journalHtml = `
          <div style="font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.6; padding: 30px; background: white; width: 600px;">
            <div style="text-align: center; font-size: 20px; font-weight: bold; margin-bottom: 20px;">
              ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«
            </div>
            <div style="text-align: center; margin-bottom: 30px; color: #666;">
              å‡ºåŠ›æ—¥æ™‚: ${outputTime}
            </div>
            
            <div style="border-top: 2px solid #333; border-bottom: 2px solid #333; padding: 15px 0; margin: 20px 0;">
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>å–¶æ¥­æ—¥:</span>
                <strong>${dateStr}</strong>
              </div>
            </div>
            
            <div style="margin: 20px 0;">
              <div style="font-weight: bold; margin-bottom: 10px;">åŸºæœ¬æƒ…å ±</div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>å®¢æ•°:</span>
                <span>${customerCount}äºº</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>å•†å“æ•°:</span>
                <span>${totalItems}å€‹</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>å®¢å˜ä¾¡:</span>
                <span>Â¥${averageSpend.toLocaleString()}</span>
              </div>
            </div>
            
            <div style="margin: 20px 0; border-top: 1px dashed #999; padding-top: 15px;">
              <div style="font-weight: bold; margin-bottom: 10px;">å£²ä¸Šå†…è¨³</div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>ç¾é‡‘:</span>
                <span>Â¥${cashSales.toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>é›»å­ãƒãƒãƒ¼:</span>
                <span>Â¥${emoneSales.toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰:</span>
                <span>Â¥${creditSales.toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>å€¤å¼•:</span>
                <span>-Â¥${discountTotal.toLocaleString()}</span>
              </div>
            </div>
            
            <div style="margin: 20px 0; border-top: 1px dashed #999; padding-top: 15px;">
              <div style="font-weight: bold; margin-bottom: 10px;">ç¨é‡‘å†…è¨³</div>
              <div style="margin-left: 10px;">
                <div style="font-weight: bold; margin: 10px 0;">8%ã®å•†å“</div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>ã€€ç¨æŠœ:</span>
                  <span>Â¥${tax8Excluded.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>ã€€ç¨è¾¼:</span>
                  <span>Â¥${tax8Total.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>ã€€æ¶ˆè²»ç¨:</span>
                  <span>Â¥${tax8Amount.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0; margin-left: 15px;">
                  <span>å†…ç¨:</span>
                  <span>Â¥${tax8InclusiveTotal.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0; margin-left: 15px;">
                  <span>å¤–ç¨:</span>
                  <span>Â¥${tax8ExclusiveTotal.toLocaleString()}</span>
                </div>
                
                <div style="font-weight: bold; margin: 10px 0;">10%ã®å•†å“</div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>ã€€ç¨æŠœ:</span>
                  <span>Â¥${tax10Excluded.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>ã€€ç¨è¾¼:</span>
                  <span>Â¥${tax10Total.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>ã€€æ¶ˆè²»ç¨:</span>
                  <span>Â¥${tax10Amount.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0; margin-left: 15px;">
                  <span>å†…ç¨:</span>
                  <span>Â¥${tax10InclusiveTotal.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0; margin-left: 15px;">
                  <span>å¤–ç¨:</span>
                  <span>Â¥${tax10ExclusiveTotal.toLocaleString()}</span>
                </div>
              </div>
            </div>
            
            <div style="margin: 20px 0; border-top: 2px solid #333; padding-top: 15px;">
              <div style="display: flex; justify-content: space-between; margin: 8px 0; font-size: 16px;">
                <span>æ¶ˆè²»ç¨ã®åˆè¨ˆ:</span>
                <strong>Â¥${totalTax.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 8px 0; font-size: 16px;">
                <span>ç¨æŠœåˆè¨ˆ:</span>
                <strong>Â¥${taxExcludedTotal.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 8px 0; font-size: 18px; font-weight: bold;">
                <span>ç¨è¾¼åˆè¨ˆ:</span>
                <strong style="font-size: 24px;">Â¥${taxIncludedTotal.toLocaleString()}</strong>
              </div>
            </div>
            
            ${redSlipCount > 0 ? `
            <div style="margin: 20px 0; border-top: 1px dashed #999; padding-top: 15px;">
              <div style="font-weight: bold; margin-bottom: 10px; color: #d32f2f;">ğŸ”´ èµ¤ä¼ç¥¨ã®ç¨é‡‘å†…è¨³</div>
              <div style="margin-left: 10px;">
                <div style="font-weight: bold; margin: 10px 0;">8%ã®èµ¤ä¼ç¥¨</div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>ã€€ç¨æŠœ:</span>
                  <span>-Â¥${Math.floor(redSlipTax8Total / 1.08).toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>ã€€ç¨è¾¼:</span>
                  <span>-Â¥${redSlipTax8Total.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>ã€€æ¶ˆè²»ç¨:</span>
                  <span>-Â¥${(redSlipTax8Total - Math.floor(redSlipTax8Total / 1.08)).toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0; margin-left: 15px;">
                  <span>å†…ç¨:</span>
                  <span>-Â¥${redSlipTax8Inclusive.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0; margin-left: 15px;">
                  <span>å¤–ç¨:</span>
                  <span>-Â¥${redSlipTax8Exclusive.toLocaleString()}</span>
                </div>
                
                <div style="font-weight: bold; margin: 10px 0;">10%ã®èµ¤ä¼ç¥¨</div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>ã€€ç¨æŠœ:</span>
                  <span>-Â¥${Math.floor(redSlipTax10Total / 1.10).toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>ã€€ç¨è¾¼:</span>
                  <span>-Â¥${redSlipTax10Total.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0;">
                  <span>ã€€æ¶ˆè²»ç¨:</span>
                  <span>-Â¥${(redSlipTax10Total - Math.floor(redSlipTax10Total / 1.10)).toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0; margin-left: 15px;">
                  <span>å†…ç¨:</span>
                  <span>-Â¥${redSlipTax10Inclusive.toLocaleString()}</span>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 3px 0; margin-left: 15px;">
                  <span>å¤–ç¨:</span>
                  <span>-Â¥${redSlipTax10Exclusive.toLocaleString()}</span>
                </div>
              </div>
              
              <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd;">
                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                  <span>èµ¤ä¼ç¥¨æ¶ˆè²»ç¨ã®åˆè¨ˆ:</span>
                  <strong>-Â¥${((redSlipTax8Total - Math.floor(redSlipTax8Total / 1.08)) + (redSlipTax10Total - Math.floor(redSlipTax10Total / 1.10))).toLocaleString()}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                  <span>èµ¤ä¼ç¥¨ç¨æŠœåˆè¨ˆ:</span>
                  <strong>-Â¥${(Math.floor(redSlipTax8Total / 1.08) + Math.floor(redSlipTax10Total / 1.10)).toLocaleString()}</strong>
                </div>
                <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                  <span>èµ¤ä¼ç¥¨ç¨è¾¼åˆè¨ˆ:</span>
                  <strong>-Â¥${(redSlipTax8Total + redSlipTax10Total).toLocaleString()}</strong>
                </div>
              </div>
            </div>
            ` : ''}
            
            <div style="margin: 20px 0; border-top: 1px dashed #999; padding-top: 15px;">
              <div style="font-weight: bold; margin-bottom: 10px;">ãã®ä»–</div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>èµ¤ä¼ç¥¨ä»¶æ•°:</span>
                <span>${redSlipCount}ä»¶</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin: 5px 0;">
                <span>èµ¤ä¼ç¥¨é‡‘é¡:</span>
                <span>Â¥${redSlipAmount.toLocaleString()}</span>
              </div>
            </div>
          </div>
        `;
        
        // HTML2Canvasã§ç”»åƒåŒ–
        const journalDiv = document.createElement('div');
        journalDiv.innerHTML = journalHtml;
        journalDiv.style.position = 'absolute';
        journalDiv.style.left = '-9999px';
        document.body.appendChild(journalDiv);
        
        const canvas = await html2canvas(journalDiv, {
          backgroundColor: '#ffffff',
          scale: 2
        });
        
        document.body.removeChild(journalDiv);
        
        const link = document.createElement('a');
        link.download = `ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«_${dateStr}.png`;
        link.href = canvas.toDataURL();
        link.click();
        
        await showCustomAlert({
          title: 'å®Œäº†',
          message: 'ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ',
          type: 'success'
        });
    }
    
    // ğŸ†• æ—¥è¨ˆè¡¨å‡ºåŠ›

    
    // ğŸ†• å°åˆ·ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡ã™ã‚‹å…±é€šé–¢æ•°
    async function sendPrintRequest(builder, onSuccess, onError) {
      try {
        const request = builder.toString();
        
        if (PRINTER_CONNECTION_TYPE === 'ethernet' || PRINTER_CONNECTION_TYPE === 'wifi') {
          // HTTPSç’°å¢ƒã§ã¯Wi-Fi/LANå°åˆ·ã§ããªã„ã“ã¨ã‚’é€šçŸ¥
          if (window.location.protocol === 'https:') {
            throw new Error('HTTPSç’°å¢ƒã§ã¯Wi-Fi/LANå°åˆ·ã¯åˆ¶é™ã•ã‚Œã¾ã™ã€‚HTTPã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‹ã€Bluetoothãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
          }
          
          // Wi-Fi/LANå°åˆ·
          const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
          const trader = new StarWebPrintTrader({url: url});
          
          trader.onReceive = onSuccess;
          trader.onError = onError;
          
          await trader.sendMessage(request);
        } else if (PRINTER_CONNECTION_TYPE === 'bluetooth' && BLUETOOTH_CHARACTERISTIC) {
          // Bluetoothå°åˆ·
          const encoder = new TextEncoder();
          const data = encoder.encode(request);
          await BLUETOOTH_CHARACTERISTIC.writeValue(data);
          if (onSuccess) onSuccess({ status: 'success' });
        } else {
          throw new Error('ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }
      } catch (error) {
        console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', error);
        if (onError) onError({ status: error.message });
      }
    }
    
    // ========== ğŸ–¨ ãƒ—ãƒªãƒ³ã‚¿è¨­å®šæ©Ÿèƒ½ ==========
    
    // ãƒ—ãƒªãƒ³ã‚¿è¨­å®šã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let PRINTER_IP = localStorage.getItem('printerIP') || '192.168.1.100';
    let PRINTER_CONNECTION_TYPE = localStorage.getItem('printerConnectionType') || 'ethernet';
    let BLUETOOTH_DEVICE = null;
    let BLUETOOTH_CHARACTERISTIC = null;
    
    window.selectConnectionType = function(type) {
      PRINTER_CONNECTION_TYPE = type;
      
      const ethernetBtn = document.getElementById('connectionTypeEthernet');
      const bluetoothBtn = document.getElementById('connectionTypeBluetooth');
      const usbBtn = document.getElementById('connectionTypeUsb');
      const proxyBtn = document.getElementById('connectionTypeProxy');
      const ethernetSettings = document.getElementById('ethernetSettings');
      const bluetoothSettings = document.getElementById('bluetoothSettings');
      const usbSettings = document.getElementById('usbSettings');
      const proxySettings = document.getElementById('proxySettings');
      
      // ã™ã¹ã¦ã®ãƒœã‚¿ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
      [ethernetBtn, bluetoothBtn, usbBtn, proxyBtn].forEach(btn => {
        if (btn) {
          btn.style.background = 'white';
          btn.style.color = '#666';
          btn.style.borderColor = '#ddd';
        }
      });
      
      // ã™ã¹ã¦ã®è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
      if (ethernetSettings) ethernetSettings.style.display = 'none';
      if (bluetoothSettings) bluetoothSettings.style.display = 'none';
      if (usbSettings) usbSettings.style.display = 'none';
      if (proxySettings) proxySettings.style.display = 'none';
      
      if (type === 'ethernet') {
        if (ethernetBtn) {
          ethernetBtn.style.background = '#667eea';
          ethernetBtn.style.color = 'white';
          ethernetBtn.style.borderColor = '#667eea';
        }
        if (ethernetSettings) ethernetSettings.style.display = 'block';
      } else if (type === 'bluetooth') {
        if (bluetoothBtn) {
          bluetoothBtn.style.background = '#667eea';
          bluetoothBtn.style.color = 'white';
          bluetoothBtn.style.borderColor = '#667eea';
        }
        if (bluetoothSettings) bluetoothSettings.style.display = 'block';
      } else if (type === 'usb') {
        if (usbBtn) {
          usbBtn.style.background = '#667eea';
          usbBtn.style.color = 'white';
          usbBtn.style.borderColor = '#667eea';
        }
        if (usbSettings) usbSettings.style.display = 'block';
      } else if (type === 'proxy') {
        if (proxyBtn) {
          proxyBtn.style.background = '#667eea';
          proxyBtn.style.color = 'white';
          proxyBtn.style.borderColor = '#667eea';
        }
        if (proxySettings) proxySettings.style.display = 'block';
      }
    };
    
    window.showBluetoothSearchGuide = function() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;';
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <div style="text-align: center; margin-bottom: 25px;">
            <div style="width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 50%; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold;">
              BT
            </div>
            <h3 style="font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #333;">Bluetoothãƒ—ãƒªãƒ³ã‚¿ã®æ¤œç´¢</h3>
          </div>
          
          <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
            <p style="font-size: 15px; color: #555; margin-bottom: 12px; line-height: 1.6;">
              ã“ã®å¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒšã‚¢è¨­å®šç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            </p>
            <p style="font-size: 14px; color: #666; line-height: 1.6;">
              <strong style="color: #333;">ç¢ºèªäº‹é …ï¼š</strong><br>
              â€¢ ãƒ—ãƒªãƒ³ã‚¿ã®é›»æºãŒå…¥ã£ã¦ã„ã‚‹<br>
              â€¢ BluetoothãŒONã«ãªã£ã¦ã„ã‚‹<br>
              â€¢ ãƒšã‚¢ãƒªãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã«ãªã£ã¦ã„ã‚‹
            </p>
          </div>
          
          <div style="display: flex; gap: 12px;">
            <button onclick="playTapSound(); this.closest('.modal-overlay').remove()" style="flex: 1; padding: 15px; font-size: 16px; font-weight: bold; border: 2px solid #ddd; background: white; color: #666; border-radius: 10px; cursor: pointer;">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button onclick="playTapSound(); this.closest('.modal-overlay').remove(); window.startBluetoothSearch();" style="flex: 1; padding: 15px; font-size: 16px; font-weight: bold; border: none; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 15px rgba(33,150,243,0.3);">
              æ¤œç´¢é–‹å§‹
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    };
    
    window.startBluetoothSearch = async function() {
      try {
        console.log('Bluetoothãƒ—ãƒªãƒ³ã‚¿ã‚’æ¤œç´¢ä¸­...');
        
        const device = await navigator.bluetooth.requestDevice({
          filters: [
            { services: ['000018f0-0000-1000-8000-00805f9b34fb'] },
          ],
          optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });
        
        console.log('ãƒ‡ãƒã‚¤ã‚¹ç™ºè¦‹:', device.name);
        
        const server = await device.gatt.connect();
        console.log('GATTæ¥ç¶šæˆåŠŸ');
        
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        console.log('ã‚µãƒ¼ãƒ“ã‚¹å–å¾—æˆåŠŸ');
        
        const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
        console.log('Characteristicå–å¾—æˆåŠŸ');
        
        BLUETOOTH_DEVICE = device;
        BLUETOOTH_CHARACTERISTIC = characteristic;
        
        document.getElementById('bluetoothDeviceInfo').style.display = 'block';
        document.getElementById('bluetoothDeviceName').textContent = device.name || 'ä¸æ˜ãªãƒ‡ãƒã‚¤ã‚¹';
        
        localStorage.setItem('bluetoothDeviceName', device.name || '');
        
        await showCustomAlert({ 
          icon: '', 
          title: 'æ¥ç¶šæˆåŠŸ', 
          message: 'Bluetoothãƒ—ãƒªãƒ³ã‚¿ã«æ¥ç¶šã—ã¾ã—ãŸ\n' + (device.name || 'ä¸æ˜ãªãƒ‡ãƒã‚¤ã‚¹'), 
          btnClass: 'modal-btn-success' 
        });
        
      } catch (error) {
        console.error('Bluetoothæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
        
        if (error.name === 'NotFoundError') {
          await showCustomAlert({ 
            icon: '', 
            title: 'ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 
            message: 'Bluetoothãƒ—ãƒªãƒ³ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\nãƒ—ãƒªãƒ³ã‚¿ã®é›»æºãŒå…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 
            btnClass: 'modal-btn-danger' 
          });
        } else if (error.name === 'SecurityError' || error.name === 'NotAllowedError') {
          console.log('æ¤œç´¢ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
        } else {
          await showCustomAlert({ 
            icon: '', 
            title: 'æ¥ç¶šã‚¨ãƒ©ãƒ¼', 
            message: 'Bluetoothãƒ—ãƒªãƒ³ã‚¿ã®æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nãƒ–ãƒ©ã‚¦ã‚¶ãŒBluetoothå¯¾å¿œã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆChromeã€Edgeæ¨å¥¨ï¼‰', 
            btnClass: 'modal-btn-danger' 
          });
        }
      }
    };
    
    window.searchBluetoothPrinter = function() {
      showBluetoothSearchGuide();
    };
    
    function createESCPOSCommand(text) {
      const encoder = new TextEncoder();
      const commands = [];
      
      commands.push(new Uint8Array([0x1B, 0x40]));
      commands.push(encoder.encode(text));
      commands.push(new Uint8Array([0x0A, 0x0A, 0x0A]));
      commands.push(new Uint8Array([0x1D, 0x56, 0x00]));
      
      const totalLength = commands.reduce((sum, cmd) => sum + cmd.length, 0);
      const result = new Uint8Array(totalLength);
      let offset = 0;
      for (const cmd of commands) {
        result.set(cmd, offset);
        offset += cmd.length;
      }
      
      return result;
    }
    
    async function printViaBluetooth(text) {
      if (!BLUETOOTH_CHARACTERISTIC) {
        throw new Error('Bluetoothãƒ—ãƒªãƒ³ã‚¿ãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      }
      
      try {
        const command = createESCPOSCommand(text);
        
        const chunkSize = 512;
        for (let i = 0; i < command.length; i += chunkSize) {
          const chunk = command.slice(i, Math.min(i + chunkSize, command.length));
          await BLUETOOTH_CHARACTERISTIC.writeValue(chunk);
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        console.log('Bluetoothå°åˆ·å®Œäº†');
      } catch (error) {
        console.error('Bluetoothå°åˆ·ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
      }
    }
    
    // ========================================
    // USBæ¥ç¶šæ©Ÿèƒ½
    // ========================================
    
    let USB_DEVICE = null;
    
    // USBæ¥ç¶šã®mCprint3ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã‚’æ¤œç´¢ã—ã¦æ¥ç¶š
    window.connectUSBPrinter = async function() {
      if (!navigator.usb) {
        await showCustomAlert({
          icon: '',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯WebUSB APIã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚\nChromeã¾ãŸã¯Edgeã‚’ã”ä½¿ç”¨ãã ã•ã„ã€‚',
          btnClass: 'modal-btn-danger'
        });
        return;
      }
      
      try {
        console.log('ğŸ” USBãƒ—ãƒªãƒ³ã‚¿ã‚’æ¤œç´¢ä¸­...');
        
        // USBãƒ‡ãƒã‚¤ã‚¹ã‚’è¦æ±‚ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ‡ãƒã‚¤ã‚¹ã‚’é¸æŠï¼‰
        const device = await navigator.usb.requestDevice({
          filters: [
            { vendorId: 0x0519 }, // Star Micronics Vendor ID
            { vendorId: 0x0519, productId: 0x0001 } // mCprint3
          ]
        });
        
        console.log('âœ… USBãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º:', device.productName);
        
        // ãƒ‡ãƒã‚¤ã‚¹ã‚’é–‹ã
        await device.open();
        console.log('ğŸ“‚ ãƒ‡ãƒã‚¤ã‚¹ã‚’ã‚ªãƒ¼ãƒ—ãƒ³ã—ã¾ã—ãŸ');
        
        // ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é¸æŠ
        if (device.configuration === null) {
          await device.selectConfiguration(1);
          console.log('âš™ï¸ ã‚³ãƒ³ãƒ•ã‚£ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é¸æŠå®Œäº†');
        }
        
        // ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’ã‚¯ãƒ¬ãƒ¼ãƒ 
        await device.claimInterface(0);
        console.log('ğŸ”— ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹æ¥ç¶šå®Œäº†');
        
        USB_DEVICE = device;
        
        // ãƒ‡ãƒã‚¤ã‚¹åã‚’è¡¨ç¤º
        document.getElementById('usbDeviceInfo').style.display = 'block';
        document.getElementById('usbDeviceName').textContent = device.productName || 'mC-Print3';
        
        // localStorageã«ä¿å­˜
        localStorage.setItem('usbDeviceName', device.productName || 'mC-Print3');
        
        await showCustomAlert({
          icon: '',
          title: 'æ¥ç¶šæˆåŠŸ',
          message: 'USBãƒ—ãƒªãƒ³ã‚¿ã«æ¥ç¶šã—ã¾ã—ãŸ\n' + (device.productName || 'mC-Print3'),
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ USBæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
        
        if (error.name === 'NotFoundError') {
          await showCustomAlert({
            icon: '',
            title: 'ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
            message: 'USBãƒ—ãƒªãƒ³ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\nç¢ºèªäº‹é …:\n1. USBã‚±ãƒ¼ãƒ–ãƒ«ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã‹\n2. ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã®é›»æºãŒå…¥ã£ã¦ã„ã‚‹ã‹',
            btnClass: 'modal-btn-danger'
          });
        } else if (error.name === 'SecurityError' || error.name === 'NotAllowedError') {
          console.log('æ¤œç´¢ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
        } else {
          await showCustomAlert({
            icon: '',
            title: 'æ¥ç¶šã‚¨ãƒ©ãƒ¼',
            message: 'USBãƒ—ãƒªãƒ³ã‚¿ã®æ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nãƒ–ãƒ©ã‚¦ã‚¶ãŒWebUSBå¯¾å¿œã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆChromeã€Edgeæ¨å¥¨ï¼‰',
            btnClass: 'modal-btn-danger'
          });
        }
      }
    };
    
    // USBçµŒç”±ã§å°åˆ·
    async function printViaUSB(text) {
      if (!USB_DEVICE) {
        throw new Error('USBãƒ—ãƒªãƒ³ã‚¿ãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      }
      
      try {
        const command = createESCPOSCommand(text);
        
        console.log('ğŸ“¤ USBå°åˆ·ãƒ‡ãƒ¼ã‚¿é€ä¿¡ä¸­... (' + command.length + ' bytes)');
        await USB_DEVICE.transferOut(1, command);
        
        console.log('âœ… USBå°åˆ·å®Œäº†');
      } catch (error) {
        console.error('âŒ USBå°åˆ·ã‚¨ãƒ©ãƒ¼:', error);
        
        // ãƒ‡ãƒã‚¤ã‚¹ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¦å†æ¥ç¶šã‚’ä¿ƒã™
        if (USB_DEVICE) {
          try {
            await USB_DEVICE.close();
          } catch (e) {
            console.error('ãƒ‡ãƒã‚¤ã‚¹ã‚¯ãƒ­ãƒ¼ã‚ºã‚¨ãƒ©ãƒ¼:', e);
          }
          USB_DEVICE = null;
        }
        
        throw error;
      }
    }
    
    window.showPrinterSettings = function() {
      // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('printerIPInput').value = PRINTER_IP;
      
      // ãƒ—ãƒ­ã‚­ã‚·URLã®å¾©å…ƒ
      const savedProxyURL = localStorage.getItem('printerProxyURL') || 'http://192.168.1.100:3000';
      const proxyInput = document.getElementById('printerProxyInput');
      if (proxyInput) {
        proxyInput.value = savedProxyURL;
      }
      
      selectConnectionType(PRINTER_CONNECTION_TYPE);
      
      // Bluetoothãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã®å¾©å…ƒ
      const savedDeviceName = localStorage.getItem('bluetoothDeviceName');
      if (savedDeviceName && PRINTER_CONNECTION_TYPE === 'bluetooth') {
        document.getElementById('bluetoothDeviceInfo').style.display = 'block';
        document.getElementById('bluetoothDeviceName').textContent = savedDeviceName + ' (å†æ¥ç¶šãŒå¿…è¦)';
      }
      
      // USBãƒ‡ãƒã‚¤ã‚¹æƒ…å ±ã®å¾©å…ƒ
      const savedUsbName = localStorage.getItem('usbDeviceName');
      if (savedUsbName && PRINTER_CONNECTION_TYPE === 'usb') {
        document.getElementById('usbDeviceInfo').style.display = 'block';
        document.getElementById('usbDeviceName').textContent = savedUsbName + ' (å†æ¥ç¶šãŒå¿…è¦)';
      }
      
      document.getElementById('printerSettingsModal').style.display = 'flex';
      document.getElementById('printerTestResult').style.display = 'none';
    };
    
    window.closePrinterSettingsModal = function() {
      document.getElementById('printerSettingsModal').style.display = 'none';
    };
    
    window.savePrinterSettings = async function() {
      if (PRINTER_CONNECTION_TYPE === 'ethernet') {
        const newIP = document.getElementById('printerIPInput').value.trim();
        
        const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
        if (!ipPattern.test(newIP)) {
          await showCustomAlert({ 
            icon: '', 
            title: 'ã‚¨ãƒ©ãƒ¼', 
            message: 'æ­£ã—ã„IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nä¾‹: 192.168.1.100', 
            btnClass: 'modal-btn-danger' 
          });
          return;
        }
        
        PRINTER_IP = newIP;
        localStorage.setItem('printerIP', newIP);
        localStorage.setItem('printerConnectionType', 'ethernet');
        
        await showCustomAlert({ 
          icon: '', 
          title: 'ä¿å­˜å®Œäº†', 
          message: 'ãƒ—ãƒªãƒ³ã‚¿è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ\næ¥ç¶šæ–¹å¼: WiFi/LAN\nIP: ' + newIP, 
          btnClass: 'modal-btn-success' 
        });
      } else if (PRINTER_CONNECTION_TYPE === 'bluetooth') {
        if (!BLUETOOTH_DEVICE) {
          await showCustomAlert({ 
            icon: '', 
            title: 'ã‚¨ãƒ©ãƒ¼', 
            message: 'Bluetoothãƒ—ãƒªãƒ³ã‚¿ã‚’æ¤œç´¢ã—ã¦æ¥ç¶šã—ã¦ãã ã•ã„', 
            btnClass: 'modal-btn-danger' 
          });
          return;
        }
        
        localStorage.setItem('printerConnectionType', 'bluetooth');
        await showCustomAlert({ 
          icon: '', 
          title: 'ä¿å­˜å®Œäº†', 
          message: 'ãƒ—ãƒªãƒ³ã‚¿è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ\næ¥ç¶šæ–¹å¼: Bluetooth\nãƒ‡ãƒã‚¤ã‚¹: ' + (BLUETOOTH_DEVICE.name || 'ä¸æ˜'), 
          btnClass: 'modal-btn-success' 
        });
      } else if (PRINTER_CONNECTION_TYPE === 'usb') {
        if (!USB_DEVICE) {
          await showCustomAlert({ 
            icon: '', 
            title: 'ã‚¨ãƒ©ãƒ¼', 
            message: 'USBãƒ—ãƒªãƒ³ã‚¿ã‚’æ¥ç¶šã—ã¦ãã ã•ã„', 
            btnClass: 'modal-btn-danger' 
          });
          return;
        }
        
        localStorage.setItem('printerConnectionType', 'usb');
        await showCustomAlert({ 
          icon: '', 
          title: 'ä¿å­˜å®Œäº†', 
          message: 'ãƒ—ãƒªãƒ³ã‚¿è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ\næ¥ç¶šæ–¹å¼: USB\nãƒ‡ãƒã‚¤ã‚¹: ' + (USB_DEVICE.productName || 'mC-Print3'), 
          btnClass: 'modal-btn-success' 
        });
      } else if (PRINTER_CONNECTION_TYPE === 'proxy') {
        const proxyURL = document.getElementById('printerProxyInput').value.trim();
        
        if (!proxyURL.startsWith('http://') && !proxyURL.startsWith('https://')) {
          await showCustomAlert({ 
            icon: '', 
            title: 'ã‚¨ãƒ©ãƒ¼', 
            message: 'æ­£ã—ã„URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nä¾‹: http://192.168.1.100:3000', 
            btnClass: 'modal-btn-danger' 
          });
          return;
        }
        
        localStorage.setItem('printerProxyURL', proxyURL);
        localStorage.setItem('printerConnectionType', 'proxy');
        
        await showCustomAlert({ 
          icon: '', 
          title: 'ä¿å­˜å®Œäº†', 
          message: 'ãƒ—ãƒªãƒ³ã‚¿è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ\næ¥ç¶šæ–¹å¼: ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼\nURL: ' + proxyURL, 
          btnClass: 'modal-btn-success' 
        });
      }
      
      closePrinterSettingsModal();
    };
    
    window.testPrinterConnection = async function() {
      const resultDiv = document.getElementById('printerTestResult');
      
      resultDiv.style.display = 'block';
      resultDiv.style.background = '#FFF9C4';
      resultDiv.style.color = '#F57F17';
      resultDiv.textContent = 'æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...';
      
      try {
        if (PRINTER_CONNECTION_TYPE === 'bluetooth') {
          if (!BLUETOOTH_CHARACTERISTIC) {
            resultDiv.style.background = '#FFCDD2';
            resultDiv.style.color = '#C62828';
            resultDiv.innerHTML = 'Bluetoothãƒ—ãƒªãƒ³ã‚¿ãŒæœªæ¥ç¶š<br>å…ˆã«ãƒ—ãƒªãƒ³ã‚¿ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„';
            return;
          }
          
          await printViaBluetooth('=== æ¥ç¶šãƒ†ã‚¹ãƒˆ ===\nå°åˆ·æˆåŠŸï¼\n\n');
          
          resultDiv.style.background = '#C8E6C9';
          resultDiv.style.color = '#2E7D32';
          resultDiv.innerHTML = 'æ¥ç¶šæˆåŠŸï¼<br>Bluetoothãƒ—ãƒªãƒ³ã‚¿ã¨é€šä¿¡ã§ãã¾ã—ãŸ';
          
        } else if (PRINTER_CONNECTION_TYPE === 'usb') {
          if (!USB_DEVICE) {
            resultDiv.style.background = '#FFCDD2';
            resultDiv.style.color = '#C62828';
            resultDiv.innerHTML = 'USBãƒ—ãƒªãƒ³ã‚¿ãŒæœªæ¥ç¶š<br>å…ˆã«ãƒ—ãƒªãƒ³ã‚¿ã‚’æ¥ç¶šã—ã¦ãã ã•ã„';
            return;
          }
          
          await printViaUSB('=== æ¥ç¶šãƒ†ã‚¹ãƒˆ ===\nå°åˆ·æˆåŠŸï¼\n\n');
          
          resultDiv.style.background = '#C8E6C9';
          resultDiv.style.color = '#2E7D32';
          resultDiv.innerHTML = 'âœ… æ¥ç¶šæˆåŠŸï¼<br>USBãƒ—ãƒªãƒ³ã‚¿ã¨é€šä¿¡ã§ãã¾ã—ãŸ';
          
        } else if (PRINTER_CONNECTION_TYPE === 'proxy') {
          // ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼æ¥ç¶šãƒ†ã‚¹ãƒˆ
          const proxyURL = document.getElementById('printerProxyInput').value.trim();
          
          const response = await fetch(`${proxyURL}/health`, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json'
            }
          });
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }
          
          const data = await response.json();
          
          resultDiv.style.background = '#C8E6C9';
          resultDiv.style.color = '#2E7D32';
          resultDiv.innerHTML = `âœ… æ¥ç¶šæˆåŠŸï¼<br>ã‚µãƒ¼ãƒãƒ¼: ${data.serverIP}:${data.serverPort}<br>ãƒ—ãƒªãƒ³ã‚¿ãƒ¼æ•°: ${data.printers}`;
          
        } else {
          // Ethernetæ¥ç¶šãƒ†ã‚¹ãƒˆ
          const testIP = document.getElementById('printerIPInput').value.trim();
          
          // IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
          const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
          if (!ipPattern.test(testIP)) {
            resultDiv.style.background = '#FFCDD2';
            resultDiv.style.color = '#C62828';
            resultDiv.innerHTML = 'âŒ ã‚¨ãƒ©ãƒ¼<br>æ­£ã—ã„IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
            return;
          }
          
          // HTTPSã‹ã‚‰HTTPã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒã‚§ãƒƒã‚¯
          if (window.location.protocol === 'https:') {
            resultDiv.style.background = '#FFF9C4';
            resultDiv.style.color = '#F57F17';
            resultDiv.innerHTML = 'âš ï¸ HTTPSç’°å¢ƒã§ã¯Wi-Fi/LANå°åˆ·ã¯åˆ¶é™ã•ã‚Œã¾ã™<br><small>HTTPã‚µã‚¤ãƒˆã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã‹ã€Bluetoothãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚</small>';
            return;
          }
          
          // StarWebPrintBuilderãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
          if (typeof StarWebPrintBuilder === 'undefined' || typeof StarWebPrintTrader === 'undefined') {
            resultDiv.style.background = '#FFF9C4';
            resultDiv.style.color = '#F57F17';
            resultDiv.innerHTML = 'âš ï¸ WiFi/LANæ¥ç¶šãƒ†ã‚¹ãƒˆã¯ç¾åœ¨åˆ©ç”¨ã§ãã¾ã›ã‚“<br><small>StarWebPrintãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚<br>ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã¾ãŸã¯Bluetoothã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚</small>';
            console.error('StarWebPrintæœªå®šç¾©:', {
              Builder: typeof StarWebPrintBuilder,
              Trader: typeof StarWebPrintTrader
            });
            return;
          }
          
          const builder = new StarWebPrintBuilder();
          builder.createInitializationElement();
          builder.createTextElement({data: '=== æ¥ç¶šãƒ†ã‚¹ãƒˆ ===\n'});
          builder.createTextElement({data: 'å°åˆ·æˆåŠŸï¼\n\n'});
          builder.createCutPaperElement({feed: true});
          
          const url = `http://${testIP}/StarWebPRNT/SendMessage`;
          const request = builder.toString();
          
          const trader = new StarWebPrintTrader({url: url});
          
          trader.onReceive = function(response) {
            console.log('âœ… æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ:', response);
            resultDiv.style.background = '#C8E6C9';
            resultDiv.style.color = '#2E7D32';
            resultDiv.innerHTML = 'âœ… æ¥ç¶šæˆåŠŸï¼<br>ãƒ—ãƒªãƒ³ã‚¿ã¨é€šä¿¡ã§ãã¾ã—ãŸ';
          };
          
          trader.onError = function(response) {
            console.error('âŒ æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—:', response);
            resultDiv.style.background = '#FFCDD2';
            resultDiv.style.color = '#C62828';
            resultDiv.innerHTML = `âŒ æ¥ç¶šå¤±æ•—<br>${response.status || 'ãƒ—ãƒªãƒ³ã‚¿ã«æ¥ç¶šã§ãã¾ã›ã‚“'}<br><small>IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„</small>`;
          };
          
          await trader.sendMessage(request);
        }
        
      } catch (error) {
        console.error('æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        resultDiv.style.background = '#FFCDD2';
        resultDiv.style.color = '#C62828';
        resultDiv.innerHTML = 'ã‚¨ãƒ©ãƒ¼<br>' + error.message;
      }
    };
    
    // ========================================
    // ğŸ—„ï¸ ãƒ‰ãƒ­ã‚¢è¨­å®šæ©Ÿèƒ½
    // ========================================
    
    window.showDrawerSettings = function() {
      playTapSound();
      const menu = document.getElementById('functionsSubMenu');
      if (menu) menu.style.display = 'none';
      
      const savedIp = localStorage.getItem('drawerIp') || '192.168.1.100';
      const savedDuration = localStorage.getItem('drawerDuration') || '500';
      
      document.getElementById('drawerIpInput').value = savedIp;
      document.getElementById('drawerDurationInput').value = savedDuration;
      document.getElementById('drawerSettingsModal').style.display = 'flex';
      document.getElementById('drawerTestResult').style.display = 'none';
    };
    
    window.closeDrawerSettingsModal = function() {
      document.getElementById('drawerSettingsModal').style.display = 'none';
    };
    
    window.saveDrawerSettings = async function() {
      const ip = document.getElementById('drawerIpInput').value.trim();
      const duration = document.getElementById('drawerDurationInput').value.trim();
      
      if (!ip) {
        await showCustomAlert({ icon: 'âš ï¸', title: 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼', message: 'IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', btnClass: 'modal-btn-danger' });
        return;
      }
      
      localStorage.setItem('drawerIp', ip);
      localStorage.setItem('drawerDuration', duration);
      
      await showCustomAlert({ icon: 'âœ…', title: 'ä¿å­˜å®Œäº†', message: 'ãƒ‰ãƒ­ã‚¢è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ', btnClass: 'modal-btn-success' });
      closeDrawerSettingsModal();
    };
    
    window.testDrawerConnection = async function() {
      const ip = document.getElementById('drawerIpInput').value.trim();
      const duration = document.getElementById('drawerDurationInput').value.trim();
      
      if (!ip) {
        await showCustomAlert({ icon: 'âš ï¸', title: 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼', message: 'IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', btnClass: 'modal-btn-danger' });
        return;
      }
      
      const resultDiv = document.getElementById('drawerTestResult');
      resultDiv.style.display = 'block';
      resultDiv.style.background = '#fff3cd';
      resultDiv.style.color = '#856404';
      resultDiv.innerHTML = 'æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...';
      
      try {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(`http://${ip}/open`, {
          method: 'POST',
          signal: controller.signal,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ duration: parseInt(duration) || 500 })
        });
        
        clearTimeout(timeoutId);
        
        if (response.ok) {
          resultDiv.style.background = '#d4edda';
          resultDiv.style.color = '#155724';
          resultDiv.innerHTML = 'âœ… æ¥ç¶šæˆåŠŸï¼ãƒ‰ãƒ­ã‚¢ãŒé–‹ãã¾ã™';
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (error) {
        resultDiv.style.background = '#f8d7da';
        resultDiv.style.color = '#721c24';
        
        if (error.name === 'AbortError') {
          resultDiv.innerHTML = 'âŒ ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ãƒ‰ãƒ­ã‚¢ã«æ¥ç¶šã§ãã¾ã›ã‚“ã§ã—ãŸ';
        } else {
          resultDiv.innerHTML = 'âŒ æ¥ç¶šå¤±æ•—: ' + error.message;
        }
      }
    };
    
    // ========================================
    // ğŸ“¦ åœ¨åº«ä¸€æ‹¬è¨­å®šæ©Ÿèƒ½
    // ========================================
    
    // åœ¨åº«ä¸€æ‹¬è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.showBulkInventoryModal = function() {
      playTapSound();
      
      // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const functionsMenu = document.getElementById('functionsSubMenu');
      if (functionsMenu) {
        functionsMenu.style.display = 'none';
      }
      
      document.getElementById('bulkInventoryModal').style.display = 'flex';
    };
    
    // åœ¨åº«ä¸€æ‹¬è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeBulkInventoryModal = function() {
      document.getElementById('bulkInventoryModal').style.display = 'none';
    };
    
    // å…¨å•†å“ã‚’ä¸€æ‹¬ã§å“åˆ‡ã‚Œã«ã™ã‚‹
    window.bulkSetInventoryToZero = async function() {
      const confirmed = await showCustomConfirm(
        'å…¨å•†å“ã‚’å“åˆ‡ã‚Œï¼ˆåœ¨åº«0ï¼‰ã«è¨­å®šã—ã¾ã™ã‹ï¼Ÿ\n\nä¼‘æ¥­æ—¥ãªã©ã«ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚',
        'å…¨å•†å“å“åˆ‡'
      );
      if (!confirmed) return;
      
      try {
        // å…¨å•†å“ã‚’å–å¾—
        const menusRef = getStoreCollection('menus');
        const menusSnapshot = await getDocs(menusRef);
        
        // åœ¨åº«è¨­å®šã‚’èª­ã¿è¾¼ã¿
        const inventoryRef = getStoreDoc('inventory_settings', 'default');
        const inventorySnap = await getDoc(inventoryRef);
        const inventorySettings = inventorySnap.exists() ? inventorySnap.data().items || {} : {};
        
        // å…¨å•†å“ã‚’åœ¨åº«0ã«è¨­å®š
        const newSettings = { ...inventorySettings };
        let count = 0;
        
        menusSnapshot.forEach(doc => {
          const data = doc.data();
          const itemId = data.id || doc.id;
          
          newSettings[itemId] = {
            ...newSettings[itemId],
            stock: 0
          };
          count++;
        });
        
        // ä¿å­˜
        await setDoc(inventoryRef, {
          items: newSettings,
          updatedAt: new Date().toISOString()
        });
        
        showCustomAlert(`${count}ä»¶ã®å•†å“ã‚’å“åˆ‡ã‚Œã«è¨­å®šã—ã¾ã—ãŸ`, 'å®Œäº†');
        console.log('âœ… å…¨å•†å“å“åˆ‡ã‚Œè¨­å®šå®Œäº†:', count, 'ä»¶');
        
        closeBulkInventoryModal();
      } catch (error) {
        console.error('âŒ å…¨å•†å“å“åˆ‡ã‚Œè¨­å®šã‚¨ãƒ©ãƒ¼:', error);
        showCustomAlert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'ã‚¨ãƒ©ãƒ¼');
      }
    };
    
    // å…¨å•†å“ã‚’ä¸€æ‹¬ã§å¾©æ´»ã•ã›ã‚‹ï¼ˆåœ¨åº«0ã‚’è§£é™¤ï¼‰
    window.bulkClearInventoryZero = async function() {
      const confirmed = await showCustomConfirm(
        'å…¨å•†å“ã®å“åˆ‡ã‚Œã‚’è§£é™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nå…¨ã¦ã®å•†å“ãŒç„¡é™åœ¨åº«ï¼ˆæœªè¨­å®šï¼‰ã«æˆ»ã‚Šã¾ã™ã€‚\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚',
        'å…¨å•†å“å¾©æ´»'
      );
      if (!confirmed) return;
      
      try {
        // å…¨å•†å“ã‚’å–å¾—
        const menusRef = getStoreCollection('menus');
        const menusSnapshot = await getDocs(menusRef);
        
        // åœ¨åº«è¨­å®šã‚’èª­ã¿è¾¼ã¿
        const inventoryRef = getStoreDoc('inventory_settings', 'default');
        const inventorySnap = await getDoc(inventoryRef);
        const inventorySettings = inventorySnap.exists() ? inventorySnap.data().items || {} : {};
        
        // åœ¨åº«0ã®å•†å“ã‚’ç„¡é™åœ¨åº«ã«æˆ»ã™
        const newSettings = { ...inventorySettings };
        let count = 0;
        
        menusSnapshot.forEach(doc => {
          const data = doc.data();
          const itemId = data.id || doc.id;
          
          // åœ¨åº«ãŒ0ã®å•†å“ã®ã¿å¯¾è±¡
          if (newSettings[itemId]?.stock === 0) {
            newSettings[itemId] = {
              ...newSettings[itemId],
              stock: null,
              alertThreshold: null
            };
            count++;
          }
        });
        
        // ä¿å­˜
        await setDoc(inventoryRef, {
          items: newSettings,
          updatedAt: new Date().toISOString()
        });
        
        showCustomAlert(`${count}ä»¶ã®å•†å“ã‚’å¾©æ´»ã•ã›ã¾ã—ãŸ`, 'å®Œäº†');
        console.log('âœ… å…¨å•†å“å¾©æ´»å®Œäº†:', count, 'ä»¶');
        
        closeBulkInventoryModal();
      } catch (error) {
        console.error('âŒ å…¨å•†å“å¾©æ´»ã‚¨ãƒ©ãƒ¼:', error);
        showCustomAlert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message, 'ã‚¨ãƒ©ãƒ¼');
      }
    };
    
    // ========================================
    // ğŸ’³ å³ä¼šè¨ˆæ©Ÿèƒ½
    // ========================================
    
    // å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openInstantCheckout = async function() {
      console.log('ğŸ’³ å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ã‚’é–‹å§‹');
      playTapSound();
      
      // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const functionsMenu = document.getElementById('functionsSubMenu');
      if (functionsMenu) {
        functionsMenu.style.display = 'none';
      }
      
      try {
        // å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
        isInstantCheckoutMode = true;
        
        // POSãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã„ã¦menu.htmlã‚’è¡¨ç¤ºï¼ˆå³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ï¼‰
        const modal = document.getElementById('posIframeModal');
        const iframe = document.getElementById('posIframe');
        const modalTitle = document.getElementById('posModalTitle');
        
        if (modal && iframe && modalTitle) {
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
          modalTitle.textContent = 'ğŸ’³ å³ä¼šè¨ˆ';
          
          // menu.htmlã‚’å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ã§é–‹ã
          const menuUrl = `menu.html?table=å³ä¼šè¨ˆ&store=${currentStoreId}&mode=handy&instant=true`;
          console.log('ğŸ“± menu.htmlã‚’é–‹ã:', menuUrl);
          iframe.src = menuUrl;
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          modal.classList.add('active');
        }
        
      } catch (error) {
        console.error('âŒ å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰èµ·å‹•ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert({
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message,
          type: 'error'
        });
      }
    };
    
    // å³ä¼šè¨ˆå‡¦ç†(POSã‹ã‚‰ç§»æ¤)- iframeå†…ã‹ã‚‰ã®æ³¨æ–‡å®Œäº†æ™‚ã«å‘¼ã°ã‚Œã‚‹
    window.processInstantCheckout = async function(orderData) {
      console.log('ğŸ’³ğŸ’³ğŸ’³ å³ä¼šè¨ˆå‡¦ç†é–‹å§‹ ğŸ’³ğŸ’³ğŸ’³');
      console.log('å—ä¿¡ã—ãŸç”Ÿãƒ‡ãƒ¼ã‚¿:', orderData);
      console.log('ğŸ› å—ä¿¡ã—ãŸãƒ¬ã‚¸è¢‹æƒ…å ±ï¼ˆç”Ÿãƒ‡ãƒ¼ã‚¿ï¼‰:', {
        bagNeeded: orderData.bagNeeded,
        bagQuantity: orderData.bagQuantity,
        bagPrice: orderData.bagPrice
      });
      
      try {
        // ãƒ¬ã‚¸è¢‹æƒ…å ±ã‚’ç¢ºå®Ÿã«orderDataã«å«ã‚ã‚‹
        const processedOrderData = {
          ...orderData,
          bagNeeded: orderData.bagNeeded || false,
          bagQuantity: orderData.bagQuantity || 0,
          bagPrice: orderData.bagPrice || 0
        };
        
        console.log('âœ… å‡¦ç†å¾Œã®ãƒ¬ã‚¸è¢‹æƒ…å ±:', {
          bagNeeded: processedOrderData.bagNeeded,
          bagQuantity: processedOrderData.bagQuantity,
          bagPrice: processedOrderData.bagPrice
        });
        
        console.log('ğŸ“¦ å®Œå…¨ãªprocessedOrderData:', processedOrderData);
        
        // currentOrdersã«è¨­å®š
        currentOrders = [processedOrderData];
        console.log('ğŸ“‹ currentOrdersã«è¨­å®šå®Œäº†:', currentOrders);
        
        // POSãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        const modal = document.getElementById('posIframeModal');
        if (modal) {
          modal.classList.remove('active');
        }
        
        // å³ä¼šè¨ˆãƒ•ãƒ©ã‚°ã‚’è¨­å®šï¼ˆãƒ¬ã‚¸è¢‹æƒ…å ±ã‚‚ä¿å­˜ï¼‰
        const orderRef = doc(db, 'stores', currentStoreId, 'orders', orderData.id);
        await updateDoc(orderRef, {
          directPayment: true,
          handyOrder: true,
          bagNeeded: processedOrderData.bagNeeded,
          bagQuantity: processedOrderData.bagQuantity,
          bagPrice: processedOrderData.bagPrice
        });
        
        console.log('ğŸ’¾ Firestoreã«ä¿å­˜ã—ãŸãƒ¬ã‚¸è¢‹æƒ…å ±:', {
          bagNeeded: processedOrderData.bagNeeded,
          bagQuantity: processedOrderData.bagQuantity,
          bagPrice: processedOrderData.bagPrice
        });
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’å–å¾—
        currentTableSettings = await getTableSettings('å³ä¼šè¨ˆ');
        console.log('ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š(å³ä¼šè¨ˆ):', currentTableSettings);
        
        // ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        setTimeout(() => {
          // æ³¨æ–‡ç•ªå·ã‚’è¡¨ç¤º
          document.getElementById('selectedTableLabel2').textContent = `å³ä¼šè¨ˆ - æ³¨æ–‡ #${orderData.orderNumber || '1'}`;
          
          // ç¨ç‡ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç”Ÿæˆï¼ˆãƒ¬ã‚¸è¢‹æƒ…å ±ã‚’å«ã‚€ï¼‰
          console.log('ğŸ“ğŸ“ğŸ“ generateTaxRateItemsã‚’å‘¼ã³å‡ºã—ã¾ã™ ğŸ“ğŸ“ğŸ“');
          console.log('æ¸¡ã™ãƒ‡ãƒ¼ã‚¿:', processedOrderData);
          console.log('æ¸¡ã™ãƒ¬ã‚¸è¢‹æƒ…å ±:', {
            bagNeeded: processedOrderData.bagNeeded,
            bagQuantity: processedOrderData.bagQuantity,
            bagPrice: processedOrderData.bagPrice
          });
          generateTaxRateItems([processedOrderData], 'å³ä¼šè¨ˆ');
          
          document.getElementById('discountAmount').value = '0';
          updatePaymentTotal();
          document.getElementById('paymentModal').classList.remove('hidden');
          selectedPaymentMethod = null;
          document.querySelectorAll('.payment-method-btn').forEach(btn => {
            btn.classList.remove('selected');
          });
          document.getElementById('cashInputSection').classList.add('hidden');
          document.getElementById('completePaymentBtn').disabled = true;
        }, 500);
        
        // å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
        isInstantCheckoutMode = false;
        
      } catch (error) {
        console.error('âŒ å³ä¼šè¨ˆå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert({
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'å³ä¼šè¨ˆã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message,
          type: 'error'
        });
      }
    };
    
    // menu.htmlã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡
    window.addEventListener('message', function(event) {
      console.log('ğŸ“¨ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡:', event.data);
      
      if (event.data && event.data.type === 'orderCreated' && isInstantCheckoutMode) {
        // å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ã§æ³¨æ–‡ãŒä½œæˆã•ã‚ŒãŸå ´åˆ
        console.log('ğŸ’³ å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰: æ³¨æ–‡ä½œæˆã‚’æ¤œçŸ¥');
        console.log('ğŸ› ãƒ¬ã‚¸è¢‹æƒ…å ±:', {
          bagNeeded: event.data.order.bagNeeded,
          bagQuantity: event.data.order.bagQuantity,
          bagPrice: event.data.order.bagPrice
        });
        processInstantCheckout(event.data.order);
      }
    });
  
  </script>
  
  <!-- å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åœ¨åº«ãƒ‘ãƒãƒ« -->
  <div id="inventoryPanel" style="position: fixed; bottom: 20px; right: 20px; width: 300px; max-height: 400px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 9999; overflow: hidden; transition: all 0.3s ease;">
    <div id="inventoryPanelBar" onclick="playTapSound(); toggleInventoryPanel()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.3s ease;">
      <div style="font-weight: bold; color: white; font-size: 15px;"> åœ¨åº«çŠ¶æ³</div>
      <div id="inventoryPanelArrow" style="color: white; font-size: 18px;">â–¼</div>
    </div>
    <div id="inventoryPanelContent" style="max-height: 350px; overflow-y: auto; padding: 10px;">
      <div style="padding: 10px; text-align: center; color: #999;">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>
  
  <!-- ğŸ†• å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="salesModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3 id="salesModalTitle">æœ¬æ—¥ã®å£²ä¸Š</h3>
        <button class="modal-close" onclick="playTapSound(); closeSalesModal()">Ã—</button>
      </div>
      <div id="salesContent" style="padding: 20px; max-height: 60vh; overflow-y: auto;">
        <div style="text-align: center; padding: 20px;">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <div class="modal-footer" style="display: flex !important; gap: 10px; justify-content: flex-end; padding: 20px; border-top: 1px solid #ddd;">
        <button class="btn btn-secondary" style="padding: 12px 24px;" onclick="playTapSound(); closeSalesModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  
  <!-- ç²¾ç®—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="settlementModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 style="color: #ff6b6b;">ç²¾ç®—ç¢ºèª</h3>
        <button class="modal-close" onclick="playTapSound(); closeSettlementModal()">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
          <p style="margin: 0 0 10px 0; font-weight: bold; color: #856404;">æ³¨æ„äº‹é …:</p>
          <ul style="margin: 0; padding-left: 20px; color: #856404;">
            <li>æœ¬æ—¥ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºå®šã—ã¾ã™</li>
            <li>ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ï¼ˆPNGç”»åƒï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™</li>
            <li>å£²ä¸Šã¯åˆå‰3æ™‚ã«è‡ªå‹•çš„ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</li>
          </ul>
        </div>
        <div style="margin: 20px 0;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">ç²¾ç®—æ—¥ä»˜ã‚’é¸æŠ</label>
          <input type="date" id="settlementDate" onchange="playTapSound(); loadSettlementSummary(this.value)" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
          <p style="font-size: 12px; color: #666; margin-top: 5px;">â€» æ˜¨æ—¥ã®ç²¾ç®—ã‚’ä¸Šã’å¿˜ã‚ŒãŸå ´åˆãªã©ã€éå»ã®æ—¥ä»˜ã‚’é¸æŠã§ãã¾ã™</p>
        </div>
        <div id="settlementSummary" style="margin: 20px 0;"></div>
      </div>
      <div class="modal-footer" style="display: flex; flex-direction: column; gap: 10px;">
        <button class="btn" style="width: 100%; background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%); color: white;" onclick="playTapSound(); confirmSettlement()">ç²¾ç®—ã‚’å®Ÿè¡Œ</button>
        <div style="margin-bottom: 10px;">
          <label style="display: block; margin-bottom: 5px; color: #333; font-weight: bold;">æ—¥è¨ˆè¡¨å‡ºåŠ›ã™ã‚‹æœˆã‚’é¸æŠ:</label>
          <select id="dailyReportMonth" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 10px;">
            <!-- éå»12ãƒ¶æœˆåˆ†ã®é¸æŠè‚¢ã‚’å‹•çš„ã«ç”Ÿæˆ -->
          </select>
          <button class="btn" style="width: 100%; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="playTapSound(); generateDailyReportForSelectedMonth()">æ—¥è¨ˆè¡¨å‡ºåŠ›</button>
        </div>
        <button class="btn btn-secondary" style="width: 100%;" onclick="playTapSound(); closeSettlementModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>
  
  <!-- å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="historyModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3>æ³¨æ–‡å±¥æ­´</h3>
        <button class="modal-close" onclick="playTapSound(); closeHistoryModal()">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap;">
          <select id="historyDateFilter" onchange="playTapSound(); filterHistory()" style="padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
            <option value="today">ä»Šæ—¥</option>
            <option value="yesterday">æ˜¨æ—¥</option>
            <option value="week">ä»Šé€±</option>
            <option value="month">ä»Šæœˆ</option>
            <option value="all">å…¨æœŸé–“</option>
          </select>
          <select id="historyStatusFilter" onchange="playTapSound(); filterHistory()" style="padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
            <option value="all">ã™ã¹ã¦</option>
            <option value="deleted">å‰Šé™¤æ¸ˆã¿</option>
            <option value="paid">ä¼šè¨ˆæ¸ˆã¿</option>
            <option value="completed">å®Œäº†</option>
          </select>
          <button onclick="playTapSound(); refreshHistory()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;">æ›´æ–°</button>
        </div>
        <div id="historyList" style="max-height: 60vh; overflow-y: auto;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="playTapSound(); closeHistoryModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  
  <!-- æ³¨æ–‡ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="editOrderModal" class="modal-overlay" style="display: none;z-index: 99999; ">
    <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3> æ³¨æ–‡ç·¨é›†</h3>
        <button class="modal-close" onclick="playTapSound(); closeEditOrderModal()">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div id="editOrderContent" style="margin: 20px 0;">
          <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
        </div>
      </div>
      <div class="modal-footer">
        <div id="editOrderButtons" style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
          <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- æ”¯å‡ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="expenseModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3 style="color: #f093fb;">æ”¯å‡ºå…¥åŠ›</h3>
        <button class="modal-close" onclick="playTapSound(); closeExpenseModal()">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; gap: 15px;">
          <label style="font-weight: bold; font-size: 16px;">æ—¥ä»˜:</label>
          <input type="date" id="expenseDateInput" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 16px; flex: 1;" onchange="playTapSound(); loadExpensesByDate()" />
        </div>
        <div style="margin: 20px 0;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #f5f5f5;">
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">åº—å</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">å‹˜å®šç§‘ç›®</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">è©³ç´°</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">é‡‘é¡</th>
                <th style="padding: 10px; border: 1px solid #ddd; width: 60px;"></th>
              </tr>
            </thead>
            <tbody id="expenseTableBody"></tbody>
          </table>
          <button class="btn" style="margin-top: 10px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="playTapSound(); addExpenseRow()">ï¼‹ è¡Œã‚’è¿½åŠ </button>
          <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; text-align: right;">
            <span style="font-size: 18px; font-weight: bold;">åˆè¨ˆ: Â¥</span>
            <span id="expenseTotal" style="font-size: 24px; font-weight: bold; color: #f093fb;">0</span>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
        <button class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="playTapSound(); saveExpenses()">ä¿å­˜</button>
        <button class="btn btn-secondary" onclick="playTapSound(); closeExpenseModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  
  <!-- æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="monthlyReportModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3>æœˆæ¬¡</h3>
        <button class="modal-close" onclick="playTapSound(); closeMonthlyReportModal()">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">é–‹å§‹æ—¥</label>
            <input type="date" id="reportStartDate" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
          </div>
          <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">çµ‚äº†æ—¥</label>
            <input type="date" id="reportEndDate" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
          </div>
          <button onclick="playTapSound(); generatePeriodJournal()" style="padding: 12px 24px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px;">ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆ</button>
          </div>
        <div id="monthlyReportContent"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="playTapSound(); closeMonthlyReportModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  
  <!-- ãƒ‰ãƒ­ã‚¢è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="drawerSettingsModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <h3 style="font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 15px; color: #333;">ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‰ãƒ­ã‚¢è¨­å®š</h3>
      <p style="text-align: center; font-size: 14px; color: #666; margin-bottom: 30px;">WiFiå¯¾å¿œãƒ‰ãƒ­ã‚¢ã®æ¥ç¶šè¨­å®š</p>
      
      <div style="margin-bottom: 25px;">
        <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">ãƒ‰ãƒ­ã‚¢IPã‚¢ãƒ‰ãƒ¬ã‚¹</label>
        <input type="text" id="drawerIpInput" placeholder="ä¾‹: 192.168.1.100" 
               style="width: 100%; padding: 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        <div style="margin-top: 8px; font-size: 14px; color: #666;">
          ãƒ‰ãƒ­ã‚¢ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„
        </div>
      </div>
      
      <div style="margin-bottom: 25px;">
        <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">é–‹æ”¾æ™‚é–“ (ãƒŸãƒªç§’)</label>
        <input type="number" id="drawerDurationInput" placeholder="500" 
               style="width: 100%; padding: 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        <div style="margin-top: 8px; font-size: 14px; color: #666;">
          ãƒ‰ãƒ­ã‚¢ãŒé–‹ã„ã¦ã„ã‚‹æ™‚é–“ï¼ˆæ¨å¥¨: 500msï¼‰
        </div>
      </div>
      
      <div id="drawerTestResult" style="display: none; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold;"></div>
      
      <div style="display: flex; gap: 10px; margin-top: 30px;">
        <button onclick="playTapSound(); testDrawerConnection()" 
                style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; box-shadow: 0 4px 15px rgba(76,175,80,0.3);">
          æ¥ç¶šãƒ†ã‚¹ãƒˆ
        </button>
        <button onclick="playTapSound(); saveDrawerSettings()" 
                style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; box-shadow: 0 4px 15px rgba(33,150,243,0.3);">
          ä¿å­˜
        </button>
      </div>
      
      <button onclick="playTapSound(); closeDrawerSettingsModal()" 
              style="width: 100%; padding: 15px; margin-top: 15px; background: #9E9E9E; color: white; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer;">
        é–‰ã˜ã‚‹
      </button>
    </div>
  </div>
  
  <!-- ãƒ—ãƒªãƒ³ã‚¿è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="printerSettingsModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <h3 style="font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 15px; color: #333;">ãƒ—ãƒªãƒ³ã‚¿è¨­å®š</h3>
      <p style="text-align: center; font-size: 16px; color: #666; margin-bottom: 30px;">TSP650II / mC-Print3 / Bluetoothå¯¾å¿œ</p>
      
      <!-- æ¥ç¶šæ–¹å¼é¸æŠ -->
      <div style="margin-bottom: 25px;">
        <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">æ¥ç¶šæ–¹å¼</label>
        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
          <button id="connectionTypeEthernet" onclick="playTapSound(); selectConnectionType('ethernet')" 
                  style="padding: 15px 10px; border: 2px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">
            WiFi/LAN
          </button>
          <button id="connectionTypeBluetooth" onclick="playTapSound(); selectConnectionType('bluetooth')" 
                  style="padding: 15px 10px; border: 2px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">
            Bluetooth
          </button>
          <button id="connectionTypeUsb" onclick="playTapSound(); selectConnectionType('usb')" 
                  style="padding: 15px 10px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">
            USBæ¥ç¶š
          </button>
          <button id="connectionTypeProxy" onclick="playTapSound(); selectConnectionType('proxy')" 
                  style="padding: 15px 10px; border: 2px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">
            ãƒ—ãƒ­ã‚­ã‚·
          </button>
        </div>
      </div>
      
      <!-- Ethernetè¨­å®š -->
      <div id="ethernetSettings" style="display: block;">
        <div style="margin-bottom: 25px;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">ãƒ—ãƒªãƒ³ã‚¿IPã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="text" id="printerIPInput" placeholder="ä¾‹: 192.168.1.100" 
                 style="width: 100%; padding: 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
          <div style="margin-top: 8px; font-size: 14px; color: #666;">
            ãƒ—ãƒªãƒ³ã‚¿ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„<br>
            <small style="color: #999;">â€»ãƒ—ãƒªãƒ³ã‚¿ã®è¨­å®šå°åˆ·ã§ç¢ºèªã§ãã¾ã™</small>
          </div>
        </div>
      </div>
      
      <!-- Bluetoothè¨­å®š -->
      <div id="bluetoothSettings" style="display: none;">
        <div style="margin-bottom: 25px;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">Bluetoothãƒ—ãƒªãƒ³ã‚¿</label>
          <button onclick="playTapSound(); searchBluetoothPrinter()" 
                  style="width: 100%; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; box-shadow: 0 4px 15px rgba(33,150,243,0.3);">
            ãƒ—ãƒªãƒ³ã‚¿ã‚’æ¤œç´¢
          </button>
          <div id="bluetoothDeviceInfo" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 8px; display: none;">
            <div style="font-weight: bold; color: #333;">æ¥ç¶šæ¸ˆã¿ãƒ—ãƒªãƒ³ã‚¿:</div>
            <div id="bluetoothDeviceName" style="color: #666; margin-top: 5px;">ãªã—</div>
          </div>
          <div style="margin-top: 8px; font-size: 14px; color: #666;">
            ESC/POSå¯¾å¿œã®Bluetoothãƒ—ãƒªãƒ³ã‚¿ã‚’æ¤œç´¢ã—ã¾ã™<br>
            <small style="color: #999;">â€»Chromeã€Edgeã§åˆ©ç”¨å¯èƒ½</small>
          </div>
        </div>
      </div>
      
      <!-- USBè¨­å®š -->
      <div id="usbSettings" style="display: none;">
        <div style="margin-bottom: 25px;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">USBãƒ—ãƒªãƒ³ã‚¿</label>
          <button onclick="playTapSound(); connectUSBPrinter()" 
                  style="width: 100%; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; box-shadow: 0 4px 15px rgba(255,152,0,0.3);">
            ãƒ—ãƒªãƒ³ã‚¿ã‚’æ¥ç¶š
          </button>
          <div id="usbDeviceInfo" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 8px; display: none;">
            <div style="font-weight: bold; color: #333;">æ¥ç¶šæ¸ˆã¿ãƒ—ãƒªãƒ³ã‚¿:</div>
            <div id="usbDeviceName" style="color: #666; margin-top: 5px;">ãªã—</div>
          </div>
          <div style="margin-top: 8px; font-size: 14px; color: #666;">
            mC-Print3ã‚’USBã‚±ãƒ¼ãƒ–ãƒ«ã§æ¥ç¶šã—ã¦ãã ã•ã„<br>
            <small style="color: #999;">â€»Chromeã€Edgeã§åˆ©ç”¨å¯èƒ½</small>
          </div>
        </div>
      </div>
      
      <!-- ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼è¨­å®š -->
      <div id="proxySettings" style="display: none;">
        <div style="margin-bottom: 25px;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼URL</label>
          <input type="text" id="printerProxyInput" placeholder="ä¾‹: http://192.168.1.100:3000" 
                 style="width: 100%; padding: 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
          <div style="margin-top: 8px; font-size: 14px; color: #666;">
            PCã§Node.jsã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦URLã‚’å…¥åŠ›<br>
            <small style="color: #999;">â€»ã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚ã«è¡¨ç¤ºã•ã‚Œã¾ã™</small>
          </div>
        </div>
      </div>
      
      <div style="margin-bottom: 25px;">
        <button onclick="playTapSound(); testPrinterConnection()" id="testConnectionBtn"
                style="width: 100%; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; box-shadow: 0 4px 15px rgba(76,175,80,0.3);">
          æ¥ç¶šãƒ†ã‚¹ãƒˆ
        </button>
        <div id="printerTestResult" style="margin-top: 10px; padding: 10px; border-radius: 8px; display: none;"></div>
      </div>
      
      <div style="display: flex; gap: 15px; margin-top: 30px;">
        <button onclick="playTapSound(); closePrinterSettingsModal()" 
                style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: #e0e0e0; color: #666;">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button onclick="playTapSound(); savePrinterSettings()" 
                style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          ä¿å­˜
        </button>
      </div>
    </div>
  </div>
  
  <!-- ğŸ†• åœ¨åº«ä¸€æ‹¬è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="bulkInventoryModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h3>åœ¨åº«ä¸€æ‹¬è¨­å®š</h3>
        <button class="modal-close" onclick="playTapSound(); closeBulkInventoryModal()">Ã—</button>
      </div>
      <div style="padding: 30px;">
        <div style="text-align: center; margin-bottom: 30px;">
          <p style="font-size: 16px; color: #666; line-height: 1.6;">
            ä¼‘æ¥­æ—¥ã‚„è‡¨æ™‚ä¼‘æ¥­æ™‚ã«ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚<br>
            å…¨å•†å“ã®åœ¨åº«çŠ¶æ…‹ã‚’ä¸€æ‹¬ã§å¤‰æ›´ã§ãã¾ã™ã€‚
          </p>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 15px;">
          <button 
            onclick="playTapSound(); bulkSetInventoryToZero()" 
            style="width: 100%; padding: 20px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(244,67,54,0.3);">
            å…¨å•†å“ã‚’å“åˆ‡ã‚Œã«ã™ã‚‹
          </button>
          
          <button 
            onclick="playTapSound(); bulkClearInventoryZero()" 
            style="width: 100%; padding: 20px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 15px rgba(255,152,0,0.3);">
            å…¨å•†å“ã‚’å¾©æ´»ã•ã›ã‚‹
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="playTapSound(); closeBulkInventoryModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  
  <!-- ğŸ†• POSãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="posIframeModal" class="pos-iframe-modal">
    <div class="pos-iframe-container">
      <div class="pos-iframe-header">
        <h3 id="posModalTitle">POSæ©Ÿèƒ½</h3>
        <button class="pos-iframe-close" onclick="playTapSound(); closePOSModal()">Ã—</button>
      </div>
      <iframe id="posIframe" class="pos-iframe-content" src="about:blank"></iframe>
    </div>
  </div>
  
  <!-- ãƒ¬ã‚·ãƒ¼ãƒˆè¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ  (v3 - å®Œå…¨ä¿®æ­£ç‰ˆ) -->
  <script src="receipt-display-functions-v3.js"></script>
  
</body>
</html>