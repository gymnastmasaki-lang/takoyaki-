<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </title>
  
  <!-- å¤–éƒ¨ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <!-- ã‚¿ãƒƒãƒ—éŸ³ -->
  <script>
    // AudioContextã‚’ä½¿ç”¨ã—ãŸã‚¿ãƒƒãƒ—éŸ³ç”Ÿæˆ
    let audioContext = null;
    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }
    function playTapSound() {
      initAudio();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    .login-screen {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .login-screen h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 28px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .login-btn:active {
      transform: scale(0.98);
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ */
    .tables-screen {
      display: none;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .header h2 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .header .store-info {
      color: #666;
      font-size: 14px;
    }
    
    .header-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .logout-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .sales-btn {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .settings-btn {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .table-card {
      background: white;
      border-radius: 15px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    
    .table-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .table-card:active {
      transform: translateY(-2px);
    }
    
    .table-card.has-pending-orders {
      background: linear-gradient(135deg, #fff4e6 0%, #ffe0b2 100%);
      border: 2px solid #ff9800;
    }
    
    .table-card.has-pending-orders .table-name {
      color: #f57c00;
    }
    
    .table-card.has-pending-orders .pending-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff9800;
      color: white;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
    }
    
    .status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
    }
    
    .unpaid-badge {
      background: #f57c00;
      color: white;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }
    
    .table-card .table-name {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .table-card .table-status {
      font-size: 12px;
      color: #999;
    }
    
    .checkout-btn {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .checkout-btn:active {
      transform: scale(0.95);
    }
    
    /* ä¿®æ­£ç®‡æ‰€: hiddenã‚¯ãƒ©ã‚¹ã®å®šç¾©ã‚’æ˜ç¢ºã«ã™ã‚‹ */
    .hidden {
      display: none !important;
    }
    
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }
    
    /* å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨CSS */
    .sales-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    
    .sales-modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    .sales-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .sales-modal-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    
    .sales-modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .sales-modal-close:hover {
      color: #333;
    }
    
    .custom-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    
    .custom-modal-box {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .modal-icon {
      font-size: 64px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 15px;
      color: #333;
    }
    
    .modal-message {
      text-align: center;
      font-size: 16px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.6;
      white-space: pre-line;
    }
    
    .modal-buttons {
      display: flex;
      gap: 15px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 18px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .modal-btn:active {
      transform: scale(0.95);
    }
    
    .modal-btn-cancel {
      background: #e0e0e0;
      color: #333;
    }
    
    .modal-btn-cancel:hover {
      background: #d0d0d0;
    }
    
    .modal-btn-danger {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
    }
    
    .modal-btn-success {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    /* ä¿®æ­£ç®‡æ‰€: .modal-overlayã®displayè¨­å®šã‚’ä¿®æ­£ */
    .modal-overlay {
      display: flex; /* noneã‹ã‚‰å¤‰æ›´ã€‚è¡¨ç¤ºéè¡¨ç¤ºã¯.hiddenã‚¯ãƒ©ã‚¹ã§åˆ¶å¾¡ã™ã‚‹ */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10001;
      align-items: center;
      justify-content: center;
    }
    
    .modal {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal h3 {
      margin: 0 0 20px 0;
      color: #333;
      font-size: 24px;
      text-align: center;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .payment-methods {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .payment-method-btn {
      padding: 15px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .payment-method-btn:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    
    .payment-method-btn.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .cash-input-section {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    
    .cash-input-section label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    
    .cash-input-section input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 18px;
      text-align: center;
    }
    
    .change-display {
      margin-top: 15px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
    }
    
    .change-amount {
      color: #4CAF50;
      font-size: 20px;
    }
    
    .order-selection-btn {
      width: 100%;
      padding: 20px;
      margin-bottom: 15px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
    }
    
    .order-selection-btn:hover {
      border-color: #667eea;
      background: #f8f9ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .order-selection-btn:active {
      transform: translateY(0);
    }
    
    /* ğŸ†• ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10001;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
    }
    
    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 20px;
    }
    
    .modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 28px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.2s;
      line-height: 1;
    }
    
    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .modal-footer {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    /* ğŸ†• æ©Ÿèƒ½ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .header-buttons {
      position: relative;
      display: flex;
      gap: 10px;
    }
    
    .functions-submenu {
      position: absolute;
      top: 45px;
      left: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      margin-top: 8px;
      min-width: 220px;
      z-index: 1000;
      overflow: hidden;
      border: 1px solid rgba(102, 126, 234, 0.1);
    }
    
    .functions-submenu button {
      width: 100%;
      padding: 14px 18px;
      background: white;
      border: none;
      border-left: 3px solid transparent;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .functions-submenu button::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: transform 0.2s ease;
    }
    
    .functions-submenu button:first-child {
      border-radius: 12px 12px 0 0;
    }
    
    .functions-submenu button:last-child {
      border-radius: 0 0 12px 12px;
    }
    
    .functions-submenu button:hover {
      background: linear-gradient(90deg, rgba(102, 126, 234, 0.08) 0%, rgba(255, 255, 255, 0) 100%);
      border-left-color: #667eea;
      padding-left: 22px;
    }
    
    .functions-submenu button:hover::before {
      transform: scale(1.3);
    }
    
    .functions-submenu button:active {
      background: linear-gradient(90deg, rgba(102, 126, 234, 0.12) 0%, rgba(255, 255, 255, 0) 100%);
      transform: scale(0.98);
    }
    
    /* ğŸ†• POSãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .pos-iframe-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }
    
    .pos-iframe-modal.active {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .pos-iframe-container {
      width: 95%;
      height: 95%;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
    }
    
    .pos-iframe-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .pos-iframe-header h3 {
      margin: 0;
      font-size: 18px;
    }
    
    .pos-iframe-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .pos-iframe-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .pos-iframe-content {
      flex: 1;
      width: 100%;
      border: none;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="login-screen" id="loginScreen">
      <h1>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </h1>
      <div id="errorMessage" class="error-message hidden"></div>
      
      <div class="form-group">
        <label for="storeSelect">åº—èˆ—ã‚’é¸æŠ</label>
        <select id="storeSelect">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="passwordInput">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      </div>
      
      <button class="login-btn" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    
    <div class="tables-screen" id="tablesScreen">
      <div class="header">
        <h2 id="storeNameDisplay">åº—èˆ—å</h2>
        <div class="store-info">ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        <div class="header-buttons">
          <button class="sales-btn" onclick="toggleFunctionsMenu()">æ©Ÿèƒ½ â–¼</button>
          <button class="settings-btn" onclick="window.open('https://gymnastmasaki-lang.github.io/takoyaki-/kanri.html', '_blank')">è¨­å®š</button>
          <button class="logout-btn" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
        <!-- ğŸ†• æ©Ÿèƒ½ã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div id="functionsSubMenu" class="functions-submenu" style="display: none;">
          <button onclick="window.open('https://gymnastmasaki-lang.github.io/takoyaki-/kintai.html', '_blank')">å‹¤æ€ </button>
          <button onclick="showSalesModal()">å£²ä¸Š</button>
          <button onclick="showHistoryModal()">å±¥æ­´</button>
          <button onclick="showExpenseModal()">æ”¯å‡º</button>
          <button onclick="openDrawerDirect()">ãƒ‰ãƒ­ã‚¢é–‹</button>
          <button onclick="showMonthlyReportModal()">æœˆæ¬¡</button>
          <button onclick="showPrinterSettings()">ãƒ—ãƒªãƒ³ã‚¿è¨­å®š</button>
        </div>
      </div>
      
      <div class="tables-grid" id="tablesGrid">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>
  
  <div id="customConfirmModal" class="custom-modal-overlay">
    <div class="custom-modal-box">
      <div class="modal-icon" id="modalIcon">âš ï¸</div>
      <div class="modal-title" id="modalTitle">ç¢ºèª</div>
      <div class="modal-message" id="modalMessage">æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeCustomModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-danger" id="modalConfirmBtn" onclick="confirmCustomModal()">å®Ÿè¡Œ</button>
      </div>
    </div>
  </div>
  
  <!-- æ³¨æ–‡é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="orderSelectionModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ“‹ æ³¨æ–‡ã‚’é¸æŠ</h3>
      <p id="orderSelectionTableName" style="color: #666; margin-bottom: 20px; text-align: center; font-size: 18px; font-weight: bold;">ãƒ†ãƒ¼ãƒ–ãƒ«</p>
      <div id="ordersList" style="max-height: 60vh; overflow-y: auto;"></div>
      <div style="margin-top: 20px;">
        <button class="btn btn-secondary" style="width: 100%;" onclick="closeOrderSelectionModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  
  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ’° ä¼šè¨ˆå‡¦ç†</h3>
      <p id="selectedTableLabel2" style="color: #666; margin-bottom: 20px;">ãƒ†ãƒ¼ãƒ–ãƒ«</p>
      
      <div id="taxRateSection" style="margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px; border-left: 4px solid #4CAF50; max-height: 300px; overflow-y: auto;">
        <h4 style="margin: 0 0 15px 0; color: #2e7d32; font-size: 16px;">å„å•†å“ã®ç¨ç‡ã‚’é¸æŠ</h4>
        <div id="taxRateItemsList"></div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #4CAF50; font-weight: bold; font-size: 14px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>8%å¯¾è±¡:</span>
            <span id="tax8Summary" style="color: #FF9800;">Â¥0</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>10%å¯¾è±¡:</span>
            <span id="tax10Summary" style="color: #2196F3;">Â¥0</span>
          </div>
        </div>
      </div>
      
      <div class="payment-methods">
        <button class="payment-method-btn" onclick="selectPaymentMethod('cash')">
          ğŸ’µ ç¾é‡‘
        </button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('emoney')">
          ğŸ“± é›»å­ãƒãƒãƒ¼
        </button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('credit')">
          ğŸ’³ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰
        </button>
      </div>
      
      <div id="cashInputSection" class="cash-input-section hidden">
        <label>ãŠé ã‹ã‚Šé‡‘é¡</label>
        <input type="number" id="cashReceived" placeholder="0" oninput="calculateChange()">
        <div class="change-display" id="changeDisplay">
          ãŠã¤ã‚Š: <span class="change-amount" id="changeAmount">Â¥0</span>
        </div>
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 10px;">
        <label style="font-weight: bold; color: #856404;">å€¤å¼•ãé‡‘é¡</label>
        <input type="number" id="discountAmount" placeholder="0" value="0" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ffc107; border-radius: 8px; margin-top: 8px;" oninput="updatePaymentTotal()">
        <div style="text-align: center; margin-top: 10px; font-size: 18px; font-weight: bold; color: #333;">
          è«‹æ±‚é¡: <span id="finalPaymentAmount" style="color: #4CAF50;">Â¥0</span>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;" id="mainButtons">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="processPayment()" id="paymentBtn" disabled>ğŸ’° ä¼šè¨ˆ</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white;" onclick="completeOrdersForTable()">âœ… å®Œäº†</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white;" onclick="cancelOrdersForTable()">â¸ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="deleteOrdersForTable()">ğŸ—‘ï¸ å‰Šé™¤</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closePaymentModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="priceChangeModal" class="modal-overlay hidden">
    <div class="modal">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 50px; margin-bottom: 10px;">ğŸ’´</div>
        <h3 style="margin: 0; font-size: 20px; color: #333;" id="priceChangeTitle">é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h3>
      </div>
      
      <div style="background: #f5f5f5; border-radius: 10px; padding: 15px; margin: 20px 0; text-align: center;">
        <div style="color: #666; margin-bottom: 10px;" id="priceChangeItemInfo"></div>
        <div style="font-size: 18px; font-weight: bold; color: #333;">
          ç¾åœ¨: <span id="priceChangeCurrentPrice"></span>
        </div>
      </div>
      
      <div style="margin: 20px 0;">
        <input type="number" id="priceChangeInput" placeholder="æ–°ã—ã„é‡‘é¡ã‚’å…¥åŠ›" style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 24px; text-align: center;">
      </div>
      
      <input type="hidden" id="priceChangeItemId">
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="closePriceChangeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="confirmPriceChange()">âœ“ å¤‰æ›´</button>
      </div>
    </div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, getDocs, doc, getDoc, setDoc, where, onSnapshot, updateDoc, deleteDoc, Timestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.onSnapshot = onSnapshot;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.Timestamp = Timestamp;
    window.orderBy = orderBy;
    window.limit = limit;
    
    // åº—èˆ—åˆ¥ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§ã‚’å–å¾—
    window.getStoreCollection = function(collectionName) {
      console.log('ğŸ” HANDY getStoreCollectionå‘¼ã³å‡ºã—');
      console.log('   ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å:', collectionName);
      console.log('   window.currentStoreId:', window.currentStoreId);
      console.log('   typeof:', typeof window.currentStoreId);
      
      // currentStoreIdãŒnullã¾ãŸã¯ç©ºã®å ´åˆã¯æ—§ãƒ‘ã‚¹ã‚’ä½¿ç”¨
      if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
        const oldPathMap = {
          "menus": "menu",
          "employees": "kintai_employees",
          "attendance": "kintai_attendance",
          "orders": "orders",
          "tables": "tables"
        };
        const path = oldPathMap[collectionName] || collectionName;
        console.log('   â†’ æ—§ãƒ‘ã‚¹ä½¿ç”¨:', path);
        return collection(db, path);
      }
      console.log('   â†’ æ–°ãƒ‘ã‚¹ä½¿ç”¨: stores/' + window.currentStoreId + '/' + collectionName);
      return collection(db, "stores", window.currentStoreId, collectionName);
    };

    // åº—èˆ—åˆ¥ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ã‚’å–å¾—
    window.getStoreDoc = function(collectionName, docId) {
      console.log('ğŸ” HANDY getStoreDocå‘¼ã³å‡ºã—');
      console.log('   ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å:', collectionName, 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID:', docId);
      console.log('   window.currentStoreId:', window.currentStoreId);
      
      // currentStoreIdãŒnullã¾ãŸã¯ç©ºã®å ´åˆã¯æ—§ãƒ‘ã‚¹ã‚’ä½¿ç”¨
      if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
        const oldPathMap = {
          "menus": "menu",
          "employees": "kintai_employees",
          "attendance": "kintai_attendance",
          "orders": "orders",
          "tables": "tables"
        };
        const path = oldPathMap[collectionName] || collectionName;
        console.log('   â†’ æ—§ãƒ‘ã‚¹ä½¿ç”¨:', path + '/' + docId);
        return doc(db, path, docId);
      }
      console.log('   â†’ æ–°ãƒ‘ã‚¹ä½¿ç”¨: stores/' + window.currentStoreId + '/' + collectionName + '/' + docId);
      return doc(db, "stores", window.currentStoreId, collectionName, docId);
    };
    
    console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†');
    
    window.firebaseReady = true;
    window.dispatchEvent(new Event('firebaseReady'));
  </script>
  
  <script>
    let currentStoreId = null;
    let currentStoreName = null;
    let storesData = {};
    let ordersListener = null;
    let currentOrders = [];
    let currentTableSettings = null;  // ğŸ†• ç¾åœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š
    
    let selectedPaymentMethod = null;
    let totalAmountToPay = 0;
    let cashReceived = 0;
    let changeAmount = 0;
    let customModalResolve = null;
    
    function showCustomConfirm(options) {
      return new Promise((resolve) => {
        customModalResolve = resolve;
        const modal = document.getElementById('customConfirmModal');
        const icon = document.getElementById('modalIcon');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        
        icon.textContent = options.icon || 'âš ï¸';
        title.textContent = options.title || 'ç¢ºèª';
        message.textContent = options.message || 'æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ';
        
        confirmBtn.className = 'modal-btn ' + (options.btnClass || 'modal-btn-danger');
        confirmBtn.textContent = options.btnText || 'å®Ÿè¡Œ';
        
        modal.style.display = 'flex';
      });
    }
    
    function closeCustomModal() {
      document.getElementById('customConfirmModal').style.display = 'none';
      if (customModalResolve) {
        customModalResolve(false);
        customModalResolve = null;
      }
    }
    
    function confirmCustomModal() {
      document.getElementById('customConfirmModal').style.display = 'none';
      if (customModalResolve) {
        customModalResolve(true);
        customModalResolve = null;
      }
    }
    
    /**
     * ğŸ†• å•†å“ã®é©ç”¨ç¨ç‡ã‚’æ±ºå®šï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã¨foodTypeã‚’è€ƒæ…®ï¼‰
     * ğŸ”¥ æ”¹å–„: ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šï¼ˆtakeout/dine-inï¼‰ãŒæœ‰åŠ¹ãªå ´åˆã€å•†å“ã®taxRateã‚ˆã‚Šã‚‚foodTypeã‚’å„ªå…ˆ
     */
    function getApplicableTaxRate(item, tableSettings) {
      // ğŸ”¥ ç‰¹åˆ¥å‡¦ç†: ãƒ¬ã‚¸è¢‹ã¯å¸¸ã«10%ï¼ˆæœ€å„ªå…ˆï¼‰
      if (item.name?.includes('ãƒ¬ã‚¸è¢‹') || item.name?.includes('ğŸ›ï¸') || item.name?.includes('è¢‹')) {
        console.log(`ğŸ”¥ ãƒ¬ã‚¸è¢‹åˆ¤å®š: ${item.name} â†’ å¼·åˆ¶çš„ã«10%`);
        return 10;
      }
      
      // ğŸ†• foodTypeã‚’æ±ºå®šï¼ˆæœªè¨­å®šã®å ´åˆã¯categoryã‹ã‚‰æ¨æ¸¬ï¼‰
      let foodType = item.foodType;
      if (!foodType) {
        // ã‚«ãƒ†ã‚´ãƒªãŒã€ŒåŒ…æã€ã¾ãŸã¯å•†å“åã«ã€ŒåŒ…æã€ã‚’å«ã‚€å ´åˆã¯é£Ÿæä»¥å¤–
        if (item.category === 'åŒ…æ' || item.name?.includes('åŒ…æ')) {
          foodType = 'non-food';
          console.log(`âš ï¸ foodTypeæœªè¨­å®š â†’ category/name(${item.category}/${item.name})ã‹ã‚‰æ¨æ¸¬: non-foodï¼ˆé£Ÿæä»¥å¤–ï¼‰`);
        } else {
          foodType = 'food';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é£Ÿæ
          console.log(`âš ï¸ foodTypeæœªè¨­å®š â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: foodï¼ˆé£Ÿæï¼‰, å•†å“å: ${item.name}`);
        }
      } else {
        console.log(`âœ… foodTypeè¨­å®šæ¸ˆã¿: ${foodType} (å•†å“: ${item.name})`);
      }
      
      // ğŸ”¥ æ”¹å–„: ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãŒæœ‰åŠ¹ï¼ˆtakeout/dine-inï¼‰ãªå ´åˆã€foodTypeã‚’å„ªå…ˆ
      if (tableSettings && tableSettings.taxRule && tableSettings.taxRule !== 'none') {
        const taxRule = tableSettings.taxRule;
        console.log(`[ç¨ç‡æ±ºå®š] å•†å“: ${item.name}, foodType: ${foodType}, taxRule: ${taxRule}`);
        
        switch(taxRule) {
          case 'takeout':
            // ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ: é£Ÿæã¯8%ã€é£Ÿæä»¥å¤–ã¯10%
            const takeoutRate = (foodType === 'food') ? 8 : 10;
            console.log(`  â†’ ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆãƒ¢ãƒ¼ãƒ‰: ${foodType === 'food' ? 'é£Ÿæ(8%)' : 'é£Ÿæä»¥å¤–(10%)'} = ${takeoutRate}%`);
            return takeoutRate;
          
          case 'dine-in':
            // åº—å†…é£²é£ŸåŠã³é£Ÿæä»¥å¤–: å…¨éƒ¨10%
            console.log(`  â†’ åº—å†…é£²é£ŸåŠã³é£Ÿæä»¥å¤–ãƒ¢ãƒ¼ãƒ‰: 10%`);
            return 10;
          
          default:
            // ä¸æ˜ãªtaxRule: å•†å“ã®taxRateã‚’å„ªå…ˆã€æœªè¨­å®šãªã‚‰foodTypeã‹ã‚‰æ¨æ¸¬
            if (item.taxRate !== undefined && item.taxRate !== null) {
              console.log(`  â†’ ä¸æ˜ãªtaxRule: ${taxRule} â†’ å•†å“ã®taxRate: ${item.taxRate}%`);
              return item.taxRate;
            }
            const defaultRate = (foodType === 'non-food') ? 10 : 8;
            console.log(`  â†’ ä¸æ˜ãªtaxRule: ${taxRule}, taxRateæœªè¨­å®š â†’ foodType(${foodType})ã‹ã‚‰: ${defaultRate}%`);
            return defaultRate;
        }
      }
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãŒãªã„ã€ã¾ãŸã¯taxRuleãŒ'none'ã®å ´åˆã¯å•†å“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡ã‚’ä½¿ç”¨
      // å•†å“ã®taxRateã‚’å„ªå…ˆä½¿ç”¨
      if (item.taxRate !== undefined && item.taxRate !== null) {
        console.log(`[ç¨ç‡æ±ºå®š] ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãªã— â†’ å•†å“ã®taxRate: ${item.taxRate}%`);
        return item.taxRate;
      }
      
      // taxRateãŒãªã„å ´åˆã€foodTypeã‹ã‚‰æ¨æ¸¬ï¼ˆé£Ÿæ:8%, é£Ÿæä»¥å¤–:10%ï¼‰
      const inferredRate = (foodType === 'non-food') ? 10 : 8;
      console.log(`[ç¨ç‡æ±ºå®š] ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãªã—ã€taxRateæœªè¨­å®š â†’ foodType(${foodType})ã‹ã‚‰æ¨æ¸¬: ${inferredRate}%`);
      return inferredRate;
    }
    
    /**
     * ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’å–å¾—
     */
    async function getTableSettings(tableId) {
      if (!tableId || !currentStoreId) {
        return null;
      }
      
      try {
        const tableDocRef = window.doc(window.db, 'stores', currentStoreId, 'tableSettings', tableId);
        const tableDoc = await window.getDoc(tableDocRef);
        
        if (tableDoc.exists()) {
          console.log('ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šå–å¾—:', tableId, tableDoc.data());
          return tableDoc.data();
        }
        console.log('ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãªã—:', tableId);
        return null;
      } catch (e) {
        console.error('âŒ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        return null;
      }
    }
    
    async function loadStoreList() {
      try {
        const storesQuery = window.query(
          window.collection(window.db, 'stores'),
          window.where('isActive', '==', true)
        );
        const storesSnapshot = await window.getDocs(storesQuery);
        const storeSelect = document.getElementById('storeSelect');
        
        storeSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        storesData = {};
        
        storesSnapshot.forEach(doc => {
          const storeData = doc.data();
          const storeId = doc.id;
          const storeName = storeData.storeName || doc.id;
          const password = storeData.storePassword || '';
          
          storesData[storeId] = {
            storeName: storeName,
            password: String(password),
            isActive: true
          };
          
          const option = document.createElement('option');
          option.value = storeId;
          option.textContent = storeName;
          storeSelect.appendChild(option);
        });
      } catch (error) {
        console.error('âŒ åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        showError('åº—èˆ—ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
    
    window.handleLogin = async function() {
      playTapSound();
      const storeSelect = document.getElementById('storeSelect');
      const passwordInput = document.getElementById('passwordInput');
      const storeId = storeSelect.value;
      const inputPassword = passwordInput.value.trim();
      
      if (!storeId) {
        showError('åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      if (!inputPassword) {
        showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      const storeInfo = storesData[storeId];
      if (inputPassword !== storeInfo.password) {
        showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      currentStoreId = storeId;
      window.currentStoreId = storeId; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦è¨­å®š
      currentStoreName = storeInfo.storeName;
      sessionStorage.setItem('handyStoreId', storeId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      
      // ğŸ†• ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’ä¿å­˜ï¼ˆPOSè‡ªå‹•ãƒ­ã‚°ã‚¤ãƒ³ç”¨ï¼‰
      window.saveLoginInfo(storeId, inputPassword);
      
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log('ğŸ“ HANDY åº—èˆ—IDè¨­å®šå®Œäº†');
      console.log('   currentStoreId:', currentStoreId);
      console.log('   window.currentStoreId:', window.currentStoreId);
      console.log('   currentStoreName:', currentStoreName);
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      
      showTablesScreen();
    };
    
    window.handleLogout = async function() {
      playTapSound();
      const confirmed = await showCustomConfirm({
        icon: 'ğŸšª',
        title: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
        message: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ',
        btnClass: 'modal-btn-danger',
        btnText: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ'
      });
      
      if (confirmed) {
        if (ordersListener) ordersListener();
        sessionStorage.removeItem('handyStoreId');
        sessionStorage.removeItem('handyStoreName');
        location.reload();
      }
    };
    
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => errorDiv.classList.add('hidden'), 3000);
    }
    
    async function showTablesScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('tablesScreen').style.display = 'block';
      document.getElementById('tablesScreen').classList.remove('hidden');
      document.getElementById('storeNameDisplay').textContent = currentStoreName;
      
      await loadTables();
      startOrdersListener();
      
      // ğŸ†• åœ¨åº«ãƒ‘ãƒãƒ«ã‚’åˆæœŸåŒ–
      updateInventoryPanel();
      watchInventoryChanges();
    }
    
    function startOrdersListener() {
      if (ordersListener) ordersListener();
      const ordersRef = window.getStoreCollection('orders');
      ordersListener = window.onSnapshot(ordersRef, (snapshot) => {
        updateTableStatus(snapshot);
      });
    }
    
    function updateTableStatus(ordersSnapshot) {
      const unpaidTables = new Set();  // æ³¨æ–‡ã‚ã‚Šï¼ˆæœªä¼šè¨ˆï¼‰
      const completedUnpaidTables = new Set();  // å®Œäº†æ¸ˆã¿ã ãŒæœªä¼šè¨ˆ
      const hasIncompleteOrders = new Set();  // æœªå®Œäº†ã®æ³¨æ–‡ãŒã‚ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«
      
      console.log('ğŸ”„ ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°é–‹å§‹');
      
      ordersSnapshot.forEach(doc => {
        const order = doc.data();
        console.log('ğŸ“‹ æ³¨æ–‡ãƒã‚§ãƒƒã‚¯:', {
          id: doc.id,
          table: order.tableNumber,
          deleted: order.deleted,
          cancelled: !!order.cancelledAt,
          paid: !!order.paidAt,
          completed: !!order.completedAt
        });
        
        if (order.tableNumber && !order.deleted && !order.cancelledAt) {
          // ä¼šè¨ˆæ¸ˆã¿ã§ãªã„æ³¨æ–‡
          if (!order.paidAt) {
            unpaidTables.add(order.tableNumber);
            
            // å®Œäº†æ¸ˆã¿ã ãŒæœªä¼šè¨ˆ
            if (order.completedAt) {
              completedUnpaidTables.add(order.tableNumber);
              console.log('âš ï¸ æœªä¼šè¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ç™ºè¦‹:', order.tableNumber);
            } else {
              // æœªå®Œäº†ã®æ³¨æ–‡ãŒã‚ã‚‹
              hasIncompleteOrders.add(order.tableNumber);
              console.log('ğŸ“ æœªå®Œäº†æ³¨æ–‡ã‚ã‚Š:', order.tableNumber);
            }
          }
        }
      });
      
      console.log('ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é›†è¨ˆ:', {
        æœªä¼šè¨ˆãƒ†ãƒ¼ãƒ–ãƒ«: Array.from(completedUnpaidTables),
        æ³¨æ–‡ã‚ã‚Šãƒ†ãƒ¼ãƒ–ãƒ«: Array.from(unpaidTables),
        æœªå®Œäº†æ³¨æ–‡ã‚ã‚Š: Array.from(hasIncompleteOrders)
      });
      
      document.querySelectorAll('.table-card').forEach(card => {
        const tableName = card.getAttribute('data-table-name');
        
        // æ—¢å­˜ã®ãƒãƒƒã‚¸ã‚’ã™ã¹ã¦å‰Šé™¤
        card.querySelectorAll('.pending-badge, .status-badge, .unpaid-badge').forEach(badge => badge.remove());
        
        if (unpaidTables.has(tableName)) {
          // æ³¨æ–‡ã‚ã‚Š â†’ èƒŒæ™¯ã‚’ã‚ªãƒ¬ãƒ³ã‚¸ã«
          card.classList.add('has-pending-orders');
          
          // ã€Œæ³¨æ–‡ã‚ã‚Šã€ãƒãƒƒã‚¸ã‚’è¿½åŠ ï¼ˆæœªå®Œäº†ã®æ³¨æ–‡ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
          if (hasIncompleteOrders.has(tableName)) {
            const orderBadge = document.createElement('div');
            orderBadge.className = 'pending-badge';
            orderBadge.textContent = 'æ³¨æ–‡ã‚ã‚Š';
            orderBadge.style.cssText = 'position: absolute; top: 10px; right: 10px; background: #ff9800; color: white; font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: bold;';
            card.appendChild(orderBadge);
            console.log('âœ… æ³¨æ–‡ã‚ã‚Šãƒãƒƒã‚¸è¿½åŠ :', tableName);
          }
          
          // ã€Œæœªä¼šè¨ˆã€ãƒãƒƒã‚¸ã‚’è¿½åŠ ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
          const unpaidBadge = document.createElement('div');
          unpaidBadge.className = 'unpaid-badge';
          unpaidBadge.textContent = 'æœªä¼šè¨ˆ';
          unpaidBadge.style.cssText = 'position: absolute; top: 10px; left: 10px; background: #f57c00; color: white; font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: bold; animation: pulse 2s infinite;';
          card.appendChild(unpaidBadge);
          console.log('âœ… æœªä¼šè¨ˆãƒãƒƒã‚¸è¿½åŠ :', tableName);
        } else {
          // ç©ºå¸­ â†’ ãƒãƒƒã‚¸ãªã—
          card.classList.remove('has-pending-orders');
          console.log('â„¹ï¸ ç©ºå¸­:', tableName);
        }
      });
    }
    
    async function loadTables() {
      try {
        const tablesGrid = document.getElementById('tablesGrid');
        tablesGrid.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
        
        const tablesRef = window.getStoreCollection('tables');
        const tablesSnapshot = await window.getDocs(tablesRef);
        const tables = [];
        
        tablesSnapshot.forEach(doc => {
          tables.push({ id: doc.id, ...doc.data() });
        });
        
        tables.sort((a, b) => (a.order || 0) - (b.order || 0) || a.name.localeCompare(b.name));
        
        if (tables.length === 0) {
          tablesGrid.innerHTML = '<div style="color: white; text-align: center; padding: 40px;">ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
          return;
        }
        
        tablesGrid.innerHTML = '';
        tables.forEach(table => {
          const tableCard = document.createElement('div');
          tableCard.className = 'table-card';
          tableCard.setAttribute('data-table-name', table.name);
          tableCard.innerHTML = `
            <div class="table-name">${table.name}</div>
            <div class="table-status">ã‚¿ãƒƒãƒ—ã—ã¦æ³¨æ–‡</div>
          `;
          
          // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰è‡ªä½“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã«é·ç§»
          tableCard.onclick = () => { 
            playTapSound(); 
            openMenu(table.name); 
          };
          
          const menuBtn = document.createElement('button');
          menuBtn.className = 'checkout-btn';
          menuBtn.textContent = 'ğŸ“± ãƒ¡ãƒ‹ãƒ¥ãƒ¼';
          menuBtn.style.background = '#667eea';
          menuBtn.onclick = (e) => { e.stopPropagation(); playTapSound(); openMenu(table.name); };
          tableCard.appendChild(menuBtn);
          
          const checkoutBtn = document.createElement('button');
          checkoutBtn.className = 'checkout-btn';
          checkoutBtn.textContent = 'ğŸ’° ä¼šè¨ˆ';
          checkoutBtn.onclick = (e) => { e.stopPropagation(); playTapSound(); openCheckoutForTable(table.name); };
          tableCard.appendChild(checkoutBtn);
          
          tablesGrid.appendChild(tableCard);
        });
      } catch (error) {
        console.error('âŒ ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    function openMenu(tableName) {
      console.log('ğŸ½ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã:', {
        tableName: tableName,
        currentStoreId: currentStoreId,
        currentStoreName: currentStoreName
      });
      
      // åº—èˆ—IDã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆmenu.htmlã§ä½¿ç”¨ï¼‰
      sessionStorage.setItem('handyStoreId', currentStoreId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      sessionStorage.setItem('handyTableName', tableName);
      
      const menuUrl = `menu.html?table=${encodeURIComponent(tableName)}&store=${currentStoreId}&mode=handy`;
      console.log('ğŸ“± é·ç§»å…ˆURL:', menuUrl);
      window.location.href = menuUrl;
    }
    
    async function openCheckoutForTable(tableName) {
      try {
        const ordersRef = window.getStoreCollection('orders');
        const ordersQuery = window.query(ordersRef, window.where('tableNumber', '==', String(tableName)));
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        currentOrders = [];
        ordersSnapshot.forEach(doc => {
          const order = { id: doc.id, ...doc.data() };
          if (!order.deleted && !order.cancelledAt && !order.paidAt) {
            currentOrders.push(order);
          }
        });
        
        // æ³¨æ–‡ç•ªå·ã§ã‚½ãƒ¼ãƒˆ
        currentOrders.sort((a, b) => (a.orderNumber || 0) - (b.orderNumber || 0));
        
        if (currentOrders.length === 0) {
          await showCustomAlert({ icon: 'ğŸ“‹', title: 'æ³¨æ–‡ãªã—', message: `${tableName}\nã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“`, btnClass: 'modal-btn-success' });
          return;
        }
        
        // è¤‡æ•°æ³¨æ–‡ãŒã‚ã‚‹å ´åˆã¯é¸æŠç”»é¢ã‚’è¡¨ç¤º
        if (currentOrders.length > 1) {
          showOrderSelectionModal(tableName);
        } else {
          showCheckoutMenu(tableName, [currentOrders[0]]);
        }
      } catch (error) {
        console.error('âŒ ä¼šè¨ˆç”»é¢è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // æ³¨æ–‡é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showOrderSelectionModal(tableName) {
      const modal = document.getElementById('orderSelectionModal');
      document.getElementById('orderSelectionTableName').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${tableName}`;
      
      const ordersList = document.getElementById('ordersList');
      ordersList.innerHTML = '';
      
      // å…¨æ³¨æ–‡ã¾ã¨ã‚ã¦ä¼šè¨ˆãƒœã‚¿ãƒ³
      const allOrdersBtn = document.createElement('button');
      allOrdersBtn.className = 'order-selection-btn';
      allOrdersBtn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
      allOrdersBtn.style.color = 'white';
      allOrdersBtn.style.fontWeight = 'bold';
      
      // æœªå®Œäº†ã¨å®Œäº†æ¸ˆã¿ã®ä»¶æ•°ã‚’è¨ˆç®—
      const incompleteCount = currentOrders.filter(o => !o.completedAt).length;
      const completeCount = currentOrders.filter(o => o.completedAt).length;
      const statusText = incompleteCount > 0 && completeCount > 0 
        ? ` (æœªå®Œäº† ${incompleteCount}ä»¶ / å®Œäº†æ¸ˆã¿ ${completeCount}ä»¶)`
        : incompleteCount > 0 
        ? ` (æœªå®Œäº† ${incompleteCount}ä»¶)`
        : completeCount > 0 
        ? ` (å®Œäº†æ¸ˆã¿ ${completeCount}ä»¶)`
        : '';
      
      allOrdersBtn.innerHTML = `
        <div style="font-size: 20px; margin-bottom: 8px;">ğŸ“‹ å…¨æ³¨æ–‡ã¾ã¨ã‚ã¦ä¼šè¨ˆ</div>
        <div style="font-size: 16px;">åˆè¨ˆ ${currentOrders.length} ä»¶${statusText} - Â¥${currentOrders.reduce((sum, o) => sum + (o.totalAmount || 0), 0).toLocaleString()}</div>
      `;
      allOrdersBtn.onclick = () => {
        modal.classList.add('hidden');
        showCheckoutMenu(tableName, currentOrders);
      };
      ordersList.appendChild(allOrdersBtn);
      
      // å€‹åˆ¥æ³¨æ–‡ãƒœã‚¿ãƒ³
      currentOrders.forEach((order, index) => {
        const orderBtn = document.createElement('button');
        orderBtn.className = 'order-selection-btn';
        orderBtn.style.position = 'relative';  // ãƒãƒƒã‚¸ã®é…ç½®ã®ãŸã‚
        
        const itemsText = order.items && Array.isArray(order.items)
          ? order.items.map(item => `${item.name} x${item.quantity || 1}`).join(', ')
          : 'æ³¨æ–‡å†…å®¹ãªã—';
        
        // æœªå®Œäº†ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        const isIncomplete = !order.completedAt;
        const statusBadge = isIncomplete 
          ? '<span style="position: absolute; top: 10px; right: 10px; background: #ff9800; color: white; font-size: 11px; padding: 4px 10px; border-radius: 12px; font-weight: bold;">æœªå®Œäº†</span>'
          : '<span style="position: absolute; top: 10px; right: 10px; background: #4CAF50; color: white; font-size: 11px; padding: 4px 10px; border-radius: 12px; font-weight: bold;">å®Œäº†æ¸ˆã¿</span>';
        
        orderBtn.innerHTML = `
          ${statusBadge}
          <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">æ³¨æ–‡ #${order.orderNumber || (index + 1)}</div>
          <div style="font-size: 14px; color: #666; margin-bottom: 8px;">${itemsText}</div>
          <div style="font-size: 16px; color: #4CAF50; font-weight: bold;">Â¥${(order.totalAmount || 0).toLocaleString()}</div>
        `;
        orderBtn.onclick = () => {
          modal.classList.add('hidden');
          showCheckoutMenu(tableName, [order]);
        };
        ordersList.appendChild(orderBtn);
      });
      
      modal.classList.remove('hidden');
    }
    
    window.closeOrderSelectionModal = function() {
      document.getElementById('orderSelectionModal').classList.add('hidden');
    };
    
    async function showCheckoutMenu(tableName, selectedOrders = null) {
      // selectedOrdersãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°currentOrderså…¨ã¦
      const ordersToCheckout = selectedOrders || currentOrders;
      
      totalAmountToPay = ordersToCheckout.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      const paymentModal = document.getElementById('paymentModal');
      paymentModal.classList.remove('hidden');
      
      // æ³¨æ–‡ç•ªå·ã‚’è¡¨ç¤º
      let orderNumbersText = '';
      if (ordersToCheckout.length === 1) {
        orderNumbersText = ` - æ³¨æ–‡ #${ordersToCheckout[0].orderNumber || '1'}`;
      } else if (ordersToCheckout.length > 1) {
        const orderNums = ordersToCheckout.map(o => `#${o.orderNumber || '?'}`).join(', ');
        orderNumbersText = ` - ${orderNums}`;
      }
      
      document.getElementById('selectedTableLabel2').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${tableName}${orderNumbersText}`;
      
      // é¸æŠã•ã‚ŒãŸæ³¨æ–‡ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ï¼ˆä¼šè¨ˆå‡¦ç†ã§ä½¿ç”¨ï¼‰
      window.ordersToCheckout = ordersToCheckout;
      
      // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’å–å¾—
      currentTableSettings = await getTableSettings(tableName);
      console.log('ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š:', tableName, currentTableSettings);
      
      generateTaxRateItems(ordersToCheckout, tableName);
      document.getElementById('discountAmount').value = 0;
      updatePaymentTotal();
      
      selectedPaymentMethod = null;
      document.querySelectorAll('.payment-method-btn').forEach(btn => btn.classList.remove('selected'));
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('paymentBtn').disabled = true;
    }
    
    window.closePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
    };
    
    function generateTaxRateItems(ordersToProcess = null, tableName = '') {
      const container = document.getElementById('taxRateItemsList');
      container.innerHTML = '';
      let itemIndex = 0;
      
      const orders = ordersToProcess || currentOrders;
      
      orders.forEach(order => {
        if (!order.items || order.items.length === 0) {
          // æ³¨æ–‡å…¨ä½“ã¨ã—ã¦æ‰±ã†å ´åˆï¼ˆå¤ã„å½¢å¼ï¼‰
          // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã«åŸºã¥ã„ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡ã‚’æ±ºå®šã™ã‚‹ãŒã€å•†å“ãŒãªã„ã®ã§10%ã¨ã™ã‚‹
          const defaultTaxRate = 10;
          addTaxRateItem(container, `æ³¨æ–‡ #${order.orderNumber}`, 1, order.totalAmount || 0, itemIndex, defaultTaxRate, 'inclusive');
          itemIndex++;
        } else {
          order.items.forEach(item => {
            const toppingStr = item.toppings || item.toppingDetails || 'ãªã—';
            // ğŸ†• å¤–ç¨ã®å ´åˆã¯æœ¬ä½“ä¾¡æ ¼ã€å†…ç¨ã®å ´åˆã¯ç¨è¾¼ä¾¡æ ¼
            const itemBasePrice = item.price + (item.toppingPrice || 0);
            const itemTotal = itemBasePrice * item.quantity;
            
            // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã¨foodTypeã«åŸºã¥ã„ã¦ç¨ç‡ã‚’æ±ºå®š
            const itemTaxRate = getApplicableTaxRate(item, currentTableSettings);
            console.log(`âœ… é©ç”¨ç¨ç‡: ${itemTaxRate}% (å•†å“: ${item.name}, foodType: ${item.foodType || 'food'}, taxRule: ${currentTableSettings?.taxRule || 'none'})`);
            
            // ğŸ†• taxTypeã‚’æ¸¡ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å†…ç¨ï¼‰
            addTaxRateItem(container, `${item.name} (${toppingStr})`, item.quantity, itemTotal, itemIndex, itemTaxRate, item.taxType || 'inclusive');
            itemIndex++;
          });
          if (order.bagNeeded && order.bagQuantity > 0) {
            addTaxRateItem(container, 'ğŸ›ï¸ ãƒ¬ã‚¸è¢‹', order.bagQuantity, order.bagPrice || (order.bagQuantity * 3), itemIndex, 10, 'inclusive');
            itemIndex++;
          }
        }
      });
      calculateTaxSummary();
    }
    
    function addTaxRateItem(container, itemName, quantity, itemTotal, index, defaultTaxRate, taxType = 'inclusive') {
      // ğŸ†• å¤–ç¨ã®å ´åˆã¯ç¨è¾¼ä¾¡æ ¼ã‚’è¨ˆç®—ï¼ˆitemTotalã¯æœ¬ä½“ä¾¡æ ¼ï¼‰
      let displayTotal = itemTotal;
      if (taxType === 'exclusive') {
        // å¤–ç¨ã®å ´åˆã€itemTotalã¯æœ¬ä½“ä¾¡æ ¼ãªã®ã§ç¨ã‚’åŠ ç®—
        displayTotal = itemTotal + Math.floor(itemTotal * (defaultTaxRate / 100));
        console.log(`ğŸ†• å¤–ç¨è¨ˆç®—: æœ¬ä½“${itemTotal}å†† + ç¨${Math.floor(itemTotal * (defaultTaxRate / 100))}å†† â†’ ${displayTotal}å††ï¼ˆç¨ç‡${defaultTaxRate}%ï¼‰`);
      }
      
      const itemDiv = document.createElement('div');
      itemDiv.style.cssText = 'padding: 10px; margin-bottom: 8px; background: white; border-radius: 6px; border: 1px solid #ddd;';
      
      const headerDiv = document.createElement('div');
      headerDiv.style.cssText = 'display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; font-size: 14px; cursor: pointer;';
      headerDiv.innerHTML = `<span>${itemName} Ã—${quantity}</span><span style="color: #667eea;" id="itemPrice${index}">Â¥${displayTotal.toLocaleString()}</span>`;
      
      headerDiv.onclick = function() {
        document.getElementById('priceChangeTitle').textContent = itemName;
        document.getElementById('priceChangeCurrentPrice').textContent = `Â¥${displayTotal.toLocaleString()}`;
        document.getElementById('priceChangeInput').value = displayTotal;
        document.getElementById('priceChangeItemId').value = index;
        document.getElementById('priceChangeModal').classList.remove('hidden');
      };
      
      const radioDiv = document.createElement('div');
      radioDiv.style.cssText = 'display: flex; gap: 10px; justify-content: center;';
      
      const radio8 = createRadio(index, 8, displayTotal, defaultTaxRate === 8, itemTotal, taxType);
      const radio10 = createRadio(index, 10, displayTotal, defaultTaxRate === 10, itemTotal, taxType);
      
      radioDiv.appendChild(createRadioLabel(radio8, '8%æŒã¡å¸°ã‚Š', '#fff3e0', '#FF9800'));
      radioDiv.appendChild(createRadioLabel(radio10, '10%åº—å†…', '#e3f2fd', '#2196F3'));
      
      itemDiv.appendChild(headerDiv);
      itemDiv.appendChild(radioDiv);
      container.appendChild(itemDiv);
    }
    
    function createRadio(index, rate, amount, checked, baseAmount = null, taxType = 'inclusive') {
      const radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = `taxRate${index}`;
      radio.value = rate;
      radio.checked = checked;
      radio.dataset.amount = amount;
      radio.dataset.taxType = taxType;  // ğŸ†• taxTypeã‚’ä¿å­˜
      radio.dataset.baseAmount = baseAmount || amount;  // ğŸ†• æœ¬ä½“ä¾¡æ ¼ã‚’ä¿å­˜
      radio.style.marginRight = '5px';
      
      // ğŸ†• å¤–ç¨ã®å ´åˆã¯ç¨ç‡å¤‰æ›´æ™‚ã«é‡‘é¡ã‚’å†è¨ˆç®—
      radio.onchange = function() {
        if (taxType === 'exclusive') {
          const newAmount = parseInt(radio.dataset.baseAmount) + Math.floor(parseInt(radio.dataset.baseAmount) * (rate / 100));
          // åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã®å…¨ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®amountã‚’æ›´æ–°
          document.querySelectorAll(`input[name="taxRate${index}"]`).forEach(r => {
            r.dataset.amount = newAmount;
          });
          document.getElementById('itemPrice' + index).textContent = 'Â¥' + newAmount.toLocaleString();
          console.log(`ğŸ”„ å¤–ç¨${rate}%ã«å¤‰æ›´: ${radio.dataset.baseAmount}å†† â†’ ${newAmount}å††`);
        }
        calculateTaxSummary();
      };
      
      return radio;
    }
    
    function createRadioLabel(radio, text, bg, border) {
      const label = document.createElement('label');
      label.style.cssText = `flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 6px 10px; border-radius: 4px; background: ${bg}; border: 2px solid ${border}; font-size: 13px;`;
      label.appendChild(radio);
      label.appendChild(document.createTextNode(text));
      return label;
    }
    
    function calculateTaxSummary() {
      let tax8 = 0, tax10 = 0;
      document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked').forEach(r => {
        if (r.value === '8') tax8 += parseFloat(r.dataset.amount);
        else tax10 += parseFloat(r.dataset.amount);
      });
      document.getElementById('tax8Summary').textContent = 'Â¥' + tax8.toLocaleString();
      document.getElementById('tax10Summary').textContent = 'Â¥' + tax10.toLocaleString();
      updatePaymentTotal();
    }
    
    window.updatePaymentTotal = function() {
      let total = 0;
      document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked').forEach(r => total += parseFloat(r.dataset.amount));
      const final = Math.max(0, total - (parseInt(document.getElementById('discountAmount').value) || 0));
      totalAmountToPay = final;
      document.getElementById('finalPaymentAmount').textContent = 'Â¥' + final.toLocaleString();
      if (selectedPaymentMethod === 'cash') calculateChange();
    };
    
    window.selectPaymentMethod = function(method) {
      playTapSound();
      selectedPaymentMethod = method;
      document.querySelectorAll('.payment-method-btn').forEach(btn => btn.classList.toggle('selected', btn.innerText.includes(method === 'cash' ? 'ç¾é‡‘' : method === 'emoney' ? 'é›»å­' : 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ')));
      document.getElementById('cashInputSection').classList.toggle('hidden', method !== 'cash');
      document.getElementById('paymentBtn').disabled = method === 'cash';
    };
    
    window.calculateChange = function() {
      cashReceived = parseInt(document.getElementById('cashReceived').value) || 0;
      changeAmount = cashReceived - totalAmountToPay;
      document.getElementById('changeAmount').textContent = `Â¥${changeAmount.toLocaleString()}`;
      document.getElementById('paymentBtn').disabled = cashReceived < totalAmountToPay;
    };
    
    window.confirmPriceChange = function() {
      const itemId = document.getElementById('priceChangeItemId').value;
      const newPrice = parseFloat(document.getElementById('priceChangeInput').value) || 0;
      document.querySelectorAll(`input[name="taxRate${itemId}"]`).forEach(r => r.dataset.amount = newPrice);
      document.getElementById(`itemPrice${itemId}`).textContent = 'Â¥' + newPrice.toLocaleString();
      calculateTaxSummary();
      document.getElementById('priceChangeModal').classList.add('hidden');
    };
    
    window.closePriceChangeModal = function() {
      document.getElementById('priceChangeModal').classList.add('hidden');
    };

    // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆOK ãƒœã‚¿ãƒ³ã®ã¿ï¼‰
    function showCustomAlert(options) {
      return new Promise((resolve) => {
        const modal = document.getElementById('customConfirmModal');
        const icon = document.getElementById('modalIcon');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const buttonsContainer = document.querySelector('.modal-buttons');
        
        icon.textContent = options.icon || 'â„¹ï¸';
        title.textContent = options.title || 'ãŠçŸ¥ã‚‰ã›';
        message.textContent = options.message || '';
        
        buttonsContainer.innerHTML = `
          <button class="modal-btn ${options.btnClass || 'modal-btn-primary'}" onclick="closeCustomAlert()">${options.btnText || 'OK'}</button>
        `;
        
        window.closeCustomAlert = function() {
          modal.style.display = 'none';
          resolve(true);
        };
        
        modal.style.display = 'flex';
      });
    }

    // ä¼šè¨ˆå‡¦ç†ï¼ˆå£²ä¸Šãƒ»å®¢æ•°ã‚’POSã«åæ˜ ï¼‰- ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§å®Œçµ
    window.processPayment = async function() {
      playTapSound();
      
      if (!selectedPaymentMethod) {
        await showCustomAlert({ icon: 'âš ï¸', title: 'ã‚¨ãƒ©ãƒ¼', message: 'æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„', btnClass: 'modal-btn-danger' });
        return;
      }
      
      if (selectedPaymentMethod === 'cash' && cashReceived < totalAmountToPay) {
        await showCustomAlert({ icon: 'âš ï¸', title: 'ã‚¨ãƒ©ãƒ¼', message: 'ãŠé ã‹ã‚Šé‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™', btnClass: 'modal-btn-danger' });
        return;
      }
      
      try {
        const now = window.Timestamp.now();
        
        // window.ordersToCheckoutã‹ã‚‰ä¼šè¨ˆå¯¾è±¡ã®æ³¨æ–‡ã‚’å–å¾—
        const ordersToProcess = window.ordersToCheckout || currentOrders;
        
        // å€¤å¼•ãé‡‘é¡ã‚’å–å¾—
        const discountAmount = parseInt(document.getElementById('discountAmount').value) || 0;
        
        // ç¨ç‡åˆ¥é›†è¨ˆ
        let tax8Total = 0;
        let tax10Total = 0;
        const radios = document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked');
        radios.forEach(radio => {
          const amount = parseFloat(radio.dataset.amount) || 0;
          const taxRate = radio.value;
          if (taxRate === '8') {
            tax8Total += amount;
          } else if (taxRate === '10') {
            tax10Total += amount;
          }
        });
        
        // å€¤å¼•ãå¾Œã®é‡‘é¡ï¼ˆtotalAmountToPayã¯æ—¢ã«å€¤å¼•ãå¾Œï¼‰
        const totalBeforeDiscount = tax8Total + tax10Total;
        
        // å•†å“ç‚¹æ•°ã‚’è¨ˆç®—
        let itemCount = 0;
        ordersToProcess.forEach(order => {
          if (order.items && Array.isArray(order.items)) {
            order.items.forEach(item => {
              itemCount += item.quantity || 0;
            });
          } else {
            itemCount += 1;
          }
        });
        
        console.log('ğŸ’° ä¼šè¨ˆå‡¦ç†é–‹å§‹:', {
          totalAmount: totalAmountToPay,
          å€¤å¼•ãå‰é‡‘é¡: totalBeforeDiscount,
          å€¤å¼•ãé‡‘é¡: discountAmount,
          å€¤å¼•ãå¾Œé‡‘é¡: totalAmountToPay,
          paymentMethod: selectedPaymentMethod,
          itemCount: itemCount,
          tax8Total: tax8Total,
          tax10Total: tax10Total,
          customerCount: 1,
          ordersCount: ordersToProcess.length,
          storeId: currentStoreId
        });
        
        // æ”¯æ‰•ã„æ–¹æ³•ã‚’æ—¥æœ¬èªã«å¤‰æ›
        let paymentMethodJP = 'ç¾é‡‘';
        if (selectedPaymentMethod === 'emoney') paymentMethodJP = 'é›»å­ãƒãƒãƒ¼';
        else if (selectedPaymentMethod === 'credit') paymentMethodJP = 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰';
        
        // Firestoreã®æ³¨æ–‡ã«paidAtã€completedAtã€deletedãƒ•ãƒ©ã‚°ã‚’è¨­å®šï¼ˆä¼šè¨ˆå®Œäº†ã§å‰Šé™¤ï¼‰
        for (const order of ordersToProcess) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          await window.updateDoc(orderRef, {
            paidAt: now,
            completedAt: now,
            deleted: true,  // ä¼šè¨ˆå®Œäº†ã§å‰Šé™¤
            deletedAt: now,
            paymentMethod: paymentMethodJP,
            discountAmount: discountAmount,  // å€¤å¼•ãé‡‘é¡ã‚’ä¿å­˜
            totalAmount: totalAmountToPay,  // å€¤å¼•ãå¾Œã®é‡‘é¡ã§totalAmountã‚’æ›´æ–°
            originalAmount: totalBeforeDiscount,  // å…ƒã®é‡‘é¡ã‚’ä¿å­˜
            notifiedPaid: true,
            tax8Total: tax8Total,
            tax10Total: tax10Total
          });
          console.log('âœ… æ³¨æ–‡ã‚’ä¼šè¨ˆæ¸ˆã¿ï¼†å‰Šé™¤:', order.id, 'é‡‘é¡:', totalAmountToPay);
        }
        
        // å£²ä¸Šã‚’POSã«åæ˜ 
        const dateStr = getBusinessDateStr();
        console.log('ğŸ“… å–¶æ¥­æ—¥:', dateStr);
        
        const dailySalesRef = window.doc(window.db, 'stores', currentStoreId, 'dailySales', dateStr);
        const dailySalesDoc = await window.getDoc(dailySalesRef);
        
        const currentData = dailySalesDoc.exists() ? dailySalesDoc.data() : {
          totalSales: 0,
          customerCount: 0,
          totalItems: 0,
          cashSales: 0,
          emoneSales: 0,
          creditSales: 0,
          tax8Total: 0,
          tax10Total: 0,
          totalDiscount: 0  // å€¤å¼•ãåˆè¨ˆ
        };
        
        console.log('ğŸ“Š ç¾åœ¨ã®dailySales:', currentData);
        
        const updateData = {
          totalSales: (currentData.totalSales || 0) + totalAmountToPay,
          customerCount: (currentData.customerCount || 0) + 1,
          totalItems: (currentData.totalItems || 0) + itemCount,
          cashSales: (currentData.cashSales || 0) + (selectedPaymentMethod === 'cash' ? totalAmountToPay : 0),
          emoneSales: (currentData.emoneSales || 0) + (selectedPaymentMethod === 'emoney' ? totalAmountToPay : 0),
          creditSales: (currentData.creditSales || 0) + (selectedPaymentMethod === 'credit' ? totalAmountToPay : 0),
          tax8Total: (currentData.tax8Total || 0) + tax8Total,
          tax10Total: (currentData.tax10Total || 0) + tax10Total,
          totalDiscount: (currentData.totalDiscount || 0) + discountAmount,  // å€¤å¼•ãåˆè¨ˆã«åŠ ç®—
          updatedAt: now
        };
        
        console.log('ğŸ“Š æ›´æ–°ã™ã‚‹dailySales:', updateData);
        
        await window.setDoc(dailySalesRef, updateData, { merge: true });
        
        console.log('âœ… å£²ä¸Šã‚’POSã«åæ˜ ã—ã¾ã—ãŸï¼ˆå€¤å¼•ã: Â¥' + discountAmount.toLocaleString() + 'ï¼‰');
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        let message = `ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\nå£²ä¸Š: Â¥${totalAmountToPay.toLocaleString()}`;
        if (discountAmount > 0) {
          message += `\nå€¤å¼•ã: Â¥${discountAmount.toLocaleString()}`;
        }
        message += `\nå®¢æ•°: +1\n\næ³¨æ–‡ã¯è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚`;
        
        await showCustomAlert({ 
          icon: 'âœ…', 
          title: 'ä¼šè¨ˆå®Œäº†', 
          message: message, 
          btnClass: 'modal-btn-success' 
        });
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closePaymentModal();
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’æ›´æ–°
        await loadTables();
      } catch (error) {
        console.error('âŒ ä¼šè¨ˆå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert({ 
          icon: 'âŒ', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'ä¼šè¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    // å–¶æ¥­æ—¥ã®æ—¥ä»˜æ–‡å­—åˆ—ã‚’å–å¾—ï¼ˆ3æ™‚åŸºæº–ï¼‰
    function getBusinessDateStr() {
      const now = new Date();
      let businessDate = new Date(now);
      
      // åˆå‰3æ™‚å‰ãªã‚‰å‰æ—¥ã¨ã™ã‚‹
      if (now.getHours() < 3) {
        businessDate.setDate(businessDate.getDate() - 1);
      }
      
      const year = businessDate.getFullYear();
      const month = String(businessDate.getMonth() + 1).padStart(2, '0');
      const day = String(businessDate.getDate()).padStart(2, '0');
      const dateStr = `${year}-${month}-${day}`;
      
      console.log('ğŸ“… å–¶æ¥­æ—¥è¨ˆç®—:', {
        ç¾åœ¨æ™‚åˆ»: now.toLocaleString('ja-JP'),
        æ™‚: now.getHours(),
        å–¶æ¥­æ—¥: dateStr
      });
      
      return dateStr;
    }
    
    // å®Œäº†å‡¦ç†ï¼ˆPOSã®completedAtã«åˆã‚ã›ã‚‹ï¼‰- ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§å®Œçµ
    window.completeOrdersForTable = async function() {
      try {
        playTapSound();
        const now = window.Timestamp.now();
        
        // window.ordersToCheckoutã‹ã‚‰å®Œäº†å¯¾è±¡ã®æ³¨æ–‡ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°currentOrdersï¼‰
        const ordersToComplete = window.ordersToCheckout || currentOrders;
        
        console.log('âœ… å®Œäº†å‡¦ç†é–‹å§‹:', {
          ordersCount: ordersToComplete.length,
          orderIds: ordersToComplete.map(o => o.id)
        });
        
        // ğŸ†• åœ¨åº«ã‚’æ¸›ã‚‰ã™å‡¦ç†
        for (const order of ordersToComplete) {
          // æ³¨æ–‡ã‚’å®Œäº†ã«ã™ã‚‹
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          await window.updateDoc(orderRef, { 
            completedAt: now
          });
          console.log('âœ… æ³¨æ–‡ã‚’å®Œäº†:', order.id);
          
          // ğŸ†• åœ¨åº«ã‚’æ¸›ã‚‰ã™
          if (order.items && Array.isArray(order.items)) {
            try {
              // åœ¨åº«è¨­å®šã‚’å–å¾—
              const inventoryRef = window.doc(window.db, 'stores', currentStoreId, 'inventory_settings', 'default');
              const inventoryDoc = await window.getDoc(inventoryRef);
              
              if (inventoryDoc.exists()) {
                const inventoryData = inventoryDoc.data().items || {};
                let hasChanges = false;
                
                // å„å•†å“ã®åœ¨åº«ã‚’æ¸›ã‚‰ã™
                for (const item of order.items) {
                  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å•†å“IDã‚’å–å¾—ï¼ˆåå‰ã§æ¤œç´¢ï¼‰
                  const menuSnapshot = await window.getDocs(window.collection(window.db, 'stores', currentStoreId, 'menus'));
                  let menuId = null;
                  
                  menuSnapshot.forEach(doc => {
                    const menuData = doc.data();
                    if (menuData.name === item.name) {
                      menuId = menuData.id || doc.id;
                    }
                  });
                  
                  if (menuId && inventoryData[menuId]) {
                    const currentStock = inventoryData[menuId].stock;
                    if (currentStock !== undefined && currentStock !== null) {
                      // åœ¨åº«ã‚’æ¸›ã‚‰ã™
                      const quantity = item.quantity || 1;
                      const newStock = Math.max(0, currentStock - quantity);
                      inventoryData[menuId].stock = newStock;
                      hasChanges = true;
                      
                      console.log(`ğŸ“¦ åœ¨åº«æ¸›ç®—: ${item.name} (${menuId}) ${currentStock} â†’ ${newStock} (-${quantity})`);
                    }
                  }
                }
                
                // å¤‰æ›´ãŒã‚ã‚Œã°ä¿å­˜
                if (hasChanges) {
                  await window.setDoc(inventoryRef, {
                    items: inventoryData,
                    updatedAt: new Date().toISOString()
                  });
                  console.log('âœ… åœ¨åº«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                }
              }
            } catch (inventoryError) {
              console.error('âš ï¸ åœ¨åº«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', inventoryError);
              // åœ¨åº«æ›´æ–°ã‚¨ãƒ©ãƒ¼ã¯è‡´å‘½çš„ã§ãªã„ãŸã‚ç¶šè¡Œ
            }
          }
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closePaymentModal();
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’æ›´æ–°ï¼ˆFirestoreã®å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤ï¼‰
        await new Promise(resolve => setTimeout(resolve, 500));
        
        await showCustomAlert({ 
          icon: 'âœ…', 
          title: 'å®Œäº†', 
          message: 'æ³¨æ–‡ã‚’å®Œäº†ã«ã—ã¾ã—ãŸã€‚', 
          btnClass: 'modal-btn-success' 
        });
      } catch (error) {
        console.error('âŒ å®Œäº†å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert({ 
          icon: 'âŒ', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'å®Œäº†å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç† - ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§å®Œçµ
    window.cancelOrdersForTable = async function() {
      try {
        playTapSound();
        const now = window.Timestamp.now();
        
        // window.ordersToCheckoutã‹ã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯¾è±¡ã®æ³¨æ–‡ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°currentOrdersï¼‰
        const ordersToCancel = window.ordersToCheckout || currentOrders;
        
        console.log('â¸ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†é–‹å§‹:', {
          ordersCount: ordersToCancel.length,
          orderIds: ordersToCancel.map(o => o.id)
        });
        
        for (const order of ordersToCancel) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          await window.updateDoc(orderRef, { 
            cancelledAt: now
          });
          console.log('âœ… æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«:', order.id);
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closePaymentModal();
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆFirestoreã®å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤ï¼‰
        await new Promise(resolve => setTimeout(resolve, 500));
        
        await showCustomAlert({ 
          icon: 'â¸ï¸', 
          title: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†', 
          message: 'æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚', 
          btnClass: 'modal-btn-success' 
        });
      } catch (error) {
        console.error('âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert({ 
          icon: 'âŒ', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };

    // å‰Šé™¤å‡¦ç† - ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§å®Œçµ
    window.deleteOrdersForTable = async function() {
      try {
        playTapSound();
        
        // window.ordersToCheckoutã‹ã‚‰å‰Šé™¤å¯¾è±¡ã®æ³¨æ–‡ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°currentOrdersï¼‰
        const ordersToDelete = window.ordersToCheckout || currentOrders;
        
        console.log('ğŸ—‘ï¸ å‰Šé™¤å‡¦ç†é–‹å§‹:', {
          ordersCount: ordersToDelete.length,
          orderIds: ordersToDelete.map(o => o.id)
        });
        
        for (const order of ordersToDelete) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          // Firestoreã‹ã‚‰å®Œå…¨ã«å‰Šé™¤ï¼ˆPOSã‹ã‚‰ã‚‚æ¶ˆãˆã‚‹ï¼‰
          await window.deleteDoc(orderRef);
          console.log('âœ… æ³¨æ–‡ã‚’å‰Šé™¤:', order.id);
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closePaymentModal();
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆFirestoreã®å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤ï¼‰
        await new Promise(resolve => setTimeout(resolve, 500));
        
        await showCustomAlert({ 
          icon: 'âœ…', 
          title: 'å‰Šé™¤å®Œäº†', 
          message: 'æ³¨æ–‡ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã—ãŸã€‚\nPOSã‹ã‚‰ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚', 
          btnClass: 'modal-btn-success' 
        });
      } catch (error) {
        console.error('âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert({ 
          icon: 'âŒ', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };

    window.addEventListener('DOMContentLoaded', async () => {
      while (!window.firebaseReady || !window.db) await new Promise(r => setTimeout(r, 100));
      await loadStoreList();
      if (sessionStorage.getItem('handyStoreId')) {
        currentStoreId = sessionStorage.getItem('handyStoreId');
        window.currentStoreId = currentStoreId; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦è¨­å®š
        currentStoreName = sessionStorage.getItem('handyStoreName');
        
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('ğŸ“ HANDY ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰åº—èˆ—IDå¾©å…ƒ');
        console.log('   currentStoreId:', currentStoreId);
        console.log('   window.currentStoreId:', window.currentStoreId);
        console.log('   currentStoreName:', currentStoreName);
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        
        showTablesScreen();
      }
    });
    
    // ========== ğŸ“¦ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åœ¨åº«ãƒ‘ãƒãƒ« ==========
    
    // åœ¨åº«ãƒ‘ãƒãƒ«ã‚’æ›´æ–°
    async function updateInventoryPanel() {
      try {
        console.log('ğŸ“¦ åœ¨åº«ãƒ‘ãƒãƒ«ã‚’æ›´æ–°ä¸­...');
        
        // inventory_settings ã‚’å–å¾—
        let inventorySettingsRef;
        if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
          inventorySettingsRef = window.doc(window.db, 'inventory_settings', 'default');
        } else {
          inventorySettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
        }
        
        const inventorySettingsSnap = await window.getDoc(inventorySettingsRef);
        
        if (!inventorySettingsSnap.exists()) {
          console.log('âš ï¸ åœ¨åº«è¨­å®šãŒå­˜åœ¨ã—ã¾ã›ã‚“');
          document.getElementById('inventoryPanelContent').innerHTML = '<div style="padding: 10px; text-align: center; color: #999;">åœ¨åº«è¨­å®šãªã—</div>';
          // ãƒãƒ¼ã®è‰²ã‚’é€šå¸¸ã«æˆ»ã™
          document.getElementById('inventoryPanelBar').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          return;
        }
        
        const inventorySettingsData = inventorySettingsSnap.data();
        const inventoryItems = inventorySettingsData.items || {};
        
        // menusã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å•†å“åã‚’å–å¾—
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        const idToNameMap = {};
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          const itemId = data.id || doc.id;
          if (data.name) {
            idToNameMap[itemId] = data.name;
          }
        });
        
        // åœ¨åº«ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å•†å“ã®ã¿è¡¨ç¤ºï¼ˆåœ¨åº«å°‘ãƒ»å“åˆ‡ã‚Œã‚’å„ªå…ˆï¼‰
        const lowStockItems = [];
        const outOfStockItems = [];
        const normalStockItems = [];
        
        for (const [itemId, settings] of Object.entries(inventoryItems)) {
          const stock = settings.stock;
          const alertThreshold = settings.alertThreshold;
          const itemName = idToNameMap[itemId] || itemId;
          
          // stockãŒnullã§ãªã„ï¼ˆåœ¨åº«ç®¡ç†å¯¾è±¡ï¼‰å ´åˆã®ã¿è¡¨ç¤º
          if (stock !== null && stock !== undefined) {
            const item = { id: itemId, name: itemName, stock, alertThreshold };
            
            if (stock === 0) {
              outOfStockItems.push(item);
            } else if (alertThreshold !== null && alertThreshold !== undefined && stock <= alertThreshold) {
              lowStockItems.push(item);
            } else {
              normalStockItems.push(item);
            }
          }
        }
        
        // ğŸ†• ãƒãƒ¼ã®è‰²ã‚’åœ¨åº«çŠ¶æ…‹ã«å¿œã˜ã¦å¤‰æ›´
        const panelBar = document.getElementById('inventoryPanelBar');
        if (outOfStockItems.length > 0) {
          // åœ¨åº«åˆ‡ã‚ŒãŒã‚ã‚‹å ´åˆã¯èµ¤
          panelBar.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
        } else if (lowStockItems.length > 0) {
          // åœ¨åº«å°‘ãŒã‚ã‚‹å ´åˆã¯é»„è‰²
          panelBar.style.background = 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
        } else {
          // å•é¡Œãªã—ã®å ´åˆã¯ç´«ï¼ˆé€šå¸¸ï¼‰
          panelBar.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        }
        
        // è¡¨ç¤ºç”¨HTMLç”Ÿæˆ
        let html = '';
        
        // å“åˆ‡ã‚Œï¼ˆèµ¤ï¼‰
        outOfStockItems.forEach(item => {
          html += `
            <div style="padding: 8px 12px; background: #ffebee; border-left: 4px solid #f44336; margin-bottom: 6px; border-radius: 4px;">
              <div style="font-weight: bold; color: #f44336; font-size: 14px;">${item.name}</div>
              <div style="color: #f44336; font-size: 13px; font-weight: bold;">å“åˆ‡</div>
            </div>
          `;
        });
        
        // åœ¨åº«å°‘ï¼ˆé»„ï¼‰
        lowStockItems.forEach(item => {
          html += `
            <div style="padding: 8px 12px; background: #fff9e6; border-left: 4px solid #ff9800; margin-bottom: 6px; border-radius: 4px;">
              <div style="font-weight: bold; color: #ff9800; font-size: 14px;">${item.name}</div>
              <div style="color: #ff9800; font-size: 13px;">æ®‹ ${item.stock}</div>
            </div>
          `;
        });
        
        if (html === '') {
          html = '<div style="padding: 10px; text-align: center; color: #4caf50; font-weight: bold;">åœ¨åº«å……åˆ†âœ“</div>';
        }
        
        document.getElementById('inventoryPanelContent').innerHTML = html;
        console.log('âœ… åœ¨åº«ãƒ‘ãƒãƒ«æ›´æ–°å®Œäº†');
        
      } catch (error) {
        console.error('âŒ åœ¨åº«ãƒ‘ãƒãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // åœ¨åº«ãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    function toggleInventoryPanel() {
      const panel = document.getElementById('inventoryPanel');
      const arrow = document.getElementById('inventoryPanelArrow');
      const isCollapsed = panel.classList.contains('collapsed');
      
      if (isCollapsed) {
        panel.classList.remove('collapsed');
        panel.style.maxHeight = '400px';
        arrow.textContent = 'â–¼';
      } else {
        panel.classList.add('collapsed');
        panel.style.maxHeight = '45px';
        arrow.textContent = 'â–²';
      }
    }
    
    // inventory_settingsã®å¤‰æ›´ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
    function watchInventoryChanges() {
      let inventorySettingsRef;
      if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
        inventorySettingsRef = window.doc(window.db, 'inventory_settings', 'default');
      } else {
        inventorySettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
      }
      
      const unsubscribe = window.onSnapshot(inventorySettingsRef, (doc) => {
        if (doc.exists()) {
          console.log('ğŸ“¦ åœ¨åº«ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ');
          updateInventoryPanel();
        }
      });
      
      return unsubscribe;
    }
    
    // ========== ğŸ†• POSãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ ==========
    
    // ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’localStorageã«ä¿å­˜
    window.saveLoginInfo = function(storeId, password) {
      localStorage.setItem('handy_storeId', storeId);
      localStorage.setItem('handy_password', password);
    };
    
    // ä¿å­˜ã•ã‚ŒãŸãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å–å¾—
    window.getSavedLoginInfo = function() {
      return {
        storeId: localStorage.getItem('handy_storeId'),
        password: localStorage.getItem('handy_password')
      };
    };
    
    // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãƒˆã‚°ãƒ«
    function toggleFunctionsMenu() {
      const menu = document.getElementById('functionsSubMenu');
      if (menu.style.display === 'none' || menu.style.display === '') {
        menu.style.display = 'block';
      } else {
        menu.style.display = 'none';
      }
    }
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
    document.addEventListener('click', function(e) {
      const menu = document.getElementById('functionsSubMenu');
      const btn = e.target.closest('.sales-btn');
      if (menu && menu.style.display === 'block' && !menu.contains(e.target) && !btn) {
        menu.style.display = 'none';
      }
    });
    
    // POSãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openPOSModal = function(modalType) {
      const modal = document.getElementById('posIframeModal');
      const iframe = document.getElementById('posIframe');
      const title = document.getElementById('posModalTitle');
      
      // ã‚¿ã‚¤ãƒˆãƒ«ã‚’è¨­å®š
      const titles = {
        'sales': 'å£²ä¸Š',
        'expense': 'æ”¯å‡º',
        'monthly': 'æœˆæ¬¡',
        'history': 'å±¥æ­´',
        'printer': 'ãƒ—ãƒªãƒ³ã‚¿è¨­å®š'
      };
      title.textContent = titles[modalType] || 'POSæ©Ÿèƒ½';
      
      // ä¿å­˜ã•ã‚ŒãŸãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’å–å¾—
      const loginInfo = window.getSavedLoginInfo();
      
      // URLã‚’æ§‹ç¯‰
      let url = 'https://gymnastmasaki-lang.github.io/takoyaki-/pos.html';
      const params = new URLSearchParams();
      
      params.append('modal', modalType);
      
      // ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã‚’ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¿½åŠ 
      if (loginInfo.storeId && loginInfo.password) {
        params.append('storeId', loginInfo.storeId);
        params.append('password', loginInfo.password);
        params.append('autoLogin', 'true');
      }
      
      if (params.toString()) {
        url += '?' + params.toString();
      }
      
      iframe.src = url;
      modal.classList.add('active');
      
      // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
    };
    
    // ãƒ‰ãƒ­ã‚¢é–‹ã‚’ç›´æ¥å®Ÿè¡Œ
    window.openDrawerDirect = async function() {
      try {
        const now = new Date();
        const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          const currentCount = data.drawerOpenCount || 0;
          await window.updateDoc(salesRef, {
            drawerOpenCount: currentCount + 1,
            updatedAt: window.Timestamp.now()
          });
        } else {
          await window.setDoc(salesRef, {
            date: dateStr,
            totalSales: 0,
            customerCount: 0,
            drawerOpenCount: 1,
            createdAt: window.Timestamp.now(),
            updatedAt: window.Timestamp.now()
          });
        }
        
        await showCustomAlert({ 
          icon: '', 
          title: 'å®Œäº†', 
          message: 'ãƒ‰ãƒ­ã‚¢ã‚’é–‹ãã¾ã—ãŸ', 
          btnClass: 'modal-btn-success' 
        });
        
        // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
        const menu = document.getElementById('functionsSubMenu');
        if (menu) {
          menu.style.display = 'none';
        }
      } catch (e) {
        console.error('ãƒ‰ãƒ­ã‚¢é–‹ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({ 
          icon: '', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    // ğŸ†• å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ç›´æ¥è¡¨ç¤º
    
    // ğŸ†• å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeSalesModal = function() {
      document.getElementById('salesModal').style.display = 'none';
    };
    
    // POSãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closePOSModal = function() {
      const modal = document.getElementById('posIframeModal');
      const iframe = document.getElementById('posIframe');
      
      modal.classList.remove('active');
      // iframeã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒ¡ãƒ¢ãƒªè§£æ”¾ï¼‰
      setTimeout(() => {
        iframe.src = 'about:blank';
      }, 300);
    };
    
    // ========== ğŸ’° å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ ==========
    
    // å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showSalesModal = function() {
      document.getElementById('salesModal').style.display = 'flex';
      calculateSales();
      
      // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
    };
    
    // å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeSalesModal = function() {
      document.getElementById('salesModal').style.display = 'none';
    };
    
    // å£²ä¸Šã‚’è¨ˆç®—ï¼ˆæ‹¡å¼µç‰ˆ - æ”¯æ‰•æ–¹æ³•åˆ¥ã€ç›®æ¨™é”æˆç‡ã€ç´”åˆ©ç›Šï¼‰
    window.calculateSales = async function() {
      const container = document.getElementById('salesContent');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">é›†è¨ˆä¸­...</div>';
      
      try {
        // æœ¬æ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆ3æ™‚åŸºæº–ï¼‰
        const now = new Date();
        let today = new Date(now);
        if (now.getHours() < 3) {
          today.setDate(today.getDate() - 1);
        }
        const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
        
        console.log('ğŸ“Š å£²ä¸Šå–å¾—æ—¥ä»˜:', dateStr);
        
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        let totalSales = 0;
        let cashSales = 0;
        let emoneSales = 0;
        let creditSales = 0;
        let orderCount = 0;
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          console.log('ğŸ’° å£²ä¸Šãƒ‡ãƒ¼ã‚¿:', data);
          totalSales = data.totalSales || 0;
          cashSales = data.cashSales || 0;
          emoneSales = data.emoneSales || 0;
          creditSales = data.creditSales || 0;
          orderCount = data.customerCount || 0;
        } else {
          console.log('âš ï¸ å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
        }
        
        // äººä»¶è²»ã‚’å–å¾—
        let todayLaborCost = 0;
        try {
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.date === dateStr) {
              if (data.totalWage && data.totalWage > 0) {
                todayLaborCost += data.totalWage;
              } else if (data.clockIn && data.clockOut) {
                const clockIn = new Date(`${dateStr} ${data.clockIn}`);
                const clockOut = new Date(`${dateStr} ${data.clockOut}`);
                let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                
                if (data.breakStart1 && data.breakEnd1) {
                  const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                  const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                  workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                }
                if (data.breakStart2 && data.breakEnd2) {
                  const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                  const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                  workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                }
                
                const hourlyRate = data.hourlyRate || 1150;
                todayLaborCost += workHours * hourlyRate;
              }
            }
          });
        } catch (e) {
          console.error('äººä»¶è²»å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        }
        
        // æ”¯å‡ºã‚’å–å¾—
        let todayExpense = 0;
        try {
          const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
          if (expenseDoc.exists()) {
            todayExpense = expenseDoc.data().total || 0;
          }
        } catch (e) {
          console.error('æ”¯å‡ºå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        }
        
        // ç´”åˆ©ç›Šè¨ˆç®—
        const grossProfit = totalSales - todayLaborCost;
        const netProfit = totalSales - todayLaborCost - todayExpense;
        const netProfitRate = totalSales > 0 ? (netProfit / totalSales * 100).toFixed(1) : 0;
        const laborCostRate = totalSales > 0 ? (todayLaborCost / totalSales * 100).toFixed(1) : 0;
        const expenseRate = totalSales > 0 ? (todayExpense / totalSales * 100).toFixed(1) : 0;
        
        // å£²ä¸Šç›®æ¨™é”æˆç‡
        const dayOfWeek = today.getDay();
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
        const targetSales = isWeekend ? 70000 : 50000;
        const achievementRate = Math.round((totalSales / targetSales) * 100);
        const rateColor = achievementRate >= 100 ? '#4CAF50' : achievementRate >= 80 ? '#FF9800' : '#f44336';
        const netProfitColor = netProfit >= 0 ? '#4CAF50' : '#f44336';
        
        container.innerHTML = `
          <div style="background: white; border-radius: 12px; padding: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
              <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;">ç·å£²ä¸Š</div>
                <div style="font-size: 28px; font-weight: bold;">Â¥${totalSales.toLocaleString()}</div>
              </div>
              <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;">å®¢æ•°</div>
                <div style="font-size: 28px; font-weight: bold;">${orderCount}ä»¶</div>
              </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
              <h4 style="margin: 0 0 10px 0;">å£²ä¸Šç›®æ¨™</h4>
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>ç›®æ¨™é‡‘é¡ï¼ˆ${isWeekend ? 'åœŸæ—¥ç¥' : 'å¹³æ—¥'}ï¼‰</span>
                <strong>Â¥${targetSales.toLocaleString()}</strong>
              </div>
              <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 32px; font-weight: bold; color: ${rateColor};">${achievementRate}%</div>
                <div style="font-size: 14px; opacity: 0.9;">é”æˆç‡</div>
              </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #FF6B6B 0%, #C92A2A 100%); border-radius: 10px; color: white;">
              <h4 style="margin: 0 0 15px 0;">æœ¬æ—¥ã®ç´”åˆ©ç›Š</h4>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                <span>å£²ä¸Š</span>
                <strong>Â¥${totalSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                <span>âˆ’ äººä»¶è²»${totalSales > 0 ? 'ï¼ˆ' + laborCostRate + '%ï¼‰' : ''}</span>
                <strong>Â¥${Math.round(todayLaborCost).toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px;">
                <span>âˆ’ æ”¯å‡º${totalSales > 0 ? 'ï¼ˆ' + expenseRate + '%ï¼‰' : ''}</span>
                <strong>Â¥${Math.round(todayExpense).toLocaleString()}</strong>
              </div>
              <div style="border-top: 2px solid rgba(255,255,255,0.3); padding-top: 12px;">
                <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                  <div style="font-size: 16px; opacity: 0.9; margin-bottom: 5px;">ç´”åˆ©ç›Š</div>
                  <div style="font-size: 32px; font-weight: bold; color: ${netProfitColor};">Â¥${Math.round(netProfit).toLocaleString()}</div>
                  <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">ç´”åˆ©ç›Šç‡: ${netProfitRate}%</div>
                </div>
              </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
              <h4 style="margin: 0 0 15px 0;">æ”¯æ‰•ã„æ–¹æ³•åˆ¥</h4>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>ç¾é‡‘</span>
                <strong>Â¥${cashSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>ã‚«ãƒ¼ãƒ‰</span>
                <strong>Â¥${creditSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span>é›»å­ãƒãƒãƒ¼</span>
                <strong>Â¥${emoneSales.toLocaleString()}</strong>
              </div>
            </div>
          </div>
        `;
        
      } catch (e) {
        console.error('å£²ä¸Šè¨ˆç®—ã‚¨ãƒ©ãƒ¼:', e);
        container.innerHTML = '<div style="text-align: center; color: red; padding: 20px;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    };
    
    // ========== ğŸ’° ç²¾ç®—æ©Ÿèƒ½ ==========
    
    window.showSettlementModal = async function() {
      // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('settlementModal').style.display = 'flex';
      
      // æœ¬æ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
      const now = new Date();
      let today = new Date(now);
      if (now.getHours() < 3) {
        today.setDate(today.getDate() - 1);
      }
      const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      document.getElementById('settlementDate').value = dateStr;
      
      // å£²ä¸Šã‚µãƒãƒªãƒ¼ã‚’è¡¨ç¤º
      await loadSettlementSummary(dateStr);
    };
    
    window.closeSettlementModal = function() {
      document.getElementById('settlementModal').style.display = 'none';
    };
    
    async function loadSettlementSummary(dateStr) {
      const container = document.getElementById('settlementSummary');
      container.innerHTML = '<div style="text-align: center;">èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      try {
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          const totalSales = data.totalSales || 0;
          const cashSales = data.cashSales || 0;
          const emoneSales = data.emoneSales || 0;
          const creditSales = data.creditSales || 0;
          const customerCount = data.customerCount || 0;
          
          container.innerHTML = `
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <h4 style="margin: 0 0 10px 0;">ç²¾ç®—ã‚µãƒãƒªãƒ¼</h4>
              <div style="display: grid; gap: 8px;">
                <div style="display: flex; justify-content: space-between;">
                  <span>ç·å£²ä¸Š:</span>
                  <strong>Â¥${totalSales.toLocaleString()}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span>å®¢æ•°:</span>
                  <strong>${customerCount}ä»¶</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span>ç¾é‡‘:</span>
                  <strong>Â¥${cashSales.toLocaleString()}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span>ã‚«ãƒ¼ãƒ‰:</span>
                  <strong>Â¥${creditSales.toLocaleString()}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span>é›»å­ãƒãƒãƒ¼:</span>
                  <strong>Â¥${emoneSales.toLocaleString()}</strong>
                </div>
              </div>
            </div>
          `;
        } else {
          container.innerHTML = '<div style="text-align: center; color: #999;">ã“ã®æ—¥ä»˜ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        }
      } catch (e) {
        console.error('ç²¾ç®—ã‚µãƒãƒªãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        container.innerHTML = '<div style="text-align: center; color: red;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    }
    
    window.confirmSettlement = async function() {
      const dateStr = document.getElementById('settlementDate').value;
      if (!dateStr) {
        await showCustomAlert({ icon: '', title: 'ã‚¨ãƒ©ãƒ¼', message: 'æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„', btnClass: 'modal-btn-danger' });
        return;
      }
      
      const confirmed = confirm(`${dateStr}ã®ç²¾ç®—ã‚’å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚`);
      if (!confirmed) return;
      
      try {
        await showCustomAlert({ 
          icon: '', 
          title: 'æº–å‚™ä¸­', 
          message: 'ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã®ç”Ÿæˆæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™ã€‚\nä»£ã‚ã‚Šã«æ—¥è¨ˆè¡¨å‡ºåŠ›ã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚', 
          btnClass: 'modal-btn-primary' 
        });
        closeSettlementModal();
      } catch (e) {
        console.error('ç²¾ç®—ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({ 
          icon: '', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'ç²¾ç®—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    window.generateDailyReport = async function() {
      try {
        await showCustomAlert({ 
          icon: '', 
          title: 'æº–å‚™ä¸­', 
          message: 'æ—¥è¨ˆè¡¨å‡ºåŠ›æ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™ã€‚\n\nç¾åœ¨ã€æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã§æœŸé–“ã‚’æŒ‡å®šã—ã¦å‡ºåŠ›ã§ãã¾ã™ã€‚', 
          btnClass: 'modal-btn-primary' 
        });
      } catch (e) {
        console.error('æ—¥è¨ˆè¡¨å‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({ 
          icon: '', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'æ—¥è¨ˆè¡¨å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ', 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    // ========== ğŸ“‹ å±¥æ­´æ©Ÿèƒ½ ==========
    
    let historyOrders = [];
    let currentEditingOrder = null;
    
    window.showHistoryModal = async function() {
      // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('historyModal').style.display = 'flex';
      await loadHistory();
    };
    
    window.closeHistoryModal = function() {
      document.getElementById('historyModal').style.display = 'none';
    };
    
    async function loadHistory() {
      try {
        const q = window.query(
          window.getStoreCollection('orders'),
          window.orderBy('timestamp', 'desc'),
          window.limit(100)
        );
        const ordersSnapshot = await window.getDocs(q);
        historyOrders = [];
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          historyOrders.push({
            id: doc.id,
            orderNumber: data.orderNumber || 0,
            timestamp: data.timestamp,
            tableNumber: data.tableNumber || '',
            items: data.items || [],
            totalAmount: data.totalAmount || 0,
            paymentMethod: data.paymentMethod || 'cash',
            paidAt: data.paidAt || null,
            completedAt: data.completedAt || null
          });
        });
        
        filterHistory();
      } catch (e) {
        console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({ 
          icon: '', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 
          btnClass: 'modal-btn-danger' 
        });
      }
    }
    
    window.filterHistory = function() {
      const dateFilter = document.getElementById('historyDateFilter').value;
      const statusFilter = document.getElementById('historyStatusFilter').value;
      const now = new Date();
      
      let filtered = historyOrders.filter(order => {
        const orderDate = order.timestamp.toDate();
        
        let dateMatch = true;
        if (dateFilter === 'today') {
          const todayStart = new Date(now);
          todayStart.setHours(3, 0, 0, 0);
          if (now.getHours() < 3) {
            todayStart.setDate(todayStart.getDate() - 1);
          }
          const todayEnd = new Date(todayStart);
          todayEnd.setDate(todayEnd.getDate() + 1);
          dateMatch = orderDate >= todayStart && orderDate < todayEnd;
        } else if (dateFilter === 'yesterday') {
          const yesterdayStart = new Date(now);
          yesterdayStart.setHours(3, 0, 0, 0);
          if (now.getHours() < 3) {
            yesterdayStart.setDate(yesterdayStart.getDate() - 1);
          }
          yesterdayStart.setDate(yesterdayStart.getDate() - 1);
          const yesterdayEnd = new Date(yesterdayStart);
          yesterdayEnd.setDate(yesterdayEnd.getDate() + 1);
          dateMatch = orderDate >= yesterdayStart && orderDate < yesterdayEnd;
        } else if (dateFilter === 'week') {
          const weekAgo = new Date(now);
          weekAgo.setDate(weekAgo.getDate() - 7);
          dateMatch = orderDate >= weekAgo;
        } else if (dateFilter === 'month') {
          const monthStart = new Date(now);
          monthStart.setDate(1);
          monthStart.setHours(0, 0, 0, 0);
          dateMatch = orderDate >= monthStart;
        }
        
        let statusMatch = true;
        if (statusFilter === 'paid') {
          statusMatch = order.paidAt !== null;
        } else if (statusFilter === 'completed') {
          statusMatch = order.completedAt !== null;
        }
        
        return dateMatch && statusMatch;
      });
      
      displayHistory(filtered);
    };
    
    function displayHistory(orders) {
      const container = document.getElementById('historyList');
      
      if (orders.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">è©²å½“ã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = '';
      
      orders.forEach(order => {
        const card = document.createElement('div');
        card.style.cssText = `
          background: white;
          border-radius: 12px;
          padding: 15px;
          margin-bottom: 15px;
          border: 2px solid #ddd;
        `;
        
        const orderDate = order.timestamp.toDate();
        const dateStr = orderDate.toLocaleString('ja-JP');
        
        const paymentMethodNames = {
          'cash': 'ç¾é‡‘',
          'emoney': 'é›»å­ãƒãƒãƒ¼',
          'credit': 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰'
        };
        const paymentMethodLabel = paymentMethodNames[order.paymentMethod] || 'ç¾é‡‘';
        
        let itemsHtml = '';
        order.items.forEach(item => {
          itemsHtml += `<div style="padding: 5px 0; border-bottom: 1px solid #eee;">
            ${item.name} Ã—${item.quantity} - Â¥${((item.price + (item.toppingPrice || 0)) * item.quantity).toLocaleString()}
          </div>`;
        });
        
        // ãƒœã‚¿ãƒ³ä½œæˆ
        let buttonsHtml = '';
        if (order.paidAt) {
          // ä¼šè¨ˆæ¸ˆã¿ï¼šèµ¤ä¼ç¥¨ã€ãƒ¬ã‚·ãƒ¼ãƒˆå†å°åˆ·ã€é ˜åæ›¸å†å°åˆ·
          buttonsHtml = `
            <div style="display: flex; gap: 8px; margin-top: 12px; flex-wrap: wrap;">
              <button onclick="redSlipFromHistory('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">èµ¤ä¼ç¥¨</button>
              <button onclick="reprintReceipt('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">ãƒ¬ã‚·ãƒ¼ãƒˆå†å°åˆ·</button>
              <button onclick="reprintInvoice('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">é ˜åæ›¸å†å°åˆ·</button>
            </div>
          `;
        } else {
          // æœªä¼šè¨ˆï¼šç·¨é›†ãƒœã‚¿ãƒ³ã®ã¿
          buttonsHtml = `
            <div style="display: flex; gap: 8px; margin-top: 12px;">
              <button onclick="editOrderFromHistory('${order.id}')" style="flex: 1; padding: 8px 12px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;">ç·¨é›†</button>
            </div>
          `;
        }
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <div>
              <strong style="font-size: 18px; color: #667eea;">#${order.orderNumber}</strong>
              <span style="margin-left: 10px; color: #666;">${order.tableNumber}</span>
            </div>
            <div>
              ${order.paidAt ? '<span style="background: #2196F3; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px;">ä¼šè¨ˆæ¸ˆ</span>' : ''}
              ${order.completedAt ? '<span style="background: #4CAF50; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-left: 5px;">å®Œäº†</span>' : ''}
            </div>
          </div>
          <div style="font-size: 12px; color: #999; margin-bottom: 10px;">${dateStr}</div>
          <div style="margin-bottom: 10px;">${itemsHtml}</div>
          <div style="display: flex; justify-content: space-between; padding-top: 10px; border-top: 2px solid #eee;">
            <span>æ”¯æ‰•æ–¹æ³•: ${paymentMethodLabel}</span>
            <strong style="font-size: 18px; color: #667eea;">Â¥${order.totalAmount.toLocaleString()}</strong>
          </div>
          ${buttonsHtml}
        `;
        
        container.appendChild(card);
      });
    }
    
    window.refreshHistory = async function() {
      await loadHistory();
    };
    
    // ========== æ³¨æ–‡ç·¨é›†æ©Ÿèƒ½ ==========
    
    let currentEditingOrder = null;
    
    window.editOrderFromHistory = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        if (!orderDoc.exists()) {
          await showCustomAlert({ 
            icon: '', 
            title: 'ã‚¨ãƒ©ãƒ¼', 
            message: 'æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 
            btnClass: 'modal-btn-danger' 
          });
          return;
        }
        
        const orderData = orderDoc.data();
        
        currentEditingOrder = {
          id: orderId,
          ...orderData,
          originalTotalAmount: orderData.totalAmount,
          originalPaymentMethod: orderData.paymentMethod
        };
        
        // æ”¯æ‰•æ–¹æ³•ã®é¸æŠè‚¢
        const paymentMethods = {
          'cash': 'ç¾é‡‘',
          'emoney': 'é›»å­ãƒãƒãƒ¼',
          'credit': 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰'
        };
        
        let paymentMethodOptions = '';
        Object.keys(paymentMethods).forEach(method => {
          const selected = orderData.paymentMethod === method ? 'selected' : '';
          paymentMethodOptions += `<option value="${method}" ${selected}>${paymentMethods[method]}</option>`;
        });
        
        // å•†å“ãƒªã‚¹ãƒˆ
        let itemsHtml = '';
        if (orderData.items && orderData.items.length > 0) {
          orderData.items.forEach((item, index) => {
            let toppingsHtml = '';
            if (item.toppingDetails && item.toppingDetails.length > 0) {
              const groupedBySet = {};
              item.toppingDetails.forEach(detail => {
                if (!groupedBySet[detail.setName]) {
                  groupedBySet[detail.setName] = [];
                }
                groupedBySet[detail.setName].push(detail.optionName);
              });
              
              toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
                return `
                  <div style="font-size: 12px; color: #666; font-weight: bold; margin-top: 5px;">${setName}</div>
                  ${options.map(opt => `<div style="font-size: 12px; color: #666; margin-left: 10px;">ãƒ»${opt}</div>`).join('')}
                `;
              }).join('');
            } else if (item.toppings && item.toppings !== 'ãªã—') {
              toppingsHtml = `<div style="font-size: 12px; color: #666;">ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${item.toppings}</div>`;
            }
            
            itemsHtml += `
              <div style="padding: 10px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong>${item.name}</strong>
                    ${toppingsHtml}
                  </div>
                  <button onclick="removeItemFromOrder(${index})" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
                </div>
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                  <label>æ•°é‡:</label>
                  <input type="number" value="${item.quantity}" onchange="updateItemQuantity(${index}, this.value)" min="1" style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                  <span style="margin-left: auto; font-weight: bold;">Â¥${((item.price + (item.toppingPrice || 0)) * item.quantity).toLocaleString()}</span>
                </div>
              </div>
            `;
          });
        }
        
        const content = document.getElementById('editOrderContent');
        content.innerHTML = `
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ³¨æ–‡ç•ªå·</label>
            <div style="font-size: 24px; color: #667eea;">#${orderData.orderNumber || 0}</div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·</label>
            <input type="text" id="editTableNumber" value="${orderData.tableNumber || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ”¯æ‰•æ–¹æ³•</label>
            <select id="editPaymentMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
              ${paymentMethodOptions}
            </select>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">æ³¨æ–‡å•†å“</label>
            ${itemsHtml || '<div style="text-align: center; padding: 20px; color: #999;">å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>'}
          </div>
          
          <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; text-align: right;">
            <span style="font-size: 18px; font-weight: bold;">åˆè¨ˆ: </span>
            <span id="editTotalAmount" style="font-size: 24px; font-weight: bold; color: #1976d2;">Â¥${(orderData.totalAmount || 0).toLocaleString()}</span>
          </div>
        `;
        
        // ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«ç”Ÿæˆ
        const buttonsContainer = document.getElementById('editOrderButtons');
        if (orderData.paidAt) {
          buttonsContainer.innerHTML = `
            <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveOrderEdit()">ä¿å­˜</button>
            <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="redSlipFromEdit()">èµ¤ä¼ç¥¨</button>
            <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditOrderModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          `;
        } else {
          if (orderData.deleted) {
            buttonsContainer.innerHTML = `
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveOrderEdit()">ä¿å­˜</button>
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white;" onclick="restoreOrder()">æ³¨æ–‡ã‚’å¾©å…ƒ</button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditOrderModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            `;
          } else {
            buttonsContainer.innerHTML = `
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveOrderEdit()">ä¿å­˜</button>
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="deleteOrderFromEdit()">æ³¨æ–‡å–æ¶ˆ</button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditOrderModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            `;
          }
        }
        
        document.getElementById('editOrderModal').style.display = 'flex';
        
      } catch (e) {
        console.error('æ³¨æ–‡ç·¨é›†ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({ 
          icon: '', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'æ³¨æ–‡ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    window.closeEditOrderModal = function() {
      document.getElementById('editOrderModal').style.display = 'none';
      currentEditingOrder = null;
    };
    
    window.updateItemQuantity = function(index, newQuantity) {
      const qty = parseInt(newQuantity);
      if (qty < 1) return;
      
      currentEditingOrder.items[index].quantity = qty;
      
      // åˆè¨ˆé‡‘é¡ã‚’å†è¨ˆç®—
      let total = 0;
      currentEditingOrder.items.forEach(item => {
        total += (item.price + (item.toppingPrice || 0)) * item.quantity;
      });
      currentEditingOrder.totalAmount = total;
      
      document.getElementById('editTotalAmount').textContent = `Â¥${total.toLocaleString()}`;
    };
    
    window.removeItemFromOrder = function(index) {
      currentEditingOrder.items.splice(index, 1);
      
      // åˆè¨ˆé‡‘é¡ã‚’å†è¨ˆç®—
      let total = 0;
      currentEditingOrder.items.forEach(item => {
        total += (item.price + (item.toppingPrice || 0)) * item.quantity;
      });
      currentEditingOrder.totalAmount = total;
      
      // å†è¡¨ç¤º
      editOrderFromHistory(currentEditingOrder.id);
    };
    
    window.saveOrderEdit = async function() {
      if (!currentEditingOrder) return;
      
      try {
        const tableNumber = document.getElementById('editTableNumber').value;
        const paymentMethod = document.getElementById('editPaymentMethod').value;
        
        const orderUpdates = {
          tableNumber: tableNumber,
          paymentMethod: paymentMethod,
          items: currentEditingOrder.items,
          totalAmount: currentEditingOrder.totalAmount
        };
        
        await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), orderUpdates);
        
        await showCustomAlert({ 
          icon: '', 
          title: 'å®Œäº†', 
          message: 'æ³¨æ–‡ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 
          btnClass: 'modal-btn-success' 
        });
        
        closeEditOrderModal();
        await loadHistory();
        
      } catch (e) {
        console.error('æ³¨æ–‡æ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({ 
          icon: '', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'æ³¨æ–‡ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ', 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    window.deleteOrderFromEdit = async function() {
      if (!currentEditingOrder) return;
      
      const confirmed = await showCustomConfirm({
        icon: '',
        title: 'æ³¨æ–‡å–æ¶ˆ',
        message: `æ³¨æ–‡ #${currentEditingOrder.orderNumber} ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ\n\nâ€» å‰Šé™¤ã—ã¦ã‚‚å¾©å…ƒã§ãã¾ã™`,
        btnText: 'å–æ¶ˆ',
        btnClass: 'modal-btn-danger'
      });
      
      if (!confirmed) return;
      
      try {
        await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), {
          deleted: true,
          deletedAt: window.Timestamp.now()
        });
        
        await showCustomAlert({ 
          icon: '', 
          title: 'å®Œäº†', 
          message: 'æ³¨æ–‡ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ', 
          btnClass: 'modal-btn-success' 
        });
        
        closeEditOrderModal();
        await loadHistory();
        
      } catch (e) {
        console.error('æ³¨æ–‡å–æ¶ˆã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({ 
          icon: '', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'æ³¨æ–‡ã®å–æ¶ˆã«å¤±æ•—ã—ã¾ã—ãŸ', 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    window.restoreOrder = async function() {
      if (!currentEditingOrder) return;
      
      try {
        await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), {
          deleted: false,
          deletedAt: null
        });
        
        await showCustomAlert({ 
          icon: '', 
          title: 'å®Œäº†', 
          message: 'æ³¨æ–‡ã‚’å¾©å…ƒã—ã¾ã—ãŸ', 
          btnClass: 'modal-btn-success' 
        });
        
        closeEditOrderModal();
        await loadHistory();
        
      } catch (e) {
        console.error('æ³¨æ–‡å¾©å…ƒã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({ 
          icon: '', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'æ³¨æ–‡ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ', 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    window.redSlipFromEdit = async function() {
      if (!currentEditingOrder) return;
      
      const orderData = currentEditingOrder;
      
      if (!orderData.paidAt) {
        await showCustomAlert({ 
          icon: '', 
          title: 'è­¦å‘Š', 
          message: 'ä¼šè¨ˆæ¸ˆã¿ã®æ³¨æ–‡ã®ã¿èµ¤ä¼ç¥¨ã§ãã¾ã™', 
          btnClass: 'modal-btn-danger' 
        });
        return;
      }
      
      const confirmed = await showCustomConfirm({
        icon: '',
        title: 'èµ¤ä¼ç¥¨ï¼ˆå®Œå…¨å–æ¶ˆï¼‰',
        message: `æ³¨æ–‡ #${orderData.orderNumber} ã‚’èµ¤ä¼ç¥¨ã§å®Œå…¨å–æ¶ˆã—ã¾ã™ã‹ï¼Ÿ\n\né‡‘é¡: Â¥${orderData.totalAmount.toLocaleString()}\n\né‡è¦ãªæ³¨æ„äº‹é …:\nâ€¢ å£²ä¸Šã‹ã‚‰å®Œå…¨ã«é™¤å¤–ã•ã‚Œã¾ã™\nâ€¢ å®¢æ•°ã‚‚æ¸›å°‘ã—ã¾ã™\nâ€¢ å¾©å…ƒã§ãã¾ã›ã‚“\nâ€¢ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“`,
        btnText: 'èµ¤ä¼ç¥¨ã§å–æ¶ˆ',
        btnClass: 'modal-btn-danger'
      });
      
      if (!confirmed) return;
      
      try {
        // ä¼šè¨ˆæ—¥æ™‚ã‹ã‚‰å–¶æ¥­æ—¥ã‚’è¨ˆç®—
        const paidDate = orderData.paidAt.toDate();
        let businessDate = new Date(paidDate);
        
        if (paidDate.getHours() < 3) {
          businessDate.setDate(businessDate.getDate() - 1);
        }
        
        const dateStr = `${businessDate.getFullYear()}-${String(businessDate.getMonth() + 1).padStart(2, '0')}-${String(businessDate.getDate()).padStart(2, '0')}`;
        
        // dailySalesã‚’å–å¾—
        const dailySalesRef = window.getStoreDoc('dailySales', dateStr);
        const dailySalesDoc = await window.getDoc(dailySalesRef);
        
        if (!dailySalesDoc.exists()) {
          await showCustomAlert({ 
            icon: '', 
            title: 'è­¦å‘Š', 
            message: `ã“ã®å–¶æ¥­æ—¥ã®dailySalesãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\nå–¶æ¥­æ—¥: ${dateStr}`, 
            btnClass: 'modal-btn-danger' 
          });
          return;
        }
        
        const dailyData = dailySalesDoc.data();
        const totalAmount = orderData.totalAmount || 0;
        
        // ç¨ç‡è¨ˆç®—
        let tax8Total = 0;
        let tax10Total = 0;
        
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
            let itemTaxRate = item.taxRate || (item.takeout ? 8 : 10);
            
            if (itemTaxRate === 8) {
              tax8Total += itemTotal;
            } else {
              tax10Total += itemTotal;
            }
          });
        }
        
        // æ”¯æ‰•ã„æ–¹æ³•åˆ¥ã®é‡‘é¡
        let cashSales = 0, emoneSales = 0, creditSales = 0;
        const paymentMethod = orderData.paymentMethod || '';
        if (paymentMethod === 'ç¾é‡‘' || paymentMethod === 'cash') cashSales = totalAmount;
        else if (paymentMethod === 'é›»å­ãƒãƒãƒ¼' || paymentMethod === 'emoney') emoneSales = totalAmount;
        else if (paymentMethod === 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰' || paymentMethod === 'credit') creditSales = totalAmount;
        
        // å•†å“æ•°ã‚’è¨ˆç®—
        let totalItems = 0;
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            totalItems += item.quantity || 0;
          });
        }
        
        // dailySalesã‹ã‚‰æ¸›ç®—
        const updateData = {
          totalSales: Math.max(0, (dailyData.totalSales || 0) - totalAmount),
          customerCount: Math.max(0, (dailyData.customerCount || 0) - 1),
          totalItems: Math.max(0, (dailyData.totalItems || 0) - totalItems),
          cashSales: Math.max(0, (dailyData.cashSales || 0) - cashSales),
          emoneSales: Math.max(0, (dailyData.emoneSales || 0) - emoneSales),
          creditSales: Math.max(0, (dailyData.creditSales || 0) - creditSales),
          tax8Total: Math.max(0, (dailyData.tax8Total || 0) - tax8Total),
          tax10Total: Math.max(0, (dailyData.tax10Total || 0) - tax10Total),
          redSlipCount: (dailyData.redSlipCount || 0) + 1,
          redSlipAmount: (dailyData.redSlipAmount || 0) + totalAmount,
          redSlipTax8Total: (dailyData.redSlipTax8Total || 0) + tax8Total,
          redSlipTax10Total: (dailyData.redSlipTax10Total || 0) + tax10Total
        };
        
        await window.updateDoc(dailySalesRef, updateData);
        
        // redSlipsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜
        const redSlipData = {
          ...orderData,
          redSlippedAt: window.Timestamp.now(),
          redSlippedBy: window.currentStoreId,
          businessDate: dateStr,
          originalOrderId: orderData.id,
          calculatedTax8Total: tax8Total,
          calculatedTax10Total: tax10Total
        };
        
        const redSlipRef = window.doc(window.collection(window.db, 'stores', window.currentStoreId, 'redSlips'));
        await window.setDoc(redSlipRef, redSlipData);
        
        // æ³¨æ–‡ã‚’å‰Šé™¤
        await window.deleteDoc(window.getStoreDoc('orders', orderData.id));
        
        await showCustomAlert({ 
          icon: '', 
          title: 'èµ¤ä¼ç¥¨å®Œäº†', 
          message: `æ³¨æ–‡ #${orderData.orderNumber} ã‚’èµ¤ä¼ç¥¨ã§å–ã‚Šæ¶ˆã—ã¾ã—ãŸ\n\né‡‘é¡: Â¥${totalAmount.toLocaleString()}\n\nå£²ä¸Šãƒ»å®¢æ•°ã‹ã‚‰é™¤å¤–ã•ã‚Œã¾ã—ãŸ`, 
          btnClass: 'modal-btn-success' 
        });
        
        closeEditOrderModal();
        await loadHistory();
        
      } catch (e) {
        console.error('èµ¤ä¼ç¥¨ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({ 
          icon: '', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: `èµ¤ä¼ç¥¨å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    // ========== èµ¤ä¼ç¥¨æ©Ÿèƒ½ ==========
    window.redSlipFromHistory = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        if (!orderDoc.exists()) {
          await showCustomAlert({ 
            icon: '', 
            title: 'ã‚¨ãƒ©ãƒ¼', 
            message: 'æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 
            btnClass: 'modal-btn-danger' 
          });
          return;
        }
        
        const orderData = { id: orderDoc.id, ...orderDoc.data() };
        
        if (!orderData.paidAt) {
          await showCustomAlert({ 
            icon: '', 
            title: 'è­¦å‘Š', 
            message: 'ä¼šè¨ˆæ¸ˆã¿ã®æ³¨æ–‡ã®ã¿èµ¤ä¼ç¥¨ã§ãã¾ã™', 
            btnClass: 'modal-btn-danger' 
          });
          return;
        }
        
        const confirmed = await showCustomConfirm({
          icon: '',
          title: 'èµ¤ä¼ç¥¨ï¼ˆå®Œå…¨å–æ¶ˆï¼‰',
          message: `æ³¨æ–‡ #${orderData.orderNumber} ã‚’èµ¤ä¼ç¥¨ã§å®Œå…¨å–æ¶ˆã—ã¾ã™ã‹ï¼Ÿ\n\né‡‘é¡: Â¥${orderData.totalAmount.toLocaleString()}\n\né‡è¦ãªæ³¨æ„äº‹é …:\nâ€¢ å£²ä¸Šã‹ã‚‰å®Œå…¨ã«é™¤å¤–ã•ã‚Œã¾ã™\nâ€¢ å®¢æ•°ã‚‚æ¸›å°‘ã—ã¾ã™\nâ€¢ å¾©å…ƒã§ãã¾ã›ã‚“\nâ€¢ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“`,
          btnText: 'èµ¤ä¼ç¥¨ã§å–æ¶ˆ',
          btnClass: 'modal-btn-danger'
        });
        
        if (!confirmed) return;
        
        // ä¼šè¨ˆæ—¥æ™‚ã‹ã‚‰å–¶æ¥­æ—¥ã‚’è¨ˆç®—ï¼ˆ3æ™‚åŸºæº–ï¼‰
        const paidDate = orderData.paidAt.toDate();
        let businessDate = new Date(paidDate);
        
        if (paidDate.getHours() < 3) {
          businessDate.setDate(businessDate.getDate() - 1);
        }
        
        const dateStr = `${businessDate.getFullYear()}-${String(businessDate.getMonth() + 1).padStart(2, '0')}-${String(businessDate.getDate()).padStart(2, '0')}`;
        
        // dailySalesã‚’å–å¾—
        const dailySalesRef = window.getStoreDoc('dailySales', dateStr);
        const dailySalesDoc = await window.getDoc(dailySalesRef);
        
        if (!dailySalesDoc.exists()) {
          await showCustomAlert({ 
            icon: '', 
            title: 'è­¦å‘Š', 
            message: `ã“ã®å–¶æ¥­æ—¥ã®dailySalesãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\nå–¶æ¥­æ—¥: ${dateStr}`, 
            btnClass: 'modal-btn-danger' 
          });
          return;
        }
        
        const dailyData = dailySalesDoc.data();
        const totalAmount = orderData.totalAmount || 0;
        
        // ç¨ç‡è¨ˆç®—
        let tax8Total = 0;
        let tax10Total = 0;
        
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
            let itemTaxRate = item.taxRate || (item.takeout ? 8 : 10);
            
            if (itemTaxRate === 8) {
              tax8Total += itemTotal;
            } else {
              tax10Total += itemTotal;
            }
          });
        }
        
        // æ”¯æ‰•ã„æ–¹æ³•åˆ¥ã®é‡‘é¡
        let cashSales = 0, emoneSales = 0, creditSales = 0;
        const paymentMethod = orderData.paymentMethod || '';
        if (paymentMethod === 'ç¾é‡‘' || paymentMethod === 'cash') cashSales = totalAmount;
        else if (paymentMethod === 'é›»å­ãƒãƒãƒ¼' || paymentMethod === 'emoney') emoneSales = totalAmount;
        else if (paymentMethod === 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰' || paymentMethod === 'credit') creditSales = totalAmount;
        
        // å•†å“æ•°ã‚’è¨ˆç®—
        let totalItems = 0;
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            totalItems += item.quantity || 0;
          });
        }
        
        // dailySalesã‹ã‚‰æ¸›ç®—
        const updateData = {
          totalSales: Math.max(0, (dailyData.totalSales || 0) - totalAmount),
          customerCount: Math.max(0, (dailyData.customerCount || 0) - 1),
          totalItems: Math.max(0, (dailyData.totalItems || 0) - totalItems),
          cashSales: Math.max(0, (dailyData.cashSales || 0) - cashSales),
          emoneSales: Math.max(0, (dailyData.emoneSales || 0) - emoneSales),
          creditSales: Math.max(0, (dailyData.creditSales || 0) - creditSales),
          tax8Total: Math.max(0, (dailyData.tax8Total || 0) - tax8Total),
          tax10Total: Math.max(0, (dailyData.tax10Total || 0) - tax10Total),
          redSlipCount: (dailyData.redSlipCount || 0) + 1,
          redSlipAmount: (dailyData.redSlipAmount || 0) + totalAmount,
          redSlipTax8Total: (dailyData.redSlipTax8Total || 0) + tax8Total,
          redSlipTax10Total: (dailyData.redSlipTax10Total || 0) + tax10Total
        };
        
        await window.updateDoc(dailySalesRef, updateData);
        
        // redSlipsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜
        const redSlipData = {
          ...orderData,
          redSlippedAt: window.Timestamp.now(),
          redSlippedBy: window.currentStoreId,
          businessDate: dateStr,
          originalOrderId: orderData.id,
          calculatedTax8Total: tax8Total,
          calculatedTax10Total: tax10Total
        };
        
        const redSlipRef = window.doc(window.collection(window.db, 'stores', window.currentStoreId, 'redSlips'));
        await window.setDoc(redSlipRef, redSlipData);
        
        // æ³¨æ–‡ã‚’å‰Šé™¤
        await window.deleteDoc(window.getStoreDoc('orders', orderData.id));
        
        await showCustomAlert({ 
          icon: '', 
          title: 'èµ¤ä¼ç¥¨å®Œäº†', 
          message: `æ³¨æ–‡ #${orderData.orderNumber} ã‚’èµ¤ä¼ç¥¨ã§å–ã‚Šæ¶ˆã—ã¾ã—ãŸ\n\né‡‘é¡: Â¥${totalAmount.toLocaleString()}\n\nå£²ä¸Šãƒ»å®¢æ•°ã‹ã‚‰é™¤å¤–ã•ã‚Œã¾ã—ãŸ`, 
          btnClass: 'modal-btn-success' 
        });
        
        // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
        await loadHistory();
        
      } catch (e) {
        console.error('èµ¤ä¼ç¥¨ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({ 
          icon: '', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: `èµ¤ä¼ç¥¨å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ${e.message}`, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    // ========== ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸å†å°åˆ·æ©Ÿèƒ½ ==========
    window.reprintReceipt = async function(orderId) {
      await showCustomAlert({ 
        icon: '', 
        title: 'ãƒ¬ã‚·ãƒ¼ãƒˆå†å°åˆ·', 
        message: 'ãƒ¬ã‚·ãƒ¼ãƒˆå†å°åˆ·æ©Ÿèƒ½\nï¼ˆãƒ—ãƒªãƒ³ã‚¿ãƒ¼é€£æºãŒå¿…è¦ã§ã™ï¼‰\n\nç¾åœ¨ã“ã®æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™ã€‚', 
        btnClass: 'modal-btn-primary' 
      });
    };
    
    window.reprintInvoice = async function(orderId) {
      await showCustomAlert({ 
        icon: '', 
        title: 'é ˜åæ›¸å†å°åˆ·', 
        message: 'é ˜åæ›¸å†å°åˆ·æ©Ÿèƒ½\nï¼ˆãƒ—ãƒªãƒ³ã‚¿ãƒ¼é€£æºãŒå¿…è¦ã§ã™ï¼‰\n\nç¾åœ¨ã“ã®æ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™ã€‚', 
        btnClass: 'modal-btn-primary' 
      });
    };
    
    // ========== ğŸ’¸ æ”¯å‡ºæ©Ÿèƒ½ ==========
    
    window.showExpenseModal = async function() {
      // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('expenseModal').style.display = 'flex';
      
      // æœ¬æ—¥ã®æ—¥ä»˜ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«è¨­å®š
      const now = new Date();
      let today = new Date(now);
      if (now.getHours() < 3) {
        today.setDate(today.getDate() - 1);
      }
      const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      document.getElementById('expenseDateInput').value = dateStr;
      
      await loadExpensesByDate();
    };
    
    window.closeExpenseModal = function() {
      document.getElementById('expenseModal').style.display = 'none';
    };
    
    window.loadExpensesByDate = async function() {
      const dateStr = document.getElementById('expenseDateInput').value;
      if (!dateStr) return;
      
      try {
        const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
        const tbody = document.getElementById('expenseTableBody');
        tbody.innerHTML = '';
        
        if (expenseDoc.exists()) {
          const data = expenseDoc.data();
          const items = data.items || [];
          
          items.forEach(item => {
            addExpenseRowWithData(item);
          });
        } else {
          addExpenseRow();
        }
        
        calculateExpenseTotal();
      } catch (e) {
        console.error('æ”¯å‡ºèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        addExpenseRow();
      }
    };
    
    window.addExpenseRow = function() {
      addExpenseRowWithData({});
    };
    
    function addExpenseRowWithData(data) {
      const tbody = document.getElementById('expenseTableBody');
      const row = tbody.insertRow();
      row.innerHTML = `
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="text" value="${data.storeName || ''}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="åº—å">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <select style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="åŸææ–™è²»" ${data.category === 'åŸææ–™è²»' ? 'selected' : ''}>åŸææ–™è²»</option>
            <option value="å…‰ç†±è²»" ${data.category === 'å…‰ç†±è²»' ? 'selected' : ''}>å…‰ç†±è²»</option>
            <option value="æ¶ˆè€—å“è²»" ${data.category === 'æ¶ˆè€—å“è²»' ? 'selected' : ''}>æ¶ˆè€—å“è²»</option>
            <option value="ãã®ä»–" ${data.category === 'ãã®ä»–' ? 'selected' : ''}>ãã®ä»–</option>
          </select>
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="text" value="${data.detail || ''}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="è©³ç´°">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="number" value="${data.amount || ''}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="é‡‘é¡" onchange="calculateExpenseTotal()">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
          <button onclick="this.closest('tr').remove(); calculateExpenseTotal();" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
        </td>
      `;
    }
    
    function calculateExpenseTotal() {
      const tbody = document.getElementById('expenseTableBody');
      const rows = tbody.querySelectorAll('tr');
      let total = 0;
      
      rows.forEach(row => {
        const amountInput = row.querySelector('input[type="number"]');
        const amount = parseInt(amountInput.value) || 0;
        total += amount;
      });
      
      document.getElementById('expenseTotal').textContent = total.toLocaleString();
    }
    
    window.saveExpenses = async function() {
      const dateStr = document.getElementById('expenseDateInput').value;
      if (!dateStr) {
        await showCustomAlert({ icon: '', title: 'ã‚¨ãƒ©ãƒ¼', message: 'æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„', btnClass: 'modal-btn-danger' });
        return;
      }
      
      const tbody = document.getElementById('expenseTableBody');
      const rows = tbody.querySelectorAll('tr');
      const items = [];
      let total = 0;
      
      rows.forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        const storeName = inputs[0].value;
        const category = inputs[1].value;
        const detail = inputs[2].value;
        const amount = parseInt(inputs[3].value) || 0;
        
        if (storeName || category || detail || amount) {
          items.push({ storeName, category, detail, amount });
          total += amount;
        }
      });
      
      try {
        await window.setDoc(window.getStoreDoc('expenses', dateStr), {
          date: dateStr,
          items: items,
          total: total,
          updatedAt: window.Timestamp.now()
        });
        
        await showCustomAlert({ 
          icon: '', 
          title: 'ä¿å­˜å®Œäº†', 
          message: 'æ”¯å‡ºã‚’ä¿å­˜ã—ã¾ã—ãŸ', 
          btnClass: 'modal-btn-success' 
        });
      } catch (e) {
        console.error('æ”¯å‡ºä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
        await showCustomAlert({ 
          icon: '', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'æ”¯å‡ºã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ', 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    // ========== ğŸ“Š æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ==========
    
    window.showMonthlyReportModal = function() {
      // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('monthlyReportModal').style.display = 'flex';
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä»Šæœˆã®ç¯„å›²ã‚’è¨­å®š
      const now = new Date();
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      
      document.getElementById('reportStartDate').value = `${firstDay.getFullYear()}-${String(firstDay.getMonth()+1).padStart(2,'0')}-${String(firstDay.getDate()).padStart(2,'0')}`;
      document.getElementById('reportEndDate').value = `${lastDay.getFullYear()}-${String(lastDay.getMonth()+1).padStart(2,'0')}-${String(lastDay.getDate()).padStart(2,'0')}`;
    };
    
    window.closeMonthlyReportModal = function() {
      document.getElementById('monthlyReportModal').style.display = 'none';
    };
    
    window.generateMonthlyReport = async function() {
      const startDate = document.getElementById('reportStartDate').value;
      const endDate = document.getElementById('reportEndDate').value;
      
      if (!startDate || !endDate) {
        await showCustomAlert({ icon: '', title: 'ã‚¨ãƒ©ãƒ¼', message: 'é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„', btnClass: 'modal-btn-danger' }); return;
        return;
      }
      
      const container = document.getElementById('monthlyReportContent');
      container.innerHTML = '<div style="text-align: center; padding: 40px;">é›†è¨ˆä¸­...</div>';
      
      try {
        const salesSnapshot = await window.getDocs(window.getStoreCollection('dailySales'));
        const salesByDate = {};
        
        salesSnapshot.forEach(doc => {
          const data = doc.data();
          const date = data.date;
          if (date && date >= startDate && date <= endDate) {
            salesByDate[date] = data;
          }
        });
        
        let totalSales = 0;
        let totalCustomers = 0;
        let html = `
          <div style="background: white; padding: 20px; border-radius: 12px;">
            <h4 style="margin: 0 0 20px 0;">æœŸé–“: ${startDate} ï½ ${endDate}</h4>
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                  <th style="padding: 12px; border: 1px solid #ddd;">æ—¥ä»˜</th>
                  <th style="padding: 12px; border: 1px solid #ddd;">å£²ä¸Š</th>
                  <th style="padding: 12px; border: 1px solid #ddd;">å®¢æ•°</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        const dates = Object.keys(salesByDate).sort();
        dates.forEach(date => {
          const data = salesByDate[date];
          const sales = data.totalSales || 0;
          const customers = data.customerCount || 0;
          
          totalSales += sales;
          totalCustomers += customers;
          
          html += `
            <tr>
              <td style="padding: 10px; border: 1px solid #ddd;">${date}</td>
              <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">Â¥${sales.toLocaleString()}</td>
              <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${customers}ä»¶</td>
            </tr>
          `;
        });
        
        html += `
              </tbody>
              <tfoot>
                <tr style="background: #f5f5f5; font-weight: bold;">
                  <td style="padding: 12px; border: 1px solid #ddd;">åˆè¨ˆ</td>
                  <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">Â¥${totalSales.toLocaleString()}</td>
                  <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${totalCustomers}ä»¶</td>
                </tr>
              </tfoot>
            </table>
          </div>
        `;
        
        container.innerHTML = html;
      } catch (e) {
        console.error('æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚¨ãƒ©ãƒ¼:', e);
        container.innerHTML = '<div style="text-align: center; color: red; padding: 40px;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    };
    
    // ========== ğŸ–¨ ãƒ—ãƒªãƒ³ã‚¿è¨­å®šæ©Ÿèƒ½ ==========
    
    // ãƒ—ãƒªãƒ³ã‚¿è¨­å®šã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let PRINTER_IP = localStorage.getItem('printerIP') || '192.168.1.100';
    let PRINTER_CONNECTION_TYPE = localStorage.getItem('printerConnectionType') || 'ethernet';
    let BLUETOOTH_DEVICE = null;
    let BLUETOOTH_CHARACTERISTIC = null;
    
    window.selectConnectionType = function(type) {
      PRINTER_CONNECTION_TYPE = type;
      
      const ethernetBtn = document.getElementById('connectionTypeEthernet');
      const bluetoothBtn = document.getElementById('connectionTypeBluetooth');
      const ethernetSettings = document.getElementById('ethernetSettings');
      const bluetoothSettings = document.getElementById('bluetoothSettings');
      
      if (type === 'ethernet') {
        ethernetBtn.style.background = '#667eea';
        ethernetBtn.style.color = 'white';
        bluetoothBtn.style.background = 'white';
        bluetoothBtn.style.color = '#666';
        ethernetSettings.style.display = 'block';
        bluetoothSettings.style.display = 'none';
      } else {
        ethernetBtn.style.background = 'white';
        ethernetBtn.style.color = '#666';
        bluetoothBtn.style.background = '#667eea';
        bluetoothBtn.style.color = 'white';
        ethernetSettings.style.display = 'none';
        bluetoothSettings.style.display = 'block';
      }
    };
    
    window.showBluetoothSearchGuide = function() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;';
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <div style="text-align: center; margin-bottom: 25px;">
            <div style="width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 50%; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold;">
              BT
            </div>
            <h3 style="font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #333;">Bluetoothãƒ—ãƒªãƒ³ã‚¿ã®æ¤œç´¢</h3>
          </div>
          
          <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
            <p style="font-size: 15px; color: #555; margin-bottom: 12px; line-height: 1.6;">
              ã“ã®å¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒšã‚¢è¨­å®šç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            </p>
            <p style="font-size: 14px; color: #666; line-height: 1.6;">
              <strong style="color: #333;">ç¢ºèªäº‹é …ï¼š</strong><br>
              â€¢ ãƒ—ãƒªãƒ³ã‚¿ã®é›»æºãŒå…¥ã£ã¦ã„ã‚‹<br>
              â€¢ BluetoothãŒONã«ãªã£ã¦ã„ã‚‹<br>
              â€¢ ãƒšã‚¢ãƒªãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã«ãªã£ã¦ã„ã‚‹
            </p>
          </div>
          
          <div style="display: flex; gap: 12px;">
            <button onclick="this.closest('.modal-overlay').remove()" style="flex: 1; padding: 15px; font-size: 16px; font-weight: bold; border: 2px solid #ddd; background: white; color: #666; border-radius: 10px; cursor: pointer;">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button onclick="this.closest('.modal-overlay').remove(); window.startBluetoothSearch();" style="flex: 1; padding: 15px; font-size: 16px; font-weight: bold; border: none; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 15px rgba(33,150,243,0.3);">
              æ¤œç´¢é–‹å§‹
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    };
    
    window.startBluetoothSearch = async function() {
      try {
        console.log('Bluetoothãƒ—ãƒªãƒ³ã‚¿ã‚’æ¤œç´¢ä¸­...');
        
        const device = await navigator.bluetooth.requestDevice({
          filters: [
            { services: ['000018f0-0000-1000-8000-00805f9b34fb'] },
          ],
          optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });
        
        console.log('ãƒ‡ãƒã‚¤ã‚¹ç™ºè¦‹:', device.name);
        
        const server = await device.gatt.connect();
        console.log('GATTæ¥ç¶šæˆåŠŸ');
        
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        console.log('ã‚µãƒ¼ãƒ“ã‚¹å–å¾—æˆåŠŸ');
        
        const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
        console.log('Characteristicå–å¾—æˆåŠŸ');
        
        BLUETOOTH_DEVICE = device;
        BLUETOOTH_CHARACTERISTIC = characteristic;
        
        document.getElementById('bluetoothDeviceInfo').style.display = 'block';
        document.getElementById('bluetoothDeviceName').textContent = device.name || 'ä¸æ˜ãªãƒ‡ãƒã‚¤ã‚¹';
        
        localStorage.setItem('bluetoothDeviceName', device.name || '');
        
        await showCustomAlert({ 
          icon: '', 
          title: 'æ¥ç¶šæˆåŠŸ', 
          message: 'Bluetoothãƒ—ãƒªãƒ³ã‚¿ã«æ¥ç¶šã—ã¾ã—ãŸ\n' + (device.name || 'ä¸æ˜ãªãƒ‡ãƒã‚¤ã‚¹'), 
          btnClass: 'modal-btn-success' 
        });
        
      } catch (error) {
        console.error('Bluetoothæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
        
        if (error.name === 'NotFoundError') {
          await showCustomAlert({ 
            icon: '', 
            title: 'ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 
            message: 'Bluetoothãƒ—ãƒªãƒ³ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\nãƒ—ãƒªãƒ³ã‚¿ã®é›»æºãŒå…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 
            btnClass: 'modal-btn-danger' 
          });
        } else if (error.name === 'SecurityError' || error.name === 'NotAllowedError') {
          console.log('æ¤œç´¢ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
        } else {
          await showCustomAlert({ 
            icon: '', 
            title: 'æ¥ç¶šã‚¨ãƒ©ãƒ¼', 
            message: 'Bluetoothãƒ—ãƒªãƒ³ã‚¿ã®æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nãƒ–ãƒ©ã‚¦ã‚¶ãŒBluetoothå¯¾å¿œã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆChromeã€Edgeæ¨å¥¨ï¼‰', 
            btnClass: 'modal-btn-danger' 
          });
        }
      }
    };
    
    window.searchBluetoothPrinter = function() {
      showBluetoothSearchGuide();
    };
    
    function createESCPOSCommand(text) {
      const encoder = new TextEncoder();
      const commands = [];
      
      commands.push(new Uint8Array([0x1B, 0x40]));
      commands.push(encoder.encode(text));
      commands.push(new Uint8Array([0x0A, 0x0A, 0x0A]));
      commands.push(new Uint8Array([0x1D, 0x56, 0x00]));
      
      const totalLength = commands.reduce((sum, cmd) => sum + cmd.length, 0);
      const result = new Uint8Array(totalLength);
      let offset = 0;
      for (const cmd of commands) {
        result.set(cmd, offset);
        offset += cmd.length;
      }
      
      return result;
    }
    
    async function printViaBluetooth(text) {
      if (!BLUETOOTH_CHARACTERISTIC) {
        throw new Error('Bluetoothãƒ—ãƒªãƒ³ã‚¿ãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      }
      
      try {
        const command = createESCPOSCommand(text);
        
        const chunkSize = 512;
        for (let i = 0; i < command.length; i += chunkSize) {
          const chunk = command.slice(i, Math.min(i + chunkSize, command.length));
          await BLUETOOTH_CHARACTERISTIC.writeValue(chunk);
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        console.log('Bluetoothå°åˆ·å®Œäº†');
      } catch (error) {
        console.error('Bluetoothå°åˆ·ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
      }
    }
    
    window.showPrinterSettings = function() {
      // æ©Ÿèƒ½ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('printerIPInput').value = PRINTER_IP;
      selectConnectionType(PRINTER_CONNECTION_TYPE);
      
      const savedDeviceName = localStorage.getItem('bluetoothDeviceName');
      if (savedDeviceName && PRINTER_CONNECTION_TYPE === 'bluetooth') {
        document.getElementById('bluetoothDeviceInfo').style.display = 'block';
        document.getElementById('bluetoothDeviceName').textContent = savedDeviceName + ' (å†æ¥ç¶šãŒå¿…è¦)';
      }
      
      document.getElementById('printerSettingsModal').style.display = 'flex';
      document.getElementById('printerTestResult').style.display = 'none';
    };
    
    window.closePrinterSettingsModal = function() {
      document.getElementById('printerSettingsModal').style.display = 'none';
    };
    
    window.savePrinterSettings = async function() {
      if (PRINTER_CONNECTION_TYPE === 'ethernet') {
        const newIP = document.getElementById('printerIPInput').value.trim();
        
        const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
        if (!ipPattern.test(newIP)) {
          await showCustomAlert({ 
            icon: '', 
            title: 'ã‚¨ãƒ©ãƒ¼', 
            message: 'æ­£ã—ã„IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nä¾‹: 192.168.1.100', 
            btnClass: 'modal-btn-danger' 
          });
          return;
        }
        
        PRINTER_IP = newIP;
        localStorage.setItem('printerIP', newIP);
        localStorage.setItem('printerConnectionType', 'ethernet');
        
        await showCustomAlert({ 
          icon: '', 
          title: 'ä¿å­˜å®Œäº†', 
          message: 'ãƒ—ãƒªãƒ³ã‚¿è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ\næ¥ç¶šæ–¹å¼: WiFi/LAN\nIP: ' + newIP, 
          btnClass: 'modal-btn-success' 
        });
      } else {
        if (!BLUETOOTH_DEVICE) {
          await showCustomAlert({ 
            icon: '', 
            title: 'ã‚¨ãƒ©ãƒ¼', 
            message: 'Bluetoothãƒ—ãƒªãƒ³ã‚¿ã‚’æ¤œç´¢ã—ã¦æ¥ç¶šã—ã¦ãã ã•ã„', 
            btnClass: 'modal-btn-danger' 
          });
          return;
        }
        
        localStorage.setItem('printerConnectionType', 'bluetooth');
        await showCustomAlert({ 
          icon: '', 
          title: 'ä¿å­˜å®Œäº†', 
          message: 'ãƒ—ãƒªãƒ³ã‚¿è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ\næ¥ç¶šæ–¹å¼: Bluetooth\nãƒ‡ãƒã‚¤ã‚¹: ' + (BLUETOOTH_DEVICE.name || 'ä¸æ˜'), 
          btnClass: 'modal-btn-success' 
        });
      }
      
      closePrinterSettingsModal();
    };
    
    window.testPrinterConnection = async function() {
      const resultDiv = document.getElementById('printerTestResult');
      
      resultDiv.style.display = 'block';
      resultDiv.style.background = '#FFF9C4';
      resultDiv.style.color = '#F57F17';
      resultDiv.textContent = 'æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...';
      
      try {
        if (PRINTER_CONNECTION_TYPE === 'bluetooth') {
          if (!BLUETOOTH_CHARACTERISTIC) {
            resultDiv.style.background = '#FFCDD2';
            resultDiv.style.color = '#C62828';
            resultDiv.innerHTML = 'Bluetoothãƒ—ãƒªãƒ³ã‚¿ãŒæœªæ¥ç¶š<br>å…ˆã«ãƒ—ãƒªãƒ³ã‚¿ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„';
            return;
          }
          
          await printViaBluetooth('=== æ¥ç¶šãƒ†ã‚¹ãƒˆ ===\nå°åˆ·æˆåŠŸï¼\n\n');
          
          resultDiv.style.background = '#C8E6C9';
          resultDiv.style.color = '#2E7D32';
          resultDiv.innerHTML = 'æ¥ç¶šæˆåŠŸï¼<br>Bluetoothãƒ—ãƒªãƒ³ã‚¿ã¨é€šä¿¡ã§ãã¾ã—ãŸ';
          
        } else {
          resultDiv.style.background = '#FFCDD2';
          resultDiv.style.color = '#C62828';
          resultDiv.innerHTML = 'æ¥ç¶šãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™<br>WiFi/LANãƒ—ãƒªãƒ³ã‚¿ã®ãƒ†ã‚¹ãƒˆã«ã¯å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“';
        }
        
      } catch (error) {
        console.error('æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        resultDiv.style.background = '#FFCDD2';
        resultDiv.style.color = '#C62828';
        resultDiv.innerHTML = 'ã‚¨ãƒ©ãƒ¼<br>' + error.message;
      }
    };
  
  </script>
  
  <!-- å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="salesModal" class="sales-modal">
    <div class="sales-modal-content">
      <div class="sales-modal-header">
        <h2 class="sales-modal-title" id="salesModalTitle">æœ¬æ—¥ã®å£²ä¸Š</h2>
        <button class="sales-modal-close" onclick="closeSalesModal()">Ã—</button>
      </div>
      <div id="salesContent">
        <div style="text-align: center; padding: 20px;">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>
  
  <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åœ¨åº«ãƒ‘ãƒãƒ« -->
  <div id="inventoryPanel" style="position: fixed; bottom: 20px; right: 20px; width: 300px; max-height: 400px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 9999; overflow: hidden; transition: all 0.3s ease;">
    <div id="inventoryPanelBar" onclick="toggleInventoryPanel()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.3s ease;">
      <div style="font-weight: bold; color: white; font-size: 15px;">ğŸ“¦ åœ¨åº«çŠ¶æ³</div>
      <div id="inventoryPanelArrow" style="color: white; font-size: 18px;">â–¼</div>
    </div>
    <div id="inventoryPanelContent" style="max-height: 350px; overflow-y: auto; padding: 10px;">
      <div style="padding: 10px; text-align: center; color: #999;">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>
  
  <!-- ğŸ†• å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="salesModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3 id="salesModalTitle">æœ¬æ—¥ã®å£²ä¸Š</h3>
        <button class="modal-close" onclick="closeSalesModal()">Ã—</button>
      </div>
      <div id="salesContent" style="padding: 20px;">
        <div style="text-align: center; padding: 20px;">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn" style="background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%); color: white;" onclick="showSettlementModal()">ğŸ”„ ç²¾ç®—</button>
        <button class="btn btn-secondary" onclick="closeSalesModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  
  <!-- ç²¾ç®—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="settlementModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 style="color: #ff6b6b;">ğŸ”„ ç²¾ç®—ç¢ºèª</h3>
        <button class="modal-close" onclick="closeSettlementModal()">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
          <p style="margin: 0 0 10px 0; font-weight: bold; color: #856404;">æ³¨æ„äº‹é …:</p>
          <ul style="margin: 0; padding-left: 20px; color: #856404;">
            <li>æœ¬æ—¥ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºå®šã—ã¾ã™</li>
            <li>ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ï¼ˆPNGç”»åƒï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™</li>
            <li>å£²ä¸Šã¯åˆå‰3æ™‚ã«è‡ªå‹•çš„ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</li>
          </ul>
        </div>
        <div style="margin: 20px 0;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">ç²¾ç®—æ—¥ä»˜ã‚’é¸æŠ</label>
          <input type="date" id="settlementDate" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
          <p style="font-size: 12px; color: #666; margin-top: 5px;">â€» æ˜¨æ—¥ã®ç²¾ç®—ã‚’ä¸Šã’å¿˜ã‚ŒãŸå ´åˆãªã©ã€éå»ã®æ—¥ä»˜ã‚’é¸æŠã§ãã¾ã™</p>
        </div>
        <div id="settlementSummary" style="margin: 20px 0;"></div>
      </div>
      <div class="modal-footer" style="display: flex; flex-direction: column; gap: 10px;">
        <button class="btn" style="width: 100%; background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%); color: white;" onclick="confirmSettlement()">ç²¾ç®—ã‚’å®Ÿè¡Œ</button>
        <button class="btn" style="width: 100%; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="generateDailyReport()">æ—¥è¨ˆè¡¨å‡ºåŠ›</button>
        <button class="btn btn-secondary" style="width: 100%;" onclick="closeSettlementModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>
  
  <!-- å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="historyModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3>æ³¨æ–‡å±¥æ­´</h3>
        <button class="modal-close" onclick="closeHistoryModal()">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap;">
          <select id="historyDateFilter" onchange="filterHistory()" style="padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
            <option value="today">ä»Šæ—¥</option>
            <option value="yesterday">æ˜¨æ—¥</option>
            <option value="week">ä»Šé€±</option>
            <option value="month">ä»Šæœˆ</option>
            <option value="all">å…¨æœŸé–“</option>
          </select>
          <select id="historyStatusFilter" onchange="filterHistory()" style="padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
            <option value="all">ã™ã¹ã¦</option>
            <option value="paid">ä¼šè¨ˆæ¸ˆã¿</option>
            <option value="completed">å®Œäº†</option>
          </select>
          <button onclick="refreshHistory()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;">ğŸ”„ æ›´æ–°</button>
        </div>
        <div id="historyList" style="max-height: 60vh; overflow-y: auto;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeHistoryModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  
  <!-- æ”¯å‡ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="expenseModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3 style="color: #f093fb;">æ”¯å‡ºå…¥åŠ›</h3>
        <button class="modal-close" onclick="closeExpenseModal()">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; gap: 15px;">
          <label style="font-weight: bold; font-size: 16px;">æ—¥ä»˜:</label>
          <input type="date" id="expenseDateInput" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 16px; flex: 1;" onchange="loadExpensesByDate()" />
        </div>
        <div style="margin: 20px 0;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #f5f5f5;">
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">åº—å</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">å‹˜å®šç§‘ç›®</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">è©³ç´°</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">é‡‘é¡</th>
                <th style="padding: 10px; border: 1px solid #ddd; width: 60px;"></th>
              </tr>
            </thead>
            <tbody id="expenseTableBody"></tbody>
          </table>
          <button class="btn" style="margin-top: 10px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="addExpenseRow()">ï¼‹ è¡Œã‚’è¿½åŠ </button>
          <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; text-align: right;">
            <span style="font-size: 18px; font-weight: bold;">åˆè¨ˆ: Â¥</span>
            <span id="expenseTotal" style="font-size: 24px; font-weight: bold; color: #f093fb;">0</span>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
        <button class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="saveExpenses()">ä¿å­˜</button>
        <button class="btn btn-secondary" onclick="closeExpenseModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  
  <!-- æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="monthlyReportModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3>æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</h3>
        <button class="modal-close" onclick="closeMonthlyReportModal()">Ã—</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">é–‹å§‹æ—¥</label>
            <input type="date" id="reportStartDate" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
          </div>
          <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">çµ‚äº†æ—¥</label>
            <input type="date" id="reportEndDate" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
          </div>
          <button onclick="generateMonthlyReport()" style="padding: 12px 24px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px;">ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
        </div>
        <div id="monthlyReportContent"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeMonthlyReportModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  
  <!-- ãƒ—ãƒªãƒ³ã‚¿è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="printerSettingsModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <h3 style="font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 15px; color: #333;">ãƒ—ãƒªãƒ³ã‚¿è¨­å®š</h3>
      <p style="text-align: center; font-size: 16px; color: #666; margin-bottom: 30px;">TSP650II / mC-Print3 / Bluetoothå¯¾å¿œ</p>
      
      <!-- æ¥ç¶šæ–¹å¼é¸æŠ -->
      <div style="margin-bottom: 25px;">
        <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">æ¥ç¶šæ–¹å¼</label>
        <div style="display: flex; gap: 10px;">
          <button id="connectionTypeEthernet" onclick="selectConnectionType('ethernet')" 
                  style="flex: 1; padding: 15px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
            WiFi / LAN
          </button>
          <button id="connectionTypeBluetooth" onclick="selectConnectionType('bluetooth')" 
                  style="flex: 1; padding: 15px; border: 2px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
            Bluetooth
          </button>
        </div>
      </div>
      
      <!-- Ethernetè¨­å®š -->
      <div id="ethernetSettings" style="display: block;">
        <div style="margin-bottom: 25px;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">ãƒ—ãƒªãƒ³ã‚¿IPã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="text" id="printerIPInput" placeholder="ä¾‹: 192.168.1.100" 
                 style="width: 100%; padding: 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
          <div style="margin-top: 8px; font-size: 14px; color: #666;">
            ãƒ—ãƒªãƒ³ã‚¿ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„<br>
            <small style="color: #999;">â€»ãƒ—ãƒªãƒ³ã‚¿ã®è¨­å®šå°åˆ·ã§ç¢ºèªã§ãã¾ã™</small>
          </div>
        </div>
      </div>
      
      <!-- Bluetoothè¨­å®š -->
      <div id="bluetoothSettings" style="display: none;">
        <div style="margin-bottom: 25px;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">Bluetoothãƒ—ãƒªãƒ³ã‚¿</label>
          <button onclick="searchBluetoothPrinter()" 
                  style="width: 100%; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; box-shadow: 0 4px 15px rgba(33,150,243,0.3);">
            ãƒ—ãƒªãƒ³ã‚¿ã‚’æ¤œç´¢
          </button>
          <div id="bluetoothDeviceInfo" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 8px; display: none;">
            <div style="font-weight: bold; color: #333;">æ¥ç¶šæ¸ˆã¿ãƒ—ãƒªãƒ³ã‚¿:</div>
            <div id="bluetoothDeviceName" style="color: #666; margin-top: 5px;">ãªã—</div>
          </div>
          <div style="margin-top: 8px; font-size: 14px; color: #666;">
            ESC/POSå¯¾å¿œã®Bluetoothãƒ—ãƒªãƒ³ã‚¿ã‚’æ¤œç´¢ã—ã¾ã™<br>
            <small style="color: #999;">â€»Chromeã€Edgeã§åˆ©ç”¨å¯èƒ½</small>
          </div>
        </div>
      </div>
      
      <div style="margin-bottom: 25px;">
        <button onclick="testPrinterConnection()" id="testConnectionBtn"
                style="width: 100%; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; box-shadow: 0 4px 15px rgba(76,175,80,0.3);">
          æ¥ç¶šãƒ†ã‚¹ãƒˆ
        </button>
        <div id="printerTestResult" style="margin-top: 10px; padding: 10px; border-radius: 8px; display: none;"></div>
      </div>
      
      <div style="display: flex; gap: 15px; margin-top: 30px;">
        <button onclick="closePrinterSettingsModal()" 
                style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: #e0e0e0; color: #666;">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button onclick="savePrinterSettings()" 
                style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          ä¿å­˜
        </button>
      </div>
    </div>
  </div>
  
  <!-- ğŸ†• POSãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="posIframeModal" class="pos-iframe-modal">
    <div class="pos-iframe-container">
      <div class="pos-iframe-header">
        <h3 id="posModalTitle">POSæ©Ÿèƒ½</h3>
        <button class="pos-iframe-close" onclick="closePOSModal()">Ã—</button>
      </div>
      <iframe id="posIframe" class="pos-iframe-content" src="about:blank"></iframe>
    </div>
  </div>
  
  
  <!-- æ³¨æ–‡ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="editOrderModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3>æ³¨æ–‡ç·¨é›†</h3>
        <button class="modal-close" onclick="closeEditOrderModal()">Ã—</button>
      </div>
      <div id="editOrderContent" style="padding: 20px;"></div>
      <div id="editOrderButtons" class="modal-footer" style="display: flex; gap: 10px;"></div>
    </div>
  </div>

</body>
</html>