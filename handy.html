<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ  - ä¼šè¨ˆæ©Ÿèƒ½ä»˜ã</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    .login-screen {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .login-screen h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 28px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .login-btn:active {
      transform: scale(0.98);
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ */
    .tables-screen {
      display: none;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .header h2 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    /* ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
    .mode-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .mode-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .mode-btn.active {
      background: #667eea;
      color: white;
    }
    
    .mode-btn:active {
      transform: scale(0.95);
    }
    
    .store-info {
      color: #666;
      font-size: 14px;
    }
    
    .logout-btn {
      margin-top: 15px;
      padding: 10px 20px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
    }
    
    .logout-btn:active {
      transform: scale(0.98);
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .table-card {
      background: white;
      border-radius: 15px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    
    .table-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .table-card:active {
      transform: translateY(-2px);
    }
    
    .table-card .table-name {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .table-card .table-status {
      font-size: 12px;
      color: #999;
    }
    
    /* ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .table-card.payment-mode {
      cursor: default;
      padding: 20px;
    }
    
    .table-card.has-orders {
      border: 3px solid #4CAF50;
    }
    
    .table-card.has-incomplete-orders {
      border: 3px solid #FF9800 !important;
      background: #fff3e0;
    }
    
    .table-card.all-paid {
      border: 3px solid #2196F3;
    }
    
    .table-card .order-info {
      margin-top: 10px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 12px;
    }
    
    .table-card .order-total {
      font-size: 20px;
      font-weight: bold;
      color: #4CAF50;
      margin: 10px 0;
    }
    
    .table-card .payment-btn {
      width: 100%;
      padding: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .table-card .payment-btn:active {
      transform: scale(0.95);
    }
    
    .table-card .no-orders {
      color: #999;
      font-size: 12px;
      margin-top: 10px;
    }
    
    .table-card .status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    
    .table-card .status-badge.paid {
      background: #2196F3;
      color: white;
    }
    
    .table-card .status-badge.incomplete {
      background: #FF9800;
      color: white;
    }
    
    .hidden {
      display: none !important;
    }
    
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }
    
    /* ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .custom-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.2s ease-out;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    .custom-modal-box {
      background: white;
      border-radius: 20px;
      padding: 0;
      max-width: 85%;
      width: 400px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease-out;
      overflow: hidden;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-icon {
      font-size: 64px;
      text-align: center;
      padding: 30px 20px 20px 20px;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      text-align: center;
      padding: 0 30px;
      margin-bottom: 15px;
    }
    
    .modal-message {
      font-size: 16px;
      color: #666;
      text-align: center;
      padding: 0 30px 30px 30px;
      line-height: 1.6;
      white-space: pre-line;
    }
    
    .modal-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
      border-top: 1px solid #e0e0e0;
    }
    
    .modal-btn {
      padding: 18px;
      background: white;
      border: none;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modal-btn:hover {
      background: #f5f5f5;
    }
    
    .modal-btn-cancel {
      color: #666;
      border-right: 1px solid #e0e0e0;
    }
    
    .modal-btn-success {
      color: #4CAF50;
    }
    
    .modal-btn-danger {
      color: #f44336;
    }
    
    /* ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« */
    .payment-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 9999;
      overflow-y: auto;
    }
    
    .payment-modal {
      background: white;
      max-width: 600px;
      margin: 20px auto;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease-out;
    }
    
    .payment-modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 20px 20px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .payment-modal-header h2 {
      font-size: 24px;
      margin: 0;
    }
    
    .payment-modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .payment-modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .payment-modal-body {
      padding: 20px;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }
    
    .order-summary {
      background: #f5f5f5;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 20px;
    }
    
    .order-summary-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #ddd;
    }
    
    .order-summary-item:last-child {
      border-bottom: none;
      font-weight: bold;
      font-size: 18px;
      color: #667eea;
      padding-top: 12px;
    }
    
    .check-section {
      margin: 20px 0;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 12px;
    }
    
    .check-section h3 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 18px;
    }
    
    .check-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: white;
      border-radius: 8px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .check-item:hover {
      background: #f0f0f0;
    }
    
    .check-item input[type="checkbox"] {
      width: 24px;
      height: 24px;
      margin-right: 12px;
      cursor: pointer;
    }
    
    .check-item label {
      flex: 1;
      cursor: pointer;
      font-size: 16px;
    }
    
    .check-item.checked {
      background: #e8f5e9;
      border: 2px solid #4CAF50;
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    
    .action-btn {
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .action-btn:active {
      transform: scale(0.95);
    }
    
    .action-btn-primary {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    .action-btn-warning {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
    }
    
    .action-btn-danger {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
    }
    
    .action-btn-info {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
    }
    
    .complete-btn {
      width: 100%;
      padding: 20px;
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border: none;
      border-radius: 15px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .complete-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    .complete-btn:not(:disabled):active {
      transform: scale(0.98);
    }
    
    /* é‡‘é¡ä¿®æ­£ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .amount-edit-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10001;
      overflow-y: auto;
    }
    
    .amount-edit-content {
      background: white;
      max-width: 600px;
      margin: 20px auto;
      border-radius: 20px;
      padding: 0;
      animation: slideUp 0.3s ease-out;
    }
    
    .amount-edit-header {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
      padding: 20px;
      border-radius: 20px 20px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .amount-edit-body {
      padding: 20px;
      max-height: calc(100vh - 200px);
      overflow-y: auto;
    }
    
    .edit-item {
      padding: 15px;
      background: #f9f9f9;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    
    .edit-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-weight: bold;
    }
    
    .edit-item input[type="number"] {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 18px;
      text-align: right;
    }
    
    .edit-item input[type="number"]:focus {
      outline: none;
      border-color: #FF9800;
    }
    
    .edit-total {
      background: #667eea;
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      margin: 20px 0;
    }
    
    .edit-total-label {
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .edit-total-amount {
      font-size: 32px;
      font-weight: bold;
    }
    
    /* å€¤å¼•ããƒ¢ãƒ¼ãƒ€ãƒ« */
    .discount-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .discount-content {
      background: white;
      max-width: 500px;
      width: 90%;
      border-radius: 20px;
      padding: 0;
      animation: slideUp 0.3s ease-out;
    }
    
    .discount-header {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      padding: 20px;
      border-radius: 20px 20px 0 0;
      text-align: center;
    }
    
    .discount-header h2 {
      font-size: 24px;
      margin: 0;
    }
    
    .discount-body {
      padding: 30px;
    }
    
    .discount-info {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .discount-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      font-size: 18px;
    }
    
    .discount-row.total {
      border-top: 2px solid #ddd;
      margin-top: 10px;
      padding-top: 15px;
      font-weight: bold;
      color: #667eea;
      font-size: 24px;
    }
    
    .discount-input-group {
      margin: 20px 0;
    }
    
    .discount-input-group label {
      display: block;
      margin-bottom: 10px;
      font-weight: bold;
      color: #333;
    }
    
    .discount-input-group input {
      width: 100%;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 20px;
      text-align: right;
    }
    
    .discount-input-group input:focus {
      outline: none;
      border-color: #2196F3;
    }
    
    .discount-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
    }
    
    .discount-btn {
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .discount-btn-cancel {
      background: #f5f5f5;
      color: #666;
    }
    
    .discount-btn-apply {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
    }
  </style>
</head>
<body>
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc, doc, Timestamp, onSnapshot, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.updateDoc = updateDoc;
    window.doc = doc;
    window.Timestamp = Timestamp;
    window.onSnapshot = onSnapshot;
    window.orderBy = orderBy;
    
    window.firebaseReady = true;
    console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†');
  </script>

  <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
  <div class="login-screen" id="loginScreen">
    <h1>ğŸ½ï¸ ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </h1>
    <div class="form-group">
      <label>åº—èˆ—ã‚’é¸æŠ</label>
      <select id="storeSelect">
        <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
      </select>
    </div>
    <button class="login-btn" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>

  <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ -->
  <div class="tables-screen" id="tablesScreen">
    <div class="header">
      <h2 id="storeName">åº—èˆ—å</h2>
      
      <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ -->
      <div class="mode-toggle">
        <button class="mode-btn active" onclick="switchMode('order')">ğŸ“ æ³¨æ–‡ãƒ¢ãƒ¼ãƒ‰</button>
        <button class="mode-btn" onclick="switchMode('payment')">ğŸ’° ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰</button>
      </div>
      
      <div class="store-info" id="storeInfo">
        ãƒ¢ãƒ¼ãƒ‰: æ³¨æ–‡ãƒ¢ãƒ¼ãƒ‰
      </div>
      
      <button class="logout-btn" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
    
    <div class="tables-grid" id="tablesGrid">
      <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
    </div>
  </div>

  <!-- ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="custom-modal-overlay" id="customModal">
    <div class="custom-modal-box">
      <div class="modal-icon" id="modalIcon">âš ï¸</div>
      <div class="modal-title" id="modalTitle">ç¢ºèª</div>
      <div class="modal-message" id="modalMessage">æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeCustomModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-success" id="modalConfirmBtn" onclick="confirmCustomModal()">OK</button>
      </div>
    </div>
  </div>

  <!-- ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="payment-modal-overlay" id="paymentModal">
    <div class="payment-modal">
      <div class="payment-modal-header">
        <h2>ğŸ’° ä¼šè¨ˆå‡¦ç†</h2>
        <button class="payment-modal-close" onclick="closePaymentModal()">Ã—</button>
      </div>
      <div class="payment-modal-body">
        <div class="order-summary">
          <div class="order-summary-item">
            <span>ãƒ†ãƒ¼ãƒ–ãƒ«:</span>
            <span id="paymentTableNumber">-</span>
          </div>
          <div class="order-summary-item">
            <span>æ³¨æ–‡ä»¶æ•°:</span>
            <span id="paymentOrderCount">0ä»¶</span>
          </div>
          <div class="order-summary-item">
            <span>åˆè¨ˆé‡‘é¡:</span>
            <span id="paymentTotalAmount">Â¥0</span>
          </div>
        </div>

        <!-- ãƒã‚§ãƒƒã‚¯é …ç›® -->
        <div class="check-section">
          <h3>âœ… ç¢ºèªé …ç›®</h3>
          <div id="checkItemsList">
            <!-- ãƒã‚§ãƒƒã‚¯é …ç›®ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
          </div>
        </div>

        <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ -->
        <div class="action-buttons">
          <button class="action-btn action-btn-info" onclick="openAmountEditModal()">ğŸ’´ é‡‘é¡ä¿®æ­£</button>
          <button class="action-btn action-btn-info" onclick="openDiscountModal()">ğŸ« å€¤å¼•ã</button>
          <button class="action-btn action-btn-warning" onclick="cancelOrder()">â¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="action-btn action-btn-danger" onclick="deleteOrder()">ğŸ—‘ å‰Šé™¤</button>
        </div>

        <!-- ä¼šè¨ˆå®Œäº†ãƒœã‚¿ãƒ³ -->
        <button class="complete-btn" id="completePaymentBtn" onclick="completePayment()" disabled>
          âœ… ä¼šè¨ˆå®Œäº†
        </button>
      </div>
    </div>
  </div>

  <!-- é‡‘é¡ä¿®æ­£ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="amount-edit-modal" id="amountEditModal">
    <div class="amount-edit-content">
      <div class="amount-edit-header">
        <h2>ğŸ’´ é‡‘é¡ä¿®æ­£</h2>
        <button class="payment-modal-close" onclick="closeAmountEditModal()">Ã—</button>
      </div>
      <div class="amount-edit-body">
        <div id="editItemsList">
          <!-- ç·¨é›†é …ç›®ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
        </div>
        
        <div class="edit-total">
          <div class="edit-total-label">ä¿®æ­£å¾Œã®åˆè¨ˆé‡‘é¡</div>
          <div class="edit-total-amount" id="editTotalAmount">Â¥0</div>
        </div>

        <div class="action-buttons">
          <button class="action-btn action-btn-danger" onclick="closeAmountEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="action-btn action-btn-primary" onclick="applyAmountEdit()">é©ç”¨</button>
        </div>
      </div>
    </div>
  </div>

  <!-- å€¤å¼•ããƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="discount-modal" id="discountModal">
    <div class="discount-content">
      <div class="discount-header">
        <h2>ğŸ« å€¤å¼•ã</h2>
      </div>
      <div class="discount-body">
        <div class="discount-info">
          <div class="discount-row">
            <span>ç¾åœ¨ã®åˆè¨ˆ:</span>
            <span id="discountCurrentTotal">Â¥0</span>
          </div>
          <div class="discount-row total">
            <span>å€¤å¼•ãå¾Œ:</span>
            <span id="discountNewTotal">Â¥0</span>
          </div>
        </div>

        <div class="discount-input-group">
          <label>å€¤å¼•ãé‡‘é¡ (å††)</label>
          <input type="number" id="discountAmount" placeholder="0" oninput="calculateDiscountTotal()">
        </div>

        <div class="discount-buttons">
          <button class="discount-btn discount-btn-cancel" onclick="closeDiscountModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="discount-btn discount-btn-apply" onclick="applyDiscount()">é©ç”¨</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let storesData = {};
    let currentStoreId = null;
    let currentStoreName = null;
    let currentMode = 'order'; // 'order' ã¾ãŸã¯ 'payment'
    let orderMonitoringUnsubscribers = [];
    let currentPaymentOrders = [];
    let modalResolve = null;
    
    // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    function showCustomModal(options) {
      return new Promise((resolve) => {
        modalResolve = resolve;
        
        document.getElementById('modalIcon').textContent = options.icon || 'âš ï¸';
        document.getElementById('modalTitle').textContent = options.title || 'ç¢ºèª';
        document.getElementById('modalMessage').textContent = options.message || '';
        
        const confirmBtn = document.getElementById('modalConfirmBtn');
        confirmBtn.textContent = options.btnText || 'OK';
        confirmBtn.className = 'modal-btn ' + (options.btnClass || 'modal-btn-success');
        
        document.getElementById('customModal').style.display = 'flex';
      });
    }
    
    function closeCustomModal() {
      document.getElementById('customModal').style.display = 'none';
      if (modalResolve) {
        modalResolve(false);
        modalResolve = null;
      }
    }
    
    function confirmCustomModal() {
      document.getElementById('customModal').style.display = 'none';
      if (modalResolve) {
        modalResolve(true);
        modalResolve = null;
      }
    }
    
    // åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿
    async function loadStoreList() {
      try {
        const storesRef = window.collection(window.db, 'stores');
        const snapshot = await window.getDocs(storesRef);
        
        const select = document.getElementById('storeSelect');
        select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        
        storesData = {};
        
        snapshot.forEach(doc => {
          const data = doc.data();
          storesData[doc.id] = data;
          
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = data.name || doc.id;
          select.appendChild(option);
        });
        
        console.log('âœ… åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å®Œäº†:', Object.keys(storesData).length, 'åº—èˆ—');
        
      } catch (error) {
        console.error('âŒ åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'åº—èˆ—ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-danger'
        });
      }
    }
    
    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    async function handleLogin() {
      const storeId = document.getElementById('storeSelect').value;
      
      if (!storeId) {
        await showCustomModal({
          icon: 'âš ï¸',
          title: 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼',
          message: 'åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„',
          btnText: 'OK',
          btnClass: 'modal-btn-danger'
        });
        return;
      }
      
      currentStoreId = storeId;
      currentStoreName = storesData[storeId].name;
      
      sessionStorage.setItem('handyStoreId', storeId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      
      console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³:', currentStoreName);
      
      showTablesScreen();
    }
    
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
    async function handleLogout() {
      const confirmed = await showCustomModal({
        icon: 'ğŸšª',
        title: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
        message: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ',
        btnText: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
        btnClass: 'modal-btn-danger'
      });
      
      if (confirmed) {
        stopOrderMonitoring();
        
        sessionStorage.removeItem('handyStoreId');
        sessionStorage.removeItem('handyStoreName');
        
        currentStoreId = null;
        currentStoreName = null;
        
        document.getElementById('loginScreen').style.display = 'block';
        document.getElementById('tablesScreen').style.display = 'none';
      }
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢è¡¨ç¤º
    function showTablesScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('tablesScreen').style.display = 'block';
      document.getElementById('storeName').textContent = currentStoreName;
      
      loadTables();
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿
    async function loadTables() {
      try {
        console.log('ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹ - StoreID:', currentStoreId);
        
        const tablesRef = window.collection(window.db, 'stores', currentStoreId, 'tables');
        const snapshot = await window.getDocs(tablesRef);
        
        console.log('ğŸ“Š å–å¾—ã—ãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ•°:', snapshot.size);
        
        const grid = document.getElementById('tablesGrid');
        grid.innerHTML = '';
        
        if (snapshot.empty) {
          console.warn('âš ï¸ ãƒ†ãƒ¼ãƒ–ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          grid.innerHTML = '<div class="error-message">ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
          return;
        }
        
        const tables = [];
        snapshot.forEach(doc => {
          const tableData = { id: doc.id, ...doc.data() };
          console.log('ğŸ“„ ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ:', doc.id, 'â†’', tableData);
          tables.push(tableData);
        });
        
        console.log('ğŸ“¦ å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿:', tables);
        
        tables.sort((a, b) => (a.order || 0) - (b.order || 0));
        
        tables.forEach(table => {
          const card = document.createElement('div');
          card.className = 'table-card';
          
          // ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã‚’å–å¾—ï¼ˆè¤‡æ•°ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã«å¯¾å¿œï¼‰
          const tableNumber = table.tableNumber || table.tableName || table.number || table.name || table.id;
          
          console.log('ğŸ·ï¸ ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º:', tableNumber, 'from data:', table);
          
          card.id = `table-${tableNumber}`;
          
          if (currentMode === 'order') {
            card.onclick = () => openMenu(tableNumber);
            card.innerHTML = `
              <div class="table-name">${tableNumber}</div>
              <div class="table-status">ã‚¿ãƒƒãƒ—ã—ã¦æ³¨æ–‡</div>
            `;
          } else {
            card.classList.add('payment-mode');
            card.innerHTML = `
              <div class="table-name">${tableNumber}</div>
              <div class="order-info" id="orderInfo-${tableNumber}">
                <div class="no-orders">æ³¨æ–‡ãªã—</div>
              </div>
            `;
          }
          
          grid.appendChild(card);
        });
        
        if (currentMode === 'payment') {
          startOrderMonitoring();
        }
        
        console.log('âœ… ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºå®Œäº†:', tables.length, 'ä»¶');
        
      } catch (error) {
        console.error('âŒ ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.message, error.stack);
        document.getElementById('tablesGrid').innerHTML = 
          '<div class="error-message">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message + '</div>';
      }
    }
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‚’é–‹ãï¼ˆæ³¨æ–‡ãƒ¢ãƒ¼ãƒ‰ï¼‰
    function openMenu(tableNumber) {
      console.log('ğŸ“ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã¸:', tableNumber);
      window.location.href = `menu.html?table=${tableNumber}&store=${currentStoreId}`;
    }
    
    // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
    function switchMode(mode) {
      currentMode = mode;
      
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');
      
      if (mode === 'order') {
        document.getElementById('storeInfo').textContent = 'ãƒ¢ãƒ¼ãƒ‰: æ³¨æ–‡ãƒ¢ãƒ¼ãƒ‰';
        stopOrderMonitoring();
      } else {
        document.getElementById('storeInfo').textContent = 'ãƒ¢ãƒ¼ãƒ‰: ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰';
      }
      
      loadTables();
    }
    
    // æ³¨æ–‡ç›£è¦–é–‹å§‹
    function startOrderMonitoring() {
      stopOrderMonitoring();
      
      const ordersRef = window.collection(window.db, 'stores', currentStoreId, 'orders');
      
      const unsubscribe = window.onSnapshot(ordersRef, (snapshot) => {
        updateTablesDisplay(snapshot);
      });
      
      orderMonitoringUnsubscribers.push(unsubscribe);
      console.log('ğŸ‘€ æ³¨æ–‡ç›£è¦–é–‹å§‹');
    }
    
    // æ³¨æ–‡ç›£è¦–åœæ­¢
    function stopOrderMonitoring() {
      orderMonitoringUnsubscribers.forEach(unsub => unsub());
      orderMonitoringUnsubscribers = [];
      console.log('â¹ æ³¨æ–‡ç›£è¦–åœæ­¢');
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤ºæ›´æ–°
    function updateTablesDisplay(snapshot) {
      const tableOrders = {};
      
      snapshot.forEach(doc => {
        const order = { id: doc.id, ...doc.data() };
        
        if (order.deleted || order.cancelledAt) return;
        
        const tableNum = order.tableNumber;
        if (!tableOrders[tableNum]) {
          tableOrders[tableNum] = {
            unpaid: [],
            paid: []
          };
        }
        
        if (order.paidAt) {
          tableOrders[tableNum].paid.push(order);
        } else {
          tableOrders[tableNum].unpaid.push(order);
        }
      });
      
      Object.keys(tableOrders).forEach(tableNum => {
        const card = document.getElementById(`table-${tableNum}`);
        if (!card) return;
        
        const orders = tableOrders[tableNum];
        const unpaidCount = orders.unpaid.length;
        const paidCount = orders.paid.length;
        const totalUnpaid = orders.unpaid.reduce((sum, o) => sum + (o.totalAmount || 0), 0);
        
        card.classList.remove('has-orders', 'has-incomplete-orders', 'all-paid');
        
        const infoDiv = document.getElementById(`orderInfo-${tableNum}`);
        
        if (unpaidCount > 0) {
          card.classList.add('has-orders');
          
          if (paidCount > 0) {
            card.classList.add('has-incomplete-orders');
            const badge = document.createElement('div');
            badge.className = 'status-badge incomplete';
            badge.textContent = 'æœªå®Œäº†';
            card.querySelector('.table-name').appendChild(badge);
          }
          
          infoDiv.innerHTML = `
            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">
              æœªä¼šè¨ˆ: ${unpaidCount}ä»¶
            </div>
            <div class="order-total">Â¥${totalUnpaid.toLocaleString()}</div>
            <button class="payment-btn" onclick="openPaymentModal('${tableNum}')">
              ä¼šè¨ˆå‡¦ç†
            </button>
          `;
        } else if (paidCount > 0) {
          card.classList.add('all-paid');
          const badge = document.createElement('div');
          badge.className = 'status-badge paid';
          badge.textContent = 'ä¼šè¨ˆæ¸ˆ';
          card.querySelector('.table-name').appendChild(badge);
          
          infoDiv.innerHTML = `
            <div style="font-size: 12px; color: #666;">
              ä¼šè¨ˆæ¸ˆ: ${paidCount}ä»¶
            </div>
          `;
        } else {
          infoDiv.innerHTML = '<div class="no-orders">æ³¨æ–‡ãªã—</div>';
        }
      });
    }
    
    // ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    async function openPaymentModal(tableNumber) {
      try {
        const ordersRef = window.collection(window.db, 'stores', currentStoreId, 'orders');
        const q = window.query(ordersRef, window.where('tableNumber', '==', tableNumber));
        const snapshot = await window.getDocs(q);
        
        currentPaymentOrders = [];
        
        snapshot.forEach(doc => {
          const order = { id: doc.id, ...doc.data() };
          if (!order.deleted && !order.cancelledAt && !order.paidAt) {
            currentPaymentOrders.push(order);
          }
        });
        
        if (currentPaymentOrders.length === 0) {
          await showCustomModal({
            icon: 'â„¹ï¸',
            title: 'æƒ…å ±',
            message: 'ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«æœªä¼šè¨ˆã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“',
            btnText: 'OK',
            btnClass: 'modal-btn-success'
          });
          return;
        }
        
        const totalAmount = currentPaymentOrders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);
        
        document.getElementById('paymentTableNumber').textContent = tableNumber;
        document.getElementById('paymentOrderCount').textContent = currentPaymentOrders.length + 'ä»¶';
        document.getElementById('paymentTotalAmount').textContent = 'Â¥' + totalAmount.toLocaleString();
        
        // ãƒã‚§ãƒƒã‚¯é …ç›®ç”Ÿæˆ
        const checkList = document.getElementById('checkItemsList');
        checkList.innerHTML = '';
        
        currentPaymentOrders.forEach((order, index) => {
          const checkItem = document.createElement('div');
          checkItem.className = 'check-item';
          checkItem.onclick = (e) => {
            if (e.target.tagName !== 'INPUT') {
              const checkbox = checkItem.querySelector('input');
              checkbox.checked = !checkbox.checked;
              toggleItemCheck(index);
            }
          };
          
          checkItem.innerHTML = `
            <input type="checkbox" id="check-${index}" onchange="toggleItemCheck(${index})">
            <label for="check-${index}">
              æ³¨æ–‡ #${order.orderNumber || index + 1} - Â¥${(order.totalAmount || 0).toLocaleString()}
            </label>
          `;
          
          checkList.appendChild(checkItem);
        });
        
        updateCompleteButtonState();
        
        document.getElementById('paymentModal').style.display = 'block';
        
      } catch (error) {
        console.error('âŒ ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'ä¼šè¨ˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-danger'
        });
      }
    }
    
    // ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closePaymentModal() {
      document.getElementById('paymentModal').style.display = 'none';
      currentPaymentOrders = [];
    }
    
    // ãƒã‚§ãƒƒã‚¯é …ç›®ãƒˆã‚°ãƒ«
    function toggleItemCheck(index) {
      const checkbox = document.getElementById(`check-${index}`);
      const checkItem = checkbox.closest('.check-item');
      
      if (checkbox.checked) {
        checkItem.classList.add('checked');
      } else {
        checkItem.classList.remove('checked');
      }
      
      updateCompleteButtonState();
    }
    
    // ä¼šè¨ˆå®Œäº†ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
    function updateCompleteButtonState() {
      const checkboxes = document.querySelectorAll('#checkItemsList input[type="checkbox"]');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      
      document.getElementById('completePaymentBtn').disabled = !allChecked;
    }
    
    // ä¼šè¨ˆå®Œäº†
    async function completePayment() {
      const confirmed = await showCustomModal({
        icon: 'ğŸ’°',
        title: 'ä¼šè¨ˆå®Œäº†',
        message: 'ä¼šè¨ˆã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ',
        btnText: 'å®Œäº†',
        btnClass: 'modal-btn-success'
      });
      
      if (!confirmed) return;
      
      try {
        const now = window.Timestamp.now();
        
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          await window.updateDoc(orderRef, {
            paidAt: now,
            notifiedPaid: true
          });
        }
        
        console.log('âœ… ä¼šè¨ˆå®Œäº†:', currentPaymentOrders.length, 'ä»¶');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'å®Œäº†',
          message: 'ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ ä¼šè¨ˆã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'ä¼šè¨ˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-danger'
        });
      }
    }
    
    // é‡‘é¡ä¿®æ­£ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openAmountEditModal() {
      const editList = document.getElementById('editItemsList');
      editList.innerHTML = '';
      
      currentPaymentOrders.forEach((order, orderIndex) => {
        if (order.items && order.items.length > 0) {
          order.items.forEach((item, itemIndex) => {
            const editItem = document.createElement('div');
            editItem.className = 'edit-item';
            
            const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
            
            editItem.innerHTML = `
              <div class="edit-item-header">
                <span>${item.name} Ã—${item.quantity}</span>
                <span>Â¥${itemTotal.toLocaleString()}</span>
              </div>
              <input type="number" id="editPrice_${order.id}_${itemIndex}" value="${itemTotal}" oninput="updateEditTotal()">
            `;
            
            editList.appendChild(editItem);
          });
        } else {
          const editItem = document.createElement('div');
          editItem.className = 'edit-item';
          
          editItem.innerHTML = `
            <div class="edit-item-header">
              <span>æ³¨æ–‡ #${order.orderNumber}</span>
              <span>Â¥${(order.totalAmount || 0).toLocaleString()}</span>
            </div>
            <input type="number" id="editPrice_${order.id}_0" value="${order.totalAmount || 0}" oninput="updateEditTotal()">
          `;
          
          editList.appendChild(editItem);
        }
      });
      
      updateEditTotal();
      document.getElementById('amountEditModal').style.display = 'block';
    }
    
    function closeAmountEditModal() {
      document.getElementById('amountEditModal').style.display = 'none';
    }
    
    function updateEditTotal() {
      let total = 0;
      
      currentPaymentOrders.forEach(order => {
        if (order.items && order.items.length > 0) {
          order.items.forEach((item, index) => {
            const input = document.getElementById(`editPrice_${order.id}_${index}`);
            total += parseInt(input.value) || 0;
          });
        } else {
          const input = document.getElementById(`editPrice_${order.id}_0`);
          total += parseInt(input.value) || 0;
        }
      });
      
      document.getElementById('editTotalAmount').textContent = 'Â¥' + total.toLocaleString();
    }
    
    async function applyAmountEdit() {
      const confirmed = await showCustomModal({
        icon: 'ğŸ’´',
        title: 'é‡‘é¡ä¿®æ­£',
        message: 'ä¿®æ­£ã—ãŸé‡‘é¡ã‚’é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ',
        btnText: 'é©ç”¨',
        btnClass: 'modal-btn-success'
      });
      
      if (!confirmed) return;
      
      try {
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          if (order.items && order.items.length > 0) {
            const updatedItems = order.items.map((item, index) => {
              const input = document.getElementById(`editPrice_${order.id}_${index}`);
              const newTotal = parseInt(input.value) || 0;
              const newPrice = newTotal / item.quantity;
              return {
                ...item,
                price: newPrice - (item.toppingPrice || 0)
              };
            });
            
            const newTotal = updatedItems.reduce((sum, item) => 
              sum + (item.price + (item.toppingPrice || 0)) * item.quantity, 0);
            
            await window.updateDoc(orderRef, {
              items: updatedItems,
              totalAmount: newTotal
            });
            
            order.items = updatedItems;
            order.totalAmount = newTotal;
          } else {
            const input = document.getElementById(`editPrice_${order.id}_0`);
            const newTotal = parseInt(input.value) || 0;
            
            await window.updateDoc(orderRef, {
              totalAmount: newTotal
            });
            
            order.totalAmount = newTotal;
          }
        }
        
        closeAmountEditModal();
        
        const newTotalAmount = currentPaymentOrders.reduce((sum, order) => 
          sum + (order.totalAmount || 0), 0);
        document.getElementById('paymentTotalAmount').textContent = 'Â¥' + newTotalAmount.toLocaleString();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'é‡‘é¡ä¿®æ­£å®Œäº†',
          message: 'é‡‘é¡ã‚’ä¿®æ­£ã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ é‡‘é¡ä¿®æ­£ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'é‡‘é¡ä¿®æ­£ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-danger'
        });
      }
    }
    
    // å€¤å¼•ããƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openDiscountModal() {
      const currentTotal = currentPaymentOrders.reduce((sum, order) => 
        sum + (order.totalAmount || 0), 0);
      
      document.getElementById('discountCurrentTotal').textContent = 'Â¥' + currentTotal.toLocaleString();
      document.getElementById('discountNewTotal').textContent = 'Â¥' + currentTotal.toLocaleString();
      document.getElementById('discountAmount').value = '';
      document.getElementById('discountModal').style.display = 'flex';
    }
    
    function closeDiscountModal() {
      document.getElementById('discountModal').style.display = 'none';
    }
    
    function calculateDiscountTotal() {
      const currentTotal = currentPaymentOrders.reduce((sum, order) => 
        sum + (order.totalAmount || 0), 0);
      const discount = parseInt(document.getElementById('discountAmount').value) || 0;
      const newTotal = Math.max(0, currentTotal - discount);
      
      document.getElementById('discountNewTotal').textContent = 'Â¥' + newTotal.toLocaleString();
    }
    
    async function applyDiscount() {
      const discount = parseInt(document.getElementById('discountAmount').value) || 0;
      
      if (discount <= 0) {
        await showCustomModal({
          icon: 'âš ï¸',
          title: 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼',
          message: 'å€¤å¼•ãé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
          btnText: 'OK',
          btnClass: 'modal-btn-danger'
        });
        return;
      }
      
      const currentTotal = currentPaymentOrders.reduce((sum, order) => 
        sum + (order.totalAmount || 0), 0);
      const newTotal = Math.max(0, currentTotal - discount);
      
      const confirmed = await showCustomModal({
        icon: 'ğŸ«',
        title: 'å€¤å¼•ãé©ç”¨',
        message: `å€¤å¼•ãé‡‘é¡: Â¥${discount.toLocaleString()}\nå€¤å¼•ãå¾Œ: Â¥${newTotal.toLocaleString()}\n\nå€¤å¼•ãã‚’é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ`,
        btnText: 'é©ç”¨',
        btnClass: 'modal-btn-success'
      });
      
      if (!confirmed) return;
      
      try {
        const firstOrder = currentPaymentOrders[0];
        const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', firstOrder.id);
        
        const discountedTotal = Math.max(0, firstOrder.totalAmount - discount);
        
        await window.updateDoc(orderRef, {
          totalAmount: discountedTotal,
          discount: discount,
          originalAmount: firstOrder.totalAmount
        });
        
        firstOrder.totalAmount = discountedTotal;
        
        closeDiscountModal();
        
        const updatedTotal = currentPaymentOrders.reduce((sum, order) => 
          sum + (order.totalAmount || 0), 0);
        document.getElementById('paymentTotalAmount').textContent = 'Â¥' + updatedTotal.toLocaleString();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'å€¤å¼•ãå®Œäº†',
          message: `Â¥${discount.toLocaleString()} ã®å€¤å¼•ãã‚’é©ç”¨ã—ã¾ã—ãŸ`,
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ å€¤å¼•ãã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'å€¤å¼•ãå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-danger'
        });
      }
    }
    
    // æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    async function cancelOrder() {
      const confirmed = await showCustomModal({
        icon: 'â¸',
        title: 'æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
        message: 'ã“ã®æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ',
        btnText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
        btnClass: 'modal-btn-danger'
      });
      
      if (!confirmed) return;
      
      try {
        const now = window.Timestamp.now();
        
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          await window.updateDoc(orderRef, {
            cancelledAt: now
          });
        }
        
        console.log('âœ… æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«:', currentPaymentOrders.length, 'ä»¶');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†',
          message: 'æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-danger'
        });
      }
    }
    
    // æ³¨æ–‡å‰Šé™¤
    async function deleteOrder() {
      const confirmed = await showCustomModal({
        icon: 'ğŸ—‘',
        title: 'æ³¨æ–‡å‰Šé™¤',
        message: 'ã“ã®æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼‰',
        btnText: 'å‰Šé™¤',
        btnClass: 'modal-btn-danger'
      });
      
      if (!confirmed) return;
      
      try {
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          await window.updateDoc(orderRef, {
            deleted: true,
            deletedAt: window.Timestamp.now()
          });
        }
        
        console.log('âœ… æ³¨æ–‡å‰Šé™¤:', currentPaymentOrders.length, 'ä»¶');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'å‰Šé™¤å®Œäº†',
          message: 'æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'å‰Šé™¤å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-danger'
        });
      }
    }
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã«ç™»éŒ²
    window.showCustomModal = showCustomModal;
    window.closeCustomModal = closeCustomModal;
    window.confirmCustomModal = confirmCustomModal;
    window.loadStoreList = loadStoreList;
    window.handleLogin = handleLogin;
    window.handleLogout = handleLogout;
    window.showTablesScreen = showTablesScreen;
    window.loadTables = loadTables;
    window.openMenu = openMenu;
    window.switchMode = switchMode;
    window.startOrderMonitoring = startOrderMonitoring;
    window.stopOrderMonitoring = stopOrderMonitoring;
    window.updateTablesDisplay = updateTablesDisplay;
    window.openPaymentModal = openPaymentModal;
    window.closePaymentModal = closePaymentModal;
    window.toggleItemCheck = toggleItemCheck;
    window.updateCompleteButtonState = updateCompleteButtonState;
    window.completePayment = completePayment;
    window.openAmountEditModal = openAmountEditModal;
    window.closeAmountEditModal = closeAmountEditModal;
    window.updateEditTotal = updateEditTotal;
    window.applyAmountEdit = applyAmountEdit;
    window.openDiscountModal = openDiscountModal;
    window.closeDiscountModal = closeDiscountModal;
    window.calculateDiscountTotal = calculateDiscountTotal;
    window.applyDiscount = applyDiscount;
    window.cancelOrder = cancelOrder;
    window.deleteOrder = deleteOrder;
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('ğŸ“± ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•');
      
      while (!window.firebaseReady || !window.db) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      console.log('âœ… Firebaseæº–å‚™å®Œäº†ã€åº—èˆ—ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã™');
      
      await loadStoreList();
      
      const savedStoreId = sessionStorage.getItem('handyStoreId');
      const savedStoreName = sessionStorage.getItem('handyStoreName');
      
      if (savedStoreId && savedStoreName && storesData[savedStoreId]) {
        currentStoreId = savedStoreId;
        currentStoreName = savedStoreName;
        
        console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å¾©å…ƒ:', currentStoreName);
        showTablesScreen();
      }
    });
  </script>
</body>
</html>
