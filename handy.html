<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ  - POSé€£å‹•ç‰ˆ</title>
  <style>
    /* ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 600px; margin: 0 auto; }
    
    /* å…±é€šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */
    .hidden { display: none !important; }
    .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; margin-bottom: 8px; }
    .btn:active { transform: scale(0.98); }
    
    /* ã‚«ãƒ©ãƒ¼ãƒãƒªã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ */
    .btn-primary { background: #667eea; color: white; }
    .btn-success { background: #4CAF50; color: white; }
    .btn-danger { background: #f44336; color: white; }
    .btn-warning { background: #FF9800; color: white; }
    .btn-info { background: #2196F3; color: white; }
    .btn-secondary { background: #e0e0e0; color: #333; }

    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    .login-screen { text-align: center; }
    .form-group { margin-bottom: 15px; text-align: left; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
    .form-input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ */
    .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
    .table-card { background: white; border-radius: 15px; padding: 20px; text-align: center; cursor: pointer; position: relative; min-height: 120px; display: flex; flex-direction: column; justify-content: space-between; }
    .table-card.active { background: #fff3e0; border: 2px solid #FF9800; }
    .table-name { font-size: 20px; font-weight: bold; color: #333; }
    .badge { position: absolute; top: 10px; right: 10px; background: #FF9800; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; }

    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
    .modal { background: white; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; border-radius: 20px; padding: 25px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
    
    /* ä¼šè¨ˆç”»é¢å›ºæœ‰ */
    .payment-summary { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
    .total-price { font-size: 28px; font-weight: bold; color: #d32f2f; }
    .payment-methods { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
    .payment-method-btn { padding: 15px; border: 2px solid #ddd; border-radius: 10px; background: white; font-weight: bold; cursor: pointer; text-align: center; }
    .payment-method-btn.selected { border-color: #667eea; background: #e8eaf6; color: #667eea; }
    
    /* ãŠã¤ã‚Šè¨ˆç®—ã‚¨ãƒªã‚¢ */
    .cash-section { background: #e8f5e9; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #4CAF50; }
    .cash-input { width: 100%; padding: 15px; font-size: 24px; text-align: right; border: 2px solid #4CAF50; border-radius: 8px; margin-bottom: 10px; }
    .change-display { font-size: 20px; font-weight: bold; text-align: right; color: #333; }
    .change-amount { color: #d32f2f; font-size: 24px; }

    /* ã‚¢ã‚¤ãƒ†ãƒ ãƒªã‚¹ãƒˆ */
    .item-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 14px; }
  </style>
</head>
<body>

<div class="container">
  <div id="loginScreen" class="card login-screen">
    <h1 style="color:#667eea; margin-bottom:20px;">ğŸ½ï¸ ãƒãƒ³ãƒ‡ã‚£POS</h1>
    <div class="form-group">
      <label>åº—èˆ—ã‚’é¸æŠ</label>
      <select id="storeSelect" class="form-input"><option>èª­ã¿è¾¼ã¿ä¸­...</option></select>
    </div>
    <div class="form-group">
      <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input type="password" id="passwordInput" class="form-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰">
    </div>
    <button class="btn btn-primary" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>

  <div id="tablesScreen" class="hidden">
    <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
      <h2 id="storeNameDisplay">åº—èˆ—å</h2>
      <button class="btn btn-danger" style="width:auto; padding:8px 15px; margin:0;" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
    <div id="tablesGrid" class="tables-grid"></div>
  </div>
</div>

<div id="paymentModal" class="modal-overlay hidden">
  <div class="modal">
    <h3 style="text-align:center; margin-bottom:15px;">ğŸ’° ä¼šè¨ˆå‡¦ç†</h3>
    <p id="modalTableName" style="text-align:center; color:#666; margin-bottom:15px;"></p>

    <div style="max-height:150px; overflow-y:auto; margin-bottom:15px; border:1px solid #eee; padding:10px; border-radius:8px;">
      <div id="orderItemsList"></div>
    </div>

    <div class="payment-summary">
      <div>ã”è«‹æ±‚é¡</div>
      <div class="total-price" id="totalAmountDisplay">Â¥0</div>
    </div>

    <div class="payment-methods">
      <div class="payment-method-btn" onclick="selectPayment('cash', this)">
        ğŸ’´<br>ç¾é‡‘
      </div>
      <div class="payment-method-btn" onclick="selectPayment('emoney', this)">
        ğŸ’³<br>é›»å­
      </div>
      <div class="payment-method-btn" onclick="selectPayment('credit', this)">
        ğŸ’³<br>ã‚«ãƒ¼ãƒ‰
      </div>
    </div>

    <div id="cashSection" class="cash-section hidden">
      <label style="font-weight:bold;">ãŠé ã‹ã‚Šé‡‘é¡</label>
      <input type="number" id="cashReceived" class="cash-input" placeholder="0" oninput="calcChange()">
      <div class="change-display">
        ãŠã¤ã‚Š: <span id="changeAmount" class="change-amount">Â¥0</span>
      </div>
    </div>

    <button id="btnComplete" class="btn btn-success" disabled onclick="executePayment()">ä¼šè¨ˆå®Œäº†</button>
    
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
      <button class="btn btn-warning" onclick="cancelOrder()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-danger" onclick="deleteOrder()">å‰Šé™¤</button>
    </div>
    
    <button class="btn btn-secondary" style="margin-top:10px;" onclick="closeModal()">é–‰ã˜ã‚‹</button>
  </div>
</div>

<div id="confirmModal" class="modal-overlay hidden">
  <div class="modal" style="text-align:center; max-width:350px;">
    <div style="font-size:40px; margin-bottom:10px;">âš ï¸</div>
    <h3 id="confirmTitle">ç¢ºèª</h3>
    <p id="confirmMessage" style="margin:15px 0; color:#666;"></p>
    <div style="display:flex; gap:10px;">
      <button class="btn btn-secondary" onclick="closeConfirm()">ã„ã„ãˆ</button>
      <button id="confirmOkBtn" class="btn btn-primary">ã¯ã„</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, doc, updateDoc, setDoc, getDoc, serverTimestamp, onSnapshot, increment } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
    authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
    projectId: "takoyaki-order-system-bacd7",
    storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
    messagingSenderId: "104494752890",
    appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
  let currentStoreId = null;
  let currentStoreName = null;
  let storesData = {};
  let currentOrders = []; // é¸æŠä¸­ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ³¨æ–‡
  let currentTableName = '';
  let selectedMethod = null;
  let confirmResolve = null;

  // --- åˆæœŸåŒ– ---
  window.onload = async () => {
    await loadStores();
    const sid = sessionStorage.getItem('handyStoreId');
    if(sid && storesData[sid]){
      currentStoreId = sid;
      currentStoreName = storesData[sid].name;
      showTables();
    }
  };

  // --- åº—èˆ—ãƒ­ãƒ¼ãƒ‰ ---
  async function loadStores() {
    const q = query(collection(db, 'stores'), where('isActive', '==', true));
    const snap = await getDocs(q);
    const select = document.getElementById('storeSelect');
    select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    
    snap.forEach(d => {
      const data = d.data();
      storesData[d.id] = { name: data.storeName, pass: String(data.storePassword) };
      const opt = document.createElement('option');
      opt.value = d.id;
      opt.textContent = data.storeName;
      select.appendChild(opt);
    });
  }

  // --- ãƒ­ã‚°ã‚¤ãƒ³ ---
  window.handleLogin = () => {
    const id = document.getElementById('storeSelect').value;
    const pass = document.getElementById('passwordInput').value;
    
    if(!id || !storesData[id]) return alert('åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
    if(pass !== storesData[id].pass) return alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
    
    currentStoreId = id;
    currentStoreName = storesData[id].name;
    sessionStorage.setItem('handyStoreId', id);
    showTables();
  };

  window.handleLogout = () => {
    sessionStorage.clear();
    location.reload();
  };

  function showTables() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('tablesScreen').classList.remove('hidden');
    document.getElementById('storeNameDisplay').textContent = currentStoreName;
    loadTablesGrid();
  }

  // --- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ ---
  async function loadTablesGrid() {
    const grid = document.getElementById('tablesGrid');
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒã‚¹ã‚¿å–å¾—
    const tSnap = await getDocs(collection(db, 'stores', currentStoreId, 'tables'));
    const tables = [];
    tSnap.forEach(d => tables.push(d.data()));
    tables.sort((a, b) => (a.order||0) - (b.order||0));

    // æ³¨æ–‡ç›£è¦–
    onSnapshot(collection(db, 'stores', currentStoreId, 'orders'), (snap) => {
      const activeTables = new Set();
      snap.forEach(d => {
        const o = d.data();
        // æœªä¼šè¨ˆãƒ»æœªå‰Šé™¤ãƒ»æœªã‚­ãƒ£ãƒ³ã‚»ãƒ«
        if(!o.paidAt && !o.deleted && !o.cancelledAt && o.tableNumber){
          activeTables.add(String(o.tableNumber));
        }
      });

      grid.innerHTML = '';
      tables.forEach(t => {
        const isActive = activeTables.has(t.name);
        const div = document.createElement('div');
        div.className = `table-card ${isActive ? 'active' : ''}`;
        div.innerHTML = `
          ${isActive ? '<span class="badge">æ³¨æ–‡ã‚ã‚Š</span>' : ''}
          <div class="table-name">${t.name}</div>
          <button class="btn btn-success" style="margin-top:auto;" onclick="openPayment('${t.name}')">ä¼šè¨ˆ/ç®¡ç†</button>
        `;
        grid.appendChild(div);
      });
    });
  }

  // --- ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚ªãƒ¼ãƒ—ãƒ³ ---
  window.openPayment = async (tableName) => {
    currentTableName = tableName;
    
    // æ³¨æ–‡å–å¾—
    const q = query(collection(db, 'stores', currentStoreId, 'orders'), where('tableNumber', '==', String(tableName)));
    const snap = await getDocs(q);
    
    // æœªä¼šè¨ˆãªã©ã®æœ‰åŠ¹ãªæ³¨æ–‡ã®ã¿æŠ½å‡º
    currentOrders = snap.docs
      .map(d => ({id: d.id, ...d.data()}))
      .filter(o => !o.paidAt && !o.deleted && !o.cancelledAt);

    if(currentOrders.length === 0){
      return showConfirm('æ³¨æ–‡ãªã—', 'æœªä¼šè¨ˆã®æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'OK', 'btn-primary');
    }

    // è¡¨ç¤ºæ›´æ–°
    document.getElementById('modalTableName').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ«: ${tableName}`;
    
    // æ˜ç´°ãƒªã‚¹ãƒˆ
    const list = document.getElementById('orderItemsList');
    list.innerHTML = '';
    let total = 0;
    
    currentOrders.forEach(o => {
      total += (o.totalAmount || 0);
      (o.items||[]).forEach(item => {
        const row = document.createElement('div');
        row.className = 'item-row';
        row.innerHTML = `<span>${item.name} x${item.quantity}</span><span>Â¥${((item.price+(item.toppingPrice||0))*item.quantity).toLocaleString()}</span>`;
        list.appendChild(row);
      });
    });

    document.getElementById('totalAmountDisplay').textContent = `Â¥${total.toLocaleString()}`;
    document.getElementById('totalAmountDisplay').dataset.value = total;

    // ãƒªã‚»ãƒƒãƒˆ
    selectedMethod = null;
    document.querySelectorAll('.payment-method-btn').forEach(b => b.classList.remove('selected'));
    document.getElementById('cashSection').classList.add('hidden');
    document.getElementById('cashReceived').value = '';
    document.getElementById('changeAmount').textContent = 'Â¥0';
    document.getElementById('btnComplete').disabled = true;

    document.getElementById('paymentModal').classList.remove('hidden');
  };

  // --- æ”¯æ‰•ã„æ–¹æ³•é¸æŠ ---
  window.selectPayment = (method, btn) => {
    selectedMethod = method;
    document.querySelectorAll('.payment-method-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');

    const total = parseInt(document.getElementById('totalAmountDisplay').dataset.value);
    const btnComplete = document.getElementById('btnComplete');

    if(method === 'cash'){
      document.getElementById('cashSection').classList.remove('hidden');
      btnComplete.disabled = true; // é‡‘é¡å…¥åŠ›å¾…ã¡
    } else {
      document.getElementById('cashSection').classList.add('hidden');
      btnComplete.disabled = false;
    }
  };

  // --- ãŠã¤ã‚Šè¨ˆç®— ---
  window.calcChange = () => {
    const total = parseInt(document.getElementById('totalAmountDisplay').dataset.value);
    const received = parseInt(document.getElementById('cashReceived').value) || 0;
    const change = received - total;
    
    const display = document.getElementById('changeAmount');
    const btn = document.getElementById('btnComplete');

    if(change >= 0){
      display.textContent = `Â¥${change.toLocaleString()}`;
      display.style.color = '#d32f2f'; // é€šå¸¸è‰²
      btn.disabled = false;
    } else {
      display.textContent = `ä¸è¶³ Â¥${Math.abs(change).toLocaleString()}`;
      display.style.color = 'red';
      btn.disabled = true;
    }
  };

  // --- ä¼šè¨ˆå®Ÿè¡Œï¼ˆPOSé€£å‹•ï¼šupdateDailySalesï¼‰ ---
  window.executePayment = async () => {
    if(!await showConfirm('ç¢ºèª', 'ä¼šè¨ˆã‚’ç¢ºå®šã—ã¾ã™ã‹ï¼Ÿ', 'ç¢ºå®š', 'btn-success')) return;

    try {
      const totalAmount = parseInt(document.getElementById('totalAmountDisplay').dataset.value);
      const now = new Date();
      
      // å–¶æ¥­æ—¥ã®è¨ˆç®— (3æ™‚åŒºåˆ‡ã‚Š)
      const businessDate = new Date(now);
      if(businessDate.getHours() < 3) businessDate.setDate(businessDate.getDate() - 1);
      const dateStr = `${businessDate.getFullYear()}-${String(businessDate.getMonth()+1).padStart(2,'0')}-${String(businessDate.getDate()).padStart(2,'0')}`;

      // é›†è¨ˆç”¨å¤‰æ•°
      let tax8 = 0;
      let tax10 = 0;
      let itemCount = 0;
      
      // 1. æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
      const batchPromises = currentOrders.map(order => {
        // ç¨ç‡é›†è¨ˆ
        (order.items||[]).forEach(item => {
          const price = (item.price + (item.toppingPrice||0)) * item.quantity;
          // ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ãªã©ã¯8%ã®ãƒ­ã‚¸ãƒƒã‚¯ãŒå¿…è¦ã ãŒã€ç°¡æ˜“çš„ã«ã“ã“ã§ã¯10%ã¨ã™ã‚‹ã‹ã€
          // å•†å“ãƒã‚¹ã‚¿ã®taxRateã‚’è¦‹ã‚‹ã€‚ä»Šå›ã¯POSã«åˆã‚ã›ã¦ç°¡æ˜“å®Ÿè£…ã€‚
          // POSã§ã¯ãƒ†ãƒ¼ãƒ–ãƒ«åã§åˆ¤åˆ¥ã—ã¦ã„ã‚‹ç®‡æ‰€ã‚ã‚Šã€‚
          const isTakeout = (order.tableNumber === 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ' || item.taxRate === 8);
          if(isTakeout) tax8 += price; else tax10 += price;
          itemCount += item.quantity;
        });

        return updateDoc(doc(db, 'stores', currentStoreId, 'orders', order.id), {
          paidAt: serverTimestamp(),
          paymentMethod: selectedMethod,
          status: 'paid'
        });
      });
      await Promise.all(batchPromises);

      // 2. æ—¥æ¬¡å£²ä¸Š(dailySales)æ›´æ–° - POSé€£å‹•ã®è‚
      const salesRef = doc(db, 'stores', currentStoreId, 'dailySales', dateStr);
      const salesDoc = await getDoc(salesRef);

      const updates = {
        totalSales: increment(totalAmount),
        customerCount: increment(1),
        totalItems: increment(itemCount),
        tax8Total: increment(tax8),
        tax10Total: increment(tax10),
        updatedAt: serverTimestamp()
      };

      if(selectedMethod === 'cash') updates.cashSales = increment(totalAmount);
      if(selectedMethod === 'emoney') updates.emoneSales = increment(totalAmount);
      if(selectedMethod === 'credit') updates.creditSales = increment(totalAmount);

      if(salesDoc.exists()){
        await updateDoc(salesRef, updates);
      } else {
        await setDoc(salesRef, {
          date: dateStr,
          ...updates,
          createdAt: serverTimestamp()
        });
      }

      closeModal();
      showConfirm('å®Œäº†', 'ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸ', 'OK', 'btn-primary');

    } catch(e) {
      alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
  };

  // --- ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç† ---
  window.cancelOrder = async () => {
    if(!await showConfirm('ç¢ºèª', 'æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ‰±ã„ã«ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå£²ä¸Šã«ã¯è¨ˆä¸Šã•ã‚Œã¾ã›ã‚“ï¼‰', 'å®Ÿè¡Œ', 'btn-warning')) return;
    
    try {
      await Promise.all(currentOrders.map(o => updateDoc(doc(db, 'stores', currentStoreId, 'orders', o.id), {
        cancelledAt: serverTimestamp()
      })));
      closeModal();
    } catch(e) { alert(e.message); }
  };

  // --- å‰Šé™¤å‡¦ç† ---
  window.deleteOrder = async () => {
    if(!await showConfirm('å±é™º', 'æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå±¥æ­´ã«ã‚‚æ®‹ã‚Šã¾ã›ã‚“ï¼‰', 'å‰Šé™¤', 'btn-danger')) return;

    try {
      await Promise.all(currentOrders.map(o => updateDoc(doc(db, 'stores', currentStoreId, 'orders', o.id), {
        deleted: true
      })));
      closeModal();
    } catch(e) { alert(e.message); }
  };

  // --- ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ---
  window.closeModal = () => document.getElementById('paymentModal').classList.add('hidden');

  window.showConfirm = (title, msg, btnText, btnClass) => {
    return new Promise(resolve => {
      confirmResolve = resolve;
      document.getElementById('confirmTitle').textContent = title;
      document.getElementById('confirmMessage').innerText = msg; // æ”¹è¡Œå¯¾å¿œ
      const btn = document.getElementById('confirmOkBtn');
      btn.textContent = btnText;
      btn.className = `btn ${btnClass}`;
      document.getElementById('confirmModal').classList.remove('hidden');
    });
  };

  window.closeConfirm = () => {
    document.getElementById('confirmModal').classList.add('hidden');
    if(confirmResolve) confirmResolve(false);
  };

  document.getElementById('confirmOkBtn').onclick = () => {
    document.getElementById('confirmModal').classList.add('hidden');
    if(confirmResolve) confirmResolve(true);
  };

</script>
</body>
</html>