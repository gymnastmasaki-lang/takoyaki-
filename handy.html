<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    /* ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 600px; margin: 0 auto; }
    .login-screen { background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .login-screen h1 { text-align: center; color: #667eea; margin-bottom: 30px; font-size: 28px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; margin-bottom: 8px; color: #333; font-weight: bold; }
    .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
    .login-btn { width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; }
    .tables-screen { display: none; }
    .header { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    .logout-btn { background: #f44336; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
    .table-card { background: white; border-radius: 15px; padding: 30px 20px; text-align: center; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
    
    /* æ³¨æ–‡ã‚ã‚Šãƒãƒƒã‚¸ */
    .table-card.has-pending-orders { background: linear-gradient(135deg, #fff4e6 0%, #ffe0b2 100%); border: 2px solid #ff9800; }
    .table-card.has-pending-orders::after { content: 'æ³¨æ–‡ã‚ã‚Š'; position: absolute; top: 10px; right: 10px; background: #ff9800; color: white; font-size: 10px; padding: 4px 8px; border-radius: 10px; }
    
    .table-card .table-name { font-size: 24px; font-weight: bold; color: #667eea; }
    .checkout-btn { width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer; margin-top: 10px; }
    .hidden { display: none !important; }
    .modal-overlay { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(5px); z-index: 10001; align-items: center; justify-content: center; }
    .modal { background: white; border-radius: 20px; padding: 30px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-bottom: 8px; width: 100%; }
    .tax-item { padding: 10px; background: white; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 8px; }

    /* ä¼šè¨ˆãƒœã‚¿ãƒ³ã®è‰²åˆ†ã‘ */
    .btn-cash { background: #4CAF50; color: white; } /* ç·‘ */
    .btn-emoney { background: #00bcd4; color: white; } /* æ°´è‰² */
    .btn-credit { background: #3f51b5; color: white; } /* é’ */
    .btn-cancel { background: #ff9800; color: white; } /* ã‚ªãƒ¬ãƒ³ã‚¸ */
    .btn-delete { background: #f44336; color: white; } /* èµ¤ */
  </style>
</head>
<body>
  <div class="container">
    <div class="login-screen" id="loginScreen">
      <h1>ğŸ½ï¸ ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </h1>
      <div class="form-group">
        <label for="storeSelect">åº—èˆ—ã‚’é¸æŠ</label>
        <select id="storeSelect"><option value="">èª­ã¿è¾¼ã¿ä¸­...</option></select>
      </div>
      <div class="form-group">
        <label for="passwordInput">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      </div>
      <button class="login-btn" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    
    <div class="tables-screen" id="tablesScreen">
      <div class="header">
        <h2 id="storeNameDisplay">åº—èˆ—å</h2>
        <button class="logout-btn" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <div class="tables-grid" id="tablesGrid">
        <div style="text-align:center; padding:20px;">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>
  
  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3 style="text-align:center;">ğŸ’° ä¼šè¨ˆå‡¦ç†</h3>
      <p id="selectedTableLabel2" style="text-align:center; color:#666; margin-bottom:15px; font-weight:bold;"></p>
      
      <div id="taxRateSection" style="margin-bottom:15px; padding:10px; background:#e8f5e9; border-radius:10px; max-height: 250px; overflow-y: auto;">
        <div id="taxRateItemsList"></div>
      </div>
      
      <div style="margin-bottom:20px; padding:15px; background:#fff3cd; border-radius:10px; text-align:center;">
        <div style="font-size:20px; font-weight:bold;">è«‹æ±‚é¡: <span id="finalPaymentAmount" style="color:#d32f2f;">Â¥0</span></div>
      </div>
      
      <div style="display: grid; grid-template-columns: 1fr; gap: 8px;">
        <button class="btn btn-cash" onclick="completePayment('cash', 'ç¾é‡‘')">ğŸ’´ ç¾é‡‘</button>
        <button class="btn btn-emoney" onclick="completePayment('emoney', 'é›»å­ãƒãƒãƒ¼')">ğŸ’³ é›»å­ãƒãƒãƒ¼</button>
        <button class="btn btn-credit" onclick="completePayment('credit', 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰')">ğŸ’³ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</button>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px;">
          <button class="btn btn-cancel" onclick="cancelOrdersForTable()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="btn btn-delete" onclick="deleteOrdersForTable()">æ³¨æ–‡å‰Šé™¤</button>
        </div>
      </div>
      <button class="btn" style="margin-top:10px; background:#eee;" onclick="closePaymentModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <div id="customConfirmModal" class="modal-overlay hidden">
    <div class="modal" style="text-align:center;">
      <div id="modalIcon" style="font-size:40px;">âš ï¸</div>
      <h3 id="modalTitle">ç¢ºèª</h3>
      <p id="modalMessage" style="margin:15px 0; color:#666;"></p>
      <div style="display:flex; gap:10px;">
        <button class="btn" style="flex:1; background:#ddd;" onclick="closeCustomModal()">ã„ã„ãˆ</button>
        <button id="modalConfirmBtn" class="btn" style="flex:1; background:#f44336; color:white;">ã¯ã„</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, getDocs, doc, where, onSnapshot, updateDoc, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentStoreId = null;
    let currentStoreName = null;
    let storesData = {};
    let currentOrders = [];
    let currentTableName = null;
    let customModalResolve = null;

    // --- åº—èˆ—ãƒªã‚¹ãƒˆå–å¾— ---
    async function loadStoreList() {
      try {
        const q = query(collection(db, 'stores'), where('isActive', '==', true));
        const snap = await getDocs(q);
        const select = document.getElementById('storeSelect');
        select.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        snap.forEach(doc => {
          const data = doc.data();
          storesData[doc.id] = { name: data.storeName, password: String(data.storePassword) };
          const opt = document.createElement('option');
          opt.value = doc.id; opt.textContent = data.storeName;
          select.appendChild(opt);
        });
      } catch (e) { console.error(e); }
    }

    // --- ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç† ---
    window.handleLogin = () => {
      const id = document.getElementById('storeSelect').value;
      const pass = document.getElementById('passwordInput').value;
      if (!id || !storesData[id]) return alert('åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
      if (pass !== storesData[id].password) return alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
      
      currentStoreId = id;
      currentStoreName = storesData[id].name;
      sessionStorage.setItem('handyStoreId', id);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      showTablesScreen();
    };

    window.handleLogout = () => { sessionStorage.clear(); location.reload(); };

    function showTablesScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('tablesScreen').style.display = 'block';
      document.getElementById('storeNameDisplay').textContent = currentStoreName;
      loadTables();
    }

    // --- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ ---
    async function loadTables() {
      const tSnap = await getDocs(collection(db, 'stores', currentStoreId, 'tables'));
      const grid = document.getElementById('tablesGrid');
      
      onSnapshot(collection(db, 'stores', currentStoreId, 'orders'), (oSnap) => {
        const activeTables = new Set();
        oSnap.forEach(d => {
          const data = d.data();
          // æœªä¼šè¨ˆãƒ»æœªå‰Šé™¤ãƒ»æœªã‚­ãƒ£ãƒ³ã‚»ãƒ«ã®ã‚‚ã®ã‚’åˆ¤å®š
          if (!data.paidAt && !data.deleted && !data.cancelledAt) {
            if (data.tableNumber) activeTables.add(String(data.tableNumber));
          }
        });

        grid.innerHTML = '';
        const tables = [];
        tSnap.forEach(d => tables.push(d.data()));
        tables.sort((a, b) => (a.order || 0) - (b.order || 0) || a.name.localeCompare(b.name));

        tables.forEach(t => {
          const isActive = activeTables.has(String(t.name));
          const card = document.createElement('div');
          card.className = `table-card ${isActive ? 'has-pending-orders' : ''}`;
          card.innerHTML = `
            <div class="table-name">${t.name}</div>
            <div style="font-size:12px; color:#666; margin:5px 0;">${isActive ? 'æœªä¼šè¨ˆã‚ã‚Š' : 'ç©ºå¸­'}</div>
            <button class="checkout-btn" onclick="openCheckoutForTable('${t.name}')">ä¼šè¨ˆ/ç®¡ç†</button>
          `;
          grid.appendChild(card);
        });
      });
    }

    // --- ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« ---
    window.openCheckoutForTable = async (tableName) => {
      currentTableName = tableName;
      // ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã§å–å¾—ã—ã¦ã‹ã‚‰JSã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆç¢ºå®Ÿæ€§ã®ãŸã‚ï¼‰
      const q = query(collection(db, 'stores', currentStoreId, 'orders'), where('tableNumber', '==', String(tableName)));
      const snap = await getDocs(q);
      
      currentOrders = snap.docs
        .map(d => ({id: d.id, ...d.data()}))
        .filter(o => !o.paidAt && !o.deleted && !o.cancelledAt);

      if (currentOrders.length === 0) {
        await showCustomConfirm({ icon: 'ğŸ“‹', title: 'æ³¨æ–‡ãªã—', message: 'æœªä¼šè¨ˆã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“', btnText: 'OK', btnClass: 'success' });
        return;
      }

      document.getElementById('selectedTableLabel2').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ«: ${tableName}`;
      const total = currentOrders.reduce((s, o) => s + (o.totalAmount || 0), 0);
      document.getElementById('finalPaymentAmount').textContent = `Â¥${total.toLocaleString()}`;
      
      const list = document.getElementById('taxRateItemsList');
      list.innerHTML = currentOrders.map(o => {
        let details = (o.items || []).map(i => `<div style="font-size:12px; color:#666; margin-left:10px;">ãƒ»${i.name} Ã—${i.quantity}</div>`).join('');
        return `<div class="tax-item" style="flex-direction:column;">
                  <div style="display:flex; justify-content:space-between; font-weight:bold;">
                    <span>æ³¨æ–‡æ™‚åˆ»: ${o.createdAt ? new Date(o.createdAt.toDate()).toLocaleTimeString('ja-JP', {hour:'2-digit', minute:'2-digit'}) : '-'}</span>
                    <span>Â¥${(o.totalAmount || 0).toLocaleString()}</span>
                  </div>
                  ${details}
                </div>`;
      }).join('');
      
      document.getElementById('paymentModal').classList.remove('hidden');
    };

    // --- å£²ä¸Šå‡¦ç†ï¼ˆPOSé€£æºå¼·åŒ–ï¼‰ ---
    window.completePayment = async (methodKey, methodName) => {
      const confirmed = await showCustomConfirm({ 
        icon: 'ğŸ’°', title: 'ä¼šè¨ˆç¢ºå®š', message: `${methodName}ã§ä¼šè¨ˆã—ã¾ã™ã‹ï¼Ÿ\nå£²ä¸Šã«è¨ˆä¸Šã•ã‚Œã¾ã™ã€‚`, btnClass: 'success' 
      });
      if (!confirmed) return;

      try {
        const now = serverTimestamp();
        let totalSales = 0;
        
        // 1. æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        // POSãŒã€Œstatus: 'paid'ã€ã‚’è¦‹ã¦ã„ã‚‹å¯èƒ½æ€§ãŒé«˜ã„ãŸã‚ã€statusãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚‚æ˜ç¤ºçš„ã«æ›´æ–°
        const updatePromises = currentOrders.map(order => {
          totalSales += (order.totalAmount || 0);
          return updateDoc(doc(db, 'stores', currentStoreId, 'orders', order.id), { 
            paidAt: now, 
            paymentMethod: methodKey, // cash, emoney, credit
            status: 'paid',           // POSãŒã“ã®æ–‡å­—åˆ—ã‚’è¦‹ã¦ã„ã‚‹å ´åˆã«å‚™ãˆã‚‹
            paymentMethodName: methodName // æ—¥æœ¬èªåã‚‚ä¿å­˜
          });
        });
        await Promise.all(updatePromises);
        
        // 2. å£²ä¸Šã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³(sales)ã¸ã®æ›¸ãè¾¼ã¿
        // POSãŒordersé›†è¨ˆã§ã¯ãªãã€salesã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã¦ã„ã‚‹å ´åˆã«å‚™ãˆã‚‹
        await addDoc(collection(db, 'stores', currentStoreId, 'sales'), {
          amount: totalSales,
          method: methodKey,
          methodName: methodName,
          createdAt: now,
          tableName: currentTableName,
          type: 'order',
          count: currentOrders.length
        });

        await showCustomConfirm({ icon: 'âœ…', title: 'å®Œäº†', message: 'ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸ', btnText: 'OK', btnClass: 'success' });
        location.reload();
      } catch (e) {
        console.error(e);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      }
    };

    // --- å‰Šé™¤ ---
    window.deleteOrdersForTable = async () => {
      const confirmed = await showCustomConfirm({ icon: 'ğŸ—‘ï¸', title: 'å‰Šé™¤ç¢ºèª', message: 'æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆå£²ä¸Šã«ã¯è¨ˆä¸Šã•ã‚Œã¾ã›ã‚“ï¼‰' });
      if (!confirmed) return;
      try {
        await Promise.all(currentOrders.map(o => updateDoc(doc(db, 'stores', currentStoreId, 'orders', o.id), { deleted: true })));
        await showCustomConfirm({ icon: 'ğŸ—‘ï¸', title: 'å®Œäº†', message: 'æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', btnText: 'OK', btnClass: 'success' });
        location.reload();
      } catch (e) { alert('å¤±æ•—ã—ã¾ã—ãŸ'); }
    };

    // --- ã‚­ãƒ£ãƒ³ã‚»ãƒ« ---
    window.cancelOrdersForTable = async () => {
      const confirmed = await showCustomConfirm({ icon: 'â¸ï¸', title: 'å–æ¶ˆç¢ºèª', message: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ‰±ã„ã«ã—ã¾ã™ã‹ï¼Ÿ' });
      if (!confirmed) return;
      try {
        const now = serverTimestamp();
        await Promise.all(currentOrders.map(o => updateDoc(doc(db, 'stores', currentStoreId, 'orders', o.id), { cancelledAt: now })));
        await showCustomConfirm({ icon: 'â¸ï¸', title: 'å®Œäº†', message: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ', btnText: 'OK', btnClass: 'success' });
        location.reload();
      } catch (e) { alert('å¤±æ•—ã—ã¾ã—ãŸ'); }
    };

    // --- ãƒ¢ãƒ¼ãƒ€ãƒ«åˆ¶å¾¡ ---
    window.showCustomConfirm = (opt) => {
      return new Promise(res => {
        customModalResolve = res;
        const m = document.getElementById('customConfirmModal');
        document.getElementById('modalIcon').textContent = opt.icon || 'âš ï¸';
        document.getElementById('modalTitle').textContent = opt.title;
        document.getElementById('modalMessage').innerText = opt.message; // æ”¹è¡Œå¯¾å¿œ
        const btn = document.getElementById('modalConfirmBtn');
        btn.textContent = opt.btnText || 'ã¯ã„';
        btn.style.background = opt.btnClass === 'success' ? '#4CAF50' : '#f44336';
        btn.onclick = () => { m.classList.add('hidden'); res(true); };
        m.classList.remove('hidden');
      });
    };
    window.closeCustomModal = () => { document.getElementById('customConfirmModal').classList.add('hidden'); if(customModalResolve) customModalResolve(false); };
    window.closePaymentModal = () => document.getElementById('paymentModal').classList.add('hidden');

    // --- åˆæœŸåŒ– ---
    window.addEventListener('DOMContentLoaded', async () => {
      await loadStoreList();
      const sId = sessionStorage.getItem('handyStoreId');
      if (sId && storesData[sId]) {
        currentStoreId = sId;
        currentStoreName = sessionStorage.getItem('handyStoreName');
        showTablesScreen();
      }
    });
  </script>
</body>
</html>