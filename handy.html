<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </title>
  <!-- ã‚¿ãƒƒãƒ—éŸ³ -->
  <script>
    // AudioContextã‚’ä½¿ç”¨ã—ãŸã‚¿ãƒƒãƒ—éŸ³ç”Ÿæˆ
    let audioContext = null;
    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }
    function playTapSound() {
      initAudio();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    .login-screen {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .login-screen h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 28px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .login-btn:active {
      transform: scale(0.98);
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ */
    .tables-screen {
      display: none;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .header h2 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .header .store-info {
      color: #666;
      font-size: 14px;
    }
    
    .logout-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .table-card {
      background: white;
      border-radius: 15px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    
    .table-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .table-card:active {
      transform: translateY(-2px);
    }
    
    .table-card.has-pending-orders {
      background: linear-gradient(135deg, #fff4e6 0%, #ffe0b2 100%);
      border: 2px solid #ff9800;
    }
    
    .table-card.has-pending-orders .table-name {
      color: #f57c00;
    }
    
    .table-card.has-pending-orders .pending-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff9800;
      color: white;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
    }
    
    .status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
    }
    
    .unpaid-badge {
      background: #f57c00;
      color: white;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }
    
    .table-card .table-name {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .table-card .table-status {
      font-size: 12px;
      color: #999;
    }
    
    .checkout-btn {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .checkout-btn:active {
      transform: scale(0.95);
    }
    
    /* ä¿®æ­£ç®‡æ‰€: hiddenã‚¯ãƒ©ã‚¹ã®å®šç¾©ã‚’æ˜ç¢ºã«ã™ã‚‹ */
    .hidden {
      display: none !important;
    }
    
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }
    
    .custom-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    
    .custom-modal-box {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .modal-icon {
      font-size: 64px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 15px;
      color: #333;
    }
    
    .modal-message {
      text-align: center;
      font-size: 16px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.6;
      white-space: pre-line;
    }
    
    .modal-buttons {
      display: flex;
      gap: 15px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 18px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .modal-btn:active {
      transform: scale(0.95);
    }
    
    .modal-btn-cancel {
      background: #e0e0e0;
      color: #333;
    }
    
    .modal-btn-cancel:hover {
      background: #d0d0d0;
    }
    
    .modal-btn-danger {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
    }
    
    .modal-btn-success {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    /* ä¿®æ­£ç®‡æ‰€: .modal-overlayã®displayè¨­å®šã‚’ä¿®æ­£ */
    .modal-overlay {
      display: flex; /* noneã‹ã‚‰å¤‰æ›´ã€‚è¡¨ç¤ºéè¡¨ç¤ºã¯.hiddenã‚¯ãƒ©ã‚¹ã§åˆ¶å¾¡ã™ã‚‹ */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10001;
      align-items: center;
      justify-content: center;
    }
    
    .modal {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal h3 {
      margin: 0 0 20px 0;
      color: #333;
      font-size: 24px;
      text-align: center;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .payment-methods {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .payment-method-btn {
      padding: 15px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .payment-method-btn:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    
    .payment-method-btn.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .cash-input-section {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    
    .cash-input-section label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    
    .cash-input-section input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 18px;
      text-align: center;
    }
    
    .change-display {
      margin-top: 15px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
    }
    
    .change-amount {
      color: #4CAF50;
      font-size: 20px;
    }
    
    .order-selection-btn {
      width: 100%;
      padding: 20px;
      margin-bottom: 15px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
    }
    
    .order-selection-btn:hover {
      border-color: #667eea;
      background: #f8f9ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .order-selection-btn:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="login-screen" id="loginScreen">
      <h1>ğŸ½ï¸ ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </h1>
      <div id="errorMessage" class="error-message hidden"></div>
      
      <div class="form-group">
        <label for="storeSelect">åº—èˆ—ã‚’é¸æŠ</label>
        <select id="storeSelect">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="passwordInput">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      </div>
      
      <button class="login-btn" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    
    <div class="tables-screen" id="tablesScreen">
      <div class="header">
        <h2 id="storeNameDisplay">åº—èˆ—å</h2>
        <div class="store-info">ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        <button class="logout-btn" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      
      <div class="tables-grid" id="tablesGrid">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>
  
  <div id="customConfirmModal" class="custom-modal-overlay">
    <div class="custom-modal-box">
      <div class="modal-icon" id="modalIcon">âš ï¸</div>
      <div class="modal-title" id="modalTitle">ç¢ºèª</div>
      <div class="modal-message" id="modalMessage">æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeCustomModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-danger" id="modalConfirmBtn" onclick="confirmCustomModal()">å®Ÿè¡Œ</button>
      </div>
    </div>
  </div>
  
  <!-- æ³¨æ–‡é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="orderSelectionModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ“‹ æ³¨æ–‡ã‚’é¸æŠ</h3>
      <p id="orderSelectionTableName" style="color: #666; margin-bottom: 20px; text-align: center; font-size: 18px; font-weight: bold;">ãƒ†ãƒ¼ãƒ–ãƒ«</p>
      <div id="ordersList" style="max-height: 60vh; overflow-y: auto;"></div>
      <div style="margin-top: 20px;">
        <button class="btn btn-secondary" style="width: 100%;" onclick="closeOrderSelectionModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  
  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ’° ä¼šè¨ˆå‡¦ç†</h3>
      <p id="selectedTableLabel2" style="color: #666; margin-bottom: 20px;">ãƒ†ãƒ¼ãƒ–ãƒ«</p>
      
      <div id="taxRateSection" style="margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px; border-left: 4px solid #4CAF50; max-height: 300px; overflow-y: auto;">
        <h4 style="margin: 0 0 15px 0; color: #2e7d32; font-size: 16px;">å„å•†å“ã®ç¨ç‡ã‚’é¸æŠ</h4>
        <div id="taxRateItemsList"></div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #4CAF50; font-weight: bold; font-size: 14px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>8%å¯¾è±¡:</span>
            <span id="tax8Summary" style="color: #FF9800;">Â¥0</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>10%å¯¾è±¡:</span>
            <span id="tax10Summary" style="color: #2196F3;">Â¥0</span>
          </div>
        </div>
      </div>
      
      <div class="payment-methods">
        <button class="payment-method-btn" onclick="selectPaymentMethod('cash')">
          ğŸ’µ ç¾é‡‘
        </button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('emoney')">
          ğŸ“± é›»å­ãƒãƒãƒ¼
        </button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('credit')">
          ğŸ’³ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰
        </button>
      </div>
      
      <div id="cashInputSection" class="cash-input-section hidden">
        <label>ãŠé ã‹ã‚Šé‡‘é¡</label>
        <input type="number" id="cashReceived" placeholder="0" oninput="calculateChange()">
        <div class="change-display" id="changeDisplay">
          ãŠã¤ã‚Š: <span class="change-amount" id="changeAmount">Â¥0</span>
        </div>
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 10px;">
        <label style="font-weight: bold; color: #856404;">å€¤å¼•ãé‡‘é¡</label>
        <input type="number" id="discountAmount" placeholder="0" value="0" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ffc107; border-radius: 8px; margin-top: 8px;" oninput="updatePaymentTotal()">
        <div style="text-align: center; margin-top: 10px; font-size: 18px; font-weight: bold; color: #333;">
          è«‹æ±‚é¡: <span id="finalPaymentAmount" style="color: #4CAF50;">Â¥0</span>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;" id="mainButtons">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="processPayment()" id="paymentBtn" disabled>ğŸ’° ä¼šè¨ˆ</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white;" onclick="completeOrdersForTable()">âœ… å®Œäº†</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white;" onclick="cancelOrdersForTable()">â¸ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="deleteOrdersForTable()">ğŸ—‘ï¸ å‰Šé™¤</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closePaymentModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <div id="priceChangeModal" class="modal-overlay hidden">
    <div class="modal">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 50px; margin-bottom: 10px;">ğŸ’´</div>
        <h3 style="margin: 0; font-size: 20px; color: #333;" id="priceChangeTitle">é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h3>
      </div>
      
      <div style="background: #f5f5f5; border-radius: 10px; padding: 15px; margin: 20px 0; text-align: center;">
        <div style="color: #666; margin-bottom: 10px;" id="priceChangeItemInfo"></div>
        <div style="font-size: 18px; font-weight: bold; color: #333;">
          ç¾åœ¨: <span id="priceChangeCurrentPrice"></span>
        </div>
      </div>
      
      <div style="margin: 20px 0;">
        <input type="number" id="priceChangeInput" placeholder="æ–°ã—ã„é‡‘é¡ã‚’å…¥åŠ›" style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 24px; text-align: center;">
      </div>
      
      <input type="hidden" id="priceChangeItemId">
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="closePriceChangeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="confirmPriceChange()">âœ“ å¤‰æ›´</button>
      </div>
    </div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, getDocs, doc, getDoc, setDoc, where, onSnapshot, updateDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.onSnapshot = onSnapshot;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.Timestamp = Timestamp;
    
    // åº—èˆ—åˆ¥ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§ã‚’å–å¾—
    window.getStoreCollection = function(collectionName) {
      console.log('ğŸ” HANDY getStoreCollectionå‘¼ã³å‡ºã—');
      console.log('   ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å:', collectionName);
      console.log('   window.currentStoreId:', window.currentStoreId);
      console.log('   typeof:', typeof window.currentStoreId);
      
      // currentStoreIdãŒnullã¾ãŸã¯ç©ºã®å ´åˆã¯æ—§ãƒ‘ã‚¹ã‚’ä½¿ç”¨
      if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
        const oldPathMap = {
          "menus": "menu",
          "employees": "kintai_employees",
          "attendance": "kintai_attendance",
          "orders": "orders",
          "tables": "tables"
        };
        const path = oldPathMap[collectionName] || collectionName;
        console.log('   â†’ æ—§ãƒ‘ã‚¹ä½¿ç”¨:', path);
        return collection(db, path);
      }
      console.log('   â†’ æ–°ãƒ‘ã‚¹ä½¿ç”¨: stores/' + window.currentStoreId + '/' + collectionName);
      return collection(db, "stores", window.currentStoreId, collectionName);
    };

    // åº—èˆ—åˆ¥ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ã‚’å–å¾—
    window.getStoreDoc = function(collectionName, docId) {
      console.log('ğŸ” HANDY getStoreDocå‘¼ã³å‡ºã—');
      console.log('   ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å:', collectionName, 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID:', docId);
      console.log('   window.currentStoreId:', window.currentStoreId);
      
      // currentStoreIdãŒnullã¾ãŸã¯ç©ºã®å ´åˆã¯æ—§ãƒ‘ã‚¹ã‚’ä½¿ç”¨
      if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
        const oldPathMap = {
          "menus": "menu",
          "employees": "kintai_employees",
          "attendance": "kintai_attendance",
          "orders": "orders",
          "tables": "tables"
        };
        const path = oldPathMap[collectionName] || collectionName;
        console.log('   â†’ æ—§ãƒ‘ã‚¹ä½¿ç”¨:', path + '/' + docId);
        return doc(db, path, docId);
      }
      console.log('   â†’ æ–°ãƒ‘ã‚¹ä½¿ç”¨: stores/' + window.currentStoreId + '/' + collectionName + '/' + docId);
      return doc(db, "stores", window.currentStoreId, collectionName, docId);
    };
    
    console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†');
    
    window.firebaseReady = true;
    window.dispatchEvent(new Event('firebaseReady'));
  </script>
  
  <script>
    let currentStoreId = null;
    let currentStoreName = null;
    let storesData = {};
    let ordersListener = null;
    let currentOrders = [];
    
    let selectedPaymentMethod = null;
    let totalAmountToPay = 0;
    let cashReceived = 0;
    let changeAmount = 0;
    let customModalResolve = null;
    
    function showCustomConfirm(options) {
      return new Promise((resolve) => {
        customModalResolve = resolve;
        const modal = document.getElementById('customConfirmModal');
        const icon = document.getElementById('modalIcon');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        
        icon.textContent = options.icon || 'âš ï¸';
        title.textContent = options.title || 'ç¢ºèª';
        message.textContent = options.message || 'æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ';
        
        confirmBtn.className = 'modal-btn ' + (options.btnClass || 'modal-btn-danger');
        confirmBtn.textContent = options.btnText || 'å®Ÿè¡Œ';
        
        modal.style.display = 'flex';
      });
    }
    
    function closeCustomModal() {
      document.getElementById('customConfirmModal').style.display = 'none';
      if (customModalResolve) {
        customModalResolve(false);
        customModalResolve = null;
      }
    }
    
    function confirmCustomModal() {
      document.getElementById('customConfirmModal').style.display = 'none';
      if (customModalResolve) {
        customModalResolve(true);
        customModalResolve = null;
      }
    }
    
    async function loadStoreList() {
      try {
        const storesQuery = window.query(
          window.collection(window.db, 'stores'),
          window.where('isActive', '==', true)
        );
        const storesSnapshot = await window.getDocs(storesQuery);
        const storeSelect = document.getElementById('storeSelect');
        
        storeSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        storesData = {};
        
        storesSnapshot.forEach(doc => {
          const storeData = doc.data();
          const storeId = doc.id;
          const storeName = storeData.storeName || doc.id;
          const password = storeData.storePassword || '';
          
          storesData[storeId] = {
            storeName: storeName,
            password: String(password),
            isActive: true
          };
          
          const option = document.createElement('option');
          option.value = storeId;
          option.textContent = storeName;
          storeSelect.appendChild(option);
        });
      } catch (error) {
        console.error('âŒ åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        showError('åº—èˆ—ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
    
    window.handleLogin = async function() {
      playTapSound();
      const storeSelect = document.getElementById('storeSelect');
      const passwordInput = document.getElementById('passwordInput');
      const storeId = storeSelect.value;
      const inputPassword = passwordInput.value.trim();
      
      if (!storeId) {
        showError('åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      if (!inputPassword) {
        showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      const storeInfo = storesData[storeId];
      if (inputPassword !== storeInfo.password) {
        showError('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      currentStoreId = storeId;
      window.currentStoreId = storeId; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦è¨­å®š
      currentStoreName = storeInfo.storeName;
      sessionStorage.setItem('handyStoreId', storeId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log('ğŸ“ HANDY åº—èˆ—IDè¨­å®šå®Œäº†');
      console.log('   currentStoreId:', currentStoreId);
      console.log('   window.currentStoreId:', window.currentStoreId);
      console.log('   currentStoreName:', currentStoreName);
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      
      showTablesScreen();
    };
    
    window.handleLogout = async function() {
      playTapSound();
      const confirmed = await showCustomConfirm({
        icon: 'ğŸšª',
        title: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
        message: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ',
        btnClass: 'modal-btn-danger',
        btnText: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ'
      });
      
      if (confirmed) {
        if (ordersListener) ordersListener();
        sessionStorage.removeItem('handyStoreId');
        sessionStorage.removeItem('handyStoreName');
        location.reload();
      }
    };
    
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => errorDiv.classList.add('hidden'), 3000);
    }
    
    async function showTablesScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('tablesScreen').style.display = 'block';
      document.getElementById('tablesScreen').classList.remove('hidden');
      document.getElementById('storeNameDisplay').textContent = currentStoreName;
      
      await loadTables();
      startOrdersListener();
    }
    
    function startOrdersListener() {
      if (ordersListener) ordersListener();
      const ordersRef = window.getStoreCollection('orders');
      ordersListener = window.onSnapshot(ordersRef, (snapshot) => {
        updateTableStatus(snapshot);
      });
    }
    
    function updateTableStatus(ordersSnapshot) {
      const unpaidTables = new Set();  // æ³¨æ–‡ã‚ã‚Šï¼ˆæœªä¼šè¨ˆï¼‰
      const completedUnpaidTables = new Set();  // å®Œäº†æ¸ˆã¿ã ãŒæœªä¼šè¨ˆ
      const hasIncompleteOrders = new Set();  // æœªå®Œäº†ã®æ³¨æ–‡ãŒã‚ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«
      
      console.log('ğŸ”„ ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°é–‹å§‹');
      
      ordersSnapshot.forEach(doc => {
        const order = doc.data();
        console.log('ğŸ“‹ æ³¨æ–‡ãƒã‚§ãƒƒã‚¯:', {
          id: doc.id,
          table: order.tableNumber,
          deleted: order.deleted,
          cancelled: !!order.cancelledAt,
          paid: !!order.paidAt,
          completed: !!order.completedAt
        });
        
        if (order.tableNumber && !order.deleted && !order.cancelledAt) {
          // ä¼šè¨ˆæ¸ˆã¿ã§ãªã„æ³¨æ–‡
          if (!order.paidAt) {
            unpaidTables.add(order.tableNumber);
            
            // å®Œäº†æ¸ˆã¿ã ãŒæœªä¼šè¨ˆ
            if (order.completedAt) {
              completedUnpaidTables.add(order.tableNumber);
              console.log('âš ï¸ æœªä¼šè¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ç™ºè¦‹:', order.tableNumber);
            } else {
              // æœªå®Œäº†ã®æ³¨æ–‡ãŒã‚ã‚‹
              hasIncompleteOrders.add(order.tableNumber);
              console.log('ğŸ“ æœªå®Œäº†æ³¨æ–‡ã‚ã‚Š:', order.tableNumber);
            }
          }
        }
      });
      
      console.log('ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é›†è¨ˆ:', {
        æœªä¼šè¨ˆãƒ†ãƒ¼ãƒ–ãƒ«: Array.from(completedUnpaidTables),
        æ³¨æ–‡ã‚ã‚Šãƒ†ãƒ¼ãƒ–ãƒ«: Array.from(unpaidTables),
        æœªå®Œäº†æ³¨æ–‡ã‚ã‚Š: Array.from(hasIncompleteOrders)
      });
      
      document.querySelectorAll('.table-card').forEach(card => {
        const tableName = card.getAttribute('data-table-name');
        
        // æ—¢å­˜ã®ãƒãƒƒã‚¸ã‚’ã™ã¹ã¦å‰Šé™¤
        card.querySelectorAll('.pending-badge, .status-badge, .unpaid-badge').forEach(badge => badge.remove());
        
        if (unpaidTables.has(tableName)) {
          // æ³¨æ–‡ã‚ã‚Š â†’ èƒŒæ™¯ã‚’ã‚ªãƒ¬ãƒ³ã‚¸ã«
          card.classList.add('has-pending-orders');
          
          // ã€Œæ³¨æ–‡ã‚ã‚Šã€ãƒãƒƒã‚¸ã‚’è¿½åŠ ï¼ˆæœªå®Œäº†ã®æ³¨æ–‡ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
          if (hasIncompleteOrders.has(tableName)) {
            const orderBadge = document.createElement('div');
            orderBadge.className = 'pending-badge';
            orderBadge.textContent = 'æ³¨æ–‡ã‚ã‚Š';
            orderBadge.style.cssText = 'position: absolute; top: 10px; right: 10px; background: #ff9800; color: white; font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: bold;';
            card.appendChild(orderBadge);
            console.log('âœ… æ³¨æ–‡ã‚ã‚Šãƒãƒƒã‚¸è¿½åŠ :', tableName);
          }
          
          // ã€Œæœªä¼šè¨ˆã€ãƒãƒƒã‚¸ã‚’è¿½åŠ ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
          const unpaidBadge = document.createElement('div');
          unpaidBadge.className = 'unpaid-badge';
          unpaidBadge.textContent = 'æœªä¼šè¨ˆ';
          unpaidBadge.style.cssText = 'position: absolute; top: 10px; left: 10px; background: #f57c00; color: white; font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: bold; animation: pulse 2s infinite;';
          card.appendChild(unpaidBadge);
          console.log('âœ… æœªä¼šè¨ˆãƒãƒƒã‚¸è¿½åŠ :', tableName);
        } else {
          // ç©ºå¸­ â†’ ãƒãƒƒã‚¸ãªã—
          card.classList.remove('has-pending-orders');
          console.log('â„¹ï¸ ç©ºå¸­:', tableName);
        }
      });
    }
    
    async function loadTables() {
      try {
        const tablesGrid = document.getElementById('tablesGrid');
        tablesGrid.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
        
        const tablesRef = window.getStoreCollection('tables');
        const tablesSnapshot = await window.getDocs(tablesRef);
        const tables = [];
        
        tablesSnapshot.forEach(doc => {
          tables.push({ id: doc.id, ...doc.data() });
        });
        
        tables.sort((a, b) => (a.order || 0) - (b.order || 0) || a.name.localeCompare(b.name));
        
        if (tables.length === 0) {
          tablesGrid.innerHTML = '<div style="color: white; text-align: center; padding: 40px;">ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
          return;
        }
        
        tablesGrid.innerHTML = '';
        tables.forEach(table => {
          const tableCard = document.createElement('div');
          tableCard.className = 'table-card';
          tableCard.setAttribute('data-table-name', table.name);
          tableCard.innerHTML = `
            <div class="table-name">${table.name}</div>
            <div class="table-status">ã‚¿ãƒƒãƒ—ã—ã¦æ³¨æ–‡</div>
          `;
          
          // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰è‡ªä½“ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã¨ãã«ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã«é·ç§»
          tableCard.onclick = () => { 
            playTapSound(); 
            openMenu(table.name); 
          };
          
          const menuBtn = document.createElement('button');
          menuBtn.className = 'checkout-btn';
          menuBtn.textContent = 'ğŸ“± ãƒ¡ãƒ‹ãƒ¥ãƒ¼';
          menuBtn.style.background = '#667eea';
          menuBtn.onclick = (e) => { e.stopPropagation(); playTapSound(); openMenu(table.name); };
          tableCard.appendChild(menuBtn);
          
          const checkoutBtn = document.createElement('button');
          checkoutBtn.className = 'checkout-btn';
          checkoutBtn.textContent = 'ğŸ’° ä¼šè¨ˆ';
          checkoutBtn.onclick = (e) => { e.stopPropagation(); playTapSound(); openCheckoutForTable(table.name); };
          tableCard.appendChild(checkoutBtn);
          
          tablesGrid.appendChild(tableCard);
        });
      } catch (error) {
        console.error('âŒ ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    function openMenu(tableName) {
      console.log('ğŸ½ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã:', {
        tableName: tableName,
        currentStoreId: currentStoreId,
        currentStoreName: currentStoreName
      });
      
      // åº—èˆ—IDã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ï¼ˆmenu.htmlã§ä½¿ç”¨ï¼‰
      sessionStorage.setItem('handyStoreId', currentStoreId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      sessionStorage.setItem('handyTableName', tableName);
      
      const menuUrl = `menu.html?table=${encodeURIComponent(tableName)}&store=${currentStoreId}&mode=handy`;
      console.log('ğŸ“± é·ç§»å…ˆURL:', menuUrl);
      window.location.href = menuUrl;
    }
    
    async function openCheckoutForTable(tableName) {
      try {
        const ordersRef = window.getStoreCollection('orders');
        const ordersQuery = window.query(ordersRef, window.where('tableNumber', '==', String(tableName)));
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        currentOrders = [];
        ordersSnapshot.forEach(doc => {
          const order = { id: doc.id, ...doc.data() };
          if (!order.deleted && !order.cancelledAt && !order.paidAt) {
            currentOrders.push(order);
          }
        });
        
        // æ³¨æ–‡ç•ªå·ã§ã‚½ãƒ¼ãƒˆ
        currentOrders.sort((a, b) => (a.orderNumber || 0) - (b.orderNumber || 0));
        
        if (currentOrders.length === 0) {
          await showCustomAlert({ icon: 'ğŸ“‹', title: 'æ³¨æ–‡ãªã—', message: `${tableName}\nã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¯æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“`, btnClass: 'modal-btn-success' });
          return;
        }
        
        // è¤‡æ•°æ³¨æ–‡ãŒã‚ã‚‹å ´åˆã¯é¸æŠç”»é¢ã‚’è¡¨ç¤º
        if (currentOrders.length > 1) {
          showOrderSelectionModal(tableName);
        } else {
          showCheckoutMenu(tableName, [currentOrders[0]]);
        }
      } catch (error) {
        console.error('âŒ ä¼šè¨ˆç”»é¢è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // æ³¨æ–‡é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showOrderSelectionModal(tableName) {
      const modal = document.getElementById('orderSelectionModal');
      document.getElementById('orderSelectionTableName').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${tableName}`;
      
      const ordersList = document.getElementById('ordersList');
      ordersList.innerHTML = '';
      
      // å…¨æ³¨æ–‡ã¾ã¨ã‚ã¦ä¼šè¨ˆãƒœã‚¿ãƒ³
      const allOrdersBtn = document.createElement('button');
      allOrdersBtn.className = 'order-selection-btn';
      allOrdersBtn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
      allOrdersBtn.style.color = 'white';
      allOrdersBtn.style.fontWeight = 'bold';
      
      // æœªå®Œäº†ã¨å®Œäº†æ¸ˆã¿ã®ä»¶æ•°ã‚’è¨ˆç®—
      const incompleteCount = currentOrders.filter(o => !o.completedAt).length;
      const completeCount = currentOrders.filter(o => o.completedAt).length;
      const statusText = incompleteCount > 0 && completeCount > 0 
        ? ` (æœªå®Œäº† ${incompleteCount}ä»¶ / å®Œäº†æ¸ˆã¿ ${completeCount}ä»¶)`
        : incompleteCount > 0 
        ? ` (æœªå®Œäº† ${incompleteCount}ä»¶)`
        : completeCount > 0 
        ? ` (å®Œäº†æ¸ˆã¿ ${completeCount}ä»¶)`
        : '';
      
      allOrdersBtn.innerHTML = `
        <div style="font-size: 20px; margin-bottom: 8px;">ğŸ“‹ å…¨æ³¨æ–‡ã¾ã¨ã‚ã¦ä¼šè¨ˆ</div>
        <div style="font-size: 16px;">åˆè¨ˆ ${currentOrders.length} ä»¶${statusText} - Â¥${currentOrders.reduce((sum, o) => sum + (o.totalAmount || 0), 0).toLocaleString()}</div>
      `;
      allOrdersBtn.onclick = () => {
        modal.classList.add('hidden');
        showCheckoutMenu(tableName, currentOrders);
      };
      ordersList.appendChild(allOrdersBtn);
      
      // å€‹åˆ¥æ³¨æ–‡ãƒœã‚¿ãƒ³
      currentOrders.forEach((order, index) => {
        const orderBtn = document.createElement('button');
        orderBtn.className = 'order-selection-btn';
        orderBtn.style.position = 'relative';  // ãƒãƒƒã‚¸ã®é…ç½®ã®ãŸã‚
        
        const itemsText = order.items && Array.isArray(order.items)
          ? order.items.map(item => `${item.name} x${item.quantity || 1}`).join(', ')
          : 'æ³¨æ–‡å†…å®¹ãªã—';
        
        // æœªå®Œäº†ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯
        const isIncomplete = !order.completedAt;
        const statusBadge = isIncomplete 
          ? '<span style="position: absolute; top: 10px; right: 10px; background: #ff9800; color: white; font-size: 11px; padding: 4px 10px; border-radius: 12px; font-weight: bold;">æœªå®Œäº†</span>'
          : '<span style="position: absolute; top: 10px; right: 10px; background: #4CAF50; color: white; font-size: 11px; padding: 4px 10px; border-radius: 12px; font-weight: bold;">å®Œäº†æ¸ˆã¿</span>';
        
        orderBtn.innerHTML = `
          ${statusBadge}
          <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;">æ³¨æ–‡ #${order.orderNumber || (index + 1)}</div>
          <div style="font-size: 14px; color: #666; margin-bottom: 8px;">${itemsText}</div>
          <div style="font-size: 16px; color: #4CAF50; font-weight: bold;">Â¥${(order.totalAmount || 0).toLocaleString()}</div>
        `;
        orderBtn.onclick = () => {
          modal.classList.add('hidden');
          showCheckoutMenu(tableName, [order]);
        };
        ordersList.appendChild(orderBtn);
      });
      
      modal.classList.remove('hidden');
    }
    
    window.closeOrderSelectionModal = function() {
      document.getElementById('orderSelectionModal').classList.add('hidden');
    };
    
    function showCheckoutMenu(tableName, selectedOrders = null) {
      // selectedOrdersãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ç”¨ã€ãªã‘ã‚Œã°currentOrderså…¨ã¦
      const ordersToCheckout = selectedOrders || currentOrders;
      
      totalAmountToPay = ordersToCheckout.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      const paymentModal = document.getElementById('paymentModal');
      paymentModal.classList.remove('hidden');
      
      // æ³¨æ–‡ç•ªå·ã‚’è¡¨ç¤º
      let orderNumbersText = '';
      if (ordersToCheckout.length === 1) {
        orderNumbersText = ` - æ³¨æ–‡ #${ordersToCheckout[0].orderNumber || '1'}`;
      } else if (ordersToCheckout.length > 1) {
        const orderNums = ordersToCheckout.map(o => `#${o.orderNumber || '?'}`).join(', ');
        orderNumbersText = ` - ${orderNums}`;
      }
      
      document.getElementById('selectedTableLabel2').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${tableName}${orderNumbersText}`;
      
      // é¸æŠã•ã‚ŒãŸæ³¨æ–‡ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ï¼ˆä¼šè¨ˆå‡¦ç†ã§ä½¿ç”¨ï¼‰
      window.ordersToCheckout = ordersToCheckout;
      
      generateTaxRateItems(ordersToCheckout, tableName);
      document.getElementById('discountAmount').value = 0;
      updatePaymentTotal();
      
      selectedPaymentMethod = null;
      document.querySelectorAll('.payment-method-btn').forEach(btn => btn.classList.remove('selected'));
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('paymentBtn').disabled = true;
    }
    
    window.closePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
    };
    
    function generateTaxRateItems(ordersToProcess = null, tableName = '') {
      const container = document.getElementById('taxRateItemsList');
      container.innerHTML = '';
      let itemIndex = 0;
      
      const orders = ordersToProcess || currentOrders;
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«åãŒã€Œãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã€ã€Œãƒ¢ãƒã‚¤ãƒ«ã‚ªãƒ¼ãƒ€ãƒ¼ã€ã€Œäºˆç´„ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã€ã€Œäºˆç´„ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ2ã€ã®å ´åˆã¯8%ã€ãã‚Œä»¥å¤–ã¯10%
      const isTakeoutOrMobile = tableName.includes('ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ') || tableName.includes('ãƒ¢ãƒã‚¤ãƒ«ã‚ªãƒ¼ãƒ€ãƒ¼') || tableName.includes('äºˆç´„ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ');
      const defaultTaxRate = isTakeoutOrMobile ? 8 : 10;
      
      orders.forEach(order => {
        if (!order.items || order.items.length === 0) {
          addTaxRateItem(container, `æ³¨æ–‡ #${order.orderNumber}`, 1, order.totalAmount || 0, itemIndex, defaultTaxRate, 'inclusive');
          itemIndex++;
        } else {
          order.items.forEach(item => {
            const toppingStr = item.toppings || item.toppingDetails || 'ãªã—';
            // ğŸ†• å¤–ç¨ã®å ´åˆã¯æœ¬ä½“ä¾¡æ ¼ã€å†…ç¨ã®å ´åˆã¯ç¨è¾¼ä¾¡æ ¼
            const itemBasePrice = item.price + (item.toppingPrice || 0);
            const itemTotal = itemBasePrice * item.quantity;
            
            // ğŸ†• å•†å“ã®taxRateã‚’å„ªå…ˆã€ãªã‘ã‚Œã°ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
            const itemTaxRate = (item.taxRate !== undefined && item.taxRate !== null) ? item.taxRate : defaultTaxRate;
            
            // ğŸ†• taxTypeã‚’æ¸¡ã™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å†…ç¨ï¼‰
            addTaxRateItem(container, `${item.name} (${toppingStr})`, item.quantity, itemTotal, itemIndex, itemTaxRate, item.taxType || 'inclusive');
            itemIndex++;
          });
          if (order.bagNeeded && order.bagQuantity > 0) {
            addTaxRateItem(container, 'ğŸ›ï¸ ãƒ¬ã‚¸è¢‹', order.bagQuantity, order.bagPrice || (order.bagQuantity * 3), itemIndex, 10, 'inclusive');
            itemIndex++;
          }
        }
      });
      calculateTaxSummary();
    }
    
    function addTaxRateItem(container, itemName, quantity, itemTotal, index, defaultTaxRate, taxType = 'inclusive') {
      // ğŸ†• å¤–ç¨ã®å ´åˆã¯ç¨è¾¼ä¾¡æ ¼ã‚’è¨ˆç®—ï¼ˆitemTotalã¯æœ¬ä½“ä¾¡æ ¼ï¼‰
      let displayTotal = itemTotal;
      if (taxType === 'exclusive') {
        // å¤–ç¨ã®å ´åˆã€itemTotalã¯æœ¬ä½“ä¾¡æ ¼ãªã®ã§ç¨ã‚’åŠ ç®—
        displayTotal = itemTotal + Math.floor(itemTotal * (defaultTaxRate / 100));
        console.log(`ğŸ†• å¤–ç¨è¨ˆç®—: æœ¬ä½“${itemTotal}å†† + ç¨${Math.floor(itemTotal * (defaultTaxRate / 100))}å†† â†’ ${displayTotal}å††ï¼ˆç¨ç‡${defaultTaxRate}%ï¼‰`);
      }
      
      const itemDiv = document.createElement('div');
      itemDiv.style.cssText = 'padding: 10px; margin-bottom: 8px; background: white; border-radius: 6px; border: 1px solid #ddd;';
      
      const headerDiv = document.createElement('div');
      headerDiv.style.cssText = 'display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; font-size: 14px; cursor: pointer;';
      headerDiv.innerHTML = `<span>${itemName} Ã—${quantity}</span><span style="color: #667eea;" id="itemPrice${index}">Â¥${displayTotal.toLocaleString()}</span>`;
      
      headerDiv.onclick = function() {
        document.getElementById('priceChangeTitle').textContent = itemName;
        document.getElementById('priceChangeCurrentPrice').textContent = `Â¥${displayTotal.toLocaleString()}`;
        document.getElementById('priceChangeInput').value = displayTotal;
        document.getElementById('priceChangeItemId').value = index;
        document.getElementById('priceChangeModal').classList.remove('hidden');
      };
      
      const radioDiv = document.createElement('div');
      radioDiv.style.cssText = 'display: flex; gap: 10px; justify-content: center;';
      
      const radio8 = createRadio(index, 8, displayTotal, defaultTaxRate === 8, itemTotal, taxType);
      const radio10 = createRadio(index, 10, displayTotal, defaultTaxRate === 10, itemTotal, taxType);
      
      radioDiv.appendChild(createRadioLabel(radio8, '8%æŒã¡å¸°ã‚Š', '#fff3e0', '#FF9800'));
      radioDiv.appendChild(createRadioLabel(radio10, '10%åº—å†…', '#e3f2fd', '#2196F3'));
      
      itemDiv.appendChild(headerDiv);
      itemDiv.appendChild(radioDiv);
      container.appendChild(itemDiv);
    }
    
    function createRadio(index, rate, amount, checked, baseAmount = null, taxType = 'inclusive') {
      const radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = `taxRate${index}`;
      radio.value = rate;
      radio.checked = checked;
      radio.dataset.amount = amount;
      radio.dataset.taxType = taxType;  // ğŸ†• taxTypeã‚’ä¿å­˜
      radio.dataset.baseAmount = baseAmount || amount;  // ğŸ†• æœ¬ä½“ä¾¡æ ¼ã‚’ä¿å­˜
      radio.style.marginRight = '5px';
      
      // ğŸ†• å¤–ç¨ã®å ´åˆã¯ç¨ç‡å¤‰æ›´æ™‚ã«é‡‘é¡ã‚’å†è¨ˆç®—
      radio.onchange = function() {
        if (taxType === 'exclusive') {
          const newAmount = parseInt(radio.dataset.baseAmount) + Math.floor(parseInt(radio.dataset.baseAmount) * (rate / 100));
          // åŒã˜ã‚°ãƒ«ãƒ¼ãƒ—ã®å…¨ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®amountã‚’æ›´æ–°
          document.querySelectorAll(`input[name="taxRate${index}"]`).forEach(r => {
            r.dataset.amount = newAmount;
          });
          document.getElementById('itemPrice' + index).textContent = 'Â¥' + newAmount.toLocaleString();
          console.log(`ğŸ”„ å¤–ç¨${rate}%ã«å¤‰æ›´: ${radio.dataset.baseAmount}å†† â†’ ${newAmount}å††`);
        }
        calculateTaxSummary();
      };
      
      return radio;
    }
    
    function createRadioLabel(radio, text, bg, border) {
      const label = document.createElement('label');
      label.style.cssText = `flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 6px 10px; border-radius: 4px; background: ${bg}; border: 2px solid ${border}; font-size: 13px;`;
      label.appendChild(radio);
      label.appendChild(document.createTextNode(text));
      return label;
    }
    
    function calculateTaxSummary() {
      let tax8 = 0, tax10 = 0;
      document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked').forEach(r => {
        if (r.value === '8') tax8 += parseFloat(r.dataset.amount);
        else tax10 += parseFloat(r.dataset.amount);
      });
      document.getElementById('tax8Summary').textContent = 'Â¥' + tax8.toLocaleString();
      document.getElementById('tax10Summary').textContent = 'Â¥' + tax10.toLocaleString();
      updatePaymentTotal();
    }
    
    window.updatePaymentTotal = function() {
      let total = 0;
      document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked').forEach(r => total += parseFloat(r.dataset.amount));
      const final = Math.max(0, total - (parseInt(document.getElementById('discountAmount').value) || 0));
      totalAmountToPay = final;
      document.getElementById('finalPaymentAmount').textContent = 'Â¥' + final.toLocaleString();
      if (selectedPaymentMethod === 'cash') calculateChange();
    };
    
    window.selectPaymentMethod = function(method) {
      playTapSound();
      selectedPaymentMethod = method;
      document.querySelectorAll('.payment-method-btn').forEach(btn => btn.classList.toggle('selected', btn.innerText.includes(method === 'cash' ? 'ç¾é‡‘' : method === 'emoney' ? 'é›»å­' : 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ')));
      document.getElementById('cashInputSection').classList.toggle('hidden', method !== 'cash');
      document.getElementById('paymentBtn').disabled = method === 'cash';
    };
    
    window.calculateChange = function() {
      cashReceived = parseInt(document.getElementById('cashReceived').value) || 0;
      changeAmount = cashReceived - totalAmountToPay;
      document.getElementById('changeAmount').textContent = `Â¥${changeAmount.toLocaleString()}`;
      document.getElementById('paymentBtn').disabled = cashReceived < totalAmountToPay;
    };
    
    window.confirmPriceChange = function() {
      const itemId = document.getElementById('priceChangeItemId').value;
      const newPrice = parseFloat(document.getElementById('priceChangeInput').value) || 0;
      document.querySelectorAll(`input[name="taxRate${itemId}"]`).forEach(r => r.dataset.amount = newPrice);
      document.getElementById(`itemPrice${itemId}`).textContent = 'Â¥' + newPrice.toLocaleString();
      calculateTaxSummary();
      document.getElementById('priceChangeModal').classList.add('hidden');
    };
    
    window.closePriceChangeModal = function() {
      document.getElementById('priceChangeModal').classList.add('hidden');
    };

    // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆOK ãƒœã‚¿ãƒ³ã®ã¿ï¼‰
    function showCustomAlert(options) {
      return new Promise((resolve) => {
        const modal = document.getElementById('customConfirmModal');
        const icon = document.getElementById('modalIcon');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const buttonsContainer = document.querySelector('.modal-buttons');
        
        icon.textContent = options.icon || 'â„¹ï¸';
        title.textContent = options.title || 'ãŠçŸ¥ã‚‰ã›';
        message.textContent = options.message || '';
        
        buttonsContainer.innerHTML = `
          <button class="modal-btn ${options.btnClass || 'modal-btn-primary'}" onclick="closeCustomAlert()">${options.btnText || 'OK'}</button>
        `;
        
        window.closeCustomAlert = function() {
          modal.style.display = 'none';
          resolve(true);
        };
        
        modal.style.display = 'flex';
      });
    }

    // ä¼šè¨ˆå‡¦ç†ï¼ˆå£²ä¸Šãƒ»å®¢æ•°ã‚’POSã«åæ˜ ï¼‰- ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§å®Œçµ
    window.processPayment = async function() {
      playTapSound();
      
      if (!selectedPaymentMethod) {
        await showCustomAlert({ icon: 'âš ï¸', title: 'ã‚¨ãƒ©ãƒ¼', message: 'æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„', btnClass: 'modal-btn-danger' });
        return;
      }
      
      if (selectedPaymentMethod === 'cash' && cashReceived < totalAmountToPay) {
        await showCustomAlert({ icon: 'âš ï¸', title: 'ã‚¨ãƒ©ãƒ¼', message: 'ãŠé ã‹ã‚Šé‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™', btnClass: 'modal-btn-danger' });
        return;
      }
      
      try {
        const now = window.Timestamp.now();
        
        // window.ordersToCheckoutã‹ã‚‰ä¼šè¨ˆå¯¾è±¡ã®æ³¨æ–‡ã‚’å–å¾—
        const ordersToProcess = window.ordersToCheckout || currentOrders;
        
        // å€¤å¼•ãé‡‘é¡ã‚’å–å¾—
        const discountAmount = parseInt(document.getElementById('discountAmount').value) || 0;
        
        // ç¨ç‡åˆ¥é›†è¨ˆ
        let tax8Total = 0;
        let tax10Total = 0;
        const radios = document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked');
        radios.forEach(radio => {
          const amount = parseFloat(radio.dataset.amount) || 0;
          const taxRate = radio.value;
          if (taxRate === '8') {
            tax8Total += amount;
          } else if (taxRate === '10') {
            tax10Total += amount;
          }
        });
        
        // å€¤å¼•ãå¾Œã®é‡‘é¡ï¼ˆtotalAmountToPayã¯æ—¢ã«å€¤å¼•ãå¾Œï¼‰
        const totalBeforeDiscount = tax8Total + tax10Total;
        
        // å•†å“ç‚¹æ•°ã‚’è¨ˆç®—
        let itemCount = 0;
        ordersToProcess.forEach(order => {
          if (order.items && Array.isArray(order.items)) {
            order.items.forEach(item => {
              itemCount += item.quantity || 0;
            });
          } else {
            itemCount += 1;
          }
        });
        
        console.log('ğŸ’° ä¼šè¨ˆå‡¦ç†é–‹å§‹:', {
          totalAmount: totalAmountToPay,
          å€¤å¼•ãå‰é‡‘é¡: totalBeforeDiscount,
          å€¤å¼•ãé‡‘é¡: discountAmount,
          å€¤å¼•ãå¾Œé‡‘é¡: totalAmountToPay,
          paymentMethod: selectedPaymentMethod,
          itemCount: itemCount,
          tax8Total: tax8Total,
          tax10Total: tax10Total,
          customerCount: 1,
          ordersCount: ordersToProcess.length,
          storeId: currentStoreId
        });
        
        // æ”¯æ‰•ã„æ–¹æ³•ã‚’æ—¥æœ¬èªã«å¤‰æ›
        let paymentMethodJP = 'ç¾é‡‘';
        if (selectedPaymentMethod === 'emoney') paymentMethodJP = 'é›»å­ãƒãƒãƒ¼';
        else if (selectedPaymentMethod === 'credit') paymentMethodJP = 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰';
        
        // Firestoreã®æ³¨æ–‡ã«paidAtã€completedAtã€deletedãƒ•ãƒ©ã‚°ã‚’è¨­å®šï¼ˆä¼šè¨ˆå®Œäº†ã§å‰Šé™¤ï¼‰
        for (const order of ordersToProcess) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          await window.updateDoc(orderRef, {
            paidAt: now,
            completedAt: now,
            deleted: true,  // ä¼šè¨ˆå®Œäº†ã§å‰Šé™¤
            deletedAt: now,
            paymentMethod: paymentMethodJP,
            discountAmount: discountAmount,  // å€¤å¼•ãé‡‘é¡ã‚’ä¿å­˜
            totalAmount: totalAmountToPay,  // å€¤å¼•ãå¾Œã®é‡‘é¡ã§totalAmountã‚’æ›´æ–°
            originalAmount: totalBeforeDiscount,  // å…ƒã®é‡‘é¡ã‚’ä¿å­˜
            notifiedPaid: true,
            tax8Total: tax8Total,
            tax10Total: tax10Total
          });
          console.log('âœ… æ³¨æ–‡ã‚’ä¼šè¨ˆæ¸ˆã¿ï¼†å‰Šé™¤:', order.id, 'é‡‘é¡:', totalAmountToPay);
        }
        
        // å£²ä¸Šã‚’POSã«åæ˜ 
        const dateStr = getBusinessDateStr();
        console.log('ğŸ“… å–¶æ¥­æ—¥:', dateStr);
        
        const dailySalesRef = window.doc(window.db, 'stores', currentStoreId, 'dailySales', dateStr);
        const dailySalesDoc = await window.getDoc(dailySalesRef);
        
        const currentData = dailySalesDoc.exists() ? dailySalesDoc.data() : {
          totalSales: 0,
          customerCount: 0,
          totalItems: 0,
          cashSales: 0,
          emoneSales: 0,
          creditSales: 0,
          tax8Total: 0,
          tax10Total: 0,
          totalDiscount: 0  // å€¤å¼•ãåˆè¨ˆ
        };
        
        console.log('ğŸ“Š ç¾åœ¨ã®dailySales:', currentData);
        
        const updateData = {
          totalSales: (currentData.totalSales || 0) + totalAmountToPay,
          customerCount: (currentData.customerCount || 0) + 1,
          totalItems: (currentData.totalItems || 0) + itemCount,
          cashSales: (currentData.cashSales || 0) + (selectedPaymentMethod === 'cash' ? totalAmountToPay : 0),
          emoneSales: (currentData.emoneSales || 0) + (selectedPaymentMethod === 'emoney' ? totalAmountToPay : 0),
          creditSales: (currentData.creditSales || 0) + (selectedPaymentMethod === 'credit' ? totalAmountToPay : 0),
          tax8Total: (currentData.tax8Total || 0) + tax8Total,
          tax10Total: (currentData.tax10Total || 0) + tax10Total,
          totalDiscount: (currentData.totalDiscount || 0) + discountAmount,  // å€¤å¼•ãåˆè¨ˆã«åŠ ç®—
          updatedAt: now
        };
        
        console.log('ğŸ“Š æ›´æ–°ã™ã‚‹dailySales:', updateData);
        
        await window.setDoc(dailySalesRef, updateData, { merge: true });
        
        console.log('âœ… å£²ä¸Šã‚’POSã«åæ˜ ã—ã¾ã—ãŸï¼ˆå€¤å¼•ã: Â¥' + discountAmount.toLocaleString() + 'ï¼‰');
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        let message = `ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\nå£²ä¸Š: Â¥${totalAmountToPay.toLocaleString()}`;
        if (discountAmount > 0) {
          message += `\nå€¤å¼•ã: Â¥${discountAmount.toLocaleString()}`;
        }
        message += `\nå®¢æ•°: +1\n\næ³¨æ–‡ã¯è‡ªå‹•çš„ã«å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚`;
        
        await showCustomAlert({ 
          icon: 'âœ…', 
          title: 'ä¼šè¨ˆå®Œäº†', 
          message: message, 
          btnClass: 'modal-btn-success' 
        });
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closePaymentModal();
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’æ›´æ–°
        await loadTables();
      } catch (error) {
        console.error('âŒ ä¼šè¨ˆå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert({ 
          icon: 'âŒ', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'ä¼šè¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    // å–¶æ¥­æ—¥ã®æ—¥ä»˜æ–‡å­—åˆ—ã‚’å–å¾—ï¼ˆ3æ™‚åŸºæº–ï¼‰
    function getBusinessDateStr() {
      const now = new Date();
      let businessDate = new Date(now);
      
      // åˆå‰3æ™‚å‰ãªã‚‰å‰æ—¥ã¨ã™ã‚‹
      if (now.getHours() < 3) {
        businessDate.setDate(businessDate.getDate() - 1);
      }
      
      const year = businessDate.getFullYear();
      const month = String(businessDate.getMonth() + 1).padStart(2, '0');
      const day = String(businessDate.getDate()).padStart(2, '0');
      const dateStr = `${year}-${month}-${day}`;
      
      console.log('ğŸ“… å–¶æ¥­æ—¥è¨ˆç®—:', {
        ç¾åœ¨æ™‚åˆ»: now.toLocaleString('ja-JP'),
        æ™‚: now.getHours(),
        å–¶æ¥­æ—¥: dateStr
      });
      
      return dateStr;
    }
    
    // å®Œäº†å‡¦ç†ï¼ˆPOSã®completedAtã«åˆã‚ã›ã‚‹ï¼‰- ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§å®Œçµ
    window.completeOrdersForTable = async function() {
      try {
        playTapSound();
        const now = window.Timestamp.now();
        
        // window.ordersToCheckoutã‹ã‚‰å®Œäº†å¯¾è±¡ã®æ³¨æ–‡ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°currentOrdersï¼‰
        const ordersToComplete = window.ordersToCheckout || currentOrders;
        
        console.log('âœ… å®Œäº†å‡¦ç†é–‹å§‹:', {
          ordersCount: ordersToComplete.length,
          orderIds: ordersToComplete.map(o => o.id)
        });
        
        // ğŸ†• åœ¨åº«ã‚’æ¸›ã‚‰ã™å‡¦ç†
        for (const order of ordersToComplete) {
          // æ³¨æ–‡ã‚’å®Œäº†ã«ã™ã‚‹
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          await window.updateDoc(orderRef, { 
            completedAt: now
          });
          console.log('âœ… æ³¨æ–‡ã‚’å®Œäº†:', order.id);
          
          // ğŸ†• åœ¨åº«ã‚’æ¸›ã‚‰ã™
          if (order.items && Array.isArray(order.items)) {
            try {
              // åœ¨åº«è¨­å®šã‚’å–å¾—
              const inventoryRef = window.doc(window.db, 'stores', currentStoreId, 'inventory_settings', 'default');
              const inventoryDoc = await window.getDoc(inventoryRef);
              
              if (inventoryDoc.exists()) {
                const inventoryData = inventoryDoc.data().items || {};
                let hasChanges = false;
                
                // å„å•†å“ã®åœ¨åº«ã‚’æ¸›ã‚‰ã™
                for (const item of order.items) {
                  // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å•†å“IDã‚’å–å¾—ï¼ˆåå‰ã§æ¤œç´¢ï¼‰
                  const menuSnapshot = await window.getDocs(window.collection(window.db, 'stores', currentStoreId, 'menus'));
                  let menuId = null;
                  
                  menuSnapshot.forEach(doc => {
                    const menuData = doc.data();
                    if (menuData.name === item.name) {
                      menuId = menuData.id || doc.id;
                    }
                  });
                  
                  if (menuId && inventoryData[menuId]) {
                    const currentStock = inventoryData[menuId].stock;
                    if (currentStock !== undefined && currentStock !== null) {
                      // åœ¨åº«ã‚’æ¸›ã‚‰ã™
                      const quantity = item.quantity || 1;
                      const newStock = Math.max(0, currentStock - quantity);
                      inventoryData[menuId].stock = newStock;
                      hasChanges = true;
                      
                      console.log(`ğŸ“¦ åœ¨åº«æ¸›ç®—: ${item.name} (${menuId}) ${currentStock} â†’ ${newStock} (-${quantity})`);
                    }
                  }
                }
                
                // å¤‰æ›´ãŒã‚ã‚Œã°ä¿å­˜
                if (hasChanges) {
                  await window.setDoc(inventoryRef, {
                    items: inventoryData,
                    updatedAt: new Date().toISOString()
                  });
                  console.log('âœ… åœ¨åº«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
                }
              }
            } catch (inventoryError) {
              console.error('âš ï¸ åœ¨åº«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', inventoryError);
              // åœ¨åº«æ›´æ–°ã‚¨ãƒ©ãƒ¼ã¯è‡´å‘½çš„ã§ãªã„ãŸã‚ç¶šè¡Œ
            }
          }
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closePaymentModal();
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’æ›´æ–°ï¼ˆFirestoreã®å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤ï¼‰
        await new Promise(resolve => setTimeout(resolve, 500));
        
        await showCustomAlert({ 
          icon: 'âœ…', 
          title: 'å®Œäº†', 
          message: 'æ³¨æ–‡ã‚’å®Œäº†ã«ã—ã¾ã—ãŸã€‚', 
          btnClass: 'modal-btn-success' 
        });
      } catch (error) {
        console.error('âŒ å®Œäº†å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert({ 
          icon: 'âŒ', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'å®Œäº†å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };

    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç† - ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§å®Œçµ
    window.cancelOrdersForTable = async function() {
      try {
        playTapSound();
        const now = window.Timestamp.now();
        
        // window.ordersToCheckoutã‹ã‚‰ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯¾è±¡ã®æ³¨æ–‡ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°currentOrdersï¼‰
        const ordersToCancel = window.ordersToCheckout || currentOrders;
        
        console.log('â¸ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†é–‹å§‹:', {
          ordersCount: ordersToCancel.length,
          orderIds: ordersToCancel.map(o => o.id)
        });
        
        for (const order of ordersToCancel) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          await window.updateDoc(orderRef, { 
            cancelledAt: now
          });
          console.log('âœ… æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«:', order.id);
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closePaymentModal();
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆFirestoreã®å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤ï¼‰
        await new Promise(resolve => setTimeout(resolve, 500));
        
        await showCustomAlert({ 
          icon: 'â¸ï¸', 
          title: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†', 
          message: 'æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚', 
          btnClass: 'modal-btn-success' 
        });
      } catch (error) {
        console.error('âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert({ 
          icon: 'âŒ', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };

    // å‰Šé™¤å‡¦ç† - ãƒ¯ãƒ³ã‚¿ãƒƒãƒ—ã§å®Œçµ
    window.deleteOrdersForTable = async function() {
      try {
        playTapSound();
        
        // window.ordersToCheckoutã‹ã‚‰å‰Šé™¤å¯¾è±¡ã®æ³¨æ–‡ã‚’å–å¾—ï¼ˆãªã‘ã‚Œã°currentOrdersï¼‰
        const ordersToDelete = window.ordersToCheckout || currentOrders;
        
        console.log('ğŸ—‘ï¸ å‰Šé™¤å‡¦ç†é–‹å§‹:', {
          ordersCount: ordersToDelete.length,
          orderIds: ordersToDelete.map(o => o.id)
        });
        
        for (const order of ordersToDelete) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          // Firestoreã‹ã‚‰å®Œå…¨ã«å‰Šé™¤ï¼ˆPOSã‹ã‚‰ã‚‚æ¶ˆãˆã‚‹ï¼‰
          await window.deleteDoc(orderRef);
          console.log('âœ… æ³¨æ–‡ã‚’å‰Šé™¤:', order.id);
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closePaymentModal();
        
        // å°‘ã—å¾…ã£ã¦ã‹ã‚‰æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆFirestoreã®å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤ï¼‰
        await new Promise(resolve => setTimeout(resolve, 500));
        
        await showCustomAlert({ 
          icon: 'âœ…', 
          title: 'å‰Šé™¤å®Œäº†', 
          message: 'æ³¨æ–‡ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã—ãŸã€‚\nPOSã‹ã‚‰ã‚‚å‰Šé™¤ã•ã‚Œã¾ã™ã€‚', 
          btnClass: 'modal-btn-success' 
        });
      } catch (error) {
        console.error('âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert({ 
          icon: 'âŒ', 
          title: 'ã‚¨ãƒ©ãƒ¼', 
          message: 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };

    window.addEventListener('DOMContentLoaded', async () => {
      while (!window.firebaseReady || !window.db) await new Promise(r => setTimeout(r, 100));
      await loadStoreList();
      if (sessionStorage.getItem('handyStoreId')) {
        currentStoreId = sessionStorage.getItem('handyStoreId');
        window.currentStoreId = currentStoreId; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦è¨­å®š
        currentStoreName = sessionStorage.getItem('handyStoreName');
        
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('ğŸ“ HANDY ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰åº—èˆ—IDå¾©å…ƒ');
        console.log('   currentStoreId:', currentStoreId);
        console.log('   window.currentStoreId:', window.currentStoreId);
        console.log('   currentStoreName:', currentStoreName);
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        
        showTablesScreen();
      }
    });
  </script>
</body>
</html>