<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ  - ä¼šè¨ˆæ©Ÿèƒ½ä»˜ã</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    .login-screen {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .login-screen h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 28px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .login-btn:active {
      transform: scale(0.98);
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ */
    .tables-screen {
      display: none;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .header h2 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    /* ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
    .mode-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .mode-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .mode-btn.active {
      background: #667eea;
      color: white;
    }
    
    .mode-btn:active {
      transform: scale(0.95);
    }
    
    .store-info {
      color: #666;
      font-size: 14px;
    }
    
    .logout-btn {
      margin-top: 15px;
      padding: 10px 20px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
    }
    
    .logout-btn:active {
      transform: scale(0.98);
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .table-card {
      background: white;
      border-radius: 15px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    
    .table-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .table-card:active {
      transform: translateY(-2px);
    }
    
    .table-card .table-name {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .table-card .table-status {
      font-size: 12px;
      color: #999;
    }
    
    /* ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .table-card.payment-mode {
      cursor: default;
      padding: 20px;
    }
    
    .table-card.has-orders {
      border: 3px solid #4CAF50;
    }
    
    .table-card.has-incomplete-orders {
      border: 3px solid #FF9800 !important;
      background: #fff3e0;
    }
    
    .table-card.all-paid {
      border: 3px solid #2196F3;
    }
    
    .table-card .order-info {
      margin-top: 10px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 12px;
    }
    
    .table-card .order-total {
      font-size: 20px;
      font-weight: bold;
      color: #4CAF50;
      margin: 10px 0;
    }
    
    .table-card .payment-btn {
      width: 100%;
      padding: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .table-card .payment-btn:active {
      transform: scale(0.95);
    }
    
    .table-card .no-orders {
      color: #999;
      font-size: 12px;
      margin-top: 10px;
    }
    
    .table-card .status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    
    .table-card .status-badge.paid {
      background: #2196F3;
      color: white;
    }
    
    .table-card .status-badge.incomplete {
      background: #FF9800;
      color: white;
    }
    
    .hidden {
      display: none !important;
    }
    
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }
    
    /* ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .custom-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.2s ease-out;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    .custom-modal-box {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 85vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease-out;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-icon {
      font-size: 60px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      color: #333;
      margin-bottom: 15px;
    }
    
    .modal-message {
      font-size: 16px;
      text-align: center;
      color: #666;
      margin-bottom: 25px;
      line-height: 1.6;
      white-space: pre-line;
    }
    
    .modal-buttons {
      display: flex;
      gap: 10px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modal-btn:active {
      transform: scale(0.95);
    }
    
    .modal-btn-cancel {
      background: #e0e0e0;
      color: #666;
    }
    
    .modal-btn-cancel:hover {
      background: #d0d0d0;
    }
    
    .modal-btn-danger {
      background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
      color: white;
    }
    
    .modal-btn-danger:hover {
      box-shadow: 0 4px 15px rgba(244, 67, 54, 0.4);
    }
    
    .modal-btn-success {
      background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
      color: white;
    }
    
    .modal-btn-success:hover {
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
    }
    
    /* ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« */
    .payment-modal-content {
      max-height: none;
    }
    
    .payment-summary {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
    }
    
    .payment-summary-row {
      display: flex;
      justify-content: space-between;
      margin: 8px 0;
      font-size: 16px;
    }
    
    .payment-summary-row.total {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
      padding-top: 10px;
      border-top: 2px solid #ddd;
    }
    
    .payment-summary-row.change {
      font-size: 28px;
      font-weight: bold;
      color: #FF9800;
    }
    
    /* æ”¯æ‰•ã„æ–¹æ³•é¸æŠ */
    .payment-method-group {
      margin: 15px 0;
    }
    
    .payment-method-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }
    
    .payment-method-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
    }
    
    .payment-method-btn {
      padding: 15px 10px;
      border: 2px solid #ddd;
      background: white;
      border-radius: 10px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    
    .payment-method-btn:active {
      transform: scale(0.95);
    }
    
    .payment-method-btn.selected {
      background: #4CAF50;
      color: white;
      border-color: #4CAF50;
    }
    
    .payment-method-btn .icon {
      font-size: 24px;
      display: block;
      margin-bottom: 5px;
    }
    
    .payment-input-group {
      margin: 15px 0;
    }
    
    .payment-input-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
    }
    
    .payment-input-group input {
      width: 100%;
      padding: 12px;
      font-size: 18px;
      border: 2px solid #ddd;
      border-radius: 8px;
      text-align: right;
    }
    
    .payment-input-group input:focus {
      outline: none;
      border-color: #4CAF50;
    }
    
    .payment-input-group input:disabled {
      background: #f5f5f5;
      cursor: not-allowed;
    }
    
    /* å•†å“ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
    .order-items-checklist {
      margin: 15px 0;
    }
    
    .order-item-checkbox {
      display: flex;
      align-items: center;
      padding: 12px;
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .order-item-checkbox:hover {
      background: #f5f5f5;
    }
    
    .order-item-checkbox.checked {
      background: #e8f5e9;
      border-color: #4CAF50;
    }
    
    .order-item-checkbox input[type="checkbox"] {
      width: 24px;
      height: 24px;
      margin-right: 12px;
      cursor: pointer;
    }
    
    .order-item-checkbox .item-info {
      flex: 1;
    }
    
    .order-item-checkbox .item-name {
      font-weight: bold;
      margin-bottom: 4px;
    }
    
    .order-item-checkbox .item-details {
      font-size: 12px;
      color: #666;
    }
    
    .order-item-checkbox .item-price {
      font-size: 16px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    /* ãƒã‚§ãƒƒã‚¯çŠ¶æ³ */
    .check-status {
      text-align: center;
      padding: 10px;
      background: #e3f2fd;
      border-radius: 8px;
      margin: 10px 0;
      font-weight: bold;
      color: #1976d2;
    }
    
    /* æ³¨æ–‡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    .order-action-buttons {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin: 15px 0;
    }
    
    .order-action-btn {
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .order-action-btn:active {
      transform: scale(0.95);
    }
    
    .order-action-btn.complete {
      background: #4CAF50;
      color: white;
    }
    
    .order-action-btn.cancel {
      background: #FF9800;
      color: white;
    }
    
    .order-action-btn.delete {
      background: #f44336;
      color: white;
    }
    
    .order-action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div class="login-screen" id="loginScreen">
      <h1>ğŸ½ï¸ ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </h1>
      <div id="errorMessage" class="error-message hidden"></div>
      
      <div class="form-group">
        <label for="storeSelect">åº—èˆ—ã‚’é¸æŠ</label>
        <select id="storeSelect">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="passwordInput">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
      </div>
      
      <button class="login-btn" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>
    
    <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ -->
    <div class="tables-screen" id="tablesScreen">
      <div class="header">
        <h2 id="storeNameDisplay">åº—èˆ—å</h2>
        <div class="store-info">ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        
        <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ -->
        <div class="mode-toggle">
          <button class="mode-btn active" id="orderModeBtn" onclick="switchMode('order')">
            ğŸ“± æ³¨æ–‡ãƒ¢ãƒ¼ãƒ‰
          </button>
          <button class="mode-btn" id="paymentModeBtn" onclick="switchMode('payment')">
            ğŸ’° ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰
          </button>
        </div>
        
        <button class="logout-btn" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      
      <div class="tables-grid" id="tablesGrid">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>
  
  <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="customModal" class="custom-modal-overlay">
    <div class="custom-modal-box">
      <div class="modal-icon" id="modalIcon">âš ï¸</div>
      <div class="modal-title" id="modalTitle">ç¢ºèª</div>
      <div class="modal-message" id="modalMessage">å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeCustomModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn" id="modalConfirmBtn" onclick="confirmCustomModal()">OK</button>
      </div>
    </div>
  </div>
  
  <!-- ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="paymentModal" class="custom-modal-overlay">
    <div class="custom-modal-box">
      <div class="payment-modal-content">
        <div class="modal-title">ğŸ’° ä¼šè¨ˆãƒ»æ³¨æ–‡ç®¡ç†</div>
        
        <div class="payment-summary">
          <div class="payment-summary-row">
            <span>ãƒ†ãƒ¼ãƒ–ãƒ«:</span>
            <span id="paymentTableName">-</span>
          </div>
          <div class="payment-summary-row">
            <span>æ³¨æ–‡ç•ªå·:</span>
            <span id="paymentOrderNumber">-</span>
          </div>
        </div>
        
        <!-- æ³¨æ–‡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
        <div class="order-action-buttons">
          <button class="order-action-btn complete" id="completeOrderBtn" onclick="markOrderComplete()">
            âœ“ å®Œäº†
          </button>
          <button class="order-action-btn cancel" onclick="cancelOrder()">
            â¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
          </button>
          <button class="order-action-btn delete" onclick="deleteOrder()">
            ğŸ—‘ å‰Šé™¤
          </button>
        </div>
        
        <!-- å•†å“ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ -->
        <div class="order-items-checklist">
          <h3 style="margin-bottom: 10px;">æä¾›ãƒã‚§ãƒƒã‚¯</h3>
          <div class="check-status" id="checkStatus">0 / 0 å®Œäº†</div>
          <div id="paymentItemsChecklist">
            <!-- å•†å“ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ãŒè¡¨ç¤ºã•ã‚Œã‚‹ -->
          </div>
        </div>
        
        <div class="payment-summary">
          <div class="payment-summary-row total">
            <span>åˆè¨ˆé‡‘é¡:</span>
            <span id="paymentTotalAmount">Â¥0</span>
          </div>
        </div>
        
        <!-- ğŸ†• é‡‘é¡èª¿æ•´ãƒœã‚¿ãƒ³ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px;">
          <button onclick="openAmountEditModal()" style="padding: 12px; background: #FF9800; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
            ğŸ’´ é‡‘é¡ä¿®æ­£
          </button>
          <button onclick="openDiscountModal()" style="padding: 12px; background: #FF9800; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer;">
            ğŸ« å€¤å¼•ã
          </button>
        </div>
        
        <!-- æ”¯æ‰•ã„æ–¹æ³•é¸æŠ -->
        <div class="payment-method-group">
          <label>æ”¯æ‰•ã„æ–¹æ³•</label>
          <div class="payment-method-buttons">
            <button class="payment-method-btn" id="methodCash" onclick="selectPaymentMethod('cash')">
              <span class="icon">ğŸ’´</span>
              <span>ç¾é‡‘</span>
            </button>
            <button class="payment-method-btn" id="methodCard" onclick="selectPaymentMethod('card')">
              <span class="icon">ğŸ’³</span>
              <span>ã‚«ãƒ¼ãƒ‰</span>
            </button>
            <button class="payment-method-btn" id="methodEmoney" onclick="selectPaymentMethod('emoney')">
              <span class="icon">ğŸ“±</span>
              <span>é›»å­ãƒãƒãƒ¼</span>
            </button>
          </div>
        </div>
        
        <!-- ç¾é‡‘ã®å ´åˆã®ã¿è¡¨ç¤º -->
        <div class="payment-input-group" id="cashInputGroup" style="display: none;">
          <label>ãŠé ã‹ã‚Šé‡‘é¡</label>
          <input type="number" id="cashReceived" placeholder="0" inputmode="numeric" oninput="calculateChange()">
        </div>
        
        <div class="payment-summary" id="changeDisplay" style="display: none;">
          <div class="payment-summary-row change">
            <span>ãŠé‡£ã‚Š:</span>
            <span id="changeAmount">Â¥0</span>
          </div>
        </div>
        
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" onclick="closePaymentModal()">é–‰ã˜ã‚‹</button>
          <button class="modal-btn modal-btn-success" id="paymentCompleteBtn" onclick="completePayment()">ä¼šè¨ˆå®Œäº†</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ğŸ†• é‡‘é¡ä¿®æ­£ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="amountEditModal" class="custom-modal-overlay">
    <div class="custom-modal-box">
      <div style="padding: 20px;">
        <div class="modal-title">ğŸ’´ é‡‘é¡ä¿®æ­£</div>
        <div id="amountEditList" style="margin-bottom: 20px;"></div>
        <div style="background: #f5f5f5; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; padding: 8px 0;">
            <span>å…ƒã®åˆè¨ˆ:</span>
            <span id="editOriginalTotal">Â¥0</span>
          </div>
          <div style="display: flex; justify-content: space-between; padding: 8px 0; border-top: 2px solid #4CAF50; margin-top: 10px; font-size: 18px; font-weight: bold; color: #4CAF50;">
            <span>ä¿®æ­£å¾Œåˆè¨ˆ:</span>
            <span id="editNewTotal">Â¥0</span>
          </div>
        </div>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" onclick="closeAmountEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="modal-btn modal-btn-success" onclick="applyAmountEdit()">é©ç”¨</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ğŸ†• å€¤å¼•ããƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="discountModal" class="custom-modal-overlay">
    <div class="custom-modal-box">
      <div style="padding: 20px;">
        <div class="modal-title">ğŸ« å€¤å¼•ã</div>
        
        <div class="payment-summary">
          <div class="payment-summary-row">
            <span>ç¾åœ¨ã®åˆè¨ˆ:</span>
            <span id="discountCurrentTotal">Â¥0</span>
          </div>
        </div>
        
        <div class="payment-input-group">
          <label>å€¤å¼•ãé‡‘é¡</label>
          <input type="number" id="discountAmount" placeholder="0" inputmode="numeric" oninput="calculateDiscountTotal()">
        </div>
        
        <div class="payment-summary">
          <div class="payment-summary-row total">
            <span>å€¤å¼•ãå¾Œ:</span>
            <span id="discountNewTotal">Â¥0</span>
          </div>
        </div>
        
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" onclick="closeDiscountModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          <button class="modal-btn modal-btn-success" onclick="applyDiscount()">é©ç”¨</button>
        </div>
      </div>
    </div>
  </div>

  <!-- æ¬¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§JavaScriptã‚’ç¶šã‘ã¾ã™ -->
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, getDocs, doc, getDoc, where, updateDoc, Timestamp, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.doc = doc;
    window.getDoc = getDoc;
    window.updateDoc = updateDoc;
    window.Timestamp = Timestamp;
    window.onSnapshot = onSnapshot;
    window.deleteDoc = deleteDoc;
    
    console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†');
    
    // FirebaseåˆæœŸåŒ–å®Œäº†ã‚’é€šçŸ¥
    window.firebaseReady = true;
    window.dispatchEvent(new Event('firebaseReady'));
  </script>
  
  <script>
    let currentStoreId = null;
    let currentStoreName = null;
    let currentMode = 'order'; // 'order' ã¾ãŸã¯ 'payment'
    let tableOrders = {}; // ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã®æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿
    let ordersUnsubscribe = null; // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã®è§£é™¤é–¢æ•°
    let storesData = {}; // åº—èˆ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    let currentPaymentOrders = []; // ç¾åœ¨ä¼šè¨ˆä¸­ã®æ³¨æ–‡
    let selectedPaymentMethod = null; // é¸æŠã•ã‚ŒãŸæ”¯æ‰•ã„æ–¹æ³•
    let itemCheckStatus = {}; // å•†å“ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹
    
    // ========== ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ ==========
    let customModalResolve = null;
    
    function showCustomModal(options) {
      return new Promise((resolve) => {
        customModalResolve = resolve;
        
        const modal = document.getElementById('customModal');
        const icon = document.getElementById('modalIcon');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        const buttonsContainer = confirmBtn.parentElement;
        
        icon.textContent = options.icon || 'âš ï¸';
        title.textContent = options.title || 'ç¢ºèª';
        message.textContent = options.message || 'å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ';
        
        confirmBtn.className = 'modal-btn ' + (options.btnClass || 'modal-btn-danger');
        confirmBtn.textContent = options.btnText || 'OK';
        
        // confirmOnlyã®å ´åˆã¯ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
        const cancelBtn = buttonsContainer.querySelector('.modal-btn-cancel');
        if (options.btnText === 'OK' && (options.btnClass === 'modal-btn-success' || options.btnClass === 'modal-btn-danger')) {
          cancelBtn.style.display = 'none';
          confirmBtn.style.width = '100%';
        } else {
          cancelBtn.style.display = '';
          confirmBtn.style.width = '';
        }
        
        modal.style.display = 'flex';
      });
    }
    
    function closeCustomModal() {
      document.getElementById('customModal').style.display = 'none';
      if (customModalResolve) {
        customModalResolve(false);
        customModalResolve = null;
      }
    }
    
    function confirmCustomModal() {
      document.getElementById('customModal').style.display = 'none';
      if (customModalResolve) {
        customModalResolve(true);
        customModalResolve = null;
      }
    }
    
    // ========== ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½ ==========
    async function loadStoreList() {
      try {
        const storesRef = window.collection(window.db, 'stores');
        const storesSnapshot = await window.getDocs(storesRef);
        const storeSelect = document.getElementById('storeSelect');
        
        storeSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        storesData = {};
        
        storesSnapshot.forEach(doc => {
          const storeData = doc.data();
          storesData[doc.id] = storeData;
          
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = storeData.storeName || doc.id;
          storeSelect.appendChild(option);
        });
        
        console.log('âœ… åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å®Œäº†:', storesSnapshot.size + 'åº—èˆ—');
      } catch (error) {
        console.error('âŒ åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    async function handleLogin() {
      const storeId = document.getElementById('storeSelect').value;
      const password = document.getElementById('passwordInput').value;
      const errorDiv = document.getElementById('errorMessage');
      
      errorDiv.classList.add('hidden');
      
      if (!storeId) {
        errorDiv.textContent = 'åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„';
        errorDiv.classList.remove('hidden');
        return;
      }
      
      if (!password) {
        errorDiv.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        errorDiv.classList.remove('hidden');
        return;
      }
      
      const storeData = storesData[storeId];
      
      if (!storeData) {
        errorDiv.textContent = 'åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
        errorDiv.classList.remove('hidden');
        return;
      }
      
      if (storeData.password !== password) {
        errorDiv.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
        errorDiv.classList.remove('hidden');
        return;
      }
      
      currentStoreId = storeId;
      currentStoreName = storeData.storeName;
      
      sessionStorage.setItem('handyStoreId', storeId);
      sessionStorage.setItem('handyStoreName', storeData.storeName);
      
      console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', storeData.storeName);
      
      showTablesScreen();
    }
    
    function handleLogout() {
      sessionStorage.removeItem('handyStoreId');
      sessionStorage.removeItem('handyStoreName');
      
      currentStoreId = null;
      currentStoreName = null;
      
      stopOrderMonitoring();
      
      document.getElementById('tablesScreen').style.display = 'none';
      document.getElementById('loginScreen').style.display = 'block';
      
      document.getElementById('passwordInput').value = '';
      
      console.log('âœ… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†');
    }
    
    function showTablesScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('tablesScreen').style.display = 'block';
      document.getElementById('storeNameDisplay').textContent = currentStoreName;
      
      loadTables();
    }
    
    // ========== ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç† ==========
    async function loadTables() {
      try {
        console.log('ğŸ” ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...');
        const tablesGrid = document.getElementById('tablesGrid');
        tablesGrid.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
        
        const tablesRef = window.collection(window.db, 'stores', currentStoreId, 'tables');
        const tablesSnapshot = await window.getDocs(tablesRef);
        const tables = [];
        
        tablesSnapshot.forEach(doc => {
          tables.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        console.log('ğŸ“Š å–å¾—ã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«æ•°:', tables.length);
        
        tables.sort((a, b) => {
          const orderA = a.order || 0;
          const orderB = b.order || 0;
          if (orderA !== orderB) {
            return orderA - orderB;
          }
          return a.name.localeCompare(b.name);
        });
        
        if (tables.length === 0) {
          tablesGrid.innerHTML = '<div style="color: white; text-align: center; padding: 40px;">ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
          return;
        }
        
        tablesGrid.innerHTML = '';
        
        tables.forEach(table => {
          const tableCard = document.createElement('div');
          tableCard.className = 'table-card';
          tableCard.dataset.tableName = table.name;
          
          tableCard.innerHTML = `
            <div class="table-name">${table.name}</div>
            <div class="table-status">${currentMode === 'order' ? 'ã‚¿ãƒƒãƒ—ã—ã¦æ³¨æ–‡' : ''}</div>
          `;
          
          if (currentMode === 'order') {
            tableCard.onclick = () => openMenu(table.name);
          }
          
          tablesGrid.appendChild(tableCard);
        });
        
        console.log('âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§èª­ã¿è¾¼ã¿å®Œäº†:', tables.length + 'ä»¶');
        
        if (currentMode === 'payment') {
          updateTablesDisplay();
        }
      } catch (error) {
        console.error('âŒ ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        const tablesGrid = document.getElementById('tablesGrid');
        tablesGrid.innerHTML = '<div style="color: white; text-align: center; padding: 40px;">ãƒ†ãƒ¼ãƒ–ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    }
    
    function openMenu(tableName) {
      console.log('ğŸ“± ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢ã‚’é–‹ã:', tableName);
      
      const menuUrl = `menu.html?table=${encodeURIComponent(tableName)}&store=${currentStoreId}&mode=handy`;
      
      sessionStorage.setItem('handyStoreId', currentStoreId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      sessionStorage.setItem('handyTableName', tableName);
      
      console.log('â†’ é·ç§»å…ˆ:', menuUrl);
      window.location.href = menuUrl;
    }
    
    // ========== ä¼šè¨ˆæ©Ÿèƒ½ ==========
    function switchMode(mode) {
      currentMode = mode;
      
      document.getElementById('orderModeBtn').classList.toggle('active', mode === 'order');
      document.getElementById('paymentModeBtn').classList.toggle('active', mode === 'payment');
      
      loadTables();
      
      if (mode === 'payment') {
        startOrderMonitoring();
      } else {
        stopOrderMonitoring();
      }
    }
    
    function startOrderMonitoring() {
      if (ordersUnsubscribe) {
        ordersUnsubscribe();
      }
      
      console.log('ğŸ”„ æ³¨æ–‡ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚’é–‹å§‹');
      
      const ordersRef = window.collection(window.db, 'stores', currentStoreId, 'orders');
      
      ordersUnsubscribe = window.onSnapshot(ordersRef, (snapshot) => {
        tableOrders = {};
        
        snapshot.forEach((doc) => {
          const order = doc.data();
          
          if (order.deleted) {
            return;
          }
          
          const tableName = order.tableNumber;
          
          if (!tableOrders[tableName]) {
            tableOrders[tableName] = [];
          }
          
          tableOrders[tableName].push({
            id: doc.id,
            ...order
          });
        });
        
        console.log('ğŸ“Š ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã®æ³¨æ–‡:', tableOrders);
        
        updateTablesDisplay();
      });
    }
    
    function stopOrderMonitoring() {
      if (ordersUnsubscribe) {
        ordersUnsubscribe();
        ordersUnsubscribe = null;
      }
      tableOrders = {};
    }
    
    function updateTablesDisplay() {
      const tablesGrid = document.getElementById('tablesGrid');
      const tableCards = tablesGrid.querySelectorAll('.table-card');
      
      tableCards.forEach(card => {
        const tableName = card.dataset.tableName;
        const orders = tableOrders[tableName] || [];
        
        // æ—¢å­˜ã®ãƒãƒƒã‚¸ã‚’å‰Šé™¤
        const oldBadge = card.querySelector('.status-badge');
        if (oldBadge) oldBadge.remove();
        
        if (currentMode === 'payment') {
          card.classList.add('payment-mode');
          
          const existingInfo = card.querySelector('.order-info');
          const existingBtn = card.querySelector('.payment-btn');
          const existingTotal = card.querySelector('.order-total');
          const existingNoOrders = card.querySelector('.no-orders');
          
          if (existingInfo) existingInfo.remove();
          if (existingBtn) existingBtn.remove();
          if (existingTotal) existingTotal.remove();
          if (existingNoOrders) existingNoOrders.remove();
          
          if (orders.length > 0) {
            // æœªå®Œäº†ã®æ³¨æ–‡ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            const hasIncomplete = orders.some(o => !o.completedAt && !o.paidAt);
            const allPaid = orders.every(o => o.paidAt || o.completedAt);
            
            if (hasIncomplete) {
              card.classList.add('has-incomplete-orders');
              card.classList.remove('has-orders', 'all-paid');
              
              // ãƒãƒƒã‚¸ã‚’è¿½åŠ 
              const badge = document.createElement('div');
              badge.className = 'status-badge incomplete';
              badge.textContent = 'æœªæä¾›';
              card.appendChild(badge);
            } else if (allPaid) {
              card.classList.add('all-paid');
              card.classList.remove('has-orders', 'has-incomplete-orders');
              
              const badge = document.createElement('div');
              badge.className = 'status-badge paid';
              badge.textContent = 'ä¼šè¨ˆæ¸ˆ';
              card.appendChild(badge);
            } else {
              card.classList.add('has-orders');
              card.classList.remove('has-incomplete-orders', 'all-paid');
            }
            
            let totalAmount = 0;
            orders.forEach(order => {
              totalAmount += order.totalAmount || 0;
            });
            
            const orderInfo = document.createElement('div');
            orderInfo.className = 'order-info';
            orderInfo.innerHTML = `æ³¨æ–‡: ${orders.length}ä»¶`;
            card.appendChild(orderInfo);
            
            const totalDiv = document.createElement('div');
            totalDiv.className = 'order-total';
            totalDiv.textContent = 'Â¥' + totalAmount.toLocaleString();
            card.appendChild(totalDiv);
            
            const paymentBtn = document.createElement('button');
            paymentBtn.className = 'payment-btn';
            paymentBtn.textContent = allPaid ? 'ğŸ’° è©³ç´°' : 'ğŸ’° ä¼šè¨ˆã™ã‚‹';
            paymentBtn.onclick = (e) => {
              e.stopPropagation();
              openPaymentModal(tableName, orders);
            };
            card.appendChild(paymentBtn);
            
            card.onclick = null;
          } else {
            card.classList.remove('has-orders', 'has-incomplete-orders', 'all-paid');
            
            const noOrders = document.createElement('div');
            noOrders.className = 'no-orders';
            noOrders.textContent = 'æ³¨æ–‡ãªã—';
            card.appendChild(noOrders);
            
            card.onclick = null;
          }
        } else {
          card.classList.remove('payment-mode', 'has-orders', 'has-incomplete-orders', 'all-paid');
          
          const existingInfo = card.querySelector('.order-info');
          const existingBtn = card.querySelector('.payment-btn');
          const existingTotal = card.querySelector('.order-total');
          const existingNoOrders = card.querySelector('.no-orders');
          
          if (existingInfo) existingInfo.remove();
          if (existingBtn) existingBtn.remove();
          if (existingTotal) existingTotal.remove();
          if (existingNoOrders) existingNoOrders.remove();
          
          card.onclick = () => openMenu(tableName);
        }
      });
    }
    
    function openPaymentModal(tableName, orders) {
      currentPaymentOrders = orders;
      selectedPaymentMethod = null;
      itemCheckStatus = {};
      
      console.log('ğŸ’° ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã:', tableName, orders);
      
      document.getElementById('paymentTableName').textContent = tableName;
      document.getElementById('paymentOrderNumber').textContent = orders.map(o => '#' + o.orderNumber).join(', ');
      
      // å•†å“ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆã‚’ä½œæˆ
      const checklist = document.getElementById('paymentItemsChecklist');
      checklist.innerHTML = '';
      
      let totalAmount = 0;
      let itemIndex = 0;
      
      orders.forEach(order => {
        totalAmount += order.totalAmount || 0;
        
        order.items.forEach(item => {
          const checkboxId = `item_${itemIndex}`;
          itemCheckStatus[checkboxId] = item.served || false;
          
          const checkboxDiv = document.createElement('div');
          checkboxDiv.className = 'order-item-checkbox' + (itemCheckStatus[checkboxId] ? ' checked' : '');
          
          const itemPrice = (item.price + (item.toppingPrice || 0)) * item.quantity;
          
          checkboxDiv.innerHTML = `
            <input type="checkbox" id="${checkboxId}" ${itemCheckStatus[checkboxId] ? 'checked' : ''} onchange="toggleItemCheck('${checkboxId}')">
            <div class="item-info">
              <div class="item-name">${item.name}</div>
              <div class="item-details">æ•°é‡: ${item.quantity}</div>
            </div>
            <div class="item-price">Â¥${itemPrice.toLocaleString()}</div>
          `;
          
          checklist.appendChild(checkboxDiv);
          itemIndex++;
        });
      });
      
      updateCheckStatus();
      
      document.getElementById('paymentTotalAmount').textContent = 'Â¥' + totalAmount.toLocaleString();
      
      // æ”¯æ‰•ã„æ–¹æ³•ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById('cashInputGroup').style.display = 'none';
      document.getElementById('changeDisplay').style.display = 'none';
      document.getElementById('cashReceived').value = '';
      document.getElementById('changeAmount').textContent = 'Â¥0';
      
      // å®Œäº†ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
      updateCompleteButtonState();
      
      document.getElementById('paymentModal').style.display = 'flex';
    }
    
    function closePaymentModal() {
      document.getElementById('paymentModal').style.display = 'none';
      currentPaymentOrders = [];
      selectedPaymentMethod = null;
      itemCheckStatus = {};
    }
    
    function toggleItemCheck(checkboxId) {
      itemCheckStatus[checkboxId] = document.getElementById(checkboxId).checked;
      
      const checkboxDiv = document.getElementById(checkboxId).closest('.order-item-checkbox');
      if (itemCheckStatus[checkboxId]) {
        checkboxDiv.classList.add('checked');
      } else {
        checkboxDiv.classList.remove('checked');
      }
      
      updateCheckStatus();
      updateCompleteButtonState();
    }
    
    function updateCheckStatus() {
      const total = Object.keys(itemCheckStatus).length;
      const checked = Object.values(itemCheckStatus).filter(v => v).length;
      
      document.getElementById('checkStatus').textContent = `${checked} / ${total} å®Œäº†`;
    }
    
    function updateCompleteButtonState() {
      const allChecked = Object.values(itemCheckStatus).every(v => v);
      const completeBtn = document.getElementById('completeOrderBtn');
      
      if (allChecked && Object.keys(itemCheckStatus).length > 0) {
        completeBtn.disabled = false;
        completeBtn.style.opacity = '1';
      } else {
        completeBtn.disabled = true;
        completeBtn.style.opacity = '0.5';
      }
    }
    
    function selectPaymentMethod(method) {
      selectedPaymentMethod = method;
      
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      if (method === 'cash') {
        document.getElementById('methodCash').classList.add('selected');
        document.getElementById('cashInputGroup').style.display = 'block';
        document.getElementById('changeDisplay').style.display = 'block';
      } else if (method === 'card') {
        document.getElementById('methodCard').classList.add('selected');
        document.getElementById('cashInputGroup').style.display = 'none';
        document.getElementById('changeDisplay').style.display = 'none';
      } else if (method === 'emoney') {
        document.getElementById('methodEmoney').classList.add('selected');
        document.getElementById('cashInputGroup').style.display = 'none';
        document.getElementById('changeDisplay').style.display = 'none';
      }
    }
    
    function calculateChange() {
      const totalAmount = currentPaymentOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      const received = parseInt(document.getElementById('cashReceived').value) || 0;
      const change = received - totalAmount;
      
      const changeElement = document.getElementById('changeAmount');
      changeElement.textContent = 'Â¥' + Math.max(0, change).toLocaleString();
      
      if (change < 0) {
        changeElement.style.color = '#f44336';
      } else {
        changeElement.style.color = '#FF9800';
      }
    }
    
    async function completePayment() {
      if (!selectedPaymentMethod) {
        await showCustomModal({
          icon: 'âš ï¸',
          title: 'æœªé¸æŠ',
          message: 'æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„',
          btnText: 'OK',
          btnClass: 'modal-btn-danger'
        });
        return;
      }
      
      const totalAmount = currentPaymentOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      
      if (selectedPaymentMethod === 'cash') {
        const received = parseInt(document.getElementById('cashReceived').value) || 0;
        
        if (received < totalAmount) {
          await showCustomModal({
            icon: 'âš ï¸',
            title: 'é‡‘é¡ä¸è¶³',
            message: 'ãŠé ã‹ã‚Šé‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™',
            btnText: 'OK',
            btnClass: 'modal-btn-danger'
          });
          return;
        }
        
        const change = received - totalAmount;
        
        const confirmed = await showCustomModal({
          icon: 'ğŸ’°',
          title: 'ä¼šè¨ˆå®Œäº†',
          message: `æ”¯æ‰•ã„æ–¹æ³•: ç¾é‡‘\nåˆè¨ˆ: Â¥${totalAmount.toLocaleString()}\nãŠé ã‹ã‚Š: Â¥${received.toLocaleString()}\nãŠé‡£ã‚Š: Â¥${change.toLocaleString()}\n\nä¼šè¨ˆã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ`,
          btnText: 'å®Œäº†',
          btnClass: 'modal-btn-success'
        });
        
        if (!confirmed) return;
      } else {
        const methodName = selectedPaymentMethod === 'card' ? 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰' : 'é›»å­ãƒãƒãƒ¼';
        
        const confirmed = await showCustomModal({
          icon: 'ğŸ’³',
          title: 'ä¼šè¨ˆå®Œäº†',
          message: `æ”¯æ‰•ã„æ–¹æ³•: ${methodName}\nåˆè¨ˆ: Â¥${totalAmount.toLocaleString()}\n\nä¼šè¨ˆã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ`,
          btnText: 'å®Œäº†',
          btnClass: 'modal-btn-success'
        });
        
        if (!confirmed) return;
      }
      
      try {
        const now = window.Timestamp.now();
        
        // å„æ³¨æ–‡ã«paidAtã¨paymentMethodã‚’è¨­å®š
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          await window.updateDoc(orderRef, {
            paidAt: now,
            paymentMethod: selectedPaymentMethod,
            completedAt: now  // ä¼šè¨ˆå®Œäº†æ™‚ã«æ³¨æ–‡ã‚‚å®Œäº†ã¨ã™ã‚‹
          });
        }
        
        console.log('âœ… ä¼šè¨ˆå®Œäº†:', currentPaymentOrders.length, 'ä»¶');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'ä¼šè¨ˆå®Œäº†',
          message: `ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸ`,
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ ä¼šè¨ˆã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'ä¼šè¨ˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-danger'
        });
      }
    }
    
    async function markOrderComplete() {
      const allChecked = Object.values(itemCheckStatus).every(v => v);
      
      if (!allChecked) {
        await showCustomModal({
          icon: 'âš ï¸',
          title: 'æœªå®Œäº†',
          message: 'å…¨ã¦ã®å•†å“ã‚’æä¾›ã—ã¦ã‹ã‚‰ãƒã‚§ãƒƒã‚¯ã—ã¦ãã ã•ã„',
          btnText: 'OK',
          btnClass: 'modal-btn-danger'
        });
        return;
      }
      
      const confirmed = await showCustomModal({
        icon: 'âœ…',
        title: 'æ³¨æ–‡å®Œäº†',
        message: 'å…¨ã¦ã®å•†å“ã‚’æä¾›æ¸ˆã¿ã«ã—ã¦ã€æ³¨æ–‡ã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ',
        btnText: 'å®Œäº†',
        btnClass: 'modal-btn-success'
      });
      
      if (!confirmed) return;
      
      try {
        const now = window.Timestamp.now();
        
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          // å•†å“ã«servedãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
          const updatedItems = order.items.map(item => ({
            ...item,
            served: true
          }));
          
          await window.updateDoc(orderRef, {
            completedAt: now,
            items: updatedItems
          });
        }
        
        console.log('âœ… æ³¨æ–‡å®Œäº†:', currentPaymentOrders.length, 'ä»¶');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'æ³¨æ–‡å®Œäº†',
          message: 'æ³¨æ–‡ãŒå®Œäº†ã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ å®Œäº†ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'å®Œäº†å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-danger'
        });
      }
    }
    
    // ğŸ†• é‡‘é¡ä¿®æ­£ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openAmountEditModal() {
      const list = document.getElementById('amountEditList');
      list.innerHTML = '';
      
      let originalTotal = 0;
      
      currentPaymentOrders.forEach(order => {
        order.items.forEach((item, index) => {
          originalTotal += item.price * item.quantity;
          
          const itemDiv = document.createElement('div');
          itemDiv.style.cssText = 'padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px;';
          itemDiv.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 10px;">${item.name} x ${item.quantity}</div>
            <div style="display: flex; gap: 10px; align-items: center;">
              <label style="flex-shrink: 0;">å˜ä¾¡:</label>
              <input type="number" 
                id="editPrice_${order.id}_${index}" 
                value="${item.price}" 
                style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; font-weight: bold;"
                oninput="updateEditTotal()">
            </div>
          `;
          list.appendChild(itemDiv);
        });
      });
      
      document.getElementById('editOriginalTotal').textContent = 'Â¥' + originalTotal.toLocaleString();
      document.getElementById('editNewTotal').textContent = 'Â¥' + originalTotal.toLocaleString();
      document.getElementById('amountEditModal').style.display = 'flex';
    }
    
    function closeAmountEditModal() {
      document.getElementById('amountEditModal').style.display = 'none';
    }
    
    function updateEditTotal() {
      let newTotal = 0;
      
      currentPaymentOrders.forEach(order => {
        order.items.forEach((item, index) => {
          const input = document.getElementById(`editPrice_${order.id}_${index}`);
          const price = parseInt(input.value) || 0;
          newTotal += price * item.quantity;
        });
      });
      
      document.getElementById('editNewTotal').textContent = 'Â¥' + newTotal.toLocaleString();
    }
    
    async function applyAmountEdit() {
      const confirmed = await showCustomModal({
        icon: 'ğŸ’´',
        title: 'é‡‘é¡ä¿®æ­£',
        message: 'ä¿®æ­£ã—ãŸé‡‘é¡ã‚’é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ',
        btnText: 'é©ç”¨',
        btnClass: 'modal-btn-success'
      });
      
      if (!confirmed) return;
      
      try {
        // å„æ³¨æ–‡ã®å•†å“ä¾¡æ ¼ã‚’æ›´æ–°
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          const updatedItems = order.items.map((item, index) => {
            const input = document.getElementById(`editPrice_${order.id}_${index}`);
            const newPrice = parseInt(input.value) || item.price;
            return {
              ...item,
              price: newPrice
            };
          });
          
          const newTotal = updatedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
          
          await window.updateDoc(orderRef, {
            items: updatedItems,
            totalAmount: newTotal
          });
          
          // ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
          order.items = updatedItems;
          order.totalAmount = newTotal;
        }
        
        closeAmountEditModal();
        
        // ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã®é‡‘é¡ã‚’æ›´æ–°
        const newTotalAmount = currentPaymentOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
        document.getElementById('paymentTotalAmount').textContent = 'Â¥' + newTotalAmount.toLocaleString();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'é‡‘é¡ä¿®æ­£å®Œäº†',
          message: 'é‡‘é¡ã‚’ä¿®æ­£ã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ é‡‘é¡ä¿®æ­£ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'é‡‘é¡ä¿®æ­£ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-danger'
        });
      }
    }
    
    // ğŸ†• å€¤å¼•ããƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openDiscountModal() {
      const currentTotal = currentPaymentOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      
      document.getElementById('discountCurrentTotal').textContent = 'Â¥' + currentTotal.toLocaleString();
      document.getElementById('discountNewTotal').textContent = 'Â¥' + currentTotal.toLocaleString();
      document.getElementById('discountAmount').value = '';
      document.getElementById('discountModal').style.display = 'flex';
    }
    
    function closeDiscountModal() {
      document.getElementById('discountModal').style.display = 'none';
    }
    
    function calculateDiscountTotal() {
      const currentTotal = currentPaymentOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      const discount = parseInt(document.getElementById('discountAmount').value) || 0;
      const newTotal = Math.max(0, currentTotal - discount);
      
      document.getElementById('discountNewTotal').textContent = 'Â¥' + newTotal.toLocaleString();
    }
    
    async function applyDiscount() {
      const discount = parseInt(document.getElementById('discountAmount').value) || 0;
      
      if (discount <= 0) {
        await showCustomModal({
          icon: 'âš ï¸',
          title: 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼',
          message: 'å€¤å¼•ãé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
          btnText: 'OK',
          btnClass: 'modal-btn-danger'
        });
        return;
      }
      
      const currentTotal = currentPaymentOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      const newTotal = Math.max(0, currentTotal - discount);
      
      const confirmed = await showCustomModal({
        icon: 'ğŸ«',
        title: 'å€¤å¼•ãé©ç”¨',
        message: `å€¤å¼•ãé‡‘é¡: Â¥${discount.toLocaleString()}\nå€¤å¼•ãå¾Œ: Â¥${newTotal.toLocaleString()}\n\nå€¤å¼•ãã‚’é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ`,
        btnText: 'é©ç”¨',
        btnClass: 'modal-btn-success'
      });
      
      if (!confirmed) return;
      
      try {
        // æœ€åˆã®æ³¨æ–‡ã«å€¤å¼•ãã‚’é©ç”¨
        const firstOrder = currentPaymentOrders[0];
        const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', firstOrder.id);
        
        const discountedTotal = Math.max(0, firstOrder.totalAmount - discount);
        
        await window.updateDoc(orderRef, {
          totalAmount: discountedTotal,
          discount: discount,
          originalAmount: firstOrder.totalAmount
        });
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã®ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
        firstOrder.totalAmount = discountedTotal;
        
        closeDiscountModal();
        
        // ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã®é‡‘é¡ã‚’æ›´æ–°
        const updatedTotal = currentPaymentOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
        document.getElementById('paymentTotalAmount').textContent = 'Â¥' + updatedTotal.toLocaleString();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'å€¤å¼•ãå®Œäº†',
          message: `Â¥${discount.toLocaleString()} ã®å€¤å¼•ãã‚’é©ç”¨ã—ã¾ã—ãŸ`,
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ å€¤å¼•ãã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'å€¤å¼•ãå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-danger'
        });
      }
    }
    
    async function cancelOrder() {
      const confirmed = await showCustomModal({
        icon: 'â¸',
        title: 'æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
        message: 'ã“ã®æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ',
        btnText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
        btnClass: 'modal-btn-danger'
      });
      
      if (!confirmed) return;
      
      try {
        const now = window.Timestamp.now();
        
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          await window.updateDoc(orderRef, {
            cancelledAt: now
          });
        }
        
        console.log('âœ… æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«:', currentPaymentOrders.length, 'ä»¶');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†',
          message: 'æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-danger'
        });
      }
    }
    
    async function deleteOrder() {
      const confirmed = await showCustomModal({
        icon: 'ğŸ—‘',
        title: 'æ³¨æ–‡å‰Šé™¤',
        message: 'ã“ã®æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼‰',
        btnText: 'å‰Šé™¤',
        btnClass: 'modal-btn-danger'
      });
      
      if (!confirmed) return;
      
      try {
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          await window.updateDoc(orderRef, {
            deleted: true,
            deletedAt: window.Timestamp.now()
          });
        }
        
        console.log('âœ… æ³¨æ–‡å‰Šé™¤:', currentPaymentOrders.length, 'ä»¶');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'å‰Šé™¤å®Œäº†',
          message: 'æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'å‰Šé™¤å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
          btnText: 'OK',
          btnClass: 'modal-btn-danger'
        });
      }
    }
    
    // ========== ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ ==========
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('ğŸ“± ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•');
      
      while (!window.firebaseReady || !window.db) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      console.log('âœ… Firebaseæº–å‚™å®Œäº†ã€åº—èˆ—ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã™');
      
      await loadStoreList();
      
      const savedStoreId = sessionStorage.getItem('handyStoreId');
      const savedStoreName = sessionStorage.getItem('handyStoreName');
      
      if (savedStoreId && savedStoreName && storesData[savedStoreId]) {
        currentStoreId = savedStoreId;
        currentStoreName = savedStoreName;
        
        console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å¾©å…ƒ:', currentStoreName);
        showTablesScreen();
      }
    });
  </script>
</body>
</html>
