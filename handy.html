<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title>
  
  <!--  -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <!--  -->
  <script>
    // AudioContext
    let audioContext = null;
    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }
    function playTapSound() {
      initAudio();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    /*  */
    .login-screen {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .login-screen h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 28px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .login-btn:active {
      transform: scale(0.98);
    }
    
    /*  */
    .tables-screen {
      display: none;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .header h2 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .header .store-info {
      color: #666;
      font-size: 14px;
    }
    
    .header-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    
    .logout-btn {
      background: #f44336;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .sales-btn {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .settings-btn {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .table-card {
      background: white;
      border-radius: 15px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    
    .table-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .table-card:active {
      transform: translateY(-2px);
    }
    
    .table-card.has-pending-orders {
      background: linear-gradient(135deg, #fff4e6 0%, #ffe0b2 100%);
      border: 2px solid #ff9800;
    }
    
    .table-card.has-pending-orders .table-name {
      color: #f57c00;
    }
    
    .table-card.has-pending-orders .pending-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff9800;
      color: white;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
    }
    
    .status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
    }
    
    .unpaid-badge {
      background: #f57c00;
      color: white;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }
    
    .table-card .table-name {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .table-card .table-status {
      font-size: 12px;
      color: #999;
    }
    
    .checkout-btn {
      width: 100%;
      padding: 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .checkout-btn:active {
      transform: scale(0.95);
    }
    
    /* : hidden */
    .hidden {
      display: none !important;
    }
    
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }
    
    /* CSS */
    .sales-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    
    .sales-modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    .sales-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .sales-modal-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    
    .sales-modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: #999;
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .sales-modal-close:hover {
      color: #333;
    }
    
    .custom-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    
    .custom-modal-box {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .modal-icon {
      font-size: 64px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 15px;
      color: #333;
    }
    
    .modal-message {
      text-align: center;
      font-size: 16px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.6;
      white-space: pre-line;
    }
    
    .modal-buttons {
      display: flex;
      gap: 15px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 18px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .modal-btn:active {
      transform: scale(0.95);
    }
    
    .modal-btn-cancel {
      background: #e0e0e0;
      color: #333;
    }
    
    .modal-btn-cancel:hover {
      background: #d0d0d0;
    }
    
    .modal-btn-danger {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
    }
    
    .modal-btn-success {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    /* : .modal-overlaydisplay */
    .modal-overlay {
      display: flex; /* none.hidden */
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10001;
      align-items: center;
      justify-content: center;
    }
    
    .modal {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .modal h3 {
      margin: 0 0 20px 0;
      color: #333;
      font-size: 24px;
      text-align: center;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .payment-methods {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .payment-method-btn {
      padding: 15px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .payment-method-btn:hover {
      border-color: #667eea;
      background: #f8f9ff;
    }
    
    .payment-method-btn.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .cash-input-section {
      margin: 20px 0;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 10px;
    }
    
    .cash-input-section label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #333;
    }
    
    .cash-input-section input {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 18px;
      text-align: center;
    }
    
    .change-display {
      margin-top: 15px;
      padding: 12px;
      background: white;
      border-radius: 8px;
      text-align: center;
      font-weight: bold;
      font-size: 16px;
    }
    
    .change-amount {
      color: #4CAF50;
      font-size: 20px;
    }
    
    .order-selection-btn {
      width: 100%;
      padding: 20px;
      margin-bottom: 15px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: left;
    }
    
    .order-selection-btn:hover {
      border-color: #667eea;
      background: #f8f9ff;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .order-selection-btn:active {
      transform: translateY(0);
    }
    
    /*   */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10001;
    }
    
    .modal-content {
      background: white;
      border-radius: 12px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
    }
    
    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      margin: 0;
      font-size: 20px;
    }
    
    .modal-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 28px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.2s;
      line-height: 1;
    }
    
    .modal-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .modal-footer {
      padding: 20px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
    }
    
    /*   */
    .header-buttons {
      position: relative;
      display: flex;
      gap: 10px;
    }
    
    .functions-submenu {
      position: absolute;
      top: 45px;
      left: 0;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      margin-top: 8px;
      min-width: 220px;
      z-index: 1000;
      overflow: hidden;
      border: 1px solid rgba(102, 126, 234, 0.1);
    }
    
    .functions-submenu button {
      width: 100%;
      padding: 14px 18px;
      background: white;
      border: none;
      border-left: 3px solid transparent;
      text-align: left;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      color: #333;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .functions-submenu button::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transition: transform 0.2s ease;
    }
    
    .functions-submenu button:first-child {
      border-radius: 12px 12px 0 0;
    }
    
    .functions-submenu button:last-child {
      border-radius: 0 0 12px 12px;
    }
    
    .functions-submenu button:hover {
      background: linear-gradient(90deg, rgba(102, 126, 234, 0.08) 0%, rgba(255, 255, 255, 0) 100%);
      border-left-color: #667eea;
      padding-left: 22px;
    }
    
    .functions-submenu button:hover::before {
      transform: scale(1.3);
    }
    
    .functions-submenu button:active {
      background: linear-gradient(90deg, rgba(102, 126, 234, 0.12) 0%, rgba(255, 255, 255, 0) 100%);
      transform: scale(0.98);
    }
    
    /*  POS */
    .pos-iframe-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      animation: fadeIn 0.3s ease;
    }
    
    .pos-iframe-modal.active {
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .pos-iframe-container {
      width: 95%;
      height: 95%;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 10px 50px rgba(0, 0, 0, 0.5);
      display: flex;
      flex-direction: column;
    }
    
    .pos-iframe-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .pos-iframe-header h3 {
      margin: 0;
      font-size: 18px;
    }
    
    .pos-iframe-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      transition: background 0.2s;
    }
    
    .pos-iframe-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .pos-iframe-content {
      flex: 1;
      width: 100%;
      border: none;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="login-screen" id="loginScreen">
      <h1></h1>
      <div id="errorMessage" class="error-message hidden"></div>
      
      <div class="form-group">
        <label for="storeSelect"></label>
        <select id="storeSelect">
          <option value=""></option>
        </select>
      </div>
      
      <div class="form-group">
        <label for="passwordInput"></label>
        <input type="password" id="passwordInput" placeholder="">
      </div>
      
      <button class="login-btn" onclick="handleLogin()"></button>
    </div>
    
    <div class="tables-screen" id="tablesScreen">
      <div class="header">
        <h2 id="storeNameDisplay"></h2>
        <div class="store-info"></div>
        <div class="header-buttons">
          <button class="sales-btn" onclick="toggleFunctionsMenu()"> </button>
          <button class="settings-btn" onclick="window.open('https://gymnastmasaki-lang.github.io/takoyaki-/kanri.html', '_blank')"></button>
          <button class="logout-btn" onclick="handleLogout()"></button>
        </div>
        <!--   -->
        <div id="functionsSubMenu" class="functions-submenu" style="display: none;">
          <button onclick="window.open('https://gymnastmasaki-lang.github.io/takoyaki-/kintai.html', '_blank')" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;"> </button>
          <button onclick="showSalesModal()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;"> </button>
          <button onclick="showHistoryModal()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;"> </button>
          <button onclick="showExpenseModal()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;"> </button>
          <button onclick="openDrawerDirect()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;"> </button>
          <button onclick="showPeriodJournalModal()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;"> </button>
          <button onclick="showPrinterSettings()" style="width: 100%; padding: 12px; margin-bottom: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; transition: all 0.2s;"> </button>
        </div>
      </div>
      
      <div class="tables-grid" id="tablesGrid">
        <div class="loading">...</div>
      </div>
    </div>
  </div>
  
  <div id="customConfirmModal" class="custom-modal-overlay">
    <div class="custom-modal-box">
      <div class="modal-icon" id="modalIcon"></div>
      <div class="modal-title" id="modalTitle"></div>
      <div class="modal-message" id="modalMessage"></div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeCustomModal()"></button>
        <button class="modal-btn modal-btn-danger" id="modalConfirmBtn" onclick="confirmCustomModal()">OK</button>
      </div>
    </div>
  </div>
  
  <!--  -->
  <div id="orderSelectionModal" class="modal-overlay hidden">
    <div class="modal">
      <h3> </h3>
      <p id="orderSelectionTableName" style="color: #666; margin-bottom: 20px; text-align: center; font-size: 18px; font-weight: bold;"></p>
      <div id="ordersList" style="max-height: 60vh; overflow-y: auto;"></div>
      <div style="margin-top: 20px;">
        <button class="btn btn-secondary" style="width: 100%;" onclick="closeOrderSelectionModal()"></button>
      </div>
    </div>
  </div>
  
  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3> </h3>
      <p id="selectedTableLabel2" style="color: #666; margin-bottom: 20px;"></p>
      
      <div id="taxRateSection" style="margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px; border-left: 4px solid #4CAF50; max-height: 300px; overflow-y: auto;">
        <h4 style="margin: 0 0 15px 0; color: #2e7d32; font-size: 16px;"></h4>
        <div id="taxRateItemsList"></div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #4CAF50; font-weight: bold; font-size: 14px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>8%:</span>
            <span id="tax8Summary" style="color: #FF9800;">¥0</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>10%:</span>
            <span id="tax10Summary" style="color: #2196F3;">¥0</span>
          </div>
        </div>
      </div>
      
      <div class="payment-methods">
        <button class="payment-method-btn" onclick="selectPaymentMethod('cash')">
           
        </button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('emoney')">
           
        </button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('credit')">
           
        </button>
      </div>
      
      <div id="cashInputSection" class="cash-input-section hidden">
        <label></label>
        <input type="number" id="cashReceived" placeholder="0" oninput="calculateChange()">
        <div class="change-display" id="changeDisplay">
          : <span class="change-amount" id="changeAmount">¥0</span>
        </div>
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 10px;">
        <label style="font-weight: bold; color: #856404;"></label>
        <input type="number" id="discountAmount" placeholder="0" value="0" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ffc107; border-radius: 8px; margin-top: 8px;" oninput="updatePaymentTotal()">
        <div style="text-align: center; margin-top: 10px; font-size: 18px; font-weight: bold; color: #333;">
          : <span id="finalPaymentAmount" style="color: #4CAF50;">¥0</span>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;" id="mainButtons">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="processPayment()" id="paymentBtn" disabled> </button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white;" onclick="completeOrdersForTable()"> </button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white;" onclick="cancelOrdersForTable()">⏸ </button>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 10px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="deleteOrdersForTable()"> </button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closePaymentModal()"></button>
      </div>
    </div>
  </div>

  <div id="priceChangeModal" class="modal-overlay hidden">
    <div class="modal">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 50px; margin-bottom: 10px;"></div>
        <h3 style="margin: 0; font-size: 20px; color: #333;" id="priceChangeTitle"></h3>
      </div>
      
      <div style="background: #f5f5f5; border-radius: 10px; padding: 15px; margin: 20px 0; text-align: center;">
        <div style="color: #666; margin-bottom: 10px;" id="priceChangeItemInfo"></div>
        <div style="font-size: 18px; font-weight: bold; color: #333;">
          : <span id="priceChangeCurrentPrice"></span>
        </div>
      </div>
      
      <div style="margin: 20px 0;">
        <input type="number" id="priceChangeInput" placeholder="" style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 24px; text-align: center;">
      </div>
      
      <input type="hidden" id="priceChangeItemId">
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="closePriceChangeModal()"></button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="confirmPriceChange()"> </button>
      </div>
    </div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, getDocs, doc, getDoc, setDoc, where, onSnapshot, updateDoc, deleteDoc, Timestamp, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // 
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.doc = doc;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.onSnapshot = onSnapshot;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.Timestamp = Timestamp;
    window.orderBy = orderBy;
    window.limit = limit;
    
    // 
    window.getStoreCollection = function(collectionName) {
      console.log(' HANDY getStoreCollection');
      console.log('   :', collectionName);
      console.log('   window.currentStoreId:', window.currentStoreId);
      console.log('   typeof:', typeof window.currentStoreId);
      
      // currentStoreIdnull
      if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
        const oldPathMap = {
          "menus": "menu",
          "employees": "kintai_employees",
          "attendance": "kintai_attendance",
          "orders": "orders",
          "tables": "tables"
        };
        const path = oldPathMap[collectionName] || collectionName;
        console.log('   → :', path);
        return collection(db, path);
      }
      console.log('   → : stores/' + window.currentStoreId + '/' + collectionName);
      return collection(db, "stores", window.currentStoreId, collectionName);
    };

    // 
    window.getStoreDoc = function(collectionName, docId) {
      console.log(' HANDY getStoreDoc');
      console.log('   :', collectionName, 'ID:', docId);
      console.log('   window.currentStoreId:', window.currentStoreId);
      
      // currentStoreIdnull
      if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
        const oldPathMap = {
          "menus": "menu",
          "employees": "kintai_employees",
          "attendance": "kintai_attendance",
          "orders": "orders",
          "tables": "tables"
        };
        const path = oldPathMap[collectionName] || collectionName;
        console.log('   → :', path + '/' + docId);
        return doc(db, path, docId);
      }
      console.log('   → : stores/' + window.currentStoreId + '/' + collectionName + '/' + docId);
      return doc(db, "stores", window.currentStoreId, collectionName, docId);
    };
    
    console.log(' Firebase');
    
    window.firebaseReady = true;
    window.dispatchEvent(new Event('firebaseReady'));
  </script>
  
  <script>
    let currentStoreId = null;
    let currentStoreName = null;
    let storesData = {};
    let ordersListener = null;
    let currentOrders = [];
    let currentTableSettings = null;  //  
    
    let selectedPaymentMethod = null;
    let totalAmountToPay = 0;
    let cashReceived = 0;
    let changeAmount = 0;
    let customModalResolve = null;
    
    function showCustomConfirm(options) {
      return new Promise((resolve) => {
        customModalResolve = resolve;
        const modal = document.getElementById('customConfirmModal');
        const icon = document.getElementById('modalIcon');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        
        icon.textContent = options.icon || '';
        title.textContent = options.title || '';
        message.textContent = options.message || '';
        
        confirmBtn.className = 'modal-btn ' + (options.btnClass || 'modal-btn-danger');
        confirmBtn.textContent = options.btnText || '';
        
        modal.style.display = 'flex';
      });
    }
    
    function closeCustomModal() {
      document.getElementById('customConfirmModal').style.display = 'none';
      if (customModalResolve) {
        customModalResolve(false);
        customModalResolve = null;
      }
    }
    
    function confirmCustomModal() {
      document.getElementById('customConfirmModal').style.display = 'none';
      if (customModalResolve) {
        customModalResolve(true);
        customModalResolve = null;
      }
    }
    
    /**
     *  foodType
     *  : takeout/dine-intaxRatefoodType
     */
    function getApplicableTaxRate(item, tableSettings) {
      //  : 10%
      if (item.name?.includes('') || item.name?.includes('') || item.name?.includes('')) {
        console.log(` : ${item.name} → 10%`);
        return 10;
      }
      
      //  foodTypecategory
      let foodType = item.foodType;
      if (!foodType) {
        // 
        if (item.category === '' || item.name?.includes('')) {
          foodType = 'non-food';
          console.log(` foodType → category/name(${item.category}/${item.name}): non-food`);
        } else {
          foodType = 'food';  // 
          console.log(` foodType → : food, : ${item.name}`);
        }
      } else {
        console.log(` foodType: ${foodType} (: ${item.name})`);
      }
      
      //  : takeout/dine-infoodType
      if (tableSettings && tableSettings.taxRule && tableSettings.taxRule !== 'none') {
        const taxRule = tableSettings.taxRule;
        console.log(`[] : ${item.name}, foodType: ${foodType}, taxRule: ${taxRule}`);
        
        switch(taxRule) {
          case 'takeout':
            // : 8%10%
            const takeoutRate = (foodType === 'food') ? 8 : 10;
            console.log(`  → : ${foodType === 'food' ? '(8%)' : '(10%)'} = ${takeoutRate}%`);
            return takeoutRate;
          
          case 'dine-in':
            // : 10%
            console.log(`  → : 10%`);
            return 10;
          
          default:
            // taxRule: taxRatefoodType
            if (item.taxRate !== undefined && item.taxRate !== null) {
              console.log(`  → taxRule: ${taxRule} → taxRate: ${item.taxRate}%`);
              return item.taxRate;
            }
            const defaultRate = (foodType === 'non-food') ? 10 : 8;
            console.log(`  → taxRule: ${taxRule}, taxRate → foodType(${foodType}): ${defaultRate}%`);
            return defaultRate;
        }
      }
      
      // taxRule'none'
      // taxRate
      if (item.taxRate !== undefined && item.taxRate !== null) {
        console.log(`[]  → taxRate: ${item.taxRate}%`);
        return item.taxRate;
      }
      
      // taxRatefoodType:8%, :10%
      const inferredRate = (foodType === 'non-food') ? 10 : 8;
      console.log(`[] taxRate → foodType(${foodType}): ${inferredRate}%`);
      return inferredRate;
    }
    
    /**
     *  
     */
    async function getTableSettings(tableId) {
      if (!tableId || !currentStoreId) {
        return null;
      }
      
      try {
        const tableDocRef = window.doc(window.db, 'stores', currentStoreId, 'tableSettings', tableId);
        const tableDoc = await window.getDoc(tableDocRef);
        
        if (tableDoc.exists()) {
          console.log(' :', tableId, tableDoc.data());
          return tableDoc.data();
        }
        console.log(' :', tableId);
        return null;
      } catch (e) {
        console.error(' :', e);
        return null;
      }
    }
    
    async function loadStoreList() {
      try {
        const storesQuery = window.query(
          window.collection(window.db, 'stores'),
          window.where('isActive', '==', true)
        );
        const storesSnapshot = await window.getDocs(storesQuery);
        const storeSelect = document.getElementById('storeSelect');
        
        storeSelect.innerHTML = '<option value=""></option>';
        storesData = {};
        
        storesSnapshot.forEach(doc => {
          const storeData = doc.data();
          const storeId = doc.id;
          const storeName = storeData.storeName || doc.id;
          const password = storeData.storePassword || '';
          
          storesData[storeId] = {
            storeName: storeName,
            password: String(password),
            isActive: true
          };
          
          const option = document.createElement('option');
          option.value = storeId;
          option.textContent = storeName;
          storeSelect.appendChild(option);
        });
      } catch (error) {
        console.error(' :', error);
        showError('');
      }
    }
    
    window.handleLogin = async function() {
      playTapSound();
      const storeSelect = document.getElementById('storeSelect');
      const passwordInput = document.getElementById('passwordInput');
      const storeId = storeSelect.value;
      const inputPassword = passwordInput.value.trim();
      
      if (!storeId) {
        showError('');
        return;
      }
      if (!inputPassword) {
        showError('');
        return;
      }
      
      const storeInfo = storesData[storeId];
      if (inputPassword !== storeInfo.password) {
        showError('');
        return;
      }
      
      currentStoreId = storeId;
      window.currentStoreId = storeId; // 
      currentStoreName = storeInfo.storeName;
      sessionStorage.setItem('handyStoreId', storeId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      
      //  POS
      window.saveLoginInfo(storeId, inputPassword);
      
      console.log('');
      console.log(' HANDY ID');
      console.log('   currentStoreId:', currentStoreId);
      console.log('   window.currentStoreId:', window.currentStoreId);
      console.log('   currentStoreName:', currentStoreName);
      console.log('');
      
      showTablesScreen();
    };
    
    window.handleLogout = async function() {
      playTapSound();
      const confirmed = await showCustomConfirm({
        icon: '',
        title: '',
        message: '',
        btnClass: 'modal-btn-danger',
        btnText: ''
      });
      
      if (confirmed) {
        if (ordersListener) ordersListener();
        sessionStorage.removeItem('handyStoreId');
        sessionStorage.removeItem('handyStoreName');
        location.reload();
      }
    };
    
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      setTimeout(() => errorDiv.classList.add('hidden'), 3000);
    }
    
    async function showTablesScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('tablesScreen').style.display = 'block';
      document.getElementById('tablesScreen').classList.remove('hidden');
      document.getElementById('storeNameDisplay').textContent = currentStoreName;
      
      await loadTables();
      startOrdersListener();
      
      //  
      updateInventoryPanel();
      watchInventoryChanges();
    }
    
    function startOrdersListener() {
      if (ordersListener) ordersListener();
      const ordersRef = window.getStoreCollection('orders');
      ordersListener = window.onSnapshot(ordersRef, (snapshot) => {
        updateTableStatus(snapshot);
      });
    }
    
    function updateTableStatus(ordersSnapshot) {
      const unpaidTables = new Set();  // 
      const completedUnpaidTables = new Set();  // 
      const hasIncompleteOrders = new Set();  // 
      
      console.log('');
      
      ordersSnapshot.forEach(doc => {
        const order = doc.data();
        console.log(' :', {
          id: doc.id,
          table: order.tableNumber,
          deleted: order.deleted,
          cancelled: !!order.cancelledAt,
          paid: !!order.paidAt,
          completed: !!order.completedAt
        });
        
        if (order.tableNumber && !order.deleted && !order.cancelledAt) {
          // 
          if (!order.paidAt) {
            unpaidTables.add(order.tableNumber);
            
            // 
            if (order.completedAt) {
              completedUnpaidTables.add(order.tableNumber);
              console.log(' :', order.tableNumber);
            } else {
              // 
              hasIncompleteOrders.add(order.tableNumber);
              console.log(' :', order.tableNumber);
            }
          }
        }
      });
      
      console.log(' :', {
        : Array.from(completedUnpaidTables),
        : Array.from(unpaidTables),
        : Array.from(hasIncompleteOrders)
      });
      
      document.querySelectorAll('.table-card').forEach(card => {
        const tableName = card.getAttribute('data-table-name');
        
        // 
        card.querySelectorAll('.pending-badge, .status-badge, .unpaid-badge').forEach(badge => badge.remove());
        
        if (unpaidTables.has(tableName)) {
          //  → 
          card.classList.add('has-pending-orders');
          
          // 
          if (hasIncompleteOrders.has(tableName)) {
            const orderBadge = document.createElement('div');
            orderBadge.className = 'pending-badge';
            orderBadge.textContent = '';
            orderBadge.style.cssText = 'position: absolute; top: 10px; right: 10px; background: #ff9800; color: white; font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: bold;';
            card.appendChild(orderBadge);
            console.log(' :', tableName);
          }
          
          // 
          const unpaidBadge = document.createElement('div');
          unpaidBadge.className = 'unpaid-badge';
          unpaidBadge.textContent = '';
          unpaidBadge.style.cssText = 'position: absolute; top: 10px; left: 10px; background: #f57c00; color: white; font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: bold; animation: pulse 2s infinite;';
          card.appendChild(unpaidBadge);
          console.log(' :', tableName);
        } else {
          //  → 
          card.classList.remove('has-pending-orders');
          console.log('ℹ :', tableName);
        }
      });
    }
    
    async function loadTables() {
      try {
        const tablesGrid = document.getElementById('tablesGrid');
        tablesGrid.innerHTML = '<div class="loading">...</div>';
        
        const tablesRef = window.getStoreCollection('tables');
        const tablesSnapshot = await window.getDocs(tablesRef);
        const tables = [];
        
        tablesSnapshot.forEach(doc => {
          tables.push({ id: doc.id, ...doc.data() });
        });
        
        tables.sort((a, b) => (a.order || 0) - (b.order || 0) || a.name.localeCompare(b.name));
        
        if (tables.length === 0) {
          tablesGrid.innerHTML = '<div style="color: white; text-align: center; padding: 40px;"></div>';
          return;
        }
        
        tablesGrid.innerHTML = '';
        tables.forEach(table => {
          const tableCard = document.createElement('div');
          tableCard.className = 'table-card';
          tableCard.setAttribute('data-table-name', table.name);
          tableCard.innerHTML = `
            <div class="table-name">${table.name}</div>
            <div class="table-status"></div>
          `;
          
          //  
          tableCard.onclick = () => { 
            playTapSound(); 
            openMenu(table.name); 
          };
          
          const menuBtn = document.createElement('button');
          menuBtn.className = 'checkout-btn';
          menuBtn.textContent = ' ';
          menuBtn.style.background = '#667eea';
          menuBtn.onclick = (e) => { e.stopPropagation(); playTapSound(); openMenu(table.name); };
          tableCard.appendChild(menuBtn);
          
          const checkoutBtn = document.createElement('button');
          checkoutBtn.className = 'checkout-btn';
          checkoutBtn.textContent = ' ';
          checkoutBtn.onclick = (e) => { e.stopPropagation(); playTapSound(); openCheckoutForTable(table.name); };
          tableCard.appendChild(checkoutBtn);
          
          tablesGrid.appendChild(tableCard);
        });
      } catch (error) {
        console.error(' :', error);
      }
    }
    
    function openMenu(tableName) {
      console.log(' :', {
        tableName: tableName,
        currentStoreId: currentStoreId,
        currentStoreName: currentStoreName
      });
      
      // IDmenu.html
      sessionStorage.setItem('handyStoreId', currentStoreId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      sessionStorage.setItem('handyTableName', tableName);
      
      const menuUrl = `menu.html?table=${encodeURIComponent(tableName)}&store=${currentStoreId}&mode=handy`;
      console.log(' URL:', menuUrl);
      window.location.href = menuUrl;
    }
    
    async function openCheckoutForTable(tableName) {
      try {
        const ordersRef = window.getStoreCollection('orders');
        const ordersQuery = window.query(ordersRef, window.where('tableNumber', '==', String(tableName)));
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        currentOrders = [];
        ordersSnapshot.forEach(doc => {
          const order = { id: doc.id, ...doc.data() };
          if (!order.deleted && !order.cancelledAt && !order.paidAt) {
            currentOrders.push(order);
          }
        });
        
        // 
        currentOrders.sort((a, b) => (a.orderNumber || 0) - (b.orderNumber || 0));
        
        if (currentOrders.length === 0) {
          await showCustomAlert({ icon: '', title: '', message: `${tableName}\n`, btnClass: 'modal-btn-success' });
          return;
        }
        
        // 
        if (currentOrders.length > 1) {
          showOrderSelectionModal(tableName);
        } else {
          showCheckoutMenu(tableName, [currentOrders[0]]);
        }
      } catch (error) {
        console.error(' :', error);
      }
    }
    
    // 
    function showOrderSelectionModal(tableName) {
      const modal = document.getElementById('orderSelectionModal');
      document.getElementById('orderSelectionTableName').textContent = ` ${tableName}`;
      
      const ordersList = document.getElementById('ordersList');
      ordersList.innerHTML = '';
      
      // 
      const allOrdersBtn = document.createElement('button');
      allOrdersBtn.className = 'order-selection-btn';
      allOrdersBtn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
      allOrdersBtn.style.color = 'white';
      allOrdersBtn.style.fontWeight = 'bold';
      
      // 
      const incompleteCount = currentOrders.filter(o => !o.completedAt).length;
      const completeCount = currentOrders.filter(o => o.completedAt).length;
      const statusText = incompleteCount > 0 && completeCount > 0 
        ? ` ( ${incompleteCount} /  ${completeCount})`
        : incompleteCount > 0 
        ? ` ( ${incompleteCount})`
        : completeCount > 0 
        ? ` ( ${completeCount})`
        : '';
      
      allOrdersBtn.innerHTML = `
        <div style="font-size: 20px; margin-bottom: 8px;"> </div>
        <div style="font-size: 16px;"> ${currentOrders.length} ${statusText} - ¥${currentOrders.reduce((sum, o) => sum + (o.totalAmount || 0), 0).toLocaleString()}</div>
      `;
      allOrdersBtn.onclick = () => {
        modal.classList.add('hidden');
        showCheckoutMenu(tableName, currentOrders);
      };
      ordersList.appendChild(allOrdersBtn);
      
      // 
      currentOrders.forEach((order, index) => {
        const orderBtn = document.createElement('button');
        orderBtn.className = 'order-selection-btn';
        orderBtn.style.position = 'relative';  // 
        
        const itemsText = order.items && Array.isArray(order.items)
          ? order.items.map(item => `${item.name} x${item.quantity || 1}`).join(', ')
          : '';
        
        // 
        const isIncomplete = !order.completedAt;
        const statusBadge = isIncomplete 
          ? '<span style="position: absolute; top: 10px; right: 10px; background: #ff9800; color: white; font-size: 11px; padding: 4px 10px; border-radius: 12px; font-weight: bold;"></span>'
          : '<span style="position: absolute; top: 10px; right: 10px; background: #4CAF50; color: white; font-size: 11px; padding: 4px 10px; border-radius: 12px; font-weight: bold;"></span>';
        
        orderBtn.innerHTML = `
          ${statusBadge}
          <div style="font-size: 18px; font-weight: bold; margin-bottom: 8px;"> #${order.orderNumber || (index + 1)}</div>
          <div style="font-size: 14px; color: #666; margin-bottom: 8px;">${itemsText}</div>
          <div style="font-size: 16px; color: #4CAF50; font-weight: bold;">¥${(order.totalAmount || 0).toLocaleString()}</div>
        `;
        orderBtn.onclick = () => {
          modal.classList.add('hidden');
          showCheckoutMenu(tableName, [order]);
        };
        ordersList.appendChild(orderBtn);
      });
      
      modal.classList.remove('hidden');
    }
    
    window.closeOrderSelectionModal = function() {
      document.getElementById('orderSelectionModal').classList.add('hidden');
    };
    
    async function showCheckoutMenu(tableName, selectedOrders = null) {
      // selectedOrderscurrentOrders
      const ordersToCheckout = selectedOrders || currentOrders;
      
      totalAmountToPay = ordersToCheckout.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      const paymentModal = document.getElementById('paymentModal');
      paymentModal.classList.remove('hidden');
      
      // 
      let orderNumbersText = '';
      if (ordersToCheckout.length === 1) {
        orderNumbersText = ` -  #${ordersToCheckout[0].orderNumber || '1'}`;
      } else if (ordersToCheckout.length > 1) {
        const orderNums = ordersToCheckout.map(o => `#${o.orderNumber || '?'}`).join(', ');
        orderNumbersText = ` - ${orderNums}`;
      }
      
      document.getElementById('selectedTableLabel2').textContent = ` ${tableName}${orderNumbersText}`;
      
      // 
      window.ordersToCheckout = ordersToCheckout;
      
      //  
      currentTableSettings = await getTableSettings(tableName);
      console.log(' :', tableName, currentTableSettings);
      
      generateTaxRateItems(ordersToCheckout, tableName);
      document.getElementById('discountAmount').value = 0;
      updatePaymentTotal();
      
      selectedPaymentMethod = null;
      document.querySelectorAll('.payment-method-btn').forEach(btn => btn.classList.remove('selected'));
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('paymentBtn').disabled = true;
    }
    
    window.closePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
    };
    
    function generateTaxRateItems(ordersToProcess = null, tableName = '') {
      const container = document.getElementById('taxRateItemsList');
      container.innerHTML = '';
      let itemIndex = 0;
      
      const orders = ordersToProcess || currentOrders;
      
      orders.forEach(order => {
        if (!order.items || order.items.length === 0) {
          // 
          // 10%
          const defaultTaxRate = 10;
          addTaxRateItem(container, ` #${order.orderNumber}`, 1, order.totalAmount || 0, itemIndex, defaultTaxRate, 'inclusive');
          itemIndex++;
        } else {
          order.items.forEach(item => {
            const toppingStr = item.toppings || item.toppingDetails || '';
            //  
            const itemBasePrice = item.price + (item.toppingPrice || 0);
            const itemTotal = itemBasePrice * item.quantity;
            
            //  foodType
            const itemTaxRate = getApplicableTaxRate(item, currentTableSettings);
            console.log(` : ${itemTaxRate}% (: ${item.name}, foodType: ${item.foodType || 'food'}, taxRule: ${currentTableSettings?.taxRule || 'none'})`);
            
            //  taxType
            addTaxRateItem(container, `${item.name} (${toppingStr})`, item.quantity, itemTotal, itemIndex, itemTaxRate, item.taxType || 'inclusive');
            itemIndex++;
          });
          if (order.bagNeeded && order.bagQuantity > 0) {
            addTaxRateItem(container, ' ', order.bagQuantity, order.bagPrice || (order.bagQuantity * 3), itemIndex, 10, 'inclusive');
            itemIndex++;
          }
        }
      });
      calculateTaxSummary();
    }
    
    function addTaxRateItem(container, itemName, quantity, itemTotal, index, defaultTaxRate, taxType = 'inclusive') {
      //  itemTotal
      let displayTotal = itemTotal;
      if (taxType === 'exclusive') {
        // itemTotal
        displayTotal = itemTotal + Math.floor(itemTotal * (defaultTaxRate / 100));
        console.log(` : ${itemTotal} + ${Math.floor(itemTotal * (defaultTaxRate / 100))} → ${displayTotal}${defaultTaxRate}%`);
      }
      
      const itemDiv = document.createElement('div');
      itemDiv.style.cssText = 'padding: 10px; margin-bottom: 8px; background: white; border-radius: 6px; border: 1px solid #ddd;';
      
      const headerDiv = document.createElement('div');
      headerDiv.style.cssText = 'display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; font-size: 14px; cursor: pointer;';
      headerDiv.innerHTML = `<span>${itemName} ×${quantity}</span><span style="color: #667eea;" id="itemPrice${index}">¥${displayTotal.toLocaleString()}</span>`;
      
      headerDiv.onclick = function() {
        document.getElementById('priceChangeTitle').textContent = itemName;
        document.getElementById('priceChangeCurrentPrice').textContent = `¥${displayTotal.toLocaleString()}`;
        document.getElementById('priceChangeInput').value = displayTotal;
        document.getElementById('priceChangeItemId').value = index;
        document.getElementById('priceChangeModal').classList.remove('hidden');
      };
      
      const radioDiv = document.createElement('div');
      radioDiv.style.cssText = 'display: flex; gap: 10px; justify-content: center;';
      
      const radio8 = createRadio(index, 8, displayTotal, defaultTaxRate === 8, itemTotal, taxType);
      const radio10 = createRadio(index, 10, displayTotal, defaultTaxRate === 10, itemTotal, taxType);
      
      radioDiv.appendChild(createRadioLabel(radio8, '8%', '#fff3e0', '#FF9800'));
      radioDiv.appendChild(createRadioLabel(radio10, '10%', '#e3f2fd', '#2196F3'));
      
      itemDiv.appendChild(headerDiv);
      itemDiv.appendChild(radioDiv);
      container.appendChild(itemDiv);
    }
    
    function createRadio(index, rate, amount, checked, baseAmount = null, taxType = 'inclusive') {
      const radio = document.createElement('input');
      radio.type = 'radio';
      radio.name = `taxRate${index}`;
      radio.value = rate;
      radio.checked = checked;
      radio.dataset.amount = amount;
      radio.dataset.taxType = taxType;  //  taxType
      radio.dataset.baseAmount = baseAmount || amount;  //  
      radio.style.marginRight = '5px';
      
      //  
      radio.onchange = function() {
        if (taxType === 'exclusive') {
          const newAmount = parseInt(radio.dataset.baseAmount) + Math.floor(parseInt(radio.dataset.baseAmount) * (rate / 100));
          // amount
          document.querySelectorAll(`input[name="taxRate${index}"]`).forEach(r => {
            r.dataset.amount = newAmount;
          });
          document.getElementById('itemPrice' + index).textContent = '¥' + newAmount.toLocaleString();
          console.log(`${rate}%: ${radio.dataset.baseAmount} → ${newAmount}`);
        }
        calculateTaxSummary();
      };
      
      return radio;
    }
    
    function createRadioLabel(radio, text, bg, border) {
      const label = document.createElement('label');
      label.style.cssText = `flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 6px 10px; border-radius: 4px; background: ${bg}; border: 2px solid ${border}; font-size: 13px;`;
      label.appendChild(radio);
      label.appendChild(document.createTextNode(text));
      return label;
    }
    
    function calculateTaxSummary() {
      let tax8 = 0, tax10 = 0;
      document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked').forEach(r => {
        if (r.value === '8') tax8 += parseFloat(r.dataset.amount);
        else tax10 += parseFloat(r.dataset.amount);
      });
      document.getElementById('tax8Summary').textContent = '¥' + tax8.toLocaleString();
      document.getElementById('tax10Summary').textContent = '¥' + tax10.toLocaleString();
      updatePaymentTotal();
    }
    
    window.updatePaymentTotal = function() {
      let total = 0;
      document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked').forEach(r => total += parseFloat(r.dataset.amount));
      const final = Math.max(0, total - (parseInt(document.getElementById('discountAmount').value) || 0));
      totalAmountToPay = final;
      document.getElementById('finalPaymentAmount').textContent = '¥' + final.toLocaleString();
      if (selectedPaymentMethod === 'cash') calculateChange();
    };
    
    window.selectPaymentMethod = function(method) {
      playTapSound();
      selectedPaymentMethod = method;
      document.querySelectorAll('.payment-method-btn').forEach(btn => btn.classList.toggle('selected', btn.innerText.includes(method === 'cash' ? '' : method === 'emoney' ? '' : '')));
      document.getElementById('cashInputSection').classList.toggle('hidden', method !== 'cash');
      document.getElementById('paymentBtn').disabled = method === 'cash';
    };
    
    window.calculateChange = function() {
      cashReceived = parseInt(document.getElementById('cashReceived').value) || 0;
      changeAmount = cashReceived - totalAmountToPay;
      document.getElementById('changeAmount').textContent = `¥${changeAmount.toLocaleString()}`;
      document.getElementById('paymentBtn').disabled = cashReceived < totalAmountToPay;
    };
    
    window.confirmPriceChange = function() {
      const itemId = document.getElementById('priceChangeItemId').value;
      const newPrice = parseFloat(document.getElementById('priceChangeInput').value) || 0;
      document.querySelectorAll(`input[name="taxRate${itemId}"]`).forEach(r => r.dataset.amount = newPrice);
      document.getElementById(`itemPrice${itemId}`).textContent = '¥' + newPrice.toLocaleString();
      calculateTaxSummary();
      document.getElementById('priceChangeModal').classList.add('hidden');
    };
    
    window.closePriceChangeModal = function() {
      document.getElementById('priceChangeModal').classList.add('hidden');
    };

    // OK 
    function showCustomAlert(options) {
      return new Promise((resolve) => {
        const modal = document.getElementById('customConfirmModal');
        const icon = document.getElementById('modalIcon');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const buttonsContainer = document.querySelector('.modal-buttons');
        
        icon.textContent = options.icon || 'ℹ';
        title.textContent = options.title || '';
        message.textContent = options.message || '';
        
        buttonsContainer.innerHTML = `
          <button class="modal-btn ${options.btnClass || 'modal-btn-primary'}" onclick="closeCustomAlert()">${options.btnText || 'OK'}</button>
        `;
        
        window.closeCustomAlert = function() {
          modal.style.display = 'none';
          resolve(true);
        };
        
        modal.style.display = 'flex';
      });
    }

    // POS- 
    window.processPayment = async function() {
      playTapSound();
      
      if (!selectedPaymentMethod) {
        await showCustomAlert({ icon: '', title: '', message: '', btnClass: 'modal-btn-danger' });
        return;
      }
      
      if (selectedPaymentMethod === 'cash' && cashReceived < totalAmountToPay) {
        await showCustomAlert({ icon: '', title: '', message: '', btnClass: 'modal-btn-danger' });
        return;
      }
      
      try {
        const now = window.Timestamp.now();
        
        // window.ordersToCheckout
        const ordersToProcess = window.ordersToCheckout || currentOrders;
        
        // 
        const discountAmount = parseInt(document.getElementById('discountAmount').value) || 0;
        
        // 
        let tax8Total = 0;
        let tax10Total = 0;
        const radios = document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked');
        radios.forEach(radio => {
          const amount = parseFloat(radio.dataset.amount) || 0;
          const taxRate = radio.value;
          if (taxRate === '8') {
            tax8Total += amount;
          } else if (taxRate === '10') {
            tax10Total += amount;
          }
        });
        
        // totalAmountToPay
        const totalBeforeDiscount = tax8Total + tax10Total;
        
        // 
        let itemCount = 0;
        ordersToProcess.forEach(order => {
          if (order.items && Array.isArray(order.items)) {
            order.items.forEach(item => {
              itemCount += item.quantity || 0;
            });
          } else {
            itemCount += 1;
          }
        });
        
        console.log(' :', {
          totalAmount: totalAmountToPay,
          : totalBeforeDiscount,
          : discountAmount,
          : totalAmountToPay,
          paymentMethod: selectedPaymentMethod,
          itemCount: itemCount,
          tax8Total: tax8Total,
          tax10Total: tax10Total,
          customerCount: 1,
          ordersCount: ordersToProcess.length,
          storeId: currentStoreId
        });
        
        // 
        let paymentMethodJP = '';
        if (selectedPaymentMethod === 'emoney') paymentMethodJP = '';
        else if (selectedPaymentMethod === 'credit') paymentMethodJP = '';
        
        // FirestorepaidAtcompletedAtdeleted
        for (const order of ordersToProcess) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          await window.updateDoc(orderRef, {
            paidAt: now,
            completedAt: now,
            deleted: true,  // 
            deletedAt: now,
            paymentMethod: paymentMethodJP,
            discountAmount: discountAmount,  // 
            totalAmount: totalAmountToPay,  // totalAmount
            originalAmount: totalBeforeDiscount,  // 
            notifiedPaid: true,
            tax8Total: tax8Total,
            tax10Total: tax10Total
          });
          console.log(' :', order.id, ':', totalAmountToPay);
        }
        
        // POS
        const dateStr = getBusinessDateStr();
        console.log(' :', dateStr);
        
        const dailySalesRef = window.doc(window.db, 'stores', currentStoreId, 'dailySales', dateStr);
        const dailySalesDoc = await window.getDoc(dailySalesRef);
        
        const currentData = dailySalesDoc.exists() ? dailySalesDoc.data() : {
          totalSales: 0,
          customerCount: 0,
          totalItems: 0,
          cashSales: 0,
          emoneSales: 0,
          creditSales: 0,
          tax8Total: 0,
          tax10Total: 0,
          totalDiscount: 0  // 
        };
        
        console.log(' dailySales:', currentData);
        
        const updateData = {
          totalSales: (currentData.totalSales || 0) + totalAmountToPay,
          customerCount: (currentData.customerCount || 0) + 1,
          totalItems: (currentData.totalItems || 0) + itemCount,
          cashSales: (currentData.cashSales || 0) + (selectedPaymentMethod === 'cash' ? totalAmountToPay : 0),
          emoneSales: (currentData.emoneSales || 0) + (selectedPaymentMethod === 'emoney' ? totalAmountToPay : 0),
          creditSales: (currentData.creditSales || 0) + (selectedPaymentMethod === 'credit' ? totalAmountToPay : 0),
          tax8Total: (currentData.tax8Total || 0) + tax8Total,
          tax10Total: (currentData.tax10Total || 0) + tax10Total,
          totalDiscount: (currentData.totalDiscount || 0) + discountAmount,  // 
          updatedAt: now
        };
        
        console.log(' dailySales:', updateData);
        
        await window.setDoc(dailySalesRef, updateData, { merge: true });
        
        console.log(' POS: ¥' + discountAmount.toLocaleString() + '');
        
        // 
        let message = `\n\n: ¥${totalAmountToPay.toLocaleString()}`;
        if (discountAmount > 0) {
          message += `\n: ¥${discountAmount.toLocaleString()}`;
        }
        message += `\n: +1\n\n`;
        
        await showCustomAlert({ 
          icon: '', 
          title: '', 
          message: message, 
          btnClass: 'modal-btn-success' 
        });
        
        // 
        closePaymentModal();
        
        // 
        await loadTables();
      } catch (error) {
        console.error(' :', error);
        await showCustomAlert({ 
          icon: '', 
          title: '', 
          message: '\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    // 3
    function getBusinessDateStr() {
      const now = new Date();
      let businessDate = new Date(now);
      
      // 3
      if (now.getHours() < 3) {
        businessDate.setDate(businessDate.getDate() - 1);
      }
      
      const year = businessDate.getFullYear();
      const month = String(businessDate.getMonth() + 1).padStart(2, '0');
      const day = String(businessDate.getDate()).padStart(2, '0');
      const dateStr = `${year}-${month}-${day}`;
      
      console.log(' :', {
        : now.toLocaleString('ja-JP'),
        : now.getHours(),
        : dateStr
      });
      
      return dateStr;
    }
    
    // POScompletedAt- 
    window.completeOrdersForTable = async function() {
      try {
        playTapSound();
        const now = window.Timestamp.now();
        
        // window.ordersToCheckoutcurrentOrders
        const ordersToComplete = window.ordersToCheckout || currentOrders;
        
        console.log(' :', {
          ordersCount: ordersToComplete.length,
          orderIds: ordersToComplete.map(o => o.id)
        });
        
        //  
        for (const order of ordersToComplete) {
          // 
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          await window.updateDoc(orderRef, { 
            completedAt: now
          });
          console.log(' :', order.id);
          
          //  
          if (order.items && Array.isArray(order.items)) {
            try {
              // 
              const inventoryRef = window.doc(window.db, 'stores', currentStoreId, 'inventory_settings', 'default');
              const inventoryDoc = await window.getDoc(inventoryRef);
              
              if (inventoryDoc.exists()) {
                const inventoryData = inventoryDoc.data().items || {};
                let hasChanges = false;
                
                // 
                for (const item of order.items) {
                  // ID
                  const menuSnapshot = await window.getDocs(window.collection(window.db, 'stores', currentStoreId, 'menus'));
                  let menuId = null;
                  
                  menuSnapshot.forEach(doc => {
                    const menuData = doc.data();
                    if (menuData.name === item.name) {
                      menuId = menuData.id || doc.id;
                    }
                  });
                  
                  if (menuId && inventoryData[menuId]) {
                    const currentStock = inventoryData[menuId].stock;
                    if (currentStock !== undefined && currentStock !== null) {
                      // 
                      const quantity = item.quantity || 1;
                      const newStock = Math.max(0, currentStock - quantity);
                      inventoryData[menuId].stock = newStock;
                      hasChanges = true;
                      
                      console.log(` : ${item.name} (${menuId}) ${currentStock} → ${newStock} (-${quantity})`);
                    }
                  }
                }
                
                // 
                if (hasChanges) {
                  await window.setDoc(inventoryRef, {
                    items: inventoryData,
                    updatedAt: new Date().toISOString()
                  });
                  console.log(' ');
                }
              }
            } catch (inventoryError) {
              console.error(' :', inventoryError);
              // 
            }
          }
        }
        
        // 
        closePaymentModal();
        
        // Firestore
        await new Promise(resolve => setTimeout(resolve, 500));
        
        await showCustomAlert({ 
          icon: '', 
          title: '', 
          message: '', 
          btnClass: 'modal-btn-success' 
        });
      } catch (error) {
        console.error(' :', error);
        await showCustomAlert({ 
          icon: '', 
          title: '', 
          message: '\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };

    //  - 
    window.cancelOrdersForTable = async function() {
      try {
        playTapSound();
        const now = window.Timestamp.now();
        
        // window.ordersToCheckoutcurrentOrders
        const ordersToCancel = window.ordersToCheckout || currentOrders;
        
        console.log('⏸ :', {
          ordersCount: ordersToCancel.length,
          orderIds: ordersToCancel.map(o => o.id)
        });
        
        for (const order of ordersToCancel) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          await window.updateDoc(orderRef, { 
            cancelledAt: now
          });
          console.log(' :', order.id);
        }
        
        // 
        closePaymentModal();
        
        // Firestore
        await new Promise(resolve => setTimeout(resolve, 500));
        
        await showCustomAlert({ 
          icon: '⏸', 
          title: '', 
          message: '', 
          btnClass: 'modal-btn-success' 
        });
      } catch (error) {
        console.error(' :', error);
        await showCustomAlert({ 
          icon: '', 
          title: '', 
          message: '\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };

    //  - 
    window.deleteOrdersForTable = async function() {
      try {
        playTapSound();
        
        // window.ordersToCheckoutcurrentOrders
        const ordersToDelete = window.ordersToCheckout || currentOrders;
        
        console.log(' :', {
          ordersCount: ordersToDelete.length,
          orderIds: ordersToDelete.map(o => o.id)
        });
        
        for (const order of ordersToDelete) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          // FirestorePOS
          await window.deleteDoc(orderRef);
          console.log(' :', order.id);
        }
        
        // 
        closePaymentModal();
        
        // Firestore
        await new Promise(resolve => setTimeout(resolve, 500));
        
        await showCustomAlert({ 
          icon: '', 
          title: '', 
          message: '\nPOS', 
          btnClass: 'modal-btn-success' 
        });
      } catch (error) {
        console.error(' :', error);
        await showCustomAlert({ 
          icon: '', 
          title: '', 
          message: '\n\n' + error.message, 
          btnClass: 'modal-btn-danger' 
        });
      }
    };

    window.addEventListener('DOMContentLoaded', async () => {
      while (!window.firebaseReady || !window.db) await new Promise(r => setTimeout(r, 100));
      await loadStoreList();
      if (sessionStorage.getItem('handyStoreId')) {
        currentStoreId = sessionStorage.getItem('handyStoreId');
        window.currentStoreId = currentStoreId; // 
        currentStoreName = sessionStorage.getItem('handyStoreName');
        
        console.log('');
        console.log(' HANDY ID');
        console.log('   currentStoreId:', currentStoreId);
        console.log('   window.currentStoreId:', window.currentStoreId);
        console.log('   currentStoreName:', currentStoreName);
        console.log('');
        
        showTablesScreen();
      }
    });
    
    // ==========  (pos.html) ==========
    
    // CSV
    window.confirmSettlement = async function() {
      // Firebase
      if (!window.firebaseReady) {
        await new Promise(resolve => {
          window.addEventListener('firebaseReady', resolve, { once: true });
        });
      }
      
      //  
      const shouldBackup = await new Promise((resolve) => {
        // HTML
        const modal = document.createElement('div');
        modal.id = 'backupConfirmModal';
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
          background: rgba(0,0,0,0.7); display: flex; align-items: center; 
          justify-content: center; z-index: 999999; animation: fadeIn 0.2s;
        `;
        
        modal.innerHTML = `
          <div style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px; padding: 0; max-width: 500px; width: 90%;
            box-shadow: 0 25px 60px rgba(0,0,0,0.4); overflow: hidden;
            animation: slideUp 0.3s;
          ">
            <div style="background: white; padding: 32px; border-radius: 0 0 24px 24px;">
              <div style="text-align: center; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: bold; color: #333; margin-bottom: 8px;">
                  
                </h3>
              </div>
              
              <div style="background: #f0f7ff; border-left: 4px solid #667eea; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-weight: bold; color: #667eea; margin-bottom: 12px; font-size: 16px;">: </div>
                <div style="color: #555; font-size: 14px; line-height: 1.8;">
                  <br>
                  • <br>
                  • <br>
                  • <br>
                  • <br>
                  • <br>
                  • <br>
                  • <br>
                  • <br>
                  • <br>
                  • <br><br>
                  <br>
                  7
                </div>
              </div>
              
              <div style="background: #fff9e6; border-left: 4px solid #ff9800; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <div style="font-weight: bold; color: #ff9800; margin-bottom: 8px; font-size: 15px;"></div>
                <div style="color: #666; font-size: 14px;"></div>
              </div>
              
              <div style="display: flex; gap: 12px;">
                <button id="backupNoBtn" style="
                  flex: 1; padding: 16px; font-size: 16px; font-weight: bold;
                  border: 2px solid #ddd; border-radius: 12px; cursor: pointer;
                  background: white; color: #666; transition: all 0.2s;
                " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                  
                </button>
                <button id="backupYesBtn" style="
                  flex: 1; padding: 16px; font-size: 16px; font-weight: bold;
                  border: none; border-radius: 12px; cursor: pointer;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                  transition: all 0.2s;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.5)'" 
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'">
                  
                </button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('backupYesBtn').onclick = () => {
          modal.remove();
          resolve(true);
        };
        document.getElementById('backupNoBtn').onclick = () => {
          modal.remove();
          resolve(false);
        };
      });
      
      if (shouldBackup) {
        console.log(' ');
        const backupSuccess = await window.createAutoBackup();
        if (!backupSuccess) {
          const continueAnyway = confirm('\n\n');
          if (!continueAnyway) {
            return;
          }
        } else {
          console.log('  - ');
        }
      } else {
        console.log(' ');
      }
      
      try {
        const settlementData = window.currentSettlementData;
        const dateStr = window.currentSettlementDate;
        
        if (!settlementData) {
          alert('');
          return;
        }
        
        console.log(' ');
        console.log(' settlementData:', settlementData);
        
        // =====  =====
        const now = new Date();
        const outputTime = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        
        // =====  =====
        const staffSelect = document.getElementById('staffSelect');
        const staffName = staffSelect.value || '';
        
        // ===== dailySales =====
        const customerCount = settlementData.customerCount || 0;
        const totalItems = settlementData.totalItems || 0;
        const totalSales = settlementData.totalSales || 0;
        const averageSpend = customerCount > 0 ? Math.round(totalSales / customerCount) : 0;
        
        // =====  =====
        const cashSales = settlementData.cashSales || 0;
        const emoneSales = settlementData.emoneSales || 0;
        const creditSales = settlementData.creditSales || 0;
        const discountTotal = settlementData.totalDiscount || 0;
        
        // =====  =====
        const tax8TotalWithTax = settlementData.tax8Total || 0;  // 8%
        const tax10TotalWithTax = settlementData.tax10Total || 0; // 10%
        
        // 
        const tax8Excluded = Math.floor(tax8TotalWithTax / 1.08);  // 8%
        const tax10Excluded = Math.floor(tax10TotalWithTax / 1.10); // 10%
        
        // 
        const tax8Amount = tax8TotalWithTax - tax8Excluded;  // 8%
        const tax10Amount = tax10TotalWithTax - tax10Excluded; // 10%
        
        // 
        const totalTax = tax8Amount + tax10Amount;  // 
        const taxExcludedTotal = tax8Excluded + tax10Excluded;  // 
        const taxIncludedTotal = tax8TotalWithTax + tax10TotalWithTax;  // 8%10%
        
        //  
        let tax8InclusiveTotal = 0;
        let tax10InclusiveTotal = 0;
        let tax8ExclusiveTotal = 0;
        let tax10ExclusiveTotal = 0;
        let redSlipTax8Inclusive = 0;
        let redSlipTax10Inclusive = 0;
        let redSlipTax8Exclusive = 0;
        let redSlipTax10Exclusive = 0;
        
        try {
          const ordersQuery = window.query(
            window.getStoreCollection('orders'),
            window.where('paidAt', '!=', null)
          );
          const ordersSnapshot = await window.getDocs(ordersQuery);
          
          ordersSnapshot.forEach(doc => {
            const data = doc.data();
            if (!data.paidAt || !data.items) return;
            
            const orderDate = data.paidAt.toDate();
            let targetDate = new Date(orderDate);
            if (orderDate.getHours() < 3) {
              targetDate.setDate(targetDate.getDate() - 1);
            }
            
            const orderDateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-${String(targetDate.getDate()).padStart(2, '0')}`;
            
            if (orderDateStr === dateStr) {
              const isRedSlip = data.isRedSlip || false;
              
              data.items.forEach(item => {
                const taxType = item.taxType || 'inclusive';
                const taxAmount = getTaxAmount(item, item.quantity || 1);
                
                if ((item.taxRate || 10) === 8) {
                  if (taxType === 'exclusive') {
                    tax8ExclusiveTotal += taxAmount;
                    if (isRedSlip) redSlipTax8Exclusive += taxAmount;
                  } else {
                    tax8InclusiveTotal += taxAmount;
                    if (isRedSlip) redSlipTax8Inclusive += taxAmount;
                  }
                } else {
                  if (taxType === 'exclusive') {
                    tax10ExclusiveTotal += taxAmount;
                    if (isRedSlip) redSlipTax10Exclusive += taxAmount;
                  } else {
                    tax10InclusiveTotal += taxAmount;
                    if (isRedSlip) redSlipTax10Inclusive += taxAmount;
                  }
                }
              });
            }
          });
          
          console.log(' :', {
            tax8Inclusive: tax8InclusiveTotal,
            tax8Exclusive: tax8ExclusiveTotal,
            tax10Inclusive: tax10InclusiveTotal,
            tax10Exclusive: tax10ExclusiveTotal
          });
        } catch (e) {
          console.error(':', e);
        }
        
        // =====  =====
        const drawerOpenCount = settlementData.drawerOpenCount || 0;
        console.log(' drawerOpenCount:', drawerOpenCount);
        console.log(' settlementData:', settlementData);
        
        // =====   =====
        const redSlipCount = settlementData.redSlipCount || 0;
        const redSlipAmount = settlementData.redSlipAmount || 0;
        const redSlipTax8Total = settlementData.redSlipTax8Total || 0;
        const redSlipTax10Total = settlementData.redSlipTax10Total || 0;
        console.log(' :', redSlipCount);
        console.log(' :', redSlipAmount);
        console.log(' 8%:', redSlipTax8Total);
        console.log(' 10%:', redSlipTax10Total);
        
        // =====  =====
        let expenseTotal = 0;
        try {
          const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
          if (expenseDoc.exists()) {
            expenseTotal = expenseDoc.data().total || 0;
            console.log(' :', expenseTotal);
          }
        } catch (e) {
          console.error(':', e);
        }
        
        // =====  =====
        let laborCost = 0;
        try {
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(docData => {
            const data = docData.data();
            if (data.date === dateStr) {
              // 
              if (data.totalWage && data.totalWage > 0) {
                laborCost += data.totalWage;
              } else if (data.clockIn && data.clockOut) {
                // 
                const clockIn = new Date(`${dateStr} ${data.clockIn}`);
                const clockOut = new Date(`${dateStr} ${data.clockOut}`);
                let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                
                // 
                if (data.breakStart1 && data.breakEnd1) {
                  const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                  const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                  workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                }
                if (data.breakStart2 && data.breakEnd2) {
                  const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                  const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                  workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                }
                
                const hourlyRate = data.hourlyRate || 1150;
                
                // 
                let totalWage = 0;
                const isHoliday = data.isHoliday || false;
                
                // 
                let currentTime = new Date(clockIn);
                const endTime = new Date(clockOut);
                
                while (currentTime < endTime) {
                  const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                  const segmentEnd = nextHour > endTime ? endTime : nextHour;
                  
                  // 
                  let isBreak = false;
                  if (data.breakStart1 && data.breakEnd1) {
                    const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                    const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                    if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                      isBreak = true;
                    }
                  }
                  if (data.breakStart2 && data.breakEnd2) {
                    const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                    const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                    if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                      isBreak = true;
                    }
                  }
                  
                  if (!isBreak) {
                    const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                    const hour = currentTime.getHours();
                    
                    let rate = 1.0;
                    if (isHoliday) {
                      // : 35%
                      rate = 1.35;
                      // 22525%60%
                      if (hour >= 22 || hour < 5) {
                        rate = 1.60;
                      }
                    } else {
                      // : 22525%
                      if (hour >= 22 || hour < 5) {
                        rate = 1.25;
                      }
                    }
                    
                    totalWage += segmentHours * hourlyRate * rate;
                  }
                  
                  currentTime = segmentEnd;
                }
                
                laborCost += totalWage;
              }
            }
          });
          console.log(' :', laborCost);
        } catch (e) {
          console.error(':', e);
        }
        
        // 
        const finalTotalSales = taxIncludedTotal - discountTotal - expenseTotal;
        
        // =====  =====
        console.log(' :', dateStr);
        console.log(' :', outputTime);
        console.log(' :', customerCount);
        console.log(' :', totalItems);
        console.log(' :', averageSpend);
        console.log(' :', totalSales);
        console.log(' :', discountTotal);
        console.log(' 8%:', tax8TotalWithTax);
        console.log(' 8%:', tax8Excluded);
        console.log(' 8%:', tax8Amount);
        console.log(' 10%:', tax10TotalWithTax);
        console.log(' 10%:', tax10Excluded);
        console.log(' 10%:', tax10Amount);
        console.log(' :', drawerOpenCount);
        console.log(' :', staffName);
        
        // =====  =====
        const journalText = `
=====================================
      
=====================================
: ${outputTime}
: ${customerCount}
: ${totalItems}
: ¥${averageSpend.toLocaleString()}
: ¥${totalSales.toLocaleString()}

-------------------------------------

-------------------------------------
: ¥${cashSales.toLocaleString()}
: ¥${emoneSales.toLocaleString()}
: ¥${creditSales.toLocaleString()}
: ¥${discountTotal.toLocaleString()}

-------------------------------------
※
-------------------------------------
8%: ¥${tax8Excluded.toLocaleString()}
8%: ¥${tax8TotalWithTax.toLocaleString()}
8%: ¥${tax8Amount.toLocaleString()}
  : ¥${tax8InclusiveTotal.toLocaleString()}
  : ¥${tax8ExclusiveTotal.toLocaleString()}

10%: ¥${tax10Excluded.toLocaleString()}
10%: ¥${tax10TotalWithTax.toLocaleString()}
10%: ¥${tax10Amount.toLocaleString()}
  : ¥${tax10InclusiveTotal.toLocaleString()}
  : ¥${tax10ExclusiveTotal.toLocaleString()}

: ¥${totalTax.toLocaleString()}
: ¥${taxExcludedTotal.toLocaleString()}
: ¥${taxIncludedTotal.toLocaleString()}
${redSlipCount > 0 ? `
-------------------------------------

-------------------------------------
8%: -¥${Math.floor(redSlipTax8Total / 1.08).toLocaleString()}
8%: -¥${redSlipTax8Total.toLocaleString()}
8%: -¥${(redSlipTax8Total - Math.floor(redSlipTax8Total / 1.08)).toLocaleString()}
  : -¥${redSlipTax8Inclusive.toLocaleString()}
  : -¥${redSlipTax8Exclusive.toLocaleString()}

10%: -¥${Math.floor(redSlipTax10Total / 1.10).toLocaleString()}
10%: -¥${redSlipTax10Total.toLocaleString()}
10%: -¥${(redSlipTax10Total - Math.floor(redSlipTax10Total / 1.10)).toLocaleString()}
  : -¥${redSlipTax10Inclusive.toLocaleString()}
  : -¥${redSlipTax10Exclusive.toLocaleString()}

: -¥${((redSlipTax8Total - Math.floor(redSlipTax8Total / 1.08)) + (redSlipTax10Total - Math.floor(redSlipTax10Total / 1.10))).toLocaleString()}
: -¥${(Math.floor(redSlipTax8Total / 1.08) + Math.floor(redSlipTax10Total / 1.10)).toLocaleString()}
: -¥${(redSlipTax8Total + redSlipTax10Total).toLocaleString()}

-------------------------------------
 
-------------------------------------
8%: ¥${Math.floor((tax8TotalWithTax - redSlipTax8Total) / 1.08).toLocaleString()}
8%: ¥${(tax8TotalWithTax - redSlipTax8Total).toLocaleString()}
8%: ¥${((tax8TotalWithTax - redSlipTax8Total) - Math.floor((tax8TotalWithTax - redSlipTax8Total) / 1.08)).toLocaleString()}
  : ¥${(tax8InclusiveTotal - redSlipTax8Inclusive).toLocaleString()}
  : ¥${(tax8ExclusiveTotal - redSlipTax8Exclusive).toLocaleString()}

10%: ¥${Math.floor((tax10TotalWithTax - redSlipTax10Total) / 1.10).toLocaleString()}
10%: ¥${(tax10TotalWithTax - redSlipTax10Total).toLocaleString()}
10%: ¥${((tax10TotalWithTax - redSlipTax10Total) - Math.floor((tax10TotalWithTax - redSlipTax10Total) / 1.10)).toLocaleString()}
  : ¥${(tax10InclusiveTotal - redSlipTax10Inclusive).toLocaleString()}
  : ¥${(tax10ExclusiveTotal - redSlipTax10Exclusive).toLocaleString()}

: ¥${(((tax8TotalWithTax - redSlipTax8Total) - Math.floor((tax8TotalWithTax - redSlipTax8Total) / 1.08)) + ((tax10TotalWithTax - redSlipTax10Total) - Math.floor((tax10TotalWithTax - redSlipTax10Total) / 1.10))).toLocaleString()}
: ¥${(Math.floor((tax8TotalWithTax - redSlipTax8Total) / 1.08) + Math.floor((tax10TotalWithTax - redSlipTax10Total) / 1.10)).toLocaleString()}
: ¥${((tax8TotalWithTax - redSlipTax8Total) + (tax10TotalWithTax - redSlipTax10Total)).toLocaleString()}
` : ''}
: ¥${expenseTotal.toLocaleString()}
: ¥${(redSlipCount > 0 ? ((tax8TotalWithTax - redSlipTax8Total) + (tax10TotalWithTax - redSlipTax10Total)) - expenseTotal : taxIncludedTotal - expenseTotal).toLocaleString()}

-------------------------------------

-------------------------------------
: ${drawerOpenCount}
: ${redSlipCount}
: ¥${redSlipAmount.toLocaleString()}
: ¥${Math.round(laborCost).toLocaleString()}
: ${staffName}

=====================================
`;
        
        // ===== HTMLPNG =====
        const journalDiv = document.createElement('div');
        journalDiv.style.cssText = `
          font-family: 'Courier New', monospace;
          font-size: 14px;
          line-height: 1.6;
          padding: 30px;
          background: white;
          color: black;
          white-space: pre-wrap;
          width: 800px;
          position: absolute;
          left: -9999px;
        `;
        
        // HTML
        journalDiv.innerHTML = journalText
          .replace(/^(: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>')
          .replace(/^(: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>')
          .replace(/^( )$/gm, '<span style="color: #1976d2; font-weight: bold;">$1</span>');
        
        document.body.appendChild(journalDiv);
        
        // html2canvas
        const canvas = await html2canvas(journalDiv, {
          scale: 2,
          backgroundColor: '#ffffff',
          logging: false
        });
        
        // PNG
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `_${dateStr}.png`;
          link.click();
          URL.revokeObjectURL(url);
          document.body.removeChild(journalDiv);
        });
        
        // ===== Firebase =====
        await window.addDoc(window.getStoreCollection('settlements'), {
          date: dateStr,
          outputTime: outputTime,
          timestamp: window.Timestamp.now(),
          customerCount: customerCount,
          totalItems: totalItems,
          averageSpend: averageSpend,
          totalSales: totalSales,
          cashSales: cashSales,
          emoneSales: emoneSales,
          creditSales: creditSales,
          discountTotal: discountTotal,
          tax8TotalWithTax: tax8TotalWithTax,
          tax8Excluded: tax8Excluded,
          tax8Amount: tax8Amount,
          tax10TotalWithTax: tax10TotalWithTax,
          tax10Excluded: tax10Excluded,
          tax10Amount: tax10Amount,
          totalTax: totalTax,
          taxExcludedTotal: taxExcludedTotal,
          taxIncludedTotal: taxIncludedTotal,
          drawerOpenCount: drawerOpenCount,
          redSlipCount: redSlipCount,  //  
          redSlipAmount: redSlipAmount,  //  
          redSlipTax8Total: redSlipTax8Total,  //  8%
          redSlipTax10Total: redSlipTax10Total,  //  10%
          staffName: staffName,
          aiComment: ""
        });
        
        console.log(' ');
        closeSettlementModal();
        
      } catch (e) {
        console.error(' :', e);
        alert(': ' + e.message);
      }
    };
    
    // 
    window.closeSettlementModal = function() {
      document.getElementById('settlementModal').classList.add('hidden');
    };
    
    // =====  =====
    let expenseRows = [];
    let currentExpenseDate = null;
    
    // 
    window.showExpenseModal = async function() {
      const now = new Date();
      const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
      
      // 3
      const todayStart = new Date(jstNow);
      todayStart.setHours(3, 0, 0, 0);
      if (jstNow.getHours() < 3) {
        todayStart.setDate(todayStart.getDate() - 1);
      }
      
      const year = todayStart.getFullYear();
      const month = String(todayStart.getMonth() + 1).padStart(2, '0');
      const day = String(todayStart.getDate()).padStart(2, '0');
      currentExpenseDate = `${year}-${month}-${day}`;
      
      // 
      document.getElementById('expenseDateInput').value = currentExpenseDate;
      
      console.log('  - :', currentExpenseDate);
      console.log(' (JST):', jstNow.toLocaleString('ja-JP'));
      
      // Firebase
      await loadExpensesByDate();
      
      document.getElementById('expenseModal').classList.remove('hidden');
    };
    
    // 
    window.loadExpensesByDate = async function() {
      const selectedDate = document.getElementById('expenseDateInput').value;
      if (!selectedDate) {
        console.warn(' ');
        return;
      }
      
      currentExpenseDate = selectedDate;
      console.log('  - :', currentExpenseDate);
      
      try {
        const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', currentExpenseDate));
        
        if (expenseDoc.exists()) {
          const data = expenseDoc.data();
          expenseRows = data.items || [];
          console.log(' :', currentExpenseDate, ':', expenseRows.length);
          console.log(' :', expenseRows);
        } else {
          // 
          console.log(' :', currentExpenseDate);
          expenseRows = [
            { storeName: '', category: '', detail: '', amount: 0 },
            { storeName: '', category: '', detail: '', amount: 0 },
            { storeName: '', category: '', detail: '', amount: 0 }
          ];
        }
      } catch (e) {
        console.error(' :', e);
        expenseRows = [
          { storeName: '', category: '', detail: '', amount: 0 },
          { storeName: '', category: '', detail: '', amount: 0 },
          { storeName: '', category: '', detail: '', amount: 0 }
        ];
      }
      
      renderExpenseTable();
    };
    
    // 
    window.closeExpenseModal = function() {
      document.getElementById('expenseModal').classList.add('hidden');
      
      // URL
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('modal') === 'expense') {
        window.close();
      }
    };
    
    // 
    window.addExpenseRow = function() {
      expenseRows.push({
        storeName: '',
        category: '',
        detail: '',
        amount: 0
      });
      renderExpenseTable();
    };
    
    // 
    window.deleteExpenseRow = function(index) {
      expenseRows.splice(index, 1);
      renderExpenseTable();
    };
    
    // 
    // 
    const categoryTaxRates = {
      '': 8,
      '': 8,
      '': 8,
      '': 8,
      '': 10,
      '': 10,
      '': 10,
      '10%': 10,
      '': 10
    };
    
    function renderExpenseTable() {
      const tbody = document.getElementById('expenseTableBody');
      tbody.innerHTML = '';
      
      expenseRows.forEach((row, index) => {
        const taxRate = categoryTaxRates[row.category] || 10;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding: 8px; border: 1px solid #ddd;">
            <input type="text" value="${row.storeName}" onchange="updateExpenseRow(${index}, 'storeName', this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <select onchange="updateExpenseRow(${index}, 'category', this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
              <option value=""></option>
              <option value="" ${row.category === '' ? 'selected' : ''}>8%</option>
              <option value="" ${row.category === '' ? 'selected' : ''}>10%</option>
              <option value="" ${row.category === '' ? 'selected' : ''}>10%</option>
              <option value="" ${row.category === '' ? 'selected' : ''}>8%</option>
              <option value="" ${row.category === '' ? 'selected' : ''}>8%</option>
              <option value="" ${row.category === '' ? 'selected' : ''}>10%</option>
              <option value="" ${row.category === '' ? 'selected' : ''}></option>
              <option value="10%" ${row.category === '10%' ? 'selected' : ''}>10%</option>
              <option value="" ${row.category === '' ? 'selected' : ''}>10%</option>
            </select>
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <input type="text" value="${row.detail}" onchange="updateExpenseRow(${index}, 'detail', this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <input type="number" value="${row.amount}" onchange="updateExpenseRow(${index}, 'amount', parseFloat(this.value) || 0)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
            <button onclick="deleteExpenseRow(${index})" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;"></button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      updateExpenseTotal();
    }
    
    // 
    window.updateExpenseRow = function(index, field, value) {
      expenseRows[index][field] = value;
      
      // 
      if (field === 'category' && value === '') {
        expenseRows[index]['detail'] = '';
      }
      
      updateExpenseTotal();
      renderExpenseTable(); // 
    };
    
    // 
    function updateExpenseTotal() {
      const total = expenseRows.reduce((sum, row) => sum + (parseFloat(row.amount) || 0), 0);
      document.getElementById('expenseTotal').textContent = total.toLocaleString();
    }
    
    // 
    window.saveExpenses = async function() {
      try {
        console.log('  - :', currentExpenseDate);
        console.log(' :', expenseRows);
        
        // 
        const validRows = expenseRows.filter(row => 
          row.storeName || row.category || row.detail || row.amount
        );
        
        const total = validRows.reduce((sum, row) => sum + (parseFloat(row.amount) || 0), 0);
        
        const currentStaff = document.getElementById('staffSelect')?.value || 'POS';
        
        await window.setDoc(window.getStoreDoc('expenses', currentExpenseDate), {
          date: currentExpenseDate,
          staff: currentStaff,
          items: validRows,
          total: total,
          updatedAt: window.Timestamp.now()
        });
        
        console.log('  - :', currentExpenseDate, ':', validRows.length, ':', total);
        alert(`\n: ${currentExpenseDate}\n: ${validRows.length}\n: ¥${total.toLocaleString()}`);
        closeExpenseModal();
        
      } catch (e) {
        console.error(' :', e);
        alert(': ' + e.message);
      }
    };
    
    // Excelkeihi.html
    window.exportExpensesToCSV = async function() {
      try {
        console.log(' Excel');
        
        if (expenseRows.length === 0) {
          alert('');
          return;
        }
        
        // 
        const categoryTaxRates = {
          '': 8,
          '': 8,
          '': 8,
          '': 8,
          '': 10,
          '': 10,
          '': 10,
          '10%': 10,
          '': 10
        };
        
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        
        // Excel
        const excelData = [];
        
        // 
        excelData.push(['', '', '', '', '']);
        excelData.push([`${year}${month}`, '', '', '', '']);
        excelData.push([':', new Date().toLocaleString('ja-JP'), '', '', '']);
        excelData.push(['', '', '', '', '']);
        
        // 8%
        excelData.push(['8%', '', '', '', '']);
        excelData.push(['', '', '', '', '']);
        
        const tax8Items = expenseRows.filter(e => 
          e.category === '' || e.category === '' || e.category === ''
        );
        let tax8Total = 0;
        
        tax8Items.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax8Total += item.amount;
        });
        
        excelData.push(['', '', '', '8%:', tax8Total]);
        excelData.push(['', '', '', '', '']);
        
        // 10%
        excelData.push(['10%', '', '', '', '']);
        excelData.push(['', '', '', '', '']);
        
        const tax10Items = expenseRows.filter(e => 
          e.category === '' || e.category === '' || 
          e.category === '' || e.category === ''
        );
        let tax10Total = 0;
        
        tax10Items.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax10Total += item.amount;
        });
        
        excelData.push(['', '', '', '10%:', tax10Total]);
        excelData.push(['', '', '', '', '']);
        
        // 
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', '', '']);
        
        const sozeikokaItems = expenseRows.filter(e => e.category === '');
        let sozeikokaTotal = 0;
        
        sozeikokaItems.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          sozeikokaTotal += item.amount;
        });
        
        excelData.push(['', '', '', ':', sozeikokaTotal]);
        excelData.push(['', '', '', '', '']);
        
        // 10%
        excelData.push(['10%', '', '', '', '']);
        excelData.push(['', '', '', '', '']);
        
        const transport10Items = expenseRows.filter(e => e.category === '10%');
        let transport10Total = 0;
        
        transport10Items.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          transport10Total += item.amount;
        });
        
        excelData.push(['', '', '', '10%:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        
        // 
        const grandTotal = tax8Total + tax10Total + sozeikokaTotal + transport10Total;
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', '8%:', tax8Total]);
        excelData.push(['', '', '', '10%:', tax10Total]);
        excelData.push(['', '', '', ':', sozeikokaTotal]);
        excelData.push(['', '', '', '10%:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', ':', grandTotal]);
        
        // SheetJSExcel
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // 
        ws['!cols'] = [
          { wch: 10 },  // 
          { wch: 15 },  // 
          { wch: 15 },  // 
          { wch: 25 },  // 
          { wch: 12 }   // 
        ];
        
        // 
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        for (let R = range.s.r; R <= range.e.r; R++) {
          for (let C = range.s.c; C <= range.e.c; C++) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            
            if (!ws[cellAddress]) {
              ws[cellAddress] = { t: 's', v: '' };
            }
            
            if (!ws[cellAddress].s) {
              ws[cellAddress].s = {};
            }
            
            // 
            ws[cellAddress].s.border = {
              top: { style: 'thin', color: { rgb: '000000' } },
              bottom: { style: 'thin', color: { rgb: '000000' } },
              left: { style: 'thin', color: { rgb: '000000' } },
              right: { style: 'thin', color: { rgb: '000000' } }
            };
            
            // 
            if (R === 0 || (excelData[R] && excelData[R][0] && excelData[R][0].includes(''))) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'D3D3D3' }
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
            }
            
            // 8%10%
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%:' || excelData[R][3] === '10%:' || 
                 excelData[R][3] === ':' || excelData[R][3] === '10%:')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFE599' }  // 
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
              // 
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // 8%10%
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%:' || excelData[R][3] === '10%:' || 
                 excelData[R][3] === ':' || excelData[R][3] === '10%:' ||
                 excelData[R][3] === ':')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFC7CE' }  // 
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
              // 
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // :
            if (excelData[R] && excelData[R][3] === ':') {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFB6C1' }  // 
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 14,
                color: { rgb: 'FF0000' }  // 
              };
            }
          }
        }
        
        XLSX.utils.book_append_sheet(wb, ws, '');
        
        const fileName = `_${year}${month}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        console.log(' Excel:', fileName);
        alert(`\n${fileName}`);
        
      } catch (e) {
        console.error(' :', e);
        alert(': ' + e.message);
      }
    };
    
    // ===== 1 =====
    window.exportMonthlyExpenses = async function(year = null, month = null) {
      try {
        console.log(' ');
        
        // 
        if (!year || !month) {
          const now = new Date();
          const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
          
          // 3
          const todayStart = new Date(jstNow);
          todayStart.setHours(3, 0, 0, 0);
          if (jstNow.getHours() < 3) {
            todayStart.setDate(todayStart.getDate() - 1);
          }
          
          year = todayStart.getFullYear();
          month = todayStart.getMonth() + 1;
        }
        
        console.log(` : ${year}${month}`);
        
        // 
        const expensesSnapshot = await window.getDocs(window.getStoreCollection('expenses'));
        
        const monthlyExpenses = [];
        expensesSnapshot.forEach(doc => {
          const data = doc.data();
          const date = data.date;
          
          // 
          if (date && date.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
            if (data.items && Array.isArray(data.items)) {
              data.items.forEach(item => {
                monthlyExpenses.push({
                  date: date,
                  staff: data.staff || '',
                  storeName: item.storeName,
                  category: item.category,
                  detail: item.detail,
                  amount: item.amount
                });
              });
            }
          }
        });
        
        // 
        monthlyExpenses.sort((a, b) => a.date.localeCompare(b.date));
        
        console.log(':', monthlyExpenses.length, '');
        
        if (monthlyExpenses.length === 0) {
          alert('');
          return;
        }
        
        // Excel
        const excelData = [];
        
        // 
        excelData.push(['', '', '', '', '', '']);
        excelData.push([`${year}${month}`, '', '', '', '', '']);
        excelData.push([':', new Date().toLocaleString('ja-JP'), '', '', '', '']);
        excelData.push(['', '', '', '', '', '']);
        
        // 8%
        excelData.push(['8%', '', '', '', '', '']);
        excelData.push(['', '', '', '', '']);
        
        const tax8Items = monthlyExpenses.filter(e => 
          e.category === '' || e.category === '' || e.category === ''
        );
        let tax8Total = 0;
        
        tax8Items.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax8Total += item.amount;
        });
        
        excelData.push(['', '', '', '8%:', tax8Total]);
        excelData.push(['', '', '', '', '']);
        
        // 10%
        excelData.push(['10%', '', '', '', '', '']);
        excelData.push(['', '', '', '', '']);
        
        const tax10Items = monthlyExpenses.filter(e => 
          e.category === '' || e.category === '' || 
          e.category === '' || e.category === ''
        );
        let tax10Total = 0;
        
        tax10Items.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax10Total += item.amount;
        });
        
        excelData.push(['', '', '', '10%:', tax10Total]);
        excelData.push(['', '', '', '', '']);
        
        // 
        excelData.push(['', '', '', '', '', '']);
        excelData.push(['', '', '', '', '']);
        
        const sozeikokaItems = monthlyExpenses.filter(e => e.category === '');
        let sozeikokaTotal = 0;
        
        sozeikokaItems.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          sozeikokaTotal += item.amount;
        });
        
        excelData.push(['', '', '', ':', sozeikokaTotal]);
        excelData.push(['', '', '', '', '']);
        
        // 10%
        excelData.push(['10%', '', '', '', '', '']);
        excelData.push(['', '', '', '', '']);
        
        const transport10Items = monthlyExpenses.filter(e => e.category === '10%');
        let transport10Total = 0;
        
        transport10Items.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          transport10Total += item.amount;
        });
        
        excelData.push(['', '', '', '10%:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        
        // 
        const grandTotal = tax8Total + tax10Total + sozeikokaTotal + transport10Total;
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', '8%:', tax8Total]);
        excelData.push(['', '', '', '10%:', tax10Total]);
        excelData.push(['', '', '', ':', sozeikokaTotal]);
        excelData.push(['', '', '', '10%:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', ':', grandTotal]);
        
        // SheetJSExcel
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // 
        ws['!cols'] = [
          { wch: 10 },  // 
          { wch: 15 },  // 
          { wch: 15 },  // 
          { wch: 25 },  // 
          { wch: 12 }   // 
        ];
        
        // 
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        for (let R = range.s.r; R <= range.e.r; ++R) {
          for (let C = range.s.c; C <= range.e.c; ++C) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            
            if (!ws[cellAddress]) continue;
            
            // 
            ws[cellAddress].s = ws[cellAddress].s || {};
            ws[cellAddress].s.border = {
              top: { style: 'thin', color: { rgb: '000000' } },
              bottom: { style: 'thin', color: { rgb: '000000' } },
              left: { style: 'thin', color: { rgb: '000000' } },
              right: { style: 'thin', color: { rgb: '000000' } }
            };
            
            // 
            if (R === 0) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'ADD8E6' }  // 
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 16
              };
            }
            
            // 8%
            if (excelData[R] && excelData[R][0] && excelData[R][0].startsWith('')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFFF99' }  // 
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
            }
            
            // 
            if (excelData[R] && excelData[R][0] === '') {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'D3D3D3' }  // 
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
            }
            
            // 8%10%
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%:' || excelData[R][3] === '10%:' ||
                 excelData[R][3] === ':' || excelData[R][3] === '10%:')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFE4B5' }  // 
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
              // 
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // 8%10%
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%:' || excelData[R][3] === '10%:' || 
                 excelData[R][3] === ':' || excelData[R][3] === '10%:' ||
                 excelData[R][3] === ':')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFC7CE' }  // 
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
              // 
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // :
            if (excelData[R] && excelData[R][3] === ':') {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFB6C1' }  // 
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 14,
                color: { rgb: 'FF0000' }  // 
              };
            }
          }
        }
        
        XLSX.utils.book_append_sheet(wb, ws, '');
        
        const fileName = `_${year}${month}_.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        console.log(' Excel:', fileName);
        alert(`\n${fileName}\n\n: ${year}${month}1`);
        
      } catch (e) {
        console.error(' :', e);
        alert(': ' + e.message);
      }
    };
    
    // 
    window.showExpenseExportModal = function() {
      // 2020
      const currentYear = new Date().getFullYear();
      const yearSelect = document.getElementById('expenseExportYear');
      yearSelect.innerHTML = '';
      
      for (let year = currentYear; year >= 2020; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + '';
        yearSelect.appendChild(option);
      }
      
      // 
      const currentMonth = new Date().getMonth() + 1;
      document.getElementById('expenseExportMonth').value = currentMonth;
      
      // 
      document.getElementById('expenseExportModal').style.display = 'flex';
    };
    
    // 
    window.closeExpenseExportModal = function() {
      document.getElementById('expenseExportModal').style.display = 'none';
    };
    
    // 
    window.confirmExpenseExport = async function() {
      const year = parseInt(document.getElementById('expenseExportYear').value);
      const month = parseInt(document.getElementById('expenseExportMonth').value);
      
      closeExpenseExportModal();
      await exportMonthlyExpenses(year, month);
    };
    
    // =====  =====
    window.generateDailyReport = async function() {
      try {
        console.log(' ');
        
        // 
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        
        // 
        const firstDay = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0);
        const daysInMonth = lastDay.getDate();
        
        console.log(`${year}${month}...`);
        
        // Firestore
        const dailySalesSnapshot = await window.getDocs(window.getStoreCollection('dailySales'));
        
        // 
        const salesByDate = {};
        dailySalesSnapshot.forEach(doc => {
          const data = doc.data();
          const date = data.date;
          
          // 
          if (date && date.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
            salesByDate[date] = data;
          }
        });
        
        console.log(':', salesByDate);
        
        // Excel
        const excelData = [];
        
        // 1
        excelData.push(['', '', '', '', '', '', '', '', '', '', '   ', '', '', '']);
        excelData.push(['', '', '', '', '', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', `${year}-${String(month).padStart(2, '0')}-01`, '', '', '', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', '', '', '', '', '', '', '', '', '', '', '', '', '']);
        
        // 2
        excelData.push(['', '', '', '', '', '', '', '', '', '%', '', '', 'TOTAL', '']);
        
        // 
        const weekDays = ['', '', '', '', '', '', ''];
        
        // 
        let totalGrossProfit = 0;
        
        // 
        let sumCustomerCount = 0;
        let sumCashSales = 0;
        let sumCreditSales = 0;
        let sumEmoneSales = 0;
        let sumTotalSales = 0;
        let sumLaborCost = 0;
        let sumPayment = 0;
        let sumNetSales = 0;
        
        // 
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const date = new Date(year, month - 1, day);
          const weekDay = weekDays[date.getDay()];
          
          const data = salesByDate[dateStr];
          
          if (data) {
            // 
            const customerCount = data.customerCount || 0;
            const cashSales = data.cashSales || 0;
            const creditSales = data.creditSales || 0;
            const emoneSales = data.emoneSales || 0;
            const totalSales = cashSales + creditSales + emoneSales;
            
            // kintai_attendance
            let laborCost = 0;
            try {
              const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
              attendanceSnapshot.forEach(docData => {
                const attData = docData.data();
                if (attData.date === dateStr) {
                  // 
                  if (attData.totalWage && attData.totalWage > 0) {
                    laborCost += attData.totalWage;
                  } else if (attData.clockIn && attData.clockOut) {
                    // 
                    const clockIn = new Date(`${dateStr} ${attData.clockIn}`);
                    const clockOut = new Date(`${dateStr} ${attData.clockOut}`);
                    let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                    
                    if (attData.breakStart1 && attData.breakEnd1) {
                      const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                      const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                      workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                    }
                    if (attData.breakStart2 && attData.breakEnd2) {
                      const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                      const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                      workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                    }
                    
                    const hourlyRate = attData.hourlyRate || 1150;
                    
                    // 
                    let totalWage = 0;
                    const isHoliday = attData.isHoliday || false;
                    
                    // 
                    let currentTime = new Date(clockIn);
                    const endTime = new Date(clockOut);
                    
                    while (currentTime < endTime) {
                      const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                      const segmentEnd = nextHour > endTime ? endTime : nextHour;
                      
                      // 
                      let isBreak = false;
                      if (attData.breakStart1 && attData.breakEnd1) {
                        const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                        const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                        if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                          isBreak = true;
                        }
                      }
                      if (attData.breakStart2 && attData.breakEnd2) {
                        const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                        const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                        if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                          isBreak = true;
                        }
                      }
                      
                      if (!isBreak) {
                        const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                        const hour = currentTime.getHours();
                        
                        let rate = 1.0;
                        if (isHoliday) {
                          // : 35%
                          rate = 1.35;
                          // 22525%60%
                          if (hour >= 22 || hour < 5) {
                            rate = 1.60;
                          }
                        } else {
                          // : 22525%
                          if (hour >= 22 || hour < 5) {
                            rate = 1.25;
                          }
                        }
                        
                        totalWage += segmentHours * hourlyRate * rate;
                      }
                      
                      currentTime = segmentEnd;
                    }
                    
                    laborCost += totalWage;
                  }
                }
              });
            } catch (e) {
              console.error(':', e);
            }
            
            const laborCostPercent = totalSales > 0 ? Math.round(laborCost / totalSales * 100) : 0;
            
            // expenses
            let payment = 0;
            try {
              const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
              if (expenseDoc.exists()) {
                payment = expenseDoc.data().total || 0;
              }
            } catch (e) {
              console.error(':', e);
            }
            
            // 
            const netSales = totalSales - laborCost - payment;
            
            // 
            totalGrossProfit += netSales;
            
            // 
            sumCustomerCount += customerCount;
            sumCashSales += cashSales;
            sumCreditSales += creditSales;
            sumEmoneSales += emoneSales;
            sumTotalSales += totalSales;
            sumLaborCost += laborCost;
            sumPayment += payment;
            sumNetSales += netSales;
            
            excelData.push([
              '',
              date,
              weekDay,
              customerCount,
              cashSales,
              creditSales,
              emoneSales,
              totalSales,
              Math.round(laborCost),
              laborCostPercent + '%',  // %
              payment,
              Math.round(netSales),
              Math.round(totalGrossProfit),
              '' // 
            ]);
          } else {
            // 
            excelData.push([
              '',
              date,
              weekDay,
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              ''
            ]);
          }
        }
        
        // 
        const avgLaborCostPercent = sumTotalSales > 0 ? Math.round(sumLaborCost / sumTotalSales * 100) : 0;
        excelData.push([
          '',
          '',
          '',
          sumCustomerCount,
          sumCashSales,
          sumCreditSales,
          sumEmoneSales,
          sumTotalSales,
          Math.round(sumLaborCost),
          avgLaborCostPercent + '%',
          sumPayment,
          Math.round(sumNetSales),
          '', // TOTAL
          ''
        ]);
        
        console.log('Excel:', excelData.length, '');
        
        // SheetJSExcel
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // 
        ws['!cols'] = [
          { wch: 3 },  // A
          { wch: 12 }, // B
          { wch: 5 },  // C
          { wch: 8 },  // D
          { wch: 10 }, // E
          { wch: 10 }, // F
          { wch: 10 }, // Gpaypay
          { wch: 10 }, // H
          { wch: 10 }, // I
          { wch: 10 }, // J%
          { wch: 10 }, // K
          { wch: 10 }, // L
          { wch: 12 }, // MTOTAL
          { wch: 10 }  // N
        ];
        
        //  
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        for (let R = range.s.r; R <= range.e.r; R++) {
          for (let C = range.s.c; C <= range.e.c; C++) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            
            // 
            if (!ws[cellAddress]) {
              ws[cellAddress] = { t: 's', v: '' };
            }
            
            // 
            if (!ws[cellAddress].s) {
              ws[cellAddress].s = {};
            }
            
            // 
            ws[cellAddress].s.border = {
              top: { style: 'thin', color: { rgb: '000000' } },
              bottom: { style: 'thin', color: { rgb: '000000' } },
              left: { style: 'thin', color: { rgb: '000000' } },
              right: { style: 'thin', color: { rgb: '000000' } }
            };
            
            // 5 = R=4
            if (R === 4) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'D3D3D3' }
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
              ws[cellAddress].s.alignment = {
                horizontal: 'center',
                vertical: 'center'
              };
            }
            
            // 
            if (R === range.e.r) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFFFCC' }
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
            }
            
            // 
            if (C >= 3 && C <= 12 && R >= 5) {
              if (!ws[cellAddress].s.alignment) {
                ws[cellAddress].s.alignment = {};
              }
              ws[cellAddress].s.alignment.horizontal = 'right';
            }
          }
        }
        
        XLSX.utils.book_append_sheet(wb, ws, '');
        
        // 
        const fileName = `${year}${month}.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        console.log(' :', fileName);
        alert(`\n${fileName}`);
        
      } catch (e) {
        console.error(' :', e);
        alert(': ' + e.message);
      }
    };
    
    // =====  =====
    window.generatePeriodJournal = async function() {
      try {
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;
        
        if (!startDate || !endDate) {
          alert('');
          return;
        }
        
        if (startDate > endDate) {
          alert('');
          return;
        }
        
        console.log(` : ${startDate}  ${endDate}`);
        
        const container = document.getElementById('monthlyReportContent');
        container.innerHTML = '<div style="text-align: center; padding: 40px;">...</div>';
        
        // 
        const start = new Date(startDate);
        const end = new Date(endDate);
        const dates = [];
        
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
          dates.push(dateStr);
        }
        
        // 
        let totalCustomerCount = 0;
        let totalItems = 0;
        let totalCashSales = 0;
        let totalEmoneSales = 0;
        let totalCreditSales = 0;
        let totalDiscount = 0;
        let totalTax8 = 0;
        let totalTax10 = 0;
        let totalDrawerOpen = 0;
        let totalRedSlipCount = 0;  //  
        let totalRedSlipAmount = 0;  //  
        let totalRedSlipTax8 = 0;  //  8%
        let totalRedSlipTax10 = 0;  //  10%
        let totalExpense = 0;
        let totalLaborCost = 0;
        const itemCounts = {}; // 
        
        // orders
        const ordersQuery = window.query(
          window.getStoreCollection('orders'),
          window.where('paidAt', '!=', null)
        );
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          // paidAt
          if (!data.paidAt) return;
          
          const orderDate = data.paidAt.toDate();
          
          // 3
          let targetDate = new Date(orderDate);
          if (orderDate.getHours() < 3) {
            targetDate.setDate(targetDate.getDate() - 1);
          }
          
          const orderDateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-${String(targetDate.getDate()).padStart(2, '0')}`;
          
          // 
          if (dates.includes(orderDateStr) && data.items) {
            data.items.forEach(item => {
              itemCounts[item.name] = (itemCounts[item.name] || 0) + (item.quantity || 1);
            });
          }
        });
        
        console.log(' orders:', itemCounts);
        
        for (const dateStr of dates) {
          // 
          const salesDoc = await window.getDoc(window.getStoreDoc('dailySales', dateStr));
          if (salesDoc.exists()) {
            const data = salesDoc.data();
            totalCustomerCount += data.customerCount || 0;
            totalItems += data.totalItems || 0;
            totalCashSales += data.cashSales || 0;
            totalEmoneSales += data.emoneSales || 0;
            totalCreditSales += data.creditSales || 0;
            totalDiscount += data.totalDiscount || 0;
            totalTax8 += data.tax8Total || 0;
            totalTax10 += data.tax10Total || 0;
            totalDrawerOpen += data.drawerOpenCount || 0;
            totalRedSlipCount += data.redSlipCount || 0;  //  
            totalRedSlipAmount += data.redSlipAmount || 0;  //  
            totalRedSlipTax8 += data.redSlipTax8Total || 0;  //  8%
            totalRedSlipTax10 += data.redSlipTax10Total || 0;  //  10%
          }
          
          // 
          const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
          if (expenseDoc.exists()) {
            totalExpense += expenseDoc.data().total || 0;
          }
          
          // 
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(doc => {
            const attData = doc.data();
            if (attData.date === dateStr) {
              // 
              if (attData.totalWage && attData.totalWage > 0) {
                totalLaborCost += attData.totalWage;
              } else if (attData.clockIn && attData.clockOut) {
                // 
                const clockIn = new Date(`${dateStr} ${attData.clockIn}`);
                const clockOut = new Date(`${dateStr} ${attData.clockOut}`);
                let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                
                if (attData.breakStart1 && attData.breakEnd1) {
                  const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                  const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                  workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                }
                if (attData.breakStart2 && attData.breakEnd2) {
                  const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                  const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                  workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                }
                
                const hourlyRate = attData.hourlyRate || 1150;
                
                // 
                let totalWage = 0;
                const isHoliday = attData.isHoliday || false;
                
                // 
                let currentTime = new Date(clockIn);
                const endTime = new Date(clockOut);
                
                while (currentTime < endTime) {
                  const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                  const segmentEnd = nextHour > endTime ? endTime : nextHour;
                  
                  // 
                  let isBreak = false;
                  if (attData.breakStart1 && attData.breakEnd1) {
                    const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                    const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                    if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                      isBreak = true;
                    }
                  }
                  if (attData.breakStart2 && attData.breakEnd2) {
                    const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                    const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                    if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                      isBreak = true;
                    }
                  }
                  
                  if (!isBreak) {
                    const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                    const hour = currentTime.getHours();
                    
                    let rate = 1.0;
                    if (isHoliday) {
                      // : 35%
                      rate = 1.35;
                      // 22525%60%
                      if (hour >= 22 || hour < 5) {
                        rate = 1.60;
                      }
                    } else {
                      // : 22525%
                      if (hour >= 22 || hour < 5) {
                        rate = 1.25;
                      }
                    }
                    
                    totalWage += segmentHours * hourlyRate * rate;
                  }
                  
                  currentTime = segmentEnd;
                }
                
                totalLaborCost += totalWage;
              }
            }
          });
        }
        
        // 
        const totalSales = totalCashSales + totalEmoneSales + totalCreditSales;
        const averageSpend = totalCustomerCount > 0 ? Math.round(totalSales / totalCustomerCount) : 0;
        
        //  
        // 
        let tax8InclusiveTotal = 0;
        let tax10InclusiveTotal = 0;
        let tax8ExclusiveTotal = 0;
        let tax10ExclusiveTotal = 0;
        //  
        let redSlipTax8Inclusive = 0;
        let redSlipTax10Inclusive = 0;
        let redSlipTax8Exclusive = 0;
        let redSlipTax10Exclusive = 0;
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          if (!data.paidAt || !data.items) return;
          
          const orderDate = data.paidAt.toDate();
          let targetDate = new Date(orderDate);
          if (orderDate.getHours() < 3) {
            targetDate.setDate(targetDate.getDate() - 1);
          }
          
          const orderDateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-${String(targetDate.getDate()).padStart(2, '0')}`;
          
          if (dates.includes(orderDateStr)) {
            const isRedSlip = data.isRedSlip || false;  //  
            
            data.items.forEach(item => {
              const taxType = item.taxType || 'inclusive';
              const taxAmount = getTaxAmount(item, item.quantity || 1);
              
              if ((item.taxRate || 10) === 8) {
                if (taxType === 'exclusive') {
                  tax8ExclusiveTotal += taxAmount;
                  if (isRedSlip) redSlipTax8Exclusive += taxAmount;  // 
                } else {
                  tax8InclusiveTotal += taxAmount;
                  if (isRedSlip) redSlipTax8Inclusive += taxAmount;  // 
                }
              } else {
                if (taxType === 'exclusive') {
                  tax10ExclusiveTotal += taxAmount;
                  if (isRedSlip) redSlipTax10Exclusive += taxAmount;  // 
                } else {
                  tax10InclusiveTotal += taxAmount;
                  if (isRedSlip) redSlipTax10Inclusive += taxAmount;  // 
                }
              }
            });
          }
        });
        
        // 
        const tax8Excluded = Math.floor(totalTax8 / 1.08);
        const tax10Excluded = Math.floor(totalTax10 / 1.10);
        const tax8Amount = totalTax8 - tax8Excluded;
        const tax10Amount = totalTax10 - tax10Excluded;
        const totalTax = tax8Amount + tax10Amount;
        const taxExcludedTotal = tax8Excluded + tax10Excluded;
        const taxIncludedTotal = totalTax8 + totalTax10;
        const finalTotalSales = taxIncludedTotal - totalDiscount - totalExpense;
        
        const now = new Date();
        const outputTime = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        
        // 
        const journalText = `
=====================================
      
=====================================
: ${startDate}  ${endDate}
: ${outputTime}
: ${totalCustomerCount}
: ${totalItems}
: ¥${averageSpend.toLocaleString()}
: ¥${totalSales.toLocaleString()}

-------------------------------------

-------------------------------------
: ¥${totalCashSales.toLocaleString()}
: ¥${totalEmoneSales.toLocaleString()}
: ¥${totalCreditSales.toLocaleString()}
: ¥${totalDiscount.toLocaleString()}

-------------------------------------
※
-------------------------------------
8%
: ¥${tax8InclusiveTotal.toLocaleString()}
: ¥${tax8ExclusiveTotal.toLocaleString()}
8%: ¥${(tax8InclusiveTotal + tax8ExclusiveTotal).toLocaleString()}

10%
: ¥${tax10InclusiveTotal.toLocaleString()}
: ¥${tax10ExclusiveTotal.toLocaleString()}
10%: ¥${(tax10InclusiveTotal + tax10ExclusiveTotal).toLocaleString()}

: ¥${(tax8InclusiveTotal + tax8ExclusiveTotal + tax10InclusiveTotal + tax10ExclusiveTotal).toLocaleString()}
: ¥${taxExcludedTotal.toLocaleString()}
: ¥${taxIncludedTotal.toLocaleString()}
${totalRedSlipCount > 0 ? `
-------------------------------------

-------------------------------------
8%: -¥${Math.floor(totalRedSlipTax8 / 1.08).toLocaleString()}
8%: -¥${totalRedSlipTax8.toLocaleString()}
8%: -¥${(totalRedSlipTax8 - Math.floor(totalRedSlipTax8 / 1.08)).toLocaleString()}
  : -¥${redSlipTax8Inclusive.toLocaleString()}
  : -¥${redSlipTax8Exclusive.toLocaleString()}

10%: -¥${Math.floor(totalRedSlipTax10 / 1.10).toLocaleString()}
10%: -¥${totalRedSlipTax10.toLocaleString()}
10%: -¥${(totalRedSlipTax10 - Math.floor(totalRedSlipTax10 / 1.10)).toLocaleString()}
  : -¥${redSlipTax10Inclusive.toLocaleString()}
  : -¥${redSlipTax10Exclusive.toLocaleString()}

: -¥${((totalRedSlipTax8 - Math.floor(totalRedSlipTax8 / 1.08)) + (totalRedSlipTax10 - Math.floor(totalRedSlipTax10 / 1.10))).toLocaleString()}
: -¥${(Math.floor(totalRedSlipTax8 / 1.08) + Math.floor(totalRedSlipTax10 / 1.10)).toLocaleString()}
: -¥${(totalRedSlipTax8 + totalRedSlipTax10).toLocaleString()}

-------------------------------------
 
-------------------------------------
8%: ¥${Math.floor((totalTax8 - totalRedSlipTax8) / 1.08).toLocaleString()}
8%: ¥${(totalTax8 - totalRedSlipTax8).toLocaleString()}
8%: ¥${((totalTax8 - totalRedSlipTax8) - Math.floor((totalTax8 - totalRedSlipTax8) / 1.08)).toLocaleString()}
  : ¥${(tax8InclusiveTotal - redSlipTax8Inclusive).toLocaleString()}
  : ¥${(tax8ExclusiveTotal - redSlipTax8Exclusive).toLocaleString()}

10%: ¥${Math.floor((totalTax10 - totalRedSlipTax10) / 1.10).toLocaleString()}
10%: ¥${(totalTax10 - totalRedSlipTax10).toLocaleString()}
10%: ¥${((totalTax10 - totalRedSlipTax10) - Math.floor((totalTax10 - totalRedSlipTax10) / 1.10)).toLocaleString()}
  : ¥${(tax10InclusiveTotal - redSlipTax10Inclusive).toLocaleString()}
  : ¥${(tax10ExclusiveTotal - redSlipTax10Exclusive).toLocaleString()}

: ¥${(((totalTax8 - totalRedSlipTax8) - Math.floor((totalTax8 - totalRedSlipTax8) / 1.08)) + ((totalTax10 - totalRedSlipTax10) - Math.floor((totalTax10 - totalRedSlipTax10) / 1.10))).toLocaleString()}
: ¥${(Math.floor((totalTax8 - totalRedSlipTax8) / 1.08) + Math.floor((totalTax10 - totalRedSlipTax10) / 1.10)).toLocaleString()}
: ¥${((totalTax8 - totalRedSlipTax8) + (totalTax10 - totalRedSlipTax10)).toLocaleString()}
` : ''}
: ¥${totalExpense.toLocaleString()}
: ¥${(totalRedSlipCount > 0 ? ((totalTax8 - totalRedSlipTax8) + (totalTax10 - totalRedSlipTax10)) - totalExpense : taxIncludedTotal - totalExpense).toLocaleString()}

-------------------------------------

-------------------------------------
: ${totalDrawerOpen}
: ${totalRedSlipCount}
: ¥${totalRedSlipAmount.toLocaleString()}
: ¥${Math.round(totalLaborCost).toLocaleString()}

=====================================
`;
        
        // PNG
        const journalDiv = document.createElement('div');
        journalDiv.style.cssText = `
          font-family: 'Courier New', monospace;
          font-size: 14px;
          line-height: 1.6;
          padding: 30px;
          background: white;
          color: black;
          white-space: pre-wrap;
          position: absolute;
          left: -9999px;
        `;
        
        // HTML
        journalDiv.innerHTML = journalText
          .replace(/^(: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>')
          .replace(/^(: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>')
          .replace(/^( )$/gm, '<span style="color: #1976d2; font-weight: bold;">$1</span>');
        
        document.body.appendChild(journalDiv);
        
        const canvas = await html2canvas(journalDiv, {
          backgroundColor: '#ffffff',
          scale: 2
        });
        
        document.body.removeChild(journalDiv);
        
        const link = document.createElement('a');
        link.download = `_${startDate}_${endDate}.png`;
        link.href = canvas.toDataURL();
        link.click();
        
        console.log(' ');
        
        // 
        const sortedItems = Object.entries(itemCounts).sort((a, b) => b[1] - a[1]);
        console.log(' :', itemCounts);
        console.log(' :', sortedItems);
        
        // HTML
        let itemCountsHtml = '';
        sortedItems.forEach(([itemName, count]) => {
          itemCountsHtml += `
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
              <span>${itemName}</span>
              <strong>${count}</strong>
            </div>
          `;
        });
        
        // 
        container.innerHTML = `
          <div style="padding: 20px;">
            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border-radius: 12px; margin-bottom: 20px;">
              <div style="font-size: 18px; margin-bottom: 10px;"> </div>
              <div style="font-size: 14px; opacity: 0.9;">: ${startDate}  ${endDate}</div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
              <h4 style="margin: 0 0 15px 0; color: #333;"></h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;"></div>
                  <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">¥${(totalCashSales + totalEmoneSales + totalCreditSales).toLocaleString()}</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;"></div>
                  <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${totalCustomerCount}</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;"></div>
                  <div style="font-size: 24px; font-weight: bold; color: #FF9800;">${totalItems}</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;"></div>
                  <div style="font-size: 24px; font-weight: bold; color: #9C27B0;">¥${totalCustomerCount > 0 ? Math.round((totalCashSales + totalEmoneSales + totalCreditSales) / totalCustomerCount).toLocaleString() : 0}</div>
                </div>
              </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
              <h4 style="margin: 0 0 15px 0; color: #333;"> </h4>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span></span>
                <strong>¥${totalCashSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span></span>
                <strong>¥${totalEmoneSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span></span>
                <strong>¥${totalCreditSales.toLocaleString()}</strong>
              </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
              <h4 style="margin: 0 0 15px 0; color: #333;"></h4>
              <div style="max-height: 300px; overflow-y: auto;">
                ${itemCountsHtml || '<div style="text-align: center; color: #999;"></div>'}
              </div>
            </div>
          </div>
        `;
        
      } catch (e) {
        console.error(' :', e);
        alert(': ' + e.message);
      }
    };
    
    // /
    window.showPeriodJournalModal = function() {
      // 
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('monthlyReportModal').style.display = 'flex';
      
      // 
      const now = new Date();
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      
      document.getElementById('reportStartDate').value = `${firstDay.getFullYear()}-${String(firstDay.getMonth()+1).padStart(2,'0')}-${String(firstDay.getDate()).padStart(2,'0')}`;
      document.getElementById('reportEndDate').value = `${lastDay.getFullYear()}-${String(lastDay.getMonth()+1).padStart(2,'0')}-${String(lastDay.getDate()).padStart(2,'0')}`;
    };
    
    window.closePeriodJournalModal = function() {
      document.getElementById('monthlyReportModal').style.display = 'none';
    };
    
    // 
    window.showSettlementModal = async function() {
      document.getElementById('settlementModal').style.display = 'flex';
      
      // 
      const now = new Date();
      let targetDate = new Date(now);
      if (now.getHours() < 3) {
        targetDate.setDate(targetDate.getDate() - 1);
      }
      const dateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth()+1).padStart(2,'0')}-${String(targetDate.getDate()).padStart(2,'0')}`;
      document.getElementById('settlementDate').value = dateStr;
      
      // 
      await loadSettlementSummary();
    };
    
    window.closeSettlementModal = function() {
      document.getElementById('settlementModal').style.display = 'none';
    };
    
    // 
    window.loadSettlementSummary = async function() {
      const dateStr = document.getElementById('settlementDate').value;
      if (!dateStr) return;
      
      try {
        const salesDoc = await window.getDoc(window.getStoreDoc('dailySales', dateStr));
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          window.currentSettlementData = data;
          window.currentSettlementDate = dateStr;
          
          const summary = document.getElementById('settlementSummary');
          summary.innerHTML = `
            <div style="padding: 15px; background: #f5f5f5; border-radius: 8px;">
              <h4 style="margin: 0 0 10px 0;"> (${dateStr})</h4>
              <p style="margin: 5px 0;">: ${data.customerCount || 0}</p>
              <p style="margin: 5px 0;">: ¥${(data.totalSales || 0).toLocaleString()}</p>
              <p style="margin: 5px 0;">: ¥${(data.cashSales || 0).toLocaleString()}</p>
              <p style="margin: 5px 0;">: ¥${(data.emoneSales || 0).toLocaleString()}</p>
              <p style="margin: 5px 0;">: ¥${(data.creditSales || 0).toLocaleString()}</p>
            </div>
          `;
        } else {
          const summary = document.getElementById('settlementSummary');
          summary.innerHTML = `<div style="padding: 15px; background: #fff3cd; border-radius: 8px; color: #856404;"></div>`;
          window.currentSettlementData = null;
        }
      } catch (e) {
        console.error(':', e);
      }
    };
    
    // ========== 
    
    // 
    window.showSalesModal = function() {
      document.getElementById('salesModal').style.display = 'flex';
      calculateSales();
      
      // 
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
    };
    
    // 
    window.closeSalesModal = function() {
      document.getElementById('salesModal').style.display = 'none';
    };
    
    //  - 
    window.calculateSales = async function() {
      const container = document.getElementById('salesContent');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">...</div>';
      
      try {
        // 3
        const now = new Date();
        let today = new Date(now);
        if (now.getHours() < 3) {
          today.setDate(today.getDate() - 1);
        }
        const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
        
        console.log(' :', dateStr);
        
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        let totalSales = 0;
        let cashSales = 0;
        let emoneSales = 0;
        let creditSales = 0;
        let orderCount = 0;
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          console.log(' :', data);
          totalSales = data.totalSales || 0;
          cashSales = data.cashSales || 0;
          emoneSales = data.emoneSales || 0;
          creditSales = data.creditSales || 0;
          orderCount = data.customerCount || 0;
        } else {
          console.log(' ');
        }
        
        // 
        let todayLaborCost = 0;
        try {
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.date === dateStr) {
              if (data.totalWage && data.totalWage > 0) {
                todayLaborCost += data.totalWage;
              } else if (data.clockIn && data.clockOut) {
                const clockIn = new Date(`${dateStr} ${data.clockIn}`);
                const clockOut = new Date(`${dateStr} ${data.clockOut}`);
                let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                
                if (data.breakStart1 && data.breakEnd1) {
                  const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                  const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                  workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                }
                if (data.breakStart2 && data.breakEnd2) {
                  const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                  const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                  workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                }
                
                const hourlyRate = data.hourlyRate || 1150;
                todayLaborCost += workHours * hourlyRate;
              }
            }
          });
        } catch (e) {
          console.error(':', e);
        }
        
        // 
        let todayExpense = 0;
        try {
          const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
          if (expenseDoc.exists()) {
            todayExpense = expenseDoc.data().total || 0;
          }
        } catch (e) {
          console.error(':', e);
        }
        
        // 
        const grossProfit = totalSales - todayLaborCost;
        const netProfit = totalSales - todayLaborCost - todayExpense;
        const netProfitRate = totalSales > 0 ? (netProfit / totalSales * 100).toFixed(1) : 0;
        const laborCostRate = totalSales > 0 ? (todayLaborCost / totalSales * 100).toFixed(1) : 0;
        const expenseRate = totalSales > 0 ? (todayExpense / totalSales * 100).toFixed(1) : 0;
        
        // 
        const dayOfWeek = today.getDay();
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
        const targetSales = isWeekend ? 70000 : 50000;
        const achievementRate = Math.round((totalSales / targetSales) * 100);
        const rateColor = achievementRate >= 100 ? '#4CAF50' : achievementRate >= 80 ? '#FF9800' : '#f44336';
        const netProfitColor = netProfit >= 0 ? '#4CAF50' : '#f44336';
        
        container.innerHTML = `
          <div style="background: white; border-radius: 12px; padding: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
              <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;"></div>
                <div style="font-size: 28px; font-weight: bold;">¥${totalSales.toLocaleString()}</div>
              </div>
              <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;"></div>
                <div style="font-size: 28px; font-weight: bold;">${orderCount}</div>
              </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
              <h4 style="margin: 0 0 10px 0;"></h4>
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>${isWeekend ? '' : ''}</span>
                <strong>¥${targetSales.toLocaleString()}</strong>
              </div>
              <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px; margin-top: 10px;">
                <div style="font-size: 32px; font-weight: bold; color: ${rateColor};">${achievementRate}%</div>
                <div style="font-size: 14px; opacity: 0.9;"></div>
              </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #FF6B6B 0%, #C92A2A 100%); border-radius: 10px; color: white;">
              <h4 style="margin: 0 0 15px 0;"></h4>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                <span></span>
                <strong>¥${totalSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                <span>− ${totalSales > 0 ? '' + laborCostRate + '%' : ''}</span>
                <strong>¥${Math.round(todayLaborCost).toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px;">
                <span>− ${totalSales > 0 ? '' + expenseRate + '%' : ''}</span>
                <strong>¥${Math.round(todayExpense).toLocaleString()}</strong>
              </div>
              <div style="border-top: 2px solid rgba(255,255,255,0.3); padding-top: 12px;">
                <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                  <div style="font-size: 16px; opacity: 0.9; margin-bottom: 5px;"></div>
                  <div style="font-size: 32px; font-weight: bold; color: ${netProfitColor};">¥${Math.round(netProfit).toLocaleString()}</div>
                  <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">: ${netProfitRate}%</div>
                </div>
              </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
              <h4 style="margin: 0 0 15px 0;"></h4>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span></span>
                <strong>¥${cashSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span></span>
                <strong>¥${creditSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span></span>
                <strong>¥${emoneSales.toLocaleString()}</strong>
              </div>
            </div>
          </div>
        `;
        
      } catch (e) {
        console.error(':', e);
        container.innerHTML = '<div style="text-align: center; color: red; padding: 20px;"></div>';
      }
    };
    
    // ==========   ==========
    
    window.showSettlementModal = async function() {
      // 
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('settlementModal').style.display = 'flex';
      
      // 
      const now = new Date();
      let today = new Date(now);
      if (now.getHours() < 3) {
        today.setDate(today.getDate() - 1);
      }
      const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      document.getElementById('settlementDate').value = dateStr;
      
      // 
      await loadSettlementSummary(dateStr);
    };
    
    window.closeSettlementModal = function() {
      document.getElementById('settlementModal').style.display = 'none';
    };
    
    async function loadSettlementSummary(dateStr) {
      const container = document.getElementById('settlementSummary');
      container.innerHTML = '<div style="text-align: center;">...</div>';
      
      try {
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        let settlementData = {
          totalSales: 0,
          customerCount: 0,
          totalItems: 0,
          cashSales: 0,
          emoneSales: 0,
          creditSales: 0,
          totalDiscount: 0,
          tax8Total: 0,
          tax10Total: 0,
          drawerOpenCount: 0,
          redSlipCount: 0,
          redSlipAmount: 0,
          redSlipTax8Total: 0,
          redSlipTax10Total: 0
        };
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          settlementData = {
            totalSales: data.totalSales || 0,
            customerCount: data.customerCount || 0,
            totalItems: data.totalItems || 0,
            cashSales: data.cashSales || 0,
            emoneSales: data.emoneSales || 0,
            creditSales: data.creditSales || 0,
            totalDiscount: data.totalDiscount || 0,
            tax8Total: data.tax8Total || 0,
            tax10Total: data.tax10Total || 0,
            drawerOpenCount: data.drawerOpenCount || 0,
            redSlipCount: data.redSlipCount || 0,
            redSlipAmount: data.redSlipAmount || 0,
            redSlipTax8Total: data.redSlipTax8Total || 0,
            redSlipTax10Total: data.redSlipTax10Total || 0
          };
          
          container.innerHTML = `
            <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
              <h4 style="margin: 0 0 10px 0;"></h4>
              <div style="display: grid; gap: 8px;">
                <div style="display: flex; justify-content: space-between;">
                  <span>:</span>
                  <strong>¥${settlementData.totalSales.toLocaleString()}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span>:</span>
                  <strong>${settlementData.customerCount}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span>:</span>
                  <strong>¥${settlementData.cashSales.toLocaleString()}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span>:</span>
                  <strong>¥${settlementData.creditSales.toLocaleString()}</strong>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span>:</span>
                  <strong>¥${settlementData.emoneSales.toLocaleString()}</strong>
                </div>
              </div>
            </div>
          `;
        } else {
          container.innerHTML = '<div style="text-align: center; color: #999;"></div>';
        }
        
        // 
        window.currentSettlementData = settlementData;
        window.currentSettlementDate = dateStr;
        
      } catch (e) {
        console.error(':', e);
        container.innerHTML = '<div style="text-align: center; color: red;"></div>';
      }
    }
    
    window.confirmSettlement = async function() {
      const dateStr = document.getElementById('settlementDate').value;
      if (!dateStr) {
        await showCustomAlert({ icon: '', title: '', message: '', btnClass: 'modal-btn-danger' });
        return;
      }
      
      try {
        const settlementData = window.currentSettlementData;
        
        if (!settlementData) {
          await showCustomAlert({ icon: '', title: '', message: '', btnClass: 'modal-btn-danger' });
          return;
        }
        
        console.log(' PNG + ');
        console.log(' settlementData:', settlementData);
        
        // =====  =====
        const now = new Date();
        const outputTime = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        
        // ===== dailySales =====
        const customerCount = settlementData.customerCount || 0;
        const totalItems = settlementData.totalItems || 0;
        const totalSales = settlementData.totalSales || 0;
        const averageSpend = customerCount > 0 ? Math.round(totalSales / customerCount) : 0;
        
        // =====  =====
        const cashSales = settlementData.cashSales || 0;
        const emoneSales = settlementData.emoneSales || 0;
        const creditSales = settlementData.creditSales || 0;
        const discountTotal = settlementData.totalDiscount || 0;
        
        // =====  =====
        const tax8TotalWithTax = settlementData.tax8Total || 0;
        const tax10TotalWithTax = settlementData.tax10Total || 0;
        
        const tax8Excluded = Math.floor(tax8TotalWithTax / 1.08);
        const tax10Excluded = Math.floor(tax10TotalWithTax / 1.10);
        
        const tax8Amount = tax8TotalWithTax - tax8Excluded;
        const tax10Amount = tax10TotalWithTax - tax10Excluded;
        
        const totalTax = tax8Amount + tax10Amount;
        const taxExcludedTotal = tax8Excluded + tax10Excluded;
        const taxIncludedTotal = tax8TotalWithTax + tax10TotalWithTax;
        
        // =====  =====
        const drawerOpenCount = settlementData.drawerOpenCount || 0;
        
        // =====  =====
        const redSlipCount = settlementData.redSlipCount || 0;
        const redSlipAmount = settlementData.redSlipAmount || 0;
        const redSlipTax8Total = settlementData.redSlipTax8Total || 0;
        const redSlipTax10Total = settlementData.redSlipTax10Total || 0;
        
        // =====  =====
        let expenseTotal = 0;
        try {
          const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
          if (expenseDoc.exists()) {
            expenseTotal = expenseDoc.data().total || 0;
          }
        } catch (e) {
          console.error(':', e);
        }
        
        // =====  =====
        let laborCost = 0;
        try {
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(docData => {
            const data = docData.data();
            if (data.date === dateStr) {
              if (data.totalWage && data.totalWage > 0) {
                laborCost += data.totalWage;
              }
            }
          });
        } catch (e) {
          console.error(':', e);
        }
        
        const finalTotalSales = taxIncludedTotal - discountTotal - expenseTotal;
        
        // =====  =====
        const journalText = `
=====================================
      
=====================================
: ${outputTime}
: ${customerCount}
: ${totalItems}
: ¥${averageSpend.toLocaleString()}
: ¥${totalSales.toLocaleString()}

-------------------------------------

-------------------------------------
: ¥${cashSales.toLocaleString()}
: ¥${emoneSales.toLocaleString()}
: ¥${creditSales.toLocaleString()}
: ¥${discountTotal.toLocaleString()}

-------------------------------------
※
-------------------------------------
8%: ¥${tax8Excluded.toLocaleString()}
8%: ¥${tax8TotalWithTax.toLocaleString()}
8%: ¥${tax8Amount.toLocaleString()}

10%: ¥${tax10Excluded.toLocaleString()}
10%: ¥${tax10TotalWithTax.toLocaleString()}
10%: ¥${tax10Amount.toLocaleString()}

: ¥${totalTax.toLocaleString()}
: ¥${taxExcludedTotal.toLocaleString()}
: ¥${taxIncludedTotal.toLocaleString()}
${redSlipCount > 0 ? `
-------------------------------------

-------------------------------------
8%: -¥${Math.floor(redSlipTax8Total / 1.08).toLocaleString()}
8%: -¥${redSlipTax8Total.toLocaleString()}
8%: -¥${(redSlipTax8Total - Math.floor(redSlipTax8Total / 1.08)).toLocaleString()}

10%: -¥${Math.floor(redSlipTax10Total / 1.10).toLocaleString()}
10%: -¥${redSlipTax10Total.toLocaleString()}
10%: -¥${(redSlipTax10Total - Math.floor(redSlipTax10Total / 1.10)).toLocaleString()}

: -¥${((redSlipTax8Total - Math.floor(redSlipTax8Total / 1.08)) + (redSlipTax10Total - Math.floor(redSlipTax10Total / 1.10))).toLocaleString()}
: -¥${(Math.floor(redSlipTax8Total / 1.08) + Math.floor(redSlipTax10Total / 1.10)).toLocaleString()}
: -¥${(redSlipTax8Total + redSlipTax10Total).toLocaleString()}

-------------------------------------
 
-------------------------------------
8%: ¥${Math.floor((tax8TotalWithTax - redSlipTax8Total) / 1.08).toLocaleString()}
8%: ¥${(tax8TotalWithTax - redSlipTax8Total).toLocaleString()}
8%: ¥${((tax8TotalWithTax - redSlipTax8Total) - Math.floor((tax8TotalWithTax - redSlipTax8Total) / 1.08)).toLocaleString()}

10%: ¥${Math.floor((tax10TotalWithTax - redSlipTax10Total) / 1.10).toLocaleString()}
10%: ¥${(tax10TotalWithTax - redSlipTax10Total).toLocaleString()}
10%: ¥${((tax10TotalWithTax - redSlipTax10Total) - Math.floor((tax10TotalWithTax - redSlipTax10Total) / 1.10)).toLocaleString()}

: ¥${(((tax8TotalWithTax - redSlipTax8Total) - Math.floor((tax8TotalWithTax - redSlipTax8Total) / 1.08)) + ((tax10TotalWithTax - redSlipTax10Total) - Math.floor((tax10TotalWithTax - redSlipTax10Total) / 1.10))).toLocaleString()}
: ¥${(Math.floor((tax8TotalWithTax - redSlipTax8Total) / 1.08) + Math.floor((tax10TotalWithTax - redSlipTax10Total) / 1.10)).toLocaleString()}
: ¥${((tax8TotalWithTax - redSlipTax8Total) + (tax10TotalWithTax - redSlipTax10Total)).toLocaleString()}
` : ''}
: ¥${expenseTotal.toLocaleString()}
: ¥${(redSlipCount > 0 ? ((tax8TotalWithTax - redSlipTax8Total) + (tax10TotalWithTax - redSlipTax10Total)) - expenseTotal : taxIncludedTotal - expenseTotal).toLocaleString()}

-------------------------------------

-------------------------------------
: ${drawerOpenCount}
: ${redSlipCount}
: ¥${redSlipAmount.toLocaleString()}
: ¥${Math.round(laborCost).toLocaleString()}

=====================================
`;
        
        // ===== HTMLPNG =====
        const journalDiv = document.createElement('div');
        journalDiv.style.cssText = `
          font-family: 'Courier New', monospace;
          font-size: 14px;
          line-height: 1.6;
          padding: 30px;
          background: white;
          color: black;
          white-space: pre-wrap;
          width: 800px;
          position: absolute;
          left: -9999px;
        `;
        
        journalDiv.innerHTML = journalText
          .replace(/^(: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>')
          .replace(/^(: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>')
          .replace(/^( )$/gm, '<span style="color: #1976d2; font-weight: bold;">$1</span>');
        
        document.body.appendChild(journalDiv);
        
        // html2canvas
        const canvas = await html2canvas(journalDiv, {
          scale: 2,
          backgroundColor: '#ffffff',
          logging: false
        });
        
        // PNG
        canvas.toBlob(async (blob) => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `_${dateStr}.png`;
          link.click();
          URL.revokeObjectURL(url);
          document.body.removeChild(journalDiv);
          
          // PNG
          await generateDailyReportForSettlement(dateStr);
        });
        
        console.log(' ');
        closeSettlementModal();
        
      } catch (e) {
        console.error(' :', e);
        await showCustomAlert({ icon: '', title: '', message: ': ' + e.message, btnClass: 'modal-btn-danger' });
      }
    };
    
    // 
    async function generateDailyReportForSettlement(dateStr) {
      try {
        console.log(' ');
        
        if (typeof XLSX === 'undefined') {
          console.error('XLSX');
          return;
        }
        
        // 
        const [year, month, day] = dateStr.split('-').map(Number);
        
        // 
        const lastDay = new Date(year, month, 0);
        const daysInMonth = lastDay.getDate();
        
        // Firestore
        const dailySalesSnapshot = await window.getDocs(window.getStoreCollection('dailySales'));
        
        const salesByDate = {};
        dailySalesSnapshot.forEach(doc => {
          const data = doc.data();
          const date = data.date;
          if (date && date.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
            salesByDate[date] = data;
          }
        });
        
        // Excel
        const excelData = [];
        excelData.push(['', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', `${year}-${String(month).padStart(2, '0')}-01`, '', '', '', '', '', '', '', '']);
        excelData.push(['', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', '', '', '', '', '', '', '', '', '']);
        
        const weekDays = ['', '', '', '', '', '', ''];
        
        let sumCustomerCount = 0;
        let sumCashSales = 0;
        let sumCreditSales = 0;
        let sumEmoneSales = 0;
        let sumTotalSales = 0;
        let sumPayment = 0;
        let sumNetSales = 0;
        
        for (let d = 1; d <= daysInMonth; d++) {
          const dStr = `${year}-${String(month).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
          const date = new Date(year, month - 1, d);
          const weekDay = weekDays[date.getDay()];
          
          const data = salesByDate[dStr];
          
          if (data) {
            const customerCount = data.customerCount || 0;
            const cashSales = data.cashSales || 0;
            const creditSales = data.creditSales || 0;
            const emoneSales = data.emoneSales || 0;
            const totalSales = cashSales + creditSales + emoneSales;
            
            let payment = 0;
            try {
              const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dStr));
              if (expenseDoc.exists()) {
                payment = expenseDoc.data().total || 0;
              }
            } catch (e) {
              console.error(':', e);
            }
            
            const netSales = totalSales - payment;
            
            sumCustomerCount += customerCount;
            sumCashSales += cashSales;
            sumCreditSales += creditSales;
            sumEmoneSales += emoneSales;
            sumTotalSales += totalSales;
            sumPayment += payment;
            sumNetSales += netSales;
            
            excelData.push([
              '',
              d,
              weekDay,
              customerCount,
              cashSales,
              creditSales,
              emoneSales,
              totalSales,
              payment,
              Math.round(netSales)
            ]);
          } else {
            excelData.push(['', d, weekDay, '', '', '', '', '', '', '']);
          }
        }
        
        excelData.push(['']);
        excelData.push([
          '',
          '',
          '',
          sumCustomerCount,
          sumCashSales,
          sumCreditSales,
          sumEmoneSales,
          sumTotalSales,
          sumPayment,
          Math.round(sumNetSales)
        ]);
        
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, `${month}`);
        
        XLSX.writeFile(wb, `_${year}${month}.xlsx`);
        
        await showCustomAlert({ icon: '', title: '', message: 'PNGExcel', btnClass: 'modal-btn-success' });
        
      } catch (e) {
        console.error(':', e);
        await showCustomAlert({ icon: '', title: '', message: ': ' + e.message, btnClass: 'modal-btn-danger' });
      }
    }
    
    window.generateDailyReport = async function() {
      try {
        console.log(' ');
        await showCustomAlert({ icon: 'ℹ', title: '', message: '', btnClass: 'modal-btn-primary' });
        
        // Excel XLSX 
        if (typeof XLSX === 'undefined') {
          await showCustomAlert({ icon: '', title: '', message: 'XLSX', btnClass: 'modal-btn-danger' });
          return;
        }
        
        // 
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        
        // 
        const lastDay = new Date(year, month, 0);
        const daysInMonth = lastDay.getDate();
        
        // Firestore
        const dailySalesSnapshot = await window.getDocs(window.getStoreCollection('dailySales'));
        
        const salesByDate = {};
        dailySalesSnapshot.forEach(doc => {
          const data = doc.data();
          const date = data.date;
          if (date && date.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
            salesByDate[date] = data;
          }
        });
        
        // Excel
        const excelData = [];
        excelData.push(['', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', `${year}-${String(month).padStart(2, '0')}-01`, '', '', '', '', '', '', '', '']);
        excelData.push(['', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', '', '', '', '', '', '', '', '', '']);
        
        const weekDays = ['', '', '', '', '', '', ''];
        
        let sumCustomerCount = 0;
        let sumCashSales = 0;
        let sumCreditSales = 0;
        let sumEmoneSales = 0;
        let sumTotalSales = 0;
        let sumPayment = 0;
        let sumNetSales = 0;
        
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const date = new Date(year, month - 1, day);
          const weekDay = weekDays[date.getDay()];
          
          const data = salesByDate[dateStr];
          
          if (data) {
            const customerCount = data.customerCount || 0;
            const cashSales = data.cashSales || 0;
            const creditSales = data.creditSales || 0;
            const emoneSales = data.emoneSales || 0;
            const totalSales = cashSales + creditSales + emoneSales;
            
            // 
            let payment = 0;
            try {
              const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
              if (expenseDoc.exists()) {
                payment = expenseDoc.data().total || 0;
              }
            } catch (e) {
              console.error(':', e);
            }
            
            const netSales = totalSales - payment;
            
            sumCustomerCount += customerCount;
            sumCashSales += cashSales;
            sumCreditSales += creditSales;
            sumEmoneSales += emoneSales;
            sumTotalSales += totalSales;
            sumPayment += payment;
            sumNetSales += netSales;
            
            excelData.push([
              '',
              day,
              weekDay,
              customerCount,
              cashSales,
              creditSales,
              emoneSales,
              totalSales,
              payment,
              Math.round(netSales)
            ]);
          } else {
            excelData.push(['', day, weekDay, '', '', '', '', '', '', '']);
          }
        }
        
        // 
        excelData.push(['']);
        excelData.push([
          '',
          '',
          '',
          sumCustomerCount,
          sumCashSales,
          sumCreditSales,
          sumEmoneSales,
          sumTotalSales,
          sumPayment,
          Math.round(sumNetSales)
        ]);
        
        // Excel
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, `${month}`);
        
        XLSX.writeFile(wb, `_${year}${month}.xlsx`);
        
        await showCustomAlert({ icon: '', title: '', message: '', btnClass: 'modal-btn-success' });
        
      } catch (e) {
        console.error(':', e);
        await showCustomAlert({ icon: '', title: '', message: ': ' + e.message, btnClass: 'modal-btn-danger' });
      }
    };
    
    // ==========   ==========
    
    let historyOrders = [];
    
    window.showHistoryModal = async function() {
      // 
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('historyModal').style.display = 'flex';
      await loadHistory();
    };
    
    window.closeHistoryModal = function() {
      document.getElementById('historyModal').style.display = 'none';
    };
    
    async function loadHistory() {
      try {
        const q = window.query(
          window.getStoreCollection('orders'),
          window.orderBy('timestamp', 'desc'),
          window.limit(100)
        );
        const ordersSnapshot = await window.getDocs(q);
        historyOrders = [];
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          historyOrders.push({
            id: doc.id,
            orderNumber: data.orderNumber || 0,
            timestamp: data.timestamp,
            tableNumber: data.tableNumber || '',
            items: data.items || [],
            totalAmount: data.totalAmount || 0,
            paymentMethod: data.paymentMethod || 'cash',
            paidAt: data.paidAt || null,
            completedAt: data.completedAt || null
          });
        });
        
        filterHistory();
      } catch (e) {
        console.error(':', e);
        await showCustomAlert({ 
          icon: '', 
          title: '', 
          message: '', 
          btnClass: 'modal-btn-danger' 
        });
      }
    }
    
    window.filterHistory = function() {
      const dateFilter = document.getElementById('historyDateFilter').value;
      const statusFilter = document.getElementById('historyStatusFilter').value;
      const now = new Date();
      
      let filtered = historyOrders.filter(order => {
        const orderDate = order.timestamp.toDate();
        
        let dateMatch = true;
        if (dateFilter === 'today') {
          const todayStart = new Date(now);
          todayStart.setHours(3, 0, 0, 0);
          if (now.getHours() < 3) {
            todayStart.setDate(todayStart.getDate() - 1);
          }
          const todayEnd = new Date(todayStart);
          todayEnd.setDate(todayEnd.getDate() + 1);
          dateMatch = orderDate >= todayStart && orderDate < todayEnd;
        } else if (dateFilter === 'yesterday') {
          const yesterdayStart = new Date(now);
          yesterdayStart.setHours(3, 0, 0, 0);
          if (now.getHours() < 3) {
            yesterdayStart.setDate(yesterdayStart.getDate() - 1);
          }
          yesterdayStart.setDate(yesterdayStart.getDate() - 1);
          const yesterdayEnd = new Date(yesterdayStart);
          yesterdayEnd.setDate(yesterdayEnd.getDate() + 1);
          dateMatch = orderDate >= yesterdayStart && orderDate < yesterdayEnd;
        } else if (dateFilter === 'week') {
          const weekAgo = new Date(now);
          weekAgo.setDate(weekAgo.getDate() - 7);
          dateMatch = orderDate >= weekAgo;
        } else if (dateFilter === 'month') {
          const monthStart = new Date(now);
          monthStart.setDate(1);
          monthStart.setHours(0, 0, 0, 0);
          dateMatch = orderDate >= monthStart;
        }
        
        let statusMatch = true;
        if (statusFilter === 'deleted') {
          statusMatch = order.deleted === true;
        } else if (statusFilter === 'paid') {
          statusMatch = order.paidAt !== null && !order.deleted;
        } else if (statusFilter === 'completed') {
          statusMatch = order.completedAt !== null && !order.deleted;
        }
        
        return dateMatch && statusMatch;
      });
      
      displayHistory(filtered);
    };
    
    function displayHistory(orders) {
      const container = document.getElementById('historyList');
      
      if (orders.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;"></div>';
        return;
      }
      
      container.innerHTML = '';
      
      orders.forEach(order => {
        const card = document.createElement('div');
        card.style.cssText = `
          background: white;
          border-radius: 12px;
          padding: 15px;
          margin-bottom: 15px;
          border: 2px solid #ddd;
        `;
        
        const orderDate = order.timestamp.toDate();
        const dateStr = orderDate.toLocaleString('ja-JP');
        
        const paymentMethodNames = {
          'cash': '',
          'emoney': '',
          'credit': ''
        };
        const paymentMethodLabel = paymentMethodNames[order.paymentMethod] || '';
        
        let itemsHtml = '';
        order.items.forEach(item => {
          itemsHtml += `<div style="padding: 5px 0; border-bottom: 1px solid #eee;">
            ${item.name} ×${item.quantity} - ¥${((item.price + (item.toppingPrice || 0)) * item.quantity).toLocaleString()}
          </div>`;
        });
        
        // 
        let badges = [];
        if (order.deleted) badges.push('<span style="background: #666; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;"></span>');
        if (order.paidAt) badges.push('<span style="background: #2196F3; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;"></span>');
        if (order.completedAt) badges.push('<span style="background: #4CAF50; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;"></span>');
        if (order.cancelledAt) badges.push('<span style="background: #f44336; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;"></span>');
        
        // 
        let buttonsHtml = `
          <div style="display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 2px solid #eee; flex-wrap: wrap;">
            <button onclick="editOrderFromHistory('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;"> </button>
            ${order.paidAt ? `
              <button onclick="redSlipFromHistory('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;"> </button>
            ` : `
              ${!order.deleted ? `
                <button onclick="deleteOrderFromHistory('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;"> </button>
              ` : `
                <button onclick="restoreOrderFromHistory('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;"></button>
              `}
            `}
            ${order.paidAt ? `
              <button onclick="reprintReceipt('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;"></button>
              <button onclick="reprintInvoice('${order.id}')" style="flex: 1; min-width: 100px; padding: 8px 12px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 12px;"></button>
            ` : ''}
          </div>
        `;
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div>
              <strong style="font-size: 18px; color: #667eea;">#${order.orderNumber}</strong>
              <span style="margin-left: 10px; color: #666;">${order.tableNumber}</span>
            </div>
            <div>${badges.join('')}</div>
          </div>
          <div style="font-size: 12px; color: #999; margin-bottom: 10px;">
            ${dateStr}
            ${order.paidAt ? `<span style="margin-left: 15px; padding: 4px 8px; background: #e3f2fd; color: #1976d2; border-radius: 4px; font-weight: bold;"> ${paymentMethodLabel}</span>` : ''}
          </div>
          <div style="margin-bottom: 10px; max-height: 150px; overflow-y: auto;">${itemsHtml}</div>
          <div style="text-align: right; font-size: 18px; font-weight: bold; color: #667eea; padding-top: 10px; border-top: 2px solid #eee;">
            : ¥${order.totalAmount.toLocaleString()}
          </div>
          ${buttonsHtml}
        `;
        
        container.appendChild(card);
      });
    }
    
    window.refreshHistory = async function() {
      await loadHistory();
    };
    
    // ==========  ==========
    window.redSlipFromHistory = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        if (!orderDoc.exists()) {
          await showCustomAlert({ icon: '', title: '', message: '', btnClass: 'modal-btn-danger' });
          return;
        }
        
        const orderData = { id: orderDoc.id, ...orderDoc.data() };
        
        if (!orderData.paidAt) {
          await showCustomAlert({ icon: '', title: '', message: '', btnClass: 'modal-btn-danger' });
          return;
        }
        
        const confirmed = confirm(` #${orderData.orderNumber} \n\n: ¥${orderData.totalAmount.toLocaleString()}\n\n :\n• \n• \n• \n• `);
        
        if (!confirmed) return;
        
        // 3
        const paidDate = orderData.paidAt.toDate();
        let businessDate = new Date(paidDate);
        
        if (paidDate.getHours() < 3) {
          businessDate.setDate(businessDate.getDate() - 1);
        }
        
        const dateStr = `${businessDate.getFullYear()}-${String(businessDate.getMonth() + 1).padStart(2, '0')}-${String(businessDate.getDate()).padStart(2, '0')}`;
        
        // dailySales
        const dailySalesRef = window.getStoreDoc('dailySales', dateStr);
        const dailySalesDoc = await window.getDoc(dailySalesRef);
        
        if (!dailySalesDoc.exists()) {
          await showCustomAlert({ icon: '', title: '', message: 'dailySales', btnClass: 'modal-btn-danger' });
          return;
        }
        
        const dailyData = dailySalesDoc.data();
        const totalAmount = orderData.totalAmount || 0;
        
        // 
        let tax8Total = 0;
        let tax10Total = 0;
        
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
            let itemTaxRate = item.taxRate || (item.takeout ? 8 : 10);
            
            if (itemTaxRate === 8) {
              tax8Total += itemTotal;
            } else {
              tax10Total += itemTotal;
            }
          });
        }
        
        // 
        let cashSales = 0, emoneSales = 0, creditSales = 0;
        const paymentMethod = orderData.paymentMethod || '';
        if (paymentMethod === '' || paymentMethod === 'cash') cashSales = totalAmount;
        else if (paymentMethod === '' || paymentMethod === 'emoney') emoneSales = totalAmount;
        else if (paymentMethod === '' || paymentMethod === 'credit') creditSales = totalAmount;
        
        // 
        let totalItems = 0;
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            totalItems += item.quantity || 0;
          });
        }
        
        // dailySales
        const updateData = {
          totalSales: Math.max(0, (dailyData.totalSales || 0) - totalAmount),
          customerCount: Math.max(0, (dailyData.customerCount || 0) - 1),
          totalItems: Math.max(0, (dailyData.totalItems || 0) - totalItems),
          cashSales: Math.max(0, (dailyData.cashSales || 0) - cashSales),
          emoneSales: Math.max(0, (dailyData.emoneSales || 0) - emoneSales),
          creditSales: Math.max(0, (dailyData.creditSales || 0) - creditSales),
          tax8Total: Math.max(0, (dailyData.tax8Total || 0) - tax8Total),
          tax10Total: Math.max(0, (dailyData.tax10Total || 0) - tax10Total),
          redSlipCount: (dailyData.redSlipCount || 0) + 1,
          redSlipAmount: (dailyData.redSlipAmount || 0) + totalAmount,
          redSlipTax8Total: (dailyData.redSlipTax8Total || 0) + tax8Total,
          redSlipTax10Total: (dailyData.redSlipTax10Total || 0) + tax10Total
        };
        
        await window.updateDoc(dailySalesRef, updateData);
        
        // redSlips
        const redSlipData = {
          ...orderData,
          redSlippedAt: window.Timestamp.now(),
          redSlippedBy: window.currentStoreId,
          businessDate: dateStr,
          originalOrderId: orderData.id,
          calculatedTax8Total: tax8Total,
          calculatedTax10Total: tax10Total
        };
        
        const redSlipRef = window.doc(window.collection(window.db, 'stores', window.currentStoreId, 'redSlips'));
        await window.setDoc(redSlipRef, redSlipData);
        
        // 
        await window.deleteDoc(window.getStoreDoc('orders', orderData.id));
        
        await showCustomAlert({ icon: 'ℹ', title: '', message: ` #${orderData.orderNumber} \n\n: ¥${totalAmount.toLocaleString()}\n\n`, btnClass: 'modal-btn-primary' });
        
        // 
        await loadHistory();
        
      } catch (e) {
        console.error(':', e);
        alert(': ' + e.message);
      }
    };
    
    // ==========  ==========
    window.reprintReceipt = async function(orderId) {
      await showCustomAlert({ icon: 'ℹ', title: '', message: '\n\n\n', btnClass: 'modal-btn-primary' });
    };
    
    window.reprintInvoice = async function(orderId) {
      await showCustomAlert({ icon: 'ℹ', title: '', message: '\n\n\n', btnClass: 'modal-btn-primary' });
    };
    
    // ==========  ==========
    
    let currentEditingOrder = null;
    
    window.editOrderFromHistory = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        if (!orderDoc.exists()) {
          await showCustomAlert({ icon: '', title: '', message: '', btnClass: 'modal-btn-danger' });
          return;
        }
        
        const orderData = orderDoc.data();
        
        currentEditingOrder = {
          id: orderId,
          ...orderData,
          originalTotalAmount: orderData.totalAmount,
          originalPaymentMethod: orderData.paymentMethod
        };
        
        // 
        const paymentMethods = {
          'cash': '',
          'emoney': '',
          'credit': ''
        };
        
        let paymentMethodOptions = '';
        Object.keys(paymentMethods).forEach(method => {
          const selected = orderData.paymentMethod === method ? 'selected' : '';
          paymentMethodOptions += `<option value="${method}" ${selected}>${paymentMethods[method]}</option>`;
        });
        
        // 
        let itemsHtml = '';
        if (orderData.items && orderData.items.length > 0) {
          orderData.items.forEach((item, index) => {
            // 
            let toppingsHtml = '';
            if (item.toppingDetails && item.toppingDetails.length > 0) {
              const groupedBySet = {};
              item.toppingDetails.forEach(detail => {
                if (!groupedBySet[detail.setName]) {
                  groupedBySet[detail.setName] = [];
                }
                groupedBySet[detail.setName].push(detail.optionName);
              });
              
              toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
                return `
                  <div style="font-size: 12px; color: #666; font-weight: bold; margin-top: 5px;">${setName}</div>
                  ${options.map(opt => `<div style="font-size: 12px; color: #666; margin-left: 10px;">${opt}</div>`).join('')}
                `;
              }).join('');
            } else if (item.toppingsData && item.toppingsData.length > 0) {
              const groupedBySet = {};
              item.toppingsData.forEach(topping => {
                const setName = topping.setName || '';
                if (!groupedBySet[setName]) {
                  groupedBySet[setName] = [];
                }
                groupedBySet[setName].push(topping.name);
              });
              
              toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
                return `
                  <div style="font-size: 12px; color: #666; font-weight: bold; margin-top: 5px;">${setName}</div>
                  ${options.map(opt => `<div style="font-size: 12px; color: #666; margin-left: 10px;">${opt}</div>`).join('')}
                `;
              }).join('');
            } else if (item.toppings && item.toppings !== '' && item.toppings !== '') {
              toppingsHtml = `<div style="font-size: 12px; color: #666;">: ${item.toppings}</div>`;
            }
            
            itemsHtml += `
              <div style="padding: 10px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong>${item.name}</strong>
                    ${toppingsHtml}
                  </div>
                  <button onclick="removeItemFromOrder(${index})" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;"></button>
                </div>
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                  <label>:</label>
                  <input type="number" value="${item.quantity}" onchange="updateItemQuantity(${index}, this.value)" min="1" style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                  <span style="margin-left: auto; font-weight: bold;">¥${((item.price + (item.toppingPrice || 0)) * item.quantity).toLocaleString()}</span>
                </div>
              </div>
            `;
          });
        }
        
        const content = document.getElementById('editOrderContent');
        content.innerHTML = `
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;"></label>
            <div style="font-size: 24px; color: #667eea;">#${orderData.orderNumber || 0}</div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;"></label>
            <input type="text" id="editTableNumber" value="${orderData.tableNumber || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;"></label>
            <select id="editPaymentMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
              ${paymentMethodOptions}
            </select>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;"></label>
            ${itemsHtml || '<div style="text-align: center; padding: 20px; color: #999;"></div>'}
          </div>
          
          <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; text-align: right;">
            <span style="font-size: 18px; font-weight: bold;">: </span>
            <span id="editTotalAmount" style="font-size: 24px; font-weight: bold; color: #1976d2;">¥${(orderData.totalAmount || 0).toLocaleString()}</span>
          </div>
        `;
        
        // 
        const buttonsContainer = document.getElementById('editOrderButtons');
        if (orderData.paidAt) {
          // 
          buttonsContainer.innerHTML = `
            <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveOrderEdit()"></button>
            <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="redSlipFromEdit()"> </button>
            <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditOrderModal()"></button>
          `;
        } else {
          // 
          if (orderData.deleted) {
            // 
            buttonsContainer.innerHTML = `
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveOrderEdit()"></button>
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white;" onclick="restoreOrder()"></button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditOrderModal()"></button>
            `;
          } else {
            // 
            buttonsContainer.innerHTML = `
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveOrderEdit()"></button>
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="deleteOrderFromEdit()"> </button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditOrderModal()"></button>
            `;
          }
        }
        
        document.getElementById('editOrderModal').style.display = 'flex';
        
      } catch (e) {
        console.error(':', e);
        alert(': ' + e.message);
      }
    };
    
    // 
    window.closeEditOrderModal = function() {
      document.getElementById('editOrderModal').style.display = 'none';
      currentEditingOrder = null;
    };
    
    // 
    window.removeItemFromOrder = async function(index) {
      if (!currentEditingOrder) return;
      
      const item = currentEditingOrder.items[index];
      const itemName = item.name || '';
      const itemPrice = (item.price + (item.toppingPrice || 0)) * item.quantity;
      
      const confirmed = confirm(`${itemName}\n¥${itemPrice.toLocaleString()}\n\n`);
      
      if (confirmed) {
        try {
          // 
          currentEditingOrder.items.splice(index, 1);
          
          // 
          let total = 0;
          let tax8Total = 0;
          let tax10Total = 0;
          
          currentEditingOrder.items.forEach(item => {
            const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
            total += itemTotal;
            
            // 
            if (item.taxRate === 8) {
              tax8Total += itemTotal;
            } else {
              tax10Total += itemTotal;
            }
          });
          
          currentEditingOrder.totalAmount = total;
          currentEditingOrder.tax8Total = tax8Total;
          currentEditingOrder.tax10Total = tax10Total;
          
          // Firestore
          await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), {
            items: currentEditingOrder.items,
            totalAmount: total,
            tax8Total: tax8Total,
            tax10Total: tax10Total,
            updatedAt: window.Timestamp.now()
          });
          
          // 
          editOrderFromHistory(currentEditingOrder.id);
          
          await showCustomAlert({ icon: 'ℹ', title: '', message: '', btnClass: 'modal-btn-primary' });
          
        } catch (e) {
          console.error(':', e);
          alert(': ' + e.message);
        }
      }
    };
    
    // 
    window.updateItemQuantity = function(index, newQuantity) {
      if (!currentEditingOrder) return;
      
      const quantity = parseInt(newQuantity) || 1;
      currentEditingOrder.items[index].quantity = quantity;
      
      // 
      let total = 0;
      currentEditingOrder.items.forEach(item => {
        total += (item.price + (item.toppingPrice || 0)) * item.quantity;
      });
      currentEditingOrder.totalAmount = total;
      
      // 
      document.getElementById('editTotalAmount').textContent = `¥${total.toLocaleString()}`;
    };
    
    // 
    window.saveOrderEdit = async function() {
      if (!currentEditingOrder) return;
      
      try {
        const tableNumber = document.getElementById('editTableNumber').value;
        const paymentMethod = document.getElementById('editPaymentMethod').value;
        
        const oldPaymentMethod = currentEditingOrder.originalPaymentMethod || currentEditingOrder.paymentMethod;
        const oldTotalAmount = currentEditingOrder.originalTotalAmount || currentEditingOrder.totalAmount;
        const newTotalAmount = currentEditingOrder.totalAmount;
        
        // paidAttimestamp
        let originalDateStr = null;
        let isUnpaidOrder = false;
        
        try {
          let dateToUse = null;
          
          if (currentEditingOrder.paidAt) {
            dateToUse = currentEditingOrder.paidAt.toDate();
          } else if (currentEditingOrder.timestamp) {
            dateToUse = currentEditingOrder.timestamp.toDate();
            isUnpaidOrder = true;
          }
          
          if (dateToUse) {
            let targetDate = new Date(dateToUse);
            
            // 3
            if (dateToUse.getHours() < 3) {
              targetDate.setDate(targetDate.getDate() - 1);
            }
            
            originalDateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth()+1).padStart(2,'0')}-${String(targetDate.getDate()).padStart(2,'0')}`;
          } else {
            throw new Error('paidAttimestamp');
          }
        } catch (error) {
          console.error(':', error);
          await showCustomAlert({ icon: 'ℹ', title: '', message: '', btnClass: 'modal-btn-primary' });
          
          await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), {
            tableNumber: tableNumber,
            paymentMethod: paymentMethod,
            items: currentEditingOrder.items,
            totalAmount: currentEditingOrder.totalAmount
          });
          
          closeEditOrderModal();
          await loadHistory();
          return;
        }
        
        // 
        const orderUpdates = {
          tableNumber: tableNumber,
          paymentMethod: paymentMethod,
          items: currentEditingOrder.items,
          totalAmount: currentEditingOrder.totalAmount,
          tax8Total: currentEditingOrder.tax8Total || 0,
          tax10Total: currentEditingOrder.tax10Total || 0
        };
        
        // 
        if (isUnpaidOrder) {
          orderUpdates.paidAt = currentEditingOrder.timestamp;
          orderUpdates.notifiedPaid = true;
          
          await showCustomAlert({ icon: 'ℹ', title: '', message: `\n\n: ${originalDateStr}`, btnClass: 'modal-btn-primary' });
        }
        
        await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), orderUpdates);
        
        // dailySales
        if (currentEditingOrder.paidAt || isUnpaidOrder) {
          await updateDailySalesForEdit(originalDateStr, oldPaymentMethod, oldTotalAmount, paymentMethod, newTotalAmount, currentEditingOrder);
        }
        
        await showCustomAlert({ icon: 'ℹ', title: '', message: '', btnClass: 'modal-btn-primary' });
        
        closeEditOrderModal();
        await loadHistory();
        
      } catch (e) {
        console.error(':', e);
        alert(': ' + e.message);
      }
    };
    
    // dailySales
    async function updateDailySalesForEdit(dateStr, oldMethod, oldAmount, newMethod, newAmount, order) {
      try {
        const dailySalesRef = window.getStoreDoc('dailySales', dateStr);
        const dailySalesDoc = await window.getDoc(dailySalesRef);
        
        if (!dailySalesDoc.exists()) {
          console.warn('dailySales:', dateStr);
          return;
        }
        
        const dailyData = dailySalesDoc.data();
        
        // 
        const oldCash = (oldMethod === 'cash') ? oldAmount : 0;
        const oldEmone = (oldMethod === 'emoney') ? oldAmount : 0;
        const oldCredit = (oldMethod === 'credit') ? oldAmount : 0;
        
        // 
        const newCash = (newMethod === 'cash') ? newAmount : 0;
        const newEmone = (newMethod === 'emoney') ? newAmount : 0;
        const newCredit = (newMethod === 'credit') ? newAmount : 0;
        
        // 
        const oldTax8 = order.originalTax8Total || 0;
        const oldTax10 = order.originalTax10Total || 0;
        const newTax8 = order.tax8Total || 0;
        const newTax10 = order.tax10Total || 0;
        
        const updateData = {
          totalSales: (dailyData.totalSales || 0) - oldAmount + newAmount,
          cashSales: (dailyData.cashSales || 0) - oldCash + newCash,
          emoneSales: (dailyData.emoneSales || 0) - oldEmone + newEmone,
          creditSales: (dailyData.creditSales || 0) - oldCredit + newCredit,
          tax8Total: (dailyData.tax8Total || 0) - oldTax8 + newTax8,
          tax10Total: (dailyData.tax10Total || 0) - oldTax10 + newTax10
        };
        
        await window.updateDoc(dailySalesRef, updateData);
      } catch (e) {
        console.error('dailySales:', e);
      }
    }
    
    // 
    window.redSlipFromEdit = async function() {
      if (!currentEditingOrder) return;
      closeEditOrderModal();
      await redSlipFromHistory(currentEditingOrder.id);
    };
    
    // 
    window.deleteOrderFromEdit = async function() {
      if (!currentEditingOrder) return;
      const confirmed = confirm(` #${currentEditingOrder.orderNumber} `);
      if (confirmed) {
        closeEditOrderModal();
        await deleteOrderFromHistory(currentEditingOrder.id);
      }
    };
    
    // 
    window.restoreOrder = async function() {
      if (!currentEditingOrder) return;
      const confirmed = confirm(` #${currentEditingOrder.orderNumber} `);
      if (confirmed) {
        closeEditOrderModal();
        await restoreOrderFromHistory(currentEditingOrder.id);
      }
    };
    
    // 
    window.deleteOrderFromHistory = async function(orderId) {
      try {
        const confirmed = confirm('');
        if (!confirmed) return;
        
        await window.updateDoc(window.getStoreDoc('orders', orderId), {
          deleted: true,
          deletedAt: window.Timestamp.now()
        });
        
        await showCustomAlert({ icon: 'ℹ', title: '', message: '', btnClass: 'modal-btn-primary' });
        await loadHistory();
      } catch (e) {
        console.error(':', e);
        alert(': ' + e.message);
      }
    };
    
    // 
    window.restoreOrderFromHistory = async function(orderId) {
      try {
        const confirmed = confirm('');
        if (!confirmed) return;
        
        await window.updateDoc(window.getStoreDoc('orders', orderId), {
          deleted: false,
          deletedAt: null
        });
        
        await showCustomAlert({ icon: 'ℹ', title: '', message: '', btnClass: 'modal-btn-primary' });
        await loadHistory();
      } catch (e) {
        console.error(':', e);
        alert(': ' + e.message);
      }
    };
    
    
    // ==========   ==========
    
    window.showExpenseModal = async function() {
      // 
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('expenseModal').style.display = 'flex';
      
      // 
      const now = new Date();
      let today = new Date(now);
      if (now.getHours() < 3) {
        today.setDate(today.getDate() - 1);
      }
      const dateStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      document.getElementById('expenseDateInput').value = dateStr;
      
      await loadExpensesByDate();
    };
    
    window.closeExpenseModal = function() {
      document.getElementById('expenseModal').style.display = 'none';
    };
    
    window.loadExpensesByDate = async function() {
      const dateStr = document.getElementById('expenseDateInput').value;
      if (!dateStr) return;
      
      try {
        const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
        const tbody = document.getElementById('expenseTableBody');
        tbody.innerHTML = '';
        
        if (expenseDoc.exists()) {
          const data = expenseDoc.data();
          const items = data.items || [];
          
          items.forEach(item => {
            addExpenseRowWithData(item);
          });
        } else {
          addExpenseRow();
        }
        
        calculateExpenseTotal();
      } catch (e) {
        console.error(':', e);
        addExpenseRow();
      }
    };
    
    window.addExpenseRow = function() {
      addExpenseRowWithData({});
    };
    
    function addExpenseRowWithData(data) {
      const tbody = document.getElementById('expenseTableBody');
      const row = tbody.insertRow();
      row.innerHTML = `
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="text" value="${data.storeName || ''}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <select style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="" ${data.category === '' ? 'selected' : ''}></option>
            <option value="" ${data.category === '' ? 'selected' : ''}></option>
            <option value="" ${data.category === '' ? 'selected' : ''}></option>
            <option value="" ${data.category === '' ? 'selected' : ''}></option>
          </select>
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="text" value="${data.detail || ''}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="number" value="${data.amount || ''}" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;" placeholder="" onchange="calculateExpenseTotal()">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
          <button onclick="this.closest('tr').remove(); calculateExpenseTotal();" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;"></button>
        </td>
      `;
    }
    
    function calculateExpenseTotal() {
      const tbody = document.getElementById('expenseTableBody');
      const rows = tbody.querySelectorAll('tr');
      let total = 0;
      
      rows.forEach(row => {
        const amountInput = row.querySelector('input[type="number"]');
        const amount = parseInt(amountInput.value) || 0;
        total += amount;
      });
      
      document.getElementById('expenseTotal').textContent = total.toLocaleString();
    }
    
    window.saveExpenses = async function() {
      const dateStr = document.getElementById('expenseDateInput').value;
      if (!dateStr) {
        await showCustomAlert({ icon: '', title: '', message: '', btnClass: 'modal-btn-danger' });
        return;
      }
      
      const tbody = document.getElementById('expenseTableBody');
      const rows = tbody.querySelectorAll('tr');
      const items = [];
      let total = 0;
      
      rows.forEach(row => {
        const inputs = row.querySelectorAll('input, select');
        const storeName = inputs[0].value;
        const category = inputs[1].value;
        const detail = inputs[2].value;
        const amount = parseInt(inputs[3].value) || 0;
        
        if (storeName || category || detail || amount) {
          items.push({ storeName, category, detail, amount });
          total += amount;
        }
      });
      
      try {
        await window.setDoc(window.getStoreDoc('expenses', dateStr), {
          date: dateStr,
          items: items,
          total: total,
          updatedAt: window.Timestamp.now()
        });
        
        await showCustomAlert({ 
          icon: '', 
          title: '', 
          message: '', 
          btnClass: 'modal-btn-success' 
        });
      } catch (e) {
        console.error(':', e);
        await showCustomAlert({ 
          icon: '', 
          title: '', 
          message: '', 
          btnClass: 'modal-btn-danger' 
        });
      }
    };
    
    // ==========   ==========
    
    window.showMonthlyReportModal = function() {
      // 
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('monthlyReportModal').style.display = 'flex';
      
      // 
      const now = new Date();
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      
      document.getElementById('reportStartDate').value = `${firstDay.getFullYear()}-${String(firstDay.getMonth()+1).padStart(2,'0')}-${String(firstDay.getDate()).padStart(2,'0')}`;
      document.getElementById('reportEndDate').value = `${lastDay.getFullYear()}-${String(lastDay.getMonth()+1).padStart(2,'0')}-${String(lastDay.getDate()).padStart(2,'0')}`;
    };
    
    window.closeMonthlyReportModal = function() {
      document.getElementById('monthlyReportModal').style.display = 'none';
    };
    
    window.generateMonthlyReport = async function() {
      const startDate = document.getElementById('reportStartDate').value;
      const endDate = document.getElementById('reportEndDate').value;
      
      if (!startDate || !endDate) {
        await showCustomAlert({ icon: '', title: '', message: '', btnClass: 'modal-btn-danger' }); return;
        return;
      }
      
      const container = document.getElementById('monthlyReportContent');
      container.innerHTML = '<div style="text-align: center; padding: 40px;">...</div>';
      
      try {
        const salesSnapshot = await window.getDocs(window.getStoreCollection('dailySales'));
        const salesByDate = {};
        
        salesSnapshot.forEach(doc => {
          const data = doc.data();
          const date = data.date;
          if (date && date >= startDate && date <= endDate) {
            salesByDate[date] = data;
          }
        });
        
        let totalSales = 0;
        let totalCustomers = 0;
        let html = `
          <div style="background: white; padding: 20px; border-radius: 12px;">
            <h4 style="margin: 0 0 20px 0;">: ${startDate}  ${endDate}</h4>
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                  <th style="padding: 12px; border: 1px solid #ddd;"></th>
                  <th style="padding: 12px; border: 1px solid #ddd;"></th>
                  <th style="padding: 12px; border: 1px solid #ddd;"></th>
                </tr>
              </thead>
              <tbody>
        `;
        
        const dates = Object.keys(salesByDate).sort();
        dates.forEach(date => {
          const data = salesByDate[date];
          const sales = data.totalSales || 0;
          const customers = data.customerCount || 0;
          
          totalSales += sales;
          totalCustomers += customers;
          
          html += `
            <tr>
              <td style="padding: 10px; border: 1px solid #ddd;">${date}</td>
              <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">¥${sales.toLocaleString()}</td>
              <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${customers}</td>
            </tr>
          `;
        });
        
        html += `
              </tbody>
              <tfoot>
                <tr style="background: #f5f5f5; font-weight: bold;">
                  <td style="padding: 12px; border: 1px solid #ddd;"></td>
                  <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">¥${totalSales.toLocaleString()}</td>
                  <td style="padding: 12px; border: 1px solid #ddd; text-align: right;">${totalCustomers}</td>
                </tr>
              </tfoot>
            </table>
          </div>
        `;
        
        container.innerHTML = html;
      } catch (e) {
        console.error(':', e);
        container.innerHTML = '<div style="text-align: center; color: red; padding: 40px;"></div>';
      }
    };
    
    // PNG
    window.exportMonthlyReportAsPNG = async function() {
      const content = document.getElementById('monthlyReportContent');
      
      if (!content.children.length || content.innerHTML.includes('') || content.innerHTML.includes('')) {
        await showCustomAlert({ icon: '', title: '', message: '', btnClass: 'modal-btn-danger' });
        return;
      }
      
      try {
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;
        
        // html2canvas
        const canvas = await html2canvas(content, {
          scale: 2,
          backgroundColor: '#ffffff',
          logging: false,
          width: content.scrollWidth,
          height: content.scrollHeight
        });
        
        // PNG
        canvas.toBlob(async (blob) => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `_${startDate}_${endDate}.png`;
          link.click();
          URL.revokeObjectURL(url);
          
          await showCustomAlert({ icon: '', title: '', message: 'PNG', btnClass: 'modal-btn-success' });
        });
        
      } catch (e) {
        console.error('PNG:', e);
        await showCustomAlert({ icon: '', title: '', message: 'PNG: ' + e.message, btnClass: 'modal-btn-danger' });
      }
    };
    
    // ==========   ==========
    
    // 
    let PRINTER_IP = localStorage.getItem('printerIP') || '192.168.1.100';
    let PRINTER_CONNECTION_TYPE = localStorage.getItem('printerConnectionType') || 'ethernet';
    let BLUETOOTH_DEVICE = null;
    let BLUETOOTH_CHARACTERISTIC = null;
    
    window.selectConnectionType = function(type) {
      PRINTER_CONNECTION_TYPE = type;
      
      const ethernetBtn = document.getElementById('connectionTypeEthernet');
      const bluetoothBtn = document.getElementById('connectionTypeBluetooth');
      const ethernetSettings = document.getElementById('ethernetSettings');
      const bluetoothSettings = document.getElementById('bluetoothSettings');
      
      if (type === 'ethernet') {
        ethernetBtn.style.background = '#667eea';
        ethernetBtn.style.color = 'white';
        bluetoothBtn.style.background = 'white';
        bluetoothBtn.style.color = '#666';
        ethernetSettings.style.display = 'block';
        bluetoothSettings.style.display = 'none';
      } else {
        ethernetBtn.style.background = 'white';
        ethernetBtn.style.color = '#666';
        bluetoothBtn.style.background = '#667eea';
        bluetoothBtn.style.color = 'white';
        ethernetSettings.style.display = 'none';
        bluetoothSettings.style.display = 'block';
      }
    };
    
    window.showBluetoothSearchGuide = function() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;';
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <div style="text-align: center; margin-bottom: 25px;">
            <div style="width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 50%; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold;">
              BT
            </div>
            <h3 style="font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #333;">Bluetooth</h3>
          </div>
          
          <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
            <p style="font-size: 15px; color: #555; margin-bottom: 12px; line-height: 1.6;">
              
            </p>
            <p style="font-size: 14px; color: #666; line-height: 1.6;">
              <strong style="color: #333;"></strong><br>
              • <br>
              • BluetoothON<br>
              • 
            </p>
          </div>
          
          <div style="display: flex; gap: 12px;">
            <button onclick="this.closest('.modal-overlay').remove()" style="flex: 1; padding: 15px; font-size: 16px; font-weight: bold; border: 2px solid #ddd; background: white; color: #666; border-radius: 10px; cursor: pointer;">
              
            </button>
            <button onclick="this.closest('.modal-overlay').remove(); window.startBluetoothSearch();" style="flex: 1; padding: 15px; font-size: 16px; font-weight: bold; border: none; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 15px rgba(33,150,243,0.3);">
              
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    };
    
    window.startBluetoothSearch = async function() {
      try {
        console.log('Bluetooth...');
        
        const device = await navigator.bluetooth.requestDevice({
          filters: [
            { services: ['000018f0-0000-1000-8000-00805f9b34fb'] },
          ],
          optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });
        
        console.log(':', device.name);
        
        const server = await device.gatt.connect();
        console.log('GATT');
        
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        console.log('');
        
        const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
        console.log('Characteristic');
        
        BLUETOOTH_DEVICE = device;
        BLUETOOTH_CHARACTERISTIC = characteristic;
        
        document.getElementById('bluetoothDeviceInfo').style.display = 'block';
        document.getElementById('bluetoothDeviceName').textContent = device.name || '';
        
        localStorage.setItem('bluetoothDeviceName', device.name || '');
        
        await showCustomAlert({ 
          icon: '', 
          title: '', 
          message: 'Bluetooth\n' + (device.name || ''), 
          btnClass: 'modal-btn-success' 
        });
        
      } catch (error) {
        console.error('Bluetooth:', error);
        
        if (error.name === 'NotFoundError') {
          await showCustomAlert({ 
            icon: '', 
            title: '', 
            message: 'Bluetooth\n\n', 
            btnClass: 'modal-btn-danger' 
          });
        } else if (error.name === 'SecurityError' || error.name === 'NotAllowedError') {
          console.log('');
        } else {
          await showCustomAlert({ 
            icon: '', 
            title: '', 
            message: 'Bluetooth\n\nBluetoothChromeEdge', 
            btnClass: 'modal-btn-danger' 
          });
        }
      }
    };
    
    window.searchBluetoothPrinter = function() {
      showBluetoothSearchGuide();
    };
    
    function createESCPOSCommand(text) {
      const encoder = new TextEncoder();
      const commands = [];
      
      commands.push(new Uint8Array([0x1B, 0x40]));
      commands.push(encoder.encode(text));
      commands.push(new Uint8Array([0x0A, 0x0A, 0x0A]));
      commands.push(new Uint8Array([0x1D, 0x56, 0x00]));
      
      const totalLength = commands.reduce((sum, cmd) => sum + cmd.length, 0);
      const result = new Uint8Array(totalLength);
      let offset = 0;
      for (const cmd of commands) {
        result.set(cmd, offset);
        offset += cmd.length;
      }
      
      return result;
    }
    
    async function printViaBluetooth(text) {
      if (!BLUETOOTH_CHARACTERISTIC) {
        throw new Error('Bluetooth');
      }
      
      try {
        const command = createESCPOSCommand(text);
        
        const chunkSize = 512;
        for (let i = 0; i < command.length; i += chunkSize) {
          const chunk = command.slice(i, Math.min(i + chunkSize, command.length));
          await BLUETOOTH_CHARACTERISTIC.writeValue(chunk);
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        console.log('Bluetooth');
      } catch (error) {
        console.error('Bluetooth:', error);
        throw error;
      }
    }
    
    window.showPrinterSettings = function() {
      // 
      const menu = document.getElementById('functionsSubMenu');
      if (menu) {
        menu.style.display = 'none';
      }
      
      document.getElementById('printerIPInput').value = PRINTER_IP;
      selectConnectionType(PRINTER_CONNECTION_TYPE);
      
      const savedDeviceName = localStorage.getItem('bluetoothDeviceName');
      if (savedDeviceName && PRINTER_CONNECTION_TYPE === 'bluetooth') {
        document.getElementById('bluetoothDeviceInfo').style.display = 'block';
        document.getElementById('bluetoothDeviceName').textContent = savedDeviceName + ' ()';
      }
      
      document.getElementById('printerSettingsModal').style.display = 'flex';
      document.getElementById('printerTestResult').style.display = 'none';
    };
    
    window.closePrinterSettingsModal = function() {
      document.getElementById('printerSettingsModal').style.display = 'none';
    };
    
    window.savePrinterSettings = async function() {
      if (PRINTER_CONNECTION_TYPE === 'ethernet') {
        const newIP = document.getElementById('printerIPInput').value.trim();
        
        const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
        if (!ipPattern.test(newIP)) {
          await showCustomAlert({ 
            icon: '', 
            title: '', 
            message: 'IP\n: 192.168.1.100', 
            btnClass: 'modal-btn-danger' 
          });
          return;
        }
        
        PRINTER_IP = newIP;
        localStorage.setItem('printerIP', newIP);
        localStorage.setItem('printerConnectionType', 'ethernet');
        
        await showCustomAlert({ 
          icon: '', 
          title: '', 
          message: '\n: WiFi/LAN\nIP: ' + newIP, 
          btnClass: 'modal-btn-success' 
        });
      } else {
        if (!BLUETOOTH_DEVICE) {
          await showCustomAlert({ 
            icon: '', 
            title: '', 
            message: 'Bluetooth', 
            btnClass: 'modal-btn-danger' 
          });
          return;
        }
        
        localStorage.setItem('printerConnectionType', 'bluetooth');
        await showCustomAlert({ 
          icon: '', 
          title: '', 
          message: '\n: Bluetooth\n: ' + (BLUETOOTH_DEVICE.name || ''), 
          btnClass: 'modal-btn-success' 
        });
      }
      
      closePrinterSettingsModal();
    };
    
    window.testPrinterConnection = async function() {
      const resultDiv = document.getElementById('printerTestResult');
      
      resultDiv.style.display = 'block';
      resultDiv.style.background = '#FFF9C4';
      resultDiv.style.color = '#F57F17';
      resultDiv.textContent = '...';
      
      try {
        if (PRINTER_CONNECTION_TYPE === 'bluetooth') {
          if (!BLUETOOTH_CHARACTERISTIC) {
            resultDiv.style.background = '#FFCDD2';
            resultDiv.style.color = '#C62828';
            resultDiv.innerHTML = 'Bluetooth<br>';
            return;
          }
          
          await printViaBluetooth('===  ===\n\n\n');
          
          resultDiv.style.background = '#C8E6C9';
          resultDiv.style.color = '#2E7D32';
          resultDiv.innerHTML = '<br>Bluetooth';
          
        } else {
          resultDiv.style.background = '#FFCDD2';
          resultDiv.style.color = '#C62828';
          resultDiv.innerHTML = '<br>WiFi/LAN';
        }
        
      } catch (error) {
        console.error(':', error);
        resultDiv.style.background = '#FFCDD2';
        resultDiv.style.color = '#C62828';
        resultDiv.innerHTML = '<br>' + error.message;
      }
    };
  
  </script>
  
  <!--  -->
  <div id="salesModal" class="sales-modal">
    <div class="sales-modal-content">
      <div class="sales-modal-header">
        <h2 class="sales-modal-title" id="salesModalTitle"></h2>
        <button class="sales-modal-close" onclick="closeSalesModal()">×</button>
      </div>
      <div id="salesContent">
        <div style="text-align: center; padding: 20px;">...</div>
      </div>
    </div>
  </div>
  
  <!--  -->
  <div id="inventoryPanel" style="position: fixed; bottom: 20px; right: 20px; width: 300px; max-height: 400px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 9999; overflow: hidden; transition: all 0.3s ease;">
    <div id="inventoryPanelBar" onclick="toggleInventoryPanel()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.3s ease;">
      <div style="font-weight: bold; color: white; font-size: 15px;"> </div>
      <div id="inventoryPanelArrow" style="color: white; font-size: 18px;"></div>
    </div>
    <div id="inventoryPanelContent" style="max-height: 350px; overflow-y: auto; padding: 10px;">
      <div style="padding: 10px; text-align: center; color: #999;">...</div>
    </div>
  </div>
  
  <!--   -->
  <div id="salesModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-header">
        <h3 id="salesModalTitle"></h3>
        <button class="modal-close" onclick="closeSalesModal()">×</button>
      </div>
      <div id="salesContent" style="padding: 20px;">
        <div style="text-align: center; padding: 20px;">...</div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn" style="background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%); color: white;" onclick="showSettlementModal()"></button>
        <button class="btn btn-secondary" onclick="closeSalesModal()"></button>
      </div>
    </div>
  </div>
  
  <!--  -->
  <div id="settlementModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 style="color: #ff6b6b;"></h3>
        <button class="modal-close" onclick="closeSettlementModal()">×</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
          <p style="margin: 0 0 10px 0; font-weight: bold; color: #856404;">:</p>
          <ul style="margin: 0; padding-left: 20px; color: #856404;">
            <li></li>
            <li>PNG</li>
            <li>3</li>
          </ul>
        </div>
        <div style="margin: 20px 0;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;"></label>
          <input type="date" id="settlementDate" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
          <p style="font-size: 12px; color: #666; margin-top: 5px;">※ </p>
        </div>
        <div id="settlementSummary" style="margin: 20px 0;"></div>
      </div>
      <div class="modal-footer" style="display: flex; flex-direction: column; gap: 10px;">
        <button class="btn" style="width: 100%; background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%); color: white;" onclick="confirmSettlement()"></button>
        <button class="btn" style="width: 100%; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="generateDailyReport()"></button>
        <button class="btn btn-secondary" style="width: 100%;" onclick="closeSettlementModal()"></button>
      </div>
    </div>
  </div>
  
  <!--  -->
  <div id="historyModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3></h3>
        <button class="modal-close" onclick="closeHistoryModal()">×</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap;">
          <select id="historyDateFilter" onchange="filterHistory()" style="padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
            <option value="today"></option>
            <option value="yesterday"></option>
            <option value="week"></option>
            <option value="month"></option>
            <option value="all"></option>
          </select>
          <select id="historyStatusFilter" onchange="filterHistory()" style="padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
            <option value="all"></option>
            <option value="deleted"></option>
            <option value="paid"></option>
            <option value="completed"></option>
          </select>
          <button onclick="refreshHistory()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;"></button>
        </div>
        <div id="historyList" style="max-height: 60vh; overflow-y: auto;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeHistoryModal()"></button>
      </div>
    </div>
  </div>
  
  <!--  -->
  <div id="editOrderModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3> </h3>
        <button class="modal-close" onclick="closeEditOrderModal()">×</button>
      </div>
      <div style="padding: 20px;">
        <div id="editOrderContent" style="margin: 20px 0;">
          <!-- JavaScript -->
        </div>
      </div>
      <div class="modal-footer">
        <div id="editOrderButtons" style="display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap;">
          <!-- JavaScript -->
        </div>
      </div>
    </div>
  </div>
  
  <!--  -->
  <div id="expenseModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3 style="color: #f093fb;"></h3>
        <button class="modal-close" onclick="closeExpenseModal()">×</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; gap: 15px;">
          <label style="font-weight: bold; font-size: 16px;">:</label>
          <input type="date" id="expenseDateInput" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 16px; flex: 1;" onchange="loadExpensesByDate()" />
        </div>
        <div style="margin: 20px 0;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #f5f5f5;">
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;"></th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;"></th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;"></th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;"></th>
                <th style="padding: 10px; border: 1px solid #ddd; width: 60px;"></th>
              </tr>
            </thead>
            <tbody id="expenseTableBody"></tbody>
          </table>
          <button class="btn" style="margin-top: 10px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="addExpenseRow()"> </button>
          <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; text-align: right;">
            <span style="font-size: 18px; font-weight: bold;">: ¥</span>
            <span id="expenseTotal" style="font-size: 24px; font-weight: bold; color: #f093fb;">0</span>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
        <button class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="saveExpenses()"></button>
        <button class="btn btn-secondary" onclick="closeExpenseModal()"></button>
      </div>
    </div>
  </div>
  
  <!--  -->
  <div id="settlementModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 style="color: #ff6b6b;"></h3>
        <button class="modal-close" onclick="closeSettlementModal()">×</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
          <p style="margin: 0 0 10px 0; font-weight: bold; color: #856404;">:</p>
          <ul style="margin: 0; padding-left: 20px; color: #856404;">
            <li></li>
            <li>PNG</li>
            <li>3</li>
          </ul>
        </div>
        
        <div style="margin: 20px 0;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;"></label>
          <input type="date" id="settlementDate" onchange="loadSettlementSummary()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
          <p style="font-size: 12px; color: #666; margin-top: 5px;">※ </p>
        </div>
        
        <div id="settlementSummary" style="margin: 20px 0;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn" style="background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%); color: white;" onclick="confirmSettlement()"></button>
        <button class="btn btn-secondary" onclick="closeSettlementModal()"></button>
      </div>
    </div>
  </div>
  
  <!--  -->
  <div id="monthlyReportModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3></h3>
        <button class="modal-close" onclick="closePeriodJournalModal()">×</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;"></label>
            <input type="date" id="reportStartDate" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
          </div>
          <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;"></label>
            <input type="date" id="reportEndDate" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
          </div>
          <button onclick="generatePeriodJournal()" style="padding: 12px 24px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px;"></button>
        </div>
        <div id="monthlyReportContent"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closePeriodJournalModal()"></button>
      </div>
    </div>
  </div>
  
  <!--  -->
  <div id="printerSettingsModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <h3 style="font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 15px; color: #333;"></h3>
      <p style="text-align: center; font-size: 16px; color: #666; margin-bottom: 30px;">TSP650II / mC-Print3 / Bluetooth</p>
      
      <!--  -->
      <div style="margin-bottom: 25px;">
        <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;"></label>
        <div style="display: flex; gap: 10px;">
          <button id="connectionTypeEthernet" onclick="selectConnectionType('ethernet')" 
                  style="flex: 1; padding: 15px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
            WiFi / LAN
          </button>
          <button id="connectionTypeBluetooth" onclick="selectConnectionType('bluetooth')" 
                  style="flex: 1; padding: 15px; border: 2px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
            Bluetooth
          </button>
        </div>
      </div>
      
      <!-- Ethernet -->
      <div id="ethernetSettings" style="display: block;">
        <div style="margin-bottom: 25px;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">IP</label>
          <input type="text" id="printerIPInput" placeholder=": 192.168.1.100" 
                 style="width: 100%; padding: 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
          <div style="margin-top: 8px; font-size: 14px; color: #666;">
            IP<br>
            <small style="color: #999;">※</small>
          </div>
        </div>
      </div>
      
      <!-- Bluetooth -->
      <div id="bluetoothSettings" style="display: none;">
        <div style="margin-bottom: 25px;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">Bluetooth</label>
          <button onclick="searchBluetoothPrinter()" 
                  style="width: 100%; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; box-shadow: 0 4px 15px rgba(33,150,243,0.3);">
            
          </button>
          <div id="bluetoothDeviceInfo" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 8px; display: none;">
            <div style="font-weight: bold; color: #333;">:</div>
            <div id="bluetoothDeviceName" style="color: #666; margin-top: 5px;"></div>
          </div>
          <div style="margin-top: 8px; font-size: 14px; color: #666;">
            ESC/POSBluetooth<br>
            <small style="color: #999;">※ChromeEdge</small>
          </div>
        </div>
      </div>
      
      <div style="margin-bottom: 25px;">
        <button onclick="testPrinterConnection()" id="testConnectionBtn"
                style="width: 100%; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; box-shadow: 0 4px 15px rgba(76,175,80,0.3);">
          
        </button>
        <div id="printerTestResult" style="margin-top: 10px; padding: 10px; border-radius: 8px; display: none;"></div>
      </div>
      
      <div style="display: flex; gap: 15px; margin-top: 30px;">
        <button onclick="closePrinterSettingsModal()" 
                style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: #e0e0e0; color: #666;">
          
        </button>
        <button onclick="savePrinterSettings()" 
                style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          
        </button>
      </div>
    </div>
  </div>
  
  <!--  POS -->
  <div id="posIframeModal" class="pos-iframe-modal">
    <div class="pos-iframe-container">
      <div class="pos-iframe-header">
        <h3 id="posModalTitle">POS</h3>
        <button class="pos-iframe-close" onclick="closePOSModal()">×</button>
      </div>
      <iframe id="posIframe" class="pos-iframe-content" src="about:blank"></iframe>
    </div>
  </div>
  
</body>
</html>