<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ  - ä¿®æ­£ç‰ˆ</title>
  <style>
    /* ... (ä¸­ç•¥: å…ƒã®ã‚¹ã‚¿ã‚¤ãƒ«ã®ã¾ã¾) ... */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 600px; margin: 0 auto; }
    .login-screen, .header, .table-card, .modal { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 20px;}
    .hidden { display: none !important; }
    .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
    .table-card { text-align: center; cursor: pointer; position: relative; }
    .table-card.has-pending-orders { background: #fff4e6; border: 2px solid #ff9800; }
    .checkout-btn { width: 100%; padding: 10px; margin-top: 8px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; background: #4CAF50;}
    .modal-overlay { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); z-index: 1000; align-items: center; justify-content: center; }
    .modal { width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; background: white; border-radius: 20px; padding: 20px; }
    .btn { padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: 0.2s; }
    .btn:active { transform: scale(0.95); }
  </style>
</head>
<body>
  <div class="container">
    <div id="loginScreen" class="login-screen">
      <h1 style="text-align:center; color:#667eea; margin-bottom:20px;">ğŸ½ï¸ ãƒãƒ³ãƒ‡ã‚£</h1>
      <select id="storeSelect" style="width:100%; padding:12px; margin-bottom:15px;"></select>
      <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰" style="width:100%; padding:12px; margin-bottom:15px;">
      <button class="btn" style="width:100%; background:#667eea; color:white;" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <div id="tablesScreen" class="hidden">
      <div class="header">
        <h2 id="storeNameDisplay">åº—èˆ—å</h2>
        <button class="btn" onclick="handleLogout()" style="background:#f44336; color:white; margin-top:10px;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      <div id="tablesGrid" class="tables-grid"></div>
    </div>
  </div>

  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3 style="text-align:center; margin-bottom:15px;">ğŸ’° ä¼šè¨ˆãƒ»æ³¨æ–‡ç®¡ç†</h3>
      <p id="selectedTableLabel2" style="text-align:center; font-weight:bold;"></p>
      
      <div id="taxRateSection" style="margin: 15px 0; padding: 15px; background: #e8f5e9; border-radius: 10px;">
        <div id="taxRateItemsList"></div>
      </div>

      <div style="margin: 15px 0; padding: 15px; background: #fff3cd; border-radius: 10px;">
        <div style="display:flex; justify-content: space-between; font-weight:bold;">
          <span>è«‹æ±‚åˆè¨ˆ:</span>
          <span id="finalPaymentAmount" style="color:#d32f2f; font-size:20px;">Â¥0</span>
        </div>
      </div>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
        <button class="btn" style="background:#4CAF50; color:white;" onclick="completePayment('cash')">ç¾é‡‘ä¼šè¨ˆ</button>
        <button class="btn" style="background:#2196F3; color:white;" onclick="completePayment('credit')">ãã®ä»–ä¼šè¨ˆ</button>
        <button class="btn" style="background:#FF9800; color:white;" onclick="cancelOrdersForTable()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn" style="background:#f44336; color:white;" onclick="deleteOrdersForTable()">æ³¨æ–‡å‰Šé™¤</button>
      </div>
      <button class="btn" style="width:100%; margin-top:10px; background:#ddd;" onclick="closePaymentModal()">æˆ»ã‚‹</button>
    </div>
  </div>

  <div id="customConfirmModal" class="modal-overlay hidden">
    <div class="modal" style="text-align:center;">
      <div id="modalIcon" style="font-size:40px;">âš ï¸</div>
      <h3 id="modalTitle">ç¢ºèª</h3>
      <p id="modalMessage" style="margin:15px 0; color:#666;"></p>
      <div style="display:flex; gap:10px;">
        <button class="btn" style="flex:1; background:#ddd;" onclick="closeCustomModal()">ã„ã„ãˆ</button>
        <button id="modalConfirmBtn" class="btn" style="flex:1; background:#f44336; color:white;">ã¯ã„</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc, addDoc, serverTimestamp, onSnapshot, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // Firebaseè¨­å®š (å…ƒãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¼•ç”¨)
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let currentStoreId = null;
    let currentTableName = null;
    let currentOrders = [];
    let customModalResolve = null;

    // --- ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« ---
    window.showCustomConfirm = (options) => {
      return new Promise((resolve) => {
        customModalResolve = resolve;
        const modal = document.getElementById('customConfirmModal');
        document.getElementById('modalIcon').textContent = options.icon || 'âš ï¸';
        document.getElementById('modalTitle').textContent = options.title || 'ç¢ºèª';
        document.getElementById('modalMessage').textContent = options.message || '';
        const confirmBtn = document.getElementById('modalConfirmBtn');
        confirmBtn.textContent = options.btnText || 'ã¯ã„';
        confirmBtn.style.background = options.btnClass === 'success' ? '#4CAF50' : '#f44336';
        confirmBtn.onclick = () => { modal.classList.add('hidden'); resolve(true); };
        modal.classList.remove('hidden');
      });
    };
    window.closeCustomModal = () => { document.getElementById('customConfirmModal').classList.add('hidden'); if(customModalResolve) customModalResolve(false); };

    // --- ä¼šè¨ˆå®Œäº† (å£²ä¸Šåæ˜ ) ---
    window.completePayment = async (method) => {
      const confirmed = await showCustomConfirm({
        icon: 'ğŸ’°', title: 'ä¼šè¨ˆç¢ºå®š', message: 'ã“ã®å†…å®¹ã§å£²ä¸Šã«åæ˜ ã—ã¾ã™ã‹ï¼Ÿ', btnText: 'ä¼šè¨ˆå®Œäº†', btnClass: 'success'
      });
      if (!confirmed) return;

      try {
        const now = serverTimestamp();
        let totalAmount = 0;
        
        // 1. å„æ³¨æ–‡ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        for (const order of currentOrders) {
          const orderRef = doc(db, 'stores', currentStoreId, 'orders', order.id);
          await updateDoc(orderRef, { paidAt: now, paymentMethod: method });
          totalAmount += (order.totalAmount || 0);
        }

        // 2. POSã®å£²ä¸Šã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³(sales)ã¸æ›¸ãè¾¼ã¿
        await addDoc(collection(db, 'stores', currentStoreId, 'sales'), {
          amount: totalAmount,
          method: method,
          createdAt: now,
          tableName: currentTableName,
          type: 'order'
        });

        await showCustomConfirm({ icon: 'âœ…', title: 'å®Œäº†', message: 'å£²ä¸Šã«åæ˜ ã—ã¾ã—ãŸ', btnText: 'OK', btnClass: 'success' });
        location.reload(); 
      } catch (e) { alert('ä¼šè¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    };

    // --- å‰Šé™¤ (è‡ªå‹•æˆ»ã‚Š) ---
    window.deleteOrdersForTable = async () => {
      const confirmed = await showCustomConfirm({ icon: 'ğŸ—‘ï¸', title: 'å‰Šé™¤ç¢ºèª', message: 'æ³¨æ–‡ã‚’å®Œå…¨ã«æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ' });
      if (!confirmed) return;

      try {
        for (const order of currentOrders) {
          await updateDoc(doc(db, 'stores', currentStoreId, 'orders', order.id), { deleted: true });
        }
        await showCustomConfirm({ icon: 'ğŸ—‘ï¸', title: 'å®Œäº†', message: 'å‰Šé™¤ã—ã¾ã—ãŸ', btnText: 'OK' });
        location.reload();
      } catch (e) { alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    };

    // --- ã‚­ãƒ£ãƒ³ã‚»ãƒ« (è‡ªå‹•æˆ»ã‚Š) ---
    window.cancelOrdersForTable = async () => {
      const confirmed = await showCustomConfirm({ icon: 'â¸ï¸', title: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç¢ºèª', message: 'æ³¨æ–‡ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ' });
      if (!confirmed) return;

      try {
        const now = serverTimestamp();
        for (const order of currentOrders) {
          await updateDoc(doc(db, 'stores', currentStoreId, 'orders', order.id), { cancelledAt: now });
        }
        await showCustomConfirm({ icon: 'â¸ï¸', title: 'å®Œäº†', message: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ', btnText: 'OK' });
        location.reload();
      } catch (e) { alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    };

    // --- ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ---
    window.openCheckoutForTable = async (tableName) => {
      currentTableName = tableName;
      const q = query(collection(db, 'stores', currentStoreId, 'orders'), 
                where('tableNumber', '==', String(tableName)),
                where('paidAt', '==', null),
                where('deleted', '==', false),
                where('cancelledAt', '==', null));
      
      const snap = await getDocs(q);
      currentOrders = snap.docs.map(d => ({id: d.id, ...d.data()}));
      
      if (currentOrders.length === 0) {
        alert('æœªä¼šè¨ˆã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      document.getElementById('selectedTableLabel2').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ«: ${tableName}`;
      const total = currentOrders.reduce((s, o) => s + (o.totalAmount || 0), 0);
      document.getElementById('finalPaymentAmount').textContent = `Â¥${total.toLocaleString()}`;
      
      // ç¨ç‡è¡¨ç¤ºã‚¨ãƒªã‚¢ï¼ˆç°¡æ˜“ç‰ˆï¼‰
      const list = document.getElementById('taxRateItemsList');
      list.innerHTML = currentOrders.map(o => `<div>æ³¨æ–‡ #${o.orderNumber || ''}: Â¥${(o.totalAmount || 0).toLocaleString()}</div>`).join('');
      
      document.getElementById('paymentModal').classList.remove('hidden');
    };

    window.closePaymentModal = () => document.getElementById('paymentModal').classList.add('hidden');

    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    window.handleLogin = async () => {
      const sid = document.getElementById('storeSelect').value;
      if (!sid) return;
      currentStoreId = sid;
      sessionStorage.setItem('handyStoreId', sid);
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('tablesScreen').classList.remove('hidden');
      loadTables();
    };

    window.handleLogout = () => { sessionStorage.clear(); location.reload(); };

    async function loadTables() {
      const tRef = collection(db, 'stores', currentStoreId, 'tables');
      const snap = await getDocs(tRef);
      const grid = document.getElementById('tablesGrid');
      grid.innerHTML = '';
      
      // æ³¨æ–‡çŠ¶æ…‹ã®ç›£è¦–
      const oRef = collection(db, 'stores', currentStoreId, 'orders');
      onSnapshot(query(oRef, where('paidAt', '==', null), where('deleted', '==', false), where('cancelledAt', '==', null)), (oSnap) => {
        const activeTables = new Set();
        oSnap.forEach(d => activeTables.add(d.data().tableNumber));
        
        grid.innerHTML = '';
        snap.forEach(d => {
          const t = d.data();
          const card = document.createElement('div');
          card.className = `table-card ${activeTables.has(t.name) ? 'has-pending-orders' : ''}`;
          card.innerHTML = `<h3>${t.name}</h3><button class="checkout-btn" onclick="openCheckoutForTable('${t.name}')">ä¼šè¨ˆ/ç®¡ç†</button>`;
          grid.appendChild(card);
        });
      });
    }

    // åˆæœŸåŒ–
    (async () => {
      const sSnap = await getDocs(query(collection(db, 'stores'), where('isActive', '==', true)));
      const sel = document.getElementById('storeSelect');
      sSnap.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id; opt.textContent = d.data().storeName;
        sel.appendChild(opt);
      });
    })();
  </script>
</body>
</html>