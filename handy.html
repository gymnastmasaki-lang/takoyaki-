<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ  - æ³¨æ–‡ãƒ»ä¼šè¨ˆå®Œå…¨ç‰ˆ</title>
  <style>
    /* æ—¢å­˜ã®ãƒãƒ³ãƒ‡ã‚£ã®ãƒ‡ã‚¶ã‚¤ãƒ³ã‚’ç¶­æŒ */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; }
    .container { max-width: 600px; margin: 0 auto; }
    .hidden { display: none !important; }

    /* ã‚«ãƒ¼ãƒ‰ãƒ»ãƒœã‚¿ãƒ³é¡ */
    .card { background: white; border-radius: 15px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); margin-bottom: 10px; }
    .btn { width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.2s; margin-bottom: 8px; }
    .btn-primary { background: #667eea; color: white; }
    .btn-success { background: #4CAF50; color: white; }
    .btn-danger { background: #f44336; color: white; }
    .btn-warning { background: #FF9800; color: white; }
    .btn-secondary { background: #e0e0e0; color: #333; }

    /* ãƒ†ãƒ¼ãƒ–ãƒ«ã‚°ãƒªãƒƒãƒ‰ */
    .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; }
    .table-card { background: white; border-radius: 12px; padding: 20px 10px; text-align: center; cursor: pointer; border: 2px solid transparent; }
    .table-card.active { border-color: #FF9800; background: #fff3e0; }

    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
    .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .menu-item { background: white; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #eee; }

    /* ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« (POSç§»æ¤ã‚¹ã‚¿ã‚¤ãƒ«) */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 10px; }
    .modal { background: white; width: 100%; max-width: 450px; border-radius: 20px; padding: 20px; max-height: 90vh; overflow-y: auto; }
    .item-row { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; align-items: center; }
    .clickable-text { color: #667eea; text-decoration: underline; cursor: pointer; }
    .payment-summary { background: #f8f9fa; padding: 15px; border-radius: 12px; text-align: center; margin: 15px 0; }
    .total-amount { font-size: 32px; font-weight: bold; color: #d32f2f; }
    
    .payment-methods { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 15px; }
    .method-btn { padding: 12px; border: 2px solid #ddd; border-radius: 8px; background: white; font-weight: bold; }
    .method-btn.selected { border-color: #667eea; background: #e8eaf6; }

    /* ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ */
    #customConfirmModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; align-items: center; justify-content: center; z-index: 9999; }
    .confirm-modal-content { background: white; width: 85%; max-width: 350px; border-radius: 20px; padding: 25px; text-align: center; }
  </style>
</head>
<body>

<div class="container">
  <div id="loginScreen" class="login-screen card">
    <h1 style="text-align:center; color:#667eea; margin-bottom:20px;">ãƒãƒ³ãƒ‡ã‚£ä¼šè¨ˆã‚·ã‚¹ãƒ†ãƒ </h1>
    <div style="margin-bottom:15px;">
      <label>åº—èˆ—é¸æŠ</label>
      <select id="storeSelect" style="width:100%; padding:12px; margin-top:5px; border-radius:8px;"></select>
    </div>
    <div style="margin-bottom:20px;">
      <label>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
      <input type="password" id="passwordInput" style="width:100%; padding:12px; margin-top:5px; border-radius:8px; border:1px solid #ddd;">
    </div>
    <button class="btn btn-primary" onclick="handleLogin()">ãƒ­ã‚°ã‚¤ãƒ³</button>
  </div>

  <div id="tablesScreen" class="hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; color:white;">
      <h2 id="displayStoreName">åº—èˆ—å</h2>
      <button class="btn btn-danger" style="width:auto; padding:5px 15px;" onclick="handleLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
    </div>
    <div id="tablesGrid" class="tables-grid"></div>
  </div>

  <div id="orderScreen" class="hidden">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; color:white;">
      <button class="btn btn-secondary" style="width:auto; margin:0;" onclick="backToTables()">â† æˆ»ã‚‹</button>
      <h2 id="targetTableName">ãƒ†ãƒ¼ãƒ–ãƒ«</h2>
      <button class="btn btn-warning" style="width:auto; margin:0;" onclick="openPaymentModal()">ä¼šè¨ˆ/ç®¡ç†</button>
    </div>
    <div id="menuContainer" class="menu-grid"></div>
  </div>
</div>

<div id="paymentModal" class="modal-overlay hidden">
  <div class="modal">
    <h2 style="text-align:center; margin-bottom:15px;">ä¼šè¨ˆãƒ»æ³¨æ–‡ç®¡ç†</h2>
    
    <div id="paymentItemsList" style="border:1px solid #eee; border-radius:10px; padding:5px 10px; max-height:180px; overflow-y:auto; margin-bottom:10px;"></div>

    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; background:#fff9c4; padding:10px; border-radius:8px;">
      <span>å€¤å¼•ãé¡:</span>
      <input type="number" id="discountInput" style="width:100px; text-align:right; padding:8px; font-size:16px;" value="0" oninput="updateTotalDisplay()">
    </div>

    <div class="payment-summary">
      <div style="font-size:14px; color:#666;">æœ€çµ‚ãŠæ”¯æ‰•ã„åˆè¨ˆ</div>
      <div class="total-amount" id="totalDisplay">Â¥0</div>
    </div>

    <div class="payment-methods">
      <button class="method-btn" id="m-cash" onclick="setMethod('cash')">ğŸ’´ ç¾é‡‘</button>
      <button class="method-btn" id="m-emoney" onclick="setMethod('emoney')">ğŸ’³ é›»å­</button>
      <button class="method-btn" id="m-credit" onclick="setMethod('credit')">ğŸ’³ ã‚«ãƒ¼ãƒ‰</button>
    </div>

    <div id="cashInputArea" class="hidden" style="background:#e8f5e9; padding:15px; border-radius:10px; margin-bottom:15px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <span>ãŠé ã‹ã‚Šé¡:</span>
        <input type="number" id="cashReceived" style="width:120px; text-align:right; padding:8px; font-size:18px;" oninput="calcChange()">
      </div>
      <div style="text-align:right; margin-top:8px; font-weight:bold; font-size:18px;">
        ãŠã¤ã‚Š: <span id="changeAmount" style="color:#d32f2f;">Â¥0</span>
      </div>
    </div>

    <button id="btnComplete" class="btn btn-success" disabled onclick="executePaymentFlow()">ä¼šè¨ˆã‚’å®Œäº†ã—ã¦å‰Šé™¤</button>
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
      <button class="btn btn-warning" onclick="statusUpdate('cancelledAt')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button class="btn btn-danger" onclick="statusUpdate('deleted')">ç›´æ¥å‰Šé™¤</button>
    </div>
    <button class="btn btn-secondary" onclick="closePaymentModal()">æˆ»ã‚‹</button>
  </div>
</div>

<div id="customConfirmModal">
  <div class="confirm-modal-content">
    <div id="modalIcon" style="font-size:50px; margin-bottom:10px;">âš ï¸</div>
    <h3 id="modalTitle">ç¢ºèª</h3>
    <p id="modalMessage" style="margin:15px 0; color:#666;"></p>
    <button id="modalConfirmBtn" class="btn btn-success" onclick="confirmCustomModal()">OK</button>
  </div>
</div>

<div id="cartBar" class="hidden" style="position:fixed; bottom:0; left:0; width:100%; background:rgba(0,0,0,0.85); color:white; padding:15px; display:flex; justify-content:space-between; align-items:center; z-index:500;">
  <div id="cartCount">0ç‚¹é¸æŠä¸­</div>
  <button class="btn btn-success" style="width:auto; margin:0;" onclick="sendOrder()">æ³¨æ–‡ã‚’é€ä¿¡</button>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, query, where, getDocs, doc, updateDoc, setDoc, getDoc, serverTimestamp, onSnapshot, increment, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
    authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
    projectId: "takoyaki-order-system-bacd7",
    storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
    messagingSenderId: "104494752890",
    appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let currentStoreId, storesData = {}, currentTable = '', cart = [], activeOrders = [], baseTotal = 0, selectedMethod = '';

  // --- åˆæœŸåŒ– & ãƒ­ã‚°ã‚¤ãƒ³ ---
  window.onload = async () => {
    const snap = await getDocs(query(collection(db, 'stores'), where('isActive', '==', true)));
    const sel = document.getElementById('storeSelect');
    snap.forEach(d => {
      storesData[d.id] = { name: d.data().storeName, pass: String(d.data().storePassword) };
      sel.innerHTML += `<option value="${d.id}">${d.data().storeName}</option>`;
    });
    if(sessionStorage.getItem('handyStoreId')) {
      currentStoreId = sessionStorage.getItem('handyStoreId');
      showTables();
    }
  };

  window.handleLogin = () => {
    const id = document.getElementById('storeSelect').value;
    if(document.getElementById('passwordInput').value === storesData[id].pass) {
      currentStoreId = id;
      sessionStorage.setItem('handyStoreId', id);
      showTables();
    } else alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™');
  };
  window.handleLogout = () => { sessionStorage.clear(); location.reload(); };

  // --- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ ---
  function showTables() {
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('tablesScreen').classList.remove('hidden');
    document.getElementById('displayStoreName').textContent = storesData[currentStoreId].name;
    
    onSnapshot(collection(db, 'stores', currentStoreId, 'orders'), async (snap) => {
      const occupied = new Set();
      snap.forEach(d => { 
        const data = d.data();
        if(!data.paidAt && !data.deleted && !data.cancelledAt) occupied.add(String(data.tableNumber)); 
      });
      
      const tSnap = await getDocs(collection(db, 'stores', currentStoreId, 'tables'));
      const grid = document.getElementById('tablesGrid');
      grid.innerHTML = '';
      tSnap.docs.map(d => d.data()).sort((a,b)=> (a.order||0)-(b.order||0)).forEach(t => {
        const hasOrder = occupied.has(t.name);
        grid.innerHTML += `<div class="table-card ${hasOrder?'active':''}" onclick="openOrderScreen('${t.name}')">
          <b>${t.name}</b><br><small>${hasOrder?'æ³¨æ–‡ã‚ã‚Š':'ç©ºå¸­'}</small>
        </div>`;
      });
    });
  }

  // --- æ³¨æ–‡æ©Ÿèƒ½ (ç¶­æŒ) ---
  window.openOrderScreen = async (tName) => {
    currentTable = tName;
    document.getElementById('tablesScreen').classList.add('hidden');
    document.getElementById('orderScreen').classList.remove('hidden');
    document.getElementById('targetTableName').textContent = tName;
    loadMenu();
  };

  async function loadMenu() {
    const mSnap = await getDocs(collection(db, 'stores', currentStoreId, 'menu'));
    const cont = document.getElementById('menuContainer');
    cont.innerHTML = '';
    mSnap.forEach(d => {
      const item = d.data();
      cont.innerHTML += `<div class="menu-item" onclick="addToCart('${item.name}', ${item.price}, ${item.taxRate||10})">
        <b>${item.name}</b><br>Â¥${item.price}
      </div>`;
    });
  }

  window.addToCart = (name, price, taxRate) => {
    cart.push({ name, price, taxRate, quantity: 1 });
    document.getElementById('cartBar').classList.remove('hidden');
    document.getElementById('cartCount').textContent = `${cart.length}ç‚¹ é¸æŠä¸­`;
  };

  window.sendOrder = async () => {
    const orderData = {
      tableNumber: currentTable,
      items: cart,
      totalAmount: cart.reduce((s, i) => s + i.price, 0),
      createdAt: serverTimestamp(),
      status: 'pending'
    };
    await setDoc(doc(collection(db, 'stores', currentStoreId, 'orders')), orderData);
    alert('æ³¨æ–‡ã‚’é€ä¿¡ã—ã¾ã—ãŸ');
    cart = [];
    document.getElementById('cartBar').classList.add('hidden');
  };

  window.backToTables = () => {
    document.getElementById('orderScreen').classList.add('hidden');
    document.getElementById('tablesScreen').classList.remove('hidden');
    cart = [];
    document.getElementById('cartBar').classList.add('hidden');
  };

  // --- ä¼šè¨ˆç®¡ç† (POSç§»æ¤ãƒ­ã‚¸ãƒƒã‚¯) ---
  window.openPaymentModal = async () => {
    const q = query(collection(db, 'stores', currentStoreId, 'orders'), where('tableNumber', '==', currentTable));
    const snap = await getDocs(q);
    activeOrders = snap.docs.map(d => ({id: d.id, ...d.data()})).filter(o => !o.paidAt && !o.deleted && !o.cancelledAt);
    
    if(!activeOrders.length) return alert('æœªä¼šè¨ˆã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“');
    
    renderPaymentItems();
    document.getElementById('paymentModal').classList.remove('hidden');
  };

  function renderPaymentItems() {
    const list = document.getElementById('paymentItemsList');
    list.innerHTML = '';
    baseTotal = 0;
    activeOrders.forEach((o, oIdx) => {
      (o.items||[]).forEach((item, iIdx) => {
        const p = (item.price + (item.toppingPrice||0)) * item.quantity;
        baseTotal += p;
        list.innerHTML += `<div class="item-row">
          <span class="clickable-text" onclick="editItemPrice(${oIdx}, ${iIdx})">${item.name} x${item.quantity}</span>
          <span>Â¥${p.toLocaleString()}</span>
        </div>`;
      });
    });
    updateTotalDisplay();
  }

  // é‡‘é¡å¤‰æ›´æ©Ÿèƒ½ (POSç§»æ¤)
  window.editItemPrice = async (oIdx, iIdx) => {
    const item = activeOrders[oIdx].items[iIdx];
    const n = prompt(`${item.name} ã®å˜ä¾¡ã‚’å¤‰æ›´`, item.price);
    if(n !== null && !isNaN(n)) {
      item.price = parseInt(n);
      const newTotal = activeOrders[oIdx].items.reduce((s, i) => s + (i.price * i.quantity), 0);
      await updateDoc(doc(db, 'stores', currentStoreId, 'orders', activeOrders[oIdx].id), { 
        items: activeOrders[oIdx].items,
        totalAmount: newTotal
      });
      renderPaymentItems();
    }
  };

  window.updateTotalDisplay = () => {
    const discount = parseInt(document.getElementById('discountInput').value) || 0;
    const final = Math.max(0, baseTotal - discount);
    document.getElementById('totalDisplay').textContent = `Â¥${final.toLocaleString()}`;
    document.getElementById('totalDisplay').dataset.value = final;
    if(selectedMethod === 'cash') calcChange();
  };

  window.setMethod = (m) => {
    selectedMethod = m;
    document.querySelectorAll('.method-btn').forEach(b => b.classList.remove('selected'));
    document.getElementById(`m-${m}`).classList.add('selected');
    document.getElementById('cashInputArea').classList.toggle('hidden', m !== 'cash');
    document.getElementById('btnComplete').disabled = (m === 'cash');
  };

  window.calcChange = () => {
    const tot = parseInt(document.getElementById('totalDisplay').dataset.value);
    const rec = parseInt(document.getElementById('cashReceived').value) || 0;
    const diff = rec - tot;
    document.getElementById('changeAmount').textContent = `Â¥${diff.toLocaleString()}`;
    document.getElementById('btnComplete').disabled = diff < 0;
  };

  // ä¼šè¨ˆå®Ÿè¡Œãƒ•ãƒ­ãƒ¼ (POSã¨å®Œå…¨åŒæœŸ: å£²ä¸Šåæ˜  + å‰Šé™¤)
  window.executePaymentFlow = async () => {
    try {
      const finalAmt = parseInt(document.getElementById('totalDisplay').dataset.value);
      const now = new Date();
      // æ·±å¤œ3æ™‚åŒºåˆ‡ã‚Šã®å–¶æ¥­æ—¥è¨ˆç®—
      const bizDate = new Date(now); if(bizDate.getHours() < 3) bizDate.setDate(bizDate.getDate() - 1);
      const dStr = `${bizDate.getFullYear()}-${String(bizDate.getMonth()+1).padStart(2,'0')}-${String(bizDate.getDate()).padStart(2,'0')}`;

      // 1. å£²ä¸Šé›†è¨ˆ (POSç§»æ¤)
      const sRef = doc(db, 'stores', currentStoreId, 'dailySales', dStr);
      const up = { totalSales: increment(finalAmt), customerCount: increment(1), updatedAt: serverTimestamp() };
      if(selectedMethod === 'cash') up.cashSales = increment(finalAmt);
      else if(selectedMethod === 'credit') up.creditSales = increment(finalAmt);
      else up.emoneSales = increment(finalAmt);

      const sDoc = await getDoc(sRef);
      if(sDoc.exists()) await updateDoc(sRef, up); else await setDoc(sRef, { date: dStr, ...up, createdAt: serverTimestamp() });

      // 2. æ³¨æ–‡ã‚’ã€Œå®Œäº†ã€ã‹ã¤ã€Œå‰Šé™¤ã€çŠ¶æ…‹ã«ã™ã‚‹
      for(const o of activeOrders) {
        await updateDoc(doc(db, 'stores', currentStoreId, 'orders', o.id), { 
          paidAt: serverTimestamp(), 
          paymentMethod: selectedMethod,
          deleted: true 
        });
      }

      // 3. å®Œäº†é€šçŸ¥ (OKãƒœã‚¿ãƒ³ã§æˆ»ã‚‹)
      await showCustomConfirm("ğŸ’°", "ä¼šè¨ˆå®Œäº†", "å£²ä¸Šã‚’è¨˜éŒ²ã—ã€æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚");
      
      closePaymentModal();
      backToTables();

    } catch(e) { alert("ã‚¨ãƒ©ãƒ¼: " + e.message); }
  };

  window.statusUpdate = async (field) => {
    if(confirm('å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ')) {
      for(const o of activeOrders) {
        const up = {};
        if(field === 'deleted') up.deleted = true; else up[field] = serverTimestamp();
        await updateDoc(doc(db, 'stores', currentStoreId, 'orders', o.id), up);
      }
      closePaymentModal();
      backToTables();
    }
  };

  // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
  let modalResolve;
  window.showCustomConfirm = (icon, title, msg) => {
    return new Promise(resolve => {
      modalResolve = resolve;
      document.getElementById('modalIcon').textContent = icon;
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalMessage').textContent = msg;
      document.getElementById('customConfirmModal').style.display = 'flex';
    });
  };
  window.confirmCustomModal = () => {
    document.getElementById('customConfirmModal').style.display = 'none';
    if(modalResolve) modalResolve();
  };

  window.closePaymentModal = () => {
    document.getElementById('paymentModal').classList.add('hidden');
    document.getElementById('discountInput').value = 0;
    document.getElementById('cashReceived').value = '';
    selectedMethod = '';
  };
</script>
</body>
</html>