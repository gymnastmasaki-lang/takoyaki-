<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ハンディシステム</title>
  
  <!-- 外部ライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <!-- タップ音 -->
  <script>
    // AudioContextを使用したタップ音生成
    let audioContext = null;
    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }
    function playTapSound() {
      initAudio();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    }
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* ログイン画面 */
    .login-screen {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .login-screen h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 28px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .login-btn:active {
      transform: scale(0.98);
    }
    
    /* テーブル一覧画面 */
    .tables-screen {
      display: none;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .header h2 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .header .store-info {
      color: #666;
      font-size: 14px;
    }
    
    .header-buttons {
      display: flex;
      gap: 10px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    
    /* モダンなサブメニューボタンスタイル */
    .modern-menu-btn {
      background: white;
      border: 2px solid #e0e0e0;
      padding: 12px 20px;
      border-radius: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      position: relative;
      overflow: hidden;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .modern-menu-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.5s;
    }
    
    .modern-menu-btn:hover::before {
      left: 100%;
    }
    
    .modern-menu-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: currentColor;
    }
    
    .modern-menu-btn:active {
      transform: translateY(0);
    }
    
    .btn-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .logout-btn {
      background: white;
      color: #f44336;
      border-color: #ffcdd2;
    }
    
    .logout-btn:hover {
      background: #ffebee;
    }
    
    .sales-btn {
      background: white;
      color: #4CAF50;
      border-color: #c8e6c9;
    }
    
    .sales-btn:hover {
      background: #f1f8e9;
    }
    
    .settlement-btn {
      background: white;
      color: #FF9800;
      border-color: #ffe0b2;
    }
    
    .settlement-btn:hover {
      background: #fff3e0;
    }
    
    .settings-btn {
      background: white;
      color: #2196F3;
      border-color: #bbdefb;
    }
    
    .settings-btn:hover {
      background: #e3f2fd;
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .table-card {
      background: white;
      border-radius: 15px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    
    .table-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .table-card.occupied {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .table-card.occupied::after {
      content: '●';
      position: absolute;
      top: 10px;
      right: 10px;
      color: #4CAF50;
      font-size: 12px;
      animation: blink 1.5s infinite;
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    
    .table-number {
      font-size: 36px;
      font-weight: bold;
      margin-bottom: 10px;
    }
    
    .table-label {
      font-size: 14px;
      opacity: 0.8;
    }
    
    /* メニュー画面 */
    .menu-screen {
      display: none;
    }
    
    .menu-header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .back-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .submit-btn {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .cart-summary {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .cart-items {
      max-height: 200px;
      overflow-y: auto;
    }
    
    .cart-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    
    .cart-item:last-child {
      border-bottom: none;
    }
    
    .quantity-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .quantity-btn {
      width: 30px;
      height: 30px;
      border: none;
      background: #667eea;
      color: white;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
    }
    
    .quantity-btn:active {
      background: #5568d3;
    }
    
    .cart-total {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #667eea;
      text-align: right;
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    
    .menu-categories {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    
    .category-btn {
      padding: 10px 20px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 20px;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .category-btn.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }
    
    .menu-items {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .menu-item {
      background: white;
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .menu-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .menu-item-name {
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 16px;
    }
    
    .menu-item-price {
      color: #667eea;
      font-size: 20px;
      font-weight: bold;
    }
    
    /* モーダル */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .modal-header h3 {
      font-size: 24px;
      color: #333;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 30px;
      cursor: pointer;
      color: #999;
      line-height: 1;
      padding: 0;
      width: 30px;
      height: 30px;
    }
    
    .modal-close:hover {
      color: #333;
    }
    
    .modal-footer {
      display: flex;
      gap: 10px;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #f0f0f0;
    }
    
    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      flex: 1;
      font-size: 16px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #666;
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    /* トッピング選択 */
    .toppings-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    
    .topping-option {
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
    }
    
    .topping-option.selected {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }
    
    .topping-name {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .topping-price {
      font-size: 14px;
      opacity: 0.8;
    }
    
    /* 売上モーダル */
    .sales-modal {
      max-width: 800px;
    }
    
    .sales-summary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 15px;
      margin-bottom: 20px;
    }
    
    .sales-amount {
      font-size: 48px;
      font-weight: bold;
      text-align: center;
      margin: 20px 0;
    }
    
    .sales-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    
    .sales-detail-item {
      background: white;
      color: #333;
      padding: 15px;
      border-radius: 10px;
    }
    
    .sales-detail-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .sales-detail-value {
      font-size: 20px;
      font-weight: bold;
      color: #667eea;
    }
    
    /* 清算モーダル */
    .settlement-card {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
      padding: 25px;
      border-radius: 15px;
      margin: 20px 0;
    }
    
    .settlement-amount {
      font-size: 42px;
      font-weight: bold;
      text-align: center;
      margin: 15px 0;
    }
    
    .settlement-details {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    
    .settlement-item {
      background: rgba(255, 255, 255, 0.2);
      padding: 15px;
      border-radius: 10px;
      backdrop-filter: blur(10px);
    }
    
    .settlement-label {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 5px;
    }
    
    .settlement-value {
      font-size: 22px;
      font-weight: bold;
    }
    
    /* 履歴モーダル */
    .history-item {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }
    
    .history-item:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    }
    
    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .history-table {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
    }
    
    .history-date {
      font-size: 12px;
      color: #999;
    }
    
    .history-items {
      background: #f8f9fa;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    .history-total {
      text-align: right;
      font-size: 20px;
      font-weight: bold;
      color: #4CAF50;
      margin-top: 10px;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .status-paid {
      background: #c8e6c9;
      color: #2e7d32;
    }
    
    .status-completed {
      background: #bbdefb;
      color: #1565c0;
    }
    
    /* 月次レポート */
    .report-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .report-section h4 {
      color: #667eea;
      margin-bottom: 15px;
      font-size: 18px;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 10px;
    }
    
    .chart-container {
      position: relative;
      height: 300px;
      margin: 20px 0;
    }
    
    /* PNG出力ボタン */
    .export-png-btn {
      background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .export-png-btn:hover {
      background: linear-gradient(135deg, #7B1FA2 0%, #6A1B9A 100%);
    }
    
    /* POS iframeモーダル */
    .pos-iframe-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 2000;
      animation: fadeIn 0.3s;
    }
    
    .pos-iframe-container {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 95%;
      height: 95%;
      max-width: 1400px;
      max-height: 900px;
      background: white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.5);
      display: flex;
      flex-direction: column;
    }
    
    .pos-iframe-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .pos-iframe-header h3 {
      margin: 0;
      font-size: 20px;
    }
    
    .pos-iframe-close {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      font-size: 28px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.3s;
    }
    
    .pos-iframe-close:hover {
      background: rgba(255, 255, 255, 0.3);
    }
    
    .pos-iframe-content {
      flex: 1;
      border: none;
      width: 100%;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
  
  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, getDocs, doc, getDoc, setDoc, where, onSnapshot, updateDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // グローバルに公開
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.doc = doc;
    window.onSnapshot = onSnapshot;
    window.updateDoc = updateDoc;
    window.deleteDoc = deleteDoc;
    window.Timestamp = Timestamp;
    
    console.log('✅ Firebase初期化完了');
    window.firebaseReady = true;
  </script>
</head>
<body>
  <!-- ログイン画面 -->
  <div id="loginScreen" class="container login-screen">
    <h1>ハンディシステム</h1>
    <div id="errorMessage" style="display: none; background: #ffebee; color: #c62828; padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold;"></div>
    <div class="form-group">
      <label>店舗選択</label>
      <select id="storeSelect">
        <option value="">店舗を選択...</option>
        <option value="shimoakatsuka">下赤塚</option>
        <option value="eiwashokuhin">栄和食品</option>
        <option value="takada">高田</option>
      </select>
    </div>
    <div class="form-group">
      <label>パスワード</label>
      <input type="password" id="passwordInput" placeholder="パスワードを入力">
    </div>
    <button class="login-btn" onclick="login()">ログイン</button>
  </div>

  <!-- テーブル一覧画面 -->
  <div id="tablesScreen" class="container tables-screen">
    <div class="header">
      <h2 id="staffWelcome"></h2>
      <div class="store-info" id="storeInfo"></div>
      <div class="header-buttons">
        <button class="modern-menu-btn logout-btn" onclick="logout()">
          <span class="btn-icon">←</span>
          ログアウト
        </button>
        <button class="modern-menu-btn sales-btn" onclick="showSalesModal()">
          <span class="btn-icon">¥</span>
          売上
        </button>
        <button class="modern-menu-btn settlement-btn" onclick="showSettlementModal()">
          <span class="btn-icon">✓</span>
          精算
        </button>
        <button class="modern-menu-btn settings-btn" onclick="showSettingsMenu()">
          <span class="btn-icon">⚙</span>
          設定
        </button>
      </div>
    </div>
    <div class="tables-grid" id="tablesGrid"></div>
  </div>

  <!-- メニュー画面 -->
  <div id="menuScreen" class="container menu-screen">
    <div class="menu-header">
      <button class="back-btn" onclick="backToTables()">← 戻る</button>
      <h2 id="currentTable"></h2>
      <button class="submit-btn" onclick="submitOrder()">注文</button>
    </div>
    
    <div class="cart-summary">
      <h3>カート</h3>
      <div class="cart-items" id="cartItems">
        <p style="text-align: center; color: #999;">商品を選択してください</p>
      </div>
      <div class="cart-total" id="cartTotal">合計: ¥0</div>
    </div>
    
    <div class="menu-categories" id="menuCategories"></div>
    <div class="menu-items" id="menuItems"></div>
  </div>

  <!-- トッピング選択モーダル -->
  <div id="toppingModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="toppingModalTitle">トッピング選択</h3>
        <button class="modal-close" onclick="closeToppingModal()">×</button>
      </div>
      <div class="toppings-grid" id="toppingsGrid"></div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="addItemWithTopping()">カートに追加</button>
        <button class="btn btn-secondary" onclick="closeToppingModal()">キャンセル</button>
      </div>
    </div>
  </div>

  <!-- 売上モーダル -->
  <div id="salesModal" class="modal-overlay" style="display: none;">
    <div class="modal-content sales-modal" style="max-width: 800px;">
      <div class="modal-header">
        <h3>売上集計</h3>
        <button class="modal-close" onclick="closeSalesModal()">×</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; display: flex; gap: 10px; align-items: center;">
          <label style="font-weight: bold;">集計期間:</label>
          <select id="salesPeriod" onchange="updateSales()" style="padding: 8px; border-radius: 8px; border: 2px solid #ddd;">
            <option value="today">今日</option>
            <option value="yesterday">昨日</option>
            <option value="week">今週</option>
            <option value="month">今月</option>
          </select>
        </div>
        <div class="sales-summary">
          <h3 style="margin-bottom: 10px;">総売上</h3>
          <div class="sales-amount" id="salesAmount">¥0</div>
          <div class="sales-details">
            <div class="sales-detail-item">
              <div class="sales-detail-label">注文件数</div>
              <div class="sales-detail-value" id="orderCount">0</div>
            </div>
            <div class="sales-detail-item">
              <div class="sales-detail-label">商品数</div>
              <div class="sales-detail-value" id="itemCount">0</div>
            </div>
            <div class="sales-detail-item">
              <div class="sales-detail-label">平均客単価</div>
              <div class="sales-detail-value" id="avgPrice">¥0</div>
            </div>
            <div class="sales-detail-item">
              <div class="sales-detail-label">最高額</div>
              <div class="sales-detail-value" id="maxPrice">¥0</div>
            </div>
          </div>
        </div>
        <div id="salesChart" style="margin-top: 20px;">
          <canvas id="salesChartCanvas"></canvas>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeSalesModal()">閉じる</button>
      </div>
    </div>
  </div>

  <!-- 精算モーダル -->
  <div id="settlementModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h3 style="color: #FF9800;">本日の精算</h3>
        <button class="modal-close" onclick="closeSettlementModal()">×</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin-bottom: 20px;">
          <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #333;">精算日</label>
          <input type="date" id="settlementDate" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
          <p style="font-size: 12px; color: #666; margin-top: 5px;">※ 昨日の精算を上げ忘れた場合など、過去の日付を選択できます</p>
        </div>
        <div id="settlementSummary" style="margin: 20px 0;"></div>
      </div>
      <div class="modal-footer" style="display: flex; flex-direction: column; gap: 10px;">
        <button class="btn" style="width: 100%; background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%); color: white;" onclick="confirmSettlement()">精算を実行</button>
        <button class="btn" style="width: 100%; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="generateDailyReport()">日計表出力</button>
        <button class="btn btn-secondary" style="width: 100%;" onclick="closeSettlementModal()">キャンセル</button>
      </div>
    </div>
  </div>

  <!-- 履歴モーダル -->
  <div id="historyModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3>注文履歴</h3>
        <button class="modal-close" onclick="closeHistoryModal()">×</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap;">
          <select id="historyDateFilter" onchange="filterHistory()" style="padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
            <option value="today">今日</option>
            <option value="yesterday">昨日</option>
            <option value="week">今週</option>
            <option value="month">今月</option>
            <option value="all">全期間</option>
          </select>
          <select id="historyStatusFilter" onchange="filterHistory()" style="padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
            <option value="all">すべて</option>
            <option value="paid">会計済み</option>
            <option value="completed">完了</option>
          </select>
          <button class="modern-menu-btn" onclick="refreshHistory()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none;">
            <span class="btn-icon">↻</span>
            更新
          </button>
        </div>
        <div id="historyList" style="max-height: 60vh; overflow-y: auto;"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeHistoryModal()">閉じる</button>
      </div>
    </div>
  </div>

  <!-- 支出モーダル -->
  <div id="expenseModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3 style="color: #f093fb;">支出入力</h3>
        <button class="modal-close" onclick="closeExpenseModal()">×</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; gap: 15px;">
          <label style="font-weight: bold; font-size: 16px;">日付:</label>
          <input type="date" id="expenseDateInput" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 16px; flex: 1;" onchange="loadExpensesByDate()" />
        </div>
        <div style="margin: 20px 0;">
          <table style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: #f5f5f5;">
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">店名</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">勘定科目</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">詳細</th>
                <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">金額</th>
                <th style="padding: 10px; border: 1px solid #ddd; width: 60px;"></th>
              </tr>
            </thead>
            <tbody id="expenseTableBody"></tbody>
          </table>
          <button class="btn" style="margin-top: 10px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="addExpenseRow()">＋ 行を追加</button>
          <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; text-align: right;">
            <span style="font-size: 18px; font-weight: bold;">合計: ¥</span>
            <span id="expenseTotal" style="font-size: 24px; font-weight: bold; color: #f093fb;">0</span>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end;">
        <button class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="saveExpenses()">保存</button>
        <button class="btn btn-secondary" onclick="closeExpenseModal()">閉じる</button>
      </div>
    </div>
  </div>

  <!-- 月次レポートモーダル -->
  <div id="monthlyReportModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <div class="modal-header">
        <h3>月次レポート</h3>
        <button class="modal-close" onclick="closeMonthlyReportModal()">×</button>
      </div>
      <div style="padding: 20px;">
        <div style="margin: 20px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
          <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">開始日</label>
            <input type="date" id="reportStartDate" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
          </div>
          <div style="flex: 1; min-width: 200px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">終了日</label>
            <input type="date" id="reportEndDate" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
          </div>
          <button onclick="generateMonthlyReport()" style="padding: 12px 24px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px;">レポート生成</button>
        </div>
        <div id="monthlyReportContent"></div>
      </div>
      <div class="modal-footer">
        <button class="export-png-btn" onclick="exportReportAsPNG()">
          <span class="btn-icon">↓</span>
          PNG出力
        </button>
        <button class="btn btn-secondary" onclick="closeMonthlyReportModal()">閉じる</button>
      </div>
    </div>
  </div>

  <!-- プリンタ設定モーダル -->
  <div id="printerSettingsModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <h3 style="font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 15px; color: #333;">プリンタ設定</h3>
      <p style="text-align: center; font-size: 16px; color: #666; margin-bottom: 30px;">TSP650II / mC-Print3 / Bluetooth対応</p>
      
      <!-- 接続方式選択 -->
      <div style="margin-bottom: 25px;">
        <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">接続方式</label>
        <div style="display: flex; gap: 10px;">
          <button id="connectionTypeEthernet" onclick="selectConnectionType('ethernet')" 
                  style="flex: 1; padding: 15px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
            WiFi / LAN
          </button>
          <button id="connectionTypeBluetooth" onclick="selectConnectionType('bluetooth')" 
                  style="flex: 1; padding: 15px; border: 2px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
            Bluetooth
          </button>
        </div>
      </div>
      
      <!-- Ethernet設定 -->
      <div id="ethernetSettings" style="display: block;">
        <div style="margin-bottom: 25px;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">プリンタIPアドレス</label>
          <input type="text" id="printerIPInput" placeholder="例: 192.168.1.100" 
                 style="width: 100%; padding: 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
          <div style="margin-top: 8px; font-size: 14px; color: #666;">
            プリンタのIPアドレスを入力してください<br>
            <small style="color: #999;">※プリンタの設定印刷で確認できます</small>
          </div>
        </div>
      </div>
      
      <!-- Bluetooth設定 -->
      <div id="bluetoothSettings" style="display: none;">
        <div style="margin-bottom: 25px;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">Bluetoothプリンタ</label>
          <button onclick="searchBluetoothPrinter()" 
                  style="width: 100%; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; box-shadow: 0 4px 15px rgba(33,150,243,0.3);">
            プリンタを検索
          </button>
          <div id="bluetoothDeviceInfo" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 8px; display: none;">
            <div style="font-weight: bold; color: #333;">接続済みプリンタ:</div>
            <div id="bluetoothDeviceName" style="color: #666; margin-top: 5px;">なし</div>
          </div>
          <div style="margin-top: 8px; font-size: 14px; color: #666;">
            ESC/POS対応のBluetoothプリンタを検索します<br>
            <small style="color: #999;">※Chrome、Edgeで利用可能</small>
          </div>
        </div>
      </div>
      
      <div style="margin-bottom: 25px;">
        <button onclick="testPrinterConnection()" id="testConnectionBtn"
                style="width: 100%; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; box-shadow: 0 4px 15px rgba(76,175,80,0.3);">
          接続テスト
        </button>
        <div id="printerTestResult" style="margin-top: 10px; padding: 10px; border-radius: 8px; display: none;"></div>
      </div>
      
      <div style="display: flex; gap: 15px; margin-top: 30px;">
        <button onclick="closePrinterSettingsModal()" 
                style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: #e0e0e0; color: #666;">
          キャンセル
        </button>
        <button onclick="savePrinterSettings()" 
                style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          保存
        </button>
      </div>
    </div>
  </div>

  <!-- POSモーダル -->
  <div id="posIframeModal" class="pos-iframe-modal">
    <div class="pos-iframe-container">
      <div class="pos-iframe-header">
        <h3 id="posModalTitle">POS機能</h3>
        <button class="pos-iframe-close" onclick="closePOSModal()">×</button>
      </div>
      <iframe id="posIframe" class="pos-iframe-content" src="about:blank"></iframe>
    </div>
  </div>

  <script>
    // グローバル変数
    let currentStaff = '';
    let currentStore = '';
    let currentStoreId = '';
    let currentStoreName = '';
    let storesData = {};
    let currentTableId = null;
    let cart = [];
    let menuData = {
      categories: ['定番', '限定', 'トッピング', 'ドリンク'],
      items: [
        { id: 1, name: 'たこ焼き(8個)', price: 500, category: '定番', hasToppings: true },
        { id: 2, name: 'たこ焼き(12個)', price: 700, category: '定番', hasToppings: true },
        { id: 3, name: 'ねぎ焼き(8個)', price: 600, category: '定番', hasToppings: true },
        { id: 4, name: 'チーズたこ焼き(8個)', price: 600, category: '限定', hasToppings: true },
        { id: 5, name: 'ビール', price: 500, category: 'ドリンク', hasToppings: false },
        { id: 6, name: 'ウーロン茶', price: 200, category: 'ドリンク', hasToppings: false }
      ],
      toppings: [
        { id: 1, name: 'ソース', price: 0 },
        { id: 2, name: '塩', price: 0 },
        { id: 3, name: 'ポン酢', price: 0 },
        { id: 4, name: 'マヨネーズ', price: 50 }
      ]
    };
    let selectedItem = null;
    let selectedTopping = null;
    let allOrders = []; // 履歴データ保存用

    // 店舗リストをFirebaseから読み込み
    async function loadStoreList() {
      try {
        const storesQuery = query(collection(window.db, 'stores'));
        const storesSnapshot = await getDocs(storesQuery);
        const storeSelect = document.getElementById('storeSelect');
        
        storeSelect.innerHTML = '<option value="">店舗を選択...</option>';
        storesData = {};
        
        storesSnapshot.forEach(doc => {
          const storeData = doc.data();
          const storeId = doc.id;
          const storeName = storeData.storeName || doc.id;
          const password = storeData.storePassword || '';
          
          storesData[storeId] = {
            storeName: storeName,
            password: String(password),
            isActive: true
          };
          
          const option = document.createElement('option');
          option.value = storeId;
          option.textContent = storeName;
          storeSelect.appendChild(option);
        });
      } catch (error) {
        console.error('❌ 店舗リスト読み込みエラー:', error);
        showError('店舗リストの読み込みに失敗しました');
      }
    }

    // ログイン処理
    async function login() {
      const storeId = document.getElementById('storeSelect').value;
      const inputPassword = document.getElementById('passwordInput').value.trim();
      
      if (!storeId) {
        showError('店舗を選択してください');
        return;
      }
      if (!inputPassword) {
        showError('パスワードを入力してください');
        return;
      }
      
      const storeInfo = storesData[storeId];
      if (inputPassword !== storeInfo.password) {
        showError('パスワードが正しくありません');
        return;
      }
      
      currentStoreId = storeId;
      currentStoreName = storeInfo.storeName;
      currentStore = storeId;
      
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('tablesScreen').style.display = 'block';
      
      document.getElementById('staffWelcome').textContent = currentStoreName;
      document.getElementById('storeInfo').textContent = currentStoreName;

      loadTables();
      loadOrderHistory();
    }
    
    // エラー表示関数
    function showError(message) {
      const errorDiv = document.getElementById('errorMessage');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 3000);
    }
    
    // ページ読み込み時に店舗リストを取得
    window.addEventListener('DOMContentLoaded', async function() {
      // Firebaseの準備を待つ
      while (!window.firebaseReady) {
        await new Promise(r => setTimeout(r, 100));
      }
      await loadStoreList();
      loadOrderHistory();
    });

    // ログアウト
    function logout() {
      if (confirm('ログアウトしますか?')) {
        document.getElementById('tablesScreen').style.display = 'none';
        document.getElementById('loginScreen').style.display = 'block';
        document.getElementById('staffName').value = '';
        currentStaff = '';
        currentStore = '';
      }
    }

    // テーブル一覧読み込み
    function loadTables() {
      const tablesGrid = document.getElementById('tablesGrid');
      tablesGrid.innerHTML = '';

      const tableCount = 12;
      const occupiedTables = [1, 3, 7]; // サンプル: 使用中のテーブル

      for (let i = 1; i <= tableCount; i++) {
        const tableCard = document.createElement('div');
        tableCard.className = 'table-card';
        if (occupiedTables.includes(i)) {
          tableCard.classList.add('occupied');
        }
        tableCard.innerHTML = `
          <div class="table-number">${i}</div>
          <div class="table-label">テーブル</div>
        `;
        tableCard.onclick = () => openTable(i);
        tablesGrid.appendChild(tableCard);
      }
    }

    // テーブルを開く
    function openTable(tableId) {
      playTapSound();
      currentTableId = tableId;
      cart = [];

      document.getElementById('tablesScreen').style.display = 'none';
      document.getElementById('menuScreen').style.display = 'block';
      document.getElementById('currentTable').textContent = `テーブル ${tableId}`;

      loadMenu();
      updateCart();
    }

    // テーブル一覧に戻る
    function backToTables() {
      if (cart.length > 0) {
        if (!confirm('カート内の商品が破棄されますがよろしいですか?')) {
          return;
        }
      }
      document.getElementById('menuScreen').style.display = 'none';
      document.getElementById('tablesScreen').style.display = 'block';
      cart = [];
      currentTableId = null;
    }

    // メニュー読み込み
    function loadMenu(category = null) {
      const categoriesEl = document.getElementById('menuCategories');
      const itemsEl = document.getElementById('menuItems');

      // カテゴリボタン
      categoriesEl.innerHTML = '';
      menuData.categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'category-btn';
        if (category === cat || (!category && cat === '定番')) {
          btn.classList.add('active');
        }
        btn.textContent = cat;
        btn.onclick = () => loadMenu(cat);
        categoriesEl.appendChild(btn);
      });

      // メニューアイテム
      const currentCategory = category || '定番';
      const filteredItems = menuData.items.filter(item => item.category === currentCategory);

      itemsEl.innerHTML = '';
      filteredItems.forEach(item => {
        const itemCard = document.createElement('div');
        itemCard.className = 'menu-item';
        itemCard.innerHTML = `
          <div class="menu-item-name">${item.name}</div>
          <div class="menu-item-price">¥${item.price}</div>
        `;
        itemCard.onclick = () => selectMenuItem(item);
        itemsEl.appendChild(itemCard);
      });
    }

    // 商品選択
    function selectMenuItem(item) {
      playTapSound();
      if (item.hasToppings) {
        selectedItem = item;
        showToppingModal(item);
      } else {
        cart.push({ ...item, quantity: 1 });
        updateCart();
      }
    }

    // トッピングモーダル表示
    function showToppingModal(item) {
      document.getElementById('toppingModalTitle').textContent = `${item.name} - トッピング選択`;
      const grid = document.getElementById('toppingsGrid');
      grid.innerHTML = '';

      menuData.toppings.forEach(topping => {
        const option = document.createElement('div');
        option.className = 'topping-option';
        option.innerHTML = `
          <div class="topping-name">${topping.name}</div>
          <div class="topping-price">${topping.price > 0 ? '+¥' + topping.price : '無料'}</div>
        `;
        option.onclick = () => selectTopping(topping, option);
        grid.appendChild(option);
      });

      document.getElementById('toppingModal').style.display = 'flex';
    }

    // トッピング選択
    function selectTopping(topping, element) {
      playTapSound();
      document.querySelectorAll('.topping-option').forEach(el => el.classList.remove('selected'));
      element.classList.add('selected');
      selectedTopping = topping;
    }

    // トッピング付き商品追加
    function addItemWithTopping() {
      if (!selectedTopping) {
        alert('トッピングを選択してください');
        return;
      }

      const itemWithTopping = {
        ...selectedItem,
        toppingName: selectedTopping.name,
        toppingPrice: selectedTopping.price,
        totalPrice: selectedItem.price + selectedTopping.price,
        quantity: 1
      };

      cart.push(itemWithTopping);
      updateCart();
      closeToppingModal();
    }

    // トッピングモーダル閉じる
    function closeToppingModal() {
      document.getElementById('toppingModal').style.display = 'none';
      selectedItem = null;
      selectedTopping = null;
    }

    // カート更新
    function updateCart() {
      const cartItemsEl = document.getElementById('cartItems');
      const cartTotalEl = document.getElementById('cartTotal');

      if (cart.length === 0) {
        cartItemsEl.innerHTML = '<p style="text-align: center; color: #999;">商品を選択してください</p>';
        cartTotalEl.textContent = '合計: ¥0';
        return;
      }

      cartItemsEl.innerHTML = '';
      let total = 0;

      cart.forEach((item, index) => {
        const price = item.totalPrice || item.price;
        const itemTotal = price * item.quantity;
        total += itemTotal;

        const cartItem = document.createElement('div');
        cartItem.className = 'cart-item';
        cartItem.innerHTML = `
          <div>
            <div style="font-weight: bold;">${item.name}</div>
            ${item.toppingName ? `<div style="font-size: 12px; color: #666;">トッピング: ${item.toppingName}</div>` : ''}
          </div>
          <div class="quantity-controls">
            <button class="quantity-btn" onclick="changeQuantity(${index}, -1)">-</button>
            <span style="min-width: 30px; text-align: center;">${item.quantity}</span>
            <button class="quantity-btn" onclick="changeQuantity(${index}, 1)">+</button>
            <span style="margin-left: 10px; font-weight: bold;">¥${itemTotal}</span>
          </div>
        `;
        cartItemsEl.appendChild(cartItem);
      });

      cartTotalEl.textContent = `合計: ¥${total}`;
    }

    // 数量変更
    function changeQuantity(index, delta) {
      playTapSound();
      cart[index].quantity += delta;
      if (cart[index].quantity <= 0) {
        cart.splice(index, 1);
      }
      updateCart();
    }

    // 注文送信
    function submitOrder() {
      if (cart.length === 0) {
        alert('商品を選択してください');
        return;
      }

      const order = {
        id: Date.now(),
        tableId: currentTableId,
        staff: currentStaff,
        items: [...cart],
        total: cart.reduce((sum, item) => sum + (item.totalPrice || item.price) * item.quantity, 0),
        timestamp: new Date(),
        status: 'completed'
      };

      allOrders.push(order);
      localStorage.setItem('handyOrders', JSON.stringify(allOrders));

      alert('注文を送信しました!');
      backToTables();
    }

    // 履歴データ読み込み
    function loadOrderHistory() {
      try {
        const saved = localStorage.getItem('handyOrders');
        if (saved) {
          allOrders = JSON.parse(saved);
          // 日付文字列をDateオブジェクトに変換
          allOrders.forEach(order => {
            if (typeof order.timestamp === 'string') {
              order.timestamp = new Date(order.timestamp);
            }
          });
        }
      } catch (error) {
        console.error('履歴の読み込みに失敗:', error);
        allOrders = [];
      }
    }

    // 売上モーダル表示
    function showSalesModal() {
      document.getElementById('salesModal').style.display = 'flex';
      updateSales();
    }

    // 売上モーダル閉じる
    function closeSalesModal() {
      document.getElementById('salesModal').style.display = 'none';
    }

    // 売上集計
    function updateSales() {
      const period = document.getElementById('salesPeriod').value;
      const now = new Date();
      let startDate = new Date(now);

      switch(period) {
        case 'today':
          startDate.setHours(0, 0, 0, 0);
          break;
        case 'yesterday':
          startDate.setDate(startDate.getDate() - 1);
          startDate.setHours(0, 0, 0, 0);
          break;
        case 'week':
          startDate.setDate(startDate.getDate() - 7);
          break;
        case 'month':
          startDate.setMonth(startDate.getMonth() - 1);
          break;
      }

      const filteredOrders = allOrders.filter(order => {
        const orderDate = new Date(order.timestamp);
        return orderDate >= startDate;
      });

      const totalSales = filteredOrders.reduce((sum, order) => sum + order.total, 0);
      const orderCount = filteredOrders.length;
      const itemCount = filteredOrders.reduce((sum, order) => 
        sum + order.items.reduce((s, item) => s + item.quantity, 0), 0);
      const avgPrice = orderCount > 0 ? Math.round(totalSales / orderCount) : 0;
      const maxPrice = orderCount > 0 ? Math.max(...filteredOrders.map(o => o.total)) : 0;

      document.getElementById('salesAmount').textContent = `¥${totalSales.toLocaleString()}`;
      document.getElementById('orderCount').textContent = orderCount;
      document.getElementById('itemCount').textContent = itemCount;
      document.getElementById('avgPrice').textContent = `¥${avgPrice.toLocaleString()}`;
      document.getElementById('maxPrice').textContent = `¥${maxPrice.toLocaleString()}`;

      // グラフ表示は簡易版のため省略
    }

    // 精算モーダル表示
    function showSettlementModal() {
      // 今日の日付を設定
      const today = new Date();
      const dateStr = today.toISOString().split('T')[0];
      document.getElementById('settlementDate').value = dateStr;
      
      document.getElementById('settlementModal').style.display = 'flex';
      calculateSettlement();
    }

    // 精算モーダル閉じる
    function closeSettlementModal() {
      document.getElementById('settlementModal').style.display = 'none';
    }

    // 精算計算
    function calculateSettlement() {
      const selectedDate = new Date(document.getElementById('settlementDate').value);
      selectedDate.setHours(0, 0, 0, 0);
      
      const nextDay = new Date(selectedDate);
      nextDay.setDate(nextDay.getDate() + 1);

      const dayOrders = allOrders.filter(order => {
        const orderDate = new Date(order.timestamp);
        return orderDate >= selectedDate && orderDate < nextDay;
      });

      const totalSales = dayOrders.reduce((sum, order) => sum + order.total, 0);
      const orderCount = dayOrders.length;
      const itemCount = dayOrders.reduce((sum, order) => 
        sum + order.items.reduce((s, item) => s + item.quantity, 0), 0);

      const summaryHTML = `
        <div class="settlement-card">
          <div style="text-align: center; margin-bottom: 10px; font-size: 18px; opacity: 0.9;">
            ${selectedDate.toLocaleDateString('ja-JP')}
          </div>
          <div class="settlement-amount">¥${totalSales.toLocaleString()}</div>
          <div class="settlement-details">
            <div class="settlement-item">
              <div class="settlement-label">注文件数</div>
              <div class="settlement-value">${orderCount}件</div>
            </div>
            <div class="settlement-item">
              <div class="settlement-label">商品数</div>
              <div class="settlement-value">${itemCount}個</div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('settlementSummary').innerHTML = summaryHTML;
    }

    // 精算実行
    function confirmSettlement() {
      if (confirm('精算を実行しますか？\nこの操作は取り消せません。')) {
        alert('精算が完了しました');
        closeSettlementModal();
      }
    }

    // 日計表出力
    function generateDailyReport() {
      alert('日計表を生成します（実装予定）');
    }

    // 履歴モーダル表示
    function showHistoryModal() {
      document.getElementById('historyModal').style.display = 'flex';
      filterHistory();
    }

    // 履歴モーダル閉じる
    function closeHistoryModal() {
      document.getElementById('historyModal').style.display = 'none';
    }

    // 履歴フィルター
    function filterHistory() {
      const dateFilter = document.getElementById('historyDateFilter').value;
      const statusFilter = document.getElementById('historyStatusFilter').value;
      const now = new Date();
      let startDate = new Date(0);

      switch(dateFilter) {
        case 'today':
          startDate = new Date(now);
          startDate.setHours(0, 0, 0, 0);
          break;
        case 'yesterday':
          startDate = new Date(now);
          startDate.setDate(startDate.getDate() - 1);
          startDate.setHours(0, 0, 0, 0);
          break;
        case 'week':
          startDate = new Date(now);
          startDate.setDate(startDate.getDate() - 7);
          break;
        case 'month':
          startDate = new Date(now);
          startDate.setMonth(startDate.getMonth() - 1);
          break;
      }

      let filtered = allOrders.filter(order => {
        const orderDate = new Date(order.timestamp);
        const dateMatch = dateFilter === 'all' || orderDate >= startDate;
        const statusMatch = statusFilter === 'all' || order.status === statusFilter;
        return dateMatch && statusMatch;
      });

      // 新しい順にソート
      filtered.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

      displayHistory(filtered);
    }

    // 履歴表示
    function displayHistory(orders) {
      const listEl = document.getElementById('historyList');
      
      if (orders.length === 0) {
        listEl.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">該当する履歴がありません</p>';
        return;
      }

      listEl.innerHTML = orders.map(order => {
        const date = new Date(order.timestamp);
        const itemsHTML = order.items.map(item => 
          `<div style="display: flex; justify-content: space-between; padding: 5px 0;">
            <span>${item.name} ${item.toppingName ? '(' + item.toppingName + ')' : ''} × ${item.quantity}</span>
            <span>¥${((item.totalPrice || item.price) * item.quantity).toLocaleString()}</span>
          </div>`
        ).join('');

        return `
          <div class="history-item">
            <div class="history-header">
              <div>
                <div class="history-table">テーブル ${order.tableId}</div>
                <div class="history-date">${date.toLocaleString('ja-JP')}</div>
              </div>
              <span class="status-badge status-${order.status}">${order.status === 'paid' ? '会計済み' : '完了'}</span>
            </div>
            <div class="history-items">${itemsHTML}</div>
            <div class="history-total">合計: ¥${order.total.toLocaleString()}</div>
          </div>
        `;
      }).join('');
    }

    // 履歴更新
    function refreshHistory() {
      loadOrderHistory();
      filterHistory();
    }

    // 支出モーダル（簡易版）
    function showExpenseModal() {
      alert('支出入力機能（実装予定）');
    }

    function closeExpenseModal() {
      document.getElementById('expenseModal').style.display = 'none';
    }

    // 月次レポートモーダル表示
    function showMonthlyReportModal() {
      document.getElementById('monthlyReportModal').style.display = 'flex';
      
      // デフォルトで今月の日付を設定
      const now = new Date();
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      
      document.getElementById('reportStartDate').value = firstDay.toISOString().split('T')[0];
      document.getElementById('reportEndDate').value = lastDay.toISOString().split('T')[0];
    }

    // 月次レポートモーダル閉じる
    function closeMonthlyReportModal() {
      document.getElementById('monthlyReportModal').style.display = 'none';
    }

    // 月次レポート生成
    function generateMonthlyReport() {
      const startDate = new Date(document.getElementById('reportStartDate').value);
      const endDate = new Date(document.getElementById('reportEndDate').value);
      endDate.setHours(23, 59, 59, 999);

      const filtered = allOrders.filter(order => {
        const orderDate = new Date(order.timestamp);
        return orderDate >= startDate && orderDate <= endDate;
      });

      const totalSales = filtered.reduce((sum, order) => sum + order.total, 0);
      const orderCount = filtered.length;

      const contentHTML = `
        <div class="report-section">
          <h4>期間サマリー</h4>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px;">
            <div style="padding: 15px; background: #f5f5f5; border-radius: 8px;">
              <div style="font-size: 14px; color: #666;">総売上</div>
              <div style="font-size: 28px; font-weight: bold; color: #4CAF50;">¥${totalSales.toLocaleString()}</div>
            </div>
            <div style="padding: 15px; background: #f5f5f5; border-radius: 8px;">
              <div style="font-size: 14px; color: #666;">注文件数</div>
              <div style="font-size: 28px; font-weight: bold; color: #2196F3;">${orderCount}件</div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('monthlyReportContent').innerHTML = contentHTML;
    }

    // PNG出力
    async function exportReportAsPNG() {
      const content = document.getElementById('monthlyReportContent');
      if (!content.innerHTML) {
        alert('先にレポートを生成してください');
        return;
      }

      try {
        const canvas = await html2canvas(content, {
          backgroundColor: '#ffffff',
          scale: 2
        });

        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `月次レポート_${new Date().toISOString().split('T')[0]}.png`;
          a.click();
          URL.revokeObjectURL(url);
        });

        alert('PNGファイルをダウンロードしました');
      } catch (error) {
        console.error('PNG出力エラー:', error);
        alert('PNG出力に失敗しました');
      }
    }

    // 設定メニュー
    function showSettingsMenu() {
      const options = [
        '履歴を見る',
        '支出入力',
        '月次レポート',
        'プリンタ設定',
        'POSシステムを開く'
      ];

      const choice = prompt('設定メニュー:\n' + options.map((opt, i) => `${i + 1}. ${opt}`).join('\n') + '\n\n番号を入力してください');

      switch(choice) {
        case '1': showHistoryModal(); break;
        case '2': showExpenseModal(); break;
        case '3': showMonthlyReportModal(); break;
        case '4': showPrinterSettings(); break;
        case '5': openPOSSystem(); break;
      }
    }

    // プリンタ設定
    function showPrinterSettings() {
      document.getElementById('printerSettingsModal').style.display = 'flex';
    }

    function closePrinterSettingsModal() {
      document.getElementById('printerSettingsModal').style.display = 'none';
    }

    function selectConnectionType(type) {
      // ボタンのスタイル切り替え
      if (type === 'ethernet') {
        document.getElementById('connectionTypeEthernet').style.background = '#667eea';
        document.getElementById('connectionTypeEthernet').style.color = 'white';
        document.getElementById('connectionTypeBluetooth').style.background = 'white';
        document.getElementById('connectionTypeBluetooth').style.color = '#666';
        document.getElementById('ethernetSettings').style.display = 'block';
        document.getElementById('bluetoothSettings').style.display = 'none';
      } else {
        document.getElementById('connectionTypeBluetooth').style.background = '#667eea';
        document.getElementById('connectionTypeBluetooth').style.color = 'white';
        document.getElementById('connectionTypeEthernet').style.background = 'white';
        document.getElementById('connectionTypeEthernet').style.color = '#666';
        document.getElementById('bluetoothSettings').style.display = 'block';
        document.getElementById('ethernetSettings').style.display = 'none';
      }
    }

    function searchBluetoothPrinter() {
      alert('Bluetoothプリンタ検索機能（実装予定）');
    }

    function testPrinterConnection() {
      alert('プリンタ接続テスト（実装予定）');
    }

    function savePrinterSettings() {
      alert('プリンタ設定を保存しました');
      closePrinterSettingsModal();
    }

    // POSシステムを開く
    function openPOSSystem() {
      document.getElementById('posModalTitle').textContent = 'POSシステム';
      document.getElementById('posIframe').src = 'pos.html?modal=sales';
      document.getElementById('posIframeModal').style.display = 'block';
    }

    // POSモーダルを閉じる
    function closePOSModal() {
      document.getElementById('posIframeModal').style.display = 'none';
      document.getElementById('posIframe').src = 'about:blank';
    }

    // 初期化
  </script>
</body>
</html>
