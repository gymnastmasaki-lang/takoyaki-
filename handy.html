<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ  - ä¼šè¨ˆæ©Ÿèƒ½ä»˜ã</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    /* ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ */
    .login-screen {
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .login-screen h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 28px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
      padding: 12px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }
    
    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .login-btn {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .login-btn:active {
      transform: scale(0.98);
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ */
    .tables-screen {
      display: none;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .header h2 {
      color: #667eea;
      margin-bottom: 10px;
    }
    
    /* ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆãƒœã‚¿ãƒ³ */
    .mode-toggle {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .mode-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid #667eea;
      background: white;
      color: #667eea;
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .mode-btn.active {
      background: #667eea;
      color: white;
    }
    
    .mode-btn:active {
      transform: scale(0.95);
    }
    
    .store-info {
      color: #666;
      font-size: 14px;
    }
    
    .logout-btn {
      margin-top: 15px;
      padding: 10px 20px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      width: 100%;
    }
    
    .logout-btn:active {
      transform: scale(0.98);
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }
    
    .table-card {
      background: white;
      border-radius: 15px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      position: relative;
    }
    
    .table-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    }
    
    .table-card:active {
      transform: translateY(-2px);
    }
    
    .table-card .table-name {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 10px;
    }
    
    .table-card .table-status {
      font-size: 12px;
      color: #999;
    }
    
    /* ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .table-card.payment-mode {
      cursor: default;
      padding: 20px;
    }
    
    .table-card.has-orders {
      border: 3px solid #4CAF50;
    }
    
    .table-card.has-incomplete-orders {
      border: 3px solid #FF9800 !important;
      background: #fff3e0;
    }
    
    .table-card.all-paid {
      border: 3px solid #2196F3;
    }
    
    .table-card .order-info {
      margin-top: 10px;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 8px;
      font-size: 12px;
    }
    
    .table-card .order-total {
      font-size: 20px;
      font-weight: bold;
      color: #4CAF50;
      margin: 10px 0;
    }
    
    .table-card .payment-btn {
      width: 100%;
      padding: 10px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
    }
    
    .table-card .payment-btn:active {
      transform: scale(0.95);
    }
    
    .table-card .no-orders {
      color: #999;
      font-size: 12px;
      margin-top: 10px;
    }
    
    .table-card .status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: bold;
    }
    
    .table-card .status-badge.paid {
      background: #2196F3;
      color: white;
    }
    
    .table-card .status-badge.incomplete {
      background: #FF9800;
      color: white;
    }
    
    .hidden {
      display: none !important;
    }
    
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 15px;
      text-align: center;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: white;
      font-size: 18px;
    }
    
    /* ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .custom-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      z-index: 10000;
      justify-content: center;
      align-items: center;
      animation: fadeIn 0.2s ease-out;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }
    
    .custom-modal {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.3s ease-out;
      text-align: center;
    }
    
    @keyframes slideUp {
      from {
        transform: translateY(30px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .custom-modal .modal-icon {
      font-size: 60px;
      margin-bottom: 20px;
    }
    
    .custom-modal .modal-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
    }
    
    .custom-modal .modal-message {
      font-size: 16px;
      color: #666;
      margin-bottom: 25px;
      line-height: 1.5;
      white-space: pre-line;
    }
    
    .custom-modal .modal-buttons {
      display: flex;
      gap: 10px;
    }
    
    .custom-modal .modal-btn {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .custom-modal .modal-btn:active {
      transform: scale(0.95);
    }
    
    .custom-modal .modal-btn-cancel {
      background: #e0e0e0;
      color: #666;
    }
    
    .custom-modal .modal-btn-confirm {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .custom-modal .modal-btn-danger {
      background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);
      color: white;
    }
    
    .custom-modal .modal-btn-success {
      background: linear-gradient(135deg, #4CAF50 0%, #8BC34A 100%);
      color: white;
    }
    
    .custom-modal .modal-btn-single {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    /* ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« */
    .payment-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
      z-index: 1000;
      overflow-y: auto;
    }
    
    .payment-modal-content {
      max-width: 600px;
      margin: 20px auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .payment-modal-header {
      text-align: center;
      margin-bottom: 25px;
    }
    
    .payment-modal-header h2 {
      color: #667eea;
      font-size: 28px;
      margin-bottom: 10px;
    }
    
    .payment-modal-header .table-name {
      font-size: 20px;
      color: #666;
    }
    
    .payment-order-list {
      margin-bottom: 25px;
    }
    
    .payment-order-item {
      background: #f5f5f5;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
    }
    
    .payment-order-item .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #ddd;
    }
    
    .payment-order-item .order-id {
      font-weight: bold;
      color: #667eea;
    }
    
    .payment-order-item .order-status {
      padding: 5px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .payment-order-item .order-status.completed {
      background: #4CAF50;
      color: white;
    }
    
    .payment-order-item .order-status.cooking {
      background: #FF9800;
      color: white;
    }
    
    .payment-order-item .order-status.pending {
      background: #9E9E9E;
      color: white;
    }
    
    .payment-order-item .order-items {
      margin-bottom: 10px;
    }
    
    .payment-order-item .item-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      color: #333;
    }
    
    .payment-order-item .item-name {
      flex: 1;
    }
    
    .payment-order-item .item-price {
      font-weight: bold;
      color: #4CAF50;
    }
    
    .payment-order-item .order-total {
      text-align: right;
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
      padding-top: 10px;
      border-top: 2px solid #ddd;
    }
    
    .payment-total-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      margin-bottom: 25px;
    }
    
    .payment-total-section .total-label {
      color: white;
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .payment-total-section .total-amount {
      color: white;
      font-size: 36px;
      font-weight: bold;
    }
    
    .payment-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 15px;
    }
    
    .payment-action-btn {
      padding: 15px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .payment-action-btn:active {
      transform: scale(0.95);
    }
    
    .payment-action-btn.btn-complete {
      background: #4CAF50;
      color: white;
      grid-column: 1 / -1;
    }
    
    .payment-action-btn.btn-accounting-complete {
      background: #2196F3;
      color: white;
      grid-column: 1 / -1;
    }
    
    .payment-action-btn.btn-edit {
      background: #FF9800;
      color: white;
    }
    
    .payment-action-btn.btn-discount {
      background: #9C27B0;
      color: white;
    }
    
    .payment-action-btn.btn-cancel {
      background: #607D8B;
      color: white;
    }
    
    .payment-action-btn.btn-delete {
      background: #f44336;
      color: white;
    }
    
    .payment-close-btn {
      width: 100%;
      padding: 15px;
      background: #e0e0e0;
      color: #666;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .payment-close-btn:active {
      transform: scale(0.98);
    }
    
    /* é‡‘é¡ä¿®æ­£ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .amount-edit-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
      z-index: 1001;
      overflow-y: auto;
    }
    
    .amount-edit-modal-content {
      max-width: 500px;
      margin: 20px auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .amount-edit-modal h3 {
      color: #667eea;
      text-align: center;
      margin-bottom: 25px;
      font-size: 24px;
    }
    
    .amount-edit-list {
      margin-bottom: 25px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .amount-edit-total {
      background: #f5f5f5;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .amount-edit-total .total-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .amount-edit-total .total-row:last-child {
      margin-bottom: 0;
      padding-top: 10px;
      border-top: 2px solid #ddd;
      font-weight: bold;
      color: #667eea;
    }
    
    .amount-edit-buttons {
      display: flex;
      gap: 12px;
    }
    
    .amount-edit-buttons button {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .amount-edit-buttons .btn-apply {
      background: #4CAF50;
      color: white;
    }
    
    .amount-edit-buttons .btn-cancel {
      background: #e0e0e0;
      color: #666;
    }
    
    /* å€¤å¼•ããƒ¢ãƒ¼ãƒ€ãƒ« */
    .discount-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
      z-index: 1001;
      justify-content: center;
      align-items: center;
    }
    
    .discount-modal-content {
      max-width: 450px;
      width: 90%;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .discount-modal h3 {
      color: #667eea;
      text-align: center;
      margin-bottom: 25px;
      font-size: 24px;
    }
    
    .discount-input-group {
      margin-bottom: 20px;
    }
    
    .discount-input-group label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: bold;
    }
    
    .discount-input-group input {
      width: 100%;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 12px;
      font-size: 20px;
      font-weight: bold;
      text-align: right;
    }
    
    .discount-input-group input:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .discount-summary {
      background: #f5f5f5;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .discount-summary .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .discount-summary .summary-row:last-child {
      margin-bottom: 0;
      padding-top: 10px;
      border-top: 2px solid #ddd;
      font-weight: bold;
      color: #667eea;
      font-size: 18px;
    }
    
    .discount-buttons {
      display: flex;
      gap: 12px;
    }
    
    .discount-buttons button {
      flex: 1;
      padding: 15px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    
    .discount-buttons .btn-apply {
      background: #9C27B0;
      color: white;
    }
    
    .discount-buttons .btn-cancel {
      background: #e0e0e0;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
    <div class="login-screen" id="loginScreen">
      <h1>ğŸ½ ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ </h1>
      <div class="form-group">
        <label for="storeSelect">åº—èˆ—ã‚’é¸æŠ</label>
        <select id="storeSelect">
          <option value="">åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
      <div id="loginError" class="error-message hidden"></div>
      <button class="login-btn" onclick="login()">ãƒ­ã‚°ã‚¤ãƒ³</button>
    </div>

    <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ç”»é¢ -->
    <div class="tables-screen" id="tablesScreen">
      <div class="header">
        <h2>ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§</h2>
        
        <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ -->
        <div class="mode-toggle">
          <button class="mode-btn active" id="orderModeBtn" onclick="switchMode('order')">
            ğŸ“ æ³¨æ–‡ãƒ¢ãƒ¼ãƒ‰
          </button>
          <button class="mode-btn" id="paymentModeBtn" onclick="switchMode('payment')">
            ğŸ’° ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰
          </button>
        </div>
        
        <div class="store-info" id="storeInfo"></div>
        <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
      
      <div class="tables-grid" id="tablesGrid"></div>
    </div>
    
    <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° -->
    <div class="loading hidden" id="loading">
      èª­ã¿è¾¼ã¿ä¸­...
    </div>
  </div>

  <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="custom-modal-overlay" id="customModalOverlay">
    <div class="custom-modal">
      <div class="modal-icon" id="modalIcon">â„¹ï¸</div>
      <div class="modal-title" id="modalTitle">ç¢ºèª</div>
      <div class="modal-message" id="modalMessage">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
      <div class="modal-buttons" id="modalButtons">
        <button class="modal-btn modal-btn-cancel" onclick="closeCustomModal(false)">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-confirm" onclick="closeCustomModal(true)">OK</button>
      </div>
    </div>
  </div>

  <!-- ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="payment-modal" id="paymentModal">
    <div class="payment-modal-content">
      <div class="payment-modal-header">
        <h2>ğŸ’° ä¼šè¨ˆ</h2>
        <div class="table-name" id="paymentTableName"></div>
      </div>
      
      <div class="payment-order-list" id="paymentOrderList"></div>
      
      <div class="payment-total-section">
        <div class="total-label">åˆè¨ˆé‡‘é¡</div>
        <div class="total-amount" id="paymentTotalAmount">Â¥0</div>
      </div>
      
      <div class="payment-actions">
        <button class="payment-action-btn btn-complete" onclick="completePayment()">
          âœ… å®Œäº†
        </button>
        <button class="payment-action-btn btn-accounting-complete" onclick="accountingComplete()">
          ğŸ’³ ä¼šè¨ˆå®Œäº†
        </button>
        <button class="payment-action-btn btn-edit" onclick="openAmountEditModal()">
          âœï¸ é‡‘é¡ä¿®æ­£
        </button>
        <button class="payment-action-btn btn-discount" onclick="openDiscountModal()">
          ğŸ« å€¤å¼•ã
        </button>
        <button class="payment-action-btn btn-cancel" onclick="cancelOrder()">
          â¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button class="payment-action-btn btn-delete" onclick="deleteOrder()">
          ğŸ—‘ å‰Šé™¤
        </button>
      </div>
      
      <button class="payment-close-btn" onclick="closePaymentModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- é‡‘é¡ä¿®æ­£ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="amount-edit-modal" id="amountEditModal">
    <div class="amount-edit-modal-content">
      <h3>âœï¸ é‡‘é¡ä¿®æ­£</h3>
      
      <div class="amount-edit-list" id="amountEditList"></div>
      
      <div class="amount-edit-total">
        <div class="total-row">
          <span>å…ƒã®åˆè¨ˆ:</span>
          <span id="editOriginalTotal">Â¥0</span>
        </div>
        <div class="total-row">
          <span>ä¿®æ­£å¾Œã®åˆè¨ˆ:</span>
          <span id="editNewTotal">Â¥0</span>
        </div>
      </div>
      
      <div class="amount-edit-buttons">
        <button class="btn-cancel" onclick="closeAmountEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-apply" onclick="applyAmountEdit()">é©ç”¨</button>
      </div>
    </div>
  </div>

  <!-- å€¤å¼•ããƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="discount-modal" id="discountModal">
    <div class="discount-modal-content">
      <h3>ğŸ« å€¤å¼•ã</h3>
      
      <div class="discount-input-group">
        <label>å€¤å¼•ãé‡‘é¡</label>
        <input type="number" id="discountAmount" placeholder="0" oninput="calculateDiscountTotal()">
      </div>
      
      <div class="discount-summary">
        <div class="summary-row">
          <span>ç¾åœ¨ã®åˆè¨ˆ:</span>
          <span id="discountCurrentTotal">Â¥0</span>
        </div>
        <div class="summary-row">
          <span>å€¤å¼•ãå¾Œ:</span>
          <span id="discountNewTotal">Â¥0</span>
        </div>
      </div>
      
      <div class="discount-buttons">
        <button class="btn-cancel" onclick="closeDiscountModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-apply" onclick="applyDiscount()">é©ç”¨</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDKã®èª­ã¿è¾¼ã¿ -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, query, where, orderBy, Timestamp, onSnapshot } from 'https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDQwxINW26jNUQ62NHU5Q1MiCSWqkX_03s",
      authDomain: "nagoyameshi-a56f3.firebaseapp.com",
      projectId: "nagoyameshi-a56f3",
      storageBucket: "nagoyameshi-a56f3.firebasestorage.app",
      messagingSenderId: "766212321212",
      appId: "1:766212321212:web:e7bb50ba42a36dcdb2f0a4",
      measurementId: "G-B83J84EFYC"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    window.db = db;
    window.collection = collection;
    window.getDocs = getDocs;
    window.doc = doc;
    window.getDoc = getDoc;
    window.updateDoc = updateDoc;
    window.query = query;
    window.where = where;
    window.orderBy = orderBy;
    window.Timestamp = Timestamp;
    window.onSnapshot = onSnapshot;
    window.firebaseReady = true;

    console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†');
  </script>

  <script>
    let currentStoreId = null;
    let currentStoreName = null;
    let storesData = {};
    let currentMode = 'order'; // 'order' or 'payment'
    let unsubscribeOrders = null;
    let currentPaymentOrders = [];
    let modalResolve = null;

    // ========== ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•° ==========
    function showCustomModal(options) {
      return new Promise((resolve) => {
        modalResolve = resolve;
        
        const overlay = document.getElementById('customModalOverlay');
        const icon = document.getElementById('modalIcon');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const buttonsContainer = document.getElementById('modalButtons');
        
        icon.textContent = options.icon || 'â„¹ï¸';
        title.textContent = options.title || 'ç¢ºèª';
        message.textContent = options.message || '';
        
        buttonsContainer.innerHTML = '';
        
        if (options.confirmOnly) {
          const btn = document.createElement('button');
          btn.className = `modal-btn ${options.btnClass || 'modal-btn-single'}`;
          btn.textContent = options.btnText || 'OK';
          btn.onclick = () => closeCustomModal(true);
          buttonsContainer.appendChild(btn);
        } else {
          const cancelBtn = document.createElement('button');
          cancelBtn.className = 'modal-btn modal-btn-cancel';
          cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
          cancelBtn.onclick = () => closeCustomModal(false);
          buttonsContainer.appendChild(cancelBtn);
          
          const confirmBtn = document.createElement('button');
          confirmBtn.className = `modal-btn ${options.btnClass || 'modal-btn-confirm'}`;
          confirmBtn.textContent = options.btnText || 'OK';
          confirmBtn.onclick = () => closeCustomModal(true);
          buttonsContainer.appendChild(confirmBtn);
        }
        
        overlay.style.display = 'flex';
      });
    }
    
    function closeCustomModal(result) {
      document.getElementById('customModalOverlay').style.display = 'none';
      if (modalResolve) {
        modalResolve(result);
        modalResolve = null;
      }
    }

    // ========== åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ ==========
    async function loadStoreList() {
      try {
        const storesRef = window.collection(window.db, 'stores');
        const snapshot = await window.getDocs(storesRef);
        
        const storeSelect = document.getElementById('storeSelect');
        storeSelect.innerHTML = '<option value="">åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
        
        snapshot.forEach(doc => {
          const data = doc.data();
          storesData[doc.id] = data;
          
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = data.name || doc.id;
          storeSelect.appendChild(option);
        });
        
        console.log('âœ… åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å®Œäº†:', snapshot.size, 'ä»¶');
      } catch (error) {
        console.error('âŒ åº—èˆ—ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'åº—èˆ—ãƒªã‚¹ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ',
          confirmOnly: true,
          btnClass: 'modal-btn-danger'
        });
      }
    }

    // ========== ãƒ­ã‚°ã‚¤ãƒ³ ==========
    async function login() {
      const storeSelect = document.getElementById('storeSelect');
      const storeId = storeSelect.value;
      
      if (!storeId) {
        await showCustomModal({
          icon: 'âš ï¸',
          title: 'æœªé¸æŠ',
          message: 'åº—èˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„',
          confirmOnly: true,
          btnClass: 'modal-btn-danger'
        });
        return;
      }
      
      currentStoreId = storeId;
      currentStoreName = storesData[storeId].name;
      
      sessionStorage.setItem('handyStoreId', storeId);
      sessionStorage.setItem('handyStoreName', currentStoreName);
      
      console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³:', currentStoreName);
      showTablesScreen();
    }

    // ========== ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ ==========
    async function logout() {
      const confirmed = await showCustomModal({
        icon: 'ğŸ‘‹',
        title: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
        message: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹?',
        btnText: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
        btnClass: 'modal-btn-danger'
      });
      
      if (!confirmed) return;
      
      if (unsubscribeOrders) {
        unsubscribeOrders();
        unsubscribeOrders = null;
      }
      
      sessionStorage.removeItem('handyStoreId');
      sessionStorage.removeItem('handyStoreName');
      
      currentStoreId = null;
      currentStoreName = null;
      
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('tablesScreen').style.display = 'none';
      
      console.log('âœ… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†');
    }

    // ========== ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ ==========
    function switchMode(mode) {
      currentMode = mode;
      
      document.getElementById('orderModeBtn').classList.toggle('active', mode === 'order');
      document.getElementById('paymentModeBtn').classList.toggle('active', mode === 'payment');
      
      console.log('ğŸ”„ ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ:', mode);
    }

    // ========== ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§è¡¨ç¤º ==========
    async function showTablesScreen() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('tablesScreen').style.display = 'block';
      document.getElementById('storeInfo').textContent = `åº—èˆ—: ${currentStoreName}`;
      
      await loadTables();
      
      if (unsubscribeOrders) {
        unsubscribeOrders();
      }
      
      const ordersRef = window.collection(window.db, 'stores', currentStoreId, 'orders');
      const q = window.query(ordersRef, window.where('deleted', '!=', true));
      
      unsubscribeOrders = window.onSnapshot(q, (snapshot) => {
        console.log('ğŸ“¡ æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿æ›´æ–°:', snapshot.size, 'ä»¶');
        loadTables();
      });
    }

    // ========== ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿ ==========
    async function loadTables() {
      try {
        const tablesRef = window.collection(window.db, 'stores', currentStoreId, 'tables');
        const snapshot = await window.getDocs(tablesRef);
        
        const ordersRef = window.collection(window.db, 'stores', currentStoreId, 'orders');
        const ordersQuery = window.query(
          ordersRef,
          window.where('deleted', '!=', true)
        );
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        const ordersByTable = {};
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          const tableId = data.tableId;
          
          if (!ordersByTable[tableId]) {
            ordersByTable[tableId] = [];
          }
          ordersByTable[tableId].push({ id: doc.id, ...data });
        });
        
        const grid = document.getElementById('tablesGrid');
        grid.innerHTML = '';
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const tableOrders = ordersByTable[doc.id] || [];
          
          const card = document.createElement('div');
          card.className = 'table-card';
          
          if (currentMode === 'order') {
            card.onclick = () => openTable(doc.id, data.name);
            
            card.innerHTML = `
              <div class="table-name">${data.name}</div>
              <div class="table-status">
                ${tableOrders.length > 0 ? `æ³¨æ–‡: ${tableOrders.length}ä»¶` : 'ç©ºå¸­'}
              </div>
            `;
          } else {
            card.classList.add('payment-mode');
            
            const activeOrders = tableOrders.filter(order => 
              !order.paidAt && !order.cancelledAt
            );
            
            const hasIncomplete = activeOrders.some(order => 
              !order.completedAt
            );
            
            const allPaid = tableOrders.length > 0 && 
              tableOrders.every(order => order.paidAt);
            
            if (hasIncomplete) {
              card.classList.add('has-incomplete-orders');
              card.innerHTML = `
                <span class="status-badge incomplete">æœªå®Œäº†</span>
                <div class="table-name">${data.name}</div>
                <div class="no-orders">æœªå®Œäº†ã®æ³¨æ–‡ãŒã‚ã‚Šã¾ã™</div>
              `;
            } else if (activeOrders.length > 0) {
              card.classList.add('has-orders');
              
              const totalAmount = activeOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
              
              card.innerHTML = `
                <div class="table-name">${data.name}</div>
                <div class="order-info">
                  æ³¨æ–‡æ•°: ${activeOrders.length}ä»¶
                </div>
                <div class="order-total">Â¥${totalAmount.toLocaleString()}</div>
                <button class="payment-btn" onclick="openPaymentModal('${doc.id}', '${data.name}')">
                  ä¼šè¨ˆã™ã‚‹
                </button>
              `;
            } else if (allPaid) {
              card.classList.add('all-paid');
              card.innerHTML = `
                <span class="status-badge paid">ä¼šè¨ˆæ¸ˆ</span>
                <div class="table-name">${data.name}</div>
                <div class="no-orders">ä¼šè¨ˆæ¸ˆã¿</div>
              `;
            } else {
              card.innerHTML = `
                <div class="table-name">${data.name}</div>
                <div class="no-orders">æ³¨æ–‡ãªã—</div>
              `;
            }
          }
          
          grid.appendChild(card);
        });
        
        console.log('âœ… ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿å®Œäº†:', snapshot.size, 'ä»¶');
      } catch (error) {
        console.error('âŒ ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'ãƒ†ãƒ¼ãƒ–ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ',
          confirmOnly: true,
          btnClass: 'modal-btn-danger'
        });
      }
    }

    // ========== ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é–‹ãï¼ˆæ³¨æ–‡ãƒ¢ãƒ¼ãƒ‰ï¼‰ ==========
    function openTable(tableId, tableName) {
      if (currentMode !== 'order') return;
      
      const url = `order.html?storeId=${currentStoreId}&storeName=${encodeURIComponent(currentStoreName)}&tableId=${tableId}&tableName=${encodeURIComponent(tableName)}`;
      window.location.href = url;
    }

    // ========== ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã ==========
    async function openPaymentModal(tableId, tableName) {
      try {
        const ordersRef = window.collection(window.db, 'stores', currentStoreId, 'orders');
        const q = window.query(
          ordersRef,
          window.where('tableId', '==', tableId),
          window.where('deleted', '!=', true)
        );
        const snapshot = await window.getDocs(q);
        
        const orders = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          if (!data.paidAt && !data.cancelledAt) {
            orders.push({ id: doc.id, ...data });
          }
        });
        
        if (orders.length === 0) {
          await showCustomModal({
            icon: 'âš ï¸',
            title: 'æ³¨æ–‡ãªã—',
            message: 'ä¼šè¨ˆå¯èƒ½ãªæ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“',
            confirmOnly: true,
            btnClass: 'modal-btn-danger'
          });
          return;
        }
        
        const hasIncomplete = orders.some(order => !order.completedAt);
        if (hasIncomplete) {
          await showCustomModal({
            icon: 'âš ï¸',
            title: 'æœªå®Œäº†ã®æ³¨æ–‡',
            message: 'æœªå®Œäº†ã®æ³¨æ–‡ãŒã‚ã‚Šã¾ã™ã€‚\nå®Œäº†ã—ã¦ã‹ã‚‰ä¼šè¨ˆã—ã¦ãã ã•ã„ã€‚',
            confirmOnly: true,
            btnClass: 'modal-btn-danger'
          });
          return;
        }
        
        currentPaymentOrders = orders;
        
        document.getElementById('paymentTableName').textContent = tableName;
        
        const orderList = document.getElementById('paymentOrderList');
        orderList.innerHTML = '';
        
        let totalAmount = 0;
        
        orders.forEach(order => {
          totalAmount += order.totalAmount || 0;
          
          const orderDiv = document.createElement('div');
          orderDiv.className = 'payment-order-item';
          
          let statusClass = 'pending';
          let statusText = 'ä¿ç•™ä¸­';
          if (order.completedAt) {
            statusClass = 'completed';
            statusText = 'å®Œäº†';
          } else if (order.cookingStartedAt) {
            statusClass = 'cooking';
            statusText = 'èª¿ç†ä¸­';
          }
          
          let itemsHtml = '';
          order.items.forEach(item => {
            const itemTotal = item.price * item.quantity;
            itemsHtml += `
              <div class="item-row">
                <div class="item-name">${item.name} x ${item.quantity}</div>
                <div class="item-price">Â¥${itemTotal.toLocaleString()}</div>
              </div>
            `;
          });
          
          orderDiv.innerHTML = `
            <div class="order-header">
              <div class="order-id">æ³¨æ–‡ #${order.id.slice(-6)}</div>
              <div class="order-status ${statusClass}">${statusText}</div>
            </div>
            <div class="order-items">${itemsHtml}</div>
            <div class="order-total">å°è¨ˆ: Â¥${(order.totalAmount || 0).toLocaleString()}</div>
          `;
          
          orderList.appendChild(orderDiv);
        });
        
        document.getElementById('paymentTotalAmount').textContent = 'Â¥' + totalAmount.toLocaleString();
        document.getElementById('paymentModal').style.display = 'block';
        
        console.log('âœ… ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º:', orders.length, 'ä»¶');
      } catch (error) {
        console.error('âŒ ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'ä¼šè¨ˆæƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ',
          confirmOnly: true,
          btnClass: 'modal-btn-danger'
        });
      }
    }

    function closePaymentModal() {
      document.getElementById('paymentModal').style.display = 'none';
      currentPaymentOrders = [];
    }

    // ========== å®Œäº†å‡¦ç† ==========
    async function completePayment() {
      const confirmed = await showCustomModal({
        icon: 'âœ…',
        title: 'å®Œäº†ç¢ºèª',
        message: 'ã“ã®æ³¨æ–‡ã‚’å®Œäº†ã«ã—ã¾ã™ã‹ï¼Ÿ',
        btnText: 'å®Œäº†',
        btnClass: 'modal-btn-success'
      });
      
      if (!confirmed) return;
      
      try {
        const now = window.Timestamp.now();
        
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          await window.updateDoc(orderRef, {
            completedAt: now
          });
        }
        
        console.log('âœ… æ³¨æ–‡å®Œäº†:', currentPaymentOrders.length, 'ä»¶');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'å®Œäº†',
          message: 'æ³¨æ–‡ã‚’å®Œäº†ã—ã¾ã—ãŸ',
          confirmOnly: true,
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ å®Œäº†ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'å®Œäº†å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
          confirmOnly: true,
          btnClass: 'modal-btn-danger'
        });
      }
    }

    // ========== ä¼šè¨ˆå®Œäº†å‡¦ç† ==========
    async function accountingComplete() {
      const confirmed = await showCustomModal({
        icon: 'ğŸ’³',
        title: 'ä¼šè¨ˆå®Œäº†ç¢ºèª',
        message: 'ä¼šè¨ˆã‚’å®Œäº†ã—ã¾ã™ã‹ï¼Ÿ',
        btnText: 'ä¼šè¨ˆå®Œäº†',
        btnClass: 'modal-btn-success'
      });
      
      if (!confirmed) return;
      
      try {
        const now = window.Timestamp.now();
        
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          await window.updateDoc(orderRef, {
            paidAt: now,
            completedAt: order.completedAt || now
          });
        }
        
        console.log('âœ… ä¼šè¨ˆå®Œäº†:', currentPaymentOrders.length, 'ä»¶');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'ä¼šè¨ˆå®Œäº†',
          message: 'ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸ',
          confirmOnly: true,
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ ä¼šè¨ˆå®Œäº†ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'ä¼šè¨ˆå®Œäº†å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
          confirmOnly: true,
          btnClass: 'modal-btn-danger'
        });
      }
    }

    // ========== é‡‘é¡ä¿®æ­£ãƒ¢ãƒ¼ãƒ€ãƒ« ==========
    function openAmountEditModal() {
      const list = document.getElementById('amountEditList');
      list.innerHTML = '';
      
      let originalTotal = 0;
      
      currentPaymentOrders.forEach(order => {
        order.items.forEach((item, index) => {
          originalTotal += item.price * item.quantity;
          
          const itemDiv = document.createElement('div');
          itemDiv.style.cssText = 'padding: 15px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px;';
          itemDiv.innerHTML = `
            <div style="font-weight: bold; margin-bottom: 10px;">${item.name} x ${item.quantity}</div>
            <div style="display: flex; gap: 10px; align-items: center;">
              <label style="flex-shrink: 0;">å˜ä¾¡:</label>
              <input type="number" 
                id="editPrice_${order.id}_${index}" 
                value="${item.price}" 
                style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; font-weight: bold;"
                oninput="updateEditTotal()">
            </div>
          `;
          list.appendChild(itemDiv);
        });
      });
      
      document.getElementById('editOriginalTotal').textContent = 'Â¥' + originalTotal.toLocaleString();
      document.getElementById('editNewTotal').textContent = 'Â¥' + originalTotal.toLocaleString();
      document.getElementById('amountEditModal').style.display = 'block';
    }

    function closeAmountEditModal() {
      document.getElementById('amountEditModal').style.display = 'none';
    }

    function updateEditTotal() {
      let newTotal = 0;
      
      currentPaymentOrders.forEach(order => {
        order.items.forEach((item, index) => {
          const input = document.getElementById(`editPrice_${order.id}_${index}`);
          const price = parseInt(input.value) || 0;
          newTotal += price * item.quantity;
        });
      });
      
      document.getElementById('editNewTotal').textContent = 'Â¥' + newTotal.toLocaleString();
    }

    async function applyAmountEdit() {
      const confirmed = await showCustomModal({
        icon: 'ğŸ’´',
        title: 'é‡‘é¡ä¿®æ­£',
        message: 'ä¿®æ­£ã—ãŸé‡‘é¡ã‚’é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ',
        btnText: 'é©ç”¨',
        btnClass: 'modal-btn-success'
      });
      
      if (!confirmed) return;
      
      try {
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          const updatedItems = order.items.map((item, index) => {
            const input = document.getElementById(`editPrice_${order.id}_${index}`);
            const newPrice = parseInt(input.value) || item.price;
            return {
              ...item,
              price: newPrice
            };
          });
          
          const newTotal = updatedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
          
          await window.updateDoc(orderRef, {
            items: updatedItems,
            totalAmount: newTotal
          });
          
          order.items = updatedItems;
          order.totalAmount = newTotal;
        }
        
        closeAmountEditModal();
        
        const newTotalAmount = currentPaymentOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
        document.getElementById('paymentTotalAmount').textContent = 'Â¥' + newTotalAmount.toLocaleString();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'é‡‘é¡ä¿®æ­£å®Œäº†',
          message: 'é‡‘é¡ã‚’ä¿®æ­£ã—ã¾ã—ãŸ',
          confirmOnly: true,
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ é‡‘é¡ä¿®æ­£ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'é‡‘é¡ä¿®æ­£ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
          confirmOnly: true,
          btnClass: 'modal-btn-danger'
        });
      }
    }

    // ========== å€¤å¼•ããƒ¢ãƒ¼ãƒ€ãƒ« ==========
    function openDiscountModal() {
      const currentTotal = currentPaymentOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      
      document.getElementById('discountCurrentTotal').textContent = 'Â¥' + currentTotal.toLocaleString();
      document.getElementById('discountNewTotal').textContent = 'Â¥' + currentTotal.toLocaleString();
      document.getElementById('discountAmount').value = '';
      document.getElementById('discountModal').style.display = 'flex';
    }

    function closeDiscountModal() {
      document.getElementById('discountModal').style.display = 'none';
    }

    function calculateDiscountTotal() {
      const currentTotal = currentPaymentOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      const discount = parseInt(document.getElementById('discountAmount').value) || 0;
      const newTotal = Math.max(0, currentTotal - discount);
      
      document.getElementById('discountNewTotal').textContent = 'Â¥' + newTotal.toLocaleString();
    }

    async function applyDiscount() {
      const discount = parseInt(document.getElementById('discountAmount').value) || 0;
      
      if (discount <= 0) {
        await showCustomModal({
          icon: 'âš ï¸',
          title: 'å…¥åŠ›ã‚¨ãƒ©ãƒ¼',
          message: 'å€¤å¼•ãé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„',
          confirmOnly: true,
          btnClass: 'modal-btn-danger'
        });
        return;
      }
      
      const currentTotal = currentPaymentOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
      const newTotal = Math.max(0, currentTotal - discount);
      
      const confirmed = await showCustomModal({
        icon: 'ğŸ«',
        title: 'å€¤å¼•ãé©ç”¨',
        message: `å€¤å¼•ãé‡‘é¡: Â¥${discount.toLocaleString()}\nå€¤å¼•ãå¾Œ: Â¥${newTotal.toLocaleString()}\n\nå€¤å¼•ãã‚’é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ`,
        btnText: 'é©ç”¨',
        btnClass: 'modal-btn-success'
      });
      
      if (!confirmed) return;
      
      try {
        const firstOrder = currentPaymentOrders[0];
        const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', firstOrder.id);
        
        const discountedTotal = Math.max(0, firstOrder.totalAmount - discount);
        
        await window.updateDoc(orderRef, {
          totalAmount: discountedTotal,
          discount: discount,
          originalAmount: firstOrder.totalAmount
        });
        
        firstOrder.totalAmount = discountedTotal;
        
        closeDiscountModal();
        
        const updatedTotal = currentPaymentOrders.reduce((sum, order) => sum + (order.totalAmount || 0), 0);
        document.getElementById('paymentTotalAmount').textContent = 'Â¥' + updatedTotal.toLocaleString();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'å€¤å¼•ãå®Œäº†',
          message: `Â¥${discount.toLocaleString()} ã®å€¤å¼•ãã‚’é©ç”¨ã—ã¾ã—ãŸ`,
          confirmOnly: true,
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ å€¤å¼•ãã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'å€¤å¼•ãå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
          confirmOnly: true,
          btnClass: 'modal-btn-danger'
        });
      }
    }

    // ========== ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç† ==========
    async function cancelOrder() {
      const confirmed = await showCustomModal({
        icon: 'â¸',
        title: 'æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
        message: 'ã“ã®æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ',
        btnText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«',
        btnClass: 'modal-btn-danger'
      });
      
      if (!confirmed) return;
      
      try {
        const now = window.Timestamp.now();
        
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          await window.updateDoc(orderRef, {
            cancelledAt: now
          });
        }
        
        console.log('âœ… æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«:', currentPaymentOrders.length, 'ä»¶');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å®Œäº†',
          message: 'æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ',
          confirmOnly: true,
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
          confirmOnly: true,
          btnClass: 'modal-btn-danger'
        });
      }
    }

    // ========== å‰Šé™¤å‡¦ç† ==========
    async function deleteOrder() {
      const confirmed = await showCustomModal({
        icon: 'ğŸ—‘',
        title: 'æ³¨æ–‡å‰Šé™¤',
        message: 'ã“ã®æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ï¼‰',
        btnText: 'å‰Šé™¤',
        btnClass: 'modal-btn-danger'
      });
      
      if (!confirmed) return;
      
      try {
        for (const order of currentPaymentOrders) {
          const orderRef = window.doc(window.db, 'stores', currentStoreId, 'orders', order.id);
          
          await window.updateDoc(orderRef, {
            deleted: true,
            deletedAt: window.Timestamp.now()
          });
        }
        
        console.log('âœ… æ³¨æ–‡å‰Šé™¤:', currentPaymentOrders.length, 'ä»¶');
        
        closePaymentModal();
        
        await showCustomModal({
          icon: 'âœ…',
          title: 'å‰Šé™¤å®Œäº†',
          message: 'æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ',
          confirmOnly: true,
          btnText: 'OK',
          btnClass: 'modal-btn-success'
        });
        
      } catch (error) {
        console.error('âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomModal({
          icon: 'âŒ',
          title: 'ã‚¨ãƒ©ãƒ¼',
          message: 'å‰Šé™¤å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
          confirmOnly: true,
          btnClass: 'modal-btn-danger'
        });
      }
    }

    // ========== ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ ==========
    window.addEventListener('DOMContentLoaded', async () => {
      console.log('ğŸ“± ãƒãƒ³ãƒ‡ã‚£ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•');
      
      while (!window.firebaseReady || !window.db) {
        await new Promise(resolve => setTimeout(resolve, 100));
      }
      
      console.log('âœ… Firebaseæº–å‚™å®Œäº†ã€åº—èˆ—ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿ã¾ã™');
      
      await loadStoreList();
      
      const savedStoreId = sessionStorage.getItem('handyStoreId');
      const savedStoreName = sessionStorage.getItem('handyStoreName');
      
      if (savedStoreId && savedStoreName && storesData[savedStoreId]) {
        currentStoreId = savedStoreId;
        currentStoreName = savedStoreName;
        
        console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å¾©å…ƒ:', currentStoreName);
        showTablesScreen();
      }
    });
  </script>
</body>
</html>
