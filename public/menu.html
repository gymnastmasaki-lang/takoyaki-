<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="robots" content="noindex, nofollow">
  <title>ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—</title>
  
  <script>
    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      const tableNumber = urlParams.get('table');
      const orderId = urlParams.get('orderId');
      const fromIndex = urlParams.get('fromIndex');
      
      console.log('=== ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯ ===');
      console.log('tableNumber:', tableNumber);
      console.log('orderId:', orderId);
      console.log('fromIndex:', fromIndex);
      
      if (fromIndex) {
        const newUrl = new URL(window.location);
        newUrl.searchParams.delete('fromIndex');
        window.history.replaceState({}, '', newUrl);
        console.log('â†’ fromIndexãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      }
      
      if (tableNumber && !orderId && !fromIndex) {
        console.log('â†’ index.html?table=' + tableNumber + ' ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ');
        window.location.href = 'index.html?table=' + tableNumber;
      } else {
        console.log('â†’ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ãªã„(ã“ã®ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º)');
      }
    })();
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      min-height: 100vh;
      padding: 0;
      margin: 0;
      max-width: 100vw;
      overflow-x: hidden;
    }
    
    .header {
      background: #FFFF80;
      color: #000;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 0;
      font-weight: bold;
      color: #000;
    }
    
    .container {
      max-width: 100%;
      margin: 0;
      padding: 10px;
      min-height: calc(100vh - 80px);
    }
    
    @media (min-width: 420px) {
      .container {
        max-width: 420px;
        margin: 0 auto;
        padding: 15px;
      }
    }
    
    .category-filter {
      background: white;
      padding: 15px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .category-filter label {
      display: block;
      font-size: 18px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    
    select {
      width: 100%;
      padding: 20px;
      font-size: 22px;
      border: 3px solid #4CAF50;
      border-radius: 12px;
      background: white;
      color: #333;
      font-weight: 500;
    }
    
    .menu-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-bottom: 100px;
    }
    
    @media (min-width: 420px) {
      .menu-grid {
        gap: 15px;
      }
    }
    
    .menu-item {
      background: white;
      border-radius: 15px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: row;
      align-items: center;
      text-align: left;
      gap: 15px;
      position: relative;
    }
    
    .menu-item.sold-out {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f5f5f5;
    }
    
    .menu-item.sold-out::after {
      content: 'å“åˆ‡ã‚Œ';
      position: absolute;
      top: 10px;
      right: 10px;
      background: #f44336;
      color: white;
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(244, 67, 54, 0.4);
    }
    
    .menu-item:active {
      transform: scale(0.95);
    }
    
    .menu-item:hover {
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
      transform: translateY(-3px);
    }
    
    .menu-item-image {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 10px;
      flex-shrink: 0;
    }
    
    .menu-item-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .menu-item-name {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
      line-height: 1.3;
    }
    
    @media (min-width: 420px) {
      .menu-item-name {
        font-size: 18px;
      }
    }
    
    .menu-item-price {
      font-size: 20px;
      color: #4CAF50;
      font-weight: bold;
    }
    
    .menu-item-note {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }
    
    button {
      width: 100%;
      padding: 18px;
      font-size: 20px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      margin: 8px 0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .topping-list {
      display: grid;
      gap: 12px;
      margin: 20px 0;
    }
    
    .topping-item {
      padding: 15px;
      border: 3px solid #e0e0e0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      font-size: 16px;
    }
    
    .topping-item.selected {
      background: #e8f5e9;
      border-color: #4CAF50;
      font-weight: bold;
    }
    
    .topping-item:active {
      transform: scale(0.98);
    }
    
    .quantity-control {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin: 25px 0;
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .quantity-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #4CAF50;
      color: white;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
    }
    
    .quantity-btn:active {
      transform: scale(0.9);
    }
    
    .quantity-display {
      font-size: 40px;
      font-weight: bold;
      min-width: 80px;
      text-align: center;
      color: #333;
    }
    
    .price-display {
      background: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      margin: 20px 0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .price-label {
      font-size: 18px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .price-amount {
      font-size: 36px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .cart-item {
      background: white;
      border-radius: 15px;
      padding: 18px;
      margin-bottom: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    
    .cart-item-delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(244, 67, 54, 0.4);
    }
    
    .cart-item-delete-btn:active {
      transform: scale(0.9);
    }
    
    .cart-item.sold-out {
      background: #ffebee;
      border: 2px solid #f44336;
    }
    
    .cart-item.sold-out::after {
      content: 'âš ï¸ å“åˆ‡ã‚Œ';
      position: absolute;
      top: 10px;
      right: 10px;
      background: #f44336;
      color: white;
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .cart-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .cart-item-name {
      font-weight: bold;
      font-size: 18px;
      color: #333;
    }
    
    .cart-item-price {
      font-size: 20px;
      color: #4CAF50;
      font-weight: bold;
    }
    
    .cart-item-details {
      font-size: 16px;
      color: #666;
      margin-top: 5px;
    }
    
    .order-complete {
      text-align: center;
      padding: 30px 20px;
    }
    
    .order-number-display {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      font-size: 80px;
      font-weight: bold;
      padding: 40px;
      border-radius: 20px;
      margin: 30px 0;
      box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
      text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
    }
    
    .waiting-info {
      font-size: 22px;
      color: #000;
      margin: 25px 0;
      font-weight: bold;
    }
    
    .waiting-info span {
      font-size: 66px;
      display: inline-block;
      color: #FF0000;
    }
    
    .warning-box {
      background: #fff3cd;
      border: 3px solid #ffc107;
      color: #856404;
      padding: 20px;
      border-radius: 15px;
      margin: 25px 0;
      font-size: 18px;
      font-weight: bold;
      line-height: 1.6;
    }
    
    .hidden { display: none; }
    
    .fixed-cart-btn {
      position: fixed;
      bottom: 80px;
      left: 20px;
      right: 20px;
      z-index: 1000;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    
    .page-title {
      font-size: 24px;
      font-weight: bold;
      color: #000;
      margin-bottom: 20px;
      text-align: center;
      font-family: 'Hiragino Maru Gothic ProN', 'Rounded Mplus 1c', sans-serif;
    }
    
    .top-waiting-info {
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .top-waiting-label {
      font-size: 16px;
      font-weight: bold;
      color: #666;
      margin-bottom: 5px;
    }
    
    .top-waiting-count {
      font-size: 32px;
      font-weight: bold;
      color: #ff6b6b;
    }
    
    .item-info-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="./head.jpg" alt="ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—" style="max-width: 100%; height: auto; display: block; margin: 0 auto;" onerror="this.style.display='none'">
  </div>

  <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ãƒšãƒ¼ã‚¸ -->
  <div id="page-menu">
    <div class="container">
      <div class="top-waiting-info">
        <div class="top-waiting-label">ãŸã ä»Šã®ãŠå¾…ã¡äººæ•°</div>
        <div class="top-waiting-count"><span id="top-waiting">-</span>çµ„</div>
      </div>
      <div class="category-filter">
        <label>ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„</label>
        <select id="category-select">
          <option value="">å…¨ã¦ã®å•†å“</option>
        </select>
      </div>
      <div class="menu-grid" id="menu-list"></div>
    </div>
    <button id="cart-btn" class="btn-primary fixed-cart-btn hidden" onclick="showCart()">ã‚«ãƒ¼ãƒˆã‚’è¦‹ã‚‹</button>
    <button class="btn-primary" style="position: fixed; bottom: 20px; left: 20px; right: 20px; z-index: 1000; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); box-shadow: 0 8px 20px rgba(0,0,0,0.3);" onclick="callStaff()">ğŸ“ å‘¼å‡º</button>
  </div>

  <!-- ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠãƒšãƒ¼ã‚¸ -->
  <div id="page-topping" class="hidden">
    <div class="container">
      <div class="page-title">ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’é¸æŠ</div>
      <div class="item-info-card" id="item-info"></div>
      <div class="topping-list" id="topping-list"></div>
      <div class="quantity-control">
        <div class="quantity-btn" onclick="changeQty(-1)">âˆ’</div>
        <div class="quantity-display" id="qty">1</div>
        <div class="quantity-btn" onclick="changeQty(1)">+</div>
      </div>
      <div class="price-display">
        <div class="price-label">å°è¨ˆ</div>
        <div class="price-amount" id="subtotal">Â¥0</div>
      </div>
      <button class="btn-primary" onclick="addToCart()">ã‚«ãƒ¼ãƒˆã«è¿½åŠ </button>
      <button class="btn-secondary" onclick="backToMenu()">æˆ»ã‚‹</button>
    </div>
  </div>

  <!-- ã‚«ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ -->
  <div id="page-cart" class="hidden">
    <div class="container">
      <div class="page-title">ã‚«ãƒ¼ãƒˆ</div>
      <div id="cart-items"></div>
      <div class="price-display">
        <div class="price-label">åˆè¨ˆé‡‘é¡</div>
        <div class="price-amount" id="cart-total">Â¥0</div>
      </div>
      <button class="btn-primary" onclick="confirmOrder()">æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹</button>
      <button class="btn-secondary" onclick="continueShopping()">è²·ã„ç‰©ã‚’ç¶šã‘ã‚‹</button>
    </div>
  </div>

  <!-- æ³¨æ–‡å®Œäº†ãƒšãƒ¼ã‚¸ -->
  <div id="page-complete" class="hidden">
    <div class="container">
      <div class="order-complete">
        <h2 style="color: #000; font-size: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1);">âœ… ã”æ³¨æ–‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™</h2>
        <div style="background: white; padding: 15px; border-radius: 10px; margin: 20px 0;">
          <div style="font-size: 18px; color: #666; margin-bottom: 5px;">ã”åˆ©ç”¨ã‚¹ã‚¿ã‚¤ãƒ«</div>
          <div style="font-size: 28px; font-weight: bold; color: #ff6b9d;" id="eat-style">-</div>
        </div>
        
        <div class="waiting-info">ãŠå®¢æ§˜ã¯<span id="waiting">1</span>ç•ªç›®ã«<br>ãŠå¾…ã¡é ‚ã„ã¦ã¾ã™</div>
        
        <div style="color: #000; font-size: 22px; margin: 15px 0;">æ³¨æ–‡ç•ªå·</div>
        <div class="order-number-display" id="order-num">000</div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin: 20px 0;">
          <button class="btn-primary" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); box-shadow: 0 8px 20px rgba(0,0,0,0.3); padding: 15px; font-size: 18px;" onclick="callStaffFromComplete()">ğŸ“ å‘¼å‡º</button>
          <button class="btn-primary" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); box-shadow: 0 8px 20px rgba(0,0,0,0.3); padding: 15px; font-size: 18px;" onclick="requestBillFromComplete()">ğŸ’³ ãŠä¼šè¨ˆ</button>
        </div>
        
        <div style="font-size: 20px; font-weight: bold; color: #000; margin: 20px 0;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
        
        <div id="order-status" class="warning-box" style="background: linear-gradient(135deg, #a8edea 0%, #89d4cf 100%); color: #000; border-color: #89d4cf;">
          â³ ãŸã ä»Šæº–å‚™ã—ã¦ã„ã¾ã™ã€<br>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„
        </div>
        
        <div class="warning-box">
          ã“ã®ç•ªå·ã§ãŠå‘¼ã³ã—ã¾ã™ã®ã§<br>
          å•†å“ã‚’å—ã‘å–ã‚‹ã¾ã§<br>
          ã“ã®ç”»é¢ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„
        </div>
        
        <div class="warning-box" style="background: #ffebee; border-color: #ef5350; color: #c62828;">
          <strong>âš ï¸ é‡è¦ãªãŠçŸ¥ã‚‰ã›</strong><br><br>
          â€¢ å¸­ã‚’å¤–ã™éš›ã«ã¯å…ˆã«<br>ãŠä¼šè¨ˆã‚’æ¸ˆã¾ã›ã¦ãã ã•ã„<br><br>
          â€¢ ç•ªå·ã‚’ãŠå‘¼ã³ã—ã¦ã‚‚æœªä¼šè¨ˆã®ã¾ã¾å¸­ã‚’å¤–ã•ã‚Œã¾ã™ã¨æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¨ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
        </div>
        
        <div style="color: black; font-size: 22px; margin: 25px 0; font-weight: bold;">ã”æ³¨æ–‡å†…å®¹</div>
        <div id="order-items"></div>
        <div class="price-display">
          <div class="price-label">åˆè¨ˆé‡‘é¡</div>
          <div class="price-amount" id="order-total">Â¥0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, getDoc, addDoc, onSnapshot, updateDoc, deleteDoc, doc, Timestamp, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getMessaging, getToken, onMessage } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const messaging = getMessaging(app);

    let cart = [];
    let currentItem = null;
    let selectedToppings = [];
    let qty = 1;
    let allMenuItems = [];
    let soldOutIds = new Set();
    let currentOrderId = null;
    let orderStatusUnsubscribe = null;
    
    const urlParams = new URLSearchParams(window.location.search);
    const tableNumber = urlParams.get('table') || 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ';

    window.onload = async function() {
      console.log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿é–‹å§‹');
      await loadAllData();
      await updateTopWaitingCount();
      setInterval(updateTopWaitingCount, 10000);
      watchSoldOutItems();
      
      // ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
      await requestNotificationPermission();
      
      // Service Workerã‚’ç™»éŒ²ã—ã¦FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
      await setupPushNotifications();
      
      console.log('åˆæœŸåŒ–å®Œäº†');
    };

    // ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã®è¨±å¯ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
    async function requestNotificationPermission() {
      if (!('Notification' in window)) {
        console.log('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“');
        showCustomAlert('ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“');
        return;
      }
      
      console.log('ç¾åœ¨ã®é€šçŸ¥è¨±å¯çŠ¶æ…‹:', Notification.permission);
      
      if (Notification.permission === 'default') {
        const permission = await Notification.requestPermission();
        console.log('é€šçŸ¥è¨±å¯çµæœ:', permission);
        
        if (permission === 'granted') {
          console.log('âœ… ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¾ã—ãŸ');
          // ãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡
          showBrowserNotification('é€šçŸ¥è¨­å®šå®Œäº†', 'æ³¨æ–‡ã®å®Œæˆã‚’ãŠçŸ¥ã‚‰ã›ã—ã¾ã™');
        } else if (permission === 'denied') {
          console.log('âŒ ãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ');
          showCustomAlert('é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™ã€‚\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚\n\nå•†å“å®Œæˆæ™‚ã«é€šçŸ¥ãŒå±Šã‹ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
        }
      } else if (Notification.permission === 'denied') {
        console.log('âš ï¸ é€šçŸ¥ã¯æ—¢ã«æ‹’å¦ã•ã‚Œã¦ã„ã¾ã™');
        showCustomAlert('é€šçŸ¥ãŒæ‹’å¦ã•ã‚Œã¦ã„ã¾ã™ã€‚\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‹ã‚‰é€šçŸ¥ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚\n\nå•†å“å®Œæˆæ™‚ã«é€šçŸ¥ãŒå±Šãã¾ã›ã‚“ã€‚');
      } else if (Notification.permission === 'granted') {
        console.log('âœ… é€šçŸ¥ã¯æ—¢ã«è¨±å¯ã•ã‚Œã¦ã„ã¾ã™');
      }
    }

    // FCMã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆService Workerç™»éŒ²ã¨ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—ï¼‰
    async function setupPushNotifications() {
      try {
        // Service Workerã‚’ç™»éŒ²
        console.log('Service Workerã‚’ç™»éŒ²ä¸­...');
        const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
        console.log('âœ… Service Workerç™»éŒ²æˆåŠŸ:', registration);
        
        // é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        if (Notification.permission === 'granted') {
          console.log('FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ä¸­...');
          
          const currentToken = await getToken(messaging, {
            vapidKey: 'BKlT5qhF8vZ6xH3V7UwH_eY8rGJmN4oP6zQ2sK1dL9mT3wU5vX7yA9bC1dE3fG5hI7jK9lM1nO3pQ5rS7tU9vW1xY3zA5bC7dE9fG1hI3jK5lM7nO9pQ1rS3tU5vW7xY9zA1bC3dE5fG7hI9',
            serviceWorkerRegistration: registration
          });
          
          if (currentToken) {
            console.log('âœ… FCMãƒˆãƒ¼ã‚¯ãƒ³å–å¾—æˆåŠŸ:', currentToken);
            
            // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’Firestoreã«ä¿å­˜
            await saveFCMToken(currentToken);
          } else {
            console.log('ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
          }
        } else {
          console.log('é€šçŸ¥ãŒè¨±å¯ã•ã‚Œã¦ã„ãªã„ãŸã‚ã€ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã—ã¾ã›ã‚“');
        }
        
        // ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡
        onMessage(messaging, (payload) => {
          console.log('ãƒ•ã‚©ã‚¢ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡:', payload);
          
          const title = payload.notification?.title || 'é€šçŸ¥';
          const body = payload.notification?.body || '';
          
          // éŸ³å£°ã‚’å†ç”Ÿ
          if (payload.data?.type === 'completed') {
            playNotificationSound('done');
          } else if (payload.data?.type === 'cancelled') {
            playNotificationSound('cancel');
          } else {
            playNotificationSound();
          }
          
          // é€šçŸ¥ã‚’è¡¨ç¤º
          showBrowserNotification(title, body);
          
          // ã‚¢ãƒ©ãƒ¼ãƒˆã‚‚è¡¨ç¤º
          showCustomAlert(body);
        });
        
      } catch (error) {
        console.error('FCMã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’Firestoreã«ä¿å­˜
    async function saveFCMToken(token) {
      try {
        const tokenRef = doc(db, 'fcm_tokens', tableNumber);
        await setDoc(tokenRef, {
          token: token,
          tableNumber: tableNumber,
          updatedAt: Timestamp.now()
        });
        console.log('âœ… FCMãƒˆãƒ¼ã‚¯ãƒ³ã‚’Firestoreã«ä¿å­˜ã—ã¾ã—ãŸ');
      } catch (error) {
        console.error('FCMãƒˆãƒ¼ã‚¯ãƒ³ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // æ³¨æ–‡ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç›£è¦–
    function watchOrderStatus(orderId) {
      if (orderStatusUnsubscribe) {
        orderStatusUnsubscribe();
      }
      
      currentOrderId = orderId;
      const orderRef = doc(db, 'orders', orderId);
      
      orderStatusUnsubscribe = onSnapshot(orderRef, (docSnap) => {
        if (!docSnap.exists()) {
          console.log('æ³¨æ–‡ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸ');
          return;
        }
        
        const data = docSnap.data();
        updateOrderStatusDisplay(data);
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰é€šçŸ¥ã‚’è¡¨ç¤º
        if (data.completedAt && !data.notifiedComplete) {
          showBrowserNotification('ğŸ‰ å•†å“ãŒå‡ºæ¥ä¸ŠãŒã‚Šã¾ã—ãŸ!', 'ç”»é¢ã®æ³¨æ–‡ç•ªå·ã‚’åº—å“¡ã«ãŠè¦‹ã›ãã ã•ã„');
          playNotificationSound('done');
          
          // ã‚¢ãƒ©ãƒ¼ãƒˆã‚‚è¡¨ç¤º
          showCustomAlert('å•†å“ãŒå‡ºæ¥ä¸ŠãŒã‚Šã¾ã—ãŸï¼\n\næ³¨æ–‡ç•ªå· #' + data.orderNumber + '\n\nç”»é¢ã®æ³¨æ–‡ç•ªå·ã‚’åº—å“¡ã«ãŠè¦‹ã›ãã ã•ã„');
          
          // é€šçŸ¥æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ï¼ˆæ¬¡å›ã®ç›£è¦–ã§å†åº¦é€šçŸ¥ã—ãªã„ã‚ˆã†ã«ï¼‰
          updateDoc(orderRef, { notifiedComplete: true }).catch(e => console.error(e));
        }
        
        if (data.cancelledAt && !data.notifiedCancel) {
          showBrowserNotification('âŒ æ³¨æ–‡ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', 'ç•ªå·ã‚’ãŠå‘¼ã³ã—ã¾ã—ãŸãŒã”ä¸åœ¨ã§ã—ãŸã®ã§æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã›ã¦é ‚ãã¾ã—ãŸ');
          playNotificationSound('cancel');
          
          // ã‚¢ãƒ©ãƒ¼ãƒˆã‚‚è¡¨ç¤º
          showCustomAlert('æ³¨æ–‡ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ\n\næ³¨æ–‡ç•ªå· #' + data.orderNumber + '\n\nç•ªå·ã‚’ãŠå‘¼ã³ã—ã¾ã—ãŸãŒã”ä¸åœ¨ã§ã—ãŸã®ã§\næ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã›ã¦é ‚ãã¾ã—ãŸ');
          
          updateDoc(orderRef, { notifiedCancel: true }).catch(e => console.error(e));
        }
        
        if (data.paidAt && !data.notifiedPaid) {
          showBrowserNotification('ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—', 'ãŠä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸ\nå•†å“ãŒå‡ºæ¥ä¸ŠãŒã‚Šã¾ã—ãŸã‚‰ãŠå‘¼ã³ã—ã¾ã™ã®ã§ã€ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„');
          playNotificationSound(); // notification.mp3ã‚’å†ç”Ÿ
          
          updateDoc(orderRef, { notifiedPaid: true }).catch(e => console.error(e));
        }
      });
    }

    // æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®æ›´æ–°
    function updateOrderStatusDisplay(orderData) {
      const statusBox = document.getElementById('order-status');
      if (!statusBox) return;
      
      if (orderData.completedAt) {
        statusBox.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
        statusBox.style.borderColor = '#4CAF50';
        statusBox.style.color = 'white';
        statusBox.innerHTML = 'âœ… å•†å“ãŒå‡ºæ¥ä¸ŠãŒã‚Šã¾ã—ãŸ!<br>ç”»é¢ã®æ³¨æ–‡ç•ªå·ã‚’åº—å“¡ã«ãŠè¦‹ã›ãã ã•ã„';
      } else if (orderData.cancelledAt) {
        statusBox.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
        statusBox.style.borderColor = '#f44336';
        statusBox.style.color = 'white';
        statusBox.innerHTML = 'âŒ æ³¨æ–‡ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ<br>ç•ªå·ã‚’ãŠå‘¼ã³ã—ã¾ã—ãŸãŒã”ä¸åœ¨ã§ã—ãŸã®ã§<br>æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã›ã¦é ‚ãã¾ã—ãŸ';
      } else if (orderData.paidAt) {
        statusBox.style.background = 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)';
        statusBox.style.borderColor = '#2196F3';
        statusBox.style.color = 'white';
        statusBox.innerHTML = 'ğŸ’³ ãŠä¼šè¨ˆå®Œäº†<br>å•†å“ãŒå‡ºæ¥ä¸ŠãŒã‚Šã¾ã—ãŸã‚‰ãŠå‘¼ã³ã—ã¾ã™<br>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„';
      } else {
        statusBox.style.background = 'linear-gradient(135deg, #a8edea 0%, #89d4cf 100%)';
        statusBox.style.borderColor = '#89d4cf';
        statusBox.style.color = '#000';
        statusBox.innerHTML = 'â³ ãŸã ä»Šæº–å‚™ã—ã¦ã„ã¾ã™ã€<br>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„';
      }
    }

    // ãƒ–ãƒ©ã‚¦ã‚¶é€šçŸ¥ã‚’è¡¨ç¤º
    function showBrowserNotification(title, body) {
      if (Notification.permission === 'granted') {
        const notification = new Notification(title, {
          body: body,
          icon: './icon.png',
          badge: './icon.png',
          vibrate: [200, 100, 200],
          requireInteraction: true, // é€šçŸ¥ãŒè‡ªå‹•ã§æ¶ˆãˆãªã„ã‚ˆã†ã«ã™ã‚‹
          tag: 'order-notification-' + Date.now() // ä¸€æ„ã®ã‚¿ã‚°
        });
        
        // é€šçŸ¥ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        notification.onclick = function() {
          window.focus();
          notification.close();
        };
      } else {
        console.log('é€šçŸ¥ã®è¨±å¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ç¾åœ¨ã®è¨±å¯çŠ¶æ…‹:', Notification.permission);
      }
    }

    // é€šçŸ¥éŸ³ã‚’å†ç”Ÿ
    function playNotificationSound(soundType) {
      try {
        let soundFile = './notification.mp3'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        if (soundType === 'done') {
          soundFile = './done.wav';
        } else if (soundType === 'cancel') {
          soundFile = './cancel.wav';
        }
        const audio = new Audio(soundFile);
        audio.play().catch(e => console.log('éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', e));
      } catch (e) {
        console.log('éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }
    }

    function watchSoldOutItems() {
      const soldOutRef = collection(db, 'sold_out');
      
      onSnapshot(soldOutRef, (snapshot) => {
        soldOutIds.clear();
        snapshot.forEach(doc => {
          soldOutIds.add(doc.data().menuId);
        });
        
        // applyTimeBasedSoldOut(); // ğŸ”´ è‡ªå‹•å“åˆ‡ã‚Œè¨­å®šã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
        updateSoldOutDisplay();
      });
    }
    
    function updateSoldOutDisplay() {
      const menuItems = document.querySelectorAll('.menu-item');
      menuItems.forEach(item => {
        const menuId = item.dataset.menuId;
        if (soldOutIds.has(menuId)) {
          item.classList.add('sold-out');
          item.onclick = () => {
            showCustomAlert('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\nã“ã®å•†å“ã¯ç¾åœ¨å“åˆ‡ã‚Œã§ã™ã€‚');
          };
        } else {
          item.classList.remove('sold-out');
          const itemData = allMenuItems.find(i => i.id === menuId);
          if (itemData) {
            item.onclick = () => selectItem(itemData);
          }
        }
      });
    }

    async function updateTopWaitingCount() {
      try {
        const ordersSnapshot = await getDocs(collection(db, 'orders'));
        const now = new Date();
        const validOrders = new Set();
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.deleteAt && data.deleteAt.toDate() > now && !data.cancelledAt) {
            validOrders.add(data.orderNumber);
          }
        });
        
        const settingsSnapshot = await getDocs(collection(db, 'settings'));
        let manualCount = 0;
        settingsSnapshot.forEach(doc => {
          if (doc.id === 'waiting') {
            manualCount = doc.data().manualCount || 0;
          }
        });
        
        const totalWaiting = 1 + validOrders.size + manualCount;
        const waitingElem = document.getElementById('top-waiting');
        if (waitingElem) {
          waitingElem.textContent = totalWaiting;
        }
        console.log('å¾…ã¡äººæ•°æ›´æ–°:', totalWaiting);
      } catch (e) {
        console.error('å¾…ã¡äººæ•°å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    async function loadAllData() {
      try {
        console.log('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
        const menuSnapshot = await getDocs(collection(db, 'menu'));
        const isEatIn = tableNumber !== 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ';
        
        console.log('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ æ•°:', menuSnapshot.size);

        const categoryInfo = new Map();

        menuSnapshot.forEach(doc => {
          const data = doc.data();
          if (!data || !data.category || !data.id) return;

          const cat = data.category;
          const itemId = data.id;

          const isDineInOnly = typeof data.note === 'string' && data.note.includes('åº—å†…ã®ã¿');
          const showThisItemInThisMode = isEatIn || !isDineInOnly;

          if (!categoryInfo.has(cat)) {
            categoryInfo.set(cat, {
              minId: itemId,
              hasTakeoutVisibleItem: showThisItemInThisMode
            });
          } else {
            const info = categoryInfo.get(cat);
            if (itemId < info.minId) info.minId = itemId;
            if (showThisItemInThisMode) info.hasTakeoutVisibleItem = true;
          }
        });

        const sortedCategories = Array.from(categoryInfo.entries())
          .filter(([cat, info]) => {
            return isEatIn || info.hasTakeoutVisibleItem;
          })
          .sort((a, b) => a[1].minId.localeCompare(b[1].minId))
          .map(entry => entry[0]);

        const sel = document.getElementById('category-select');
        if (sel) {
          sel.innerHTML = "";

          const allOpt = document.createElement('option');
          allOpt.value = "all";
          allOpt.textContent = "å…¨ã¦ã®å•†å“";
          sel.appendChild(allOpt);

          sortedCategories.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            sel.appendChild(opt);
          });
        }
        
        await loadAllMenu();
      } catch (e) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    }

    async function loadAllMenu() {
      try {
        const menuSnapshot = await getDocs(collection(db, 'menu'));
        const items = [];
        const isEatIn = tableNumber !== 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ';
        
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          const note = data.note || '';
          
          if (!isEatIn && note.includes('åº—å†…ã®ã¿')) {
            return;
          }
          
          items.push({
            id: data.id,
            category: data.category,
            name: data.name,
            price: data.price,
            toppingsId: data.toppingsId,
            image: data.image || '',
            note: note
          });
        });
        
        items.sort((a, b) => {
          if (a.id < b.id) return -1;
          if (a.id > b.id) return 1;
          return 0;
        });
        
        allMenuItems = items;
        console.log('ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºã‚¢ã‚¤ãƒ†ãƒ æ•°:', items.length);
        displayMenuItems(items);
        await loadSoldOutItems();
      } catch (e) {
        console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    async function loadSoldOutItems() {
      try {
        const soldOutSnapshot = await getDocs(collection(db, 'sold_out'));
        soldOutIds.clear();

        soldOutSnapshot.forEach(doc => {
          soldOutIds.add(doc.data().menuId);
        });

        // applyTimeBasedSoldOut(); // ğŸ”´ è‡ªå‹•å“åˆ‡ã‚Œè¨­å®šã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
        updateSoldOutDisplay();
      } catch (e) {
        console.error('å“åˆ‡ã‚Œæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    function applyTimeBasedSoldOut() {
      // ğŸ”´ è‡ªå‹•å“åˆ‡ã‚Œè¨­å®šã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
      // const now = new Date();
      // const hour = now.getHours();
      // const minute = now.getMinutes();

      // const isTakeout = tableNumber === 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ';
      // const currentTime = hour + (minute / 60);

      // let shouldSoldOut = false;

      // if (isTakeout) {
      //   shouldSoldOut = (currentTime >= 22.5 || hour < 11);
      // } else {
      //   shouldSoldOut = (hour >= 22 || hour < 11);
      // }

      // if (shouldSoldOut) {
      //   allMenuItems.forEach(item => {
      //     soldOutIds.add(item.id);
      //   });
      // }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const sel = document.getElementById('category-select');
      if (sel) {
        sel.addEventListener('change', function() {
          if (this.value === '' || this.value === 'all') {
            displayMenuItems(allMenuItems);
          } else {
            const filtered = allMenuItems.filter(item => item.category === this.value);
            displayMenuItems(filtered);
          }
          setTimeout(() => {
            loadSoldOutItems();
          }, 100);
        });
      }
    });

    function displayMenuItems(items) {
      const list = document.getElementById('menu-list');
      if (!list) return;
      
      list.innerHTML = '';
      
      if (!items || items.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#666;padding:40px;">å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
        return;
      }
      
      console.log('è¡¨ç¤ºã™ã‚‹å•†å“æ•°:', items.length);
      
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'menu-item';
        div.dataset.menuId = item.id;
        
        let imageHtml = '';
        if (item.image) {
          const imageSrc = item.image.includes('http') ? item.image : `./${item.image}`;
          imageHtml = `<img src="${imageSrc}" class="menu-item-image" onerror="this.style.display='none'">`;
        }
        
        div.innerHTML = `
          ${imageHtml}
          <div class="menu-item-content">
            <div class="menu-item-name">${item.name}</div>
            <div class="menu-item-price">Â¥${item.price.toLocaleString()}</div>
            ${item.note ? `<div class="menu-item-note">${item.note}</div>` : ''}
          </div>
        `;
        div.onclick = () => selectItem(item);
        list.appendChild(div);
      });
    }

    async function selectItem(item) {
      if (soldOutIds.has(item.id)) {
        showCustomAlert('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\nã“ã®å•†å“ã¯ç¾åœ¨å“åˆ‡ã‚Œã§ã™ã€‚');
        return;
      }
      
      currentItem = item;
      selectedToppings = [];
      qty = 1;
      
      document.getElementById('item-info').innerHTML = `
        <div class="menu-item-name" style="font-size: 20px;">${item.name}</div>
        <div class="menu-item-price" style="font-size: 24px; margin-top: 10px;">Â¥${item.price.toLocaleString()}</div>
      `;
      
      if (item.toppingsId) {
        const toppingIds = item.toppingsId.split(',').map(id => id.trim());
        const toppingsSnapshot = await getDocs(collection(db, 'toppings'));
        const toppings = [];
        const seenIds = new Set();
        
        toppingsSnapshot.forEach(doc => {
          const data = doc.data();
          if (toppingIds.includes(data.id) && !seenIds.has(data.id)) {
            toppings.push({
              ...data,
              order: data.order || 99
            });
            seenIds.add(data.id);
          }
        });
        
        toppings.sort((a, b) => a.order - b.order);
        
        const list = document.getElementById('topping-list');
        list.innerHTML = '';
        if (toppings.length > 0) {
          toppings.forEach(t => {
            const div = document.createElement('div');
            div.className = 'topping-item';
            div.innerHTML = `
              <span>${t.name}</span>
              <span style="color: #4CAF50; font-weight: bold;">${t.price > 0 ? '+Â¥' + t.price.toLocaleString() : 'ç„¡æ–™'}</span>
            `;
            div.onclick = () => {
              div.classList.toggle('selected');
              const idx = selectedToppings.findIndex(x => x.id === t.id);
              if (idx > -1) selectedToppings.splice(idx, 1);
              else selectedToppings.push(t);
              updateSubtotal();
            };
            list.appendChild(div);
          });
        } else {
          list.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ãƒˆãƒƒãƒ”ãƒ³ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        }
      } else {
        document.getElementById('topping-list').innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ãƒˆãƒƒãƒ”ãƒ³ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      }
      
      document.getElementById('qty').textContent = '1';
      
      updateSubtotal();
      showPage('page-topping');
      window.scrollTo(0, 0);
    }

    window.changeQty = function(d) {
      qty = Math.max(1, qty + d);
      document.getElementById('qty').textContent = qty;
      updateSubtotal();
    };

    function updateSubtotal() {
      let total = currentItem.price;
      selectedToppings.forEach(t => total += t.price || 0);
      document.getElementById('subtotal').textContent = 'Â¥' + (total * qty).toLocaleString();
    }

    window.addToCart = async function() {
      if (soldOutIds.has(currentItem.id)) {
        showCustomAlert('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\nã“ã®å•†å“ã¯ç¾åœ¨å“åˆ‡ã‚Œã«ãªã‚Šã¾ã—ãŸã€‚');
        backToMenu();
        return;
      }
      
      let toppingPrice = 0;
      const toppingNames = selectedToppings.map(t => {
        toppingPrice += t.price || 0;
        return t.name;
      }).join(', ') || 'ãªã—';
      
      cart.push({
        id: currentItem.id,
        name: currentItem.name,
        price: currentItem.price,
        toppings: toppingNames,
        toppingPrice: toppingPrice,
        quantity: qty
      });
      
      backToMenu();
    };

    window.backToMenu = function() {
      showPage('page-menu');
      updateCartButton();
      window.scrollTo(0, 0);
    };

    window.continueShopping = function() {
      backToMenu();
    };

    function updateCartButton() {
      const btn = document.getElementById('cart-btn');
      if (cart.length > 0) {
        btn.classList.remove('hidden');
        btn.textContent = `ã‚«ãƒ¼ãƒˆã‚’è¦‹ã‚‹ (${cart.length}ç‚¹)`;
        btn.onclick = showCart;
      } else {
        btn.classList.add('hidden');
      }
    }

    window.showCart = function() {
      if (cart.length === 0) {
        showCustomAlert('ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™');
        return;
      }
      
      const list = document.getElementById('cart-items');
      list.innerHTML = '';
      let total = 0;
      let hasSoldOut = false;
      
      cart.forEach((item, index) => {
        const subtotal = (item.price + item.toppingPrice) * item.quantity;
        total += subtotal;
        const div = document.createElement('div');
        div.className = 'cart-item';
        
        if (soldOutIds.has(item.id)) {
          div.classList.add('sold-out');
          hasSoldOut = true;
        }
        
        div.innerHTML = `
          <button class="cart-item-delete-btn" onclick="removeFromCart(${index})">Ã—</button>
          <div class="cart-item-header">
            <div class="cart-item-name">${item.name}</div>
            <div class="cart-item-price">Â¥${subtotal.toLocaleString()}</div>
          </div>
          <div class="cart-item-details">
            å˜ä¾¡: Â¥${item.price.toLocaleString()} Ã— ${item.quantity}å€‹
          </div>
          <div class="cart-item-details" style="color: #4CAF50;">
            ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${item.toppings}
          </div>
        `;
        list.appendChild(div);
      });
      
      if (hasSoldOut) {
        const warning = document.createElement('div');
        warning.className = 'warning-box';
        warning.style.marginBottom = '15px';
        warning.innerHTML = 'âš ï¸ å“åˆ‡ã‚Œå•†å“ãŒå«ã¾ã‚Œã¦ã„ã¾ã™<br>æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹å‰ã«å‰Šé™¤ã•ã‚Œã¾ã™';
        list.insertBefore(warning, list.firstChild);
      }
      
      document.getElementById('cart-total').textContent = 'Â¥' + total.toLocaleString();
      showPage('page-cart');
    };
    
    window.removeFromCart = function(index) {
      cart.splice(index, 1);
      if (cart.length === 0) {
        showCustomAlert('ã‚«ãƒ¼ãƒˆãŒç©ºã«ãªã‚Šã¾ã—ãŸ');
        backToMenu();
      } else {
        showCart();
      }
      updateCartButton();
    };

    window.confirmOrder = async function() {
      if (cart.length === 0) {
        showCustomAlert('ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™');
        return;
      }
      
      const soldOutItems = [];
      for (const item of cart) {
        if (soldOutIds.has(item.id)) {
          soldOutItems.push(item.name);
        }
      }
      
      if (soldOutItems.length > 0) {
        showCustomAlert('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\nä»¥ä¸‹ã®å•†å“ãŒå“åˆ‡ã‚Œã«ãªã‚Šã¾ã—ãŸ:\n\n' + soldOutItems.join('\n') + '\n\nã‚«ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚');
        cart = cart.filter(item => !soldOutIds.has(item.id));
        
        if (cart.length === 0) {
          showCustomAlert('å…¨ã¦ã®å•†å“ãŒå“åˆ‡ã‚Œã«ãªã£ãŸãŸã‚ã€ã‚«ãƒ¼ãƒˆãŒç©ºã«ãªã‚Šã¾ã—ãŸã€‚');
          backToMenu();
        } else {
          showCart();
        }
        return;
      }
      
      try {
        const now = new Date();
        const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        
        const todayStart = new Date(jstNow);
        todayStart.setHours(1, 0, 0, 0);
        if (jstNow < todayStart) {
          todayStart.setDate(todayStart.getDate() - 1);
        }
        
        const ordersSnapshot = await getDocs(collection(db, 'orders'));
        let maxOrderNumber = 618;
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          const orderDate = data.timestamp.toDate();
          const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
          
          if (jstOrderDate >= todayStart && data.orderNumber > maxOrderNumber) {
            maxOrderNumber = data.orderNumber;
          }
        });
        
        const orderNumber = maxOrderNumber + 1;
        
        let totalAmount = 0;
        cart.forEach(item => {
          totalAmount += (item.price + item.toppingPrice) * item.quantity;
        });
        
        const deleteAt = new Date(now.getTime() + 10 * 60 * 1000);
        
        const orderData = {
          orderNumber: orderNumber,
          timestamp: Timestamp.fromDate(now),
          tableNumber: tableNumber,
          items: cart,
          totalAmount: totalAmount,
          status: 'pending',
          deleteAt: Timestamp.fromDate(deleteAt),
          cancelledAt: null,
          completedAt: null,
          paidAt: null,
          notifiedComplete: false,
          notifiedCancel: false,
          notifiedPaid: false
        };
        
        const docRef = await addDoc(collection(db, 'orders'), orderData);
        
        await updateDoc(docRef, {
          orderId: docRef.id
        });
        
        const validOrders = [];
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.deleteAt && data.deleteAt.toDate() > now && !data.cancelledAt) {
            validOrders.push(data.orderNumber);
          }
        });
        validOrders.push(orderNumber);
        validOrders.sort((a, b) => a - b);
        const myPosition = validOrders.indexOf(orderNumber) + 1;
        const displayPosition = myPosition + 1;
        
        await updateDoc(docRef, {
          myPosition: displayPosition
        });
        
        document.getElementById('order-num').textContent = orderNumber;
        document.getElementById('waiting').textContent = displayPosition;
        document.getElementById('order-total').textContent = 'Â¥' + totalAmount.toLocaleString();
        document.getElementById('eat-style').textContent = tableNumber;
        
        const list = document.getElementById('order-items');
        list.innerHTML = '';
        cart.forEach(item => {
          const subtotal = (item.price + item.toppingPrice) * item.quantity;
          const div = document.createElement('div');
          div.className = 'cart-item';
          div.innerHTML = `
            <div class="cart-item-header">
              <div class="cart-item-name">${item.name}</div>
              <div class="cart-item-price">Â¥${subtotal.toLocaleString()}</div>
            </div>
            <div class="cart-item-details">æ•°é‡: ${item.quantity}å€‹</div>
            <div class="cart-item-details" style="color: #4CAF50;">ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${item.toppings}</div>
          `;
          list.appendChild(div);
        });
        
        // æ³¨æ–‡ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç›£è¦–é–‹å§‹
        watchOrderStatus(docRef.id);
        
        cart = [];
        showPage('page-complete');
        
      } catch (e) {
        console.error('æ³¨æ–‡ã‚¨ãƒ©ãƒ¼:', e);
        showCustomAlert('æ³¨æ–‡ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };

    function showPage(id) {
      ['page-menu', 'page-topping', 'page-cart', 'page-complete'].forEach(p => {
        document.getElementById(p).classList.add('hidden');
      });
      document.getElementById(id).classList.remove('hidden');
      
      if (id === 'page-menu') {
        updateCartButton();
      }
    }

    window.callStaff = async function() {
      try {
        const callData = {
          tableNumber: tableNumber,
          timestamp: Timestamp.now(),
          type: 'call'
        };
        await addDoc(collection(db, 'staff_calls'), callData);
        
        showCustomAlert('åº—å“¡ã‚’å‘¼ã³ã¾ã—ãŸ!');
      } catch (e) {
        console.error('å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', e);
        showCustomAlert('å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };
    
    window.callStaffFromComplete = async function() {
      try {
        const callData = {
          tableNumber: tableNumber,
          timestamp: Timestamp.now(),
          type: 'call'
        };
        await addDoc(collection(db, 'staff_calls'), callData);
        
        showCustomAlert('åº—å“¡ã‚’å‘¼ã³ã¾ã—ãŸ!\n\næ³¨æ–‡ã®å¤‰æ›´ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãªã©\nãŠæ°—è»½ã«ãŠç”³ã—ä»˜ã‘ãã ã•ã„');
      } catch (e) {
        console.error('å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', e);
        showCustomAlert('å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };
    
    window.requestBillFromComplete = async function() {
      try {
        const billData = {
          tableNumber: tableNumber,
          timestamp: Timestamp.now(),
          type: 'bill'
        };
        await addDoc(collection(db, 'staff_calls'), billData);
        
        showCustomAlert('ãŠä¼šè¨ˆã‚’å‘¼ã³ã¾ã—ãŸ!\n\nå…ˆã«ãŠä¼šè¨ˆã‚’æ¸ˆã¾ã›ã¦ãŠãã¨\nå•†å“å—å–å¾Œã‚¹ãƒ ãƒ¼ã‚ºã«é€€åº—ã§ãã¾ã™');
      } catch (e) {
        console.error('ãŠä¼šè¨ˆã‚¨ãƒ©ãƒ¼:', e);
        showCustomAlert('ãŠä¼šè¨ˆå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };
    
    function showCustomAlert(message) {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        background: white;
        border-radius: 15px;
        padding: 30px;
        max-width: 80%;
        text-align: center;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      `;
      
      const text = document.createElement('div');
      text.textContent = message;
      text.style.cssText = `
        font-size: 18px;
        margin-bottom: 20px;
        color: #333;
        white-space: pre-line;
      `;
      
      const button = document.createElement('button');
      button.textContent = 'OK';
      button.style.cssText = `
        padding: 12px 40px;
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
      `;
      button.onclick = () => overlay.remove();
      
      dialog.appendChild(text);
      dialog.appendChild(button);
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);
    }
  </script>
</body>
</html>