<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç²‰ã‚‚ã‚“å±‹ å…« - ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ ï¼ˆäºˆç´„æ©Ÿèƒ½ä»˜ãï¼‰</title>
  
  <!-- Star mC-Print3 SDK -->
  <script src="https://www.star-m.jp/products/s_print/sdk/starwebprinttracer/v1.1.0/StarWebPrintTrader.js"></script>
  <script src="https://www.star-m.jp/products/s_print/sdk/starwebprintbuilder/v1.2.0/StarWebPrintBuilder.js"></script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1800px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      margin-bottom: 25px;
      text-align: center;
    }
    
    .header h1 {
      font-size: 32px;
      color: #333;
      margin-bottom: 10px;
    }
    
    .sales-summary {
      background: #f8f9fa;
      padding: 15px 20px;
      border-radius: 12px;
      display: flex;
      gap: 30px;
      justify-content: center;
      margin-top: 15px;
    }
    
    .sales-item {
      text-align: center;
    }
    
    .sales-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .sales-value {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .table-section {
      margin-bottom: 30px;
    }
    
    .section-title {
      font-size: 20px;
      font-weight: bold;
      color: white;
      margin-bottom: 15px;
      padding: 10px 15px;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
    }
    
    .table-buttons {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .table-btn {
      padding: 20px;
      font-size: 20px;
      font-weight: bold;
      background: white;
      border: 3px solid #2196F3;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      color: #2196F3;
      position: relative;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .table-btn:hover {
      background: #2196F3;
      color: white;
      transform: translateY(-3px);
    }
    
    .table-btn.active {
      background: #2196F3;
      color: white;
    }
    
    .table-btn.has-orders {
      border-color: #FF9800;
      color: #FF9800;
      animation: pulse 2s infinite;
    }
    
    .table-btn.reservation {
      border-color: #9C27B0;
      color: #9C27B0;
    }
    
    .table-btn.reservation.has-memo {
      background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
      border-color: #9C27B0;
    }
    
    @keyframes pulse {
      0%, 100% { box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4); }
      50% { box-shadow: 0 4px 25px rgba(255, 152, 0, 0.8); }
    }
    
    .edit-icon {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 30px;
      height: 30px;
      background: rgba(156, 39, 176, 0.8);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .edit-icon:hover {
      background: #9C27B0;
      transform: scale(1.1);
    }
    
    .memo-preview {
      font-size: 12px;
      margin-top: 8px;
      color: #666;
      line-height: 1.4;
      max-width: 100%;
      word-wrap: break-word;
    }
    
    .table-btn.has-memo .memo-preview {
      color: #9C27B0;
      font-weight: 600;
    }
    
    .orders-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      gap: 20px;
    }
    
    .order-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.15);
      position: relative;
    }
    
    .order-number {
      font-size: 36px;
      font-weight: bold;
      color: #4CAF50;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .order-number:hover {
      color: #45a049;
      transform: scale(1.05);
    }
    
    .table-label {
      font-size: 18px;
      color: #666;
      margin-bottom: 15px;
    }
    
    .order-items {
      margin: 15px 0;
      border-top: 2px solid #e0e0e0;
      padding-top: 15px;
    }
    
    .order-item {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .item-info {
      flex: 1;
    }
    
    .item-name {
      font-weight: 600;
      font-size: 16px;
      margin-bottom: 5px;
    }
    
    .item-details {
      font-size: 13px;
      color: #666;
    }
    
    .item-price {
      font-weight: bold;
      color: #333;
      font-size: 16px;
    }
    
    .order-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px solid #e0e0e0;
      font-size: 20px;
      font-weight: bold;
    }
    
    .total-label {
      color: #666;
    }
    
    .total-amount {
      color: #4CAF50;
      font-size: 28px;
    }
    
    .order-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }
    
    .btn {
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    
    .btn:active {
      transform: scale(0.95);
    }
    
    .btn-pay {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    .btn-split {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal.hidden {
      display: none;
    }
    
    .modal-content {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #333;
    }
    
    .payment-summary {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 10px 0;
    }
    
    .summary-label {
      font-size: 18px;
      color: #666;
    }
    
    .summary-value {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .summary-value.large {
      font-size: 36px;
    }
    
    .payment-methods {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin: 20px 0;
    }
    
    .payment-btn {
      padding: 25px 15px;
      font-size: 16px;
      font-weight: bold;
      border: 3px solid #e0e0e0;
      background: white;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }
    
    .payment-btn:hover {
      border-color: #4CAF50;
      transform: translateY(-2px);
    }
    
    .payment-btn.selected {
      border-color: #4CAF50;
      background: #e8f5e9;
    }
    
    .payment-btn-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }
    
    .cash-input-section {
      margin: 20px 0;
    }
    
    .input-group {
      margin: 15px 0;
    }
    
    .input-group label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      color: #333;
      font-size: 16px;
    }
    
    .input-group input,
    .input-group textarea {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      font-family: inherit;
    }
    
    .input-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .change-display {
      background: #e8f5e9;
      padding: 20px;
      border-radius: 10px;
      margin: 15px 0;
      text-align: center;
    }
    
    .change-label {
      font-size: 16px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .change-amount {
      font-size: 40px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .split-items {
      margin: 20px 0;
    }
    
    .split-item {
      display: flex;
      align-items: center;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      margin: 10px 0;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .split-item:hover {
      border-color: #2196F3;
      background: #f5f5f5;
    }
    
    .split-item.selected {
      border-color: #4CAF50;
      background: #e8f5e9;
    }
    
    .split-checkbox {
      width: 30px;
      height: 30px;
      margin-right: 15px;
      cursor: pointer;
    }
    
    .split-item-info {
      flex: 1;
    }
    
    .split-item-name {
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .split-item-details {
      font-size: 12px;
      color: #666;
    }
    
    .split-item-price {
      font-weight: bold;
      color: #333;
      font-size: 18px;
    }
    
    .memo-display {
      background: #f3e5f5;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      border-left: 4px solid #9C27B0;
    }
    
    .memo-item {
      margin: 8px 0;
      font-size: 14px;
    }
    
    .memo-label {
      font-weight: bold;
      color: #9C27B0;
      margin-right: 8px;
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
      font-size: 18px;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: white;
      font-size: 18px;
    }
    
    .btn-delete-memo {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ç²‰ã‚‚ã‚“å±‹ å…« - ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ ï¼ˆäºˆç´„æ©Ÿèƒ½ä»˜ãï¼‰</h1>
      
      <div class="sales-summary">
        <div class="sales-item">
          <div class="sales-label">æœ¬æ—¥ã®å®¢æ•°</div>
          <div class="sales-value" id="customerCount">0</div>
        </div>
        <div class="sales-item">
          <div class="sales-label">æœ¬æ—¥ã®å£²ä¸Š</div>
          <div class="sales-value" id="todaySales">Â¥0</div>
        </div>
      </div>
    </div>

    <!-- åº—å†…ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="table-section">
      <div class="section-title">ğŸ½ï¸ åº—å†…ãƒ†ãƒ¼ãƒ–ãƒ«</div>
      <div class="table-buttons" id="regularTables"></div>
    </div>
    
    <!-- äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ« -->
    <div class="table-section">
      <div class="section-title">ğŸ“… äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ«</div>
      <div class="table-buttons" id="reservationTables"></div>
    </div>
    
    <div class="orders-container" id="ordersContainer">
      <div class="empty-state">ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
    </div>
  </div>

  <!-- ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="paymentModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">ä¼šè¨ˆå‡¦ç†</div>
      
      <div class="payment-summary">
        <div class="summary-row">
          <span class="summary-label">æ³¨æ–‡ç•ªå·</span>
          <span class="summary-value" id="paymentOrderNumber">#000</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">åˆè¨ˆé‡‘é¡</span>
          <span class="summary-value large" id="paymentAmount">Â¥0</span>
        </div>
      </div>
      
      <div style="font-weight: bold; margin-bottom: 10px; font-size: 18px;">æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠ</div>
      <div class="payment-methods">
        <div class="payment-btn" onclick="selectPaymentMethod('cash')">
          <div class="payment-btn-icon">ğŸ’µ</div>
          <div>ç¾é‡‘</div>
        </div>
        <div class="payment-btn" onclick="selectPaymentMethod('emoney')">
          <div class="payment-btn-icon">ğŸ“±</div>
          <div>é›»å­ãƒãƒãƒ¼</div>
        </div>
        <div class="payment-btn" onclick="selectPaymentMethod('credit')">
          <div class="payment-btn-icon">ğŸ’³</div>
          <div>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</div>
        </div>
      </div>
      
      <div id="cashInputSection" class="cash-input-section hidden">
        <div class="input-group">
          <label>ãŠé ã‹ã‚Šé‡‘é¡</label>
          <input type="number" id="cashReceived" placeholder="0" oninput="calculateChange()">
        </div>
        
        <div class="change-display">
          <div class="change-label">ãŠã¤ã‚Š</div>
          <div class="change-amount" id="changeAmount">Â¥0</div>
        </div>
      </div>
      
      <button class="btn btn-pay" style="width: 100%; margin: 10px 0;" onclick="completePayment()" id="completePaymentBtn" disabled>ä¼šè¨ˆå®Œäº†</button>
      <button class="btn btn-split" style="width: 100%; background: #e0e0e0; color: #333;" onclick="closePaymentModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <!-- åˆ†å‰²ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="splitModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">åˆ†å‰²ä¼šè¨ˆ</div>
      
      <p style="margin-bottom: 20px; color: #666;">ä¼šè¨ˆã™ã‚‹å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
      
      <div class="split-items" id="splitItemsList"></div>
      
      <div class="payment-summary" style="margin-top: 20px;">
        <div class="summary-row">
          <span class="summary-label">é¸æŠå•†å“ã®åˆè¨ˆ</span>
          <span class="summary-value large" id="splitTotal">Â¥0</span>
        </div>
      </div>
      
      <button class="btn btn-pay" style="width: 100%; margin: 10px 0;" onclick="proceedToSplitPayment()" id="splitPaymentBtn" disabled>ã“ã®é‡‘é¡ã§ä¼šè¨ˆ</button>
      <button class="btn btn-split" style="width: 100%; background: #e0e0e0; color: #333;" onclick="closeSplitModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <!-- äºˆç´„ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="memoModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">äºˆç´„ãƒ¡ãƒ¢ç·¨é›†</div>
      
      <div id="currentMemoDisplay" class="hidden"></div>
      
      <div class="input-group">
        <label>ğŸ“… äºˆç´„æ—¥</label>
        <input type="date" id="memoDate">
      </div>
      
      <div class="input-group">
        <label>ğŸ• äºˆç´„æ™‚é–“</label>
        <input type="time" id="memoTime">
      </div>
      
      <div class="input-group">
        <label>ğŸ‘¤ ãŠå®¢æ§˜å</label>
        <input type="text" id="memoName" placeholder="ä¾‹ï¼šç”°ä¸­æ§˜">
      </div>
      
      <div class="input-group">
        <label>ğŸ“ å‚™è€ƒ</label>
        <textarea id="memoNotes" placeholder="ä¾‹ï¼š4åæ§˜ã€çª“éš›å¸Œæœ›ã€ã‚¢ãƒ¬ãƒ«ã‚®ãƒ¼å¯¾å¿œ"></textarea>
      </div>
      
      <button class="btn btn-pay" style="width: 100%; margin: 10px 0;" onclick="saveMemo()">ä¿å­˜</button>
      <button class="btn btn-delete-memo" style="width: 100%; margin: 10px 0;" onclick="deleteMemo()">ãƒ¡ãƒ¢ã‚’å‰Šé™¤</button>
      <button class="btn btn-split" style="width: 100%; background: #e0e0e0; color: #333;" onclick="closeMemoModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc, doc, Timestamp, onSnapshot, addDoc, setDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.updateDoc = updateDoc;
    window.doc = doc;
    window.Timestamp = Timestamp;
    window.onSnapshot = onSnapshot;
    window.addDoc = addDoc;
    window.setDoc = setDoc;
    window.deleteDoc = deleteDoc;
    window.getDoc = getDoc;
    
    console.log('FirebaseåˆæœŸåŒ–å®Œäº†');
  </script>

  <script>
    // ãƒ—ãƒªãƒ³ã‚¿ãƒ¼IPã‚¢ãƒ‰ãƒ¬ã‚¹
    const PRINTER_IP = '192.168.244.41';
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©
    const REGULAR_TABLES = ['c1', 'c2', 'T-H', 'T-M'];
    const RESERVATION_TABLES = ['äºˆç´„1', 'äºˆç´„2', 'äºˆç´„3', 'äºˆç´„4', 'äºˆç´„5'];
    
    // çŠ¶æ…‹ç®¡ç†
    let selectedTable = null;
    let currentOrderForPayment = null;
    let currentOrderForSplit = null;
    let currentTableForMemo = null;
    let selectedPaymentMethod = null;
    let selectedSplitItems = new Set();
    let allOrders = new Map();
    let reservationMemos = new Map();
    let listeners = new Map();
    
    // åˆæœŸåŒ–
    window.addEventListener('load', async () => {
      console.log('ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•');
      await initializeSystem();
    });
    
    async function initializeSystem() {
      // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
      createTableButtons();
      
      // äºˆç´„ãƒ¡ãƒ¢ã‚’èª­ã¿è¾¼ã¿
      await loadReservationMemos();
      
      // äºˆç´„ãƒ¡ãƒ¢ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
      watchReservationMemos();
      
      // å£²ä¸Šè¨ˆç®—
      await calculateTodaySales();
      setInterval(calculateTodaySales, 30000);
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
    function createTableButtons() {
      // åº—å†…ãƒ†ãƒ¼ãƒ–ãƒ«
      const regularContainer = document.getElementById('regularTables');
      REGULAR_TABLES.forEach(table => {
        const btn = createTableButton(table, false);
        regularContainer.appendChild(btn);
        monitorTable(table);
      });
      
      // äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ«
      const reservationContainer = document.getElementById('reservationTables');
      RESERVATION_TABLES.forEach(table => {
        const btn = createTableButton(table, true);
        reservationContainer.appendChild(btn);
        monitorTable(table);
      });
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
    function createTableButton(table, isReservation) {
      const btn = document.createElement('div');
      btn.className = 'table-btn';
      if (isReservation) btn.classList.add('reservation');
      btn.id = `table-btn-${table}`;
      
      const tableName = document.createElement('div');
      tableName.textContent = table;
      tableName.style.fontSize = '20px';
      tableName.style.fontWeight = 'bold';
      btn.appendChild(tableName);
      
      if (isReservation) {
        const editIcon = document.createElement('div');
        editIcon.className = 'edit-icon';
        editIcon.innerHTML = 'âœï¸';
        editIcon.onclick = (e) => {
          e.stopPropagation();
          showMemoModal(table);
        };
        btn.appendChild(editIcon);
        
        const memoPreview = document.createElement('div');
        memoPreview.className = 'memo-preview';
        memoPreview.id = `memo-preview-${table}`;
        btn.appendChild(memoPreview);
      }
      
      btn.onclick = () => selectTable(table);
      
      return btn;
    }
    
    // äºˆç´„ãƒ¡ãƒ¢ã‚’èª­ã¿è¾¼ã¿
    async function loadReservationMemos() {
      try {
        const snapshot = await getDocs(collection(db, 'reservations'));
        snapshot.forEach(doc => {
          const data = doc.data();
          reservationMemos.set(data.tableNumber, { id: doc.id, ...data });
        });
        updateMemoDisplays();
      } catch (e) {
        console.error('äºˆç´„ãƒ¡ãƒ¢èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    // äºˆç´„ãƒ¡ãƒ¢ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
    function watchReservationMemos() {
      onSnapshot(collection(db, 'reservations'), (snapshot) => {
        reservationMemos.clear();
        snapshot.forEach(doc => {
          const data = doc.data();
          reservationMemos.set(data.tableNumber, { id: doc.id, ...data });
        });
        updateMemoDisplays();
      });
    }
    
    // ãƒ¡ãƒ¢è¡¨ç¤ºã‚’æ›´æ–°
    function updateMemoDisplays() {
      RESERVATION_TABLES.forEach(table => {
        const btn = document.getElementById(`table-btn-${table}`);
        const preview = document.getElementById(`memo-preview-${table}`);
        const memo = reservationMemos.get(table);
        
        if (memo && preview) {
          let text = '';
          if (memo.name) text += memo.name;
          if (memo.time) text += ` ${memo.time}`;
          if (memo.date) text += `\n${memo.date}`;
          
          preview.textContent = text || 'ãƒ¡ãƒ¢ãªã—';
          btn.classList.add('has-memo');
        } else if (preview) {
          preview.textContent = '';
          btn.classList.remove('has-memo');
        }
      });
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠ
    window.selectTable = function(table) {
      selectedTable = table;
      
      // ãƒœã‚¿ãƒ³ã®activeçŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.table-btn').forEach(btn => {
        btn.classList.remove('active');
      });
      document.getElementById(`table-btn-${table}`).classList.add('active');
      
      // æ³¨æ–‡ã‚’è¡¨ç¤º
      displayOrdersForTable(table);
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ³¨æ–‡ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
    function monitorTable(table) {
      const q = query(
        collection(db, 'orders'),
        where('tableNumber', '==', table)
      );
      
      const unsubscribe = onSnapshot(q, (snapshot) => {
        console.log(`ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ« ${table} ã®æ³¨æ–‡æ›´æ–°`);
        
        // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        snapshot.forEach(doc => {
          const data = doc.data();
          allOrders.set(doc.id, { id: doc.id, ...data });
        });
        
        // ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
        const hasActiveOrders = snapshot.docs.some(doc => {
          const data = doc.data();
          return !data.paidAt && !data.cancelledAt;
        });
        
        const btn = document.getElementById(`table-btn-${table}`);
        if (btn) {
          if (hasActiveOrders) {
            btn.classList.add('has-orders');
          } else {
            btn.classList.remove('has-orders');
          }
        }
        
        // é¸æŠä¸­ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãªã‚‰è¡¨ç¤ºã‚’æ›´æ–°
        if (selectedTable === table) {
          displayOrdersForTable(table);
        }
      });
      
      listeners.set(table, unsubscribe);
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ³¨æ–‡ã‚’è¡¨ç¤º
    function displayOrdersForTable(table) {
      const container = document.getElementById('ordersContainer');
      container.innerHTML = '';
      
      const orders = Array.from(allOrders.values())
        .filter(order => order.tableNumber === table && !order.cancelledAt && !order.paidAt)
        .sort((a, b) => {
          const timeA = a.timestamp?.toDate?.() || new Date(0);
          const timeB = b.timestamp?.toDate?.() || new Date(0);
          return timeB - timeA;
        });
      
      if (orders.length === 0) {
        container.innerHTML = '<div class="empty-state">ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«æœªä¼šè¨ˆã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      orders.forEach(order => {
        const card = createOrderCard(order);
        container.appendChild(card);
      });
    }
    
    // æ³¨æ–‡ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
    function createOrderCard(order) {
      const card = document.createElement('div');
      card.className = 'order-card';
      
      let itemsHtml = '';
      order.items.forEach(item => {
        const subtotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
        itemsHtml += `
          <div class="order-item">
            <div class="item-info">
              <div class="item-name">${item.name}</div>
              <div class="item-details">æ•°é‡: ${item.quantity}å€‹ | ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${item.toppings}</div>
            </div>
            <div class="item-price">Â¥${subtotal.toLocaleString()}</div>
          </div>
        `;
      });
      
      card.innerHTML = `
        <div class="order-number" onclick="showPaymentModal('${order.id}', ${order.orderNumber}, ${order.totalAmount})">#${order.orderNumber}</div>
        <div class="table-label">ãƒ†ãƒ¼ãƒ–ãƒ«: ${order.tableNumber}</div>
        <div class="order-items">
          ${itemsHtml}
        </div>
        <div class="order-total">
          <span class="total-label">åˆè¨ˆ:</span>
          <span class="total-amount">Â¥${order.totalAmount.toLocaleString()}</span>
        </div>
        <div class="order-actions">
          <button class="btn btn-pay" onclick="showPaymentModal('${order.id}', ${order.orderNumber}, ${order.totalAmount})">
            ğŸ’³ ä¼šè¨ˆ
          </button>
          <button class="btn btn-split" onclick="showSplitModal('${order.id}', ${order.orderNumber})">
            âœ‚ï¸ åˆ†å‰²ä¼šè¨ˆ
          </button>
        </div>
      `;
      
      return card;
    }
    
    // ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showMemoModal = async function(table) {
      currentTableForMemo = table;
      const memo = reservationMemos.get(table);
      
      document.getElementById('memoDate').value = memo?.date || '';
      document.getElementById('memoTime').value = memo?.time || '';
      document.getElementById('memoName').value = memo?.name || '';
      document.getElementById('memoNotes').value = memo?.notes || '';
      
      // æ—¢å­˜ãƒ¡ãƒ¢è¡¨ç¤º
      const displayDiv = document.getElementById('currentMemoDisplay');
      if (memo) {
        displayDiv.className = 'memo-display';
        displayDiv.innerHTML = `
          <div style="font-weight: bold; color: #9C27B0; margin-bottom: 10px;">ç¾åœ¨ã®ãƒ¡ãƒ¢</div>
          ${memo.date ? `<div class="memo-item"><span class="memo-label">æ—¥ä»˜:</span>${memo.date}</div>` : ''}
          ${memo.time ? `<div class="memo-item"><span class="memo-label">æ™‚é–“:</span>${memo.time}</div>` : ''}
          ${memo.name ? `<div class="memo-item"><span class="memo-label">åå‰:</span>${memo.name}</div>` : ''}
          ${memo.notes ? `<div class="memo-item"><span class="memo-label">å‚™è€ƒ:</span>${memo.notes}</div>` : ''}
        `;
      } else {
        displayDiv.className = 'hidden';
      }
      
      document.getElementById('memoModal').classList.remove('hidden');
    };
    
    // ãƒ¡ãƒ¢ã‚’ä¿å­˜
    window.saveMemo = async function() {
      const date = document.getElementById('memoDate').value;
      const time = document.getElementById('memoTime').value;
      const name = document.getElementById('memoName').value;
      const notes = document.getElementById('memoNotes').value;
      
      if (!date && !time && !name && !notes) {
        alert('å°‘ãªãã¨ã‚‚1ã¤ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        const memoData = {
          tableNumber: currentTableForMemo,
          date: date || '',
          time: time || '',
          name: name || '',
          notes: notes || '',
          timestamp: Timestamp.now()
        };
        
        await setDoc(doc(db, 'reservations', currentTableForMemo), memoData);
        
        alert(`${currentTableForMemo}ã®äºˆç´„ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
        closeMemoModal();
      } catch (e) {
        console.error('ãƒ¡ãƒ¢ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
        alert('ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ãƒ¡ãƒ¢ã‚’å‰Šé™¤
    window.deleteMemo = async function() {
      if (!confirm(`${currentTableForMemo}ã®äºˆç´„ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      
      try {
        await deleteDoc(doc(db, 'reservations', currentTableForMemo));
        alert('äºˆç´„ãƒ¡ãƒ¢ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        closeMemoModal();
      } catch (e) {
        console.error('ãƒ¡ãƒ¢å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e);
        alert('ãƒ¡ãƒ¢ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeMemoModal = function() {
      document.getElementById('memoModal').classList.add('hidden');
      currentTableForMemo = null;
    };
    
    // ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showPaymentModal = function(orderId, orderNumber, amount) {
      currentOrderForPayment = { id: orderId, orderNumber, amount };
      selectedPaymentMethod = null;
      
      document.getElementById('paymentOrderNumber').textContent = '#' + orderNumber;
      document.getElementById('paymentAmount').textContent = 'Â¥' + amount.toLocaleString();
      
      document.querySelectorAll('.payment-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('completePaymentBtn').disabled = true;
      document.getElementById('paymentModal').classList.remove('hidden');
    };
    
    // æ”¯æ‰•ã„æ–¹æ³•é¸æŠ
    window.selectPaymentMethod = function(method) {
      selectedPaymentMethod = method;
      
      document.querySelectorAll('.payment-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      event.target.closest('.payment-btn').classList.add('selected');
      
      if (method === 'cash') {
        document.getElementById('cashInputSection').classList.remove('hidden');
        document.getElementById('completePaymentBtn').disabled = true;
      } else {
        document.getElementById('cashInputSection').classList.add('hidden');
        document.getElementById('completePaymentBtn').disabled = false;
      }
    };
    
    // ãŠã¤ã‚Šè¨ˆç®—
    window.calculateChange = function() {
      const cashReceived = parseInt(document.getElementById('cashReceived').value) || 0;
      const changeAmount = cashReceived - currentOrderForPayment.amount;
      
      document.getElementById('changeAmount').textContent = 'Â¥' + changeAmount.toLocaleString();
      document.getElementById('completePaymentBtn').disabled = cashReceived < currentOrderForPayment.amount;
    };
    
    // ä¼šè¨ˆå®Œäº†
    window.completePayment = async function() {
      if (!selectedPaymentMethod || !currentOrderForPayment) return;
      
      const cashReceived = parseInt(document.getElementById('cashReceived').value) || currentOrderForPayment.amount;
      
      if (selectedPaymentMethod === 'cash' && cashReceived < currentOrderForPayment.amount) {
        alert('ãŠé ã‹ã‚Šé‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
        return;
      }
      
      try {
        await updateDoc(doc(db, 'orders', currentOrderForPayment.id), {
          paidAt: Timestamp.now(),
          paymentMethod: selectedPaymentMethod,
          cashReceived: cashReceived,
          change: selectedPaymentMethod === 'cash' ? (cashReceived - currentOrderForPayment.amount) : 0
        });
        
        alert(`æ³¨æ–‡ #${currentOrderForPayment.orderNumber} ã®ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸ`);
        
        // ãƒ‰ãƒ­ã‚¢ã‚’é–‹ãï¼ˆç¾é‡‘ã®å ´åˆï¼‰
        if (selectedPaymentMethod === 'cash') {
          await openDrawer();
        }
        
        closePaymentModal();
        await calculateTodaySales();
      } catch (e) {
        console.error('ä¼šè¨ˆã‚¨ãƒ©ãƒ¼:', e);
        alert('ä¼šè¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
      document.getElementById('cashReceived').value = '';
      currentOrderForPayment = null;
      selectedPaymentMethod = null;
    };
    
    // åˆ†å‰²ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showSplitModal = function(orderId, orderNumber) {
      const order = allOrders.get(orderId);
      if (!order) return;
      
      currentOrderForSplit = { id: orderId, orderNumber, order };
      selectedSplitItems.clear();
      
      const container = document.getElementById('splitItemsList');
      container.innerHTML = '';
      
      order.items.forEach((item, index) => {
        const subtotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
        
        const div = document.createElement('div');
        div.className = 'split-item';
        div.onclick = () => toggleSplitItem(index, subtotal);
        
        div.innerHTML = `
          <input type="checkbox" class="split-checkbox" id="split-${index}">
          <div class="split-item-info">
            <div class="split-item-name">${item.name}</div>
            <div class="split-item-details">æ•°é‡: ${item.quantity}å€‹ | ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${item.toppings}</div>
          </div>
          <div class="split-item-price">Â¥${subtotal.toLocaleString()}</div>
        `;
        
        container.appendChild(div);
      });
      
      document.getElementById('splitTotal').textContent = 'Â¥0';
      document.getElementById('splitPaymentBtn').disabled = true;
      document.getElementById('splitModal').classList.remove('hidden');
    };
    
    // åˆ†å‰²ã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒˆã‚°ãƒ«
    window.toggleSplitItem = function(index, price) {
      const checkbox = document.getElementById(`split-${index}`);
      const item = checkbox.closest('.split-item');
      
      if (selectedSplitItems.has(index)) {
        selectedSplitItems.delete(index);
        checkbox.checked = false;
        item.classList.remove('selected');
      } else {
        selectedSplitItems.add(index);
        checkbox.checked = true;
        item.classList.add('selected');
      }
      
      updateSplitTotal();
    };
    
    // åˆ†å‰²åˆè¨ˆã‚’æ›´æ–°
    function updateSplitTotal() {
      const order = currentOrderForSplit.order;
      let total = 0;
      
      selectedSplitItems.forEach(index => {
        const item = order.items[index];
        total += (item.price + (item.toppingPrice || 0)) * item.quantity;
      });
      
      document.getElementById('splitTotal').textContent = 'Â¥' + total.toLocaleString();
      document.getElementById('splitPaymentBtn').disabled = selectedSplitItems.size === 0;
    }
    
    // åˆ†å‰²ä¼šè¨ˆã‚’é€²ã‚ã‚‹
    window.proceedToSplitPayment = function() {
      const order = currentOrderForSplit.order;
      let total = 0;
      
      selectedSplitItems.forEach(index => {
        const item = order.items[index];
        total += (item.price + (item.toppingPrice || 0)) * item.quantity;
      });
      
      closeSplitModal();
      showPaymentModal(currentOrderForSplit.id, currentOrderForSplit.orderNumber, total);
    };
    
    // åˆ†å‰²ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeSplitModal = function() {
      document.getElementById('splitModal').classList.add('hidden');
      currentOrderForSplit = null;
      selectedSplitItems.clear();
    };
    
    // ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³
    async function openDrawer() {
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        builder.createPeripheralElement({
          channel: 1,
          on: 100,
          off: 100
        });
        
        const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
        const trader = new StarWebPrintTrader({url: url});
        
        trader.onReceive = function(response) {
          console.log('ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æˆåŠŸ');
        };
        
        trader.onError = function(response) {
          console.error('ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³ã‚¨ãƒ©ãƒ¼:', response);
        };
        
        trader.sendMessage({request: request});
      } catch (e) {
        console.error('ãƒ‰ãƒ­ã‚¢ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    // æœ¬æ—¥ã®å£²ä¸Šã‚’è¨ˆç®—
    async function calculateTodaySales() {
      try {
        const now = new Date();
        const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        
        const todayStart = new Date(jstNow);
        todayStart.setHours(1, 0, 0, 0);
        if (jstNow < todayStart) {
          todayStart.setDate(todayStart.getDate() - 1);
        }
        
        const ordersSnapshot = await getDocs(collection(db, 'orders'));
        
        let customerCount = 0;
        let totalSales = 0;
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          const orderDate = data.timestamp.toDate();
          const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
          
          if (jstOrderDate >= todayStart && data.paidAt && !data.cancelledAt) {
            customerCount++;
            totalSales += data.totalAmount;
          }
        });
        
        document.getElementById('customerCount').textContent = customerCount;
        document.getElementById('todaySales').textContent = 'Â¥' + totalSales.toLocaleString();
      } catch (e) {
        console.error('å£²ä¸Šè¨ˆç®—ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
  </script>
</body>
</html>
