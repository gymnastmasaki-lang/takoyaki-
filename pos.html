<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>粉もん屋 八 - レジシステム</title>
  
  <!-- Star mC-Print3 SDK -->
  <script src="https://www.star-m.jp/products/s_print/sdk/starwebprinttracer/v1.1.0/StarWebPrintTrader.js"></script>
  <script src="https://www.star-m.jp/products/s_print/sdk/starwebprintbuilder/v1.2.0/StarWebPrintBuilder.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc, doc, Timestamp, onSnapshot, addDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    console.log('Firebase初期化完了');
    console.log('Project ID:', firebaseConfig.projectId);
    
    window.isAuthenticated = false;
    
    window.authenticateUser = async function() {
      try {
        console.log('匿名認証を開始...');
        const userCredential = await signInAnonymously(auth);
        console.log('匿名認証成功:', userCredential.user.uid);
        window.isAuthenticated = true;
        return true;
      } catch (error) {
        console.error('認証エラー:', error);
        return false;
      }
    };
    
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log('認証済みユーザー:', user.uid);
        window.isAuthenticated = true;
      } else {
        console.log('未認証');
        window.isAuthenticated = false;
      }
    });
    
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.updateDoc = updateDoc;
    window.doc = doc;
    window.Timestamp = Timestamp;
    window.onSnapshot = onSnapshot;
    window.addDoc = addDoc;
    window.orderBy = orderBy;
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .header-left h1 {
      font-size: 32px;
      color: #333;
      margin-bottom: 5px;
    }
    
    .header-left .status {
      font-size: 18px;
      color: #666;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .sales-summary {
      background: #f8f9fa;
      padding: 15px 20px;
      border-radius: 12px;
      display: flex;
      gap: 30px;
      align-items: center;
    }
    
    .sales-item {
      text-align: center;
    }
    
    .sales-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .sales-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    
    .sales-value.highlight {
      color: #4CAF50;
    }
    
    .btn-settlement, .btn-monthly, .btn-drawer {
      padding: 12px 30px;
      font-size: 16px;
      font-weight: bold;
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: all 0.3s;
    }
    
    .btn-settlement {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
    }
    
    .btn-monthly {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    }
    
    .btn-drawer {
      background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
    }
    
    .btn-settlement:hover, .btn-monthly:hover, .btn-drawer:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 25px;
    }
    
    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }
    
    .section {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }
    
    .section h2 {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #667eea;
    }
    
    .table-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }
    
    @media (max-width: 768px) {
      .table-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    .table-btn {
      padding: 20px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }
    
    .table-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    .table-btn.has-orders::after {
      content: '';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 12px;
      height: 12px;
      background: #ff4444;
      border-radius: 50%;
      border: 2px solid white;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    
    .order-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-left: 5px solid #667eea;
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .order-number {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    
    .order-items {
      margin: 15px 0;
    }
    
    .order-item {
      padding: 10px 0;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .item-name {
      font-weight: 500;
      color: #333;
    }
    
    .item-details {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    
    .item-price {
      font-weight: bold;
      color: #667eea;
    }
    
    .order-total {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 3px solid #667eea;
      font-size: 24px;
      font-weight: bold;
    }
    
    .total-amount {
      color: #667eea;
      font-size: 28px;
    }
    
    .btn {
      width: 100%;
      padding: 18px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      margin: 8px 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
    }
    
    .btn-info {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
    }
    
    .button-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    .manual-input {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-group label {
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }
    
    .input-group select {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      transition: border-color 0.3s;
    }
    
    .input-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .menu-items-list {
      max-height: 400px;
      overflow-y: auto;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      background: white;
    }
    
    .menu-item-card {
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .menu-item-card:hover {
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      transform: translateY(-2px);
    }
    
    .menu-item-name {
      font-weight: bold;
      font-size: 16px;
      color: #333;
    }
    
    .menu-item-price {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
    }
    
    .selected-items {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .selected-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .quantity-input {
      width: 60px;
      padding: 5px;
      text-align: center;
      border: 2px solid #ddd;
      border-radius: 5px;
    }
    
    .remove-btn {
      padding: 5px 12px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 18px;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal h3 {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .topping-list {
      display: grid;
      gap: 12px;
      margin: 20px 0;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .topping-item {
      padding: 15px;
      border: 3px solid #e0e0e0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      font-size: 16px;
    }
    
    .topping-item.selected {
      background: #e8f5e9;
      border-color: #4CAF50;
      font-weight: bold;
    }
    
    .topping-price {
      color: #667eea;
      font-weight: bold;
    }
    
    .payment-methods {
      display: grid;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .payment-method-btn {
      padding: 20px;
      font-size: 20px;
      font-weight: bold;
      border: 3px solid #ddd;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .payment-method-btn:hover {
      border-color: #667eea;
      background: #f8f9fa;
    }
    
    .payment-method-btn.selected {
      border-color: #667eea;
      background: #e8eaf6;
    }
    
    .cash-input-section {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    
    .cash-input-section input {
      width: 100%;
      padding: 15px;
      font-size: 24px;
      border: 2px solid #ddd;
      border-radius: 8px;
      text-align: right;
    }
    
    .change-display {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    
    .change-amount {
      color: #4CAF50;
      font-size: 28px;
    }
    
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <h1>レジシステム</h1>
        <div class="status">粉もん屋 八 下赤塚店</div>
      </div>
      <div class="header-right">
        <div class="sales-summary">
          <div class="sales-item">
            <div class="sales-label">客数</div>
            <div class="sales-value" id="customerCount">0</div>
          </div>
          <div class="sales-item">
            <div class="sales-label">本日売上</div>
            <div class="sales-value highlight" id="todaySales">¥0</div>
          </div>
        </div>
        <button class="btn-drawer" onclick="openDrawer()">ドロア開</button>
        <button class="btn-settlement" onclick="alert('精算機能')">精算</button>
        <button class="btn-monthly" onclick="alert('月次レポート')">月次</button>
      </div>
    </div>
    
    <div class="main-content">
      <div class="section">
        <h2>テーブル選択</h2>
        <div class="table-grid" id="tableGrid"></div>
        
        <div id="orderSection" class="hidden">
          <h2>注文詳細 - <span id="selectedTableLabel"></span></h2>
          
          <div class="order-action-buttons">
            <button class="btn btn-info" onclick="alert('テーブル結合')">テーブル結合</button>
            <button class="btn btn-info" onclick="alert('選択会計')">選択会計</button>
          </div>
          
          <div id="ordersList">
            <div class="loading">読み込み中...</div>
          </div>
          
          <div id="totalSection" class="hidden">
            <div class="order-total">
              <span class="total-label">合計金額:</span>
              <span class="total-amount" id="totalAmount">¥0</span>
            </div>
            <div class="button-row">
              <button class="btn btn-warning" onclick="alert('値引き')">値引き</button>
              <button class="btn btn-primary" onclick="showPaymentModal()">会計処理</button>
            </div>
            <button class="btn btn-secondary" onclick="clearSelection()">テーブル選択に戻る</button>
          </div>
        </div>
      </div>
      
      <div class="section">
        <h2>手動レジ入力</h2>
        <div class="manual-input">
          <div class="input-group">
            <label>テーブル番号</label>
            <select id="manualTable" onchange="updateManualTableSelection()">
              <option value="">選択してください</option>
            </select>
          </div>
          
          <div class="input-group">
            <label>カテゴリ選択</label>
            <select id="manualCategorySelect" onchange="filterManualMenu()">
              <option value="all">全ての商品</option>
            </select>
          </div>
          
          <div class="input-group">
            <label>商品を選択</label>
            <div class="menu-items-list" id="menuItemsList">
              <div class="loading">メニュー読み込み中...</div>
            </div>
          </div>
          
          <div class="selected-items" id="selectedItems">
            <div class="empty-state">商品を選択してください</div>
          </div>
          
          <div class="input-group">
            <label>合計金額: <span id="manualTotal" style="color: #667eea; font-size: 20px;">¥0</span></label>
          </div>
          
          <button class="btn btn-primary" onclick="submitManualOrder()" id="manualSubmitBtn" disabled>注文を追加</button>
        </div>
      </div>
    </div>
  </div>
  
  <div id="toppingModal" class="modal-overlay hidden">
    <div class="modal">
      <h3 id="toppingModalTitle">トッピングを選択</h3>
      <div id="toppingList" class="topping-list"></div>
      <button class="btn btn-primary" onclick="confirmToppingSelection()">カートに追加</button>
      <button class="btn btn-secondary" onclick="closeToppingModal()">キャンセル</button>
    </div>
  </div>
  
  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>支払い方法を選択</h3>
      <div class="payment-methods">
        <button class="payment-method-btn" onclick="selectPaymentMethod('cash')">現金</button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('emoney')">電子マネー</button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('credit')">クレジットカード</button>
      </div>
      
      <div id="cashInputSection" class="cash-input-section hidden">
        <label>お預かり金額</label>
        <input type="number" id="cashReceived" placeholder="0" oninput="calculateChange()">
        <div class="change-display">
          おつり: <span class="change-amount" id="changeAmount">¥0</span>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="completePayment()" id="completePaymentBtn" disabled>会計完了</button>
      <button class="btn btn-secondary" onclick="closePaymentModal()">キャンセル</button>
    </div>
  </div>
  
  <script>
    let selectedTable = null;
    let currentOrders = [];
    let allMenuItems = [];
    let allToppings = new Map();
    let currentToppingSelection = null;
    let selectedToppings = [];
    let manualCart = [];
    let selectedPaymentMethod = null;
    let totalAmountToPay = 0;
    let cashReceived = 0;
    let changeAmount = 0;
    
    const TABLES = [
      '619', '620', '621', '622', '623', '624', '625', '626', '627', '628',
      'T-H', 'T-M', 'c1', 'c2'
    ];
    
    const PRINTER_IP = '192.168.244.41';
    
    window.addEventListener('load', async () => {
      await initializeSystem();
    });
    
    async function initializeSystem() {
      console.log('システム初期化開始...');
      
      try {
        const authenticated = await window.authenticateUser();
        if (authenticated) {
          console.log('認証成功');
        } else {
          console.warn('認証失敗 - 匿名モードで続行');
        }
      } catch (e) {
        console.warn('認証エラー - 匿名モードで続行:', e);
      }
      
      const tableGrid = document.getElementById('tableGrid');
      tableGrid.innerHTML = '';
      TABLES.forEach(table => {
        const btn = document.createElement('button');
        btn.className = 'table-btn';
        btn.textContent = table;
        btn.onclick = () => selectTable(table);
        btn.id = `table-${table}`;
        tableGrid.appendChild(btn);
      });
      
      const manualTable = document.getElementById('manualTable');
      TABLES.forEach(table => {
        const option = document.createElement('option');
        option.value = table;
        option.textContent = `テーブル ${table}`;
        manualTable.appendChild(option);
      });
      
      await loadMenuFromFirebase();
      console.log('初期化完了');
    }
    
    async function loadMenuFromFirebase() {
      const container = document.getElementById('menuItemsList');
      
      try {
        console.log('========== メニュー読み込み開始 ==========');
        container.innerHTML = '<div class="loading">メニューを読み込んでいます...</div>';
        
        // トッピング読み込み
        console.log('1. トッピングを読み込みます...');
        const toppingsSnapshot = await getDocs(collection(db, 'toppings'));
        allToppings.clear();
        
        console.log('   トッピングドキュメント数:', toppingsSnapshot.size);
        
        toppingsSnapshot.forEach(doc => {
          const data = doc.data();
          console.log(`   - トッピングID: ${doc.id}, 名前: ${data.name}, オプション数: ${data.options?.length || 0}`);
          
          allToppings.set(doc.id, {
            id: doc.id,
            name: data.name,
            options: data.options || []
          });
        });
        
        console.log('✓ トッピング読み込み完了:', allToppings.size, '件');
        console.log('   登録されたトッピングID:', Array.from(allToppings.keys()));
        
        // メニュー読み込み
        console.log('2. メニューを読み込みます...');
        const menuSnapshot = await getDocs(collection(db, 'menu'));
        
        if (menuSnapshot.empty) {
          console.error('× menuコレクションが空です');
          container.innerHTML = '<div class="empty-state">メニューデータがありません</div>';
          return;
        }
        
        console.log('   メニュードキュメント数:', menuSnapshot.size);
        
        const items = [];
        const categories = new Set();
        
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          
          console.log(`   - 商品: ${data.name} (ID: ${data.id}, toppingsId: ${data.toppingsId || 'なし'})`);
          
          items.push({
            id: data.id,
            category: data.category,
            name: data.name,
            price: data.price,
            toppingsId: data.toppingsId,
            image: data.image || '',
            note: data.note || ''
          });
          categories.add(data.category);
        });
        
        items.sort((a, b) => a.id - b.id);
        
        allMenuItems = items;
        console.log('✓ メニュー読み込み完了:', items.length, '件');
        
        // カテゴリ選択肢を生成
        const categorySelect = document.getElementById('manualCategorySelect');
        if (categorySelect) {
          categorySelect.innerHTML = '<option value="all">全ての商品</option>';
          
          Array.from(categories).sort().forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            categorySelect.appendChild(option);
          });
        }
        
        displayManualMenuItems(items);
        console.log('✓ メニュー表示完了');
        console.log('========================================');
        
      } catch (e) {
        console.error('× メニュー読み込みエラー:', e.message);
        console.error('   スタックトレース:', e.stack);
        container.innerHTML = `<div class="empty-state" style="color: #f44336;">メニューの読み込みに失敗<br><br>${e.message}</div>`;
      }
    }
    
    window.filterManualMenu = function() {
      const category = document.getElementById('manualCategorySelect').value;
      
      if (category === 'all') {
        displayManualMenuItems(allMenuItems);
      } else {
        const filtered = allMenuItems.filter(item => item.category === category);
        displayManualMenuItems(filtered);
      }
    };
    
    function displayManualMenuItems(items) {
      const container = document.getElementById('menuItemsList');
      
      if (!container) {
        console.error('menuItemsList要素が見つかりません');
        return;
      }
      
      container.innerHTML = '';
      
      if (!items || items.length === 0) {
        container.innerHTML = '<div class="empty-state">商品が見つかりませんでした</div>';
        return;
      }
      
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'menu-item-card';
        div.dataset.menuId = item.id;
        
        div.innerHTML = `
          <div class="menu-item-content">
            <div class="menu-item-name">${item.name}</div>
            <div class="menu-item-price">¥${item.price.toLocaleString()}</div>
          </div>
        `;
        
        div.onclick = () => selectManualItem(item);
        container.appendChild(div);
      });
    }
    
    window.selectManualItem = function(item) {
      console.log('========== 商品選択 ==========');
      console.log('商品名:', item.name);
      console.log('商品ID:', item.id);
      console.log('toppingsId:', item.toppingsId);
      console.log('toppingsIdの型:', typeof item.toppingsId);
      console.log('allToppingsに登録されているキー:', Array.from(allToppings.keys()));
      
      // toppingsIdが存在するかチェック（null、undefined、空文字を除外）
      if (item.toppingsId) {
        const toppingId = String(item.toppingsId).trim();
        console.log('トリミング後のtoppingsId:', toppingId);
        console.log('allToppingsにキーが存在?:', allToppings.has(toppingId));
        
        if (allToppings.has(toppingId)) {
          const toppingData = allToppings.get(toppingId);
          console.log('トッピングデータ:', toppingData);
          console.log('オプション数:', toppingData.options?.length || 0);
          
          if (toppingData && toppingData.options && toppingData.options.length > 0) {
            console.log('✓ トッピングモーダルを表示します');
            currentToppingSelection = item;
            selectedToppings = [];
            showToppingModal(item);
            return;
          } else {
            console.log('× トッピングオプションが空です');
          }
        } else {
          console.log('× トッピングIDがallToppingsに存在しません');
        }
      } else {
        console.log('× toppingsIdがnull/undefined/空です');
      }
      
      console.log('→ トッピングなし - カートに直接追加');
      addToManualCart(item, 'なし', 0);
    };
    
    function showToppingModal(item) {
      console.log('トッピングモーダル表示開始');
      
      const modal = document.getElementById('toppingModal');
      const title = document.getElementById('toppingModalTitle');
      const list = document.getElementById('toppingList');
      
      if (!modal || !title || !list) {
        console.error('モーダル要素が見つかりません');
        return;
      }
      
      title.textContent = `${item.name} - トッピング選択`;
      list.innerHTML = '';
      
      const toppingData = allToppings.get(item.toppingsId);
      
      if (!toppingData || !toppingData.options || toppingData.options.length === 0) {
        console.log('トッピングオプションが空');
        addToManualCart(item, 'なし', 0);
        return;
      }
      
      console.log('  トッピング選択肢数:', toppingData.options.length);
      
      toppingData.options.forEach((option, index) => {
        const div = document.createElement('div');
        div.className = 'topping-item';
        div.dataset.index = index;
        
        const priceText = option.price > 0 ? `+¥${option.price}` : '無料';
        
        div.innerHTML = `
          <span>${option.name}</span>
          <span class="topping-price">${priceText}</span>
        `;
        
        div.onclick = () => toggleTopping(index, option, div);
        list.appendChild(div);
      });
      
      console.log('モーダル表示完了');
      modal.classList.remove('hidden');
    }
    
    function toggleTopping(index, option, element) {
      const existingIndex = selectedToppings.findIndex(t => t.name === option.name);
      
      if (existingIndex >= 0) {
        selectedToppings.splice(existingIndex, 1);
        element.classList.remove('selected');
      } else {
        selectedToppings.push(option);
        element.classList.add('selected');
      }
    }
    
    window.confirmToppingSelection = function() {
      if (!currentToppingSelection) return;
      
      let toppingsText = 'なし';
      let toppingPrice = 0;
      
      if (selectedToppings.length > 0) {
        toppingsText = selectedToppings.map(t => t.name).join(', ');
        toppingPrice = selectedToppings.reduce((sum, t) => sum + (t.price || 0), 0);
      }
      
      addToManualCart(currentToppingSelection, toppingsText, toppingPrice);
      closeToppingModal();
    };
    
    window.closeToppingModal = function() {
      document.getElementById('toppingModal').classList.add('hidden');
      currentToppingSelection = null;
      selectedToppings = [];
    };
    
    function addToManualCart(item, toppings, toppingPrice) {
      const existingIndex = manualCart.findIndex(
        i => i.id === item.id && i.toppings === toppings
      );
      
      if (existingIndex >= 0) {
        manualCart[existingIndex].quantity++;
      } else {
        manualCart.push({
          ...item,
          quantity: 1,
          toppings: toppings,
          toppingPrice: toppingPrice
        });
      }
      
      updateManualCart();
    }
    
    window.updateManualTableSelection = function() {
      updateManualCart();
    };
    
    function updateManualCart() {
      const container = document.getElementById('selectedItems');
      const submitBtn = document.getElementById('manualSubmitBtn');
      const manualTable = document.getElementById('manualTable');
      
      if (manualCart.length === 0) {
        container.innerHTML = '<div class="empty-state">商品を選択してください</div>';
        submitBtn.disabled = true;
        document.getElementById('manualTotal').textContent = '¥0';
        return;
      }
      
      container.innerHTML = '';
      let total = 0;
      
      manualCart.forEach((item, index) => {
        const subtotal = (item.price + item.toppingPrice) * item.quantity;
        total += subtotal;
        
        const div = document.createElement('div');
        div.className = 'selected-item';
        div.innerHTML = `
          <div style="flex: 1;">
            <div style="font-weight: bold;">${item.name}</div>
            <div style="font-size: 13px; color: #666;">トッピング: ${item.toppings}</div>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <input type="number" class="quantity-input" min="1" value="${item.quantity}" 
                   onchange="updateQuantity(${index}, this.value)">
            <button class="remove-btn" onclick="removeFromManualCart(${index})">削除</button>
            <span style="font-weight: bold; min-width: 80px; text-align: right;">¥${subtotal.toLocaleString()}</span>
          </div>
        `;
        container.appendChild(div);
      });
      
      document.getElementById('manualTotal').textContent = `¥${total.toLocaleString()}`;
      submitBtn.disabled = manualCart.length === 0 || !manualTable.value;
    }
    
    window.updateQuantity = function(index, value) {
      const qty = parseInt(value) || 1;
      manualCart[index].quantity = Math.max(1, qty);
      updateManualCart();
    };
    
    window.removeFromManualCart = function(index) {
      manualCart.splice(index, 1);
      updateManualCart();
    };
    
    window.submitManualOrder = async function() {
      const tableNumber = document.getElementById('manualTable').value;
      
      if (!tableNumber || manualCart.length === 0) {
        alert('テーブル番号と商品を選択してください');
        return;
      }
      
      try {
        const now = new Date();
        const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        
        // 本日の開始時刻 (JST 1:00)
        const todayStart = new Date(jstNow);
        todayStart.setHours(1, 0, 0, 0);
        if (jstNow < todayStart) {
          todayStart.setDate(todayStart.getDate() - 1);
        }
        
        // UTCに変換
        const todayStartUTC = new Date(todayStart.getTime() - (9 * 60 * 60 * 1000));
        
        // 本日の最大注文番号を取得
        const ordersSnapshot = await getDocs(collection(db, 'orders'));
        let maxOrderNumber = 618;
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          const orderDate = data.timestamp.toDate();
          
          if (orderDate >= todayStartUTC && data.orderNumber > maxOrderNumber) {
            maxOrderNumber = data.orderNumber;
          }
        });
        
        const orderNumber = maxOrderNumber + 1;
        console.log('新しい注文番号:', orderNumber);
        
        let totalAmount = 0;
        manualCart.forEach(item => {
          totalAmount += (item.price + item.toppingPrice) * item.quantity;
        });
        
        const deleteAt = new Date(now.getTime() + 10 * 60 * 1000);
        
        const orderData = {
          orderNumber: orderNumber,
          timestamp: Timestamp.fromDate(now),
          tableNumber: tableNumber,
          items: manualCart.map(item => ({
            id: item.id,
            name: item.name,
            price: item.price,
            quantity: item.quantity,
            toppings: item.toppings,
            toppingPrice: item.toppingPrice,
            category: item.category
          })),
          totalAmount: totalAmount,
          status: 'pending',
          deleteAt: Timestamp.fromDate(deleteAt),
          cancelledAt: null,
          completedAt: null,
          paidAt: null,
          manualEntry: true
        };
        
        const docRef = await addDoc(collection(db, 'orders'), orderData);
        
        await updateDoc(docRef, {
          orderId: docRef.id
        });
        
        alert(`注文 #${orderNumber} を追加しました！\nテーブル: ${tableNumber}\n合計: ¥${totalAmount.toLocaleString()}`);
        
        manualCart = [];
        document.getElementById('manualTable').value = '';
        updateManualCart();
        
      } catch (e) {
        console.error('注文エラー:', e);
        alert('注文の追加に失敗しました: ' + e.message);
      }
    };
    
    window.selectTable = async function(tableNum) {
      selectedTable = tableNum;
      document.getElementById('selectedTableLabel').textContent = `テーブル ${tableNum}`;
      document.getElementById('orderSection').classList.remove('hidden');
      
      await loadOrders(tableNum);
    };
    
    async function loadOrders(tableNum) {
      const container = document.getElementById('ordersList');
      container.innerHTML = '<div class="loading">読み込み中...</div>';
      
      try {
        const q = query(
          collection(db, 'orders'),
          where('tableNumber', '==', String(tableNum))
        );
        
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
          container.innerHTML = '<div class="empty-state">このテーブルに注文はありません</div>';
          document.getElementById('totalSection').classList.add('hidden');
          return;
        }
        
        container.innerHTML = '';
        currentOrders = [];
        let totalAmount = 0;
        let hasUnpaidOrders = false;
        
        const orders = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          orders.push({ id: doc.id, ...data });
        });
        
        orders.sort((a, b) => {
          const timeA = a.timestamp?.toDate?.() || new Date(0);
          const timeB = b.timestamp?.toDate?.() || new Date(0);
          return timeB - timeA;
        });
        
        orders.forEach(order => {
          if (!order.cancelledAt && !order.paidAt) {
            currentOrders.push(order);
            totalAmount += order.totalAmount;
            hasUnpaidOrders = true;
            
            const card = createOrderCard(order);
            container.appendChild(card);
          }
        });
        
        if (!hasUnpaidOrders) {
          container.innerHTML = '<div class="empty-state">未会計の注文はありません</div>';
          document.getElementById('totalSection').classList.add('hidden');
        } else {
          document.getElementById('totalAmount').textContent = `¥${totalAmount.toLocaleString()}`;
          document.getElementById('totalSection').classList.remove('hidden');
          totalAmountToPay = totalAmount;
        }
        
      } catch (e) {
        console.error('注文読み込みエラー:', e);
        container.innerHTML = `<div class="empty-state">エラーが発生しました<br><small>${e.message}</small></div>`;
      }
    }
    
    function createOrderCard(order) {
      const card = document.createElement('div');
      card.className = 'order-card';
      
      const timestamp = order.timestamp.toDate();
      const timeStr = `${timestamp.getHours()}:${String(timestamp.getMinutes()).padStart(2, '0')}`;
      
      let itemsHtml = '';
      order.items.forEach(item => {
        const subtotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
        
        itemsHtml += `
          <div class="order-item">
            <div>
              <div class="item-name">${item.name}</div>
              <div class="item-details">数量: ${item.quantity}個 | トッピング: ${item.toppings}</div>
            </div>
            <div class="item-price">¥${subtotal.toLocaleString()}</div>
          </div>
        `;
      });
      
      card.innerHTML = `
        <div class="order-header">
          <div>
            <span class="order-number">#${order.orderNumber}</span>
          </div>
          <div class="order-time">${timeStr}</div>
        </div>
        <div class="order-items">
          ${itemsHtml}
        </div>
        <div class="order-total">
          <span class="total-label">小計:</span>
          <span class="total-amount">¥${order.totalAmount.toLocaleString()}</span>
        </div>
      `;
      
      return card;
    }
    
    window.showPaymentModal = function() {
      if (currentOrders.length === 0) {
        alert('会計する注文がありません');
        return;
      }
      
      document.getElementById('paymentModal').classList.remove('hidden');
      selectedPaymentMethod = null;
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('completePaymentBtn').disabled = true;
    };
    
    window.selectPaymentMethod = function(method) {
      selectedPaymentMethod = method;
      
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');
      
      if (method === 'cash') {
        document.getElementById('cashInputSection').classList.remove('hidden');
        document.getElementById('completePaymentBtn').disabled = true;
      } else {
        document.getElementById('cashInputSection').classList.add('hidden');
        document.getElementById('completePaymentBtn').disabled = false;
      }
    };
    
    window.calculateChange = function() {
      cashReceived = parseInt(document.getElementById('cashReceived').value) || 0;
      changeAmount = cashReceived - totalAmountToPay;
      
      document.getElementById('changeAmount').textContent = `¥${changeAmount.toLocaleString()}`;
      document.getElementById('completePaymentBtn').disabled = cashReceived < totalAmountToPay;
    };
    
    window.completePayment = async function() {
      if (!selectedPaymentMethod) {
        alert('支払い方法を選択してください');
        return;
      }
      
      if (selectedPaymentMethod === 'cash' && cashReceived < totalAmountToPay) {
        alert('お預かり金額が不足しています');
        return;
      }
      
      try {
        const now = Timestamp.now();
        
        for (const order of currentOrders) {
          await updateDoc(doc(db, 'orders', order.id), {
            paidAt: now,
            paymentMethod: selectedPaymentMethod
          });
        }
        
        closePaymentModal();
        alert('会計が完了しました！');
        
        await loadOrders(selectedTable);
        
      } catch (e) {
        console.error('会計エラー:', e);
        alert('会計処理に失敗しました: ' + e.message);
      }
    };
    
    window.closePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
      document.getElementById('cashReceived').value = '';
      calculateChange();
    };
    
    window.clearSelection = function() {
      selectedTable = null;
      currentOrders = [];
      document.getElementById('orderSection').classList.add('hidden');
    };
    
    window.openDrawer = async function() {
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        builder.createPeripheralElement({
          channel: 1,
          on: 100,
          off: 100
        });
        
        const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
        
        const trader = new StarWebPrintTrader({url: url});
        trader.onReceive = function(response) {
          console.log('ドロアオープン成功');
        };
        trader.onError = function(response) {
          console.error('ドロアオープンエラー:', response);
          alert('ドロアを開けませんでした');
        };
        
        trader.sendMessage({request: request});
        
      } catch (e) {
        console.error('ドロアオープンエラー:', e);
        alert('エラーが発生しました: ' + e.message);
      }
    };
  </script>
</body>
</html>