<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow, noarchive">
  <meta name="googlebot" content="noindex, nofollow, noarchive">
  <meta name="bingbot" content="noindex, nofollow, noarchive">
  <title>レジシステム</title>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
  <script src="https://www.star-m.jp/products/s_print/sdk/starwebprinttracer/v1.1.0/StarWebPrintTrader.js"></script>
  <script src="https://www.star-m.jp/products/s_print/sdk/starwebprintbuilder/v1.2.0/StarWebPrintBuilder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc, doc, Timestamp, onSnapshot, addDoc, orderBy, getDoc, setDoc, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);
    
    // グローバルに公開
    window.db = db;
    window.storage = storage;
    window.auth = auth;
    window.signOut = signOut;
    window.storageRef = ref;
    window.uploadBytes = uploadBytes;
    window.getDownloadURL = getDownloadURL;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.updateDoc = updateDoc;
    window.doc = doc;
    window.Timestamp = Timestamp;
    window.onSnapshot = onSnapshot;
    window.addDoc = addDoc;
    window.orderBy = orderBy;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.limit = limit;
    window.deleteDoc = deleteDoc;
    
    // 店舗別コレクション参照を取得するヘルパー関数
    window.getStoreCollection = function(collectionName) {
      console.log(' POS getStoreCollection:', collectionName, 'currentStoreId:', window.currentStoreId, 'type:', typeof window.currentStoreId);
      if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
        console.warn('店舗IDが未設定のため、旧データパスを使用します');
        // 旧データパスのマッピング
        const oldPathMap = {
          'menus': 'menu',
          'employees': 'kintai_employees',
          'attendance': 'kintai_attendance'
        };
        const path = oldPathMap[collectionName] || collectionName;
        console.log('  → 旧パス:', path);
        return window.collection(window.db, path);
      }
      console.log('  → 新パス: stores/' + window.currentStoreId + '/' + collectionName);
      return window.collection(window.db, 'stores', window.currentStoreId, collectionName);
    };
    
    // 店舗別ドキュメント参照を取得するヘルパー関数
    window.getStoreDoc = function(collectionName, docId) {
      if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
        console.warn('店舗IDが未設定のため、旧データパスを使用します');
        // 旧データパスのマッピング
        const oldPathMap = {
          'menus': 'menu',
          'employees': 'kintai_employees',
          'attendance': 'kintai_attendance'
        };
        return window.doc(window.db, oldPathMap[collectionName] || collectionName, docId);
      }
      
      return window.doc(window.db, 'stores', window.currentStoreId, collectionName, docId);
    };
    
    // 初期化完了フラグ
    window.firebaseReady = true;
    console.log(' Firebase初期化完了 (Firestore + Storage)');
    
    // 初期化完了イベントを発行
    window.dispatchEvent(new Event('firebaseReady'));
    
    // ========== 営業日選択機能 ==========
    
    // 選択された営業日を保存
    window.selectedBusinessDate = null;
    
    // 日付選択モーダルを表示
    window.showDateSelectionModal = function() {
      // 本日、昨日、一昨日の日付を計算（3時基準）
      const now = new Date();
      let today = new Date(now);
      if (now.getHours() < 3) {
        today.setDate(today.getDate() - 1);
      }
      
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      const dayBeforeYesterday = new Date(today);
      dayBeforeYesterday.setDate(dayBeforeYesterday.getDate() - 2);
      
      // 日付表示を更新
      document.getElementById('todayDateDisplay').textContent = formatDateJP(today);
      document.getElementById('yesterdayDateDisplay').textContent = formatDateJP(yesterday);
      document.getElementById('dayBeforeYesterdayDateDisplay').textContent = formatDateJP(dayBeforeYesterday);
      
      // カスタム日付の初期値を昨日に設定
      document.getElementById('customDateInput').value = formatDateISO(yesterday);
      document.getElementById('customDateInput').max = formatDateISO(today);  // 未来の日付は選択不可
      
      // モーダルを表示
      document.getElementById('dateSelectionModal').style.display = 'flex';
    };
    
    // 営業日を選択
    window.selectBusinessDate = function(type) {
      const now = new Date();
      let today = new Date(now);
      if (now.getHours() < 3) {
        today.setDate(today.getDate() - 1);
      }
      
      let selectedDate;
      
      if (type === 'today') {
        selectedDate = today;
      } else if (type === 'yesterday') {
        selectedDate = new Date(today);
        selectedDate.setDate(selectedDate.getDate() - 1);
      } else if (type === 'dayBeforeYesterday') {
        selectedDate = new Date(today);
        selectedDate.setDate(selectedDate.getDate() - 2);
      } else if (type === 'custom') {
        const customInput = document.getElementById('customDateInput').value;
        if (!customInput) {
          alert('日付を選択してください');
          return;
        }
        selectedDate = new Date(customInput + 'T00:00:00');
      }
      
      // 営業日を保存
      window.selectedBusinessDate = formatDateISO(selectedDate);
      sessionStorage.setItem('businessDate', window.selectedBusinessDate);
      
      console.log('営業日選択:', window.selectedBusinessDate);
      
      // ヘッダーの営業日表示を更新
      updateBusinessDateDisplay();
      
      // モーダルを閉じてメインコンテンツを表示
      document.getElementById('dateSelectionModal').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      
      console.log(' メインコンテンツを表示しました');
      
      // メインコンテンツの表示を待ってから初期化（setTimeoutを使用）
      setTimeout(() => {
        console.log(' 初期化処理開始');
        
        // まずiframeを初期化
        console.log('️ iframe初期化を最優先で実行');
        updateMenuIframe();
        
        // その後、他の初期化処理を実行
        setTimeout(() => {
          if (window.firebaseReady) {
            // iframe以外の初期化処理
            loadStaffList();
            loadReceiptSettings();
            updateInventoryPanel();
            watchInventoryChanges();
          }
        }, 500);
      }, 300);
    };
    
    // 営業日表示を更新
    window.updateBusinessDateDisplay = function() {
      if (!window.selectedBusinessDate) return;
      
      const date = new Date(window.selectedBusinessDate + 'T00:00:00');
      const now = new Date();
      let today = new Date(now);
      if (now.getHours() < 3) {
        today.setDate(today.getDate() - 1);
      }
      
      const todayStr = formatDateISO(today);
      
      let displayText;
      if (window.selectedBusinessDate === todayStr) {
        displayText = '営業日: 本日\n' + formatDateJP(date);
      } else {
        displayText = '営業日:\n' + formatDateJP(date);
      }
      
      // 改行を<br>に変換してHTMLとして設定
      document.getElementById('businessDateText').innerHTML = displayText.replace(/\n/g, '<br>');
    };
    
    // 営業日を変更
    window.changeDateSelection = function() {
      showDateSelectionModal();
    };
    
    // 日付フォーマット（日本語）
    function formatDateJP(date) {
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const weekday = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
      return `${year}年${month}月${day}日 (${weekday})`;
    }
    
    // 日付フォーマット（ISO）
    function formatDateISO(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    // 営業日から日付文字列を取得（売上記録用）
    window.getBusinessDateString = function() {
      if (window.selectedBusinessDate) {
        return window.selectedBusinessDate;
      }
      
      // 選択されていない場合は本日（3時基準）
      const now = new Date();
      let today = new Date(now);
      if (now.getHours() < 3) {
        today.setDate(today.getDate() - 1);
      }
      return formatDateISO(today);
    };
    
    // ========== 営業日選択機能ここまで ==========
    
    // 担当者リストは認証後に読み込む
  </script>
  
  <script>
    // ======================================
    // 外税対応: 価格計算ヘルパー関数
    // ======================================
    
    /**
     * 商品の表示価格を計算（お客様が見る価格）
     */
    function getDisplayPrice(item) {
      const taxType = item.taxType || 'inclusive';
      if (taxType === 'exclusive') {
        return Math.floor(item.price * (1 + (item.taxRate || 10) / 100));
      }
      return item.price;
    }
    
    /**
     * 商品の税抜価格を計算
     */
    function getPreTaxPrice(item) {
      const taxType = item.taxType || 'inclusive';
      if (taxType === 'exclusive') {
        return item.price;
      }
      return Math.floor(item.price / (1 + (item.taxRate || 10) / 100));
    }
    
    /**
     * 商品の税額を計算
     */
    function getTaxAmount(item, quantity = 1) {
      const taxType = item.taxType || 'inclusive';
      const basePrice = item.price + (item.toppingPrice || 0);
      
      // テーブル設定に基づいて適用税率を決定
      const taxRate = getApplicableTaxRate(item, currentTableSettings);
      
      if (taxType === 'exclusive') {
        return Math.floor(basePrice * quantity * taxRate / 100);
      } else {
        const totalWithTax = basePrice * quantity;
        const totalWithoutTax = Math.floor(totalWithTax / (1 + taxRate / 100));
        return totalWithTax - totalWithoutTax;
      }
    }
    
    /**
     * 商品の合計金額を計算（お客様支払い額）
     */
    function getItemTotal(item, quantity = 1) {
      const taxType = item.taxType || 'inclusive';
      const basePrice = item.price + (item.toppingPrice || 0);
      
      // テーブル設定に基づいて適用税率を決定
      const taxRate = getApplicableTaxRate(item, currentTableSettings);
      
      if (taxType === 'exclusive') {
        return Math.floor(basePrice * quantity * (1 + taxRate / 100));
      }
      return basePrice * quantity;
    }
    
    /**
     * 注文全体の合計を計算
     */
    function calculateOrderTotals(items) {
      let total = 0;
      let tax8Total = 0;
      let tax10Total = 0;
      let tax8Inclusive = 0;
      let tax10Inclusive = 0;
      let tax8Exclusive = 0;
      let tax10Exclusive = 0;
      
      items.forEach(item => {
        const quantity = item.quantity || 1;
        const itemTotal = getItemTotal(item, quantity);
        const itemTax = getTaxAmount(item, quantity);
        const taxType = item.taxType || 'inclusive';
        
        // テーブル設定に基づいて適用税率を決定
        const applicableTaxRate = getApplicableTaxRate(item, currentTableSettings);
        
        total += itemTotal;
        
        if (applicableTaxRate === 8) {
          tax8Total += itemTax;
          if (taxType === 'exclusive') {
            tax8Exclusive += itemTax;
          } else {
            tax8Inclusive += itemTax;
          }
        } else {
          tax10Total += itemTax;
          if (taxType === 'exclusive') {
            tax10Exclusive += itemTax;
          } else {
            tax10Inclusive += itemTax;
          }
        }
      });
      
      return {
        total,
        tax8Total,
        tax10Total,
        tax8Inclusive,
        tax10Inclusive,
        tax8Exclusive,
        tax10Exclusive
      };
    }
    
    // 担当者リストを読み込む（kanri.htmlの従業員リストから）
    async function loadStaffList() {
      try {
        const staffSelect = document.getElementById('staffSelect');
        if (!staffSelect) return;
        
        console.log(' 担当者リスト読み込み開始');
        console.log('   window.currentStoreId:', window.currentStoreId);
        console.log('   window.currentStoreName:', window.currentStoreName);
        
        // 店舗別の従業員データを読み込む
        const employeesRef = window.getStoreCollection('employees');
        console.log('   employeesRef:', employeesRef);
        
        const staffSnapshot = await getDocs(employeesRef);
        console.log('   取得した従業員数:', staffSnapshot.size);
        
        // リセット
        staffSelect.innerHTML = '<option value="">選択してください</option>';
        
        // 従業員データを配列に変換
        const employees = [];
        staffSnapshot.forEach(doc => {
          const empData = { id: doc.id, ...doc.data() };
          console.log('   従業員:', empData.name, '(ID:', doc.id + ')');
          employees.push(empData);
        });
        
        if (employees.length === 0) {
          console.warn(' 従業員データが見つかりません！');
          console.warn('   確認してください: Firestore の', window.currentStoreId ? `stores/${window.currentStoreId}/employees` : 'kintai_employees');
        }
        
        // sortOrderでソート（kanri.htmlと同じロジック）
        employees.sort((a, b) => {
          if (a.sortOrder !== undefined && b.sortOrder !== undefined) {
            return a.sortOrder - b.sortOrder;
          }
          if (a.sortOrder !== undefined) return -1;
          if (b.sortOrder !== undefined) return 1;
          return (a.name || '').localeCompare(b.name || '');
        });
        
        // ソート済みの従業員リストをドロップダウンに追加
        employees.forEach(emp => {
          const option = document.createElement('option');
          option.value = emp.name || '';
          option.textContent = emp.name || '';
          staffSelect.appendChild(option);
        });
        
        console.log(' 担当者リスト読み込み完了 (sortOrder順) - 店舗:', window.currentStoreName);
        console.log('   追加した従業員数:', employees.length);
      } catch (e) {
        console.error(' 担当者リスト読み込みエラー:', e);
      }
    }
    
    /**
     * テーブル設定を取得
     */
    async function getTableSettings(tableId) {
      if (!tableId) {
        return null;
      }
      
      try {
        const tableSettingsRef = window.getStoreDoc('tableSettings', tableId);
        const tableDoc = await getDoc(tableSettingsRef);
        
        if (tableDoc.exists()) {
          return tableDoc.data();
        }
        return null;
      } catch (e) {
        console.error('テーブル設定取得エラー:', e);
        return null;
      }
    }
    
    /**
     * 商品の適用税率を決定（テーブル設定とfoodTypeを考慮）
     *  改善: テーブル設定（takeout/dine-in）が有効な場合、商品のtaxRateよりもfoodTypeを優先
     */
    function getApplicableTaxRate(item, tableSettings) {
      //  特別処理: レジ袋は常に10%（最優先）
      if (item.name?.includes('レジ袋') || item.name?.includes('️') || item.name?.includes('袋')) {
        console.log(` レジ袋判定: ${item.name} → 強制的に10%`);
        return 10;
      }
      
      // foodTypeを決定（未設定の場合はcategoryから推測）
      let foodType = item.foodType;
      if (!foodType) {
        // カテゴリが「包材」または商品名に「包材」を含む場合は食材以外
        if (item.category === '包材' || item.name?.includes('包材')) {
          foodType = 'non-food';
          console.log(`foodType未設定 → category/name(${item.category}/${item.name})から推測: non-food（食材以外）`);
        } else {
          foodType = 'food';  // デフォルトは食材
          console.log(`foodType未設定 → デフォルト: food（食材）, 商品名: ${item.name}`);
        }
      } else {
        console.log(`foodType設定済み: ${foodType} (商品: ${item.name})`);
      }
      
      //  改善: テーブル設定が有効（takeout/dine-in）な場合、foodTypeを優先
      if (tableSettings && tableSettings.taxRule && tableSettings.taxRule !== 'none') {
        const taxRule = tableSettings.taxRule;
        console.log(`[税率決定] 商品: ${item.name}, foodType: ${foodType}, taxRule: ${taxRule}`);
        
        switch(taxRule) {
          case 'takeout':
            // テイクアウト: 食材は8%、食材以外は10%
            const takeoutRate = (foodType === 'food') ? 8 : 10;
            console.log(`  → テイクアウトモード: ${foodType === 'food' ? '食材(8%)' : '食材以外(10%)'} = ${takeoutRate}%`);
            return takeoutRate;
          
          case 'dine-in':
            // 店内飲食及び食材以外: 全部10%
            console.log(`  → 店内飲食及び食材以外モード: 10%`);
            return 10;
          
          default:
            // 不明なtaxRule: 商品のtaxRateを優先、未設定ならfoodTypeから推測
            if (item.taxRate !== undefined && item.taxRate !== null) {
              console.log(`  → 不明なtaxRule: ${taxRule} → 商品のtaxRate: ${item.taxRate}%`);
              return item.taxRate;
            }
            const defaultRate = (foodType === 'non-food') ? 10 : 8;
            console.log(`  → 不明なtaxRule: ${taxRule}, taxRate未設定 → foodType(${foodType})から: ${defaultRate}%`);
            return defaultRate;
        }
      }
      
      // テーブル設定がない、またはtaxRuleが'none'の場合は商品のデフォルト税率を使用
      // 商品のtaxRateを優先使用
      if (item.taxRate !== undefined && item.taxRate !== null) {
        console.log(`[税率決定] テーブル設定なし → 商品のtaxRate: ${item.taxRate}%`);
        return item.taxRate;
      }
      
      // taxRateがない場合、foodTypeから推測（食材:8%, 食材以外:10%）
      const inferredRate = (foodType === 'non-food') ? 10 : 8;
      console.log(`[税率決定] テーブル設定なし、taxRate未設定 → foodType(${foodType})から推測: ${inferredRate}%`);
      return inferredRate;
    }
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .header-left h1 {
      font-size: 32px;
      color: #333;
      margin-bottom: 5px;
    }
    
    .header-left .status {
      font-size: 18px;
      color: #666;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .header-right {
      display: flex;
      align-items: flex-start;
      gap: 15px;
    }
    
    .auto-print-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f8f9fa;
      padding: 12px 20px;
      border-radius: 12px;
    }
    
    .auto-print-toggle label {
      font-weight: bold;
      color: #333;
    }
    
    .toggle-switch {
      position: relative;
      width: 60px;
      height: 30px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 30px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: #4CAF50;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(30px);
    }
    
    .toggle-status {
      font-weight: bold;
      min-width: 50px;
    }
    
    .toggle-status.on {
      color: #4CAF50;
    }
    
    .toggle-status.off {
      color: #999;
    }
    
    .main-content {
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    
    @media (max-width: 1024px) {
      .main-content {
        flex-direction: column;
      }
      
      .header {
        flex-direction: column;
        gap: 15px;
      }
    }
    
    .section {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }
    
    .section h2 {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #667eea;
    }
    
    /* テーブルボタングリッド */
    .table-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }
    
    @media (max-width: 768px) {
      .table-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    .table-btn {
      padding: 10px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      position: relative;
      min-height: 50px;
    }
    
    .table-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    .table-btn:active {
      transform: translateY(0);
    }
    
    .table-btn.has-orders {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
    }
    
    .order-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ff4444;
      color: white;
      font-size: 12px;
      font-weight: bold;
      min-width: 24px;
      height: 24px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
      animation: pulse 1.5s infinite;
      box-shadow: 0 2px 8px rgba(255, 68, 68, 0.5);
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }
    
    /* 注文詳細 */
    .order-details {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .order-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-left: 5px solid #667eea;
    }
    
    .order-card.completed {
      border-left-color: #4CAF50;
      opacity: 0.7;
    }
    
    .order-card.cancelled {
      border-left-color: #f44336;
      opacity: 0.7;
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .order-number {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    
    .order-time {
      font-size: 14px;
      color: #999;
    }
    
    .order-status {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      margin-left: 10px;
    }
    
    .order-status.pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .order-status.completed {
      background: #d4edda;
      color: #155724;
    }
    
    .order-status.cancelled {
      background: #f8d7da;
      color: #721c24;
    }
    
    .order-items {
      margin: 15px 0;
    }
    
    .order-item {
      padding: 10px 0;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .order-item:last-child {
      border-bottom: none;
    }
    
    .order-item-detailed {
      padding: 15px;
      margin-bottom: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }
    
    .item-name {
      font-weight: 500;
      color: #333;
    }
    
    .item-details {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    
    .item-price {
      font-weight: bold;
      color: #667eea;
    }
    
    .order-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 3px solid #667eea;
      font-size: 24px;
      font-weight: bold;
    }
    
    .total-label {
      color: #333;
    }
    
    .total-amount {
      color: #667eea;
      font-size: 28px;
    }
    
    /* 注文アクションボタン */
    .order-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px dashed #ddd;
    }
    
    .order-action-btn {
      padding: 12px;
      font-size: 14px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .order-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .pay-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .complete-btn {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    .cancel-btn {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
    }
    
    .delete-btn {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
    }
    
    /* ボタン */
    .btn {
      width: 100%;
      padding: 18px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      margin: 8px 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
      color: white;
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* 手動入力セクション */
    .manual-input {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-group label {
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }
    
    .input-group input,
    .input-group select {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      transition: border-color 0.3s;
    }
    
    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .menu-items-list {
      max-height: 300px;
      overflow-y: auto;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      background: white;
    }
    
    .menu-item-checkbox {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .menu-item-checkbox:hover {
      background: #f0f0f0;
    }
    
    .menu-item-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      cursor: pointer;
    }
    
    .menu-item-info {
      flex: 1;
    }
    
    .menu-item-name-small {
      font-weight: 500;
      color: #333;
    }
    
    .menu-item-price-small {
      color: #667eea;
      font-weight: bold;
    }
    
    .selected-items {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .selected-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .selected-item-detailed {
      padding: 15px;
      margin-bottom: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }
    
    .quantity-input {
      width: 60px;
      padding: 5px;
      text-align: center;
      border: 2px solid #ddd;
      border-radius: 5px;
    }
    
    .remove-btn {
      padding: 5px 12px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .edit-btn {
      padding: 5px 12px;
      background: #FF9800;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .edit-btn:hover {
      background: #F57C00;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 18px;
    }
    
    /* 支払い方法選択モーダル */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    }
    
    .modal h3 {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .payment-methods {
      display: grid;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .payment-method-btn {
      padding: 20px;
      font-size: 20px;
      font-weight: bold;
      border: 3px solid #ddd;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .payment-method-btn:hover {
      border-color: #667eea;
      background: #f8f9fa;
    }
    
    .payment-method-btn.selected {
      border-color: #667eea;
      background: #e8eaf6;
    }
    
    .cash-input-section {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    
    .cash-input-section label {
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
      font-size: 18px;
    }
    
    .cash-input-section input {
      width: 100%;
      padding: 15px;
      font-size: 24px;
      border: 2px solid #ddd;
      border-radius: 8px;
      text-align: right;
    }
    
    .change-display {
      margin-top: 15px;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    
    .change-amount {
      color: #4CAF50;
      font-size: 28px;
    }
    
    /* レシート完了画面 */
    .receipt-actions {
      display: grid;
      gap: 15px;
      margin-top: 20px;
    }
    
    .receipt-btn {
      padding: 20px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .receipt-btn.print {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
    }
    
    .receipt-btn.invoice {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
    }
    
    .receipt-btn.back {
      background: #e0e0e0;
      color: #333;
    }
    
    /* トッピング選択 */
    .topping-item {
      display: flex;
      align-items: center;
      padding: 15px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .topping-item:hover {
      border-color: #667eea;
      transform: translateX(5px);
    }
    
    .topping-item input[type="checkbox"] {
      width: 24px;
      height: 24px;
      margin-right: 15px;
      cursor: pointer;
    }
    
    .topping-item-info {
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .topping-item-name {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
    
    .topping-item-price {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
    }
    
    .hidden {
      display: none !important;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    /* カスタムアラート */
    .custom-alert-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 99999;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s;
    }
    .custom-alert-overlay.show {
      display: flex;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .custom-alert-box {
      background: white;
      border-radius: 25px;
      padding: 40px 30px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.4s;
    }
    .custom-alert-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: bounce 0.6s;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .custom-alert-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
    }
    .custom-alert-message {
      font-size: 16px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .custom-alert-button {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border: none;
      padding: 15px 50px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 25px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
      transition: all 0.3s;
    }
    .custom-alert-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
    }
    .custom-alert-button:active {
      transform: translateY(0);
    }
    
    /* 品切れページ用スタイル */
    .soldout-item {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .soldout-item.sold-out {
      background: #f5f5f5;
      opacity: 0.7;
    }
    .soldout-item-name {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
    .soldout-badge {
      background: #f44336;
      color: white;
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: bold;
      margin-top: 5px;
      display: inline-block;
    }
    .soldout-toggle-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      color: white;
    }
    .soldout-toggle-btn.set-soldout {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    }
    .soldout-toggle-btn.set-available {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    }
    
    /* トーストアニメーション */
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
    
    /* カスタム確認モーダル */
    .custom-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    
    .custom-modal-box {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .modal-icon {
      font-size: 64px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 15px;
      color: #333;
    }
    
    .modal-message {
      text-align: center;
      font-size: 16px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.6;
    }
    
    .modal-buttons {
      display: flex;
      gap: 15px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 18px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .modal-btn:active {
      transform: scale(0.95);
    }
    
    .modal-btn-cancel {
      background: #e0e0e0;
      color: #333;
    }
    
    .modal-btn-cancel:hover {
      background: #d0d0d0;
    }
    
    .modal-btn-danger {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
    }
    
    .modal-btn-warning {
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      color: white;
    }
    
    .modal-btn-success {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
  </style>
  
  <script>
    // タップ音を再生する関数
    function playBeep() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800; // 800Hzのビープ音
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    }
    
    // クリックイベントにビープ音を追加
    document.addEventListener('DOMContentLoaded', function() {
      document.addEventListener('click', function(e) {
        // ボタン、チェックボックス、.table-btn、.menu-item-checkbox、.topping-itemをクリックしたらビープ音
        if (e.target.closest('button') || 
            e.target.closest('.table-btn') || 
            e.target.closest('.menu-item-checkbox') || 
            e.target.closest('.topping-item') ||
            e.target.type === 'checkbox') {
          playBeep();
        }
      });
    });
  </script>
</head>
<body>
  
  <div id="loginScreen" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
      <div style="text-align: center; margin-bottom: 30px;">
        <div style="font-size: 60px; margin-bottom: 10px;"></div>
        <h2 style="font-size: 24px; font-weight: bold; color: #333; margin: 0;">POSシステム</h2>
        <p style="color: #666; margin-top: 10px;">店舗情報を入力してください</p>
      </div>
      
      <form id="posLoginForm" style="margin: 0;">
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #333; font-weight: bold; margin-bottom: 8px; font-size: 14px;">店舗名</label>
          <input
            type="text"
            id="posStoreNameInput"
            placeholder="店舗名を入力"
            style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box;"
            required
            autofocus
          />
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #333; font-weight: bold; margin-bottom: 8px; font-size: 14px;">パスワード</label>
          <input
            type="password"
            id="posPasswordInput"
            placeholder="パスワードを入力"
            style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box;"
            required
          />
        </div>
        
        <button
          type="submit"
          style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s;"
          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 30px rgba(102,126,234,0.4)';"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
        >
          ログイン
        </button>
      </form>
      
      <div id="loginError" style="display: none; margin-top: 20px; padding: 15px; background: #fee; border: 1px solid #fcc; border-radius: 10px; color: #c00; text-align: center; font-weight: bold;">
      </div>
    </div>
  </div>
  
  <!-- 日付選択モーダル -->
  <div id="dateSelectionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 500px; width: 90%;">
      <div style="text-align: center; margin-bottom: 30px;">
        <div style="font-size: 60px; margin-bottom: 10px;"></div>
        <h2 style="font-size: 28px; font-weight: bold; color: #333; margin: 0;">営業日を選択</h2>
        <p style="color: #666; margin-top: 10px;">本日または過去の日付を選択してください</p>
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 15px;">
        <!-- 本日ボタン -->
        <button onclick="selectBusinessDate('today')" style="padding: 20px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(76,175,80,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(76,175,80,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(76,175,80,0.3)';">
          本日 <span id="todayDateDisplay" style="font-size: 16px; opacity: 0.9;"></span>
        </button>
        
        <!-- 昨日ボタン -->
        <button onclick="selectBusinessDate('yesterday')" style="padding: 20px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(33,150,243,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(33,150,243,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(33,150,243,0.3)';">
           昨日 <span id="yesterdayDateDisplay" style="font-size: 16px; opacity: 0.9;"></span>
        </button>
        
        <!-- 一昨日ボタン -->
        <button onclick="selectBusinessDate('dayBeforeYesterday')" style="padding: 20px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(255,152,0,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(255,152,0,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255,152,0,0.3)';">
          一昨日 <span id="dayBeforeYesterdayDateDisplay" style="font-size: 16px; opacity: 0.9;"></span>
        </button>
        
        <!-- カスタム日付 -->
        <div style="margin-top: 10px;">
          <label style="display: block; color: #333; font-weight: bold; margin-bottom: 8px; font-size: 14px;">その他の日付</label>
          <div style="display: flex; gap: 10px;">
            <input type="date" id="customDateInput" style="flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px;" />
            <button onclick="selectBusinessDate('custom')" style="padding: 15px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer;">選択</button>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 10px; font-size: 14px; color: #856404;">
        <strong>注意:</strong> 過去の日付を選択すると、その日の売上として記録されます
      </div>
    </div>
  </div>
  
  <div id="mainContent" style="display: none;">
  <div class="container">
    
    <div class="header">
      <div class="header-left">
        <div class="status">
          <!-- 営業日表示 -->
          <div id="businessDateDisplay" style="padding: 10px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-weight: bold; margin-right: 15px; font-size: 14px; cursor: pointer; line-height: 1.4; text-align: center; width: 280px; box-sizing: border-box; display: flex; align-items: center; justify-content: center;" onclick="changeDateSelection()">
            <span id="businessDateText">営業日:<br>読み込み中...</span>
          </div>
          
          <div style="display: flex; align-items: center; width: 280px; min-height: 44px;">
            <label for="staffSelect" style="margin-right: 10px; font-weight: bold; white-space: nowrap;">担当者:</label>
            <select id="staffSelect" style="padding: 10px 12px; font-size: 16px; border: 2px solid #667eea; border-radius: 8px; background: white; cursor: pointer; flex: 1; box-sizing: border-box;">
              <option value="">選択してください</option>
            </select>
          </div>
        </div>
      </div>
      <div class="header-right" style="display: flex; gap: 15px; align-items: flex-start;">
        
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <button onclick="window.location.href='https://gymnastmasaki-lang.github.io/takoyaki-/kintai.html'" style="padding: 10px 45px; font-size: 16px; background: linear-gradient(135deg, #3F51B5 0%, #303F9F 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: space-evenly; line-height: 1.2; height: 122px; box-sizing: border-box;">
            <div style="font-size: 26px; margin-bottom: 2px;"></div>
            <div style="font-size: 15px;">勤怠</div>
          </button>
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          
          <div style="display: flex; gap: 10px;">
            <button onclick="increaseWaiting()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">待増</button>
            <button id="time-override-btn" onclick="toggleTimeOverride()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">時外</button>
            <button onclick="window.open('https://gymnastmasaki-lang.github.io/takoyaki-/order.html', '_blank')" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">発注</button>
            <button onclick="showPrinterSettings()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">プリンターの設定</button>
          </div>
          
          <div style="display: flex; gap: 10px;">
            <button onclick="showMonthlyReportModal()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">月次</button>
            <button onclick="showSalesModal()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">売上</button>
            <button onclick="showHistoryModal()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">履歴</button>
            <button onclick="showExpenseModal()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #FF5722 0%, #E64A19 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">支出</button>
            <button onclick="openDrawer()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #FFC107 0%, #FFA000 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(255,193,7,0.3);">開く</button>
          </div>
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <button onclick="window.open('https://gymnastmasaki-lang.github.io/takoyaki-/kanri.html', '_blank')" style="padding: 12px 40px; font-size: 16px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">設定•管理</button>
          <button onclick="handleLogout()" style="padding: 12px 40px; font-size: 16px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">ログアウト</button>
        </div>
      </div>
    </div>
    
    <div class="main-content">
      
      <div class="section">
        <!-- 固定ボタン（1行目：4列） -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
          
          <div style="background: linear-gradient(135deg, #81C784 0%, #66BB6A 100%); padding: 10px 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px;">
            <label style="margin: 0; white-space: nowrap; font-size: 13px; font-weight: bold; color: white;">レシート自動発行</label>
            <div style="display: flex; align-items: center; gap: 8px;">
              <label class="toggle-switch" style="margin: 0;">
                <input type="checkbox" id="autoPrintToggle" onchange="toggleAutoPrint()">
                <span class="toggle-slider"></span>
              </label>
              <span class="toggle-status off" id="autoPrintStatus" style="margin: 0; font-size: 13px; font-weight: bold; color: white;">OFF</span>
            </div>
          </div>
          <div style="background: linear-gradient(135deg, #FFB74D 0%, #FFA726 100%); padding: 10px 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px;">
            <div style="font-size: 13px; font-weight: bold; color: white;">手動待ち人数</div>
            <div style="font-size: 24px; font-weight: bold; color: white;" id="manual-count">0</div>
            <button onclick="resetWaiting()" style="padding: 6px 15px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; white-space: nowrap;">リセット</button>
          </div>
          <!-- 即会計ボタン -->
          <button onclick="quickCheckout()" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); padding: 15px; font-size: 16px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center;">
            即会計
          </button>
          <!-- テイクアウトボタンがここに追加される -->
        </div>
        
        <!-- テーブル選択（2行目以降：4列） -->
        <div id="tableButtonsGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
          <!-- 動的テーブルボタンがここに追加されます -->
        </div>
        
        <div class="table-grid" id="tableGrid" style="display: none;">
          
        </div>
        </div>
        
        <div id="orderSection" class="hidden">
          <h2>注文詳細 - <span id="selectedTableLabel"></span></h2>
          <div id="ordersList">
            <div class="loading">読み込み中...</div>
          </div>
          
          <div id="totalSection" class="hidden">
            <div class="order-total">
              <span class="total-label">合計金額:</span>
              <span class="total-amount" id="totalAmount">¥0</span>
            </div>
            <button class="btn btn-primary" onclick="showPaymentModal()">会計処理</button>
            <button class="btn" onclick="window.printBill()" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; font-weight: bold;">お会計伝票</button>
            <button class="btn btn-secondary" onclick="clearSelection()">← テーブル選択に戻る</button>
          </div>
        </div>
      </div>
      
      <div style="height: 30px;"></div>
      <div class="section">
        <!-- 手動レジ入力 -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; align-items: start;">
          
          <div>
            <!-- menu.htmlをiframeで埋め込み -->
            <div class="input-group" style="display: flex; flex-direction: column; height: 100%;">
              <label>商品を選択</label>
              <iframe 
                id="menuIframe"
                src=""
                style="
                  flex: 1; 
                  min-height: 700px; 
                  width: 100%; 
                  border: 2px solid #667eea; 
                  border-radius: 8px;
                  background: white;
                "
                frameborder="0"
              ></iframe>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; height: 100%;">
            <div class="selected-items" id="selectedItems" style="flex: 1; min-height: 400px; overflow-y: auto;"></div>
            
            <div class="input-group" style="margin-top: 15px;">
              <label>テーブル番号</label>
              <select id="manualTable">
                <option value="">選択してください</option>
              </select>
            </div>
            
            <div class="input-group" style="margin-top: 15px;">
              <label>合計金額: <span id="manualTotal" style="color: #667eea; font-size: 20px;">¥0</span></label>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button class="btn btn-primary" onclick="submitManualOrder()" id="manualSubmitBtn" disabled style="flex: 1;">テーブルに追加</button>
              <button class="btn btn-success" onclick="directPayment()" id="directPaymentBtn" disabled style="flex: 1; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">即会計</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>支払い方法を選択</h3>
      <div id="taxRateSection" style="margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px; border-left: 4px solid #4CAF50; max-height: 200px; overflow-y: auto;">
        <h4 style="margin: 0 0 15px 0; color: #2e7d32; font-size: 16px;">各商品の税率を選択</h4>
        <div id="taxRateItemsList"></div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #4CAF50; font-weight: bold; font-size: 14px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>8%対象:</span>
            <span id="tax8Summary" style="color: #FF9800;">¥0</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>10%対象:</span>
            <span id="tax10Summary" style="color: #2196F3;">¥0</span>
          </div>
        </div>
      </div>
      
      <div class="payment-methods">
        <button class="payment-method-btn" onclick="selectPaymentMethod('cash')">
          現金
        </button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('emoney')">
          電子マネー
        </button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('credit')">
          クレジットカード
        </button>
      </div>
      
      <div id="cashInputSection" class="cash-input-section hidden">
        <label>お預かり金額</label>
        <input type="number" id="cashReceived" placeholder="0" oninput="calculateChange()">
        <div class="change-display" id="changeDisplay">
          おつり: <span class="change-amount" id="changeAmount">¥0</span>
        </div>
      </div>
      <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 10px;">
        <label style="font-weight: bold; color: #856404;">値引き金額</label>
        <input type="number" id="discountAmount" placeholder="0" value="0" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ffc107; border-radius: 8px; margin-top: 8px;" oninput="updatePaymentTotal()">
        <div style="text-align: center; margin-top: 10px; font-size: 18px; font-weight: bold; color: #333;">
          請求額: <span id="finalPaymentAmount" style="color: #4CAF50;">¥0</span>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="completePayment()" id="completePaymentBtn" disabled>会計完了</button>
      <button class="btn btn-secondary" onclick="closePaymentModal()">キャンセル</button>
    </div>
  </div>
  <div id="receiptCompleteModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>会計完了</h3>
      <div style="text-align: center; margin: 20px 0; font-size: 18px; color: #4CAF50;">
        会計が完了しました
      </div>
      <div class="receipt-actions">
        <button class="receipt-btn print" onclick="printReceipt()">レシート発行</button>
        <button class="receipt-btn invoice" onclick="printInvoice()">領収書発行</button>
        <button class="receipt-btn back" onclick="closeReceiptModal()">← 戻る</button>
      </div>
    </div>
  </div>
  <div id="toppingModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>トッピングを選択</h3>
      <div id="toppingModalItemName" style="font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #667eea;"></div>
      
      <!-- 数量選択 -->
      <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
        <span style="font-size: 16px; font-weight: bold; color: #333;">数量:</span>
        <button onclick="decrementToppingQuantity()" style="width: 40px; height: 40px; border-radius: 50%; background: #dc3545; color: white; border: none; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold;">−</button>
        <span id="toppingQuantityDisplay" style="font-size: 28px; font-weight: bold; min-width: 50px; text-align: center; color: #667eea;">1</span>
        <button onclick="incrementToppingQuantity()" style="width: 40px; height: 40px; border-radius: 50%; background: #28a745; color: white; border: none; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold;">+</button>
      </div>
      
      <div id="toppingsList" style="max-height: 400px; overflow-y: auto;">
        
      </div>
      <button class="btn btn-primary" onclick="confirmTopping()">決定</button>
      <button class="btn btn-secondary" onclick="closeToppingModal()">キャンセル</button>
    </div>
  </div>
  <div id="historyModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h3>注文履歴</h3>
      
      <div style="margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap;">
        <select id="historyDateFilter" onchange="filterHistory()" style="padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
          <option value="today">今日</option>
          <option value="yesterday">昨日</option>
          <option value="week">今週</option>
          <option value="month">今月</option>
          <option value="all">全期間</option>
        </select>
        
        <select id="historyStatusFilter" onchange="filterHistory()" style="padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
          <option value="all">すべて</option>
          <option value="deleted">削除済み</option>
          <option value="paid">会計済み</option>
          <option value="completed">完了</option>
          <option value="cancelled">キャンセル</option>
        </select>
        
        <button onclick="refreshHistory()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;"> 更新</button>
      </div>
      
      <div id="historyList" style="max-height: 60vh; overflow-y: auto;">
        
      </div>
      
      <button class="btn btn-secondary" onclick="closeHistoryModal()">閉じる</button>
    </div>
  </div>
  <div id="customerCountModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 600px;">
      <h3>本日の客数</h3>
      
      <div id="customerCountContent" style="padding: 20px;">
        
      </div>
      
      <button class="btn btn-secondary" onclick="closeCustomerCountModal()">閉じる</button>
    </div>
  </div>
  <div id="salesModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 700px;">
      <h3 id="salesModalTitle">本日の売上</h3>
      
      <div style="margin: 20px 0; display: flex; justify-content: flex-end;">
        <button onclick="showSettlementModal()" style="padding: 10px 20px; background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;"> 精算</button>
      </div>
      
      <div id="salesContent">
        
      </div>
      
      <button class="btn btn-secondary" onclick="closeSalesModal()">閉じる</button>
    </div>
  </div>
  <div id="settlementModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 500px;">
      <h3 style="color: #ff6b6b;"> 精算確認</h3>
      
      <div style="margin: 20px 0; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
        <p style="margin: 0 0 10px 0; font-weight: bold; color: #856404;">注意事項:</p>
        <ul style="margin: 0; padding-left: 20px; color: #856404;">
          <li>本日の売上データを確定します</li>
          <li>精算ジャーナル（PNG画像）をダウンロードします</li>
          <li>売上は午前3時に自動的にリセットされます</li>
        </ul>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">精算日付を選択</label>
        <input type="date" id="settlementDate" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
        <p style="font-size: 12px; color: #666; margin-top: 5px;">※ 昨日の精算を上げ忘れた場合など、過去の日付を選択できます</p>
      </div>
      
      <div id="settlementSummary" style="margin: 20px 0;">
        
      </div>
      
      <button class="btn" style="width: 100%; background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%); color: white; margin-bottom: 10px;" onclick="confirmSettlement()">精算を実行</button>
      <button class="btn" style="width: 100%; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; margin-bottom: 10px;" onclick="generateDailyReport()">日計表出力</button>
      <button class="btn" style="width: 100%; background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); color: white; margin-bottom: 10px;" onclick="window.open('arari.html', '_blank')">納税額/粗利早見表</button>
      <button class="btn btn-secondary" onclick="closeSettlementModal()">キャンセル</button>
    </div>
  </div>
  <div id="expenseModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h3 style="color: #f093fb;">支出入力</h3>
      
      <div style="margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; gap: 15px;">
        <label style="font-weight: bold; font-size: 16px;">日付:</label>
        <input type="date" id="expenseDateInput" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 16px; flex: 1;" onchange="loadExpensesByDate()" />
      </div>
      
      <div style="margin: 20px 0;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f5f5f5;">
              <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">店名</th>
              <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">勘定科目</th>
              <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">詳細</th>
              <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">金額</th>
              <th style="padding: 10px; border: 1px solid #ddd; width: 60px;"></th>
            </tr>
          </thead>
          <tbody id="expenseTableBody">
            
          </tbody>
        </table>
        
        <button class="btn" style="margin-top: 10px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="addExpenseRow()">＋ 行を追加</button>
        
        <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; text-align: right;">
          <span style="font-size: 18px; font-weight: bold;">合計: ¥</span>
          <span id="expenseTotal" style="font-size: 24px; font-weight: bold; color: #f093fb;">0</span>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn" style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="saveExpenses()">保存</button>
        <button class="btn" style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="exportExpensesToCSV()">本日分出力</button>
        <button class="btn" style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white;" onclick="showExpenseExportModal()">経費出力</button>
        <button class="btn" style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;" onclick="window.open('https://gymnastmasaki-lang.github.io/takoyaki-/receipt.html', '_blank')">領収書管理</button>
        <button class="btn btn-secondary" style="flex: 1; min-width: 150px;" onclick="closeExpenseModal()">閉じる</button>
      </div>
    </div>
  </div>
  <div id="monthlyReportModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <h3>月次レポート</h3>
      
      <div style="margin: 20px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">開始日</label>
          <input type="date" id="reportStartDate" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
        </div>
        
        <div style="flex: 1; min-width: 200px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">終了日</label>
          <input type="date" id="reportEndDate" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
        </div>
        
        <button onclick="generatePeriodJournal()" style="padding: 12px 24px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px;">ジャーナル生成</button>
      </div>
      
      <div id="monthlyReportContent">
        
      </div>
      
      <!-- グラフエリア -->
      <div id="monthlyChartsArea" style="margin-top: 30px; display: none;">
        <h4 style="margin-bottom: 20px; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px;">月次推移グラフ</h4>
        
        <!-- 売上推移グラフ -->
        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <h5 style="margin-bottom: 15px; color: #4CAF50;">売上推移</h5>
          <canvas id="salesTrendChart" style="max-height: 300px;"></canvas>
        </div>
        
        <!-- 人件費率推移グラフ -->
        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <h5 style="margin-bottom: 15px; color: #FF9800;">人件費率推移（目標35%）</h5>
          <canvas id="laborCostRateChart" style="max-height: 300px;"></canvas>
        </div>
        
        <!-- 粗利率推移グラフ -->
        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <h5 style="margin-bottom: 15px; color: #2196F3;">粗利率推移（売上 - 人件費）</h5>
          <canvas id="profitRateChart" style="max-height: 300px;"></canvas>
        </div>
        
        <!-- 純利益率推移グラフ -->
        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <h5 style="margin-bottom: 15px; color: #9C27B0;">純利益率推移（売上 - 人件費 - 支出）</h5>
          <canvas id="netProfitRateChart" style="max-height: 300px;"></canvas>
        </div>
        
        <!-- 数値表 -->
        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <h5 style="margin-bottom: 15px; color: #333;"> 詳細数値</h5>
          <table id="monthlyDataTable" style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <th style="padding: 12px; text-align: center; border: 2px solid #555;">月</th>
                <th style="padding: 12px; text-align: right; border: 2px solid #555;">売上</th>
                <th style="padding: 12px; text-align: right; border: 2px solid #555;">人件費</th>
                <th style="padding: 12px; text-align: right; border: 2px solid #555;">人件費率</th>
                <th style="padding: 12px; text-align: right; border: 2px solid #555;">支出</th>
                <th style="padding: 12px; text-align: right; border: 2px solid #555;">粗利</th>
                <th style="padding: 12px; text-align: right; border: 2px solid #555;">粗利率</th>
                <th style="padding: 12px; text-align: right; border: 2px solid #555;">純利益</th>
                <th style="padding: 12px; text-align: right; border: 2px solid #555;">純利益率</th>
              </tr>
            </thead>
            <tbody id="monthlyDataTableBody">
              <!-- JavaScriptで動的に生成 -->
            </tbody>
          </table>
        </div>
      </div>
      
      <button class="btn btn-secondary" onclick="closeMonthlyReportModal()">閉じる</button>
    </div>
  </div>
  <div id="editOrderModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
      <h3>️ 注文編集</h3>
      
      <div id="editOrderContent" style="margin: 20px 0;">
        
      </div>
      
      <div id="editOrderButtons" style="display: flex; gap: 10px; margin-top: 20px;">
        
      </div>
    </div>
  </div>
  <script>
    let selectedTable = null;
    let currentTableSettings = null;  // 現在のテーブル設定
    let currentOrders = [];
    let isDirectPaymentMode = false;  // 即会計モードフラグ
    let menuItems = [];
    let manualCart = [];
    let selectedPaymentMethod = null;
    let totalAmountToPay = 0;
    let cashReceived = 0;
    let changeAmount = 0;
    let lastPaymentData = null;
    
    let allMenuItems = [];
    let isBulkSoldOut = false;
    
    // 音声通知用
    let audioEnabled = false;
    let lastOrderCount = 0;
    let isFirstOrderLoad = true;
    
    // プリンター設定（localStorageから読み込み）
    let PRINTER_IP = localStorage.getItem('printerIP') || '192.168.1.100';  // デフォルトIPアドレス
    let PRINTER_CONNECTION_TYPE = localStorage.getItem('printerConnectionType') || 'ethernet'; // ethernet or bluetooth
    let BLUETOOTH_DEVICE = null; // Bluetoothデバイス
    let BLUETOOTH_CHARACTERISTIC = null; // Bluetooth通信用
    let autoPrintEnabled = localStorage.getItem('autoPrintEnabled') === 'true';
    
    // プロキシサーバーのURL（HTTPSからHTTPへの通信を中継）
    // ローカル環境で起動したNode.jsサーバーのURL
    const PRINTER_PROXY_URL = 'http://localhost:3000/print';
    
    // プロキシを使用するかどうか（HTTPSサイトの場合はtrue）
    const USE_PROXY = window.location.protocol === 'https:';
    
    // プロキシ対応の印刷ヘルパー関数
    // プロキシ対応 + Bluetooth対応の印刷ヘルパー関数
    async function sendPrintRequest(builder, onSuccess, onError) {
      try {
        // Bluetooth接続の場合
        if (PRINTER_CONNECTION_TYPE === 'bluetooth') {
          console.log(' Bluetooth経由で印刷します');
          
          if (!BLUETOOTH_CHARACTERISTIC) {
            throw new Error('Bluetoothプリンタが接続されていません。プリンタ設定から接続してください。');
          }
          
          // StarWebPrintBuilderから生テキストを抽出（簡易版）
          // 注意: StarWebPrintBuilderはXMLを生成するので、テキストのみを抽出
          const xmlString = builder.toString();
          const textMatch = xmlString.match(/<text[^>]*>([^<]*)<\/text>/g);
          let text = '';
          if (textMatch) {
            textMatch.forEach(match => {
              const content = match.replace(/<[^>]+>/g, '');
              text += content + '\n';
            });
          }
          
          await printViaBluetooth(text);
          
          if (onSuccess) onSuccess({ status: 'success', message: 'Bluetooth印刷完了' });
          return;
        }
        
        // Ethernet/WiFi接続の場合
        if (USE_PROXY) {
          console.log(' プロキシサーバー経由で印刷します');
          
          // XMLリクエストを取得
          const request = builder.toString();
          
          // プロキシサーバーに送信
          const response = await fetch(PRINTER_PROXY_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'text/xml; charset=utf-8'
            },
            body: request
          });
          
          if (response.ok) {
            console.log(' 印刷成功');
            const data = await response.text();
            if (onSuccess) onSuccess({ status: 'success', data: data });
          } else {
            const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
            console.error(' 印刷エラー:', errorData);
            if (onError) onError({ status: response.status, message: errorData.error || response.statusText });
          }
        } else {
          console.log('プリンターに直接印刷します');
          
          const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
          const request = builder.toString();
          
          const trader = new StarWebPrintTrader({url: url});
          trader.onReceive = function(response) {
            console.log('印刷成功:', response);
            if (onSuccess) onSuccess(response);
          };
          trader.onError = function(response) {
            console.error('印刷エラー:', response);
            if (onError) onError(response);
          };
          
          trader.sendMessage({request: request});
        }
      } catch (error) {
        console.error(' 印刷処理エラー:', error);
        if (onError) onError({ status: 'error', message: error.message });
      }
    }
    
    // メニューデータ（Firebaseから取得）
    let menuData = [];
    let toppingsData = [];
    
        // 初期化
    window.addEventListener('load', async () => {
      await initializeSystem();
    });
    
    async function initializeSystem() {
      // Firebaseからメニューを取得
      try {
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        // controller.htmlと同じ形式でsold_outを取得
        const soldOutSnapshot = await window.getDocs(window.collection(window.db, 'sold_out'));
        const soldOutIds = new Set();
        soldOutSnapshot.forEach(doc => soldOutIds.add(doc.data().menuId));
        
        menuData = [];
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          const menuId = data.id || doc.id;
          menuData.push({
            id: menuId,
            docId: doc.id, // ドキュメントIDも保持
            name: data.name || '',
            price: data.price || 0,
            category: data.category || 'その他',
            taxRate: data.taxRate || 10,
            taxType: data.taxType || 'inclusive',  // 外税/内税タイプを追加
            foodType: data.foodType || 'food',  // 食材区分を追加
            toppingsId: data.toppingsId || '', // カンマ区切りのトッピングID文字列
            toppings: data.toppings || [], // 配列形式（互換性のため）
            toppingSets: data.toppingSets || [], // 新しいトッピングセット形式
            note: data.note || '', // 表示制限用のnote
            outOfStock: soldOutIds.has(menuId) // 品切れ判定
          });
        });
        
        // menu.htmlと同じソート方法：IDでソート
        console.log('ソート前のメニューID:', menuData.map(m => m.id).join(', '));
        menuData.sort((a, b) => {
          if (a.id < b.id) return -1;
          if (a.id > b.id) return 1;
          return 0;
        });
        
        console.log(' メニューを読み込みました:', menuData.length, '件 (品切れ:', soldOutIds.size, '件)');
        console.log('ソート後のメニューID:', menuData.map(m => m.id).join(', '));
      } catch (e) {
        console.error(' メニューの読み込みに失敗:', e);
      }
      
      // Firebaseからトッピングを取得
      try {
        const toppingsSnapshot = await window.getDocs(window.getStoreCollection('toppings'));
        toppingsData = [];
        toppingsSnapshot.forEach(doc => {
          const data = doc.data();
          toppingsData.push({
            id: data.id || doc.id, // data.idを優先
            docId: doc.id,
            name: data.name || '',
            price: data.price || 0,
            order: data.order || 99 // 並び順フィールド
          });
        });
        
        // menu.htmlと同じソート方法：orderフィールドでソート
        console.log('ソート前のトッピングID:', toppingsData.map(t => t.id).join(', '));
        toppingsData.sort((a, b) => a.order - b.order);
        
        console.log(' トッピングを読み込みました:', toppingsData.length, '件');
        console.log('ソート後のトッピングID:', toppingsData.map(t => t.id).join(', '));
      } catch (e) {
        console.error(' トッピングの読み込みに失敗:', e);
      }
      
      // 既存のテーブル（即会計、テイクアウト）を自動登録
      await ensureDefaultTables();
      
      // テーブルボタンを生成
      await loadTableButtons();
      
      // カテゴリを初期化
      initializeCategories();
      
      // メニュー項目を表示
      displayMenuItems();
      
      // リアルタイム更新を開始
      startRealtimeUpdates();
      
      // 音声通知を初期化
      showAudioEnablePopup();
      watchOrders();
      watchStaffCalls();
      
      // 7年以上古いデータを自動削除
      deleteOldDataAutomatically();
    }
    
    // 7年以上古いデータを自動削除する関数
    async function deleteOldDataAutomatically() {
      try {
        console.log('=== 7年以上古いデータの自動削除開始 ===');
        
        // 7年前の日時を計算
        const sevenYearsAgo = new Date();
        sevenYearsAgo.setFullYear(sevenYearsAgo.getFullYear() - 7);
        const cutoffTimestamp = window.Timestamp.fromDate(sevenYearsAgo);
        
        console.log('基準日:', sevenYearsAgo.toLocaleDateString('ja-JP'));
        
        let deletedCount = 0;
        
        // 注文データを確認
        try {
          const ordersCollection = window.getStoreCollection('orders');
          const ordersSnapshot = await window.getDocs(ordersCollection);
          
          for (const docSnap of ordersSnapshot.docs) {
            const data = docSnap.data();
            
            // createdAtフィールドがある場合のみチェック
            if (data.createdAt) {
              const docDate = data.createdAt.toDate();
              
              // 7年以上前のデータは削除
              if (docDate < sevenYearsAgo) {
                await window.deleteDoc(docSnap.ref);
                deletedCount++;
                console.log(`削除: 注文/${docSnap.id} (${docDate.toLocaleDateString('ja-JP')})`);
              }
            }
          }
        } catch (error) {
          console.warn('注文データの確認でエラー:', error.message);
        }
        
        // 勤怠データを確認
        try {
          const attendanceCollection = window.getStoreCollection('attendance');
          const attendanceSnapshot = await window.getDocs(attendanceCollection);
          
          for (const docSnap of attendanceSnapshot.docs) {
            const data = docSnap.data();
            
            // createdAtフィールドがある場合のみチェック
            if (data.createdAt) {
              const docDate = data.createdAt.toDate();
              
              // 7年以上前のデータは削除
              if (docDate < sevenYearsAgo) {
                await window.deleteDoc(docSnap.ref);
                deletedCount++;
                console.log(`削除: 勤怠/${docSnap.id} (${docDate.toLocaleDateString('ja-JP')})`);
              }
            }
          }
        } catch (error) {
          console.warn('勤怠データの確認でエラー:', error.message);
        }
        
        console.log('=== 7年以上古いデータの削除完了 ===');
        console.log('削除件数:', deletedCount);
        
        if (deletedCount > 0) {
          console.log(`7年以上古いデータを${deletedCount}件自動削除しました`);
        }
      } catch (error) {
        console.error('古いデータ自動削除エラー:', error);
      }
    }
    
    // テーブルボタンの色を更新
    
    // 自動印刷トグル
    window.toggleAutoPrint = function() {
      autoPrintEnabled = document.getElementById('autoPrintToggle').checked;
      localStorage.setItem('autoPrintEnabled', autoPrintEnabled.toString());
      const status = document.getElementById('autoPrintStatus');
      status.textContent = autoPrintEnabled ? 'ON' : 'OFF';
      status.className = autoPrintEnabled ? 'toggle-status on' : 'toggle-status off';
    };
    
    // カテゴリを初期化
    function initializeCategories() {
      const categoryFilter = document.getElementById('categoryFilter');
      
      // categoryFilter要素が存在しない場合はスキップ（モーダル内など）
      if (!categoryFilter) {
        console.log(' categoryFilter要素が見つかりません（モーダル内の可能性）');
        return;
      }
      
      // カテゴリごとの最小IDを計算
      const categoryInfo = new Map();
      menuData.forEach(item => {
        if (!item.category) return;
        const cat = item.category;
        if (!categoryInfo.has(cat)) {
          categoryInfo.set(cat, { minId: item.id });
        } else {
          const info = categoryInfo.get(cat);
          if (item.id < info.minId) {
            info.minId = item.id;
          }
        }
      });
      
      // 最小IDでソート
      const sortedCategories = Array.from(categoryInfo.entries())
        .sort((a, b) => a[1].minId.localeCompare(b[1].minId))
        .map(entry => entry[0]);
      
      // 既存のオプションをクリア（「全ての商品」以外）
      categoryFilter.innerHTML = '<option value="all">全ての商品</option>';
      
      // カテゴリを追加
      sortedCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryFilter.appendChild(option);
      });
    }
    
    // カテゴリでフィルタ
    window.filterMenuByCategory = function() {
      const categoryFilterElement = document.getElementById('categoryFilter');
      if (!categoryFilterElement) {
        console.log(' categoryFilter要素が見つかりません');
        return;
      }
      const selectedCategory = categoryFilterElement.value;
      displayMenuItems(selectedCategory);
    };
    
    // メニュー項目を表示
    function displayMenuItems(categoryFilter = 'all') {
      const container = document.getElementById('menuItemsList');
      
      // container要素が存在しない場合はスキップ
      if (!container) {
        console.log(' menuItemsList要素が見つかりません');
        return;
      }
      
      container.innerHTML = '';
      
      const filteredMenu = categoryFilter === 'all' 
        ? menuData 
        : menuData.filter(item => item.category === categoryFilter);
      
      filteredMenu.forEach(item => {
        // 外税の場合は税込価格を計算して表示
        let displayPrice = item.price;
        if (item.taxType === 'exclusive') {
          const taxRate = item.taxRate || 10;
          displayPrice = Math.floor(item.price * (1 + taxRate / 100));
        }
        
        const div = document.createElement('div');
        div.className = 'menu-item-checkbox';
        div.style.cursor = 'pointer';
        div.innerHTML = `
          <input type="checkbox" id="menu-${item.id}" value="${item.id}" style="pointer-events: none;">
          <div class="menu-item-info">
            <div class="menu-item-name-small">${item.name}</div>
            <div class="menu-item-price-small">¥${displayPrice.toLocaleString()}</div>
          </div>
        `;
        
        // div全体をクリック可能に
        div.onclick = () => {
          const checkbox = document.getElementById(`menu-${item.id}`);
          checkbox.checked = !checkbox.checked;
          toggleMenuItem(item.id);
        };
        
        container.appendChild(div);
      });
    }
    
    // 一時的な選択中のアイテム
    let currentSelectingItem = null;
    let selectedToppings = [];
    let currentToppingQuantity = 1; // トッピングモーダルでの数量
    
    // メニュー項目の選択切り替え
    window.toggleMenuItem = function(itemId) {
      const checkbox = document.getElementById(`menu-${itemId}`);
      const item = menuData.find(m => m.id === itemId);
      
      if (checkbox.checked) {
        currentSelectingItem = { ...item };
        selectedToppings = [];
        
        // toppingsIdが空または存在しない場合でも、トッピング選択モーダルを表示（数量選択のため）
        showToppingModal(item);
      } else {
        manualCart = manualCart.filter(i => i.id !== itemId);
        updateManualCart();
      }
    };
    
    // トッピング選択モーダルを表示
    function showToppingModal(item) {
      currentSelectingItem = item;
      selectedToppings = [];
      currentToppingQuantity = 1; // 数量を初期化
      
      console.log(' トッピングモーダル表示:', item);
      console.log('  toppingsData:', toppingsData);
      console.log('  item.toppingsId:', item.toppingsId);
      console.log('  item.toppingSets:', item.toppingSets);
      
      document.getElementById('toppingModalItemName').textContent = item.name;
      document.getElementById('toppingQuantityDisplay').textContent = currentToppingQuantity; // 数量表示を更新
      const list = document.getElementById('toppingsList');
      list.innerHTML = '';
      
      // toppingSetsが存在する場合は新しい形式を使用
      if (item.toppingSets && item.toppingSets.length > 0) {
        console.log(' toppingSets形式で表示');
        item.toppingSets.forEach((set, setIndex) => {
          const setDiv = document.createElement('div');
          setDiv.style.cssText = 'margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;';
          
          const setTitle = document.createElement('div');
          setTitle.style.cssText = 'font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #333;';
          setTitle.textContent = set.name + (set.type === 'single' ? ' （1つ選択）' : ' （複数選択可）');
          setDiv.appendChild(setTitle);
          
          set.options.forEach((option, optionIndex) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'topping-item';
            optionDiv.style.cursor = 'pointer';
            
            const inputType = set.type === 'single' ? 'radio' : 'checkbox';
            const inputName = set.type === 'single' ? `topping-set-${setIndex}` : '';
            
            optionDiv.innerHTML = `
              <input type="${inputType}" id="topping-${setIndex}-${optionIndex}" name="${inputName}" style="pointer-events: none;">
              <div class="topping-item-info">
                <span class="topping-item-name">${option.name}</span>
                <span class="topping-item-price">+¥${option.price.toLocaleString()}</span>
              </div>
            `;
            
            optionDiv.onclick = () => {
              const input = document.getElementById(`topping-${setIndex}-${optionIndex}`);
              
              if (set.type === 'single') {
                // ラジオボタンの場合、他の選択を解除
                set.options.forEach((_, idx) => {
                  const otherInput = document.getElementById(`topping-${setIndex}-${idx}`);
                  if (otherInput) otherInput.checked = false;
                });
                input.checked = true;
                
                // 選択状態を保存
                selectedToppings = selectedToppings.filter(t => t.setIndex !== setIndex);
                selectedToppings.push({
                  setIndex: setIndex,
                  setName: set.name,
                  optionIndex: optionIndex,
                  optionName: option.name,
                  price: option.price
                });
              } else {
                // チェックボックスの場合
                input.checked = !input.checked;
                
                if (input.checked) {
                  selectedToppings.push({
                    setIndex: setIndex,
                    setName: set.name,
                    optionIndex: optionIndex,
                    optionName: option.name,
                    price: option.price
                  });
                } else {
                  selectedToppings = selectedToppings.filter(
                    t => !(t.setIndex === setIndex && t.optionIndex === optionIndex)
                  );
                }
              }
              
              console.log('選択されたトッピング:', selectedToppings);
            };
            
            setDiv.appendChild(optionDiv);
          });
          
          list.appendChild(setDiv);
        });
      } else {
        // 古い形式（toppingsId）の場合
        console.log(' toppingsId形式で表示');
        
        // 「なし」オプション
        const noneDiv = document.createElement('div');
        noneDiv.className = 'topping-item';
        noneDiv.style.cursor = 'pointer';
        noneDiv.innerHTML = `
          <input type="checkbox" id="topping-none" style="pointer-events: none;">
          <div class="topping-item-info">
            <span class="topping-item-name">標準トッピング</span>
            <span class="topping-item-price">¥0</span>
          </div>
        `;
        
        noneDiv.onclick = () => {
          const checkbox = document.getElementById('topping-none');
          checkbox.checked = !checkbox.checked;
          selectNoneTopping(checkbox);
        };
        
        list.appendChild(noneDiv);
        
        // toppingsIdからトッピングIDのリストを取得
        let allowedToppingIds = [];
        if (item.toppingsId && typeof item.toppingsId === 'string') {
          allowedToppingIds = item.toppingsId.split(',').map(id => id.trim());
        } else if (item.toppings && Array.isArray(item.toppings)) {
          allowedToppingIds = item.toppings;
        }
        
        console.log('  allowedToppingIds:', allowedToppingIds);
        console.log('  toppingsData件数:', toppingsData.length);
        
        let displayedCount = 0;
        toppingsData.forEach(topping => {
          console.log('  チェック中:', topping.id, 'が', allowedToppingIds, 'に含まれる?', allowedToppingIds.includes(topping.id));
          if (allowedToppingIds.length > 0 && allowedToppingIds.includes(topping.id)) {
            displayedCount++;
            const div = document.createElement('div');
            div.className = 'topping-item';
            div.style.cursor = 'pointer';
            div.innerHTML = `
              <input type="checkbox" id="topping-${topping.id}" value="${topping.id}" style="pointer-events: none;">
              <div class="topping-item-info">
                <span class="topping-item-name">${topping.name}</span>
                <span class="topping-item-price">+¥${topping.price.toLocaleString()}</span>
              </div>
            `;
            
            div.onclick = () => {
              const checkbox = document.getElementById(`topping-${topping.id}`);
              checkbox.checked = !checkbox.checked;
              selectTopping(checkbox);
            };
            
            list.appendChild(div);
          }
        });
        
        console.log('  表示されたトッピング数:', displayedCount);
        
        // デフォルトで「なし」を選択
        const noneCheckbox = document.getElementById('topping-none');
        if (noneCheckbox) noneCheckbox.checked = true;
      }
      
      document.getElementById('toppingModal').classList.remove('hidden');
    }
    
    // 「なし」トッピングを選択
    window.selectNoneTopping = function(checkbox) {
      if (checkbox.checked) {
        // 他のトッピングをすべてクリア
        selectedToppings = [];
        toppingsData.forEach(t => {
          const cb = document.getElementById(`topping-${t.id}`);
          if (cb) cb.checked = false;
        });
      }
    };
    
    // トッピングを選択
    window.selectTopping = function(checkbox) {
      const noneCheckbox = document.getElementById('topping-none');
      
      if (checkbox.checked) {
        // 「なし」のチェックを外す
        noneCheckbox.checked = false;
        
        // 選択されたトッピングを追加
        const toppingId = checkbox.value;
        const topping = toppingsData.find(t => t.id === toppingId);
        if (topping && !selectedToppings.find(t => t.id === toppingId)) {
          selectedToppings.push(topping);
        }
      } else {
        // 選択解除
        selectedToppings = selectedToppings.filter(t => t.id !== checkbox.value);
        
        // トッピングが何も選択されていない場合は「なし」を選択
        if (selectedToppings.length === 0) {
          noneCheckbox.checked = true;
        }
      }
    };
    
    // トッピング選択を確定
    window.confirmTopping = function() {
      if (!currentSelectingItem) return;
      
      let toppingNames = 'なし';
      let toppingPrice = 0;
      let toppingDetails = [];
      
      // 新しい形式（toppingSets）の場合
      if (currentSelectingItem.toppingSets && currentSelectingItem.toppingSets.length > 0) {
        if (selectedToppings.length > 0) {
          toppingNames = selectedToppings.map(t => t.optionName).join(', ');
          toppingPrice = selectedToppings.reduce((sum, t) => sum + t.price, 0);
          toppingDetails = selectedToppings.map(t => ({
            setName: t.setName,
            optionName: t.optionName,
            price: t.price
          }));
        }
      } else {
        // 古い形式（toppingsId）の場合
        if (selectedToppings.length > 0) {
          toppingNames = selectedToppings.map(t => t.name).join(', ');
          toppingPrice = selectedToppings.reduce((sum, t) => sum + t.price, 0);
        }
      }
      
      // 編集モードかどうかを確認
      if (currentSelectingItem.editIndex !== undefined) {
        // 既存アイテムを更新
        manualCart[currentSelectingItem.editIndex].toppings = toppingNames;
        manualCart[currentSelectingItem.editIndex].toppingPrice = toppingPrice;
        manualCart[currentSelectingItem.editIndex].toppingDetails = toppingDetails;
        manualCart[currentSelectingItem.editIndex].quantity = currentToppingQuantity; // 数量も更新
      } else {
        // 新規アイテムを追加
        manualCart.push({
          ...currentSelectingItem,
          toppingsId: currentSelectingItem.toppingsId,  // 明示的に保存
          quantity: currentToppingQuantity, // 選択した数量を使用
          toppings: toppingNames,
          toppingPrice: toppingPrice,
          toppingDetails: toppingDetails
        });
      }
      
      closeToppingModal();
      updateManualCart();
    };
    
    // トッピングモーダルを閉じる
    window.closeToppingModal = function() {
      // チェックボックスをクリア
      if (currentSelectingItem) {
        const checkbox = document.getElementById(`menu-${currentSelectingItem.id}`);
        if (checkbox && manualCart.filter(i => i.id === currentSelectingItem.id).length === 0) {
          checkbox.checked = false;
        }
      }
      
      document.getElementById('toppingModal').classList.add('hidden');
      currentSelectingItem = null;
      selectedToppings = [];
      currentToppingQuantity = 1; // 数量をリセット
    };
    
    // トッピングモーダルの数量を増やす
    window.incrementToppingQuantity = function() {
      currentToppingQuantity++;
      document.getElementById('toppingQuantityDisplay').textContent = currentToppingQuantity;
    };
    
    // トッピングモーダルの数量を減らす
    window.decrementToppingQuantity = function() {
      if (currentToppingQuantity > 1) {
        currentToppingQuantity--;
        document.getElementById('toppingQuantityDisplay').textContent = currentToppingQuantity;
      }
    };
    
    // 予約メモモーダルを表示
    
    
    // ========== 履歴機能 ==========
    
    let historyOrders = [];
    
    // 履歴モーダルを表示
    window.showHistoryModal = async function() {
      document.getElementById('historyModal').classList.remove('hidden');
      await loadHistory();
    };
    
    // 履歴を読み込み
    async function loadHistory() {
      try {
        // timestampで昇順（古い順）にクエリ
        const q = window.query(
          window.getStoreCollection('orders'),
          window.orderBy('timestamp', 'asc')
        );
        const ordersSnapshot = await window.getDocs(q);
        historyOrders = [];
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          historyOrders.push({
            id: doc.id,
            orderNumber: data.orderNumber || 0,
            timestamp: data.timestamp,
            tableNumber: data.tableNumber || '',
            items: data.items || [],
            totalAmount: data.totalAmount || 0,
            paymentMethod: data.paymentMethod || 'cash',  // 支払方法を追加
            paidAt: data.paidAt || null,
            completedAt: data.completedAt || null,
            cancelledAt: data.cancelledAt || null,
            deleted: data.deleted || false,
            deletedAt: data.deletedAt || null
          });
        });
        
        // Firebaseのクエリで既に時系列順（古い順）にソートされている
        console.log(' 履歴読み込み完了:', historyOrders.length, '件');
        
        filterHistory();
      } catch (e) {
        console.error(' 履歴読み込みエラー:', e);
        alert('履歴の読み込みに失敗しました');
      }
    }
    
    // 履歴をフィルタ表示
    window.filterHistory = function() {
      const dateFilter = document.getElementById('historyDateFilter').value;
      const statusFilter = document.getElementById('historyStatusFilter').value;
      
      const now = new Date();
      
      let filtered = historyOrders.filter(order => {
        // 日付フィルタ
        const orderDate = order.timestamp.toDate();
        
        let dateMatch = true;
        if (dateFilter === 'today') {
          // 今日（午前3時区切り）
          const todayStart = new Date(now);
          todayStart.setHours(3, 0, 0, 0);
          if (now.getHours() < 3) {
            todayStart.setDate(todayStart.getDate() - 1);
          }
          const todayEnd = new Date(todayStart);
          todayEnd.setDate(todayEnd.getDate() + 1);
          dateMatch = orderDate >= todayStart && orderDate < todayEnd;
        } else if (dateFilter === 'yesterday') {
          // 昨日（午前3時区切り）
          const yesterdayStart = new Date(now);
          yesterdayStart.setHours(3, 0, 0, 0);
          if (now.getHours() < 3) {
            yesterdayStart.setDate(yesterdayStart.getDate() - 1);
          }
          yesterdayStart.setDate(yesterdayStart.getDate() - 1);
          const yesterdayEnd = new Date(yesterdayStart);
          yesterdayEnd.setDate(yesterdayEnd.getDate() + 1);
          dateMatch = orderDate >= yesterdayStart && orderDate < yesterdayEnd;
        } else if (dateFilter === 'week') {
          // 過去7日間
          const weekAgo = new Date(now);
          weekAgo.setDate(weekAgo.getDate() - 7);
          weekAgo.setHours(0, 0, 0, 0);
          dateMatch = orderDate >= weekAgo;
        } else if (dateFilter === 'month') {
          // 今月
          const monthStart = new Date(now);
          monthStart.setDate(1);
          monthStart.setHours(0, 0, 0, 0);
          dateMatch = orderDate >= monthStart;
        }
        
        // ステータスフィルタ
        let statusMatch = true;
        if (statusFilter === 'deleted') {
          statusMatch = order.deleted;
        } else if (statusFilter === 'paid') {
          statusMatch = order.paidAt && !order.deleted;
        } else if (statusFilter === 'completed') {
          statusMatch = order.completedAt && !order.deleted;
        } else if (statusFilter === 'cancelled') {
          statusMatch = order.cancelledAt && !order.deleted;
        }
        
        return dateMatch && statusMatch;
      });
      
      displayHistory(filtered);
    };
    
    // 履歴を表示
    function displayHistory(orders) {
      const container = document.getElementById('historyList');
      
      if (orders.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">該当する履歴がありません</div>';
        return;
      }
      
      container.innerHTML = '';
      
      // 古い順に表示（時系列順）
      // 既にFirebaseから取得したordersは時間順なので、そのまま表示
      orders.forEach(order => {
        const card = document.createElement('div');
        card.style.cssText = `
          background: white;
          border-radius: 12px;
          padding: 15px;
          margin-bottom: 15px;
          border: 2px solid #ddd;
        `;
        
        // ステータスバッジ
        let badges = [];
        if (order.deleted) badges.push('<span style="background: #666; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">削除済み</span>');
        if (order.paidAt) badges.push('<span style="background: #2196F3; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">会計済</span>');
        if (order.completedAt) badges.push('<span style="background: #4CAF50; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">完了</span>');
        if (order.cancelledAt) badges.push('<span style="background: #f44336; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">キャンセル</span>');
        
        const orderDate = order.timestamp.toDate();
        const dateStr = orderDate.toLocaleString('ja-JP');
        
        // 支払方法を日本語に変換
        const paymentMethodNames = {
          'cash': '現金',
          'emoney': '電子マネー',
          'credit': 'クレジットカード'
        };
        const paymentMethodLabel = paymentMethodNames[order.paymentMethod] || '現金';
        
        let itemsHtml = '';
        order.items.forEach(item => {
          itemsHtml += `<div style="padding: 5px 0; border-bottom: 1px solid #eee;">
            ${item.name} ×${item.quantity} - ¥${((item.price + (item.toppingPrice || 0)) * item.quantity).toLocaleString()}
          </div>`;
        });
        
        // アクションボタン
        let actionsHtml = `
          <div style="display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 2px solid #eee; flex-wrap: wrap;">
            <button onclick="editOrder('${order.id}')" style="flex: 1; min-width: 120px; padding: 10px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
              ️ 編集
            </button>
            ${order.paidAt ? `
              <button onclick="redSlip('${order.id}')" style="flex: 1; min-width: 120px; padding: 10px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                 赤伝票
              </button>
            ` : `
              ${!order.deleted ? `
                <button onclick="deleteOrderFromHistory('${order.id}')" style="flex: 1; min-width: 120px; padding: 10px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                  ️ 取消
                </button>
              ` : `
                <button onclick="restoreOrderFromHistory('${order.id}')" style="flex: 1; min-width: 120px; padding: 10px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                   復元
                </button>
              `}
            `}
            ${order.paidAt ? `
              <button onclick="reprintReceipt('${order.id}')" style="flex: 1; min-width: 120px; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                レシート再印刷
              </button>
              <button onclick="reprintInvoice('${order.id}')" style="flex: 1; min-width: 120px; padding: 10px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                領収書再印刷
              </button>
            ` : ''}
          </div>
        `;
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div>
              <strong style="font-size: 18px;">#${order.orderNumber}</strong>
              <span style="color: #666; margin-left: 10px;">${order.tableNumber}</span>
            </div>
            <div>${badges.join('')}</div>
          </div>
          <div style="font-size: 12px; color: #999; margin-bottom: 10px;">
            ${dateStr}
            ${order.paidAt ? `<span style="margin-left: 15px; padding: 4px 8px; background: #e3f2fd; color: #1976d2; border-radius: 4px; font-weight: bold;">${paymentMethodLabel}</span>` : ''}
          </div>
          <div style="max-height: 150px; overflow-y: auto; margin: 10px 0;">
            ${itemsHtml}
          </div>
          <div style="text-align: right; font-size: 18px; font-weight: bold; color: #667eea; margin-top: 10px;">
            合計: ¥${order.totalAmount.toLocaleString()}
          </div>
          ${actionsHtml}
        `;
        
        container.appendChild(card);
      });
    }
    
    // 履歴からレシートを再印刷
    window.reprintReceipt = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        if (!orderDoc.exists()) {
          alert('注文が見つかりません');
          return;
        }
        
        const orderData = orderDoc.data();
        
        // 商品リストを作成（保存されている税率情報を使用）
        const itemsWithTaxRate = [];
        
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            itemsWithTaxRate.push({
              name: item.name,
              quantity: item.quantity,
              price: item.price + (item.toppingPrice || 0),
              toppings: item.toppings || 'なし',
              taxRate: item.taxRate || 10,  // 保存されている税率を使用
              taxType: item.taxType || 'inclusive'  // taxTypeも保存
            });
          });
        }
        
        // レジ袋を追加
        if (orderData.bagNeeded && orderData.bagQuantity > 0) {
          const bagTotal = orderData.bagPrice || (orderData.bagQuantity * 3);
          const bagUnitPrice = Math.round(bagTotal / orderData.bagQuantity);
          itemsWithTaxRate.push({
            name: '️ レジ袋',
            quantity: orderData.bagQuantity,
            price: bagUnitPrice,
            toppings: 'なし',
            taxRate: 10,
            taxType: 'inclusive'
          });
        }
        
        // lastPaymentDataを再構築
        lastPaymentData = {
          orderNumbers: [orderData.orderNumber],
          tableNumber: orderData.tableNumber,
          items: itemsWithTaxRate,
          totalAmount: orderData.totalAmount,
          paymentMethod: orderData.paymentMethod || 'cash',
          staffName: orderData.staffName || 'レジ係',
          cashReceived: orderData.totalAmount,
          change: 0,
          timestamp: orderData.paidAt ? orderData.paidAt.toDate() : orderData.timestamp.toDate()
        };
        
        await printReceipt();
      } catch (e) {
        console.error('再印刷エラー:', e);
        alert('レシートの再印刷に失敗しました: ' + e.message);
      }
    };
    
    // 履歴から領収書を再印刷
    window.reprintInvoice = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        if (!orderDoc.exists()) {
          alert('注文が見つかりません');
          return;
        }
        
        const orderData = orderDoc.data();
        
        // 商品リストを作成
        const itemsWithTaxRate = [];
        
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            itemsWithTaxRate.push({
              name: item.name,
              quantity: item.quantity,
              price: item.price + (item.toppingPrice || 0),
              toppings: item.toppings || 'なし',
              taxRate: item.taxRate || 10,  // 保存されている税率を使用
              taxType: item.taxType || 'inclusive'  // taxTypeも保存
            });
          });
        }
        
        // レジ袋を追加
        if (orderData.bagNeeded && orderData.bagQuantity > 0) {
          const bagTotal = orderData.bagPrice || (orderData.bagQuantity * 3);
          const bagUnitPrice = Math.round(bagTotal / orderData.bagQuantity);
          itemsWithTaxRate.push({
            name: '️ レジ袋',
            quantity: orderData.bagQuantity,
            price: bagUnitPrice,
            toppings: 'なし',
            taxRate: 10,
            taxType: 'inclusive'
          });
        }
        
        // lastPaymentDataを再構築
        lastPaymentData = {
          orderNumbers: [orderData.orderNumber],
          tableNumber: orderData.tableNumber,
          items: itemsWithTaxRate,
          totalAmount: orderData.totalAmount,
          paymentMethod: orderData.paymentMethod || 'cash',
          staffName: orderData.staffName || 'レジ係',
          cashReceived: orderData.totalAmount,
          change: 0,
          timestamp: orderData.paidAt ? orderData.paidAt.toDate() : orderData.timestamp.toDate()
        };
        
        await printInvoice();
      } catch (e) {
        console.error('再印刷エラー:', e);
        alert('領収書の再印刷に失敗しました: ' + e.message);
      }
    };
    
    // 履歴を更新
    window.refreshHistory = async function() {
      await loadHistory();
    };
    
    // 履歴モーダルを閉じる
    window.closeHistoryModal = function() {
      document.getElementById('historyModal').classList.add('hidden');
    };
    
    // ===== 注文編集機能 =====
    let currentEditingOrder = null;
    
    // 注文編集モーダルを開く
    window.editOrder = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        if (!orderDoc.exists()) {
          alert('注文が見つかりません');
          return;
        }
        
        const orderData = orderDoc.data();
        
        // デバッグログ: 注文データの確認
        console.log(' 注文編集開始:', {
          注文ID: orderId,
          注文番号: orderData.orderNumber,
          テーブル: orderData.tableNumber,
          金額: orderData.totalAmount,
          支払方法: orderData.paymentMethod,
          paidAt: orderData.paidAt,
          paidAtタイプ: typeof orderData.paidAt,
          timestamp: orderData.timestamp
        });
        
        currentEditingOrder = {
          id: orderId,
          ...orderData,
          originalTotalAmount: orderData.totalAmount,  // 元の金額を保存
          originalPaymentMethod: orderData.paymentMethod  // 元の支払方法も保存
        };
        
        // 支払方法の選択肢
        const paymentMethods = {
          'cash': '現金',
          'emoney': '電子マネー',
          'credit': 'クレジットカード'
        };
        
        let paymentMethodOptions = '';
        Object.keys(paymentMethods).forEach(method => {
          const selected = orderData.paymentMethod === method ? 'selected' : '';
          paymentMethodOptions += `<option value="${method}" ${selected}>${paymentMethods[method]}</option>`;
        });
        
        // 商品リスト
        let itemsHtml = '';
        if (orderData.items && orderData.items.length > 0) {
          orderData.items.forEach((item, index) => {
            // トッピング表示（toppingDetailsまたはtoppingsDataを優先）
            let toppingsHtml = '';
            if (item.toppingDetails && item.toppingDetails.length > 0) {
              // 新しい形式: toppingDetailsがある場合
              const groupedBySet = {};
              item.toppingDetails.forEach(detail => {
                if (!groupedBySet[detail.setName]) {
                  groupedBySet[detail.setName] = [];
                }
                groupedBySet[detail.setName].push(detail.optionName);
              });
              
              toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
                return `
                  <div style="font-size: 12px; color: #666; font-weight: bold; margin-top: 5px;">${setName}</div>
                  ${options.map(opt => `<div style="font-size: 12px; color: #666; margin-left: 10px;">・${opt}</div>`).join('')}
                `;
              }).join('');
            } else if (item.toppingsData && item.toppingsData.length > 0) {
              // menu.htmlからの新しい形式: toppingsDataがある場合
              const groupedBySet = {};
              item.toppingsData.forEach(topping => {
                const setName = topping.setName || 'トッピング';
                if (!groupedBySet[setName]) {
                  groupedBySet[setName] = [];
                }
                groupedBySet[setName].push(topping.name);
              });
              
              toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
                return `
                  <div style="font-size: 12px; color: #666; font-weight: bold; margin-top: 5px;">${setName}</div>
                  ${options.map(opt => `<div style="font-size: 12px; color: #666; margin-left: 10px;">・${opt}</div>`).join('')}
                `;
              }).join('');
            } else if (item.toppings && item.toppings !== 'なし' && item.toppings !== '標準トッピング') {
              // 古い形式: toppingsのみの場合
              toppingsHtml = `<div style="font-size: 12px; color: #666;">トッピング: ${item.toppings}</div>`;
            }
            
            itemsHtml += `
              <div style="padding: 10px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong>${item.name}</strong>
                    ${toppingsHtml}
                  </div>
                  <button onclick="removeItemFromOrder(${index})" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">削除</button>
                </div>
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                  <label>数量:</label>
                  <input type="number" value="${item.quantity}" onchange="updateItemQuantity(${index}, this.value)" min="1" style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                  <span style="margin-left: auto; font-weight: bold;">¥${((item.price + (item.toppingPrice || 0)) * item.quantity).toLocaleString()}</span>
                </div>
              </div>
            `;
          });
        }
        
        const content = document.getElementById('editOrderContent');
        content.innerHTML = `
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">注文番号</label>
            <div style="font-size: 24px; color: #667eea;">#${orderData.orderNumber || 0}</div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">テーブル番号</label>
            <input type="text" id="editTableNumber" value="${orderData.tableNumber || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">支払方法</label>
            <select id="editPaymentMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
              ${paymentMethodOptions}
            </select>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">注文商品</label>
            ${itemsHtml || '<div style="text-align: center; padding: 20px; color: #999;">商品がありません</div>'}
          </div>
          
          <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; text-align: right;">
            <span style="font-size: 18px; font-weight: bold;">合計: </span>
            <span id="editTotalAmount" style="font-size: 24px; font-weight: bold; color: #1976d2;">¥${(orderData.totalAmount || 0).toLocaleString()}</span>
          </div>
        `;
        
        // ボタンを動的に生成（削除済みかどうかで変わる）
        const buttonsContainer = document.getElementById('editOrderButtons');
        if (orderData.paidAt) {
          // 会計済み注文：削除状態に関わらず赤伝票
          buttonsContainer.innerHTML = `
            <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveOrderEdit()">保存</button>
            <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="redSlipFromEdit()"> 赤伝票</button>
            <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditOrderModal()">キャンセル</button>
          `;
        } else {
          // 未会計注文
          if (orderData.deleted) {
            // 削除済み未会計注文：復元可能
            buttonsContainer.innerHTML = `
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveOrderEdit()">保存</button>
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white;" onclick="restoreOrder()">注文を復元</button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditOrderModal()">キャンセル</button>
            `;
          } else {
            // 通常の未会計注文：取消可能
            buttonsContainer.innerHTML = `
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveOrderEdit()">保存</button>
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="deleteOrderFromEdit()">️ 注文取消</button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditOrderModal()">キャンセル</button>
            `;
          }
        }
        
        document.getElementById('editOrderModal').classList.remove('hidden');
        
      } catch (e) {
        console.error('注文編集エラー:', e);
        alert('注文の読み込みに失敗しました');
      }
    };
    
    // 注文編集モーダルを閉じる
    window.closeEditOrderModal = function() {
      document.getElementById('editOrderModal').classList.add('hidden');
      currentEditingOrder = null;
    };
    
    // 商品を注文から削除
    window.removeItemFromOrder = async function(index) {
      if (!currentEditingOrder) return;
      
      const item = currentEditingOrder.items[index];
      const itemName = item.name || '商品';
      const itemPrice = (item.price + (item.toppingPrice || 0)) * item.quantity;
      
      //  オシャレな確認ダイアログを表示
      const confirmed = await showCustomConfirm({
        icon: '️',
        title: '商品を削除',
        message: `${itemName}\n¥${itemPrice.toLocaleString()}\n\nこの商品を注文から削除しますか？`,
        confirmText: '削除する',
        confirmColor: '#f44336'
      });
      
      if (confirmed) {
        try {
          console.log('️ 商品削除処理開始:', itemName);
          
          // 商品を配列から削除
          currentEditingOrder.items.splice(index, 1);
          
          // 合計金額を再計算
          let total = 0;
          let tax8Total = 0;
          let tax10Total = 0;
          
          currentEditingOrder.items.forEach(item => {
            const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
            total += itemTotal;
            
            // 税率別集計
            if (item.taxRate === 8) {
              tax8Total += itemTotal;
            } else {
              tax10Total += itemTotal;
            }
          });
          
          currentEditingOrder.totalAmount = total;
          currentEditingOrder.tax8Total = tax8Total;
          currentEditingOrder.tax10Total = tax10Total;
          
          //  Firestoreに保存
          await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), {
            items: currentEditingOrder.items,
            totalAmount: total,
            tax8Total: tax8Total,
            tax10Total: tax10Total,
            updatedAt: window.Timestamp.now()
          });
          
          console.log(' 商品を削除してFirestoreに保存しました');
          
          // 表示を更新（モーダルを再描画）
          editOrder(currentEditingOrder.id);
          
          showCustomAlert('商品を削除しました', '完了', '️');
          
        } catch (e) {
          console.error('商品削除エラー:', e);
          showCustomAlert('商品の削除に失敗しました: ' + e.message, 'エラー', 'warning');
        }
      }
    };
    
    // 商品の数量を更新
    window.updateItemQuantity = function(index, newQuantity) {
      if (!currentEditingOrder) return;
      
      const quantity = parseInt(newQuantity) || 1;
      currentEditingOrder.items[index].quantity = quantity;
      
      // 合計金額を再計算
      let total = 0;
      currentEditingOrder.items.forEach(item => {
        total += (item.price + (item.toppingPrice || 0)) * item.quantity;
      });
      currentEditingOrder.totalAmount = total;
      
      // 合計金額の表示を更新
      document.getElementById('editTotalAmount').textContent = `¥${total.toLocaleString()}`;
    };
    
    // 注文の変更を保存
    window.saveOrderEdit = async function() {
      if (!currentEditingOrder) return;
      
      try {
        const tableNumber = document.getElementById('editTableNumber').value;
        const paymentMethod = document.getElementById('editPaymentMethod').value;
        
        // 元の支払い方法と金額を取得（売上データの修正用）
        const oldPaymentMethod = currentEditingOrder.originalPaymentMethod || currentEditingOrder.paymentMethod;
        const oldTotalAmount = currentEditingOrder.originalTotalAmount || currentEditingOrder.totalAmount;
        const newTotalAmount = currentEditingOrder.totalAmount;
        
        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
        console.log(' 注文編集保存開始');
        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
        console.log('注文ID:', currentEditingOrder.id);
        console.log('注文番号:', currentEditingOrder.orderNumber);
        console.log('paidAt:', currentEditingOrder.paidAt);
        console.log('timestamp:', currentEditingOrder.timestamp);
        console.log('旧支払方法:', oldPaymentMethod);
        console.log('新支払方法:', paymentMethod);
        console.log('旧金額:', oldTotalAmount);
        console.log('新金額:', newTotalAmount);
        
        // 元のpaidAtから日付を取得（売上データ更新用）
        let originalDateStr = null;
        let useTimestamp = false;
        let isUnpaidOrder = false;
        
        try {
          let dateToUse = null;
          
          // paidAtがある場合はそれを使用
          if (currentEditingOrder.paidAt) {
            dateToUse = currentEditingOrder.paidAt.toDate();
            console.log('paidAtを使用:', dateToUse);
          }
          // paidAtがない場合はtimestampを使用
          else if (currentEditingOrder.timestamp) {
            dateToUse = currentEditingOrder.timestamp.toDate();
            useTimestamp = true;
            isUnpaidOrder = true;
            console.log('timestampを使用:', dateToUse);
            console.log(' この注文は未会計です');
          }
          
          if (dateToUse) {
            let targetDate = new Date(dateToUse);
            
            // 午前3時より前なら昨日扱い
            if (dateToUse.getHours() < 3) {
              targetDate.setDate(targetDate.getDate() - 1);
            }
            
            originalDateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth()+1).padStart(2,'0')}-${String(targetDate.getDate()).padStart(2,'0')}`;
            console.log('元の会計日付:', originalDateStr);
            console.log('   元の日時:', dateToUse.toLocaleString('ja-JP'));
          } else {
            throw new Error('paidAtもtimestampも存在しません');
          }
        } catch (error) {
          console.error(' 日付の変換エラー:', error);
          console.error('   paidAt:', currentEditingOrder.paidAt);
          console.error('   timestamp:', currentEditingOrder.timestamp);
          showCustomAlert('日付の取得に失敗しました。注文データのみ更新します。', '警告', 'warning');
          
          // 注文データのみ更新
          await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), {
            tableNumber: tableNumber,
            paymentMethod: paymentMethod,
            items: currentEditingOrder.items,
            totalAmount: currentEditingOrder.totalAmount
          });
          
          closeEditOrderModal();
          await loadHistory();
          return;
        }
        
        // 現在の日付を取得（本日の売上から減算するため）
        const now = new Date();
        let todayDate = new Date(now);
        if (now.getHours() < 3) {
          todayDate.setDate(todayDate.getDate() - 1);
        }
        const todayDateStr = `${todayDate.getFullYear()}-${String(todayDate.getMonth()+1).padStart(2,'0')}-${String(todayDate.getDate()).padStart(2,'0')}`;
        console.log('本日の日付:', todayDateStr);
        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
        
        // 注文を更新
        const orderUpdates = {
          tableNumber: tableNumber,
          paymentMethod: paymentMethod,
          items: currentEditingOrder.items,
          totalAmount: currentEditingOrder.totalAmount
        };
        
        // 未会計の注文を編集した場合は、会計済みにする
        if (isUnpaidOrder) {
          console.log(' 未会計の注文なので、会計済みとして更新します');
          console.log('   元の注文日時:', currentEditingOrder.timestamp.toDate().toLocaleString('ja-JP'));
          console.log('   paidAtとして設定する日時:', currentEditingOrder.timestamp.toDate().toLocaleString('ja-JP'));
          
          // timestampをpaidAtとして設定（元の注文日時で会計済みにする）
          orderUpdates.paidAt = currentEditingOrder.timestamp;
          orderUpdates.notifiedPaid = true;
          
          showCustomAlert(
            `注文を更新し、会計済みとしました\n\n会計日時: ${originalDateStr}`,
            '完了',
            ''
          );
        }
        
        await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), orderUpdates);
        console.log(' 注文データ更新完了');
        
        // 売上データを修正
        const isDateDifferent = originalDateStr !== todayDateStr;
        const isPaymentMethodChanged = oldPaymentMethod !== paymentMethod;
        const isAmountChanged = oldTotalAmount !== newTotalAmount;
        
        // 未会計注文の場合は常に更新が必要
        const needsUpdate = isUnpaidOrder || isDateDifferent || isPaymentMethodChanged || isAmountChanged;
        
        console.log(' 売上更新判定:', {
          元の日付: originalDateStr,
          本日: todayDateStr,
          未会計注文: isUnpaidOrder,
          日付が異なる: isDateDifferent,
          支払方法変更: isPaymentMethodChanged,
          金額変更: isAmountChanged,
          更新が必要: needsUpdate
        });
        
        if (!needsUpdate) {
          console.log('売上データの更新は不要です');
          showCustomAlert('注文を更新しました', '完了', '');
          closeEditOrderModal();
          await loadHistory();
          return;
        }
        
        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
        console.log(' 売上データ修正開始');
        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
          
          // ============================================
          // STEP 1: 本日の売上から減算（誤って本日に計上されている分）
          // ※ 未会計注文の場合はスキップ（まだ売上に計上されていない）
          // ============================================
          if (isDateDifferent && !isUnpaidOrder) {
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log(' STEP 1: 本日の売上から減算');
            console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
            console.log('対象日付:', todayDateStr);
            console.log('減算する金額:', oldTotalAmount);
            console.log('減算する支払方法:', oldPaymentMethod);
            
            const todaySalesRef = window.getStoreDoc('dailySales', todayDateStr);
            const todaySalesDoc = await window.getDoc(todaySalesRef);
            
            if (todaySalesDoc.exists()) {
              const todayData = todaySalesDoc.data();
              console.log('本日の売上データ（更新前）:', {
                totalSales: todayData.totalSales,
                cashSales: todayData.cashSales,
                emoneSales: todayData.emoneSales,
                creditSales: todayData.creditSales
              });
              
              const todayUpdates = {
                updatedAt: window.Timestamp.now()
              };
              
              // 【注意】本日の売上から、編集前の注文を減算
              // 支払方法は「編集前」のものを使う
              if (oldPaymentMethod === 'cash') {
                todayUpdates.cashSales = Math.max(0, (todayData.cashSales || 0) - oldTotalAmount);
                console.log(`   現金売上: ${todayData.cashSales} - ${oldTotalAmount} = ${todayUpdates.cashSales}`);
              } else if (oldPaymentMethod === 'emoney') {
                todayUpdates.emoneSales = Math.max(0, (todayData.emoneSales || 0) - oldTotalAmount);
                console.log(`   電子マネー売上: ${todayData.emoneSales} - ${oldTotalAmount} = ${todayUpdates.emoneSales}`);
              } else if (oldPaymentMethod === 'credit') {
                todayUpdates.creditSales = Math.max(0, (todayData.creditSales || 0) - oldTotalAmount);
                console.log(`   クレジット売上: ${todayData.creditSales} - ${oldTotalAmount} = ${todayUpdates.creditSales}`);
              }
              
              todayUpdates.totalSales = Math.max(0, (todayData.totalSales || 0) - oldTotalAmount);
              console.log(`   合計売上: ${todayData.totalSales} - ${oldTotalAmount} = ${todayUpdates.totalSales}`);
              
              await window.updateDoc(todaySalesRef, todayUpdates);
              console.log(' 本日の売上から減算完了');
            } else {
              console.warn(' 本日の売上データが見つかりません:', todayDateStr);
            }
          } else {
            console.log('本日と元の日付が同じ、または未会計注文のため、STEP 1はスキップ');
          }
          
          // ============================================
          // STEP 2: 元の日付の売上を修正（正しい日付に計上）
          // ============================================
          console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
          console.log(' STEP 2: 元の日付の売上を修正');
          console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
          console.log('対象日付:', originalDateStr);
          
          const originalSalesRef = window.getStoreDoc('dailySales', originalDateStr);
          const originalSalesDoc = await window.getDoc(originalSalesRef);
          
          if (originalSalesDoc.exists()) {
            const originalData = originalSalesDoc.data();
            console.log('元の日付の売上データ（更新前）:', {
              totalSales: originalData.totalSales,
              cashSales: originalData.cashSales,
              emoneSales: originalData.emoneSales,
              creditSales: originalData.creditSales
            });
            
            const originalUpdates = {
              updatedAt: window.Timestamp.now()
            };
            
            // 【パターンA】未会計注文の場合
            // → 単純に新しい内容を加算（減算は不要）
            if (isUnpaidOrder) {
              console.log(' パターンA: 未会計注文なので新しい内容を加算');
              console.log('   加算する金額:', newTotalAmount);
              console.log('   加算する支払方法:', paymentMethod);
              
              if (paymentMethod === 'cash') {
                originalUpdates.cashSales = (originalData.cashSales || 0) + newTotalAmount;
                console.log(`   現金売上: ${originalData.cashSales} + ${newTotalAmount} = ${originalUpdates.cashSales}`);
              } else if (paymentMethod === 'emoney') {
                originalUpdates.emoneSales = (originalData.emoneSales || 0) + newTotalAmount;
                console.log(`   電子マネー売上: ${originalData.emoneSales} + ${newTotalAmount} = ${originalUpdates.emoneSales}`);
              } else if (paymentMethod === 'credit') {
                originalUpdates.creditSales = (originalData.creditSales || 0) + newTotalAmount;
                console.log(`   クレジット売上: ${originalData.creditSales} + ${newTotalAmount} = ${originalUpdates.creditSales}`);
              }
              originalUpdates.totalSales = (originalData.totalSales || 0) + newTotalAmount;
              originalUpdates.customerCount = (originalData.customerCount || 0) + 1;  // 客数も加算
              console.log(`   合計売上: ${originalData.totalSales} + ${newTotalAmount} = ${originalUpdates.totalSales}`);
              console.log(`   客数: ${originalData.customerCount} + 1 = ${originalUpdates.customerCount}`);
            }
            // 【パターンB】元の日付と本日が異なる場合
            // → 元の日付に新しい内容を「加算」
            else if (isDateDifferent) {
              console.log(' パターンB: 異なる日付なので新しい内容を加算');
              console.log('   加算する金額:', newTotalAmount);
              console.log('   加算する支払方法:', paymentMethod);
              
              if (paymentMethod === 'cash') {
                originalUpdates.cashSales = (originalData.cashSales || 0) + newTotalAmount;
                console.log(`   現金売上: ${originalData.cashSales} + ${newTotalAmount} = ${originalUpdates.cashSales}`);
              } else if (paymentMethod === 'emoney') {
                originalUpdates.emoneSales = (originalData.emoneSales || 0) + newTotalAmount;
                console.log(`   電子マネー売上: ${originalData.emoneSales} + ${newTotalAmount} = ${originalUpdates.emoneSales}`);
              } else if (paymentMethod === 'credit') {
                originalUpdates.creditSales = (originalData.creditSales || 0) + newTotalAmount;
                console.log(`   クレジット売上: ${originalData.creditSales} + ${newTotalAmount} = ${originalUpdates.creditSales}`);
              }
              originalUpdates.totalSales = (originalData.totalSales || 0) + newTotalAmount;
              console.log(`   合計売上: ${originalData.totalSales} + ${newTotalAmount} = ${originalUpdates.totalSales}`);
            }
            // 【パターンC】元の日付と本日が同じ場合
            // → 支払方法や金額の変更を反映（差分計算）
            else {
              console.log(' パターンC: 同じ日付なので差分を計算');
              console.log('   旧:', oldPaymentMethod, oldTotalAmount);
              console.log('   新:', paymentMethod, newTotalAmount);
              
              // 旧支払方法から減算
              if (oldPaymentMethod === 'cash') {
                originalUpdates.cashSales = (originalData.cashSales || 0) - oldTotalAmount;
                console.log(`   現金売上（減算）: ${originalData.cashSales} - ${oldTotalAmount} = ${originalUpdates.cashSales}`);
              } else if (oldPaymentMethod === 'emoney') {
                originalUpdates.emoneSales = (originalData.emoneSales || 0) - oldTotalAmount;
                console.log(`   電子マネー売上（減算）: ${originalData.emoneSales} - ${oldTotalAmount} = ${originalUpdates.emoneSales}`);
              } else if (oldPaymentMethod === 'credit') {
                originalUpdates.creditSales = (originalData.creditSales || 0) - oldTotalAmount;
                console.log(`   クレジット売上（減算）: ${originalData.creditSales} - ${oldTotalAmount} = ${originalUpdates.creditSales}`);
              }
              
              // 新支払方法に加算
              if (paymentMethod === 'cash') {
                originalUpdates.cashSales = (originalUpdates.cashSales !== undefined ? originalUpdates.cashSales : originalData.cashSales || 0) + newTotalAmount;
                console.log(`   現金売上（加算）: + ${newTotalAmount} = ${originalUpdates.cashSales}`);
              } else if (paymentMethod === 'emoney') {
                originalUpdates.emoneSales = (originalUpdates.emoneSales !== undefined ? originalUpdates.emoneSales : originalData.emoneSales || 0) + newTotalAmount;
                console.log(`   電子マネー売上（加算）: + ${newTotalAmount} = ${originalUpdates.emoneSales}`);
              } else if (paymentMethod === 'credit') {
                originalUpdates.creditSales = (originalUpdates.creditSales !== undefined ? originalUpdates.creditSales : originalData.creditSales || 0) + newTotalAmount;
                console.log(`   クレジット売上（加算）: + ${newTotalAmount} = ${originalUpdates.creditSales}`);
              }
              
              // 合計売上の差額
              const amountDiff = newTotalAmount - oldTotalAmount;
              originalUpdates.totalSales = (originalData.totalSales || 0) + amountDiff;
              console.log(`   合計売上: ${originalData.totalSales} + ${amountDiff} = ${originalUpdates.totalSales}`);
            }
            
            // 負の値にならないように調整
            if (originalUpdates.cashSales !== undefined) originalUpdates.cashSales = Math.max(0, originalUpdates.cashSales);
            if (originalUpdates.emoneSales !== undefined) originalUpdates.emoneSales = Math.max(0, originalUpdates.emoneSales);
            if (originalUpdates.creditSales !== undefined) originalUpdates.creditSales = Math.max(0, originalUpdates.creditSales);
            if (originalUpdates.totalSales !== undefined) originalUpdates.totalSales = Math.max(0, originalUpdates.totalSales);
            
            console.log('最終更新データ:', originalUpdates);
            await window.updateDoc(originalSalesRef, originalUpdates);
            console.log(' 元の日付の売上修正完了');
          } else {
            console.error(' 元の日付の売上データが見つかりません:', originalDateStr);
          }
        
        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
        console.log(' 売上データ修正完了');
        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
        
        // 未会計注文の場合は上で既にアラート表示済み
        if (!isUnpaidOrder) {
          showCustomAlert('注文を更新しました', '完了', '');
        }
        closeEditOrderModal();
        
        // 履歴を再読み込み
        await loadHistory();
        
      } catch (e) {
        console.error('注文更新エラー:', e);
        showCustomAlert('注文の更新に失敗しました: ' + e.message, 'エラー', 'warning');
      }
    };
    
    // 編集モーダルから注文を削除
    window.deleteOrderFromEdit = async function() {
      if (!currentEditingOrder) return;
      
      // カスタム確認ダイアログを表示
      const confirmed = await showCustomConfirm({
        icon: '️',
        title: '注文取消（キャンセル）',
        message: `注文 #${currentEditingOrder.orderNumber} を取り消しますか？\n金額: ¥${currentEditingOrder.totalAmount.toLocaleString()}\n\n取消後、この注文は売上から除外されます。\n※ 履歴から復元できます`,
        confirmText: '取消する',
        confirmColor: '#f44336'
      });
      
      if (!confirmed) return;
      
      try {
        console.log('️ 注文取消処理開始:', {
          注文ID: currentEditingOrder.id,
          注文番号: currentEditingOrder.orderNumber,
          金額: currentEditingOrder.totalAmount,
          会計済み: !!currentEditingOrder.paidAt
        });
        
        // 1. 注文を取消（deleted: true）
        await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), {
          deleted: true,
          deletedAt: window.Timestamp.now(),
          cancelReason: '注文取消'
        });
        
        console.log(' 注文を取り消しました。');
        
        // 2. 会計済みの注文の場合、dailySalesから減算
        if (currentEditingOrder.paidAt) {
          console.log(' 会計済み注文のため、dailySalesを更新します');
          
          // 注文日を取得（JSTに変換）
          const orderDate = currentEditingOrder.timestamp.toDate();
          const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
          const dateStr = `${jstOrderDate.getFullYear()}-${String(jstOrderDate.getMonth() + 1).padStart(2, '0')}-${String(jstOrderDate.getDate()).padStart(2, '0')}`;
          
          console.log('注文日:', dateStr);
          
          // dailySalesを取得
          const dailySalesRef = window.getStoreDoc('dailySales', dateStr);
          const dailySalesDoc = await window.getDoc(dailySalesRef);
          
          if (dailySalesDoc.exists()) {
            const dailyData = dailySalesDoc.data();
            
            // 注文金額と税金を取得
            const totalAmount = currentEditingOrder.totalAmount || 0;
            const tax8Total = currentEditingOrder.tax8Total || 0;
            const tax10Total = currentEditingOrder.tax10Total || 0;
            
            // 支払い方法別の金額
            let cashSales = 0, emoneSales = 0, creditSales = 0;
            if (currentEditingOrder.paymentMethod === '現金') cashSales = totalAmount;
            else if (currentEditingOrder.paymentMethod === '電子マネー') emoneSales = totalAmount;
            else if (currentEditingOrder.paymentMethod === 'クレジットカード') creditSales = totalAmount;
            
            // 商品数を計算
            let totalItems = 0;
            if (currentEditingOrder.items && Array.isArray(currentEditingOrder.items)) {
              currentEditingOrder.items.forEach(item => {
                totalItems += item.quantity || 0;
              });
            }
            
            // 更新データを作成（マイナスにならないようにする）
            const updateData = {
              totalSales: Math.max(0, (dailyData.totalSales || 0) - totalAmount),
              customerCount: Math.max(0, (dailyData.customerCount || 0) - 1),
              totalItems: Math.max(0, (dailyData.totalItems || 0) - totalItems),
              cashSales: Math.max(0, (dailyData.cashSales || 0) - cashSales),
              emoneSales: Math.max(0, (dailyData.emoneSales || 0) - emoneSales),
              creditSales: Math.max(0, (dailyData.creditSales || 0) - creditSales),
              tax8Total: Math.max(0, (dailyData.tax8Total || 0) - tax8Total),
              tax10Total: Math.max(0, (dailyData.tax10Total || 0) - tax10Total)
            };
            
            console.log(' dailySales更新:', {
              元の総売上: dailyData.totalSales,
              減算額: totalAmount,
              新しい総売上: updateData.totalSales
            });
            
            // dailySalesを更新
            await window.updateDoc(dailySalesRef, updateData);
            
            console.log(' dailySalesを更新しました');
          } else {
            console.warn(' dailySalesが見つかりません:', dateStr);
          }
        } else {
          console.log('未会計の注文のため、dailySalesの更新は不要です');
        }
        
        showCustomAlert(
          `注文 #${currentEditingOrder.orderNumber} を取り消しました\n\n売上から除外されます`,
          '取消完了',
          '️'
        );
        closeEditOrderModal();
        
        // 履歴を再読み込み
        await loadHistory();
        
      } catch (e) {
        console.error('注文取消エラー:', e);
        showCustomAlert('注文の取消に失敗しました: ' + e.message, 'エラー', 'warning');
      }
    };
    
    // 赤伝票用の税率選択モーダル
    window.showTaxRateSelectionModal = async function(orderData) {
      console.log('showTaxRateSelectionModal called with:', orderData);
      
      return new Promise((resolve) => {
        console.log(' Creating tax rate selection modal...');
        
        // モーダルを作成
        const modalHtml = `
          <div id="taxRateSelectionModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;">
            <div style="background: white; border-radius: 20px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
              <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #333; text-align: center;"> 赤伝票：税率選択</h2>
              <p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 14px;">各商品の税率を選択してください</p>
              
              <div id="taxRateItemsList" style="margin-bottom: 20px;">
                <!-- 商品リストがここに挿入されます -->
              </div>
              
              <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="cancelTaxRateSelection()" style="flex: 1; padding: 15px; background: #999; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer;">
                  キャンセル
                </button>
                <button onclick="confirmTaxRateSelection()" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer;">
                  確定して次へ
                </button>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        console.log(' Modal HTML inserted');
        
        // 商品リストを作成
        const itemsList = document.getElementById('taxRateItemsList');
        let itemsHtml = '';
        
        console.log(' Building items list...');
        
        if (orderData.items && Array.isArray(orderData.items)) {
          console.log(` Found ${orderData.items.length} items`);
          
          orderData.items.forEach((item, index) => {
            const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
            const defaultTaxRate = item.taxRate || 10;
            
            console.log(`  Item ${index}: ${item.name}, taxRate: ${defaultTaxRate}`);
            
            itemsHtml += `
              <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #667eea;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <div style="flex: 1;">
                    <div style="font-weight: bold; color: #333; font-size: 16px;">${item.name}</div>
                    ${item.toppingName ? `<div style="font-size: 13px; color: #666; margin-top: 3px;">トッピング: ${item.toppingName}</div>` : ''}
                    <div style="font-size: 14px; color: #666; margin-top: 5px;">数量: ${item.quantity} × ¥${(item.price + (item.toppingPrice || 0)).toLocaleString()}</div>
                  </div>
                  <div style="font-size: 18px; font-weight: bold; color: #667eea;">
                    ¥${itemTotal.toLocaleString()}
                  </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                  <label style="flex: 1; cursor: pointer;">
                    <input type="radio" name="taxRate${index}" value="8" ${defaultTaxRate === 8 ? 'checked' : ''} style="margin-right: 5px;">
                    <span style="font-size: 15px; font-weight: bold; color: #4CAF50;">8% (軽減税率)</span>
                  </label>
                  <label style="flex: 1; cursor: pointer;">
                    <input type="radio" name="taxRate${index}" value="10" ${defaultTaxRate === 10 ? 'checked' : ''} style="margin-right: 5px;">
                    <span style="font-size: 15px; font-weight: bold; color: #667eea;">10% (標準税率)</span>
                  </label>
                </div>
              </div>
            `;
          });
        } else {
          console.warn(' No items found in orderData');
        }
        
        itemsList.innerHTML = itemsHtml;
        console.log(' Items list populated');
        
        // 確定ボタンのハンドラ
        window.confirmTaxRateSelection = function() {
          console.log(' Confirm button clicked');
          const selections = [];
          
          if (orderData.items && Array.isArray(orderData.items)) {
            orderData.items.forEach((item, index) => {
              const selected = document.querySelector(`input[name="taxRate${index}"]:checked`);
              const selectedValue = selected ? parseInt(selected.value) : 10;
              selections.push(selectedValue);
              console.log(`  Item ${index} (${item.name}): ${selectedValue}%`);
            });
          }
          
          const modal = document.getElementById('taxRateSelectionModal');
          modal.remove();
          
          delete window.confirmTaxRateSelection;
          delete window.cancelTaxRateSelection;
          
          console.log(' Resolving with selections:', selections);
          resolve(selections);
        };
        
        // キャンセルボタンのハンドラ
        window.cancelTaxRateSelection = function() {
          console.log(' Cancel button clicked');
          const modal = document.getElementById('taxRateSelectionModal');
          modal.remove();
          
          delete window.confirmTaxRateSelection;
          delete window.cancelTaxRateSelection;
          
          resolve(null);
        };
      });
    };
    
    // 編集モーダルから赤伝票（会計済み注文の完全取消）
    window.redSlipFromEdit = async function() {
      console.log(' 赤伝票処理開始');
      
      if (!currentEditingOrder) return;
      
      const orderData = currentEditingOrder;
      
      if (!orderData.paidAt) {
        showCustomAlert('会計済みの注文のみ赤伝票できます', '警告', 'warning');
        return;
      }
      
      console.log(' 注文データ:', orderData);
      console.log(' 商品一覧:', orderData.items);
      
      // 確認ダイアログ
      const confirmed = await showCustomConfirm({
        icon: '',
        title: '赤伝票（完全取消）',
        message: `注文 #${orderData.orderNumber} を赤伝票で完全取消しますか？\n\n金額: ¥${orderData.totalAmount.toLocaleString()}\n\n重要な注意事項:\n• 売上から完全に除外されます\n• 客数も減少します\n• 復元できません（伝票打ち直しが必要）\n• この操作は取り消せません`,
        btnText: '赤伝票で取消',
        btnClass: 'modal-btn-danger'
      });
      
      if (!confirmed) return;
      
      try {
        console.log(' 赤伝票処理開始（編集モーダルから）:', {
          注文ID: orderData.id,
          注文番号: orderData.orderNumber,
          金額: orderData.totalAmount
        });
        
        // 会計日時から営業日を計算（3時基準）
        const paidDate = orderData.paidAt.toDate();
        let businessDate = new Date(paidDate);
        
        if (paidDate.getHours() < 3) {
          businessDate.setDate(businessDate.getDate() - 1);
        }
        
        const dateStr = `${businessDate.getFullYear()}-${String(businessDate.getMonth() + 1).padStart(2, '0')}-${String(businessDate.getDate()).padStart(2, '0')}`;
        
        console.log('営業日:', dateStr);
        
        // dailySalesを取得
        const dailySalesRef = window.getStoreDoc('dailySales', dateStr);
        const dailySalesDoc = await window.getDoc(dailySalesRef);
        
        if (!dailySalesDoc.exists()) {
          showCustomAlert('この営業日のdailySalesが見つかりません\n営業日: ' + dateStr, '警告', 'warning');
          return;
        }
        
        const dailyData = dailySalesDoc.data();
        
        // 注文金額を取得
        const totalAmount = orderData.totalAmount || 0;
        
        // 会計時の税率で計算
        let tax8Total = 0;
        let tax10Total = 0;
        
        console.log(' 赤伝票の税率計算開始:');
        
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach((item, index) => {
            const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
            // 会計時に記録された税率を使用
            let itemTaxRate = item.taxRate;
            
            // taxRateがない場合はtakeoutフラグで判定
            if (!itemTaxRate) {
              itemTaxRate = item.takeout ? 8 : 10;
            }
            
            console.log(`  商品 ${index + 1}: ${item.name}`, {
              price: item.price,
              toppingPrice: item.toppingPrice || 0,
              quantity: item.quantity,
              itemTotal: itemTotal,
              taxRate: itemTaxRate,
              takeout: item.takeout
            });
            
            if (itemTaxRate === 8) {
              tax8Total += itemTotal;
            } else if (itemTaxRate === 10) {
              tax10Total += itemTotal;
            }
          });
          
          // レジ袋の税金も加算
          if (orderData.bagNeeded && orderData.bagQuantity > 0) {
            const bagTotal = orderData.bagQuantity * 3;
            console.log('  レジ袋:', {
              quantity: orderData.bagQuantity,
              total: bagTotal,
              taxRate: 10
            });
            tax10Total += bagTotal;
          }
          
          console.log(' 税率別合計:', {
            税込合計: totalAmount,
            '8%対象': tax8Total,
            '10%対象': tax10Total,
            '合計': tax8Total + tax10Total
          });
        }
        
        // 支払い方法別の金額
        let cashSales = 0, emoneSales = 0, creditSales = 0;
        const paymentMethod = orderData.paymentMethod || '';
        if (paymentMethod === '現金' || paymentMethod === 'cash') cashSales = totalAmount;
        else if (paymentMethod === '電子マネー' || paymentMethod === 'emoney') emoneSales = totalAmount;
        else if (paymentMethod === 'クレジットカード' || paymentMethod === 'credit') creditSales = totalAmount;
        
        // 商品数を計算
        let totalItems = 0;
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            totalItems += item.quantity || 0;
          });
        }
        
        console.log(' dailySalesから減算:', {
          売上: totalAmount,
          客数: 1,
          商品数: totalItems,
          '8%税金': tax8Total,
          '10%税金': tax10Total
        });
        
        // dailySalesから減算 + 赤伝票情報を記録
        const updateData = {
          totalSales: Math.max(0, (dailyData.totalSales || 0) - totalAmount),
          customerCount: Math.max(0, (dailyData.customerCount || 0) - 1),
          totalItems: Math.max(0, (dailyData.totalItems || 0) - totalItems),
          cashSales: Math.max(0, (dailyData.cashSales || 0) - cashSales),
          emoneSales: Math.max(0, (dailyData.emoneSales || 0) - emoneSales),
          creditSales: Math.max(0, (dailyData.creditSales || 0) - creditSales),
          tax8Total: Math.max(0, (dailyData.tax8Total || 0) - tax8Total),
          tax10Total: Math.max(0, (dailyData.tax10Total || 0) - tax10Total),
          redSlipCount: (dailyData.redSlipCount || 0) + 1,  // 赤伝票件数
          redSlipAmount: (dailyData.redSlipAmount || 0) + totalAmount,  // 赤伝票金額
          redSlipTax8Total: (dailyData.redSlipTax8Total || 0) + tax8Total,  // 赤伝票8%税金
          redSlipTax10Total: (dailyData.redSlipTax10Total || 0) + tax10Total  // 赤伝票10%税金
        };
        
        console.log(' dailySales更新:', {
          更新前: { 
            totalSales: dailyData.totalSales, 
            customerCount: dailyData.customerCount,
            赤伝票件数: dailyData.redSlipCount || 0,
            赤伝票金額: dailyData.redSlipAmount || 0
          },
          更新後: { 
            totalSales: updateData.totalSales, 
            customerCount: updateData.customerCount,
            赤伝票件数: updateData.redSlipCount,
            赤伝票金額: updateData.redSlipAmount
          }
        });
        
        // dailySalesを更新
        await window.updateDoc(dailySalesRef, updateData);
        
        // redSlipsコレクションに保存（監査用）
        const redSlipData = {
          ...orderData,
          redSlippedAt: window.Timestamp.now(),
          redSlippedBy: window.currentStoreId,
          businessDate: dateStr,
          originalOrderId: orderData.id,
          calculatedTax8Total: tax8Total,
          calculatedTax10Total: tax10Total
        };
        
        const redSlipRef = window.doc(window.collection(window.db, 'stores', window.currentStoreId, 'redSlips'));
        await window.setDoc(redSlipRef, redSlipData);
        
        console.log(' redSlipsコレクションに保存しました:', redSlipRef.id);
        
        // 注文を削除（redSlipsに移動済み）
        await window.deleteDoc(window.getStoreDoc('orders', orderData.id));
        
        console.log(' 赤伝票処理完了 - 注文を削除し、redSlipsに保存しました');
        
        showCustomAlert(
          `注文 #${orderData.orderNumber} を赤伝票で取り消しました\n\n金額: ¥${totalAmount.toLocaleString()}\n8%対象: ¥${tax8Total.toLocaleString()}\n10%対象: ¥${tax10Total.toLocaleString()}\n\n売上・客数から除外されました\n※ 復元不可（伝票打ち直しが必要）`,
          '赤伝票完了',
          ''
        );
        
        closeEditOrderModal();
        
        // 履歴を再読み込み
        await loadHistory();
        
      } catch (e) {
        console.error('赤伝票エラー:', e);
        showCustomAlert('赤伝票処理に失敗しました: ' + e.message, 'エラー', 'warning');
      }
    };
    
    // 注文を復元（未会計注文のみ）
    window.restoreOrder = async function() {
      if (!currentEditingOrder) return;
      
      // paidAtの有無を確認
      const hasPaidAt = !!currentEditingOrder.paidAt;
      
      // 会計済み注文は復元不可
      if (hasPaidAt) {
        showCustomAlert('会計済みの注文は復元できません\n\n赤伝票で取り消された注文は、\n新しく伝票を打ち直してください', '復元不可', '');
        return;
      }
      
      // カスタム確認ダイアログを表示
      const confirmed = await showCustomConfirm({
        icon: '',
        title: '注文を復元',
        message: `注文 #${currentEditingOrder.orderNumber} を復元しますか？\n\nこの注文は未会計です。\n復元後に会計処理を行ってください。`,
        btnText: '復元する',
        btnClass: 'modal-btn-primary'
      });
      
      if (!confirmed) return;
      
      try {
        const updates = {
          deleted: false,
          deletedAt: null
        };
        
        console.log(' 未会計注文復元:', {
          注文番号: currentEditingOrder.orderNumber,
          timestamp: currentEditingOrder.timestamp
        });
        
        await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), updates);
        
        console.log(' 未会計注文を復元しました');
        
        showCustomAlert(
          '注文を復元しました（未会計）\n\n会計処理を行ってください',
          '成功',
          ''
        );
        closeEditOrderModal();
        
        // 履歴を再読み込み
        await loadHistory();
        
      } catch (e) {
        console.error('注文復元エラー:', e);
        showCustomAlert('注文の復元に失敗しました: ' + e.message, 'エラー', 'warning');
      }
    };
    
    // 履歴画面から直接削除（注文取消）
    window.deleteOrderFromHistory = async function(orderId) {
      console.log(' 削除ボタンがクリックされました。注文ID:', orderId);
      
      try {
        console.log('Firestoreから注文を取得中...');
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        
        if (!orderDoc.exists()) {
          console.error(' 注文が見つかりません:', orderId);
          showCustomAlert('注文が見つかりません', 'エラー', 'warning');
          return;
        }
        
        const orderData = orderDoc.data();
        console.log(' 注文データを取得しました:', {
          注文ID: orderId,
          注文番号: orderData.orderNumber,
          金額: orderData.totalAmount,
          会計済み: !!orderData.paidAt,
          既に削除済み: !!orderData.deleted
        });
        
        // カスタム確認ダイアログを表示
        console.log(' 確認ダイアログを表示中...');
        const confirmed = await showCustomConfirm({
          icon: '️',
          title: '注文取消（キャンセル）',
          message: `注文 #${orderData.orderNumber} を取り消しますか？\n金額: ¥${orderData.totalAmount.toLocaleString()}\n\n取消後、この注文は売上から除外されます。\n※ 履歴から復元できます`,
          confirmText: '取消する',
          confirmColor: '#f44336'
        });
        
        if (!confirmed) {
          console.log('️ ユーザーがキャンセルしました');
          return;
        }
        
        console.log('️ 注文取消処理を実行中...');
        console.log('更新するパス:', window.getStoreDoc('orders', orderId).path);
        
        // 1. 注文を削除（取消）扱いにする
        await window.updateDoc(window.getStoreDoc('orders', orderId), {
          deleted: true,
          deletedAt: window.Timestamp.now(),
          cancelReason: '注文取消'
        });
        
        console.log(' 注文を取り消しました！');
        
        // 2. 会計済みの注文の場合、dailySalesから減算
        if (orderData.paidAt) {
          console.log(' 会計済み注文のため、dailySalesを更新します');
          console.log(' 注文データ詳細:', JSON.stringify(orderData, null, 2));
          
          //  修正: 会計日時から営業日を計算（3時基準）
          const paidDate = orderData.paidAt.toDate();
          console.log(' 会計日時（paidAt）:', paidDate);
          console.log(' paidDate.getHours():', paidDate.getHours());
          
          let businessDate = new Date(paidDate);
          
          // 3時より前の場合は前日の営業日扱い
          if (paidDate.getHours() < 3) {
            businessDate.setDate(businessDate.getDate() - 1);
            console.log(' 3時より前なので前日扱い');
          }
          
          const dateStr = `${businessDate.getFullYear()}-${String(businessDate.getMonth() + 1).padStart(2, '0')}-${String(businessDate.getDate()).padStart(2, '0')}`;
          
          console.log('会計日時:', paidDate);
          console.log('営業日:', dateStr);
          
          // dailySalesを取得
          const dailySalesRef = window.getStoreDoc('dailySales', dateStr);
          console.log('dailySalesパス:', dailySalesRef.path);
          
          const dailySalesDoc = await window.getDoc(dailySalesRef);
          console.log(' dailySales存在:', dailySalesDoc.exists());
          
          if (dailySalesDoc.exists()) {
            const dailyData = dailySalesDoc.data();
            console.log(' 現在のdailySalesデータ:', JSON.stringify(dailyData, null, 2));
            
            // 注文金額と税金を取得
            const totalAmount = orderData.totalAmount || 0;
            const tax8Total = orderData.tax8Total || 0;
            const tax10Total = orderData.tax10Total || 0;
            
            // 支払い方法別の金額（日本語と英語の両方に対応）
            let cashSales = 0, emoneSales = 0, creditSales = 0;
            const paymentMethod = orderData.paymentMethod || '';
            console.log('支払い方法（生データ）:', paymentMethod, '型:', typeof paymentMethod);
            
            if (paymentMethod === '現金' || paymentMethod === 'cash') cashSales = totalAmount;
            else if (paymentMethod === '電子マネー' || paymentMethod === 'emoney') emoneSales = totalAmount;
            else if (paymentMethod === 'クレジットカード' || paymentMethod === 'credit') creditSales = totalAmount;
            
            console.log('支払い方法:', paymentMethod, '→ 減算額:', { cashSales, emoneSales, creditSales });
            
            // 商品数を計算
            let totalItems = 0;
            if (orderData.items && Array.isArray(orderData.items)) {
              orderData.items.forEach(item => {
                totalItems += item.quantity || 0;
              });
            }
            console.log(' 商品数:', totalItems);
            
            // 更新データを作成（マイナスにならないようにする）
            const updateData = {
              totalSales: Math.max(0, (dailyData.totalSales || 0) - totalAmount),
              customerCount: Math.max(0, (dailyData.customerCount || 0) - 1),
              totalItems: Math.max(0, (dailyData.totalItems || 0) - totalItems),
              cashSales: Math.max(0, (dailyData.cashSales || 0) - cashSales),
              emoneSales: Math.max(0, (dailyData.emoneSales || 0) - emoneSales),
              creditSales: Math.max(0, (dailyData.creditSales || 0) - creditSales),
              tax8Total: Math.max(0, (dailyData.tax8Total || 0) - tax8Total),
              tax10Total: Math.max(0, (dailyData.tax10Total || 0) - tax10Total)
            };
            
            console.log(' dailySales更新:', {
              元の総売上: dailyData.totalSales,
              減算額: totalAmount,
              新しい総売上: updateData.totalSales,
              元の客数: dailyData.customerCount,
              新しい客数: updateData.customerCount,
              元のcashSales: dailyData.cashSales,
              新しいcashSales: updateData.cashSales,
              元のemoneSales: dailyData.emoneSales,
              新しいemoneSales: updateData.emoneSales,
              元のcreditSales: dailyData.creditSales,
              新しいcreditSales: updateData.creditSales
            });
            
            // dailySalesを更新
            console.log(' dailySalesを更新中...');
            await window.updateDoc(dailySalesRef, updateData);
            
            console.log(' dailySalesを更新しました');
            
            // 更新後の確認
            const updatedDoc = await window.getDoc(dailySalesRef);
            console.log(' 更新後のdailySalesデータ:', JSON.stringify(updatedDoc.data(), null, 2));
          } else {
            console.warn(' dailySalesが見つかりません:', dateStr);
            alert('警告: この営業日のdailySalesデータが見つかりません\n営業日: ' + dateStr);
          }
        } else {
          console.log('未会計の注文のため、dailySalesの更新は不要です');
        }
        
        console.log(' 確定申告と精算実行の売上から除外されます');
        
        showCustomAlert(
          `注文 #${orderData.orderNumber} を取り消しました\n\n売上から除外されます`,
          '取消完了',
          '️'
        );
        
        // 履歴を再読み込み
        console.log(' 履歴を再読み込み中...');
        await loadHistory();
        console.log(' 履歴の再読み込み完了');
        
      } catch (e) {
        console.error(' 注文取消エラー:', e);
        console.error('エラー詳細:', e.stack);
        showCustomAlert('注文の取消に失敗しました: ' + e.message, 'エラー', 'warning');
      }
    };
    
    // 履歴画面から直接復元（未会計注文のみ）
    window.restoreOrderFromHistory = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        if (!orderDoc.exists()) {
          showCustomAlert('注文が見つかりません', 'エラー', 'warning');
          return;
        }
        
        const orderData = orderDoc.data();
        const hasPaidAt = !!orderData.paidAt;
        
        // 会計済み注文は復元不可
        if (hasPaidAt) {
          showCustomAlert('会計済みの注文は復元できません\n\n赤伝票で取り消された注文は、\n新しく伝票を打ち直してください', '復元不可', '');
          return;
        }
        
        // カスタム確認ダイアログを表示
        const confirmed = await showCustomConfirm({
          icon: '',
          title: '注文を復元',
          message: `注文 #${orderData.orderNumber} を復元しますか？\n\nこの注文は未会計です。\n復元後に会計処理を行ってください。`,
          btnText: '復元する',
          btnClass: 'modal-btn-primary'
        });
        
        if (!confirmed) return;
        
        // 注文を復元（未会計注文のみ）
        await window.updateDoc(window.getStoreDoc('orders', orderId), {
          deleted: false,
          deletedAt: null
        });
        
        console.log(' 未会計注文を復元しました');
        
        showCustomAlert(
          '注文を復元しました（未会計）\n\n会計処理を行ってください',
          '成功',
          ''
        );
        
        // 履歴を再読み込み
        await loadHistory();
        
      } catch (e) {
        console.error('注文復元エラー:', e);
        showCustomAlert('注文の復元に失敗しました: ' + e.message, 'エラー', 'warning');
      }
    };
    
    // ==========  赤伝票機能 ==========
    
    // 赤伝票処理（会計済み注文の完全取消）
    window.redSlip = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        if (!orderDoc.exists()) {
          showCustomAlert('注文が見つかりません', 'エラー', 'warning');
          return;
        }
        
        const orderData = orderDoc.data();
        
        if (!orderData.paidAt) {
          showCustomAlert('会計済みの注文のみ赤伝票できます', '警告', 'warning');
          return;
        }
        
        // 確認ダイアログ
        const confirmed = await showCustomConfirm({
          icon: '',
          title: '赤伝票（完全取消）',
          message: `注文 #${orderData.orderNumber} を赤伝票で完全取消しますか？\n\n金額: ¥${orderData.totalAmount.toLocaleString()}\n\n重要な注意事項:\n• 売上から完全に除外されます\n• 客数も減少します\n• 復元できません（伝票打ち直しが必要）\n• この操作は取り消せません`,
          btnText: '赤伝票で取消',
          btnClass: 'modal-btn-danger'
        });
        
        if (!confirmed) return;
        
        console.log(' 赤伝票処理開始:', {
          注文ID: orderId,
          注文番号: orderData.orderNumber,
          金額: orderData.totalAmount
        });
        
        // 会計日時から営業日を計算（3時基準）
        const paidDate = orderData.paidAt.toDate();
        let businessDate = new Date(paidDate);
        
        if (paidDate.getHours() < 3) {
          businessDate.setDate(businessDate.getDate() - 1);
        }
        
        const dateStr = `${businessDate.getFullYear()}-${String(businessDate.getMonth() + 1).padStart(2, '0')}-${String(businessDate.getDate()).padStart(2, '0')}`;
        
        console.log('営業日:', dateStr);
        
        // dailySalesを取得
        const dailySalesRef = window.getStoreDoc('dailySales', dateStr);
        const dailySalesDoc = await window.getDoc(dailySalesRef);
        
        if (!dailySalesDoc.exists()) {
          showCustomAlert('この営業日のdailySalesが見つかりません\n営業日: ' + dateStr, '警告', 'warning');
          return;
        }
        
        const dailyData = dailySalesDoc.data();
        
        // 注文金額を取得
        const totalAmount = orderData.totalAmount || 0;
        
        // 税金を取得または再計算
        let tax8Total = orderData.tax8Total || 0;
        let tax10Total = orderData.tax10Total || 0;
        
        //  税金情報がない場合、itemsから再計算
        if (tax8Total === 0 && tax10Total === 0 && orderData.items && Array.isArray(orderData.items)) {
          console.log(' 税金情報がないため、itemsから再計算します');
          
          orderData.items.forEach(item => {
            const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
            const taxRate = item.taxRate || 10; // デフォルトは10%
            
            if (taxRate === 8) {
              tax8Total += itemTotal;
            } else if (taxRate === 10) {
              tax10Total += itemTotal;
            }
          });
          
          // レジ袋の税金も加算
          if (orderData.bagNeeded && orderData.bagQuantity > 0) {
            const bagTotal = orderData.bagQuantity * 3;
            // レジ袋は通常10%
            tax10Total += bagTotal;
          }
          
          console.log(' 再計算した税金:', {
            税込合計: totalAmount,
            '8%対象': tax8Total,
            '10%対象': tax10Total
          });
        }
        
        // 支払い方法別の金額
        let cashSales = 0, emoneSales = 0, creditSales = 0;
        const paymentMethod = orderData.paymentMethod || '';
        if (paymentMethod === '現金' || paymentMethod === 'cash') cashSales = totalAmount;
        else if (paymentMethod === '電子マネー' || paymentMethod === 'emoney') emoneSales = totalAmount;
        else if (paymentMethod === 'クレジットカード' || paymentMethod === 'credit') creditSales = totalAmount;
        
        // 商品数を計算
        let totalItems = 0;
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            totalItems += item.quantity || 0;
          });
        }
        
        console.log(' dailySalesから減算:', {
          売上: totalAmount,
          客数: 1,
          商品数: totalItems,
          現金: cashSales,
          電子マネー: emoneSales,
          クレジット: creditSales,
          '8%税金': tax8Total,
          '10%税金': tax10Total
        });
        
        // dailySalesから減算 + 赤伝票情報を記録
        const updateData = {
          totalSales: Math.max(0, (dailyData.totalSales || 0) - totalAmount),
          customerCount: Math.max(0, (dailyData.customerCount || 0) - 1),
          totalItems: Math.max(0, (dailyData.totalItems || 0) - totalItems),
          cashSales: Math.max(0, (dailyData.cashSales || 0) - cashSales),
          emoneSales: Math.max(0, (dailyData.emoneSales || 0) - emoneSales),
          creditSales: Math.max(0, (dailyData.creditSales || 0) - creditSales),
          tax8Total: Math.max(0, (dailyData.tax8Total || 0) - tax8Total),
          tax10Total: Math.max(0, (dailyData.tax10Total || 0) - tax10Total),
          redSlipCount: (dailyData.redSlipCount || 0) + 1,  // 赤伝票件数
          redSlipAmount: (dailyData.redSlipAmount || 0) + totalAmount,  // 赤伝票金額
          redSlipTax8Total: (dailyData.redSlipTax8Total || 0) + tax8Total,  // 赤伝票8%税金
          redSlipTax10Total: (dailyData.redSlipTax10Total || 0) + tax10Total  // 赤伝票10%税金
        };
        
        console.log(' dailySales更新:', {
          更新前: {
            totalSales: dailyData.totalSales,
            customerCount: dailyData.customerCount,
            赤伝票件数: dailyData.redSlipCount || 0,
            赤伝票金額: dailyData.redSlipAmount || 0
          },
          更新後: {
            totalSales: updateData.totalSales,
            customerCount: updateData.customerCount,
            赤伝票件数: updateData.redSlipCount,
            赤伝票金額: updateData.redSlipAmount
          }
        });
        
        // dailySalesを更新
        await window.updateDoc(dailySalesRef, updateData);
        
        // redSlipsコレクションに保存（監査用）
        const redSlipData = {
          ...orderData,
          redSlippedAt: window.Timestamp.now(),
          redSlippedBy: window.currentStoreId,
          businessDate: dateStr,
          originalOrderId: orderId
        };
        
        const redSlipRef = window.doc(window.collection(window.db, 'stores', window.currentStoreId, 'redSlips'));
        await window.setDoc(redSlipRef, redSlipData);
        
        console.log(' redSlipsコレクションに保存しました:', redSlipRef.id);
        
        // 注文を削除（redSlipsに移動済み）
        await window.deleteDoc(window.getStoreDoc('orders', orderId));
        
        console.log(' 赤伝票処理完了 - 注文を削除し、redSlipsに保存しました');
        
        showCustomAlert(
          `注文 #${orderData.orderNumber} を赤伝票で取り消しました\n\n金額: ¥${totalAmount.toLocaleString()}\n\n売上・客数から除外されました\n※ 復元不可（伝票打ち直しが必要）`,
          '赤伝票完了',
          ''
        );
        
        // 履歴を再読み込み
        await loadHistory();
        
      } catch (e) {
        console.error('赤伝票エラー:', e);
        showCustomAlert('赤伝票処理に失敗しました: ' + e.message, 'エラー', 'warning');
      }
    };
    
    // ========== 月次レポート機能 ==========
    
    // 月次レポートモーダルを表示
    window.showMonthlyReportModal = async function() {
      // 当月の開始日と終了日を初期値として設定
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      
      const startDate = `${year}-${month}-01`;
      const lastDay = new Date(year, now.getMonth() + 1, 0).getDate();
      const endDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;
      
      document.getElementById('reportStartDate').value = startDate;
      document.getElementById('reportEndDate').value = endDate;
      
      document.getElementById('monthlyReportModal').classList.remove('hidden');
      
      // グラフを生成
      await generateMonthlyCharts();
    };
    
    // 月次推移グラフを生成
    window.generateMonthlyCharts = async function() {
      try {
        console.log(' 月次グラフ生成開始');
        
        // Firebase初期化を待つ
        if (!window.firebaseReady) {
          await new Promise(resolve => {
            window.addEventListener('firebaseReady', resolve, { once: true });
          });
        }
        
        // 過去3ヶ月のデータを取得
        const now = new Date();
        const monthsData = [];
        
        for (let i = 2; i >= 0; i--) {
          const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const year = targetDate.getFullYear();
          const month = targetDate.getMonth() + 1;
          const monthStr = String(month).padStart(2, '0');
          const lastDay = new Date(year, month, 0).getDate();
          
          // その月のデータを集計
          let totalSales = 0;
          let totalLaborCost = 0;
          let totalExpense = 0;
          let workDays = 0;
          
          // 日次売上データを取得
          const salesSnapshot = await window.getDocs(window.getStoreCollection('dailySales'));
          salesSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.date && data.date.startsWith(`${year}-${monthStr}`)) {
              totalSales += data.totalSales || 0;
            }
          });
          
          // 勤怠データから人件費を計算
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.date && data.date.startsWith(`${year}-${monthStr}`)) {
              // 既に計算済みの総賃金がある場合はそれを使用
              if (data.totalWage && data.totalWage > 0) {
                totalLaborCost += data.totalWage;
                workDays++;
              } else if (data.clockIn && data.clockOut) {
                // 総賃金がない場合は計算する
                const clockIn = new Date(`${data.date} ${data.clockIn}`);
                const clockOut = new Date(`${data.date} ${data.clockOut}`);
                let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                
                if (data.breakStart1 && data.breakEnd1) {
                  const breakStart1 = new Date(`${data.date} ${data.breakStart1}`);
                  const breakEnd1 = new Date(`${data.date} ${data.breakEnd1}`);
                  workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                }
                if (data.breakStart2 && data.breakEnd2) {
                  const breakStart2 = new Date(`${data.date} ${data.breakStart2}`);
                  const breakEnd2 = new Date(`${data.date} ${data.breakEnd2}`);
                  workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                }
                
                const hourlyRate = data.hourlyRate || 1150;
                
                // 割増賃金の計算
                let totalWage = 0;
                const isHoliday = data.isHoliday || false;
                
                // 時間ごとに割増率を計算
                let currentTime = new Date(clockIn);
                const endTime = new Date(clockOut);
                
                while (currentTime < endTime) {
                  const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                  const segmentEnd = nextHour > endTime ? endTime : nextHour;
                  
                  // 休憩時間を除外
                  let isBreak = false;
                  if (data.breakStart1 && data.breakEnd1) {
                    const breakStart1 = new Date(`${data.date} ${data.breakStart1}`);
                    const breakEnd1 = new Date(`${data.date} ${data.breakEnd1}`);
                    if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                      isBreak = true;
                    }
                  }
                  if (data.breakStart2 && data.breakEnd2) {
                    const breakStart2 = new Date(`${data.date} ${data.breakStart2}`);
                    const breakEnd2 = new Date(`${data.date} ${data.breakEnd2}`);
                    if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                      isBreak = true;
                    }
                  }
                  
                  if (!isBreak) {
                    const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                    const hour = currentTime.getHours();
                    
                    let rate = 1.0;
                    if (isHoliday) {
                      // 休日出勤: 基本35%増
                      rate = 1.35;
                      // 22時～5時は深夜割増25%を追加（合計60%増）
                      if (hour >= 22 || hour < 5) {
                        rate = 1.60;
                      }
                    } else {
                      // 平日: 22時～5時は深夜割増25%
                      if (hour >= 22 || hour < 5) {
                        rate = 1.25;
                      }
                    }
                    
                    totalWage += segmentHours * hourlyRate * rate;
                  }
                  
                  currentTime = segmentEnd;
                }
                
                totalLaborCost += totalWage;
                workDays++;
              }
            }
          });
          
          // 支出データを集計
          const expensesSnapshot = await window.getDocs(window.getStoreCollection('expenses'));
          expensesSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.date && data.date.startsWith(`${year}-${monthStr}`)) {
              totalExpense += data.total || 0;
            }
          });
          
          const laborCostRate = totalSales > 0 ? (totalLaborCost / totalSales) * 100 : 0;
          const grossProfitRate = totalSales > 0 ? ((totalSales - totalLaborCost) / totalSales) * 100 : 0;
          const grossProfit = totalSales - totalLaborCost;
          const netProfit = totalSales - totalLaborCost - totalExpense; // 純利益
          const netProfitRate = totalSales > 0 ? (netProfit / totalSales) * 100 : 0;
          
          monthsData.push({
            label: `${month}月`,
            sales: Math.round(totalSales),
            laborCost: Math.round(totalLaborCost),
            expense: Math.round(totalExpense),
            laborCostRate: laborCostRate.toFixed(1),
            grossProfit: Math.round(grossProfit),
            grossProfitRate: grossProfitRate.toFixed(1),
            netProfit: Math.round(netProfit),
            netProfitRate: netProfitRate.toFixed(1)
          });
        }
        
        console.log(' 集計データ:', monthsData);
        
        // グラフエリアを表示
        document.getElementById('monthlyChartsArea').style.display = 'block';
        
        // 既存のチャートを破棄
        if (window.salesChart) window.salesChart.destroy();
        if (window.laborChart) window.laborChart.destroy();
        if (window.profitChart) window.profitChart.destroy();
        if (window.netProfitChart) window.netProfitChart.destroy();
        
        // 売上推移グラフ
        const salesCtx = document.getElementById('salesTrendChart').getContext('2d');
        window.salesChart = new Chart(salesCtx, {
          type: 'line',
          data: {
            labels: monthsData.map(d => d.label),
            datasets: [{
              label: '売上（円）',
              data: monthsData.map(d => d.sales),
              borderColor: '#4CAF50',
              backgroundColor: 'rgba(76, 175, 80, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return '¥' + value.toLocaleString();
                  }
                }
              }
            }
          }
        });
        
        // 人件費率推移グラフ
        const laborCtx = document.getElementById('laborCostRateChart').getContext('2d');
        window.laborChart = new Chart(laborCtx, {
          type: 'line',
          data: {
            labels: monthsData.map(d => d.label),
            datasets: [
              {
                label: '人件費率（%）',
                data: monthsData.map(d => d.laborCostRate),
                borderColor: '#FF9800',
                backgroundColor: 'rgba(255, 152, 0, 0.1)',
                tension: 0.4,
                fill: true
              },
              {
                label: '目標35%',
                data: monthsData.map(() => 35),
                borderColor: '#f44336',
                borderDash: [5, 5],
                borderWidth: 2,
                pointRadius: 0,
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 50,
                ticks: {
                  callback: function(value) {
                    return value + '%';
                  }
                }
              }
            }
          }
        });
        
        // 粗利率推移グラフ
        const profitCtx = document.getElementById('profitRateChart').getContext('2d');
        window.profitChart = new Chart(profitCtx, {
          type: 'line',
          data: {
            labels: monthsData.map(d => d.label),
            datasets: [{
              label: '粗利率（%）',
              data: monthsData.map(d => d.profitRate),
              borderColor: '#2196F3',
              backgroundColor: 'rgba(33, 150, 243, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return value + '%';
                  }
                }
              }
            }
          }
        });
        
        // 純利益率推移グラフ
        const netProfitCtx = document.getElementById('netProfitRateChart').getContext('2d');
        window.netProfitChart = new Chart(netProfitCtx, {
          type: 'line',
          data: {
            labels: monthsData.map(d => d.label),
            datasets: [{
              label: '純利益率（%）',
              data: monthsData.map(d => d.netProfitRate),
              borderColor: '#9C27B0',
              backgroundColor: 'rgba(156, 39, 176, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return value + '%';
                  }
                }
              }
            }
          }
        });
        
        // 数値テーブルを生成
        const tableBody = document.getElementById('monthlyDataTableBody');
        tableBody.innerHTML = '';
        
        monthsData.forEach((data, index) => {
          const row = document.createElement('tr');
          row.style.background = index % 2 === 0 ? '#f8f9fa' : 'white';
          
          const laborRateClass = parseFloat(data.laborCostRate) > 35 ? 'color: #f44336; font-weight: bold;' : 'color: #4CAF50;';
          const netProfitClass = parseFloat(data.netProfit) >= 0 ? 'color: #9C27B0; font-weight: bold;' : 'color: #f44336; font-weight: bold;';
          
          row.innerHTML = `
            <td style="padding: 10px; text-align: center; border: 1px solid #ddd; font-weight: bold;">${data.label}</td>
            <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">¥${data.sales.toLocaleString()}</td>
            <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">¥${data.laborCost.toLocaleString()}</td>
            <td style="padding: 10px; text-align: right; border: 1px solid #ddd; ${laborRateClass}">${data.laborCostRate}%</td>
            <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">¥${data.expense.toLocaleString()}</td>
            <td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: #2196F3; font-weight: bold;">¥${data.grossProfit.toLocaleString()}</td>
            <td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: #2196F3; font-weight: bold;">${data.grossProfitRate}%</td>
            <td style="padding: 10px; text-align: right; border: 1px solid #ddd; ${netProfitClass}">¥${data.netProfit.toLocaleString()}</td>
            <td style="padding: 10px; text-align: right; border: 1px solid #ddd; ${netProfitClass}">${data.netProfitRate}%</td>
          `;
          
          tableBody.appendChild(row);
        });
        
        console.log(' 月次グラフ生成完了');
      } catch (e) {
        console.error(' 月次グラフ生成エラー:', e);
      }
    };
    
    // 月次レポートモーダルを閉じる
    window.closeMonthlyReportModal = function() {
      document.getElementById('monthlyReportModal').classList.add('hidden');
    };
    
    // ===== 期間ジャーナル生成 =====
    window.generatePeriodJournal = async function() {
      try {
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;
        
        if (!startDate || !endDate) {
          alert('開始日と終了日を選択してください');
          return;
        }
        
        if (startDate > endDate) {
          alert('開始日は終了日より前の日付を選択してください');
          return;
        }
        
        console.log(`期間ジャーナル生成: ${startDate} ～ ${endDate}`);
        
        const container = document.getElementById('monthlyReportContent');
        container.innerHTML = '<div style="text-align: center; padding: 40px;">ジャーナル生成中...</div>';
        
        // 期間内の全日付を生成
        const start = new Date(startDate);
        const end = new Date(endDate);
        const dates = [];
        
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
          dates.push(dateStr);
        }
        
        // 各日付の売上データを取得して合計
        let totalCustomerCount = 0;
        let totalItems = 0;
        let totalCashSales = 0;
        let totalEmoneSales = 0;
        let totalCreditSales = 0;
        let totalDiscount = 0;
        let totalTax8 = 0;
        let totalTax10 = 0;
        let totalDrawerOpen = 0;
        let totalRedSlipCount = 0;  // 赤伝票件数
        let totalRedSlipAmount = 0;  // 赤伝票金額
        let totalRedSlipTax8 = 0;  // 赤伝票8%税金
        let totalRedSlipTax10 = 0;  // 赤伝票10%税金
        let totalExpense = 0;
        let totalLaborCost = 0;
        const itemCounts = {}; // 商品別カウント
        
        // ordersコレクションから直接商品データを集計
        const ordersQuery = window.query(
          window.getStoreCollection('orders'),
          window.where('paidAt', '!=', null)
        );
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          // paidAtを使用して会計日時を取得
          if (!data.paidAt) return;
          
          const orderDate = data.paidAt.toDate();
          
          // 3時基準の営業日計算
          let targetDate = new Date(orderDate);
          if (orderDate.getHours() < 3) {
            targetDate.setDate(targetDate.getDate() - 1);
          }
          
          const orderDateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-${String(targetDate.getDate()).padStart(2, '0')}`;
          
          // 期間内の注文のみ
          if (dates.includes(orderDateStr) && data.items) {
            data.items.forEach(item => {
              itemCounts[item.name] = (itemCounts[item.name] || 0) + (item.quantity || 1);
            });
          }
        });
        
        console.log(' ordersから集計した商品データ:', itemCounts);
        
        for (const dateStr of dates) {
          // 売上データ
          const salesDoc = await window.getDoc(window.getStoreDoc('dailySales', dateStr));
          if (salesDoc.exists()) {
            const data = salesDoc.data();
            totalCustomerCount += data.customerCount || 0;
            totalItems += data.totalItems || 0;
            totalCashSales += data.cashSales || 0;
            totalEmoneSales += data.emoneSales || 0;
            totalCreditSales += data.creditSales || 0;
            totalDiscount += data.totalDiscount || 0;
            totalTax8 += data.tax8Total || 0;
            totalTax10 += data.tax10Total || 0;
            totalDrawerOpen += data.drawerOpenCount || 0;
            totalRedSlipCount += data.redSlipCount || 0;  // 赤伝票件数
            totalRedSlipAmount += data.redSlipAmount || 0;  // 赤伝票金額
            totalRedSlipTax8 += data.redSlipTax8Total || 0;  // 赤伝票8%税金
            totalRedSlipTax10 += data.redSlipTax10Total || 0;  // 赤伝票10%税金
          }
          
          // 支出データ
          const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
          if (expenseDoc.exists()) {
            totalExpense += expenseDoc.data().total || 0;
          }
          
          // 人件費データ
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(doc => {
            const attData = doc.data();
            if (attData.date === dateStr) {
              // 既に計算済みの総賃金がある場合はそれを使用
              if (attData.totalWage && attData.totalWage > 0) {
                totalLaborCost += attData.totalWage;
              } else if (attData.clockIn && attData.clockOut) {
                // 総賃金がない場合は計算する
                const clockIn = new Date(`${dateStr} ${attData.clockIn}`);
                const clockOut = new Date(`${dateStr} ${attData.clockOut}`);
                let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                
                if (attData.breakStart1 && attData.breakEnd1) {
                  const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                  const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                  workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                }
                if (attData.breakStart2 && attData.breakEnd2) {
                  const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                  const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                  workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                }
                
                const hourlyRate = attData.hourlyRate || 1150;
                
                // 割増賃金の計算
                let totalWage = 0;
                const isHoliday = attData.isHoliday || false;
                
                // 時間ごとに割増率を計算
                let currentTime = new Date(clockIn);
                const endTime = new Date(clockOut);
                
                while (currentTime < endTime) {
                  const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                  const segmentEnd = nextHour > endTime ? endTime : nextHour;
                  
                  // 休憩時間を除外
                  let isBreak = false;
                  if (attData.breakStart1 && attData.breakEnd1) {
                    const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                    const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                    if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                      isBreak = true;
                    }
                  }
                  if (attData.breakStart2 && attData.breakEnd2) {
                    const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                    const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                    if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                      isBreak = true;
                    }
                  }
                  
                  if (!isBreak) {
                    const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                    const hour = currentTime.getHours();
                    
                    let rate = 1.0;
                    if (isHoliday) {
                      // 休日出勤: 基本35%増
                      rate = 1.35;
                      // 22時～5時は深夜割増25%を追加（合計60%増）
                      if (hour >= 22 || hour < 5) {
                        rate = 1.60;
                      }
                    } else {
                      // 平日: 22時～5時は深夜割増25%
                      if (hour >= 22 || hour < 5) {
                        rate = 1.25;
                      }
                    }
                    
                    totalWage += segmentHours * hourlyRate * rate;
                  }
                  
                  currentTime = segmentEnd;
                }
                
                totalLaborCost += totalWage;
              }
            }
          });
        }
        
        // 計算
        const totalSales = totalCashSales + totalEmoneSales + totalCreditSales;
        const averageSpend = totalCustomerCount > 0 ? Math.round(totalSales / totalCustomerCount) : 0;
        
        // 外税・内税を区別して計算
        // 注文データから外税と内税を分離
        let tax8InclusiveTotal = 0;
        let tax10InclusiveTotal = 0;
        let tax8ExclusiveTotal = 0;
        let tax10ExclusiveTotal = 0;
        // 赤伝票の内税・外税
        let redSlipTax8Inclusive = 0;
        let redSlipTax10Inclusive = 0;
        let redSlipTax8Exclusive = 0;
        let redSlipTax10Exclusive = 0;
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          if (!data.paidAt || !data.items) return;
          
          const orderDate = data.paidAt.toDate();
          let targetDate = new Date(orderDate);
          if (orderDate.getHours() < 3) {
            targetDate.setDate(targetDate.getDate() - 1);
          }
          
          const orderDateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-${String(targetDate.getDate()).padStart(2, '0')}`;
          
          if (dates.includes(orderDateStr)) {
            const isRedSlip = data.isRedSlip || false;  // 赤伝票判定
            
            data.items.forEach(item => {
              const taxType = item.taxType || 'inclusive';
              const taxAmount = getTaxAmount(item, item.quantity || 1);
              
              if ((item.taxRate || 10) === 8) {
                if (taxType === 'exclusive') {
                  tax8ExclusiveTotal += taxAmount;
                  if (isRedSlip) redSlipTax8Exclusive += taxAmount;  // NEW
                } else {
                  tax8InclusiveTotal += taxAmount;
                  if (isRedSlip) redSlipTax8Inclusive += taxAmount;  // NEW
                }
              } else {
                if (taxType === 'exclusive') {
                  tax10ExclusiveTotal += taxAmount;
                  if (isRedSlip) redSlipTax10Exclusive += taxAmount;  // NEW
                } else {
                  tax10InclusiveTotal += taxAmount;
                  if (isRedSlip) redSlipTax10Inclusive += taxAmount;  // NEW
                }
              }
            });
          }
        });
        
        // 旧計算（互換性のため残す）
        const tax8Excluded = Math.floor(totalTax8 / 1.08);
        const tax10Excluded = Math.floor(totalTax10 / 1.10);
        const tax8Amount = totalTax8 - tax8Excluded;
        const tax10Amount = totalTax10 - tax10Excluded;
        const totalTax = tax8Amount + tax10Amount;
        const taxExcludedTotal = tax8Excluded + tax10Excluded;
        const taxIncludedTotal = totalTax8 + totalTax10;
        const finalTotalSales = taxIncludedTotal - totalDiscount - totalExpense;
        
        const now = new Date();
        const outputTime = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        
        // ジャーナルテキストを生成
        const journalText = `
=====================================
      期間ジャーナル
=====================================
期間: ${startDate} ～ ${endDate}
出力時刻: ${outputTime}
客数: ${totalCustomerCount}組
総売上点数: ${totalItems}点
平均客単価: ¥${averageSpend.toLocaleString()}
合計売上: ¥${totalSales.toLocaleString()}

-------------------------------------
売上内訳
-------------------------------------
現金: ¥${totalCashSales.toLocaleString()}
電子マネー: ¥${totalEmoneSales.toLocaleString()}
クレジットカード: ¥${totalCreditSales.toLocaleString()}
値引き: ¥${totalDiscount.toLocaleString()}

-------------------------------------
税金内訳※赤伝票減算前
-------------------------------------
【8%軽減税率】
内税の消費税: ¥${tax8InclusiveTotal.toLocaleString()}
外税の消費税: ¥${tax8ExclusiveTotal.toLocaleString()}
8%合計: ¥${(tax8InclusiveTotal + tax8ExclusiveTotal).toLocaleString()}

【10%標準税率】
内税の消費税: ¥${tax10InclusiveTotal.toLocaleString()}
外税の消費税: ¥${tax10ExclusiveTotal.toLocaleString()}
10%合計: ¥${(tax10InclusiveTotal + tax10ExclusiveTotal).toLocaleString()}

消費税の合計: ¥${(tax8InclusiveTotal + tax8ExclusiveTotal + tax10InclusiveTotal + tax10ExclusiveTotal).toLocaleString()}
税抜合計: ¥${taxExcludedTotal.toLocaleString()}
税込合計: ¥${taxIncludedTotal.toLocaleString()}
${totalRedSlipCount > 0 ? `
-------------------------------------
赤伝票の税金内訳
-------------------------------------
8%の赤伝票（税抜）: -¥${Math.floor(totalRedSlipTax8 / 1.08).toLocaleString()}
8%の赤伝票（税込）: -¥${totalRedSlipTax8.toLocaleString()}
8%の赤伝票の消費税: -¥${(totalRedSlipTax8 - Math.floor(totalRedSlipTax8 / 1.08)).toLocaleString()}
  内税: -¥${redSlipTax8Inclusive.toLocaleString()}
  外税: -¥${redSlipTax8Exclusive.toLocaleString()}

10%の赤伝票（税抜）: -¥${Math.floor(totalRedSlipTax10 / 1.10).toLocaleString()}
10%の赤伝票（税込）: -¥${totalRedSlipTax10.toLocaleString()}
10%の赤伝票の消費税: -¥${(totalRedSlipTax10 - Math.floor(totalRedSlipTax10 / 1.10)).toLocaleString()}
  内税: -¥${redSlipTax10Inclusive.toLocaleString()}
  外税: -¥${redSlipTax10Exclusive.toLocaleString()}

赤伝票消費税の合計: -¥${((totalRedSlipTax8 - Math.floor(totalRedSlipTax8 / 1.08)) + (totalRedSlipTax10 - Math.floor(totalRedSlipTax10 / 1.10))).toLocaleString()}
赤伝票税抜合計: -¥${(Math.floor(totalRedSlipTax8 / 1.08) + Math.floor(totalRedSlipTax10 / 1.10)).toLocaleString()}
赤伝票税込合計: -¥${(totalRedSlipTax8 + totalRedSlipTax10).toLocaleString()}

-------------------------------------
税金内訳 正式計算（赤伝票減算後）
-------------------------------------
8%の商品合計（税抜）: ¥${Math.floor((totalTax8 - totalRedSlipTax8) / 1.08).toLocaleString()}
8%の商品合計（税込）: ¥${(totalTax8 - totalRedSlipTax8).toLocaleString()}
8%の消費税: ¥${((totalTax8 - totalRedSlipTax8) - Math.floor((totalTax8 - totalRedSlipTax8) / 1.08)).toLocaleString()}
  内税: ¥${(tax8InclusiveTotal - redSlipTax8Inclusive).toLocaleString()}
  外税: ¥${(tax8ExclusiveTotal - redSlipTax8Exclusive).toLocaleString()}

10%の商品合計（税抜）: ¥${Math.floor((totalTax10 - totalRedSlipTax10) / 1.10).toLocaleString()}
10%の商品合計（税込）: ¥${(totalTax10 - totalRedSlipTax10).toLocaleString()}
10%の消費税: ¥${((totalTax10 - totalRedSlipTax10) - Math.floor((totalTax10 - totalRedSlipTax10) / 1.10)).toLocaleString()}
  内税: ¥${(tax10InclusiveTotal - redSlipTax10Inclusive).toLocaleString()}
  外税: ¥${(tax10ExclusiveTotal - redSlipTax10Exclusive).toLocaleString()}

消費税の合計: ¥${(((totalTax8 - totalRedSlipTax8) - Math.floor((totalTax8 - totalRedSlipTax8) / 1.08)) + ((totalTax10 - totalRedSlipTax10) - Math.floor((totalTax10 - totalRedSlipTax10) / 1.10))).toLocaleString()}
税抜合計: ¥${(Math.floor((totalTax8 - totalRedSlipTax8) / 1.08) + Math.floor((totalTax10 - totalRedSlipTax10) / 1.10)).toLocaleString()}
税込合計: ¥${((totalTax8 - totalRedSlipTax8) + (totalTax10 - totalRedSlipTax10)).toLocaleString()}
` : ''}
支出: ¥${totalExpense.toLocaleString()}
合計売上: ¥${(totalRedSlipCount > 0 ? ((totalTax8 - totalRedSlipTax8) + (totalTax10 - totalRedSlipTax10)) - totalExpense : taxIncludedTotal - totalExpense).toLocaleString()}

-------------------------------------
その他
-------------------------------------
ドロアオープン数: ${totalDrawerOpen}回
赤伝票件数: ${totalRedSlipCount}件
赤伝票金額: ¥${totalRedSlipAmount.toLocaleString()}
人件費: ¥${Math.round(totalLaborCost).toLocaleString()}

=====================================
`;
        
        // PNG画像として保存
        const journalDiv = document.createElement('div');
        journalDiv.style.cssText = `
          font-family: 'Courier New', monospace;
          font-size: 14px;
          line-height: 1.6;
          padding: 30px;
          background: white;
          color: black;
          white-space: pre-wrap;
          position: absolute;
          left: -9999px;
        `;
        
        // HTMLとして生成し、支出と合計売上を赤色にする
        journalDiv.innerHTML = journalText
          .replace(/^(支出: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>')
          .replace(/^(合計売上: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>')
          .replace(/^(税金内訳 正式計算（赤伝票減算後）)$/gm, '<span style="color: #1976d2; font-weight: bold;">$1</span>');
        
        document.body.appendChild(journalDiv);
        
        const canvas = await html2canvas(journalDiv, {
          backgroundColor: '#ffffff',
          scale: 2
        });
        
        document.body.removeChild(journalDiv);
        
        const link = document.createElement('a');
        link.download = `期間ジャーナル_${startDate}_${endDate}.png`;
        link.href = canvas.toDataURL();
        link.click();
        
        console.log(' 期間ジャーナル生成完了');
        
        // 商品カウントをソート（販売数が多い順）
        const sortedItems = Object.entries(itemCounts).sort((a, b) => b[1] - a[1]);
        console.log(' 集計された商品データ:', itemCounts);
        console.log(' ソート後の商品データ:', sortedItems);
        
        // 商品カウントのHTML生成
        let itemCountsHtml = '';
        sortedItems.forEach(([itemName, count]) => {
          itemCountsHtml += `
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
              <span>${itemName}</span>
              <strong>${count}個</strong>
            </div>
          `;
        });
        
        // サマリー表示
        container.innerHTML = `
          <div style="padding: 20px;">
            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border-radius: 12px; margin-bottom: 20px;">
              <div style="font-size: 18px; margin-bottom: 10px;">ジャーナルをダウンロードしました</div>
              <div style="font-size: 14px; opacity: 0.9;">期間: ${startDate} ～ ${endDate}</div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
              <h4 style="margin: 0 0 15px 0; color: #333;">期間サマリー</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">総売上</div>
                  <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">¥${(totalCashSales + totalEmoneSales + totalCreditSales).toLocaleString()}</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">客数</div>
                  <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${totalCustomerCount}組</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">販売点数</div>
                  <div style="font-size: 24px; font-weight: bold; color: #FF9800;">${totalItems}点</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">平均客単価</div>
                  <div style="font-size: 24px; font-weight: bold; color: #9C27B0;">¥${totalCustomerCount > 0 ? Math.round((totalCashSales + totalEmoneSales + totalCreditSales) / totalCustomerCount).toLocaleString() : 0}</div>
                </div>
              </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
              <h4 style="margin: 0 0 15px 0; color: #333;">支払方法別</h4>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>現金</span>
                <strong>¥${totalCashSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>電子マネー</span>
                <strong>¥${totalEmoneSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span>クレジットカード</span>
                <strong>¥${totalCreditSales.toLocaleString()}</strong>
              </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
              <h4 style="margin: 0 0 15px 0; color: #333;">商品別販売数</h4>
              <div style="max-height: 300px; overflow-y: auto;">
                ${itemCountsHtml || '<div style="text-align: center; color: #999;">データがありません</div>'}
              </div>
            </div>
          </div>
        `;
        
      } catch (e) {
        console.error(' 期間ジャーナル生成エラー:', e);
        alert('期間ジャーナルの生成に失敗しました: ' + e.message);
      }
    };
    
    // ========== 客数機能 ==========
    
    // 客数モーダルを表示
    window.showCustomerCountModal = async function() {
      document.getElementById('customerCountModal').classList.remove('hidden');
      await calculateCustomerCount();
    };
    
    // 客数を計算
    async function calculateCustomerCount() {
      const container = document.getElementById('customerCountContent');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">集計中...</div>';
      
      try {
        console.log('=== 客数計算開始 ===');
        
        // Firebase初期化を待つ
        if (!window.firebaseReady) {
          console.log(' Firebase初期化待機中...');
          await new Promise(resolve => {
            window.addEventListener('firebaseReady', resolve, { once: true });
          });
          console.log(' Firebase初期化完了を確認');
        }
        
        const now = new Date();
        const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        
        console.log('日付キー:', dateStr);
        
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        let customerCount = 0;
        if (salesDoc.exists()) {
          customerCount = salesDoc.data().customerCount || 0;
          console.log('取得した客数:', customerCount);
        } else {
          console.log('本日のデータなし');
        }
        
        console.log('最終客数:', customerCount);
        
        container.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 80px; font-weight: bold; color: #00bcd4; margin: 20px 0;">
              ${customerCount}
            </div>
            <div style="font-size: 24px; color: #666;">
              組
            </div>
          </div>
        `;
      } catch (e) {
        console.error('客数計算エラー:', e);
        container.innerHTML = '<div style="text-align: center; color: red;">エラーが発生しました</div>';
      }
    }
    
    // 客数モーダルを閉じる
    window.closeCustomerCountModal = function() {
      document.getElementById('customerCountModal').classList.add('hidden');
    };
    
    // ========== 売上機能 ==========
    
    // 売上モーダルを表示
    window.showSalesModal = function() {
      // タイトルを営業日に応じて変更
      const dateStr = window.getBusinessDateString();
      const displayDate = new Date(dateStr + 'T00:00:00');
      const now = new Date();
      let today = new Date(now);
      if (now.getHours() < 3) {
        today.setDate(today.getDate() - 1);
      }
      
      const isToday = dateStr === window.getBusinessDateString();
      const year = displayDate.getFullYear();
      const month = displayDate.getMonth() + 1;
      const day = displayDate.getDate();
      
      let title;
      const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      
      if (dateStr === todayStr) {
        title = '本日の売上';
      } else {
        title = `${year}年${month}月${day}日の売上`;
      }
      
      document.getElementById('salesModalTitle').textContent = title;
      document.getElementById('salesModal').classList.remove('hidden');
      calculateSales();
    };
    
    // 売上を計算
    window.calculateSales = async function() {
      const container = document.getElementById('salesContent');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">集計中...</div>';
      
      try {
        // Firebase初期化を待つ
        if (!window.firebaseReady) {
          await new Promise(resolve => {
            window.addEventListener('firebaseReady', resolve, { once: true });
          });
        }
        
        // 選択された営業日の売上を取得
        const dateStr = window.getBusinessDateString();
        const displayDate = new Date(dateStr + 'T00:00:00');
        
        console.log(' 売上取得日付:', dateStr);
        
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        console.log(' dailySalesドキュメント存在:', salesDoc.exists());
        
        let totalSales = 0;
        let cashSales = 0;
        let emoneSales = 0;
        let creditSales = 0;
        let orderCount = 0;
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          console.log(' 売上データ:', data);
          totalSales = data.totalSales || 0;
          cashSales = data.cashSales || 0;
          emoneSales = data.emoneSales || 0;
          creditSales = data.creditSales || 0;
          orderCount = data.customerCount || 0;
        } else {
          console.log(' 売上データが存在しません');
        }
        
        console.log('最終売上:', totalSales, '注文数:', orderCount);
        
        // 本日の人件費を取得
        let todayLaborCost = 0;
        try {
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.date === dateStr) {
              // 既に計算済みの総賃金がある場合はそれを使用
              if (data.totalWage && data.totalWage > 0) {
                todayLaborCost += data.totalWage;
              } else if (data.clockIn && data.clockOut) {
                // 総賃金がない場合は計算する
                const clockIn = new Date(`${dateStr} ${data.clockIn}`);
                const clockOut = new Date(`${dateStr} ${data.clockOut}`);
                let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                
                if (data.breakStart1 && data.breakEnd1) {
                  const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                  const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                  workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                }
                if (data.breakStart2 && data.breakEnd2) {
                  const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                  const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                  workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                }
                
                const hourlyRate = data.hourlyRate || 1150;
                
                // 割増賃金の計算
                let totalWage = 0;
                const isHoliday = data.isHoliday || false;
                
                // 時間ごとに割増率を計算
                let currentTime = new Date(clockIn);
                const endTime = new Date(clockOut);
                
                while (currentTime < endTime) {
                  const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                  const segmentEnd = nextHour > endTime ? endTime : nextHour;
                  
                  // 休憩時間を除外
                  let isBreak = false;
                  if (data.breakStart1 && data.breakEnd1) {
                    const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                    const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                    if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                      isBreak = true;
                    }
                  }
                  if (data.breakStart2 && data.breakEnd2) {
                    const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                    const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                    if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                      isBreak = true;
                    }
                  }
                  
                  if (!isBreak) {
                    const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                    const hour = currentTime.getHours();
                    
                    let rate = 1.0;
                    if (isHoliday) {
                      // 休日出勤: 基本35%増
                      rate = 1.35;
                      // 22時～5時は深夜割増25%を追加（合計60%増）
                      if (hour >= 22 || hour < 5) {
                        rate = 1.60;
                      }
                    } else {
                      // 平日: 22時～5時は深夜割増25%
                      if (hour >= 22 || hour < 5) {
                        rate = 1.25;
                      }
                    }
                    
                    totalWage += segmentHours * hourlyRate * rate;
                  }
                  
                  currentTime = segmentEnd;
                }
                
                todayLaborCost += totalWage;
              }
            }
          });
        } catch (e) {
          console.error('人件費取得エラー:', e);
        }
        
        // 本日の支出を取得
        let todayExpense = 0;
        try {
          const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
          if (expenseDoc.exists()) {
            todayExpense = expenseDoc.data().total || 0;
          }
        } catch (e) {
          console.error('支出取得エラー:', e);
        }
        
        // 純利益計算
        const grossProfit = totalSales - todayLaborCost; // 粗利（売上 - 人件費）
        const netProfit = totalSales - todayLaborCost - todayExpense; // 純利益（売上 - 人件費 - 支出）
        const netProfitRate = totalSales > 0 ? (netProfit / totalSales * 100).toFixed(1) : 0;
        const laborCostRate = totalSales > 0 ? (todayLaborCost / totalSales * 100).toFixed(1) : 0;
        const expenseRate = totalSales > 0 ? (todayExpense / totalSales * 100).toFixed(1) : 0;
        
        console.log(' 本日の収益:', {
          売上: totalSales,
          人件費: todayLaborCost,
          支出: todayExpense,
          粗利: grossProfit,
          純利益: netProfit
        });
        
        // 売上が0の場合の表示メッセージ
        const noSalesMessage = totalSales === 0 ? '<div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">※ 本日の売上データがありません</div>' : '';
        
        // 売上目標達成率を計算（選択された営業日の曜日で判定）
        const dayOfWeek = displayDate.getDay(); // 0=日曜, 6=土曜
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
        const targetSales = isWeekend ? 70000 : 50000;
        const achievementRate = Math.round((totalSales / targetSales) * 100);
        
        const rateColor = achievementRate >= 100 ? '#4CAF50' : achievementRate >= 80 ? '#FF9800' : '#f44336';
        const netProfitColor = netProfit >= 0 ? '#4CAF50' : '#f44336';
        
        const targetSection = `
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
              <h4 style="margin: 0 0 10px 0;">売上目標</h4>
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>目標金額（${isWeekend ? '土日祝' : '平日'}）</span>
                <strong>¥${targetSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>現在の売上</span>
                <strong>¥${totalSales.toLocaleString()}</strong>
              </div>
              <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px;">
                <div style="font-size: 32px; font-weight: bold; color: ${rateColor};">
                  ${achievementRate}%
                </div>
                <div style="font-size: 14px; opacity: 0.9;">達成率</div>
              </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #FF6B6B 0%, #C92A2A 100%); border-radius: 10px; color: white;">
              <h4 style="margin: 0 0 15px 0;">本日の純利益</h4>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                <span>売上</span>
                <strong>¥${totalSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                <span>− 人件費${totalSales > 0 ? '（' + laborCostRate + '%）' : ''}</span>
                <strong>¥${Math.round(todayLaborCost).toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px;">
                <span>− 支出${totalSales > 0 ? '（' + expenseRate + '%）' : ''}</span>
                <strong>¥${Math.round(todayExpense).toLocaleString()}</strong>
              </div>
              <div style="border-top: 2px solid rgba(255,255,255,0.3); padding-top: 12px;">
                <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                  <div style="font-size: 16px; opacity: 0.9; margin-bottom: 5px;">純利益</div>
                  <div style="font-size: 32px; font-weight: bold; color: ${netProfitColor};">
                    ¥${Math.round(netProfit).toLocaleString()}
                  </div>
                  <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">純利益率: ${netProfitRate}%</div>
                  ${noSalesMessage}
                </div>
              </div>
            </div>
          `;
        
        container.innerHTML = `
          <div style="background: white; border-radius: 12px; padding: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
              <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;">総売上</div>
                <div style="font-size: 28px; font-weight: bold;">¥${totalSales.toLocaleString()}</div>
              </div>
              <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;">客数</div>
                <div style="font-size: 28px; font-weight: bold;">${orderCount}件</div>
              </div>
            </div>
            
            ${targetSection}
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
              <h4 style="margin: 0 0 15px 0;">支払い方法別</h4>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>現金</span>
                <strong>¥${cashSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>カード</span>
                <strong>¥${creditSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span>電子マネー</span>
                <strong>¥${emoneSales.toLocaleString()}</strong>
              </div>
            </div>
            
            <div id="taxForecastSection" style="margin-top: 20px;">
              <div style="text-align: center; padding: 10px;">納税額を計算中...</div>
            </div>
          </div>
        `;
        
        // 納税額予測を非同期で計算・表示
        calculateTaxForecast().then(html => {
          document.getElementById('taxForecastSection').innerHTML = html;
        }).catch(err => {
          console.error('納税額予測エラー:', err);
          document.getElementById('taxForecastSection').innerHTML = `
            <div style="padding: 15px; background: #fff3cd; border-radius: 10px; color: #856404;">
              <strong>納税額の計算に失敗しました</strong>
              <div style="font-size: 12px; margin-top: 5px;">${err.message}</div>
            </div>
          `;
        });
      } catch (e) {
        console.error('売上計算エラー:', e);
        container.innerHTML = '<div style="text-align: center; color: red;">エラーが発生しました</div>';
      }
    };
    
    // 納税額予測を計算
    window.calculateTaxForecast = async function() {
      try {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;
        
        // 今年と来年の年度を計算（1-3月は前年度）
        const fiscalYear = currentMonth <= 3 ? currentYear - 1 : currentYear;
        const nextFiscalYear = fiscalYear + 1;
        const lastFiscalYear = fiscalYear - 1;
        
        console.log(`納税額計算: 今年度=${fiscalYear}, 来年度=${nextFiscalYear}, 前年度=${lastFiscalYear}`);
        
        // 今年度のデータを集計（来年の納税額予測用）
        const currentYearTax = await calculateYearlyConsumptionTax(fiscalYear);
        
        // 前年度のデータを集計（実績）
        const lastYearTax = await calculateYearlyConsumptionTax(lastFiscalYear);
        
        const html = `
          <div style="padding: 15px; background: linear-gradient(135deg, #FF6B6B 0%, #C92A2A 100%); border-radius: 10px; color: white;">
            <h4 style="margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
              消費税納税額
            </h4>
            
            <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
              <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">来年（${nextFiscalYear}年）の予測納税額</div>
              <div style="font-size: 24px; font-weight: bold;">
                ¥${Math.round(currentYearTax.netTax).toLocaleString()}
              </div>
              <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">
                今年度（${fiscalYear}/${fiscalYear + 1}）の実績ベース
              </div>
            </div>
            
            <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 12px;">
              <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">前年（${fiscalYear}年）の納税額</div>
              <div style="font-size: 24px; font-weight: bold;">
                ¥${Math.round(lastYearTax.netTax).toLocaleString()}
              </div>
              <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">
                前年度（${lastFiscalYear}/${lastFiscalYear + 1}）の実績
              </div>
            </div>
            
            <div style="margin-top: 12px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; font-size: 11px;">
              <div style="margin-bottom: 5px;">
                <strong> 内訳（今年度）</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                <span>仮受消費税（売上8%）</span>
                <span>¥${Math.round(currentYearTax.receivedTax8).toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                <span>仮受消費税（売上10%）</span>
                <span>¥${Math.round(currentYearTax.receivedTax10).toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 2px; padding-left: 10px; opacity: 0.9;">
                <span>小計</span>
                <span>¥${Math.round(currentYearTax.receivedTax).toLocaleString()}</span>
              </div>
              <div style="height: 1px; background: rgba(255,255,255,0.2); margin: 5px 0;"></div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                <span>仮払消費税（支出8%）</span>
                <span>¥${Math.round(currentYearTax.paidTax8).toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                <span>仮払消費税（支出10%）</span>
                <span>¥${Math.round(currentYearTax.paidTax10).toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 3px; padding-left: 10px; opacity: 0.9;">
                <span>小計</span>
                <span>¥${Math.round(currentYearTax.paidTax).toLocaleString()}</span>
              </div>
              <div style="height: 1px; background: rgba(255,255,255,0.2); margin: 5px 0;"></div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 3px; opacity: 0.7;">
                <span>人件費（対象外）</span>
                <span>¥${Math.round(currentYearTax.laborCost).toLocaleString()}</span>
              </div>
              <div style="height: 1px; background: rgba(255,255,255,0.3); margin: 8px 0;"></div>
              <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 12px;">
                <span>納税額</span>
                <span>¥${Math.round(currentYearTax.netTax).toLocaleString()}</span>
              </div>
            </div>
            
            <div style="margin-top: 8px; font-size: 10px; opacity: 0.8;">
              ※ 簡易課税制度・インボイス制度は考慮していません<br/>
              ※ 実際の納税額は税理士にご確認ください
            </div>
          </div>
        `;
        
        return html;
      } catch (err) {
        console.error('納税額予測計算エラー:', err);
        throw err;
      }
    };
    
    // 年度の消費税を計算
    async function calculateYearlyConsumptionTax(fiscalYear) {
      const startDate = new Date(fiscalYear, 3, 1); // 4月1日
      const endDate = new Date(fiscalYear + 1, 2, 31, 23, 59, 59); // 翌年3月31日
      
      console.log(`集計期間: ${startDate.toLocaleDateString()} 〜 ${endDate.toLocaleDateString()}`);
      
      let receivedTax8 = 0; // 仮受消費税8%
      let receivedTax10 = 0; // 仮受消費税10%
      let paidTax8 = 0; // 仮払消費税8%
      let paidTax10 = 0; // 仮払消費税10%
      let laborCost = 0; // 人件費（消費税対象外）
      
      const startDateStr = `${fiscalYear}-${String(4).padStart(2, '0')}-01`;
      const endYear = fiscalYear + 1;
      const endDateStr = `${endYear}-${String(3).padStart(2, '0')}-31`;
      
      // 1. 注文データから仮受消費税を計算（商品ごとの税率を使用）
      try {
        const ordersQuery = window.query(
          window.getStoreCollection('orders'),
          window.where('paidAt', '>=', window.Timestamp.fromDate(startDate)),
          window.where('paidAt', '<=', window.Timestamp.fromDate(endDate))
        );
        
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.items && Array.isArray(data.items)) {
            data.items.forEach(item => {
              const itemTotal = (item.price || 0) * (item.quantity || 1);
              const taxRate = item.taxRate || 10;
              
              if (taxRate === 8) {
                receivedTax8 += itemTotal * (8 / 108);
              } else {
                receivedTax10 += itemTotal * (10 / 110);
              }
            });
          }
        });
        
        console.log(` 仮受消費税: 8%=¥${receivedTax8.toFixed(0)}, 10%=¥${receivedTax10.toFixed(0)}`);
      } catch (err) {
        console.warn('注文データ取得エラー:', err);
      }
      
      // 2. 支出データから仮払消費税を計算
      try {
        const expensesSnapshot = await window.getDocs(window.getStoreCollection('expenses'));
        
        expensesSnapshot.forEach(doc => {
          const data = doc.data();
          const date = data.date;
          
          // 期間内のデータのみ
          if (date && date >= startDateStr && date <= endDateStr) {
            if (data.items && Array.isArray(data.items)) {
              data.items.forEach(item => {
                const amount = item.amount || 0;
                const category = item.category;
                
                // カテゴリーごとの税率判定
                if (category === '材料費' || category === '食費' || 
                    category === '接待交際費' || category === '交通費') {
                  // 8%対象
                  paidTax8 += amount * (8 / 108);
                } else if (category === '日用品' || category === '雑費・雑品' || 
                           category === '水光熱費' || category === 'その他') {
                  // 10%対象
                  paidTax10 += amount * (10 / 110);
                }
                // その他のカテゴリーは消費税対象外
              });
            }
          }
        });
        
        console.log(` 仮払消費税: 8%=¥${paidTax8.toFixed(0)}, 10%=¥${paidTax10.toFixed(0)}`);
      } catch (err) {
        console.warn('支出データ取得エラー:', err);
      }
      
      // 3. 人件費データを取得
      try {
        const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
        
        attendanceSnapshot.forEach(doc => {
          const data = doc.data();
          const dateStr = data.date;
          
          // 期間内のデータのみ
          if (dateStr && dateStr >= startDateStr && dateStr <= endDateStr) {
            // 既に計算済みの総賃金がある場合はそれを使用
            if (data.totalWage && data.totalWage > 0) {
              laborCost += data.totalWage;
            } else if (data.clockIn && data.clockOut) {
              // 総賃金がない場合は計算する
              const clockIn = new Date(`${dateStr} ${data.clockIn}`);
              const clockOut = new Date(`${dateStr} ${data.clockOut}`);
              let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
              
              // 休憩時間を引く
              if (data.breakStart1 && data.breakEnd1) {
                const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
              }
              if (data.breakStart2 && data.breakEnd2) {
                const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
              }
              
              const hourlyRate = data.hourlyRate || 1150;
              
              // 割増賃金の計算
              let totalWage = 0;
              const isHoliday = data.isHoliday || false;
              
              // 時間ごとに割増率を計算
              let currentTime = new Date(clockIn);
              const endTime = new Date(clockOut);
              
              while (currentTime < endTime) {
                const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                const segmentEnd = nextHour > endTime ? endTime : nextHour;
                
                // 休憩時間を除外
                let isBreak = false;
                if (data.breakStart1 && data.breakEnd1) {
                  const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                  const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                  if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                    isBreak = true;
                  }
                }
                if (data.breakStart2 && data.breakEnd2) {
                  const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                  const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                  if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                    isBreak = true;
                  }
                }
                
                if (!isBreak) {
                  const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                  const hour = currentTime.getHours();
                  
                  let rate = 1.0;
                  if (isHoliday) {
                    // 休日出勤: 基本35%増
                    rate = 1.35;
                    // 22時～5時は深夜割増25%を追加（合計60%増）
                    if (hour >= 22 || hour < 5) {
                      rate = 1.60;
                    }
                  } else {
                    // 平日: 22時～5時は深夜割増25%
                    if (hour >= 22 || hour < 5) {
                      rate = 1.25;
                    }
                  }
                  
                  totalWage += segmentHours * hourlyRate * rate;
                }
                
                currentTime = segmentEnd;
              }
              
              laborCost += totalWage;
            }
          }
        });
        
        console.log(` 人件費: ¥${laborCost.toFixed(0)}`);
      } catch (err) {
        console.warn('人件費データ取得エラー:', err);
      }
      
      const receivedTax = receivedTax8 + receivedTax10;
      const paidTax = paidTax8 + paidTax10;
      const netTax = receivedTax - paidTax;
      
      console.log(`計算結果: 仮受=¥${receivedTax.toFixed(0)}, 仮払=¥${paidTax.toFixed(0)}, 人件費=¥${laborCost.toFixed(0)}, 納税額=¥${netTax.toFixed(0)}`);
      
      return {
        receivedTax,
        receivedTax8,
        receivedTax10,
        paidTax,
        paidTax8,
        paidTax10,
        laborCost,
        netTax
      };
    }
    
    // 売上モーダルを閉じる
    window.closeSalesModal = function() {
      document.getElementById('salesModal').classList.add('hidden');
    };
    
    // ========== ドロアオープン機能 ==========
    
    // ドロアオープン
    window.openDrawer = async function() {
      try {
        console.log(' ドロアオープン開始');
        
        const now = new Date();
        const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        
        console.log('日付:', dateStr);
        
        // 担当者を取得
        const staffSelect = document.getElementById('staffSelect');
        const staffName = staffSelect.value || 'レジ係';
        
        console.log('担当者:', staffName);
        
        // dailySalesのドロアオープン数を更新
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        console.log(' salesRef:', salesRef);
        
        const salesDoc = await window.getDoc(salesRef);
        console.log(' salesDoc exists:', salesDoc.exists());
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          const currentCount = data.drawerOpenCount || 0;
          const newCount = currentCount + 1;
          
          console.log(' 現在のカウント:', currentCount);
          console.log(' 新しいカウント:', newCount);
          
          await window.updateDoc(salesRef, {
            drawerOpenCount: newCount,
            updatedAt: window.Timestamp.now()
          });
          
          console.log(' drawerOpenCountを更新:', newCount);
        } else {
          // 今日の売上データがない場合は新規作成
          console.log(' 新規dailySalesドキュメントを作成');
          
          await window.setDoc(salesRef, {
            date: dateStr,
            totalSales: 0,
            customerCount: 0,
            totalItems: 0,
            tax8Total: 0,
            tax10Total: 0,
            cashSales: 0,
            emoneSales: 0,
            creditSales: 0,
            drawerOpenCount: 1,
            createdAt: window.Timestamp.now(),
            updatedAt: window.Timestamp.now()
          });
          
          console.log(' 新規作成 drawerOpenCount: 1');
        }
        
        // ドロア開閉ログを記録
        await window.addDoc(window.collection(window.db, 'drawer_logs'), {
          timestamp: window.Timestamp.now(),
          staffName: staffName,
          action: 'open'
        });
        
        console.log(' ドロア開: 担当者', staffName);
        alert('ドロアを開きました\n担当者: ' + staffName);
        
      } catch (error) {
        console.error(' ドロア開エラー:', error);
        console.error(' エラー詳細:', error.stack);
        alert('ドロア開に失敗しました: ' + error.message);
      }
    };
    
    // ========== バックアップ機能 ==========
    
    /**
     * 自動バックアップ（7日ローテーション）
     * 削除設定で削除されるデータをバックアップ
     */
    window.createAutoBackup = async function() {
      try {
        console.log(' 自動バックアップ開始（7日ローテーション）');
        
        const { getDocs, setDoc, doc, Timestamp } = window;
        const today = new Date();
        const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
        
        // バックアップデータを収集
        const backupData = {
          timestamp: Timestamp.now(),
          date: dateStr,
          type: 'auto',
          data: {}
        };
        
        // 1. 商品データ（menus）
        const menusSnapshot = await getDocs(window.getStoreCollection('menus'));
        backupData.data.menus = [];
        menusSnapshot.forEach(docSnap => {
          backupData.data.menus.push({
            id: docSnap.id,
            ...docSnap.data()
          });
        });
        console.log(`商品: ${backupData.data.menus.length}件`);
        
        // 2. 従業員データ（employees）
        const employeesSnapshot = await getDocs(window.getStoreCollection('employees'));
        backupData.data.employees = [];
        employeesSnapshot.forEach(docSnap => {
          backupData.data.employees.push({
            id: docSnap.id,
            ...docSnap.data()
          });
        });
        console.log(` 従業員: ${backupData.data.employees.length}名`);
        
        // 3. 注文履歴（orders）- 最近1000件のみ
        const ordersCollection = window.getStoreCollection('orders');
        const ordersSnapshot = await getDocs(ordersCollection);
        const ordersList = [];
        ordersSnapshot.forEach(docSnap => {
          const data = docSnap.data();
          ordersList.push({
            id: docSnap.id,
            ...data,
            _timestamp: data.createdAt || data.timestamp || new Date(0)
          });
        });
        
        // 日付でソート（新しい順）
        ordersList.sort((a, b) => {
          const timeA = a._timestamp?.toDate ? a._timestamp.toDate() : new Date(a._timestamp);
          const timeB = b._timestamp?.toDate ? b._timestamp.toDate() : new Date(b._timestamp);
          return timeB - timeA;
        });
        
        // 最新1000件のみ保存
        backupData.data.orders = ordersList.slice(0, 1000).map(item => {
          const { _timestamp, ...rest } = item;
          return rest;
        });
        console.log(` 注文履歴: ${backupData.data.orders.length}件`);
        
        // 4. 勤怠データ（attendance）- 最近1000件のみ
        const attendanceCollection = window.getStoreCollection('attendance');
        const attendanceSnapshot = await getDocs(attendanceCollection);
        const attendanceList = [];
        attendanceSnapshot.forEach(docSnap => {
          const data = docSnap.data();
          attendanceList.push({
            id: docSnap.id,
            ...data,
            _timestamp: data.createdAt || data.timestamp || new Date(0)
          });
        });
        
        // 日付でソート（新しい順）
        attendanceList.sort((a, b) => {
          const timeA = a._timestamp?.toDate ? a._timestamp.toDate() : new Date(a._timestamp);
          const timeB = b._timestamp?.toDate ? b._timestamp.toDate() : new Date(b._timestamp);
          return timeB - timeA;
        });
        
        // 最新1000件のみ保存
        backupData.data.attendance = attendanceList.slice(0, 1000).map(item => {
          const { _timestamp, ...rest } = item;
          return rest;
        });
        console.log(` 勤怠: ${backupData.data.attendance.length}件`);
        
        // 設定データをバックアップ
        const { getDoc } = window;
        
        // レシート設定
        try {
          let receiptRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            receiptRef = doc(window.db, 'stores', window.currentStoreId, 'receipt_settings', 'default');
          } else {
            receiptRef = doc(window.db, 'receipt_settings', 'default');
          }
          const receiptDoc = await getDoc(receiptRef);
          backupData.data.receipt_settings = receiptDoc.exists() ? receiptDoc.data() : null;
        } catch (e) { backupData.data.receipt_settings = null; }
        
        // 商品カテゴリ設定とトッピング
        try {
          let menuSettingsRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            menuSettingsRef = doc(window.db, 'stores', window.currentStoreId, 'menu_settings', 'default');
          } else {
            menuSettingsRef = doc(window.db, 'menu_settings', 'default');
          }
          const menuSettingsDoc = await getDoc(menuSettingsRef);
          const menuSettingsData = menuSettingsDoc.exists() ? menuSettingsDoc.data() : null;
          
          // トッピングを追加
          if (menuSettingsData) {
            try {
              const toppingsSnapshot = await getDocs(window.getStoreCollection('toppings'));
              const toppings = [];
              toppingsSnapshot.forEach(docSnap => {
                toppings.push({ id: docSnap.id, ...docSnap.data() });
              });
              menuSettingsData.toppings = toppings;
            } catch (e) {
              menuSettingsData.toppings = [];
            }
          }
          
          backupData.data.menu_settings = menuSettingsData;
        } catch (e) { backupData.data.menu_settings = null; }
        
        // 在庫設定
        try {
          let inventoryRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            inventoryRef = doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
          } else {
            inventoryRef = doc(window.db, 'inventory_settings', 'default');
          }
          const inventoryDoc = await getDoc(inventoryRef);
          backupData.data.inventory_settings = inventoryDoc.exists() ? inventoryDoc.data() : null;
        } catch (e) { backupData.data.inventory_settings = null; }
        
        // アラート設定
        try {
          let alertRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            alertRef = doc(window.db, 'stores', window.currentStoreId, 'alert_settings', 'default');
          } else {
            alertRef = doc(window.db, 'alert_settings', 'default');
          }
          const alertDoc = await getDoc(alertRef);
          backupData.data.alert_settings = alertDoc.exists() ? alertDoc.data() : null;
        } catch (e) { backupData.data.alert_settings = null; }
        
        // 営業時間設定
        try {
          let businessRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            businessRef = doc(window.db, 'stores', window.currentStoreId, 'business_hours', 'default');
          } else {
            businessRef = doc(window.db, 'business_hours', 'default');
          }
          const businessDoc = await getDoc(businessRef);
          backupData.data.business_hours = businessDoc.exists() ? businessDoc.data() : null;
        } catch (e) { backupData.data.business_hours = null; }
        
        // テーブル設定
        try {
          let tableRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            tableRef = doc(window.db, 'stores', window.currentStoreId, 'table_settings', 'default');
          } else {
            tableRef = doc(window.db, 'table_settings', 'default');
          }
          const tableDoc = await getDoc(tableRef);
          backupData.data.table_settings = tableDoc.exists() ? tableDoc.data() : null;
        } catch (e) { backupData.data.table_settings = null; }
        
        // テーブルデータ（各テーブルのドキュメント）
        try {
          const tablesSnapshot = await getDocs(window.getStoreCollection('tables'));
          backupData.data.tables = [];
          tablesSnapshot.forEach(docSnap => {
            backupData.data.tables.push({ id: docSnap.id, ...docSnap.data() });
          });
          console.log(`️ テーブル: ${backupData.data.tables.length}件`);
        } catch (e) {
          console.warn('テーブルデータの取得に失敗:', e.message);
          backupData.data.tables = [];
        }
        
        const settingsCount = [
          backupData.data.menu_settings,
          backupData.data.receipt_settings,
          backupData.data.inventory_settings,
          backupData.data.alert_settings,
          backupData.data.business_hours,
          backupData.data.table_settings
        ].filter(s => s !== null).length;
        console.log(`️ 設定: ${settingsCount}種類`);
        
        // バックアップを保存（7日ローテーション）
        const dayOfWeek = today.getDay(); // 0=日曜, 1=月曜, ..., 6=土曜
        const backupId = `auto_day${dayOfWeek}`; // day0〜day6で7日ローテーション
        
        let backupRef;
        if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
          backupRef = doc(window.db, 'stores', window.currentStoreId, 'backups', backupId);
        } else {
          backupRef = doc(window.db, 'backups', backupId);
        }
        
        await setDoc(backupRef, backupData);
        
        console.log(`自動バックアップ完了: ${backupId} (${dateStr})`);
        return true;
      } catch (error) {
        console.error(' 自動バックアップエラー:', error);
        return false;
      }
    };
    
    /**
     * 手動バックアップ
     */
    window.createManualBackup = async function() {
      try {
        console.log(' 手動バックアップ開始');
        
        const { getDocs, setDoc, doc, Timestamp } = window;
        const now = new Date();
        const dateTimeStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;
        
        // バックアップデータを収集
        const backupData = {
          timestamp: Timestamp.now(),
          date: dateTimeStr,
          type: 'manual',
          data: {}
        };
        
        // 1. 商品データ
        const menusSnapshot = await getDocs(window.getStoreCollection('menus'));
        backupData.data.menus = [];
        menusSnapshot.forEach(docSnap => {
          backupData.data.menus.push({
            id: docSnap.id,
            ...docSnap.data()
          });
        });
        
        // 2. 従業員データ
        const employeesSnapshot = await getDocs(window.getStoreCollection('employees'));
        backupData.data.employees = [];
        employeesSnapshot.forEach(docSnap => {
          backupData.data.employees.push({
            id: docSnap.id,
            ...docSnap.data()
          });
        });
        
        // 3. 注文履歴（最近1000件）
        const ordersCollection = window.getStoreCollection('orders');
        const ordersSnapshot = await getDocs(ordersCollection);
        const ordersList = [];
        ordersSnapshot.forEach(docSnap => {
          const data = docSnap.data();
          ordersList.push({
            id: docSnap.id,
            ...data,
            _timestamp: data.createdAt || data.timestamp || new Date(0)
          });
        });
        
        // 日付でソート（新しい順）
        ordersList.sort((a, b) => {
          const timeA = a._timestamp?.toDate ? a._timestamp.toDate() : new Date(a._timestamp);
          const timeB = b._timestamp?.toDate ? b._timestamp.toDate() : new Date(b._timestamp);
          return timeB - timeA;
        });
        
        // 最新1000件のみ保存
        backupData.data.orders = ordersList.slice(0, 1000).map(item => {
          const { _timestamp, ...rest } = item;
          return rest;
        });
        
        // 4. 勤怠データ（最近1000件）
        const attendanceCollection = window.getStoreCollection('attendance');
        const attendanceSnapshot = await getDocs(attendanceCollection);
        const attendanceList = [];
        attendanceSnapshot.forEach(docSnap => {
          const data = docSnap.data();
          attendanceList.push({
            id: docSnap.id,
            ...data,
            _timestamp: data.createdAt || data.timestamp || new Date(0)
          });
        });
        
        // 日付でソート（新しい順）
        attendanceList.sort((a, b) => {
          const timeA = a._timestamp?.toDate ? a._timestamp.toDate() : new Date(a._timestamp);
          const timeB = b._timestamp?.toDate ? b._timestamp.toDate() : new Date(b._timestamp);
          return timeB - timeA;
        });
        
        // 最新1000件のみ保存
        backupData.data.attendance = attendanceList.slice(0, 1000).map(item => {
          const { _timestamp, ...rest } = item;
          return rest;
        });
        
        // 設定データをバックアップ
        const { getDoc } = window;
        
        // レシート設定
        try {
          let receiptRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            receiptRef = doc(window.db, 'stores', window.currentStoreId, 'receipt_settings', 'default');
          } else {
            receiptRef = doc(window.db, 'receipt_settings', 'default');
          }
          const receiptDoc = await getDoc(receiptRef);
          backupData.data.receipt_settings = receiptDoc.exists() ? receiptDoc.data() : null;
        } catch (e) { backupData.data.receipt_settings = null; }
        
        // 商品カテゴリ設定とトッピング
        try {
          let menuSettingsRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            menuSettingsRef = doc(window.db, 'stores', window.currentStoreId, 'menu_settings', 'default');
          } else {
            menuSettingsRef = doc(window.db, 'menu_settings', 'default');
          }
          const menuSettingsDoc = await getDoc(menuSettingsRef);
          const menuSettingsData = menuSettingsDoc.exists() ? menuSettingsDoc.data() : null;
          
          // トッピングを追加
          if (menuSettingsData) {
            try {
              const toppingsSnapshot = await getDocs(window.getStoreCollection('toppings'));
              const toppings = [];
              toppingsSnapshot.forEach(docSnap => {
                toppings.push({ id: docSnap.id, ...docSnap.data() });
              });
              menuSettingsData.toppings = toppings;
            } catch (e) {
              menuSettingsData.toppings = [];
            }
          }
          
          backupData.data.menu_settings = menuSettingsData;
        } catch (e) { backupData.data.menu_settings = null; }
        
        // 在庫設定
        try {
          let inventoryRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            inventoryRef = doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
          } else {
            inventoryRef = doc(window.db, 'inventory_settings', 'default');
          }
          const inventoryDoc = await getDoc(inventoryRef);
          backupData.data.inventory_settings = inventoryDoc.exists() ? inventoryDoc.data() : null;
        } catch (e) { backupData.data.inventory_settings = null; }
        
        // アラート設定
        try {
          let alertRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            alertRef = doc(window.db, 'stores', window.currentStoreId, 'alert_settings', 'default');
          } else {
            alertRef = doc(window.db, 'alert_settings', 'default');
          }
          const alertDoc = await getDoc(alertRef);
          backupData.data.alert_settings = alertDoc.exists() ? alertDoc.data() : null;
        } catch (e) { backupData.data.alert_settings = null; }
        
        // 営業時間設定
        try {
          let businessRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            businessRef = doc(window.db, 'stores', window.currentStoreId, 'business_hours', 'default');
          } else {
            businessRef = doc(window.db, 'business_hours', 'default');
          }
          const businessDoc = await getDoc(businessRef);
          backupData.data.business_hours = businessDoc.exists() ? businessDoc.data() : null;
        } catch (e) { backupData.data.business_hours = null; }
        
        // テーブル設定
        try {
          let tableRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            tableRef = doc(window.db, 'stores', window.currentStoreId, 'table_settings', 'default');
          } else {
            tableRef = doc(window.db, 'table_settings', 'default');
          }
          const tableDoc = await getDoc(tableRef);
          backupData.data.table_settings = tableDoc.exists() ? tableDoc.data() : null;
        } catch (e) { backupData.data.table_settings = null; }
        
        const settingsCount = [
          backupData.data.menu_settings,
          backupData.data.receipt_settings,
          backupData.data.inventory_settings,
          backupData.data.alert_settings,
          backupData.data.business_hours,
          backupData.data.table_settings
        ].filter(s => s !== null).length;
        
        // 手動バックアップを保存
        const backupId = `manual_${dateTimeStr}`;
        
        let backupRef;
        if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
          backupRef = doc(window.db, 'stores', window.currentStoreId, 'backups', backupId);
        } else {
          backupRef = doc(window.db, 'backups', backupId);
        }
        
        await setDoc(backupRef, backupData);
        
        console.log(`手動バックアップ完了: ${backupId}`);
        alert(`バックアップを作成しました\n\n商品: ${backupData.data.menus.length}件\n従業員: ${backupData.data.employees.length}名\n注文: ${backupData.data.orders.length}件\n勤怠: ${backupData.data.attendance.length}件\n設定: ${settingsCount}種類`);
        return true;
      } catch (error) {
        console.error(' 手動バックアップエラー:', error);
        alert('バックアップに失敗しました: ' + error.message);
        return false;
      }
    };
    
    // ========== 精算機能 ==========
    
    // 精算モーダルを表示
    window.showSettlementModal = async function() {
      // Firebase初期化を待つ
      if (!window.firebaseReady) {
        await new Promise(resolve => {
          window.addEventListener('firebaseReady', resolve, { once: true });
        });
      }
      
      // 選択された営業日を初期値として設定
      const dateStr = window.getBusinessDateString();
      
      console.log('精算日付:', dateStr);
      
      document.getElementById('settlementDate').value = dateStr;
      
      const container = document.getElementById('settlementSummary');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">集計中...</div>';
      
      document.getElementById('settlementModal').classList.remove('hidden');
      
      // 日付変更時にサマリーを更新
      document.getElementById('settlementDate').onchange = updateSettlementSummary;
      
      await updateSettlementSummary();
    };
    
    // 精算サマリーを更新
    async function updateSettlementSummary() {
      const container = document.getElementById('settlementSummary');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">集計中...</div>';
      
      try {
        const dateStr = document.getElementById('settlementDate').value;
        
        // 日次売上データから取得
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        let settlementData = {
          totalSales: 0,
          customerCount: 0,
          totalItems: 0,
          cashSales: 0,
          emoneSales: 0,
          creditSales: 0,
          totalDiscount: 0,
          tax8Total: 0,
          tax10Total: 0,
          drawerOpenCount: 0,
          redSlipCount: 0,  // NEW
          redSlipAmount: 0,  // NEW
          redSlipTax8Total: 0,  // NEW
          redSlipTax10Total: 0  // NEW
        };
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          console.log(' dailySalesデータ:', data);
          console.log(' drawerOpenCount:', data.drawerOpenCount);
          
          settlementData = {
            totalSales: data.totalSales || 0,
            customerCount: data.customerCount || 0,
            totalItems: data.totalItems || 0,
            cashSales: data.cashSales || 0,
            emoneSales: data.emoneSales || 0,
            creditSales: data.creditSales || 0,
            totalDiscount: data.totalDiscount || 0,
            tax8Total: data.tax8Total || 0,
            tax10Total: data.tax10Total || 0,
            drawerOpenCount: data.drawerOpenCount || 0,
            redSlipCount: data.redSlipCount || 0,  // NEW
            redSlipAmount: data.redSlipAmount || 0,  // NEW
            redSlipTax8Total: data.redSlipTax8Total || 0,  // NEW
            redSlipTax10Total: data.redSlipTax10Total || 0  // NEW
          };
          
          console.log(' settlementData:', settlementData);
        }
        
        // settlementDataをグローバルに保存（CSV生成で使用）
        window.currentSettlementData = settlementData;
        window.currentSettlementDate = dateStr;
        
        container.innerHTML = `
          <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 2px solid #ddd;">
              <span style="font-size: 16px;">総売上</span>
              <strong style="font-size: 20px; color: #4CAF50;">¥${settlementData.totalSales.toLocaleString()}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
              <span>客数</span>
              <strong>${settlementData.customerCount}組</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
              <span>現金</span>
              <strong>¥${settlementData.cashSales.toLocaleString()}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
              <span>カード</span>
              <strong>¥${settlementData.creditSales.toLocaleString()}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0;">
              <span>電子マネー</span>
              <strong>¥${settlementData.emoneSales.toLocaleString()}</strong>
            </div>
          </div>
        `;
      } catch (e) {
        console.error('精算サマリーエラー:', e);
        container.innerHTML = '<div style="text-align: center; color: red;">エラーが発生しました</div>';
      }
    }
    
    // 精算を実行（CSVダウンロード）
    window.confirmSettlement = async function() {
      // Firebase初期化を待つ
      if (!window.firebaseReady) {
        await new Promise(resolve => {
          window.addEventListener('firebaseReady', resolve, { once: true });
        });
      }
      
      // オシャレなバックアップ確認ダイアログ
      const shouldBackup = await new Promise((resolve) => {
        // モーダルHTML作成
        const modal = document.createElement('div');
        modal.id = 'backupConfirmModal';
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
          background: rgba(0,0,0,0.7); display: flex; align-items: center; 
          justify-content: center; z-index: 999999; animation: fadeIn 0.2s;
        `;
        
        modal.innerHTML = `
          <div style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px; padding: 0; max-width: 500px; width: 90%;
            box-shadow: 0 25px 60px rgba(0,0,0,0.4); overflow: hidden;
            animation: slideUp 0.3s;
          ">
            <div style="background: white; padding: 32px; border-radius: 0 0 24px 24px;">
              <div style="text-align: center; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: bold; color: #333; margin-bottom: 8px;">
                  精算を実行する前に、データの自動バックアップを作成しますか？
                </h3>
              </div>
              
              <div style="background: #f0f7ff; border-left: 4px solid #667eea; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-weight: bold; color: #667eea; margin-bottom: 12px; font-size: 16px;">【推奨: はい】</div>
                <div style="color: #555; font-size: 14px; line-height: 1.8;">
                  以下がバックアップされます：<br>
                  • 商品<br>
                  • 従業員<br>
                  • 注文履歴<br>
                  • 勤怠データ<br>
                  • 商品カテゴリ設定<br>
                  • レシート設定<br>
                  • 在庫設定<br>
                  • アラート設定<br>
                  • 営業時間設定<br>
                  • テーブル設定<br><br>
                  誤って削除した場合に復元できます。<br>
                  過去7日分のバックアップが自動保持されます。
                </div>
              </div>
              
              <div style="background: #fff9e6; border-left: 4px solid #ff9800; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <div style="font-weight: bold; color: #ff9800; margin-bottom: 8px; font-size: 15px;">【いいえを選択した場合】</div>
                <div style="color: #666; font-size: 14px;">バックアップなしで精算を実行します</div>
              </div>
              
              <div style="display: flex; gap: 12px;">
                <button id="backupNoBtn" style="
                  flex: 1; padding: 16px; font-size: 16px; font-weight: bold;
                  border: 2px solid #ddd; border-radius: 12px; cursor: pointer;
                  background: white; color: #666; transition: all 0.2s;
                " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                  いいえ
                </button>
                <button id="backupYesBtn" style="
                  flex: 1; padding: 16px; font-size: 16px; font-weight: bold;
                  border: none; border-radius: 12px; cursor: pointer;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                  transition: all 0.2s;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.5)'" 
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'">
                  はい（推奨）
                </button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('backupYesBtn').onclick = () => {
          modal.remove();
          resolve(true);
        };
        document.getElementById('backupNoBtn').onclick = () => {
          modal.remove();
          resolve(false);
        };
      });
      
      if (shouldBackup) {
        console.log(' バックアップを作成します');
        const backupSuccess = await window.createAutoBackup();
        if (!backupSuccess) {
          const continueAnyway = confirm('バックアップの作成に失敗しました。\n\nそれでも精算を続けますか？');
          if (!continueAnyway) {
            return;
          }
        } else {
          console.log(' バックアップ作成完了 - 精算を続行します');
        }
      } else {
        console.log(' バックアップをスキップして精算を実行します');
      }
      
      try {
        const settlementData = window.currentSettlementData;
        const dateStr = window.currentSettlementDate;
        
        if (!settlementData) {
          alert('精算データが見つかりません');
          return;
        }
        
        console.log(' 精算ジャーナル生成開始');
        console.log(' settlementData:', settlementData);
        
        // ===== 現在時刻を取得 =====
        const now = new Date();
        const outputTime = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        
        // ===== 担当者を取得 =====
        const staffSelect = document.getElementById('staffSelect');
        const staffName = staffSelect.value || '未選択';
        
        // ===== dailySalesから基本データを取得 =====
        const customerCount = settlementData.customerCount || 0;
        const totalItems = settlementData.totalItems || 0;
        const totalSales = settlementData.totalSales || 0;
        const averageSpend = customerCount > 0 ? Math.round(totalSales / customerCount) : 0;
        
        // ===== 売上内訳 =====
        const cashSales = settlementData.cashSales || 0;
        const emoneSales = settlementData.emoneSales || 0;
        const creditSales = settlementData.creditSales || 0;
        const discountTotal = settlementData.totalDiscount || 0;
        
        // ===== 税金内訳（内税） =====
        const tax8TotalWithTax = settlementData.tax8Total || 0;  // 8%商品合計（税込）
        const tax10TotalWithTax = settlementData.tax10Total || 0; // 10%商品合計（税込）
        
        // 税抜価格を計算（内税なので税込価格から逆算）
        const tax8Excluded = Math.floor(tax8TotalWithTax / 1.08);  // 8%商品合計（税抜）
        const tax10Excluded = Math.floor(tax10TotalWithTax / 1.10); // 10%商品合計（税抜）
        
        // 消費税額を計算
        const tax8Amount = tax8TotalWithTax - tax8Excluded;  // 8%の消費税
        const tax10Amount = tax10TotalWithTax - tax10Excluded; // 10%の消費税
        
        // 合計
        const totalTax = tax8Amount + tax10Amount;  // 消費税の合計
        const taxExcludedTotal = tax8Excluded + tax10Excluded;  // 税抜合計
        const taxIncludedTotal = tax8TotalWithTax + tax10TotalWithTax;  // 税込合計（8%と10%の合計）
        
        // 内税・外税の内訳を注文データから集計
        let tax8InclusiveTotal = 0;
        let tax10InclusiveTotal = 0;
        let tax8ExclusiveTotal = 0;
        let tax10ExclusiveTotal = 0;
        let redSlipTax8Inclusive = 0;
        let redSlipTax10Inclusive = 0;
        let redSlipTax8Exclusive = 0;
        let redSlipTax10Exclusive = 0;
        
        try {
          const ordersQuery = window.query(
            window.getStoreCollection('orders'),
            window.where('paidAt', '!=', null)
          );
          const ordersSnapshot = await window.getDocs(ordersQuery);
          
          ordersSnapshot.forEach(doc => {
            const data = doc.data();
            if (!data.paidAt || !data.items) return;
            
            const orderDate = data.paidAt.toDate();
            let targetDate = new Date(orderDate);
            if (orderDate.getHours() < 3) {
              targetDate.setDate(targetDate.getDate() - 1);
            }
            
            const orderDateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-${String(targetDate.getDate()).padStart(2, '0')}`;
            
            if (orderDateStr === dateStr) {
              const isRedSlip = data.isRedSlip || false;
              
              data.items.forEach(item => {
                const taxType = item.taxType || 'inclusive';
                const taxAmount = getTaxAmount(item, item.quantity || 1);
                
                if ((item.taxRate || 10) === 8) {
                  if (taxType === 'exclusive') {
                    tax8ExclusiveTotal += taxAmount;
                    if (isRedSlip) redSlipTax8Exclusive += taxAmount;
                  } else {
                    tax8InclusiveTotal += taxAmount;
                    if (isRedSlip) redSlipTax8Inclusive += taxAmount;
                  }
                } else {
                  if (taxType === 'exclusive') {
                    tax10ExclusiveTotal += taxAmount;
                    if (isRedSlip) redSlipTax10Exclusive += taxAmount;
                  } else {
                    tax10InclusiveTotal += taxAmount;
                    if (isRedSlip) redSlipTax10Inclusive += taxAmount;
                  }
                }
              });
            }
          });
          
          console.log(' 内税・外税の内訳:', {
            tax8Inclusive: tax8InclusiveTotal,
            tax8Exclusive: tax8ExclusiveTotal,
            tax10Inclusive: tax10InclusiveTotal,
            tax10Exclusive: tax10ExclusiveTotal
          });
        } catch (e) {
          console.error('内税・外税集計エラー:', e);
        }
        
        // ===== ドロアオープン数 =====
        const drawerOpenCount = settlementData.drawerOpenCount || 0;
        console.log(' 精算時のdrawerOpenCount:', drawerOpenCount);
        console.log(' settlementData全体:', settlementData);
        
        // ===== 赤伝票情報を取得 =====
        const redSlipCount = settlementData.redSlipCount || 0;
        const redSlipAmount = settlementData.redSlipAmount || 0;
        const redSlipTax8Total = settlementData.redSlipTax8Total || 0;
        const redSlipTax10Total = settlementData.redSlipTax10Total || 0;
        console.log(' 赤伝票件数:', redSlipCount);
        console.log(' 赤伝票金額:', redSlipAmount);
        console.log(' 赤伝票8%税金:', redSlipTax8Total);
        console.log(' 赤伝票10%税金:', redSlipTax10Total);
        
        // ===== 支出を取得 =====
        let expenseTotal = 0;
        try {
          const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
          if (expenseDoc.exists()) {
            expenseTotal = expenseDoc.data().total || 0;
            console.log(' 支出:', expenseTotal);
          }
        } catch (e) {
          console.error('支出取得エラー:', e);
        }
        
        // ===== 人件費を取得 =====
        let laborCost = 0;
        try {
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(docData => {
            const data = docData.data();
            if (data.date === dateStr) {
              // 既に計算済みの総賃金がある場合はそれを使用
              if (data.totalWage && data.totalWage > 0) {
                laborCost += data.totalWage;
              } else if (data.clockIn && data.clockOut) {
                // 総賃金がない場合は計算する
                const clockIn = new Date(`${dateStr} ${data.clockIn}`);
                const clockOut = new Date(`${dateStr} ${data.clockOut}`);
                let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                
                // 休憩時間を引く
                if (data.breakStart1 && data.breakEnd1) {
                  const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                  const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                  workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                }
                if (data.breakStart2 && data.breakEnd2) {
                  const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                  const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                  workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                }
                
                const hourlyRate = data.hourlyRate || 1150;
                
                // 割増賃金の計算
                let totalWage = 0;
                const isHoliday = data.isHoliday || false;
                
                // 時間ごとに割増率を計算
                let currentTime = new Date(clockIn);
                const endTime = new Date(clockOut);
                
                while (currentTime < endTime) {
                  const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                  const segmentEnd = nextHour > endTime ? endTime : nextHour;
                  
                  // 休憩時間を除外
                  let isBreak = false;
                  if (data.breakStart1 && data.breakEnd1) {
                    const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                    const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                    if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                      isBreak = true;
                    }
                  }
                  if (data.breakStart2 && data.breakEnd2) {
                    const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                    const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                    if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                      isBreak = true;
                    }
                  }
                  
                  if (!isBreak) {
                    const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                    const hour = currentTime.getHours();
                    
                    let rate = 1.0;
                    if (isHoliday) {
                      // 休日出勤: 基本35%増
                      rate = 1.35;
                      // 22時～5時は深夜割増25%を追加（合計60%増）
                      if (hour >= 22 || hour < 5) {
                        rate = 1.60;
                      }
                    } else {
                      // 平日: 22時～5時は深夜割増25%
                      if (hour >= 22 || hour < 5) {
                        rate = 1.25;
                      }
                    }
                    
                    totalWage += segmentHours * hourlyRate * rate;
                  }
                  
                  currentTime = segmentEnd;
                }
                
                laborCost += totalWage;
              }
            }
          });
          console.log(' 人件費:', laborCost);
        } catch (e) {
          console.error('人件費取得エラー:', e);
        }
        
        // 値引き・支出を引いた最終合計売上
        const finalTotalSales = taxIncludedTotal - discountTotal - expenseTotal;
        
        // ===== デバッグログ =====
        console.log('日付:', dateStr);
        console.log(' 出力時刻:', outputTime);
        console.log(' 客数:', customerCount);
        console.log(' 総売上点数:', totalItems);
        console.log(' 平均客単価:', averageSpend);
        console.log(' 合計売上:', totalSales);
        console.log(' 値引き:', discountTotal);
        console.log('8%商品（税込）:', tax8TotalWithTax);
        console.log('8%商品（税抜）:', tax8Excluded);
        console.log('8%消費税:', tax8Amount);
        console.log('10%商品（税込）:', tax10TotalWithTax);
        console.log('10%商品（税抜）:', tax10Excluded);
        console.log('10%消費税:', tax10Amount);
        console.log(' ドロアオープン数:', drawerOpenCount);
        console.log('担当者:', staffName);
        
        // ===== ジャーナルテキストを生成 =====
        const journalText = `
=====================================
      精算ジャーナル
=====================================
出力時刻: ${outputTime}
客数: ${customerCount}組
総売上点数: ${totalItems}点
平均客単価: ¥${averageSpend.toLocaleString()}
合計売上: ¥${totalSales.toLocaleString()}

-------------------------------------
売上内訳
-------------------------------------
現金: ¥${cashSales.toLocaleString()}
電子マネー: ¥${emoneSales.toLocaleString()}
クレジットカード: ¥${creditSales.toLocaleString()}
値引き: ¥${discountTotal.toLocaleString()}

-------------------------------------
税金内訳※赤伝票減算前
-------------------------------------
8%の商品合計（税抜）: ¥${tax8Excluded.toLocaleString()}
8%の商品合計（税込）: ¥${tax8TotalWithTax.toLocaleString()}
8%の消費税: ¥${tax8Amount.toLocaleString()}
  内税: ¥${tax8InclusiveTotal.toLocaleString()}
  外税: ¥${tax8ExclusiveTotal.toLocaleString()}

10%の商品合計（税抜）: ¥${tax10Excluded.toLocaleString()}
10%の商品合計（税込）: ¥${tax10TotalWithTax.toLocaleString()}
10%の消費税: ¥${tax10Amount.toLocaleString()}
  内税: ¥${tax10InclusiveTotal.toLocaleString()}
  外税: ¥${tax10ExclusiveTotal.toLocaleString()}

消費税の合計: ¥${totalTax.toLocaleString()}
税抜合計: ¥${taxExcludedTotal.toLocaleString()}
税込合計: ¥${taxIncludedTotal.toLocaleString()}
${redSlipCount > 0 ? `
-------------------------------------
赤伝票の税金内訳
-------------------------------------
8%の赤伝票（税抜）: -¥${Math.floor(redSlipTax8Total / 1.08).toLocaleString()}
8%の赤伝票（税込）: -¥${redSlipTax8Total.toLocaleString()}
8%の赤伝票の消費税: -¥${(redSlipTax8Total - Math.floor(redSlipTax8Total / 1.08)).toLocaleString()}
  内税: -¥${redSlipTax8Inclusive.toLocaleString()}
  外税: -¥${redSlipTax8Exclusive.toLocaleString()}

10%の赤伝票（税抜）: -¥${Math.floor(redSlipTax10Total / 1.10).toLocaleString()}
10%の赤伝票（税込）: -¥${redSlipTax10Total.toLocaleString()}
10%の赤伝票の消費税: -¥${(redSlipTax10Total - Math.floor(redSlipTax10Total / 1.10)).toLocaleString()}
  内税: -¥${redSlipTax10Inclusive.toLocaleString()}
  外税: -¥${redSlipTax10Exclusive.toLocaleString()}

赤伝票消費税の合計: -¥${((redSlipTax8Total - Math.floor(redSlipTax8Total / 1.08)) + (redSlipTax10Total - Math.floor(redSlipTax10Total / 1.10))).toLocaleString()}
赤伝票税抜合計: -¥${(Math.floor(redSlipTax8Total / 1.08) + Math.floor(redSlipTax10Total / 1.10)).toLocaleString()}
赤伝票税込合計: -¥${(redSlipTax8Total + redSlipTax10Total).toLocaleString()}

-------------------------------------
税金内訳 正式計算（赤伝票減算後）
-------------------------------------
8%の商品合計（税抜）: ¥${Math.floor((tax8TotalWithTax - redSlipTax8Total) / 1.08).toLocaleString()}
8%の商品合計（税込）: ¥${(tax8TotalWithTax - redSlipTax8Total).toLocaleString()}
8%の消費税: ¥${((tax8TotalWithTax - redSlipTax8Total) - Math.floor((tax8TotalWithTax - redSlipTax8Total) / 1.08)).toLocaleString()}
  内税: ¥${(tax8InclusiveTotal - redSlipTax8Inclusive).toLocaleString()}
  外税: ¥${(tax8ExclusiveTotal - redSlipTax8Exclusive).toLocaleString()}

10%の商品合計（税抜）: ¥${Math.floor((tax10TotalWithTax - redSlipTax10Total) / 1.10).toLocaleString()}
10%の商品合計（税込）: ¥${(tax10TotalWithTax - redSlipTax10Total).toLocaleString()}
10%の消費税: ¥${((tax10TotalWithTax - redSlipTax10Total) - Math.floor((tax10TotalWithTax - redSlipTax10Total) / 1.10)).toLocaleString()}
  内税: ¥${(tax10InclusiveTotal - redSlipTax10Inclusive).toLocaleString()}
  外税: ¥${(tax10ExclusiveTotal - redSlipTax10Exclusive).toLocaleString()}

消費税の合計: ¥${(((tax8TotalWithTax - redSlipTax8Total) - Math.floor((tax8TotalWithTax - redSlipTax8Total) / 1.08)) + ((tax10TotalWithTax - redSlipTax10Total) - Math.floor((tax10TotalWithTax - redSlipTax10Total) / 1.10))).toLocaleString()}
税抜合計: ¥${(Math.floor((tax8TotalWithTax - redSlipTax8Total) / 1.08) + Math.floor((tax10TotalWithTax - redSlipTax10Total) / 1.10)).toLocaleString()}
税込合計: ¥${((tax8TotalWithTax - redSlipTax8Total) + (tax10TotalWithTax - redSlipTax10Total)).toLocaleString()}
` : ''}
支出: ¥${expenseTotal.toLocaleString()}
合計売上: ¥${(redSlipCount > 0 ? ((tax8TotalWithTax - redSlipTax8Total) + (tax10TotalWithTax - redSlipTax10Total)) - expenseTotal : taxIncludedTotal - expenseTotal).toLocaleString()}

-------------------------------------
その他
-------------------------------------
ドロアオープン数: ${drawerOpenCount}回
赤伝票件数: ${redSlipCount}件
赤伝票金額: ¥${redSlipAmount.toLocaleString()}
人件費: ¥${Math.round(laborCost).toLocaleString()}
担当者: ${staffName}

=====================================
`;
        
        // ===== HTML要素を作成してPNG画像として保存 =====
        const journalDiv = document.createElement('div');
        journalDiv.style.cssText = `
          font-family: 'Courier New', monospace;
          font-size: 14px;
          line-height: 1.6;
          padding: 30px;
          background: white;
          color: black;
          white-space: pre-wrap;
          width: 800px;
          position: absolute;
          left: -9999px;
        `;
        
        // HTMLとして生成し、支出と合計売上を赤色にする
        journalDiv.innerHTML = journalText
          .replace(/^(支出: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>')
          .replace(/^(合計売上: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>')
          .replace(/^(税金内訳 正式計算（赤伝票減算後）)$/gm, '<span style="color: #1976d2; font-weight: bold;">$1</span>');
        
        document.body.appendChild(journalDiv);
        
        // html2canvasで画像化
        const canvas = await html2canvas(journalDiv, {
          scale: 2,
          backgroundColor: '#ffffff',
          logging: false
        });
        
        // PNG画像としてダウンロード
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `精算ジャーナル_${dateStr}.png`;
          link.click();
          URL.revokeObjectURL(url);
          document.body.removeChild(journalDiv);
        });
        
        // ===== 精算記録をFirebaseに保存 =====
        await window.addDoc(window.getStoreCollection('settlements'), {
          date: dateStr,
          outputTime: outputTime,
          timestamp: window.Timestamp.now(),
          customerCount: customerCount,
          totalItems: totalItems,
          averageSpend: averageSpend,
          totalSales: totalSales,
          cashSales: cashSales,
          emoneSales: emoneSales,
          creditSales: creditSales,
          discountTotal: discountTotal,
          tax8TotalWithTax: tax8TotalWithTax,
          tax8Excluded: tax8Excluded,
          tax8Amount: tax8Amount,
          tax10TotalWithTax: tax10TotalWithTax,
          tax10Excluded: tax10Excluded,
          tax10Amount: tax10Amount,
          totalTax: totalTax,
          taxExcludedTotal: taxExcludedTotal,
          taxIncludedTotal: taxIncludedTotal,
          drawerOpenCount: drawerOpenCount,
          redSlipCount: redSlipCount,  // 赤伝票件数
          redSlipAmount: redSlipAmount,  // 赤伝票金額
          redSlipTax8Total: redSlipTax8Total,  // 赤伝票8%税金
          redSlipTax10Total: redSlipTax10Total,  // 赤伝票10%税金
          staffName: staffName,
          aiComment: ""
        });
        
        console.log(' 精算ジャーナル生成完了');
        closeSettlementModal();
        
      } catch (e) {
        console.error(' 精算エラー:', e);
        alert('精算に失敗しました: ' + e.message);
      }
    };
    
    // 精算モーダルを閉じる
    window.closeSettlementModal = function() {
      document.getElementById('settlementModal').classList.add('hidden');
    };
    
    // ===== 支出機能 =====
    let expenseRows = [];
    let currentExpenseDate = null;
    
    // 支出モーダルを開く
    window.showExpenseModal = async function() {
      const now = new Date();
      const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
      
      // 本日の日付を取得（午前3時基準）
      const todayStart = new Date(jstNow);
      todayStart.setHours(3, 0, 0, 0);
      if (jstNow.getHours() < 3) {
        todayStart.setDate(todayStart.getDate() - 1);
      }
      
      const year = todayStart.getFullYear();
      const month = String(todayStart.getMonth() + 1).padStart(2, '0');
      const day = String(todayStart.getDate()).padStart(2, '0');
      currentExpenseDate = `${year}-${month}-${day}`;
      
      // 日付入力フィールドに本日の日付を設定
      document.getElementById('expenseDateInput').value = currentExpenseDate;
      
      console.log('支出モーダル表示 - 本日の日付:', currentExpenseDate);
      console.log('現在時刻(JST):', jstNow.toLocaleString('ja-JP'));
      
      // Firebaseから本日の支出データを取得
      await loadExpensesByDate();
      
      document.getElementById('expenseModal').classList.remove('hidden');
    };
    
    // 日付変更時にデータを読み込む
    window.loadExpensesByDate = async function() {
      const selectedDate = document.getElementById('expenseDateInput').value;
      if (!selectedDate) {
        console.warn(' 日付が選択されていません');
        return;
      }
      
      currentExpenseDate = selectedDate;
      console.log('日付変更 - 選択された日付:', currentExpenseDate);
      
      try {
        const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', currentExpenseDate));
        
        if (expenseDoc.exists()) {
          const data = expenseDoc.data();
          expenseRows = data.items || [];
          console.log(' 既存の支出データを読み込み:', currentExpenseDate, '件数:', expenseRows.length);
          console.log(' データ内容:', expenseRows);
        } else {
          // 新規の場合は初期行を追加
          console.log(' 新規作成:', currentExpenseDate);
          expenseRows = [
            { storeName: '', category: '', detail: '', amount: 0 },
            { storeName: '', category: '', detail: '', amount: 0 },
            { storeName: '', category: '', detail: '', amount: 0 }
          ];
        }
      } catch (e) {
        console.error(' 支出データ読み込みエラー:', e);
        expenseRows = [
          { storeName: '', category: '', detail: '', amount: 0 },
          { storeName: '', category: '', detail: '', amount: 0 },
          { storeName: '', category: '', detail: '', amount: 0 }
        ];
      }
      
      renderExpenseTable();
    };
    
    // 支出モーダルを閉じる
    window.closeExpenseModal = function() {
      document.getElementById('expenseModal').classList.add('hidden');
    };
    
    // 支出行を追加
    window.addExpenseRow = function() {
      expenseRows.push({
        storeName: '',
        category: '',
        detail: '',
        amount: 0
      });
      renderExpenseTable();
    };
    
    // 支出行を削除
    window.deleteExpenseRow = function(index) {
      expenseRows.splice(index, 1);
      renderExpenseTable();
    };
    
    // 支出テーブルを描画
    // 勘定科目と税率のマッピング
    const categoryTaxRates = {
      '材料費': 8,
      '食費': 8,
      '接待交際費': 8,
      '租税公課': 8,
      '日用品': 10,
      '雑費・雑品': 10,
      '水光熱費': 10,
      '交通費10%': 10,
      'その他': 10
    };
    
    function renderExpenseTable() {
      const tbody = document.getElementById('expenseTableBody');
      tbody.innerHTML = '';
      
      expenseRows.forEach((row, index) => {
        const taxRate = categoryTaxRates[row.category] || 10;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding: 8px; border: 1px solid #ddd;">
            <input type="text" value="${row.storeName}" onchange="updateExpenseRow(${index}, 'storeName', this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <select onchange="updateExpenseRow(${index}, 'category', this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">選択してください</option>
              <option value="材料費" ${row.category === '材料費' ? 'selected' : ''}>材料費（8%）</option>
              <option value="日用品" ${row.category === '日用品' ? 'selected' : ''}>日用品（10%）</option>
              <option value="雑費・雑品" ${row.category === '雑費・雑品' ? 'selected' : ''}>雑費・雑品（10%）</option>
              <option value="食費" ${row.category === '食費' ? 'selected' : ''}>食費（8%）</option>
              <option value="接待交際費" ${row.category === '接待交際費' ? 'selected' : ''}>接待交際費（8%）</option>
              <option value="水光熱費" ${row.category === '水光熱費' ? 'selected' : ''}>水光熱費（10%）</option>
              <option value="租税公課" ${row.category === '租税公課' ? 'selected' : ''}>租税公課</option>
              <option value="交通費10%" ${row.category === '交通費10%' ? 'selected' : ''}>交通費（10%）</option>
              <option value="その他" ${row.category === 'その他' ? 'selected' : ''}>その他（10%）</option>
            </select>
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <input type="text" value="${row.detail}" onchange="updateExpenseRow(${index}, 'detail', this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <input type="number" value="${row.amount}" onchange="updateExpenseRow(${index}, 'amount', parseFloat(this.value) || 0)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
            <button onclick="deleteExpenseRow(${index})" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">削除</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      updateExpenseTotal();
    }
    
    // 支出行を更新
    window.updateExpenseRow = function(index, field, value) {
      expenseRows[index][field] = value;
      
      // 租税公課を選択した場合、詳細を「軽油引取税」に設定
      if (field === 'category' && value === '租税公課') {
        expenseRows[index]['detail'] = '軽油引取税';
      }
      
      updateExpenseTotal();
      renderExpenseTable(); // テーブルを再描画
    };
    
    // 支出合計を更新
    function updateExpenseTotal() {
      const total = expenseRows.reduce((sum, row) => sum + (parseFloat(row.amount) || 0), 0);
      document.getElementById('expenseTotal').textContent = total.toLocaleString();
    }
    
    // 支出を保存
    window.saveExpenses = async function() {
      try {
        console.log(' 支出を保存中 - 日付:', currentExpenseDate);
        console.log(' 保存データ:', expenseRows);
        
        // 空行を除外
        const validRows = expenseRows.filter(row => 
          row.storeName || row.category || row.detail || row.amount
        );
        
        const total = validRows.reduce((sum, row) => sum + (parseFloat(row.amount) || 0), 0);
        
        const currentStaff = document.getElementById('staffSelect')?.value || 'POS入力';
        
        await window.setDoc(window.getStoreDoc('expenses', currentExpenseDate), {
          date: currentExpenseDate,
          staff: currentStaff,
          items: validRows,
          total: total,
          updatedAt: window.Timestamp.now()
        });
        
        console.log(' 支出保存完了 - 日付:', currentExpenseDate, '件数:', validRows.length, '合計:', total);
        alert(`支出を保存しました\n日付: ${currentExpenseDate}\n件数: ${validRows.length}件\n合計: ¥${total.toLocaleString()}`);
        closeExpenseModal();
        
      } catch (e) {
        console.error(' 支出保存エラー:', e);
        alert('支出の保存に失敗しました: ' + e.message);
      }
    };
    
    // 支出をExcel形式で出力（keihi.htmlと同じ形式）
    window.exportExpensesToCSV = async function() {
      try {
        console.log(' 支出Excel出力開始');
        
        if (expenseRows.length === 0) {
          alert('出力する支出データがありません');
          return;
        }
        
        // 勘定科目と税率のマッピング
        const categoryTaxRates = {
          '材料費': 8,
          '食費': 8,
          '接待交際費': 8,
          '租税公課': 8,
          '日用品': 10,
          '雑費・雑品': 10,
          '水光熱費': 10,
          '交通費10%': 10,
          'その他': 10
        };
        
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        
        // Excelデータ作成
        const excelData = [];
        
        // ヘッダー
        excelData.push(['経費明細書', '', '', '', '']);
        excelData.push([`${year}年${month}月`, '', '', '', '']);
        excelData.push(['出力日時:', new Date().toLocaleString('ja-JP'), '', '', '']);
        excelData.push(['', '', '', '', '']);
        
        // 8%区分
        excelData.push(['【8%区分】', '', '', '', '']);
        excelData.push(['日付', '店名', '勘定科目', '詳細', '金額']);
        
        const tax8Items = expenseRows.filter(e => 
          e.category === '材料費' || e.category === '食費' || e.category === '接待交際費'
        );
        let tax8Total = 0;
        
        tax8Items.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax8Total += item.amount;
        });
        
        excelData.push(['', '', '', '8%合計:', tax8Total]);
        excelData.push(['', '', '', '', '']);
        
        // 10%区分
        excelData.push(['【10%区分】', '', '', '', '']);
        excelData.push(['日付', '店名', '勘定科目', '詳細', '金額']);
        
        const tax10Items = expenseRows.filter(e => 
          e.category === '日用品' || e.category === '雑費・雑品' || 
          e.category === '水光熱費' || e.category === 'その他'
        );
        let tax10Total = 0;
        
        tax10Items.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax10Total += item.amount;
        });
        
        excelData.push(['', '', '', '10%合計:', tax10Total]);
        excelData.push(['', '', '', '', '']);
        
        // 租税公課区分
        excelData.push(['【租税公課区分】', '', '', '', '']);
        excelData.push(['日付', '店名', '勘定科目', '詳細', '金額']);
        
        const sozeikokaItems = expenseRows.filter(e => e.category === '租税公課');
        let sozeikokaTotal = 0;
        
        sozeikokaItems.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          sozeikokaTotal += item.amount;
        });
        
        excelData.push(['', '', '', '租税公課合計:', sozeikokaTotal]);
        excelData.push(['', '', '', '', '']);
        
        // 交通費（10%）区分
        excelData.push(['【交通費（10%）区分】', '', '', '', '']);
        excelData.push(['日付', '店名', '勘定科目', '詳細', '金額']);
        
        const transport10Items = expenseRows.filter(e => e.category === '交通費10%');
        let transport10Total = 0;
        
        transport10Items.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          transport10Total += item.amount;
        });
        
        excelData.push(['', '', '', '交通費（10%）合計:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        
        // 総合計
        const grandTotal = tax8Total + tax10Total + sozeikokaTotal + transport10Total;
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', '8%合計金額:', tax8Total]);
        excelData.push(['', '', '', '10%合計金額:', tax10Total]);
        excelData.push(['', '', '', '租税公課合計金額:', sozeikokaTotal]);
        excelData.push(['', '', '', '交通費（10%）合計金額:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', '合計:', grandTotal]);
        
        // SheetJSでExcel生成
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // 列幅設定
        ws['!cols'] = [
          { wch: 10 },  // 日付
          { wch: 15 },  // 店名
          { wch: 15 },  // 勘定科目
          { wch: 25 },  // 詳細
          { wch: 12 }   // 金額
        ];
        
        // 罫線とスタイル設定
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        for (let R = range.s.r; R <= range.e.r; R++) {
          for (let C = range.s.c; C <= range.e.c; C++) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            
            if (!ws[cellAddress]) {
              ws[cellAddress] = { t: 's', v: '' };
            }
            
            if (!ws[cellAddress].s) {
              ws[cellAddress].s = {};
            }
            
            // 罫線
            ws[cellAddress].s.border = {
              top: { style: 'thin', color: { rgb: '000000' } },
              bottom: { style: 'thin', color: { rgb: '000000' } },
              left: { style: 'thin', color: { rgb: '000000' } },
              right: { style: 'thin', color: { rgb: '000000' } }
            };
            
            // ヘッダー行のスタイル
            if (R === 0 || (excelData[R] && excelData[R][0] && excelData[R][0].includes('【'))) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'D3D3D3' }
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
            }
            
            // 合計行のスタイル（8%、10%、交通費の各区分）
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%合計:' || excelData[R][3] === '10%合計:' || 
                 excelData[R][3] === '租税公課合計:' || excelData[R][3] === '交通費（10%）合計:')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFE599' }  // 薄い黄色
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
              // 金額列は右寄せ
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // 最終合計行のスタイル（8%合計金額、10%合計金額、交通費合計金額、合計）
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%合計金額:' || excelData[R][3] === '10%合計金額:' || 
                 excelData[R][3] === '租税公課合計金額:' || excelData[R][3] === '交通費（10%）合計金額:' ||
                 excelData[R][3] === '合計:')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFC7CE' }  // 薄いピンク
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
              // 金額列は右寄せ
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // 「合計:」行は特に強調
            if (excelData[R] && excelData[R][3] === '合計:') {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFB6C1' }  // 濃いピンク
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 14,
                color: { rgb: 'FF0000' }  // 赤文字
              };
            }
          }
        }
        
        XLSX.utils.book_append_sheet(wb, ws, '経費明細');
        
        const fileName = `経費明細_${year}年${month}月.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        console.log(' 経費Excel出力完了:', fileName);
        alert(`経費を出力しました！\n${fileName}`);
        
      } catch (e) {
        console.error(' 経費出力エラー:', e);
        alert('経費の出力に失敗しました: ' + e.message);
      }
    };
    
    // ===== 月次経費出力機能（1日からの集計） =====
    window.exportMonthlyExpenses = async function(year = null, month = null) {
      try {
        console.log(' 月次経費出力開始');
        
        // デフォルト値を設定（引数がない場合は当月）
        if (!year || !month) {
          const now = new Date();
          const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
          
          // 現在の年月を取得（午前3時基準）
          const todayStart = new Date(jstNow);
          todayStart.setHours(3, 0, 0, 0);
          if (jstNow.getHours() < 3) {
            todayStart.setDate(todayStart.getDate() - 1);
          }
          
          year = todayStart.getFullYear();
          month = todayStart.getMonth() + 1;
        }
        
        console.log(`経費出力: ${year}年${month}月`);
        
        // 月の全データを取得
        const expensesSnapshot = await window.getDocs(window.getStoreCollection('expenses'));
        
        const monthlyExpenses = [];
        expensesSnapshot.forEach(doc => {
          const data = doc.data();
          const date = data.date;
          
          // 現在の月のデータのみ
          if (date && date.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
            if (data.items && Array.isArray(data.items)) {
              data.items.forEach(item => {
                monthlyExpenses.push({
                  date: date,
                  staff: data.staff || '不明',
                  storeName: item.storeName,
                  category: item.category,
                  detail: item.detail,
                  amount: item.amount
                });
              });
            }
          }
        });
        
        // 日付順にソート
        monthlyExpenses.sort((a, b) => a.date.localeCompare(b.date));
        
        console.log('取得したデータ:', monthlyExpenses.length, '件');
        
        if (monthlyExpenses.length === 0) {
          alert('出力する経費データがありません');
          return;
        }
        
        // Excelデータ作成
        const excelData = [];
        
        // ヘッダー
        excelData.push(['経費明細書', '', '', '', '', '']);
        excelData.push([`${year}年${month}月`, '', '', '', '', '']);
        excelData.push(['出力日時:', new Date().toLocaleString('ja-JP'), '', '', '', '']);
        excelData.push(['', '', '', '', '', '']);
        
        // 8%区分
        excelData.push(['【8%区分】', '', '', '', '', '']);
        excelData.push(['日付', '店名', '勘定科目', '詳細', '金額']);
        
        const tax8Items = monthlyExpenses.filter(e => 
          e.category === '材料費' || e.category === '食費' || e.category === '接待交際費'
        );
        let tax8Total = 0;
        
        tax8Items.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax8Total += item.amount;
        });
        
        excelData.push(['', '', '', '8%合計:', tax8Total]);
        excelData.push(['', '', '', '', '']);
        
        // 10%区分
        excelData.push(['【10%区分】', '', '', '', '', '']);
        excelData.push(['日付', '店名', '勘定科目', '詳細', '金額']);
        
        const tax10Items = monthlyExpenses.filter(e => 
          e.category === '日用品' || e.category === '雑費・雑品' || 
          e.category === '水光熱費' || e.category === 'その他'
        );
        let tax10Total = 0;
        
        tax10Items.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax10Total += item.amount;
        });
        
        excelData.push(['', '', '', '10%合計:', tax10Total]);
        excelData.push(['', '', '', '', '']);
        
        // 租税公課区分
        excelData.push(['【租税公課区分】', '', '', '', '', '']);
        excelData.push(['日付', '店名', '勘定科目', '詳細', '金額']);
        
        const sozeikokaItems = monthlyExpenses.filter(e => e.category === '租税公課');
        let sozeikokaTotal = 0;
        
        sozeikokaItems.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          sozeikokaTotal += item.amount;
        });
        
        excelData.push(['', '', '', '租税公課合計:', sozeikokaTotal]);
        excelData.push(['', '', '', '', '']);
        
        // 交通費（10%）区分
        excelData.push(['【交通費（10%）区分】', '', '', '', '', '']);
        excelData.push(['日付', '店名', '勘定科目', '詳細', '金額']);
        
        const transport10Items = monthlyExpenses.filter(e => e.category === '交通費10%');
        let transport10Total = 0;
        
        transport10Items.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          transport10Total += item.amount;
        });
        
        excelData.push(['', '', '', '交通費（10%）合計:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        
        // 総合計
        const grandTotal = tax8Total + tax10Total + sozeikokaTotal + transport10Total;
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', '8%合計金額:', tax8Total]);
        excelData.push(['', '', '', '10%合計金額:', tax10Total]);
        excelData.push(['', '', '', '租税公課合計金額:', sozeikokaTotal]);
        excelData.push(['', '', '', '交通費（10%）合計金額:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', '合計:', grandTotal]);
        
        // SheetJSでExcel生成
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // 列幅設定
        ws['!cols'] = [
          { wch: 10 },  // 日付
          { wch: 15 },  // 店名
          { wch: 15 },  // 勘定科目
          { wch: 25 },  // 詳細
          { wch: 12 }   // 金額
        ];
        
        // 罫線とスタイル設定
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        for (let R = range.s.r; R <= range.e.r; ++R) {
          for (let C = range.s.c; C <= range.e.c; ++C) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            
            if (!ws[cellAddress]) continue;
            
            // 基本の罫線
            ws[cellAddress].s = ws[cellAddress].s || {};
            ws[cellAddress].s.border = {
              top: { style: 'thin', color: { rgb: '000000' } },
              bottom: { style: 'thin', color: { rgb: '000000' } },
              left: { style: 'thin', color: { rgb: '000000' } },
              right: { style: 'thin', color: { rgb: '000000' } }
            };
            
            // ヘッダー行のスタイル
            if (R === 0) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'ADD8E6' }  // 薄い青
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 16
              };
            }
            
            // 区分タイトル行のスタイル（【8%区分】など）
            if (excelData[R] && excelData[R][0] && excelData[R][0].startsWith('【')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFFF99' }  // 薄い黄色
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
            }
            
            // 列ヘッダー行のスタイル（日付、店名、勘定科目、詳細、金額）
            if (excelData[R] && excelData[R][0] === '日付') {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'D3D3D3' }  // 灰色
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
            }
            
            // 合計行のスタイル（8%合計、10%合計など）
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%合計:' || excelData[R][3] === '10%合計:' ||
                 excelData[R][3] === '租税公課合計:' || excelData[R][3] === '交通費（10%）合計:')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFE4B5' }  // 薄いオレンジ
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
              // 金額列は右寄せ
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // 最終合計行のスタイル（8%合計金額、10%合計金額、交通費合計金額、合計）
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%合計金額:' || excelData[R][3] === '10%合計金額:' || 
                 excelData[R][3] === '租税公課合計金額:' || excelData[R][3] === '交通費（10%）合計金額:' ||
                 excelData[R][3] === '合計:')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFC7CE' }  // 薄いピンク
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
              // 金額列は右寄せ
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // 「合計:」行は特に強調
            if (excelData[R] && excelData[R][3] === '合計:') {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFB6C1' }  // 濃いピンク
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 14,
                color: { rgb: 'FF0000' }  // 赤文字
              };
            }
          }
        }
        
        XLSX.utils.book_append_sheet(wb, ws, '経費明細');
        
        const fileName = `経費明細_${year}年${month}月_月次集計.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        console.log(' 月次経費Excel出力完了:', fileName);
        alert(`月次経費を出力しました！\n${fileName}\n\n集計期間: ${year}年${month}月1日〜現在`);
        
      } catch (e) {
        console.error(' 月次経費出力エラー:', e);
        alert('月次経費の出力に失敗しました: ' + e.message);
      }
    };
    
    // 経費出力モーダルを表示
    window.showExpenseExportModal = function() {
      // 年の選択肢を生成（2020年から現在の年まで）
      const currentYear = new Date().getFullYear();
      const yearSelect = document.getElementById('expenseExportYear');
      yearSelect.innerHTML = '';
      
      for (let year = currentYear; year >= 2020; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + '年';
        yearSelect.appendChild(option);
      }
      
      // 現在の月を選択状態にする
      const currentMonth = new Date().getMonth() + 1;
      document.getElementById('expenseExportMonth').value = currentMonth;
      
      // モーダルを表示
      document.getElementById('expenseExportModal').style.display = 'flex';
    };
    
    // 経費出力モーダルを閉じる
    window.closeExpenseExportModal = function() {
      document.getElementById('expenseExportModal').style.display = 'none';
    };
    
    // 経費出力を実行
    window.confirmExpenseExport = async function() {
      const year = parseInt(document.getElementById('expenseExportYear').value);
      const month = parseInt(document.getElementById('expenseExportMonth').value);
      
      closeExpenseExportModal();
      await exportMonthlyExpenses(year, month);
    };
    
    // ===== 日計表生成機能 =====
    window.generateDailyReport = async function() {
      try {
        console.log(' 日計表生成開始');
        
        // 当月の全ての日次売上データを取得
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        
        // 月の最初の日と最後の日を計算
        const firstDay = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0);
        const daysInMonth = lastDay.getDate();
        
        console.log(`${year}年${month}月のデータを取得中...`);
        
        // Firestoreから当月のデータを取得
        const dailySalesSnapshot = await window.getDocs(window.getStoreCollection('dailySales'));
        
        // 日付ごとにデータを整理
        const salesByDate = {};
        dailySalesSnapshot.forEach(doc => {
          const data = doc.data();
          const date = data.date;
          
          // 当月のデータのみ
          if (date && date.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
            salesByDate[date] = data;
          }
        });
        
        console.log('取得したデータ:', salesByDate);
        
        // Excelデータを作成
        const excelData = [];
        
        // ヘッダー行1（タイトル）
        excelData.push(['', '売上日計表', '', '', '', '', '', '', '', '', '粉もん屋 八  下赤塚店', '', '', '']);
        excelData.push(['', '', '', '', '', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', `${year}-${String(month).padStart(2, '0')}-01`, '', '', '', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', '', '', '', '', '', '', '', '', '', '', '', '', '']);
        
        // ヘッダー行2（列名）
        excelData.push(['', '日', '曜日', '伝票数', '現金', 'カード', '電子マネー', '売上合計', '人件費', '人件費%', '支払い', '純売上', 'TOTAL粗利', '天気']);
        
        // 曜日配列
        const weekDays = ['日', '月', '火', '水', '木', '金', '土'];
        
        // 累計粗利
        let totalGrossProfit = 0;
        
        // 合計用の変数
        let sumCustomerCount = 0;
        let sumCashSales = 0;
        let sumCreditSales = 0;
        let sumEmoneSales = 0;
        let sumTotalSales = 0;
        let sumLaborCost = 0;
        let sumPayment = 0;
        let sumNetSales = 0;
        
        // 各日のデータ
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const date = new Date(year, month - 1, day);
          const weekDay = weekDays[date.getDay()];
          
          const data = salesByDate[dateStr];
          
          if (data) {
            // データがある場合
            const customerCount = data.customerCount || 0;
            const cashSales = data.cashSales || 0;
            const creditSales = data.creditSales || 0;
            const emoneSales = data.emoneSales || 0;
            const totalSales = cashSales + creditSales + emoneSales;
            
            // 人件費をkintai_attendanceから取得
            let laborCost = 0;
            try {
              const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
              attendanceSnapshot.forEach(docData => {
                const attData = docData.data();
                if (attData.date === dateStr) {
                  // 既に計算済みの総賃金がある場合はそれを使用
                  if (attData.totalWage && attData.totalWage > 0) {
                    laborCost += attData.totalWage;
                  } else if (attData.clockIn && attData.clockOut) {
                    // 総賃金がない場合は計算する
                    const clockIn = new Date(`${dateStr} ${attData.clockIn}`);
                    const clockOut = new Date(`${dateStr} ${attData.clockOut}`);
                    let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                    
                    if (attData.breakStart1 && attData.breakEnd1) {
                      const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                      const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                      workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                    }
                    if (attData.breakStart2 && attData.breakEnd2) {
                      const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                      const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                      workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                    }
                    
                    const hourlyRate = attData.hourlyRate || 1150;
                    
                    // 割増賃金の計算
                    let totalWage = 0;
                    const isHoliday = attData.isHoliday || false;
                    
                    // 時間ごとに割増率を計算
                    let currentTime = new Date(clockIn);
                    const endTime = new Date(clockOut);
                    
                    while (currentTime < endTime) {
                      const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                      const segmentEnd = nextHour > endTime ? endTime : nextHour;
                      
                      // 休憩時間を除外
                      let isBreak = false;
                      if (attData.breakStart1 && attData.breakEnd1) {
                        const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                        const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                        if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                          isBreak = true;
                        }
                      }
                      if (attData.breakStart2 && attData.breakEnd2) {
                        const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                        const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                        if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                          isBreak = true;
                        }
                      }
                      
                      if (!isBreak) {
                        const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                        const hour = currentTime.getHours();
                        
                        let rate = 1.0;
                        if (isHoliday) {
                          // 休日出勤: 基本35%増
                          rate = 1.35;
                          // 22時～5時は深夜割増25%を追加（合計60%増）
                          if (hour >= 22 || hour < 5) {
                            rate = 1.60;
                          }
                        } else {
                          // 平日: 22時～5時は深夜割増25%
                          if (hour >= 22 || hour < 5) {
                            rate = 1.25;
                          }
                        }
                        
                        totalWage += segmentHours * hourlyRate * rate;
                      }
                      
                      currentTime = segmentEnd;
                    }
                    
                    laborCost += totalWage;
                  }
                }
              });
            } catch (e) {
              console.error('人件費取得エラー:', e);
            }
            
            const laborCostPercent = totalSales > 0 ? Math.round(laborCost / totalSales * 100) : 0;
            
            // 支出をexpensesから取得
            let payment = 0;
            try {
              const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
              if (expenseDoc.exists()) {
                payment = expenseDoc.data().total || 0;
              }
            } catch (e) {
              console.error('支出取得エラー:', e);
            }
            
            // 純売上
            const netSales = totalSales - laborCost - payment;
            
            // 累計粗利
            totalGrossProfit += netSales;
            
            // 合計に加算
            sumCustomerCount += customerCount;
            sumCashSales += cashSales;
            sumCreditSales += creditSales;
            sumEmoneSales += emoneSales;
            sumTotalSales += totalSales;
            sumLaborCost += laborCost;
            sumPayment += payment;
            sumNetSales += netSales;
            
            excelData.push([
              '',
              date,
              weekDay,
              customerCount,
              cashSales,
              creditSales,
              emoneSales,
              totalSales,
              Math.round(laborCost),
              laborCostPercent + '%',  // %記号を付ける
              payment,
              Math.round(netSales),
              Math.round(totalGrossProfit),
              '' // 天気は手動入力
            ]);
          } else {
            // データがない場合（空行）
            excelData.push([
              '',
              date,
              weekDay,
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              ''
            ]);
          }
        }
        
        // 合計行を追加
        const avgLaborCostPercent = sumTotalSales > 0 ? Math.round(sumLaborCost / sumTotalSales * 100) : 0;
        excelData.push([
          '',
          '',
          '合計',
          sumCustomerCount,
          sumCashSales,
          sumCreditSales,
          sumEmoneSales,
          sumTotalSales,
          Math.round(sumLaborCost),
          avgLaborCostPercent + '%',
          sumPayment,
          Math.round(sumNetSales),
          '', // TOTAL粗利は最後の行の値
          ''
        ]);
        
        console.log('Excelデータ作成完了:', excelData.length, '行');
        
        // SheetJSでExcelファイルを生成
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // 列幅を設定
        ws['!cols'] = [
          { wch: 3 },  // A列
          { wch: 12 }, // B列（日付）
          { wch: 5 },  // C列（曜日）
          { wch: 8 },  // D列（伝票数）
          { wch: 10 }, // E列（現金）
          { wch: 10 }, // F列（カード）
          { wch: 10 }, // G列（paypay）
          { wch: 10 }, // H列（売上合計）
          { wch: 10 }, // I列（人件費）
          { wch: 10 }, // J列（人件費%）
          { wch: 10 }, // K列（支払い）
          { wch: 10 }, // L列（純売上）
          { wch: 12 }, // M列（TOTAL粗利）
          { wch: 10 }  // N列（天気）
        ];
        
        // 全セルに罫線とスタイルを設定
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        for (let R = range.s.r; R <= range.e.r; R++) {
          for (let C = range.s.c; C <= range.e.c; C++) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            
            // セルが存在しない場合は作成
            if (!ws[cellAddress]) {
              ws[cellAddress] = { t: 's', v: '' };
            }
            
            // スタイルオブジェクトを初期化
            if (!ws[cellAddress].s) {
              ws[cellAddress].s = {};
            }
            
            // 罫線を設定
            ws[cellAddress].s.border = {
              top: { style: 'thin', color: { rgb: '000000' } },
              bottom: { style: 'thin', color: { rgb: '000000' } },
              left: { style: 'thin', color: { rgb: '000000' } },
              right: { style: 'thin', color: { rgb: '000000' } }
            };
            
            // ヘッダー行（5行目 = R=4）のスタイル
            if (R === 4) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'D3D3D3' }
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
              ws[cellAddress].s.alignment = {
                horizontal: 'center',
                vertical: 'center'
              };
            }
            
            // 合計行（最終行）のスタイル
            if (R === range.e.r) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFFFCC' }
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
            }
            
            // 数値セルの右寄せ
            if (C >= 3 && C <= 12 && R >= 5) {
              if (!ws[cellAddress].s.alignment) {
                ws[cellAddress].s.alignment = {};
              }
              ws[cellAddress].s.alignment.horizontal = 'right';
            }
          }
        }
        
        XLSX.utils.book_append_sheet(wb, ws, '売上日計表');
        
        // ファイルをダウンロード
        const fileName = `日計表${year}年${month}月.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        console.log(' 日計表出力完了:', fileName);
        alert(`日計表を出力しました！\n${fileName}`);
        
      } catch (e) {
        console.error(' 日計表生成エラー:', e);
        alert('日計表の生成に失敗しました: ' + e.message);
      }
    };
    
    // 手動カートの表示更新
    // iframeから商品を追加する関数
    window.addItemFromIframe = function(item) {
      console.log(' iframeから商品追加:', item);
      
      // 商品のtaxRateとfoodTypeを取得
      let taxRate = item.taxRate;
      let foodType = item.foodType || 'food';  // デフォルトは食材
      
      // 包材カテゴリの商品は強制的に10%、食材以外に設定
      if (item.category === '包材') {
        taxRate = 10;
        foodType = 'non-food';
        console.log(' 包材カテゴリ: 税率を10%、食材以外に強制設定');
      }
      
      // taxRateが未設定の場合、foodTypeに基づいて設定
      if (taxRate === undefined || taxRate === null) {
        // 食材以外は10%、食材は8%（ただし即会計では商品のデフォルト税率を使うべき）
        // ここでは商品データに税率が設定されていない場合のフォールバック
        taxRate = (foodType === 'non-food') ? 10 : 8;
        console.log(`taxRate未設定 → foodType(${foodType})に基づき${taxRate}%を設定`);
      }
      
      // taxTypeの自動判定: menu.htmlから渡されない場合はデフォルト値を設定
      // もしitem.priceIncludeTaxがtrueなら内税、falseなら外税
      let taxType = item.taxType;
      if (!taxType) {
        // taxTypeが指定されていない場合、priceIncludeTaxフィールドで判定
        if (item.priceIncludeTax === false) {
          taxType = 'exclusive';  // 外税
          console.log(' 外税と判定: priceIncludeTax =', item.priceIncludeTax);
        } else {
          taxType = 'inclusive';  // 内税（デフォルト）
          console.log(' 内税と判定（デフォルト）');
        }
      }
      
      // manualCartに商品を追加
      const cartItem = {
        id: item.id,
        name: item.name,
        price: item.price,
        category: item.category,  // カテゴリを保存
        taxRate: taxRate,  // 確実に設定済み
        foodType: foodType,  // 食材区分を保存
        taxType: taxType,  // 外税/内税タイプ
        toppings: item.toppings || '標準トッピング',
        toppingPrice: item.toppingPrice || 0,
        toppingsData: item.toppingsData || [],
        quantity: item.quantity || 1  // iframeから渡された数量を使用
      };
      
      console.log(' カートアイテム:', cartItem);
      
      // 同じ商品が既にある場合は数量を増やす
      const existingIndex = manualCart.findIndex(i => 
        i.id === item.id && 
        i.toppings === cartItem.toppings
      );
      
      if (existingIndex >= 0) {
        manualCart[existingIndex].quantity += cartItem.quantity;  // 渡された数量分増やす
        console.log(' 既存商品の数量を増やしました:', manualCart[existingIndex]);
      } else {
        manualCart.push(cartItem);
        console.log(' 新規商品を追加しました:', cartItem);
      }
      
      updateManualCart();
    };
    
    function updateManualCart() {
      const container = document.getElementById('selectedItems');
      const submitBtn = document.getElementById('manualSubmitBtn');
      const directPaymentBtn = document.getElementById('directPaymentBtn');  // 即会計ボタン
      const manualTable = document.getElementById('manualTable');
      
      if (manualCart.length === 0) {
        container.innerHTML = '<div class="empty-state">商品を選択してください</div>';
        submitBtn.disabled = true;
        if (directPaymentBtn) directPaymentBtn.disabled = true;  // ボタン無効化
        document.getElementById('manualTotal').textContent = '¥0';
        return;
      }
      
      container.innerHTML = '';
      let total = 0;
      
      manualCart.forEach((item, index) => {
        // 外税の場合は税込価格を計算
        let itemBasePrice = item.price;
        if (item.taxType === 'exclusive') {
          const taxRate = item.taxRate || 10;
          itemBasePrice = Math.floor(item.price * (1 + taxRate / 100));
        }
        
        const itemWithTopping = itemBasePrice + (item.toppingPrice || 0);
        const itemTotal = itemWithTopping * item.quantity;
        total += itemTotal;
        
        // トッピングを改行で表示
        let toppingsHtml = '';
        if (item.toppingDetails && item.toppingDetails.length > 0) {
          // POS画面からの新規注文
          const groupedBySet = {};
          item.toppingDetails.forEach(detail => {
            if (!groupedBySet[detail.setName]) {
              groupedBySet[detail.setName] = [];
            }
            groupedBySet[detail.setName].push(detail.optionName);
          });
          
          toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
            return `
              <div style="font-size: 12px; color: #666; font-weight: bold; margin-top: 3px; padding-left: 5px;">${setName}</div>
              ${options.map(opt => `<div style="font-size: 12px; color: #666; padding-left: 15px;">　・${opt}</div>`).join('')}
            `;
          }).join('');
        } else if (item.toppingsData && item.toppingsData.length > 0) {
          // menu.htmlからの注文
          const groupedBySet = {};
          item.toppingsData.forEach(topping => {
            const setName = topping.setName || 'トッピング';
            if (!groupedBySet[setName]) {
              groupedBySet[setName] = [];
            }
            groupedBySet[setName].push(topping.name);
          });
          
          toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
            return `
              <div style="font-size: 12px; color: #666; font-weight: bold; margin-top: 3px; padding-left: 5px;">${setName}</div>
              ${options.map(opt => `<div style="font-size: 12px; color: #666; padding-left: 15px;">　・${opt}</div>`).join('')}
            `;
          }).join('');
        } else if (item.toppings && item.toppings !== 'なし' && item.toppings !== '標準トッピング') {
          // 古い形式
          const toppingList = item.toppings.split(', ');
          toppingsHtml = toppingList.map(t => `<div style="font-size: 12px; color: #666; padding-left: 10px;">　${t}</div>`).join('');
        }
        
        const div = document.createElement('div');
        div.className = 'selected-item-detailed';
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <div style="font-weight: bold;">${item.name} ×${item.quantity}</div>
            <div>¥${itemBasePrice.toLocaleString()}</div>
          </div>
          ${toppingsHtml}
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 5px; border-top: 1px dashed #ddd;">
            <div style="display: flex; gap: 5px;">
              <input type="number" class="quantity-input" min="1" value="${item.quantity}" 
                     onchange="updateQuantity(${index}, this.value)">
              <button class="remove-btn" onclick="removeFromManualCart(${index})">削除</button>
            </div>
            <div style="font-weight: bold; color: #667eea;">¥${itemWithTopping.toLocaleString()} × ${item.quantity} = ¥${itemTotal.toLocaleString()}</div>
          </div>
        `;
        container.appendChild(div);
      });
      
      document.getElementById('manualTotal').textContent = `¥${total.toLocaleString()}`;
      // 商品があればボタン有効（テーブル番号は後で選択可能）
      submitBtn.disabled = manualCart.length === 0;
      
      // 即会計ボタンはテーブル選択不要なので、カートに商品があれば有効
      if (directPaymentBtn) {
        directPaymentBtn.disabled = manualCart.length === 0;
      }
    }
    
    // カート内アイテムを修正
    window.editCartItem = function(index) {
      const item = manualCart[index];
      
      // 現在のトッピング情報を保持
      currentSelectingItem = { ...item };
      currentSelectingItem.editIndex = index;
      
      // 現在選択されているトッピングを復元
      selectedToppings = [];
      if (item.toppings && item.toppings !== 'なし') {
        const toppingNames = item.toppings.split(', ');
        toppingNames.forEach(name => {
          const topping = toppingsData.find(t => t.name === name);
          if (topping) {
            selectedToppings.push(topping);
          }
        });
      }
      
      // トッピングモーダルを表示
      showToppingModalForEdit(item, index);
    };
    
    // 修正用トッピングモーダル（元の選択モーダルと同じロジックを使用）
    function showToppingModalForEdit(item, index) {
      document.getElementById('toppingModalItemName').textContent = item.name + ' (修正)';
      const list = document.getElementById('toppingsList');
      list.innerHTML = '';
      
      // toppingsIdからトッピングIDのリストを取得
      let allowedToppingIds = [];
      if (item.toppingsId && typeof item.toppingsId === 'string' && item.toppingsId.trim() !== '') {
        allowedToppingIds = item.toppingsId.split(',').map(id => id.trim());
      }
      
      console.log('修正モーダル - allowedToppingIds:', allowedToppingIds);
      console.log('修正モーダル - toppingsData件数:', toppingsData.length);
      
      // toppingsIdが空の場合は、トッピングなし商品として扱う
      if (allowedToppingIds.length === 0) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">この商品にはトッピングがありません<br><small>商品管理画面でトッピングを設定してください</small></div>';
        document.getElementById('toppingModal').classList.remove('hidden');
        return;
      }
      
      // 「なし」オプション
      const noneDiv = document.createElement('div');
      noneDiv.className = 'topping-item';
      noneDiv.style.cursor = 'pointer';
      noneDiv.innerHTML = `
        <input type="checkbox" id="topping-none" style="pointer-events: none;">
        <div class="topping-item-info">
          <span class="topping-item-name">標準トッピング</span>
          <span class="topping-item-price">¥0</span>
        </div>
      `;
      
      noneDiv.onclick = () => {
        const checkbox = document.getElementById('topping-none');
        checkbox.checked = !checkbox.checked;
        selectNoneTopping(checkbox);
      };
      
      list.appendChild(noneDiv);
      
      toppingsData.forEach(topping => {
        // allowedToppingIdsに含まれている場合のみ表示
        if (allowedToppingIds.includes(topping.id)) {
          const isSelected = selectedToppings.some(t => t.id === topping.id);
          const div = document.createElement('div');
          div.className = 'topping-item';
          div.style.cursor = 'pointer';
          div.innerHTML = `
            <input type="checkbox" id="topping-${topping.id}" value="${topping.id}" 
                   style="pointer-events: none;" ${isSelected ? 'checked' : ''}>
            <div class="topping-item-info">
              <span class="topping-item-name">${topping.name}</span>
              <span class="topping-item-price">+¥${topping.price.toLocaleString()}</span>
            </div>
          `;
          
          div.onclick = () => {
            const checkbox = document.getElementById(`topping-${topping.id}`);
            checkbox.checked = !checkbox.checked;
            selectTopping(checkbox);
          };
          
          list.appendChild(div);
        }
      });
      
      // トッピングが選択されていない場合は「なし」を選択
      if (selectedToppings.length === 0) {
        document.getElementById('topping-none').checked = true;
      }
      
      document.getElementById('toppingModal').classList.remove('hidden');
    }
    
    // 数量更新
    window.updateQuantity = function(index, value) {
      const qty = parseInt(value) || 1;
      manualCart[index].quantity = Math.max(1, qty);
      updateManualCart();
    };
    
    // カートから削除
    window.removeFromManualCart = function(index) {
      const item = manualCart[index];
      const checkbox = document.getElementById(`menu-${item.id}`);
      if (checkbox) checkbox.checked = false;
      
      manualCart.splice(index, 1);
      updateManualCart();
    };
    
    // 即会計関数（テーブル選択不要、Firebaseに保存しない）
    window.directPayment = async function() {
      if (manualCart.length === 0) {
        alert('商品を選択してください');
        return;
      }
      
      // 即会計モードを有効化
      isDirectPaymentMode = true;
      console.log('即会計モード: ON');
      
      try {
        console.log('即会計モード起動');
        console.log('カート内容:', manualCart);
        
        // カートの合計金額を計算（外税対応）
        let totalAmount = 0;
        manualCart.forEach(item => {
          let itemPrice = item.price;
          // 外税の場合は税込価格を計算
          if (item.taxType === 'exclusive') {
            const taxRate = item.taxRate || 10;
            itemPrice = Math.floor(item.price * (1 + taxRate / 100));
            console.log(`  外税商品: ${item.name}, 本体${item.price}円 → 税込${itemPrice}円`);
          }
          const itemTotal = (itemPrice + (item.toppingPrice || 0)) * item.quantity;
          totalAmount += itemTotal;
        });
        
        console.log(' 合計金額（外税対応）:', totalAmount);
        
        // 注文番号を生成
        const now = new Date();
        const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        
        const todayStart = new Date(jstNow);
        todayStart.setHours(1, 0, 0, 0);
        if (jstNow < todayStart) {
          todayStart.setDate(todayStart.getDate() - 1);
        }
        
        const ordersSnapshot = await window.getDocs(window.getStoreCollection('orders'));
        let maxOrderNumber = 618;
        let hasActiveOrders = false;
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          
          if (!data.deleted) {
            hasActiveOrders = true;
            
            const orderDate = data.timestamp.toDate();
            const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
            
            if (jstOrderDate >= todayStart && data.orderNumber > maxOrderNumber) {
              maxOrderNumber = data.orderNumber;
            }
          }
        });
        
        const orderNumber = hasActiveOrders ? (maxOrderNumber + 1) : 619;
        
        console.log('注文番号生成:', {
          hasActiveOrders,
          maxOrderNumber,
          nextOrderNumber: orderNumber
        });
        
        const deleteAt = new Date(now.getTime() + 10 * 60 * 1000);
        
        // Firebaseに即会計注文を保存
        const orderData = {
          orderNumber: orderNumber,
          tableNumber: '即会計',
          items: manualCart.map(item => ({
            id: item.id,
            name: item.name,
            price: item.price,
            taxRate: item.taxRate,  // undefinedの場合もそのまま保存
            taxType: item.taxType || 'inclusive',  // taxTypeを保存
            foodType: item.foodType || 'food',  // foodTypeを保存
            toppings: item.toppings,
            toppingsData: item.toppingsData,
            toppingPrice: item.toppingPrice || 0,
            quantity: item.quantity
          })),
          totalAmount: totalAmount,
          timestamp: window.Timestamp.now(),
          deleteAt: window.Timestamp.fromDate(deleteAt),
          status: 'pending',
          manualEntry: true,
          directPayment: true  // 即会計フラグ
        };
        
        const docRef = await window.addDoc(window.getStoreCollection('orders'), orderData);
        console.log(' 即会計注文をFirebaseに保存:', docRef.id);
        
        // currentOrdersに追加
        currentOrders = [{
          id: docRef.id,
          ...orderData
        }];
        
        console.log('注文データ:', currentOrders[0]);
        
        // 在庫を減らす（即会計時）
        console.log(' 即会計: 在庫減少処理を実行');
        await decreaseInventoryFromMenuSettings(manualCart);
        
        // 会計モーダルを表示
        document.getElementById('discountAmount').value = '0';
        buildTaxRateSelectionList();
        updatePaymentTotal();
        document.getElementById('paymentModal').classList.remove('hidden');
        selectedPaymentMethod = null;
        document.querySelectorAll('.payment-method-btn').forEach(btn => {
          btn.classList.remove('selected');
        });
        document.getElementById('cashInputSection').classList.add('hidden');
      } catch (error) {
        console.error(' 即会計エラー:', error);
        alert('即会計の処理に失敗しました: ' + error.message);
      }
      document.getElementById('completePaymentBtn').disabled = true;
    };
    
    // 手動注文を送信
    window.submitManualOrder = async function() {
      const tableNumber = document.getElementById('manualTable').value;
      
      if (!tableNumber || manualCart.length === 0) {
        alert('テーブル番号と商品を選択してください');
        return;
      }
      
      try {
        const now = new Date();
        const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        
        const todayStart = new Date(jstNow);
        todayStart.setHours(1, 0, 0, 0);
        if (jstNow < todayStart) {
          todayStart.setDate(todayStart.getDate() - 1);
        }
        
        const ordersSnapshot = await window.getDocs(window.getStoreCollection('orders'));
        let maxOrderNumber = 618;
        let hasActiveOrders = false;
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          
          // 削除されていない注文があるかチェック
          if (!data.deleted) {
            hasActiveOrders = true;
            
            // 削除されていない注文のみから最大番号を取得
            const orderDate = data.timestamp.toDate();
            const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
            
            if (jstOrderDate >= todayStart && data.orderNumber > maxOrderNumber) {
              maxOrderNumber = data.orderNumber;
            }
          }
        });
        
        // 削除されていない注文が0件なら619番から開始
        const orderNumber = hasActiveOrders ? (maxOrderNumber + 1) : 619;
        
        console.log('注文番号生成:', {
          hasActiveOrders,
          maxOrderNumber,
          nextOrderNumber: orderNumber
        });
        
        let totalAmount = 0;
        manualCart.forEach(item => {
          // 外税の場合は税込価格を計算
          let itemPrice = item.price;
          if (item.taxType === 'exclusive') {
            const taxRate = item.taxRate || 10;
            itemPrice = Math.floor(item.price * (1 + taxRate / 100));
          }
          totalAmount += (itemPrice + (item.toppingPrice || 0)) * item.quantity;
        });
        
        const deleteAt = new Date(now.getTime() + 10 * 60 * 1000);
        
        const orderData = {
          orderNumber: orderNumber,
          timestamp: window.Timestamp.fromDate(now),
          tableNumber: tableNumber,
          items: manualCart.map(item => ({
            id: item.id,
            name: item.name,
            price: item.price,
            category: item.category,
            taxRate: item.taxRate,
            taxType: item.taxType || 'inclusive',  // 外税/内税タイプを明示的に保存
            foodType: item.foodType || 'food',  // foodTypeを保存
            toppings: item.toppings,
            toppingPrice: item.toppingPrice || 0,
            toppingsData: item.toppingsData || [],
            toppingDetails: item.toppingDetails || [],
            quantity: item.quantity
          })),
          totalAmount: totalAmount,
          status: 'pending',
          deleteAt: window.Timestamp.fromDate(deleteAt),
          cancelledAt: null,
          completedAt: null,
          paidAt: null,
          notifiedComplete: false,
          notifiedCancel: false,
          notifiedPaid: false,
          manualEntry: true
        };
        
        const docRef = await window.addDoc(window.getStoreCollection('orders'), orderData);
        
        await window.updateDoc(docRef, {
          orderId: docRef.id
        });
        
        manualCart = [];
        document.getElementById('manualTable').value = '';
        document.querySelectorAll('#menuItemsList input[type="checkbox"]').forEach(cb => cb.checked = false);
        updateManualCart();
        
      } catch (e) {
        console.error('注文エラー:', e);
        alert('注文の追加に失敗しました: ' + e.message);
      }
    };
    
    // 即会計クイックボタン - 商品がある場合は送信してから開く
    window.quickCheckout = async function() {
      // 手入力レジに商品がある場合
      if (manualCart.length > 0) {
        // 即会計テーブルに送信
        try {
          const now = new Date();
          const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
          
          const todayStart = new Date(jstNow);
          todayStart.setHours(1, 0, 0, 0);
          if (jstNow < todayStart) {
            todayStart.setDate(todayStart.getDate() - 1);
          }
          
          const ordersSnapshot = await window.getDocs(window.getStoreCollection('orders'));
          let maxOrderNumber = 618;
          let hasActiveOrders = false;
          
          ordersSnapshot.forEach(doc => {
            const data = doc.data();
            if (!data.deleted) {
              hasActiveOrders = true;
              const orderDate = data.timestamp.toDate();
              const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
              if (jstOrderDate >= todayStart && data.orderNumber > maxOrderNumber) {
                maxOrderNumber = data.orderNumber;
              }
            }
          });
          
          const orderNumber = hasActiveOrders ? (maxOrderNumber + 1) : 619;
          const deleteAt = new Date(now.getTime() + 10 * 60 * 1000);
          
          const orderData = {
            orderNumber: orderNumber,
            tableNumber: '即会計',
            items: manualCart.map(item => {
              const itemData = {
                id: item.id,
                name: item.name,
                price: item.price,
                toppingPrice: item.toppingPrice || 0,
                quantity: item.quantity
              };
              
              // undefinedでないフィールドのみ追加
              if (item.taxRate !== undefined) itemData.taxRate = item.taxRate;
              if (item.taxType !== undefined) itemData.taxType = item.taxType;  // taxTypeも追加
              if (item.foodType !== undefined) itemData.foodType = item.foodType;  // foodTypeも追加
              if (item.toppings) itemData.toppings = item.toppings;
              if (item.toppingsData) itemData.toppingsData = item.toppingsData;
              if (item.toppingDetails) itemData.toppingDetails = item.toppingDetails;
              
              return itemData;
            }),
            totalAmount: manualCart.reduce((sum, item) => {
              // 外税の場合は税込価格を計算
              let itemPrice = item.price;
              if (item.taxType === 'exclusive') {
                const taxRate = item.taxRate || 10;
                itemPrice = Math.floor(item.price * (1 + taxRate / 100));
              }
              return sum + (itemPrice + (item.toppingPrice || 0)) * item.quantity;
            }, 0),
            timestamp: window.Timestamp.now(),
            deleteAt: window.Timestamp.fromDate(deleteAt),
            status: 'pending',
            manualEntry: true
          };
          
          const docRef = await window.addDoc(window.getStoreCollection('orders'), orderData);
          await window.updateDoc(docRef, {
            orderId: docRef.id
          });
          
          console.log(' 即会計テーブルに注文を送信:', orderNumber);
          
          // 手入力レジをクリア
          manualCart = [];
          document.getElementById('manualTable').value = '';
          document.querySelectorAll('#menuItemsList input[type="checkbox"]').forEach(cb => cb.checked = false);
          updateManualCart();
          
        } catch (e) {
          console.error('注文エラー:', e);
          alert('注文の追加に失敗しました: ' + e.message);
          return;
        }
      }
      
      // 即会計テーブルを開く
      await selectTable('即会計');
    };
    
    // リアルタイム更新を開始
    function startRealtimeUpdates() {
      TABLES.forEach(table => {
        monitorTable(table);
      });
    }
    
    // テーブルの注文を監視
    async function monitorTable(tableNum) {
      const q = query(
        window.getStoreCollection('orders'),
        where('tableNumber', '==', String(tableNum))
      );
      
      onSnapshot(q, (snapshot) => {
        const unpaidOrders = snapshot.docs.filter(doc => {
          const data = doc.data();
          // 削除済み、会計済み、キャンセル済みを除外
          return !data.deleted && !data.paidAt && !data.cancelledAt;
        });
        
        const hasActiveOrders = unpaidOrders.length > 0;
        const orderCount = unpaidOrders.length;
        
        const btn = document.getElementById(`table-${tableNum}`);
        if (btn) {
          // has-ordersクラスの更新
          if (hasActiveOrders) {
            btn.classList.add('has-orders');
          } else {
            btn.classList.remove('has-orders');
          }
          
          // 既存のバッジを削除
          const existingBadge = btn.querySelector('.order-badge');
          if (existingBadge) {
            existingBadge.remove();
          }
          
          // 注文がある場合はバッジを追加
          if (orderCount > 0) {
            const badge = document.createElement('span');
            badge.className = 'order-badge';
            badge.textContent = orderCount;
            btn.appendChild(badge);
          }
        }
        
        if (selectedTable === tableNum) {
          loadOrders(tableNum);
        }
      });
    }
    
    // テーブルを選択
    window.selectTable = async function(tableNum) {
      selectedTable = tableNum;
      document.getElementById('selectedTableLabel').textContent = `テーブル ${tableNum}`;
      document.getElementById('orderSection').classList.remove('hidden');
      
      // テーブル設定を読み込み
      if (tableNum && tableNum !== '即会計') {
        currentTableSettings = await getTableSettings(tableNum);
        console.log(' テーブル設定読み込み完了:', tableNum);
        console.log('  taxRule:', currentTableSettings?.taxRule || 'なし');
        console.log('  設定全体:', currentTableSettings);
      } else {
        currentTableSettings = null;
        console.log(' 即会計モード: テーブル設定なし');
      }
      
      await loadOrders(tableNum);
    };
    
    // 注文を読み込み
    async function loadOrders(tableNum) {
      const container = document.getElementById('ordersList');
      container.innerHTML = '<div class="loading">読み込み中...</div>';
      
      try {
        const q = query(
          window.getStoreCollection('orders'),
          where('tableNumber', '==', String(tableNum))
        );
        
        const snapshot = await window.getDocs(q);
        
        if (snapshot.empty) {
          container.innerHTML = '<div class="empty-state">このテーブルに注文はありません</div>';
          document.getElementById('totalSection').classList.add('hidden');
          return;
        }
        
        container.innerHTML = '';
        currentOrders = [];
        let totalAmount = 0;
        let hasUnpaidOrders = false;
        
        // 注文を配列に変換してソート
        const orders = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          orders.push({ id: doc.id, ...data });
        });
        
        // 注文番号でソート（古い順: 619→620→621）
        orders.sort((a, b) => {
          return a.orderNumber - b.orderNumber;
        });
        
        // 削除されていない注文のみ表示
        console.log('全注文数:', orders.length);
        orders.forEach(order => {
          console.log(`注文#${order.orderNumber}: deleted=${order.deleted}, paidAt=${order.paidAt}, cancelledAt=${order.cancelledAt}`);
          
          // deletedフラグが立っている注文はスキップ（履歴では表示）
          if (order.deleted) {
            console.log(`  → スキップ（削除済み）`);
            return;
          }
          
          const card = createOrderCard(order);
          container.appendChild(card);
          
          // 未払い注文のみ合計に含める
          if (!order.cancelledAt && !order.paidAt) {
            currentOrders.push(order);
            totalAmount += order.totalAmount || 0;
            hasUnpaidOrders = true;
            
            // デバッグ: 注文内の商品データを確認
            if (order.items && order.items.length > 0) {
              console.log(`[注文 #${order.orderNumber}] 商品データ:`, order.items.map(item => ({
                name: item.name,
                foodType: item.foodType,
                taxRate: item.taxRate
              })));
            }
          }
        });
        
        console.log('表示された注文数:', container.children.length);
        
        // 注文が1つも表示されなかった場合
        if (container.children.length === 0) {
          container.innerHTML = '<div class="empty-state">このテーブルに注文はありません</div>';
        }
        
        if (!hasUnpaidOrders) {
          document.getElementById('totalSection').classList.add('hidden');
        } else {
          document.getElementById('totalAmount').textContent = `¥${totalAmount.toLocaleString()}`;
          document.getElementById('totalSection').classList.remove('hidden');
          totalAmountToPay = totalAmount;
        }
        
      } catch (e) {
        console.error('注文読み込みエラー:', e);
        console.error('エラー詳細:', e.message);
        container.innerHTML = '<div class="empty-state">エラーが発生しました: ' + e.message + '</div>';
      }
    }
    
    // 注文カードを作成
    function createOrderCard(order) {
      const card = document.createElement('div');
      card.className = 'order-card';
      
      if (order.completedAt) card.classList.add('completed');
      if (order.cancelledAt) card.classList.add('cancelled');
      
      let timeStr = '--:--';
      try {
        if (order.timestamp && order.timestamp.toDate) {
          const timestamp = order.timestamp.toDate();
          timeStr = `${timestamp.getHours()}:${String(timestamp.getMinutes()).padStart(2, '0')}`;
        }
      } catch (e) {
        console.error('Timestamp変換エラー:', e);
      }
      
      // 複数のステータスバッジを表示
      let statusBadges = [];
      if (order.paidAt) {
        statusBadges.push('<span class="order-status" style="background: #2196F3; color: white;">会計済</span>');
      }
      if (order.completedAt) {
        statusBadges.push('<span class="order-status completed">提供済み</span>');
      }
      if (order.cancelledAt) {
        statusBadges.push('<span class="order-status cancelled">キャンセル</span>');
      }
      if (statusBadges.length === 0) {
        statusBadges.push('<span class="order-status pending">調理中</span>');
      }
      const statusHtml = statusBadges.join(' ');
      
      let itemsHtml = '';
      if (order.items && Array.isArray(order.items) && order.items.length > 0) {
        order.items.forEach(item => {
          const itemBasePrice = item.price;
          const itemWithTopping = itemBasePrice + (item.toppingPrice || 0);
          const itemTotal = itemWithTopping * item.quantity;
          
          // トッピング表示（toppingDetailsまたはtoppingsDataを優先）
          let toppingsHtml = '';
          if (item.toppingDetails && item.toppingDetails.length > 0) {
            // 新しい形式: toppingDetailsがある場合（POS画面から）
            const groupedBySet = {};
            item.toppingDetails.forEach(detail => {
              if (!groupedBySet[detail.setName]) {
                groupedBySet[detail.setName] = [];
              }
              groupedBySet[detail.setName].push(detail.optionName);
            });
            
            toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
              return `
                <div style="font-size: 12px; color: #666; font-weight: bold; padding-left: 10px; margin-top: 3px;">${setName}</div>
                ${options.map(opt => `<div style="font-size: 12px; color: #666; padding-left: 20px;">　・${opt}</div>`).join('')}
              `;
            }).join('');
          } else if (item.toppingsData && item.toppingsData.length > 0) {
            // menu.htmlからの形式: toppingsDataがある場合
            const groupedBySet = {};
            item.toppingsData.forEach(topping => {
              const setName = topping.setName || 'トッピング';
              if (!groupedBySet[setName]) {
                groupedBySet[setName] = [];
              }
              groupedBySet[setName].push(topping.name);
            });
            
            toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
              return `
                <div style="font-size: 12px; color: #666; font-weight: bold; padding-left: 10px; margin-top: 3px;">${setName}</div>
                ${options.map(opt => `<div style="font-size: 12px; color: #666; padding-left: 20px;">　・${opt}</div>`).join('')}
              `;
            }).join('');
          } else if (item.toppings && item.toppings !== 'なし' && item.toppings !== '標準トッピング') {
            // 古い形式: toppingsのみの場合
            const toppingList = item.toppings.split(', ');
            toppingsHtml = toppingList.map(t => `<div style="font-size: 12px; color: #666; padding-left: 10px;">　${t}</div>`).join('');
          } else if (!item.toppingDetails && (!item.toppingsData || item.toppingsData.length === 0)) {
            // トッピング未選択の場合は「標準トッピング」と表示
            toppingsHtml = `<div style="font-size: 12px; color: #999; padding-left: 10px;">　標準トッピング</div>`;
          }
          
          const itemIndex = order.items.indexOf(item);
          const isChecked = order.itemsChecked && order.itemsChecked[itemIndex];
          const checkboxId = `checkbox-${order.id}-${itemIndex}`;
          
          itemsHtml += `
            <div class="order-item-detailed" style="position: relative; ${isChecked ? 'opacity: 0.6; background: #e8f5e9;' : ''}">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                <input type="checkbox" 
                       id="${checkboxId}" 
                       ${isChecked ? 'checked' : ''} 
                       onchange="toggleItemCheck('${order.id}', ${itemIndex})"
                       style="width: 20px; height: 20px; cursor: pointer; flex-shrink: 0;">
                <div style="flex: 1; display: flex; justify-content: space-between; cursor: pointer;" 
                     onclick="document.getElementById('${checkboxId}').click()">
                  <div style="font-weight: bold;">${item.name} ×${item.quantity}</div>
                  <div>¥${itemBasePrice.toLocaleString()}</div>
                </div>
              </div>
              ${toppingsHtml}
              <div style="display: flex; justify-content: flex-end; margin-top: 5px; padding-top: 5px; border-top: 1px dashed #ddd;">
                <div style="font-weight: bold; color: #667eea;">¥${itemWithTopping.toLocaleString()} × ${item.quantity} = ¥${itemTotal.toLocaleString()}</div>
              </div>
            </div>
          `;
        });
      } else {
        // itemsがない場合は警告表示
        itemsHtml = `
          <div style="padding: 10px; background: #fff3cd; border-radius: 8px; color: #856404;">
            商品詳細が記録されていません<br>
            合計金額: ¥${(order.totalAmount || 0).toLocaleString()}
          </div>
        `;
      }
      
      // レジ袋情報を追加
      if (order.bagNeeded && order.bagQuantity > 0) {
        const bagTotal = order.bagPrice || (order.bagQuantity * 3);
        const bagUnitPrice = Math.round(bagTotal / order.bagQuantity); // 単価を計算
        itemsHtml += `
          <div class="order-item-detailed" style="background: #fff3e0;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <div style="font-weight: bold;">️ レジ袋 ×${order.bagQuantity}</div>
              <div>¥${bagUnitPrice}</div>
            </div>
            <div style="display: flex; justify-content: flex-end; margin-top: 5px; padding-top: 5px; border-top: 1px dashed #ddd;">
              <div style="font-weight: bold; color: #667eea;">¥${bagUnitPrice} × ${order.bagQuantity} = ¥${bagTotal.toLocaleString()}</div>
            </div>
          </div>
        `;
      }
      
      // お客様情報を追加
      let customerInfoHtml = '';
      
      // メモ
      if (order.customerMemo && order.customerMemo.trim() !== '') {
        customerInfoHtml += `
          <div class="order-item-detailed" style="background: #e3f2fd; border-left: 4px solid #2196F3; margin-bottom: 8px;">
            <div style="font-weight: bold; color: #1976D2; margin-bottom: 5px;">お客様メモ</div>
            <div style="color: #333;">${order.customerMemo}</div>
          </div>
        `;
      }
      
      // 名前
      if (order.customerName && order.customerName.trim() !== '') {
        customerInfoHtml += `
          <div class="order-item-detailed" style="background: #f3e5f5; border-left: 4px solid #9C27B0; margin-bottom: 8px;">
            <div style="font-weight: bold; color: #7B1FA2; margin-bottom: 5px;">お名前</div>
            <div style="color: #333;">${order.customerName}</div>
          </div>
        `;
      }
      
      // 電話番号
      if (order.customerPhone && order.customerPhone.trim() !== '') {
        customerInfoHtml += `
          <div class="order-item-detailed" style="background: #e0f2f1; border-left: 4px solid #009688; margin-bottom: 8px;">
            <div style="font-weight: bold; color: #00796B; margin-bottom: 5px;">電話番号</div>
            <div style="color: #333;">${order.customerPhone}</div>
          </div>
        `;
      }
      
      // 引取時間
      if (order.pickupTime && order.pickupTime.trim() !== '') {
        customerInfoHtml += `
          <div class="order-item-detailed" style="background: #fff9c4; border-left: 4px solid #FFC107; margin-bottom: 8px;">
            <div style="font-weight: bold; color: #F57F17; margin-bottom: 5px;"> 引取時間</div>
            <div style="color: #333; font-size: 18px; font-weight: bold;">${order.pickupTime}</div>
          </div>
        `;
      }
      
      // 郵便番号
      if (order.customerPostalCode && order.customerPostalCode.trim() !== '') {
        customerInfoHtml += `
          <div class="order-item-detailed" style="background: #fff3e0; border-left: 4px solid #FF9800; margin-bottom: 8px;">
            <div style="font-weight: bold; color: #F57C00; margin-bottom: 5px;">郵便番号</div>
            <div style="color: #333;">${order.customerPostalCode}</div>
          </div>
        `;
      }
      
      // 住所
      if (order.customerAddress && order.customerAddress.trim() !== '') {
        customerInfoHtml += `
          <div class="order-item-detailed" style="background: #e8f5e9; border-left: 4px solid #4CAF50; margin-bottom: 8px;">
            <div style="font-weight: bold; color: #388E3C; margin-bottom: 5px;">住所</div>
            <div style="color: #333;">${order.customerAddress}</div>
          </div>
        `;
      }
      
      // メールアドレス
      if (order.customerEmail && order.customerEmail.trim() !== '') {
        customerInfoHtml += `
          <div class="order-item-detailed" style="background: #fce4ec; border-left: 4px solid #E91E63; margin-bottom: 8px;">
            <div style="font-weight: bold; color: #C2185B; margin-bottom: 5px;">メールアドレス</div>
            <div style="color: #333;">${order.customerEmail}</div>
          </div>
        `;
      }
      
      // 全商品がチェック済みかどうかを判定
      const allItemsChecked = order.items && order.items.length > 0 && 
        order.items.every((item, idx) => order.itemsChecked && order.itemsChecked[idx]);
      
      // メモ表示
      let memoHtml = '';
      if (order.memo && order.memo.trim() !== '') {
        memoHtml = `
          <div class="order-item-detailed" style="background: #fff9c4; border-left: 4px solid #FBC02D; margin-bottom: 8px;">
            <div style="font-weight: bold; color: #F57F17; margin-bottom: 5px; display: flex; align-items: center; gap: 5px;">
               メモ
              <button onclick="editOrderMemo('${order.id}')" style="padding: 2px 8px; background: #FBC02D; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">編集</button>
            </div>
            <div style="color: #333; white-space: pre-wrap;">${order.memo}</div>
          </div>
        `;
      } else {
        memoHtml = `
          <div style="margin-bottom: 8px;">
            <button onclick="editOrderMemo('${order.id}')" style="padding: 6px 12px; background: #FBC02D; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: bold;">
               メモを追加
            </button>
          </div>
        `;
      }
      
      card.innerHTML = `
        <div class="order-header">
          <div>
            <span class="order-number">#${order.orderNumber || '---'}</span>
            ${statusHtml}
          </div>
          <div class="order-time">${timeStr}</div>
        </div>
        <div class="order-items">
          ${memoHtml}
          ${customerInfoHtml}
          ${itemsHtml}
        </div>
        <div class="order-total">
          <span class="total-label">合計:</span>
          <span class="total-amount">¥${(order.totalAmount || 0).toLocaleString()}</span>
        </div>
        <div class="order-actions">
          ${!order.paidAt && !order.cancelledAt ? `<button class="order-action-btn pay-btn" onclick="payOrderIndividual('${order.id}', ${order.totalAmount || 0})">会計</button>` : ''}
          ${!order.completedAt && !order.cancelledAt ? `<button class="order-action-btn complete-btn" onclick="completeOrder('${order.id}')">完了</button>` : ''}
          ${!order.completedAt && !order.cancelledAt ? `<button class="order-action-btn cancel-btn" onclick="cancelOrder('${order.id}')">キャンセル</button>` : ''}
          ${order.completedAt || order.cancelledAt ? `<button class="order-action-btn delete-btn" onclick="deleteOrder('${order.id}')">削除</button>` : ''}
        </div>
      `;
      
      return card;
    }
    
    // 個別注文の会計
    window.payOrderIndividual = function(orderId, amount) {
      const order = currentOrders.find(o => o.id === orderId);
      if (!order) {
        alert('注文が見つかりません');
        return;
      }
      
      // 単一注文を選択して会計モーダルを表示
      currentOrders = [order];
      totalAmountToPay = amount;
      
      // 値引き金額を初期化
      document.getElementById('discountAmount').value = '0';
      
      // 税率選択リストを生成
      buildTaxRateSelectionList();
      
      // 請求額を表示
      updatePaymentTotal();
      
      document.getElementById('paymentModal').classList.remove('hidden');
      selectedPaymentMethod = null;
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('completePaymentBtn').disabled = true;
    };
    
    // 注文を完了にする
    window.completeOrder = async function(orderId) {
      try {
        // 注文データを取得して在庫を減らす
        const orderRef = window.getStoreDoc('orders', orderId);
        const orderSnap = await window.getDoc(orderRef);
        
        if (orderSnap.exists()) {
          const orderData = orderSnap.data();
          await decreaseInventory(orderData.items || []);
        }
        
        // 注文を完了にする
        await window.updateDoc(window.getStoreDoc('orders', orderId), {
          completedAt: window.Timestamp.now()
        });
        
        // 待ち人数を1減らす
        try {
          const waitingRef = window.getStoreDoc('settings', 'waiting');
          const waitingDoc = await window.getDoc(waitingRef);
          
          if (waitingDoc.exists()) {
            const currentCount = waitingDoc.data().manualCount || 0;
            if (currentCount > 0) {
              await window.updateDoc(waitingRef, {
                manualCount: currentCount - 1,
                updatedAt: window.Timestamp.now()
              });
              console.log(' 完了: 待ち人数を減らしました:', currentCount, '→', currentCount - 1);
            }
          }
        } catch (err) {
          console.error('待ち人数更新エラー:', err);
        }
        
        await loadOrders(selectedTable);
        
        // 在庫アラートチェック
        await checkInventoryAlerts();
      } catch (e) {
        console.error('完了エラー:', e);
        alert('エラーが発生しました');
      }
    };
    
    // 商品のチェック状態を切り替える
    window.toggleItemCheck = async function(orderId, itemIndex) {
      try {
        const orderRef = window.getStoreDoc('orders', orderId);
        const orderSnap = await window.getDoc(orderRef);
        
        if (!orderSnap.exists()) {
          alert('注文が見つかりません');
          return;
        }
        
        const orderData = orderSnap.data();
        const itemsChecked = orderData.itemsChecked || [];
        
        // チェック状態を反転
        itemsChecked[itemIndex] = !itemsChecked[itemIndex];
        
        // Firestoreに保存
        await window.updateDoc(orderRef, {
          itemsChecked: itemsChecked
        });
        
        console.log(' 商品チェック状態を更新:', orderId, 'item', itemIndex, '=', itemsChecked[itemIndex]);
        
        // 注文一覧を再読み込み（リアルタイム更新により自動で反映される）
      } catch (e) {
        console.error('チェック状態更新エラー:', e);
        alert('エラーが発生しました');
      }
    };
    
    // 注文メモを編集
    window.editOrderMemo = async function(orderId) {
      try {
        const orderRef = window.getStoreDoc('orders', orderId);
        const orderSnap = await window.getDoc(orderRef);
        
        if (!orderSnap.exists()) {
          alert('注文が見つかりません');
          return;
        }
        
        const orderData = orderSnap.data();
        const currentMemo = orderData.memo || '';
        
        const newMemo = prompt('メモを入力してください\n（お客様の名前、引取時間、注意事項など）', currentMemo);
        
        if (newMemo !== null) {  // キャンセルしなかった場合
          await window.updateDoc(orderRef, {
            memo: newMemo.trim()
          });
          
          console.log(' メモを更新:', orderId, newMemo);
        }
      } catch (e) {
        console.error('メモ更新エラー:', e);
        alert('エラーが発生しました');
      }
    };
    
    // 完了→削除（一気に処理）
    // 注文をキャンセルする
    window.cancelOrder = async function(orderId) {
      try {
        await window.updateDoc(window.getStoreDoc('orders', orderId), {
          cancelledAt: window.Timestamp.now()
        });
        await loadOrders(selectedTable);
      } catch (e) {
        console.error('キャンセルエラー:', e);
        alert('エラーが発生しました');
      }
    };
    
    // menu_settingsコレクションから在庫を減らす（kanri.htmlと互換性あり）
    async function decreaseInventoryFromMenuSettings(items) {
      try {
        console.log(' 在庫減少処理開始');
        console.log('  減らす商品:', items);
        
        // inventory_settings を使用（kanri.htmlと統一）
        let inventorySettingsRef;
        if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
          inventorySettingsRef = window.doc(window.db, 'inventory_settings', 'default');
          console.log('  → 旧パス: inventory_settings/default');
        } else {
          inventorySettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
          console.log('  → 新パス: stores/' + window.currentStoreId + '/inventory_settings/default');
        }
        
        const inventorySettingsSnap = await window.getDoc(inventorySettingsRef);
        
        if (!inventorySettingsSnap.exists()) {
          console.log(' 在庫設定が存在しません');
          return;
        }
        
        const inventorySettingsData = inventorySettingsSnap.data();
        const inventoryItems = inventorySettingsData.items || {};
        console.log('  現在の在庫データ:', inventoryItems);
        
        let updated = false;
        
        // menusコレクションから商品IDを取得してマッピング
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        const nameToIdMap = {};
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.name) {
            nameToIdMap[data.name] = data.id || doc.id;
          }
        });
        
        for (const item of items) {
          const itemName = item.name;
          const itemId = item.id || nameToIdMap[itemName];
          const quantity = item.quantity || 1;
          
          console.log(`  チェック: ${itemName} (ID: ${itemId}, 数量: ${quantity})`);
          
          if (!itemId) {
            console.log(`  ️ ${itemName}: IDが見つかりません`);
            continue;
          }
          
          // 在庫が設定されている商品のみ減らす
          if (inventoryItems[itemId]) {
            const currentStock = inventoryItems[itemId].stock;
            
            if (currentStock !== null && currentStock !== undefined && currentStock !== '') {
              const newStock = Math.max(0, currentStock - quantity);
              inventoryItems[itemId].stock = newStock;
              updated = true;
              
              console.log(`  在庫減少: ${itemName} ${currentStock} → ${newStock}`);
              
              // 在庫が0になった場合の警告
              if (newStock === 0) {
                console.log(`  在庫切れ: ${itemName}`);
              }
            } else {
              console.log(`  ️ ${itemName}: 在庫管理対象外（現在値: ${currentStock}）`);
            }
          } else {
            console.log(`  ️ ${itemName}: 在庫設定なし`);
          }
        }
        
        // 在庫を更新
        if (updated) {
          await window.updateDoc(inventorySettingsRef, {
            items: inventoryItems,
            updatedAt: new Date().toISOString()
          });
          console.log(' 在庫を更新しました');
          console.log('  更新後の在庫:', inventoryItems);
          
          // リアルタイム在庫パネルを更新
          updateInventoryPanel();
        } else {
          console.log(' 在庫更新なし（在庫管理対象の商品がありませんでした）');
        }
      } catch (error) {
        console.error(' 在庫減少エラー:', error);
        console.error('エラー詳細:', error.stack);
      }
    }
    
    // 在庫を減らす
    async function decreaseInventory(items) {
      try {
        const inventoryRef = window.getStoreDoc('inventory_settings', 'default');
        const inventorySnap = await window.getDoc(inventoryRef);
        
        if (!inventorySnap.exists()) {
          console.log(' 在庫設定が存在しません');
          return;
        }
        
        const inventoryData = inventorySnap.data();
        const inventorySettings = inventoryData.items || {};
        let updated = false;
        
        for (const item of items) {
          const menuItemId = item.id;
          const quantity = item.quantity || 1;
          
          if (inventorySettings[menuItemId]) {
            const currentStock = inventorySettings[menuItemId].stock;
            
            // 在庫が設定されている場合のみ減らす
            if (currentStock !== null && currentStock !== undefined) {
              const newStock = Math.max(0, currentStock - quantity);
              inventorySettings[menuItemId].stock = newStock;
              updated = true;
              
              console.log(`在庫減少: ${item.name} ${currentStock} → ${newStock} (${quantity}個使用)`);
              
              // 在庫が0になった場合、自動的に品切れにする
              if (newStock === 0) {
                console.log(`在庫切れ: ${item.name}`);
                // menu商品を品切れに設定
                try {
                  const menuRef = window.getStoreDoc('menus', menuItemId);
                  await window.updateDoc(menuRef, {
                    isSoldOut: true
                  });
                  console.log(`自動品切れ設定: ${item.name}`);
                } catch (e) {
                  console.error('品切れ設定エラー:', e);
                }
              }
            }
          }
        }
        
        // 在庫を更新
        if (updated) {
          await window.updateDoc(inventoryRef, {
            items: inventorySettings,
            updatedAt: new Date().toISOString()
          });
          console.log(' 在庫を更新しました');
        }
      } catch (error) {
        console.error(' 在庫減少エラー:', error);
      }
    }
    
    // 在庫アラートをチェック
    async function checkInventoryAlerts() {
      try {
        const inventoryRef = window.getStoreDoc('inventory_settings', 'default');
        const inventorySnap = await window.getDoc(inventoryRef);
        
        if (!inventorySnap.exists()) {
          return;
        }
        
        const inventoryData = inventorySnap.data();
        const inventorySettings = inventoryData.items || {};
        
        // メニュー商品を取得
        const menusSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        const menuItems = {};
        menusSnapshot.forEach(doc => {
          menuItems[doc.id] = doc.data();
        });
        
        // アラート対象の商品をチェック
        const alerts = [];
        for (const [itemId, settings] of Object.entries(inventorySettings)) {
          const stock = settings.stock;
          const alertThreshold = settings.alertThreshold;
          
          if (stock !== null && alertThreshold !== null && stock <= alertThreshold && stock > 0) {
            const menuItem = menuItems[itemId];
            if (menuItem) {
              alerts.push({
                name: menuItem.name,
                stock: stock
              });
            }
          }
        }
        
        // アラート表示
        if (alerts.length > 0) {
          showInventoryAlert(alerts);
        }
      } catch (error) {
        console.error(' 在庫アラートチェックエラー:', error);
      }
    }
    
    // 在庫アラート表示
    function showInventoryAlert(alerts) {
      // 既存のアラートがあれば削除
      const existingAlert = document.getElementById('inventory-alert-box');
      if (existingAlert) {
        existingAlert.remove();
      }
      
      const alertBox = document.createElement('div');
      alertBox.id = 'inventory-alert-box';
      alertBox.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: linear-gradient(135deg, #ff6b6b 0%, #ff5252 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(255, 0, 0, 0.3);
        z-index: 10000;
        max-width: 400px;
        animation: slideIn 0.5s ease-out;
      `;
      
      let alertHTML = `
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 24px;">!</span>
          <span>在庫アラート</span>
        </div>
        <div style="font-size: 14px; line-height: 1.6; margin-bottom: 15px;">
          以下の商品の在庫が少なくなっています：
        </div>
        <div style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
      `;
      
      alerts.forEach(alert => {
        alertHTML += `
          <div style="margin-bottom: 10px; padding: 10px; background: rgba(255, 255, 255, 0.15); border-radius: 6px;">
            <div style="font-weight: bold; font-size: 16px;">${alert.name}</div>
            <div style="font-size: 14px; margin-top: 5px;">残り <span style="font-size: 20px; font-weight: bold;">${alert.stock}</span> 個</div>
            <div style="color: #ffeb3b; font-size: 12px; margin-top: 5px;"> 補充してください</div>
          </div>
        `;
      });
      
      alertHTML += `
        </div>
        <button onclick="this.parentElement.remove()" style="
          width: 100%;
          padding: 12px;
          background: white;
          color: #ff5252;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s;
        " onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
          閉じる
        </button>
      `;
      
      alertBox.innerHTML = alertHTML;
      document.body.appendChild(alertBox);
      
      // アニメーション用のスタイルを追加
      if (!document.getElementById('inventory-alert-animation')) {
        const style = document.createElement('style');
        style.id = 'inventory-alert-animation';
        style.innerHTML = `
          @keyframes slideIn {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
        `;
        document.head.appendChild(style);
      }
      
      // 5秒後に自動で薄くする
      setTimeout(() => {
        if (alertBox.parentElement) {
          alertBox.style.opacity = '0.7';
        }
      }, 5000);
    }
    
    // 注文を削除する
    window.deleteOrder = async function(orderId) {
      console.log('削除開始: orderId =', orderId);
      console.log('selectedTable =', selectedTable);
      
      try {
        //  削除前にFirestoreから注文データを取得 
        console.log('注文データ取得中...');
        const orderRef = window.getStoreDoc('orders', orderId);
        const orderSnap = await window.getDoc(orderRef);
        
        if (!orderSnap.exists()) {
          alert('注文が見つかりません');
          return;
        }
        
        const orderData = orderSnap.data();
        console.log('注文データ:', orderData);
        
        //  会計済みの注文のみ商品点数をカウント 
        if (orderData.paidAt && !orderData.deleted) {
          console.log(' 会計済み注文の商品点数をカウントします');
          
          let itemCount = 0;
          let tax8Total = 0;
          let tax10Total = 0;
          
          // 商品点数をカウント
          if (orderData.items && Array.isArray(orderData.items) && orderData.items.length > 0) {
            orderData.items.forEach(item => {
              const qty = item.quantity || 0;
              itemCount += qty;
              console.log(`  → ${item.name} x${qty}点`);
              
              // 商品ごとの金額を計算（トッピング込み）
              const basePrice = item.price || 0;
              const toppingPrice = item.toppingPrice || 0;
              const totalPrice = basePrice + toppingPrice;
              const itemTotal = totalPrice * qty;
              
              // 商品のtaxRateフィールドを使用（優先）
              const itemTaxRate = item.taxRate;
              
              if (itemTaxRate) {
                // 商品にtaxRateが設定されている場合はそれを使用
                if (itemTaxRate === 8) {
                  tax8Total += itemTotal;
                } else if (itemTaxRate === 10) {
                  tax10Total += itemTotal;
                }
                console.log(`  → ${item.name} x${qty}点 (税率: ${itemTaxRate}%)`);
              } else {
                // taxRateがない場合は従来の判定ロジック
                const tableNumber = orderData.tableNumber || '';
                const itemName = item.name || '';
                
                // 【10%】店内テーブル: c1, c2, T-M, T-H のみ
                if (tableNumber.match(/^(c1|c2|T-M|T-H)$/)) {
                  tax10Total += itemTotal;
                }
                // 【10%】レジ袋
                else if (itemName.includes('レジ袋') || itemName.includes('袋')) {
                  tax10Total += itemTotal;
                }
                // 【8%】即会計、テイクアウト、予約など
                else {
                  tax8Total += itemTotal;
                }
                console.log(`  → ${item.name} x${qty}点`);
              }
            });
          } else {
            // itemsがない場合は1点としてカウント
            itemCount = 1;
            console.log('  → 注文全体を1点としてカウント');
          }
          
          // レジ袋もカウント
          if (orderData.bagNeeded && orderData.bagQuantity > 0) {
            itemCount += orderData.bagQuantity;
            const bagTotal = orderData.bagPrice || (orderData.bagQuantity * 3);
            tax10Total += bagTotal;
            console.log(`  → レジ袋 x${orderData.bagQuantity}点 (10%対象)`);
          }
          
          console.log(' 商品点数:', itemCount);
          console.log(' 税率別売上:', { tax8Total, tax10Total });
          
          // 日次売上を更新（商品点数のみ、売上金額・税金・値引き・客数は他で記録済み）
          const paymentMethod = orderData.paymentMethod || 'cash';
          
          console.log(' 商品点数のみ更新中...');
          console.log('  - itemCount:', itemCount);
          await updateDailySales(0, paymentMethod, itemCount, 0, 0, 0, 0);
          console.log(' 商品点数更新完了');
        } else {
          console.log(' 未会計または既に削除済みの注文のためカウントしません');
        }
        
        // deleteDocではなくdeletedフラグを立てる
        console.log('updateDoc実行中...');
        await window.updateDoc(orderRef, {
          deleted: true,
          deletedAt: window.Timestamp.now()
        });
        console.log('updateDoc成功');
        
        console.log('loadOrders実行中...');
        await loadOrders(selectedTable);
        console.log('loadOrders完了');
      } catch (e) {
        console.error('削除エラー:', e);
        console.error('エラー詳細:', e.message, e.code);
        alert('エラーが発生しました: ' + e.message);
      }
    };
    
    // 支払いモーダルを表示
    window.showPaymentModal = function() {
      if (currentOrders.length === 0) {
        alert('会計する注文がありません');
        return;
      }
      
      // 値引き金額を初期化
      document.getElementById('discountAmount').value = '0';
      
      // 税率選択リストを生成
      buildTaxRateSelectionList();
      
      // 請求額を表示
      updatePaymentTotal();
      
      document.getElementById('paymentModal').classList.remove('hidden');
      selectedPaymentMethod = null;
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('completePaymentBtn').disabled = true;
    };
    
    // 税率選択リストを構築
    
    //  旧バージョン: テーブル番号に基づいてデフォルト税率を決定（廃止予定）
    // 新しいロジックでは、getApplicableTaxRate()を使用してテーブル設定とfoodTypeから税率を決定
    function determineDefaultTaxRate(tableNumber) {
      // 即会計、テイクアウト、モバイルオーダー、予約テーブル、予約テイクアウト、予約テイクアウト2: 8%
      if (tableNumber === '即会計' || tableNumber === 'テイクアウト' || tableNumber === 'モバイルオーダー' || tableNumber === '予約テーブル' || tableNumber === '予約テイクアウト' || tableNumber === '予約テイクアウト2') {
        return 8;
      }
      // c1, c2, T-M, T-H: 10%
      if (tableNumber === 'c1' || tableNumber === 'c2' || tableNumber === 'T-M' || tableNumber === 'T-H') {
        return 10;
      }
      // それ以外のテーブル: 10%（デフォルト）
      return 10;
    }
    
    function buildTaxRateSelectionList() {
      const container = document.getElementById('taxRateItemsList');
      container.innerHTML = '';
      
      console.log(' buildTaxRateSelectionList開始');
      console.log('currentOrders:', currentOrders);
      console.log('currentOrders.length:', currentOrders.length);
      
      if (!container) {
        console.error(' taxRateItemsListコンテナが見つかりません');
        return;
      }
      
      if (currentOrders.length === 0) {
        console.warn('currentOrdersが空です');
        container.innerHTML = '<div style="padding: 15px; text-align: center; color: #666;">注文がありません</div>';
        return;
      }
      
      let itemIndex = 0;
      
      currentOrders.forEach((order, orderIdx) => {
        console.log(`注文${orderIdx}:`, order);
        if (!order.items || !Array.isArray(order.items) || order.items.length === 0) {
          // itemsがない場合は注文全体として表示
          const orderTotal = order.totalAmount || 0;
          console.log(`  注文全体として追加: #${order.orderNumber}, 金額:${orderTotal}`);
          
          // テーブル番号に基づいてデフォルト税率を決定
          const defaultTaxRate = determineDefaultTaxRate(order.tableNumber);
          addTaxRateItem(container, `注文 #${order.orderNumber}`, 1, orderTotal, itemIndex, defaultTaxRate);
          itemIndex++;
        } else {
          // 各商品を表示
          order.items.forEach((item, itemIdx) => {
            // 外税の場合は本体価格として扱う（taxTypeがexclusiveの場合、item.priceは本体価格）
            // 内税の場合はitem.priceが税込価格なので、そのまま使用
            const itemBasePrice = item.price + (item.toppingPrice || 0);
            const itemTotal = itemBasePrice * (item.quantity || 1);
            console.log(`  商品追加: ${item.name} x${item.quantity}, 本体価格:${itemTotal}, taxType:${item.taxType}`);
            
            // テーブル設定とfoodTypeに基づいて税率を決定
            const defaultTaxRate = getApplicableTaxRate(item, currentTableSettings);
            console.log(`  適用税率: ${defaultTaxRate}% (foodType: ${item.foodType || 'food'}, taxRule: ${currentTableSettings?.taxRule || 'none'})`);
            
            // taxTypeを渡す
            addTaxRateItem(container, item.name, item.quantity, itemTotal, itemIndex, defaultTaxRate, item.taxType || 'inclusive');
            itemIndex++;
          });
          
          // レジ袋を追加（デフォルトは10%）
          if (order.bagNeeded && order.bagQuantity > 0) {
            const bagTotal = order.bagPrice || (order.bagQuantity * 3);
            console.log(`  レジ袋追加: ${order.bagQuantity}枚, 金額:${bagTotal}`);
            addTaxRateItem(container, '️ レジ袋', order.bagQuantity, bagTotal, itemIndex, 10);
            itemIndex++;
          }
        }
      });
      
      console.log(`税率選択項目を${itemIndex}個生成しました`);
      calculateTaxSummary();
    }
    
    // 税率選択項目を追加
    function addTaxRateItem(container, itemName, quantity, itemTotal, index, defaultTaxRate = 10, taxType = 'inclusive') {
      console.log(`  addTaxRateItem: ${itemName}, 数量:${quantity}, 金額:${itemTotal}, index:${index}, デフォルト税率:${defaultTaxRate}%, 税タイプ:${taxType}`);
      
      // 外税の場合は税込価格を計算（itemTotalは本体価格）
      let displayTotal = itemTotal;
      if (taxType === 'exclusive') {
        // 外税の場合、itemTotalは本体価格なので税を加算
        displayTotal = itemTotal + Math.floor(itemTotal * (defaultTaxRate / 100));
        console.log(`  外税計算: 本体${itemTotal}円 + 税${Math.floor(itemTotal * (defaultTaxRate / 100))}円 → ${displayTotal}円（税率${defaultTaxRate}%）`);
      }
      
      const itemDiv = document.createElement('div');
      itemDiv.style.cssText = 'padding: 10px; margin-bottom: 8px; background: white; border-radius: 6px; border: 1px solid #ddd;';
      
      const headerDiv = document.createElement('div');
      headerDiv.style.cssText = 'display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; font-size: 14px; cursor: pointer;';
      headerDiv.innerHTML = `
        <span>${itemName} ×${quantity}</span>
        <span style="color: #667eea;" id="itemPrice${index}">¥${displayTotal.toLocaleString()}</span>
      `;
      
      // 商品行をクリックで金額編集
      headerDiv.onclick = function() {
        // カスタム金額変更モーダルを表示
        document.getElementById('priceChangeTitle').textContent = `${itemName} ×${quantity}`;
        document.getElementById('priceChangeItemInfo').textContent = `ソース ×${quantity} の金額を入力してください`;
        document.getElementById('priceChangeCurrentPrice').textContent = `¥${displayTotal.toLocaleString()}`;  // displayTotalを使用
        document.getElementById('priceChangeInput').value = displayTotal;  // displayTotalを使用
        document.getElementById('priceChangeItemId').value = index;
        document.getElementById('priceChangeModal').classList.remove('hidden');
        
        // 入力欄にフォーカス
        setTimeout(() => {
          const input = document.getElementById('priceChangeInput');
          input.focus();
          input.select();
        }, 100);
      };
      
      itemDiv.appendChild(headerDiv);
      
      const radioDiv = document.createElement('div');
      radioDiv.style.cssText = 'display: flex; gap: 10px; justify-content: center;';
      
      // 8%ラジオボタン
      const label8 = document.createElement('label');
      label8.style.cssText = 'flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 6px 10px; border-radius: 4px; background: #fff3e0; border: 2px solid #FF9800; font-size: 13px;';
      const radio8 = document.createElement('input');
      radio8.type = 'radio';
      radio8.name = `taxRate${index}`;
      radio8.value = '8';
      radio8.checked = (defaultTaxRate === 8);
      radio8.dataset.amount = displayTotal;  // displayTotalを使用
      radio8.dataset.taxType = taxType;  // taxTypeを保存
      radio8.dataset.baseAmount = itemTotal;  // 本体価格を保存
      radio8.dataset.index = index;
      radio8.style.cssText = 'margin-right: 5px; width: 18px; height: 18px;';
      radio8.onchange = function() {
        // 外税の場合は税率変更時に金額を再計算
        if (taxType === 'exclusive') {
          const newAmount = parseInt(radio8.dataset.baseAmount) + Math.floor(parseInt(radio8.dataset.baseAmount) * 0.08);
          radio8.dataset.amount = newAmount;
          radio10.dataset.amount = newAmount;  // 両方のラジオボタンのamountを更新
          document.getElementById('itemPrice' + index).textContent = '¥' + newAmount.toLocaleString();
          console.log(`   外税8%に変更: ${radio8.dataset.baseAmount}円 → ${newAmount}円`);
        }
        calculateTaxSummary();
      };
      label8.appendChild(radio8);
      label8.appendChild(document.createTextNode('8%持ち帰り'));
      
      // 10%ラジオボタン
      const label10 = document.createElement('label');
      label10.style.cssText = 'flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 6px 10px; border-radius: 4px; background: #e3f2fd; border: 2px solid #2196F3; font-size: 13px;';
      const radio10 = document.createElement('input');
      radio10.type = 'radio';
      radio10.name = `taxRate${index}`;
      radio10.value = '10';
      radio10.checked = (defaultTaxRate === 10);
      radio10.dataset.amount = displayTotal;  // displayTotalを使用
      radio10.dataset.taxType = taxType;  // taxTypeを保存
      radio10.dataset.baseAmount = itemTotal;  // 本体価格を保存
      radio10.dataset.index = index;
      radio10.style.cssText = 'margin-right: 5px; width: 18px; height: 18px;';
      radio10.onchange = function() {
        // 外税の場合は税率変更時に金額を再計算
        if (taxType === 'exclusive') {
          const newAmount = parseInt(radio10.dataset.baseAmount) + Math.floor(parseInt(radio10.dataset.baseAmount) * 0.10);
          radio10.dataset.amount = newAmount;
          radio8.dataset.amount = newAmount;  // 両方のラジオボタンのamountを更新
          document.getElementById('itemPrice' + index).textContent = '¥' + newAmount.toLocaleString();
          console.log(`   外税10%に変更: ${radio10.dataset.baseAmount}円 → ${newAmount}円`);
        }
        calculateTaxSummary();
      };
      label10.appendChild(radio10);
      label10.appendChild(document.createTextNode('10%店内'));
      
      console.log(`    ラジオボタン生成: taxRate${index}, 8%=${radio8.checked}, 10%=${radio10.checked}, amount=${displayTotal}`);
      
      radioDiv.appendChild(label8);
      radioDiv.appendChild(label10);
      itemDiv.appendChild(radioDiv);
      
      container.appendChild(itemDiv);
    }
    
    // 税率別集計を計算
    function calculateTaxSummary() {
      let tax8Total = 0;
      let tax10Total = 0;
      
      const radios = document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked');
      radios.forEach(radio => {
        const amount = parseFloat(radio.dataset.amount) || 0;
        if (radio.value === '8') {
          tax8Total += amount;
        } else if (radio.value === '10') {
          tax10Total += amount;
        }
      });
      
      document.getElementById('tax8Summary').textContent = '¥' + tax8Total.toLocaleString();
      document.getElementById('tax10Summary').textContent = '¥' + tax10Total.toLocaleString();
      
      // 請求額も更新
      updatePaymentTotal();
    }
    
    // 値引き後の請求額を更新
    window.updatePaymentTotal = function() {
      // 編集された金額を全て合計（ラジオボタンのdata-amountから取得）
      let total = 0;
      const radios = document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked');
      radios.forEach(radio => {
        total += parseFloat(radio.dataset.amount) || 0;
      });
      
      const discount = parseInt(document.getElementById('discountAmount').value) || 0;
      const finalAmount = Math.max(0, total - discount);
      totalAmountToPay = finalAmount;
      
      document.getElementById('finalPaymentAmount').textContent = '¥' + finalAmount.toLocaleString();
      
      // 現金の場合はおつり計算も更新
      if (selectedPaymentMethod === 'cash') {
        calculateChange();
      }
    };
    
    // 支払い方法選択
    window.selectPaymentMethod = function(method) {
      selectedPaymentMethod = method;
      
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');
      
      if (method === 'cash') {
        document.getElementById('cashInputSection').classList.remove('hidden');
        document.getElementById('completePaymentBtn').disabled = true;
      } else {
        document.getElementById('cashInputSection').classList.add('hidden');
        document.getElementById('completePaymentBtn').disabled = false;
      }
    };
    
    // おつり計算
    window.calculateChange = function() {
      cashReceived = parseInt(document.getElementById('cashReceived').value) || 0;
      
      // 値引き後の金額を使用
      changeAmount = cashReceived - totalAmountToPay;
      
      document.getElementById('changeAmount').textContent = `¥${changeAmount.toLocaleString()}`;
      
      document.getElementById('completePaymentBtn').disabled = cashReceived < totalAmountToPay;
    };
    
    // 会計完了
    window.completePayment = async function() {
      console.log(' completePayment開始');
      
      if (!selectedPaymentMethod) {
        alert('支払い方法を選択してください');
        return;
      }
      
      if (selectedPaymentMethod === 'cash' && cashReceived < totalAmountToPay) {
        alert('お預かり金額が不足しています');
        return;
      }
      
      console.log(' バリデーション通過。税率読み取り開始');
      
      // 担当者を取得（未選択の場合はデフォルト値）
      const staffSelect = document.getElementById('staffSelect');
      const staffName = staffSelect.value || '高田';
      
      try {
        const now = window.Timestamp.now();
        
        // 注文番号リストを取得
        const orderNumbers = currentOrders.map(o => o.orderNumber);
        
        // 即会計モードかどうかを確認（グローバル変数を使用）
        const isDirectPayment = isDirectPaymentMode;
        console.log('即会計モード判定:', isDirectPayment);
        
        // 全ての注文に支払い済みフラグと担当者を設定
        for (const order of currentOrders) {
          //  編集された金額とtaxRateを注文データに反映
          let orderItemIndex = 0;
          const updatedItems = [];
          
          if (order.items && Array.isArray(order.items) && order.items.length > 0) {
            // 各商品の編集された金額とtaxRateを取得
            order.items.forEach(item => {
              const radio = document.querySelector(`input[name="taxRate${orderItemIndex}"]:checked`);
              const taxRate = radio ? parseInt(radio.value) : 10;
              const editedTotalPrice = radio ? parseFloat(radio.dataset.amount) : ((item.price + (item.toppingPrice || 0)) * item.quantity);
              
              // 単価を計算（編集された合計金額 / 数量）
              const editedUnitPrice = editedTotalPrice / item.quantity;
              
              updatedItems.push({
                ...item,
                price: editedUnitPrice - (item.toppingPrice || 0), // トッピング価格を引いた基本価格
                taxRate: taxRate,
                takeout: taxRate === 8 // 8%なら持ち帰り、10%なら店内
              });
              
              orderItemIndex++;
            });
          }
          
          // 編集された合計金額を計算
          let editedTotalAmount = 0;
          if (order.items && Array.isArray(order.items) && order.items.length > 0) {
            updatedItems.forEach((item, idx) => {
              const radio = document.querySelector(`input[name="taxRate${idx}"]:checked`);
              const editedPrice = radio ? parseFloat(radio.dataset.amount) : ((item.price + (item.toppingPrice || 0)) * item.quantity);
              editedTotalAmount += editedPrice;
            });
            
            // レジ袋も加算
            if (order.bagNeeded && order.bagQuantity > 0) {
              const bagRadio = document.querySelector(`input[name="taxRate${orderItemIndex}"]:checked`);
              const bagPrice = bagRadio ? parseFloat(bagRadio.dataset.amount) : (order.bagQuantity * 3);
              editedTotalAmount += bagPrice;
            }
          } else {
            // itemsがない場合は注文全体の編集額を使用
            const radio = document.querySelector(`input[name="taxRate0"]:checked`);
            editedTotalAmount = radio ? parseFloat(radio.dataset.amount) : (order.totalAmount || 0);
          }
          
          await window.updateDoc(window.getStoreDoc('orders', order.id), {
            paidAt: now,
            notifiedPaid: true,
            paymentMethod: selectedPaymentMethod,
            staffName: staffName,  // 担当者名を追加
            items: updatedItems.length > 0 ? updatedItems : order.items, // 編集された商品情報を保存
            totalAmount: editedTotalAmount // 編集された合計金額を保存
          });
        }
        
        console.log(isDirectPayment ? '即会計: Firebase更新完了' : '通常会計: Firebase更新完了');
        
        // 商品点数をカウント & 選択された税率で集計
        let itemCount = 0;
        let tax8Total = 0;
        let tax10Total = 0;
        
        // 選択された税率から集計
        const radios = document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked');
        console.log(' 選択されたラジオボタン数:', radios.length);
        
        radios.forEach((radio, idx) => {
          const amount = parseFloat(radio.dataset.amount) || 0;
          const taxRate = radio.value;
          console.log(` ラジオ${idx}: 税率=${taxRate}%, 金額=${amount}`);
          
          if (taxRate === '8') {
            tax8Total += amount;
          } else if (taxRate === '10') {
            tax10Total += amount;
          }
        });
        
        console.log(' 税率別集計結果:', { tax8Total, tax10Total });
        
        // 商品点数をカウント（レジ袋含む）
        currentOrders.forEach(order => {
          if (!order.items || !Array.isArray(order.items) || order.items.length === 0) {
            itemCount += 1;
          } else {
            order.items.forEach(item => {
              itemCount += item.quantity || 0;
            });
          }
          
          // レジ袋もカウント
          if (order.bagNeeded && order.bagQuantity > 0) {
            itemCount += order.bagQuantity;
            console.log(`  レジ袋を商品点数に追加: ${order.bagQuantity}枚`);
          }
        });
        
        console.log(' 会計商品点数:', itemCount);
        console.log(' 税率別売上:', { tax8Total, tax10Total });
        
        // デバッグ: 商品点数が0の場合はコンソールログのみ
        if (itemCount === 0) {
          console.warn(' 商品点数が0です！ currentOrders: ' + currentOrders.length + '件');
          console.error('currentOrders:', currentOrders);
        } else {
          console.log(' 商品点数カウント成功:', itemCount + '点');
        }
        
        // 元の合計金額を計算（値引き前）
        let originalTotal = 0;
        currentOrders.forEach(order => {
          originalTotal += order.totalAmount || 0;
        });
        
        // 値引き金額を取得
        const discountAmount = parseInt(document.getElementById('discountAmount').value) || 0;
        console.log(' 元の金額:', originalTotal);
        console.log(' 値引き金額:', discountAmount);
        console.log(' 値引き後金額:', totalAmountToPay);
        
        console.log(' 売上金額・客数は会計時、商品点数は削除時にカウントします');
        console.log('  - totalAmount:', totalAmountToPay);
        console.log('  - paymentMethod:', selectedPaymentMethod);
        console.log('  - itemCount: 0（削除時にカウント）');
        console.log('  - customerCountIncrement: 1（会計時にカウント）');
        console.log('  - tax8Total:', tax8Total);
        console.log('  - tax10Total:', tax10Total);
        console.log('  - discountAmount:', discountAmount);
        
        // 商品リストを作成（itemCounts保存用）
        const allItems = [];
        currentOrders.forEach(order => {
          if (order.items && Array.isArray(order.items)) {
            order.items.forEach(item => {
              allItems.push({
                name: item.name,
                quantity: item.quantity || 1
              });
            });
          }
          // レジ袋も商品として追加
          if (order.bagNeeded && order.bagQuantity > 0) {
            allItems.push({
              name: 'レジ袋',
              quantity: order.bagQuantity
            });
          }
        });
        
        console.log(' 商品リスト（itemCounts用）:', allItems);
        
        //  売上金額・客数・値引きを記録 
        // 即会計の場合は会計時に商品点数もカウント、通常会計は削除時にカウントするため0を渡す
        const itemCountToRecord = isDirectPayment ? itemCount : 0;
        console.log(`売上記録する商品点数: ${itemCountToRecord}点 (即会計: ${isDirectPayment})`);
        await updateDailySales(totalAmountToPay, selectedPaymentMethod, itemCountToRecord, tax8Total, tax10Total, discountAmount, 1, allItems);
        
        // 商品リストを税率情報付きで作成
        const itemsWithTaxRate = [];
        let itemIndex = 0;
        
        currentOrders.forEach(order => {
          if (!order.items || !Array.isArray(order.items) || order.items.length === 0) {
            // itemsがない場合
            const radio = document.querySelector(`input[name="taxRate${itemIndex}"]:checked`);
            const taxRate = radio ? parseInt(radio.value) : 10;
            const editedPrice = radio ? parseFloat(radio.dataset.amount) : (order.totalAmount || 0);
            itemsWithTaxRate.push({
              name: `注文 #${order.orderNumber}`,
              quantity: 1,
              price: editedPrice,
              toppings: 'なし',
              taxRate: taxRate,
              taxType: 'inclusive'  // 旧データはデフォルトで内税
            });
            itemIndex++;
          } else {
            // 各商品を追加
            order.items.forEach(item => {
              const radio = document.querySelector(`input[name="taxRate${itemIndex}"]:checked`);
              const taxRate = radio ? parseInt(radio.value) : 10;
              const editedPrice = radio ? parseFloat(radio.dataset.amount) : ((item.price + (item.toppingPrice || 0)) * item.quantity);
              itemsWithTaxRate.push({
                name: item.name,
                quantity: item.quantity,
                price: editedPrice / item.quantity, // 単価に戻す
                toppings: item.toppings || 'なし',
                taxRate: taxRate,
                taxType: item.taxType || 'inclusive'  // taxTypeを保存
              });
              itemIndex++;
            });
            
            // レジ袋を追加
            if (order.bagNeeded && order.bagQuantity > 0) {
              const radio = document.querySelector(`input[name="taxRate${itemIndex}"]:checked`);
              const taxRate = radio ? parseInt(radio.value) : 10;
              const editedPrice = radio ? parseFloat(radio.dataset.amount) : (order.bagQuantity * 3);
              itemsWithTaxRate.push({
                name: '️ レジ袋',
                quantity: order.bagQuantity,
                price: editedPrice / order.bagQuantity, // 単価に戻す
                toppings: 'なし',
                taxRate: taxRate,
                taxType: 'inclusive'  // レジ袋は内税
              });
              itemIndex++;
            }
          }
        });
        
        // 支払いデータを保存（レシート印刷用）
        lastPaymentData = {
          tableNumber: selectedTable,
          orderNumbers: orderNumbers,
          items: itemsWithTaxRate,
          totalAmount: totalAmountToPay,
          discountAmount: discountAmount,
          paymentMethod: selectedPaymentMethod,
          cashReceived: selectedPaymentMethod === 'cash' ? cashReceived : totalAmountToPay,
          change: selectedPaymentMethod === 'cash' ? changeAmount : 0,
          timestamp: new Date(),
          staffName: staffName  // 担当者名を追加
        };
        
        // モーダルを閉じる
        closePaymentModal();
        
        // 即会計の場合はmanualCartをクリア & 注文を完了→削除
        if (isDirectPayment) {
          console.log('即会計完了: カートをクリア & 注文を完了→削除');
          console.log('削除対象の注文数:', currentOrders.length);
          
          // 即会計の場合は在庫を減らす
          console.log(' 即会計: 在庫を減らします');
          for (const order of currentOrders) {
            if (order.items && Array.isArray(order.items)) {
              await decreaseInventoryFromMenuSettings(order.items);
            }
          }
          
          manualCart = [];
          updateManualCart();
          
          // 即会計の注文を完了→削除
          for (const order of currentOrders) {
            console.log('注文を確認:', {
              id: order.id,
              orderNumber: order.orderNumber,
              tableNumber: order.tableNumber,
              directPayment: order.directPayment
            });
            
            if (order.id) {
              try {
                console.log(' 即会計注文を完了にします:', order.id);
                
                const orderRef = window.getStoreDoc('orders', order.id);
                
                // 1. 完了フラグを立てる
                await window.updateDoc(orderRef, {
                  completedAt: window.Timestamp.now()
                });
                
                console.log(' 即会計注文を完了しました:', order.id);
                
                // 2. 待ち人数を1減らす
                try {
                  const waitingRef = window.getStoreDoc('settings', 'waiting');
                  const waitingDoc = await window.getDoc(waitingRef);
                  
                  if (waitingDoc.exists()) {
                    const currentCount = waitingDoc.data().manualCount || 0;
                    if (currentCount > 0) {
                      await window.updateDoc(waitingRef, {
                        manualCount: currentCount - 1,
                        updatedAt: window.Timestamp.now()
                      });
                      console.log(' 即会計: 待ち人数を減らしました:', currentCount, '→', currentCount - 1);
                    }
                  }
                } catch (err) {
                  console.error('待ち人数更新エラー:', err);
                }
                
                // 3. 削除フラグを立てる
                await window.updateDoc(orderRef, {
                  deleted: true,
                  deletedAt: window.Timestamp.now()
                });
                
                console.log('️ 即会計注文を削除しました:', order.id);
              } catch (err) {
                console.error(' 即会計注文処理エラー:', order.id, err);
                console.error(' エラー詳細:', err.message);
              }
            } else {
              console.error(' 注文IDが存在しません:', order);
            }
          }
          
          currentOrders = [];
        }
        
        // 自動印刷が有効なら印刷
        if (autoPrintEnabled) {
          await printReceipt();
        } else {
          // レシート完了画面を表示
          document.getElementById('receiptCompleteModal').classList.remove('hidden');
        }
        
        // 表示をクリア（即会計の場合は何もしない）
        if (!isDirectPayment) {
          await loadOrders(selectedTable);
        }
        
        // 即会計モードをリセット
        if (isDirectPayment) {
          isDirectPaymentMode = false;
          console.log('即会計モード: OFF');
        }
        
      } catch (e) {
        console.error('会計エラー:', e);
        alert('会計処理に失敗しました: ' + e.message);
        
        // エラー時もリセット
        isDirectPaymentMode = false;
      }
    };
    
    // 支払いモーダルを閉じる
    window.closePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
      document.getElementById('cashReceived').value = '';
      calculateChange();
    };
    
    // お会計伝票印刷（58mm幅対応）
    window.printBill = async function() {
      console.log('printBill関数が呼ばれました');
      const tableNumber = document.getElementById('tableSelect').value;
      console.log(' 選択されたテーブル:', tableNumber);
      if (!tableNumber) {
        alert('テーブルを選択してください');
        return;
      }
      
      try {
        // 選択されたテーブルの全注文を取得
        const ordersSnapshot = await window.getDocs(window.getStoreCollection('orders'));
        const tableOrders = [];
        
        ordersSnapshot.forEach(doc => {
          const order = doc.data();
          if (order.tableNumber === tableNumber && !order.paidAt && !order.deleted && !order.cancelledAt) {
            tableOrders.push({
              id: doc.id,
              ...order
            });
          }
        });
        
        if (tableOrders.length === 0) {
          alert('このテーブルに未会計の注文がありません');
          return;
        }
        
        // 注文番号でソート
        tableOrders.sort((a, b) => (a.orderNumber || 0) - (b.orderNumber || 0));
        
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        // 58mm幅設定
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        
        // レシート設定から店舗名を取得
        const storeName = window.receiptSettings.storeName || '粉もん屋 八';
        builder.createTextElement({data: storeName + '\n'});
        
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        const branchName = window.receiptSettings.branchName || '下赤塚店';
        builder.createTextElement({data: branchName + '\n'});
        
        builder.createTextElement({emphasis: true, width: 2, height: 1});
        builder.createTextElement({data: '\nお会計伝票\n\n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createAlignmentElement({position: 'left'});
        const now = new Date();
        const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        builder.createTextElement({data: `日時: ${dateStr}\n`});
        builder.createTextElement({data: `テーブル: ${tableNumber}\n`});
        builder.createRuledLineElement({thickness: 'thin'});
        
        // 全注文の商品を表示
        let grandTotal = 0;
        let itemCount = 0;
        
        tableOrders.forEach(order => {
          builder.createTextElement({data: `\n[注文 #${order.orderNumber}]\n`});
          
          order.items.forEach(item => {
            const subtotal = item.price * item.quantity;
            grandTotal += subtotal;
            itemCount += item.quantity;
            
            // 商品名を32文字以内に調整
            const itemName = item.name.length > 16 ? item.name.substring(0, 15) + '…' : item.name;
            builder.createTextElement({data: `${itemName}\n`});
            
            // 外税対応
            let displayPrice = item.price;
            if (item.taxType === 'exclusive') {
              const taxRate = item.taxRate || 10;
              displayPrice = Math.floor(item.price * (1 + taxRate / 100));
            }
            
            const priceInfo = `@${displayPrice} x${item.quantity}`;
            const displaySubtotal = displayPrice * item.quantity;
            const subtotalStr = `${displaySubtotal.toLocaleString()}円`;
            const spaces = ' '.repeat(Math.max(1, 32 - priceInfo.length - subtotalStr.length));
            builder.createTextElement({data: `${priceInfo}${spaces}${subtotalStr}\n`});
            
            // トッピング表示
            if (item.toppingDetails && item.toppingDetails.length > 0) {
              const groupedBySet = {};
              item.toppingDetails.forEach(detail => {
                if (!groupedBySet[detail.setName]) {
                  groupedBySet[detail.setName] = [];
                }
                groupedBySet[detail.setName].push(detail.optionName);
              });
              
              Object.entries(groupedBySet).forEach(([setName, options]) => {
                builder.createTextElement({data: ` ${setName}\n`});
                options.forEach(opt => {
                  builder.createTextElement({data: `  ・${opt}\n`});
                });
              });
            } else if (item.toppings && item.toppings !== 'なし') {
              builder.createTextElement({data: ` TP:${item.toppings}\n`});
            }
          });
        });
        
        builder.createRuledLineElement({thickness: 'medium'});
        builder.createTextElement({data: `点数: ${itemCount}点\n`});
        builder.createRuledLineElement({thickness: 'medium'});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `合計 ${grandTotal.toLocaleString()}円\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        builder.createRuledLineElement({thickness: 'medium'});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({data: '\n\nレジまでお持ちください\n\n\n'});
        
        builder.createCutPaperElement({feed: true});
        
        // プロキシ対応の印刷処理
        await sendPrintRequest(
          builder,
          (response) => {
            console.log('印刷成功:', response);
            showToast('お会計伝票を印刷しました');
          },
          (response) => {
            console.error('印刷エラー:', response);
            alert('印刷に失敗しました: ' + (response.message || response.status));
          }
        );
        
      } catch (e) {
        console.error('印刷エラー:', e);
        alert('印刷処理でエラーが発生しました: ' + e.message);
      }
    };
    
    // レシート印刷（58mm幅対応）
    window.printReceipt = async function() {
      if (!lastPaymentData) {
        alert('印刷するデータがありません');
        return;
      }
      
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        // 58mm幅設定
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        // レシート作成
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        
        //  修正: レシート設定から店舗名を取得
        const storeName = window.receiptSettings.storeName || '粉もん屋 八';
        builder.createTextElement({data: storeName + '\n'});
        
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        //  修正: レシート設定から支店名を取得
        const branchName = window.receiptSettings.branchName || '下赤塚店';
        builder.createTextElement({data: branchName + '\n'});
        
        //  修正: レシート設定から住所と電話番号を取得
        const address = window.receiptSettings.address || '東京都板橋区赤塚新町';
        const phone = window.receiptSettings.phone || '03-XXXX-XXXX';
        builder.createTextElement({data: address + '\n'});
        builder.createTextElement({data: 'TEL: ' + phone + '\n'});
        
        // 印鑑画像を印刷（事前変換したCanvasを使用）
        if (window.receiptSettings.stampCanvas) {
          try {
            console.log('️ 印鑑画像を印刷します');
            builder.createAlignmentElement({position: 'right'});
            builder.createBitImageElement({
              context: window.receiptSettings.stampCanvas,
              x: 0,
              y: 0,
              width: window.receiptSettings.stampCanvas.canvas.width,
              height: window.receiptSettings.stampCanvas.canvas.height
            });
            builder.createFeedElement({line: 1});
            console.log(' 印鑑画像を追加しました');
          } catch (error) {
            console.error(' 印鑑画像印刷エラー:', error);
          }
        }
        
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createAlignmentElement({position: 'left'});
        const now = lastPaymentData.timestamp;
        const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        builder.createTextElement({data: `日時: ${dateStr}\n`});
        builder.createTextElement({data: `担当: ${lastPaymentData.staffName || 'レジ係'}\n`});
        builder.createTextElement({data: `テーブル: ${lastPaymentData.tableNumber}\n`});
        builder.createTextElement({data: `注文No: ${lastPaymentData.orderNumbers.join(',')}\n`});
        builder.createRuledLineElement({thickness: 'thin'});
        
        // 商品明細
        let itemCount = 0;
        let tax8Total = 0;
        let tax10Total = 0;
        let tax8Exclusive = 0;  // 外税8%の税抜金額
        let tax10Exclusive = 0;  // 外税10%の税抜金額
        
        lastPaymentData.items.forEach(item => {
          const subtotal = item.price * item.quantity;
          itemCount += item.quantity;
          
          // 税込/税抜の判定
          const isExclusive = item.taxType === 'exclusive';
          
          // 税率別集計
          if (item.taxRate === 8) {
            if (isExclusive) {
              // 外税: 税抜価格を集計
              tax8Exclusive += subtotal;
            } else {
              // 内税: 税込価格を集計
              tax8Total += subtotal;
            }
          } else {
            if (isExclusive) {
              // 外税: 税抜価格を集計
              tax10Exclusive += subtotal;
            } else {
              // 内税: 税込価格を集計
              tax10Total += subtotal;
            }
          }
          
          // 商品名を32文字以内に調整
          const itemName = item.name.length > 16 ? item.name.substring(0, 15) + '…' : item.name;
          builder.createTextElement({data: `${itemName}\n`});
          
          // 外税の場合は表示価格を税込に変換
          let displayPrice = item.price;
          if (isExclusive) {
            const taxRate = item.taxRate || 10;
            displayPrice = Math.floor(item.price * (1 + taxRate / 100));
          }
          
          // 単価×数量＝小計の形式（58mm幅に最適化）
          const priceInfo = `@${displayPrice} x${item.quantity}`;
          const displaySubtotal = displayPrice * item.quantity;
          const subtotalStr = `${displaySubtotal.toLocaleString()}円`;
          const spaces = ' '.repeat(Math.max(1, 32 - priceInfo.length - subtotalStr.length));
          builder.createTextElement({data: `${priceInfo}${spaces}${subtotalStr}\n`});
          
          // トッピング表示（toppingDetailsを優先）
          if (item.toppingDetails && item.toppingDetails.length > 0) {
            const groupedBySet = {};
            item.toppingDetails.forEach(detail => {
              if (!groupedBySet[detail.setName]) {
                groupedBySet[detail.setName] = [];
              }
              groupedBySet[detail.setName].push(detail.optionName);
            });
            
            Object.entries(groupedBySet).forEach(([setName, options]) => {
              builder.createTextElement({data: ` ${setName}\n`});
              options.forEach(opt => {
                builder.createTextElement({data: `  ・${opt}\n`});
              });
            });
          } else if (item.toppings && item.toppings !== 'なし') {
            builder.createTextElement({data: ` TP:${item.toppings}\n`});
          }
        });
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createTextElement({data: `小計${' '.repeat(20)}${lastPaymentData.totalAmount.toLocaleString()}円\n`});
        builder.createTextElement({data: `点数: ${itemCount}点\n`});
        builder.createRuledLineElement({thickness: 'thin'});
        
        // 税額計算（内税と外税を分けて計算）
        const tax8AmountInclusive = Math.floor(tax8Total * 8 / 108);  // 内税8%の税額
        const tax10AmountInclusive = Math.floor(tax10Total * 10 / 110);  // 内税10%の税額
        const tax8AmountExclusive = Math.floor(tax8Exclusive * 8 / 100);  // 外税8%の税額
        const tax10AmountExclusive = Math.floor(tax10Exclusive * 10 / 100);  // 外税10%の税額
        
        // 合計税額
        const totalTax8 = tax8AmountInclusive + tax8AmountExclusive;
        const totalTax10 = tax10AmountInclusive + tax10AmountExclusive;
        
        // 税込合計
        const total8WithTax = tax8Total + tax8Exclusive + tax8AmountExclusive;
        const total10WithTax = tax10Total + tax10Exclusive + tax10AmountExclusive;
        
        if (total8WithTax > 0) {
          builder.createTextElement({data: `8%対象${' '.repeat(16)}${total8WithTax.toLocaleString()}円\n`});
          builder.createTextElement({data: `(内消費税${' '.repeat(15)}${totalTax8.toLocaleString()}円)\n`});
        }
        if (total10WithTax > 0) {
          builder.createTextElement({data: `10%対象${' '.repeat(15)}${total10WithTax.toLocaleString()}円\n`});
          builder.createTextElement({data: `(内消費税${' '.repeat(15)}${totalTax10.toLocaleString()}円)\n`});
        }
        
        builder.createRuledLineElement({thickness: 'medium'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `合計 ${lastPaymentData.totalAmount.toLocaleString()}円\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createRuledLineElement({thickness: 'medium'});
        
        // 支払い情報
        let paymentMethodStr = '';
        if (lastPaymentData.paymentMethod === 'cash') {
          paymentMethodStr = '現金';
          builder.createTextElement({data: `お預り${' '.repeat(18)}${lastPaymentData.cashReceived.toLocaleString()}円\n`});
          builder.createTextElement({data: `おつり${' '.repeat(18)}${lastPaymentData.change.toLocaleString()}円\n`});
        } else if (lastPaymentData.paymentMethod === 'emoney') {
          paymentMethodStr = '電子マネー';
        } else if (lastPaymentData.paymentMethod === 'credit') {
          paymentMethodStr = 'クレジットカード';
        }
        builder.createTextElement({data: `支払: ${paymentMethodStr}\n`});
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createAlignmentElement({position: 'center'});
        
        //  修正: レシート設定からメッセージを取得
        const receiptMessage = window.receiptSettings.message || 'ありがとうございました\nまたのご来店を\nお待ちしております';
        const messageLines = receiptMessage.split('\n');
        messageLines.forEach(line => {
          if (line.trim()) {
            builder.createTextElement({data: line + '\n'});
          }
        });
        builder.createTextElement({data: '\n\n'});
        
        builder.createCutPaperElement({feed: true});
        
        // プロキシ対応の印刷処理
        await sendPrintRequest(
          builder,
          (response) => {
            console.log('印刷成功:', response);
            closeReceiptModal();
          },
          (response) => {
            console.error('印刷エラー:', response);
            alert('印刷に失敗しました: ' + (response.message || response.status));
          }
        );
        
      } catch (e) {
        console.error('印刷エラー:', e);
        alert('印刷処理でエラーが発生しました: ' + e.message);
      }
    };
    
    // 領収書印刷（印鑑欄付き・58mm幅対応）
    window.printInvoice = async function() {
      if (!lastPaymentData) {
        alert('印刷するデータがありません');
        return;
      }
      
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        // 58mm幅設定
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: '領 収 書\n\n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        builder.createAlignmentElement({position: 'left'});
        const now = lastPaymentData.timestamp;
        const dateStr = `${now.getFullYear()}年${String(now.getMonth()+1).padStart(2,'0')}月${String(now.getDate()).padStart(2,'0')}日`;
        builder.createTextElement({data: `${dateStr}\n\n`});
        
        builder.createTextElement({data: 'お客様\n\n'});
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `¥${lastPaymentData.totalAmount.toLocaleString()}-\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createAlignmentElement({position: 'left'});
        builder.createTextElement({data: '\n上記正に領収いたしました\n\n'});
        builder.createTextElement({data: '但し 飲食代として\n\n\n'});
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createAlignmentElement({position: 'right'});
        
        //  修正: レシート設定から店舗情報を取得
        const storeName = window.receiptSettings.storeName || '粉もん屋 八';
        const branchName = window.receiptSettings.branchName || '下赤塚店';
        const address = window.receiptSettings.address || '東京都板橋区赤塚新町';
        const phone = window.receiptSettings.phone || '03-XXXX-XXXX';
        
        builder.createTextElement({data: storeName + ' ' + branchName + '\n'});
        builder.createTextElement({data: address + '\n'});
        builder.createTextElement({data: 'TEL: ' + phone + '\n\n'});
        
        // 印鑑画像を印刷（事前変換したCanvasを使用）
        if (window.receiptSettings.stampCanvas) {
          try {
            console.log('️ 印鑑画像を印刷します（領収書）');
            builder.createAlignmentElement({position: 'right'});
            builder.createBitImageElement({
              context: window.receiptSettings.stampCanvas,
              x: 0,
              y: 0,
              width: window.receiptSettings.stampCanvas.canvas.width,
              height: window.receiptSettings.stampCanvas.canvas.height
            });
            builder.createFeedElement({line: 1});
            console.log(' 印鑑画像を追加しました（領収書）');
          } catch (error) {
            console.error(' 印鑑画像印刷エラー:', error);
          }
        } else {
          // 印鑑画像がない場合は従来のテキスト印鑑欄を表示
          builder.createAlignmentElement({position: 'right'});
          builder.createTextElement({data: '        ◯◯◯\n'});
          builder.createTextElement({data: '       ◯   ◯\n'});
          builder.createTextElement({data: '      ◯  印 ◯\n'});
          builder.createTextElement({data: '       ◯   ◯\n'});
          builder.createTextElement({data: '        ◯◯◯\n\n'});
        }
        
        builder.createAlignmentElement({position: 'left'});
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createTextElement({data: `\nテーブル: ${lastPaymentData.tableNumber}\n`});
        builder.createTextElement({data: `注文No: ${lastPaymentData.orderNumbers.join(',')}\n`});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({data: '\n\n'});
        
        builder.createCutPaperElement({feed: true});
        
        // プロキシ対応の印刷処理
        await sendPrintRequest(
          builder,
          (response) => {
            console.log('印刷成功:', response);
            closeReceiptModal();
          },
          (response) => {
            console.error('印刷エラー:', response);
            alert('印刷に失敗しました: ' + (response.message || response.status));
          }
        );
        
      } catch (e) {
        console.error('印刷エラー:', e);
        alert('印刷処理でエラーが発生しました: ' + e.message);
      }
    };
    
    // レシート完了モーダルを閉じる
    window.closeReceiptModal = function() {
      document.getElementById('receiptCompleteModal').classList.add('hidden');
      
      // 即会計モードをリセット
      isDirectPaymentMode = false;
      
      clearSelection();
    };
    
    // 選択をクリア
    window.clearSelection = function() {
      selectedTable = null;
      currentTableSettings = null;  // テーブル設定もクリア
      currentOrders = [];
      document.getElementById('orderSection').classList.add('hidden');
    };
    
    // 日次売上更新関数
    window.updateDailySales = async function(totalAmount, paymentMethod, itemCount, tax8Total, tax10Total, discountAmount = 0, customerCountIncrement = 0, items = []) {
      try {
        // 選択された営業日を使用（選択されていない場合は本日）
        const dateStr = window.getBusinessDateString();
        
        console.log(' 日次売上更新開始:', { 
          営業日: dateStr,
          totalAmount, 
          paymentMethod, 
          itemCount, 
          tax8Total, 
          tax10Total, 
          discountAmount, 
          customerCountIncrement 
        });
        
        // デバッグ: itemCountが0の場合は警告（コンソールのみ）
        if (itemCount === 0) {
          console.error(' updateDailySalesに渡されたitemCountが0です！');
        }
        
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await getDoc(salesRef);
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          console.log('既存データ:', data);
          
          // 商品別カウントを計算
          const currentItemCounts = data.itemCounts || {};
          items.forEach(item => {
            const itemName = item.name;
            currentItemCounts[itemName] = (currentItemCounts[itemName] || 0) + item.quantity;
          });
          
          const updates = {
            totalSales: (data.totalSales || 0) + totalAmount,
            customerCount: (data.customerCount || 0) + customerCountIncrement,
            totalItems: (data.totalItems || 0) + itemCount,
            tax8Total: (data.tax8Total || 0) + tax8Total,
            tax10Total: (data.tax10Total || 0) + tax10Total,
            totalDiscount: (data.totalDiscount || 0) + discountAmount,
            itemCounts: currentItemCounts,
            drawerOpenCount: data.drawerOpenCount || 0,  // 現在の値を保持
            cashSales: (data.cashSales || 0),  // 既存値を保持
            emoneSales: (data.emoneSales || 0),  // 既存値を保持
            creditSales: (data.creditSales || 0),  // 既存値を保持
            updatedAt: Timestamp.now()
          };
          
          console.log(' 更新前 - totalItems:', data.totalItems || 0, 'tax8Total:', data.tax8Total || 0, 'tax10Total:', data.tax10Total || 0, 'totalDiscount:', data.totalDiscount || 0);
          console.log(' 追加分 - itemCount:', itemCount, 'tax8Total:', tax8Total, 'tax10Total:', tax10Total, 'discountAmount:', discountAmount);
          console.log(' 更新後 - totalItems:', updates.totalItems, 'tax8Total:', updates.tax8Total, 'tax10Total:', updates.tax10Total, 'totalDiscount:', updates.totalDiscount);
          
          // 支払い方法別の売上を加算
          if (paymentMethod === 'cash') {
            updates.cashSales += totalAmount;
            // ドロアオープンカウントは手動ボタンのみ
          } else if (paymentMethod === 'emoney') {
            updates.emoneSales += totalAmount;
          } else if (paymentMethod === 'credit') {
            updates.creditSales += totalAmount;
          }
          
          await updateDoc(salesRef, updates);
          console.log(' 既存売上データ更新:', updates);
          
        } else {
          // 商品別カウントを計算
          const newItemCounts = {};
          items.forEach(item => {
            const itemName = item.name;
            newItemCounts[itemName] = (newItemCounts[itemName] || 0) + item.quantity;
          });
          
          const newData = {
            date: dateStr,
            totalSales: totalAmount,
            customerCount: customerCountIncrement,
            totalItems: itemCount,
            tax8Total: tax8Total,
            tax10Total: tax10Total,
            totalDiscount: discountAmount,
            itemCounts: newItemCounts,
            cashSales: paymentMethod === 'cash' ? totalAmount : 0,
            emoneSales: paymentMethod === 'emoney' ? totalAmount : 0,
            creditSales: paymentMethod === 'credit' ? totalAmount : 0,
            drawerOpenCount: 0,  // ドロアオープンボタンを押した数のみカウント
            createdAt: Timestamp.now(),
            updatedAt: Timestamp.now()
          };
          
          await setDoc(salesRef, newData);
          console.log(' 新規売上データ作成:', newData);
        }
        
        // 更新後のデータを取得して確認
        const updatedDoc = await getDoc(salesRef);
        console.log('更新後のデータ:', updatedDoc.data());
        
      } catch (error) {
        console.error(' 日次売上更新エラー:', error);
        throw error;
      }
    };
    
    // カスタムアラート関数
    function showCustomAlert(message, title = '通知', icon = '') {
      document.getElementById('customAlertIcon').textContent = icon;
      document.getElementById('customAlertTitle').textContent = title;
      document.getElementById('customAlertMessage').textContent = message;
      document.getElementById('customAlert').classList.add('show');
    }
    
    function closeCustomAlert() {
      document.getElementById('customAlert').classList.remove('show');
    }
    
    // カスタム確認ダイアログ
    function showCustomConfirm({ icon = '', title = '確認', message = '', confirmText = 'OK', confirmColor = '#4CAF50' }) {
      return new Promise((resolve) => {
        // オーバーレイを作成
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.6);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          animation: fadeIn 0.2s ease-out;
        `;
        
        // ダイアログボックスを作成
        const dialog = document.createElement('div');
        dialog.style.cssText = `
          background: white;
          border-radius: 20px;
          padding: 0;
          max-width: 85%;
          width: 400px;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          animation: slideUp 0.3s ease-out;
          overflow: hidden;
        `;
        
        // アイコン
        const iconDiv = document.createElement('div');
        iconDiv.textContent = icon;
        iconDiv.style.cssText = `
          font-size: 64px;
          text-align: center;
          padding: 30px 20px 20px 20px;
        `;
        
        // タイトル
        const titleDiv = document.createElement('div');
        titleDiv.textContent = title;
        titleDiv.style.cssText = `
          font-size: 24px;
          font-weight: bold;
          color: #333;
          text-align: center;
          padding: 0 30px;
          margin-bottom: 15px;
        `;
        
        // メッセージ
        const messageDiv = document.createElement('div');
        messageDiv.textContent = message;
        messageDiv.style.cssText = `
          font-size: 16px;
          color: #666;
          text-align: center;
          padding: 0 30px 30px 30px;
          line-height: 1.6;
          white-space: pre-line;
        `;
        
        // ボタンコンテナ
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = `
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 0;
          border-top: 1px solid #e0e0e0;
        `;
        
        // キャンセルボタン
        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'キャンセル';
        cancelButton.style.cssText = `
          padding: 18px;
          background: white;
          color: #666;
          border: none;
          border-right: 1px solid #e0e0e0;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.2s;
        `;
        cancelButton.onmouseover = () => {
          cancelButton.style.background = '#f5f5f5';
        };
        cancelButton.onmouseout = () => {
          cancelButton.style.background = 'white';
        };
        cancelButton.onclick = () => {
          overlay.style.animation = 'fadeOut 0.2s ease-out';
          setTimeout(() => {
            overlay.remove();
            resolve(false);
          }, 200);
        };
        
        // 確認ボタン
        const confirmButton = document.createElement('button');
        confirmButton.textContent = confirmText;
        confirmButton.style.cssText = `
          padding: 18px;
          background: white;
          color: ${confirmColor};
          border: none;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.2s;
        `;
        confirmButton.onmouseover = () => {
          confirmButton.style.background = '#f5f5f5';
        };
        confirmButton.onmouseout = () => {
          confirmButton.style.background = 'white';
        };
        confirmButton.onclick = () => {
          overlay.style.animation = 'fadeOut 0.2s ease-out';
          setTimeout(() => {
            overlay.remove();
            resolve(true);
          }, 200);
        };
        
        // 組み立て
        buttonContainer.appendChild(cancelButton);
        buttonContainer.appendChild(confirmButton);
        dialog.appendChild(iconDiv);
        dialog.appendChild(titleDiv);
        dialog.appendChild(messageDiv);
        dialog.appendChild(buttonContainer);
        overlay.appendChild(dialog);
        
        // アニメーションスタイルを追加（まだなければ）
        if (!document.getElementById('custom-confirm-styles')) {
          const style = document.createElement('style');
          style.id = 'custom-confirm-styles';
          style.textContent = `
            @keyframes fadeIn {
              from { opacity: 0; }
              to { opacity: 1; }
            }
            @keyframes fadeOut {
              from { opacity: 1; }
              to { opacity: 0; }
            }
            @keyframes slideUp {
              from {
                transform: translateY(50px);
                opacity: 0;
              }
              to {
                transform: translateY(0);
                opacity: 1;
              }
            }
          `;
          document.head.appendChild(style);
        }
        
        document.body.appendChild(overlay);
      });
    }
    
    // 全てのalertをshowCustomAlertに置き換え
    window.alert = function(message) {
      let title = '通知';
      let icon = '';
      
      // メッセージに応じてアイコンを変更
      if (message.includes('成功') || message.includes('完了') || message.includes('') || message.includes('成功')) {
        icon = '';
        title = '完了';
      } else if (message.includes('エラー') || message.includes('失敗')) {
        icon = '';
        title = 'エラー';
      } else if (message.includes('警告')) {
        icon = '';
        title = '警告';
      } else if (message.includes('削除')) {
        icon = '';
        title = '削除';
      } else if (message.includes('追加') || message.includes('注文')) {
        icon = '';
        title = '完了';
      }
      
      showCustomAlert(message, title, icon);
    };
    
    // ========== コントローラー機能 ==========
    
    // 待ち人数+1
    window.increaseWaiting = async function() {
      try {
        const ref = window.getStoreDoc('settings', 'waiting');
        const snapshot = await window.getDocs(window.getStoreCollection('settings'));
        let count = 0;
        snapshot.forEach(d => { if (d.id === 'waiting') count = d.data().manualCount || 0; });
        await window.setDoc(ref, { manualCount: count + 1 });
        showToast('待ち+1');
      } catch (e) {
        console.error(e);
        alert('エラー: ' + e.message);
      }
    };
    
    // 待ち人数リセット
    window.resetWaiting = async function() {
      try {
        await window.setDoc(window.getStoreDoc('settings', 'waiting'), { manualCount: 0 });
        showToast('リセット');
      } catch (e) {
        console.error(e);
        alert('エラー: ' + e.message);
      }
    };
    
    // 待ち人数を監視
    function watchWaiting() {
      const unsubscribe = window.onSnapshot(
        window.getStoreDoc('settings', 'waiting'),
        (doc) => {
          if (doc.exists()) {
            const count = doc.data().manualCount || 0;
            document.getElementById('manual-count').textContent = count;
          }
        }
      );
      return unsubscribe;
    }
    
    // 品切れページ表示
    window.showSoldOutPage = async function() {
      try {
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        allMenuItems = [];
        const categories = new Set();
        
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          allMenuItems.push({
            id: data.id,
            name: data.name,
            price: data.price,
            category: data.category
          });
          if (data.category) categories.add(data.category);
        });
        
        const select = document.getElementById('soldout-category-select');
        select.innerHTML = '<option value="">全ての商品</option>';
        Array.from(categories).sort().forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          select.appendChild(opt);
        });
        
        select.onchange = () => {
          const filtered = select.value === '' ? allMenuItems : allMenuItems.filter(i => i.category === select.value);
          displaySoldOutItems(filtered);
        };
        
        // 一括品切れボタンのイベントリスナーを設定
        const bulkBtn = document.getElementById('bulk-soldout-btn');
        if (bulkBtn && !bulkBtn.hasAttribute('data-listener-added')) {
          bulkBtn.removeAttribute('onclick'); // 既存のonclick属性を削除
          bulkBtn.addEventListener('click', window.toggleBulkSoldOut);
          bulkBtn.setAttribute('data-listener-added', 'true'); // 重複防止
        }
        
        await displaySoldOutItems(allMenuItems);
        document.getElementById('page-soldout').style.display = 'block';
      } catch (e) {
        console.error(e);
        alert('エラー: ' + e.message);
      }
    };
    
    // 品切れページから戻る
    window.backFromSoldOut = function() {
      document.getElementById('page-soldout').style.display = 'none';
    };
    
    // 品切れ商品リスト表示
    async function displaySoldOutItems(items) {
      const list = document.getElementById('soldout-menu-list');
      list.innerHTML = '';
      
      // controller.htmlと同じ形式でsold_outを取得
      const soldOutSnapshot = await window.getDocs(window.collection(window.db, 'sold_out'));
      const soldOutIds = new Set();
      soldOutSnapshot.forEach(doc => soldOutIds.add(doc.data().menuId));
      
      items.sort((a, b) => {
        const numA = a.id ? parseInt(a.id.replace(/\D/g, '') || '0') : 0;
        const numB = b.id ? parseInt(b.id.replace(/\D/g, '') || '0') : 0;
        return numA - numB;
      });
      
      items.forEach(item => {
        const isSoldOut = soldOutIds.has(item.id);
        const div = document.createElement('div');
        div.className = 'soldout-item' + (isSoldOut ? ' sold-out' : '');
        
        div.innerHTML = `
          <div>
            <div class="soldout-item-name">${item.name}</div>
            <div style="font-size:14px;color:#666;">¥${item.price.toLocaleString()}</div>
            ${isSoldOut ? '<span class="soldout-badge">品切れ中</span>' : ''}
          </div>
          <button class="soldout-toggle-btn ${isSoldOut ? 'set-available' : 'set-soldout'}" 
                  data-menu-id="${item.id}" 
                  data-set-soldout="${!isSoldOut}">
            ${isSoldOut ? '販売再開' : '品切れ'}
          </button>
        `;
        
        // イベントリスナーを直接追加
        const button = div.querySelector('.soldout-toggle-btn');
        button.addEventListener('click', async function() {
          const menuId = this.getAttribute('data-menu-id');
          const setSoldOut = this.getAttribute('data-set-soldout') === 'true';
          await window.toggleSoldOut(menuId, setSoldOut);
        });
        
        list.appendChild(div);
      });
    }
    
    // 個別品切れ切り替え
    window.toggleSoldOut = async function(menuId, setSoldOut) {
      try {
        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
        console.log('toggleSoldOut 呼び出し');
        console.log('   menuId:', menuId);
        console.log('   setSoldOut:', setSoldOut);
        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
        
        if (setSoldOut) {
          // 品切れに設定（controller.htmlと同じ形式）
          console.log('   → 品切れに設定');
          await window.setDoc(window.doc(window.db, 'sold_out', menuId), {
            menuId: menuId,
            timestamp: window.Timestamp.now()
          });
          showToast('品切れに設定');
          console.log('   品切れ設定完了');
        } else {
          // 再販：menuIdに一致するドキュメントを検索して削除
          console.log('   → 販売再開');
          const soldOutSnapshot = await window.getDocs(window.collection(window.db, 'sold_out'));
          const deletePromises = [];
          let foundCount = 0;
          
          soldOutSnapshot.forEach(docSnap => {
            const data = docSnap.data();
            console.log('  sold_out doc:', docSnap.id, data);
            
            // menuIdが一致するドキュメントを削除（.refを使用）
            if (data.menuId === menuId || docSnap.id === menuId) {
              console.log('    → 削除:', docSnap.id);
              deletePromises.push(window.deleteDoc(docSnap.ref));
              foundCount++;
            }
          });
          
          if (deletePromises.length > 0) {
            await Promise.all(deletePromises);
            showToast(`販売再開 (${foundCount}件)`);
            console.log('   販売再開完了:', foundCount, '件');
          } else {
            console.warn('削除するドキュメントが見つかりません。menuId:', menuId);
            showToast('削除対象なし');
          }
        }
        
        console.log('    リスト更新中...');
        const sel = document.getElementById('soldout-category-select');
        const filtered = sel.value === '' ? allMenuItems : allMenuItems.filter(i => i.category === sel.value);
        await displaySoldOutItems(filtered);
        console.log('   リスト更新完了');
        console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
      } catch (e) {
        console.error(' toggleSoldOut error:', e);
        console.error('   エラー詳細:', e.message);
        console.error('   スタックトレース:', e.stack);
        showToast('エラー: ' + e.message);
      }
    };
    
    // 一括品切れ切り替え
    window.toggleBulkSoldOut = async function() {
      console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
      console.log('toggleBulkSoldOut 呼び出し');
      console.log('   currentStoreId:', window.currentStoreId);
      console.log('   isBulkSoldOut:', isBulkSoldOut);
      console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
      
      const btn = document.getElementById('bulk-soldout-btn');
      
      if (!isBulkSoldOut) {
        console.log('   → 一括品切れ設定モード');
        const confirmed = await showCustomConfirm({
          icon: '',
          title: '一括品切れ設定',
          message: '全ての商品を品切れに設定しますか？\nお客様は注文できなくなります。',
          btnText: '品切れにする',
          btnClass: 'modal-btn-danger'
        });
        
        if (!confirmed) {
          console.log('   ️ キャンセルされました');
          return;
        }
        
        try {
          console.log('    メニュー取得中...');
          const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
          const promises = [];
          
          menuSnapshot.forEach(docSnap => {
            const data = docSnap.data();
            if (data.id) {
              console.log('     品切れ設定:', data.id, data.name);
              // controller.htmlと同じ形式
              promises.push(window.setDoc(window.doc(window.db, 'sold_out', data.id), {
                menuId: data.id,
                timestamp: window.Timestamp.now()
              }));
            }
          });
          
          console.log('    一括設定実行中...', promises.length, '件');
          await Promise.all(promises);
          isBulkSoldOut = true;
          btn.textContent = '再販';
          btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
          showToast('全商品を品切れに設定しました');
          console.log('   一括品切れ設定完了');
        } catch (e) {
          console.error(' 一括品切れエラー:', e);
          alert('エラー: ' + e.message);
        }
      } else {
        console.log('   → 一括販売再開モード');
        const confirmed = await showCustomConfirm({
          icon: 'OK',
          title: '販売再開',
          message: '全ての商品を販売再開しますか？\nお客様が注文できるようになります。',
          btnText: '販売再開する',
          btnClass: 'modal-btn-success'
        });
        
        if (!confirmed) {
          console.log('   ️ キャンセルされました');
          return;
        }
        
        try {
          console.log('    品切れ一覧取得中...');
          // controller.htmlと同じ形式
          const soldOutSnapshot = await window.getDocs(window.collection(window.db, 'sold_out'));
          const promises = [];
          soldOutSnapshot.forEach(docSnap => {
            console.log('     削除:', docSnap.id);
            promises.push(window.deleteDoc(docSnap.ref));
          });
          
          console.log('    一括削除実行中...', promises.length, '件');
          await Promise.all(promises);
          isBulkSoldOut = false;
          btn.textContent = '一括';
          btn.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
          showToast('全商品の販売を再開しました');
          console.log('   一括販売再開完了');
        } catch (e) {
          console.error(' 一括販売再開エラー:', e);
          alert('エラー: ' + e.message);
        }
      }
      
      console.log('    リスト更新中...');
      await displaySoldOutItems(allMenuItems);
      console.log('   リスト更新完了');
      console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━');
    };
    
    // 時間外設定切り替え
    window.toggleTimeOverride = async function() {
      const btn = document.getElementById('time-override-btn');
      
      try {
        const settingsRef = window.getStoreDoc('settings', 'timeOverride');
        const settingsSnap = await window.getDoc(settingsRef);
        const currentOverride = settingsSnap.exists() ? settingsSnap.data().enabled : false;
        
        const newOverride = !currentOverride;
        
        await window.setDoc(settingsRef, {
          enabled: newOverride,
          timestamp: window.Timestamp.now()
        });
        
        if (newOverride) {
          btn.textContent = '営業';
          btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
          showToast('営業時間外でも注文可能にしました');
        } else {
          btn.textContent = '時外';
          btn.style.background = 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)';
          showToast('営業時間外チェックを有効にしました');
        }
      } catch (e) {
        console.error(e);
        alert('エラー: ' + e.message);
      }
    };
    
    // 時間外設定を読み込み
    async function loadTimeOverrideStatus() {
      try {
        const settingsRef = window.getStoreDoc('settings', 'timeOverride');
        const settingsSnap = await window.getDoc(settingsRef);
        const overrideEnabled = settingsSnap.exists() ? settingsSnap.data().enabled : false;
        
        const btn = document.getElementById('time-override-btn');
        if (overrideEnabled) {
          btn.textContent = '営業';
          btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
        } else {
          btn.textContent = '時外';
          btn.style.background = 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)';
        }
      } catch (e) {
        console.error('時間オーバーライド読み込みエラー:', e);
      }
    }
    
    // トースト表示
    function showToast(msg) {
      const toast = document.createElement('div');
      toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);color:white;padding:30px 50px;border-radius:15px;font-size:24px;font-weight:bold;z-index:10001;';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }
    
    // 初期化時に監視を開始
    if (window.firebaseReady) {
      watchWaiting();
      loadTimeOverrideStatus();
    } else {
      window.addEventListener('firebaseReady', () => {
        watchWaiting();
        loadTimeOverrideStatus();
      });
    }
    
    // ========== 音声通知機能 ==========
    
    function showAudioEnablePopup() {
      // サイレント化：自動的に音声を有効化
      audioEnabled = true;
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGi77eifTRAMUKjj8LZjHAY4ktfyzXksBS');
      audio.volume = 0.01;
      audio.play().catch(e => console.log('Audio init'));
    }
    
    // playOrderSound関数は削除されました
    
    function playCallSound() {
      console.log(' 呼び出し音声再生試行 - audioEnabled:', audioEnabled);
      if (!audioEnabled) {
        console.log(' 音声が無効です');
        return;
      }
      try {
        const audio = new Audio('./call.wav');
        audio.volume = 1.0;
        audio.addEventListener('loadeddata', () => console.log(' call.wav ロード成功'));
        audio.addEventListener('error', (e) => console.error(' call.wav ロードエラー:', e));
        audio.play()
          .then(() => console.log(' call.wav 再生成功'))
          .catch(e => console.error(' call.wav 再生失敗:', e));
      } catch (e) {
        console.error(' call.wav エラー:', e);
      }
    }
    
    function playBillSound() {
      console.log(' お会計音声再生試行 - audioEnabled:', audioEnabled);
      if (!audioEnabled) {
        console.log(' 音声が無効です');
        return;
      }
      try {
        const audio = new Audio('./okaikei.wav');
        audio.volume = 1.0;
        audio.addEventListener('loadeddata', () => console.log(' okaikei.wav ロード成功'));
        audio.addEventListener('error', (e) => console.error(' okaikei.wav ロードエラー:', e));
        audio.play()
          .then(() => console.log(' okaikei.wav 再生成功'))
          .catch(e => console.error(' okaikei.wav 再生失敗:', e));
      } catch (e) {
        console.error(' okaikei.wav エラー:', e);
      }
    }
    
    function watchOrders() {
      console.log(' 注文監視開始');
      const unsubscribe = window.onSnapshot(
        window.getStoreCollection('orders'), 
        (snapshot) => {
          const currentCount = snapshot.size;
          console.log(' 注文数変化:', {
            前回: lastOrderCount,
            今回: currentCount,
            初回: isFirstOrderLoad
          });
          
          // 音声再生機能は削除されました
          
          lastOrderCount = currentCount;
          isFirstOrderLoad = false;
        }
      );
      
      return unsubscribe;
    }
    
    function watchStaffCalls() {
      console.log(' スタッフコール監視開始');
      let isFirstLoad = true;
      let lastCallsSnapshot = [];
      
      const unsubscribe = window.onSnapshot(
        window.getStoreCollection('staff_calls'),
        (snapshot) => {
          const calls = [];
          snapshot.forEach(doc => calls.push({ id: doc.id, ...doc.data() }));
          calls.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
          
          console.log('スタッフコール変化:', {
            コール数: calls.length,
            初回: isFirstLoad
          });
          
          // 新しい呼び出しがあるかチェック
          if (!isFirstLoad && calls.length > 0) {
            const isBill = calls[0].type === 'bill';
            console.log(' 新しい呼び出し検出！', isBill ? 'お会計' : '呼び出し');
            
            // ポップアップを表示
            showStaffCallPopup(calls[0], isBill);
            
            // 音声を再生
            if (isBill) playBillSound();
            else playCallSound();
          }
          isFirstLoad = false;
          lastCallsSnapshot = calls;
        }
      );
      
      return unsubscribe;
    }
    
    function showStaffCallPopup(call, isBill) {
      // 既存のポップアップがあれば削除
      const existing = document.getElementById('staff-call-popup');
      if (existing) existing.remove();
      
      const overlay = document.createElement('div');
      overlay.id = 'staff-call-popup';
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:20000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s;';
      
      const popup = document.createElement('div');
      popup.style.cssText = `
        background:${isBill ? 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)' : 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)'};
        padding:60px;
        border-radius:30px;
        text-align:center;
        box-shadow:0 20px 60px rgba(0,0,0,0.5);
        color:white;
        animation:bounceIn 0.5s;
      `;
      
      const orderNumberHtml = call.orderNumber 
        ? `<div style="font-size:36px;margin-top:20px;font-weight:bold;">注文番号: #${call.orderNumber}</div>` 
        : '';
      
      popup.innerHTML = `
        <div style="font-size:80px;margin-bottom:20px;">${isBill ? "請求" : "電話"}</div>
        <div style="font-size:48px;font-weight:bold;margin-bottom:20px;">
          ${isBill ? 'お会計です' : '呼び出し'}
        </div>
        <div style="font-size:64px;font-weight:bold;background:rgba(255,255,255,0.3);padding:20px;border-radius:15px;margin-bottom:20px;">
          ${call.tableNumber || 'テイクアウト'}
        </div>
        ${orderNumberHtml}
        <button onclick="dismissStaffCallPopup('${call.id}')" style="
          margin-top:30px;
          padding:20px 60px;
          font-size:24px;
          background:white;
          color:${isBill ? '#2196F3' : '#FF9800'};
          border:none;
          border-radius:15px;
          cursor:pointer;
          font-weight:bold;
          box-shadow:0 4px 15px rgba(0,0,0,0.3);
        ">対応完了</button>
      `;
      
      overlay.appendChild(popup);
      document.body.appendChild(overlay);
    }
    
    window.dismissStaffCallPopup = async function(callId) {
      await window.deleteDoc(window.getStoreDoc('staff_calls', callId));
      const popup = document.getElementById('staff-call-popup');
      if (popup) popup.remove();
      showToast(' 対応完了');
    };
    
  </script>
  
  <style>
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
  <div id="customAlert" class="custom-alert-overlay">
    <div class="custom-alert-box">
      <div class="custom-alert-icon" id="customAlertIcon"></div>
      <div class="custom-alert-title" id="customAlertTitle">通知</div>
      <div class="custom-alert-message" id="customAlertMessage"></div>
      <button class="custom-alert-button" onclick="closeCustomAlert()">OK</button>
    </div>
  </div>
  <div id="productRegistrationModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h3>商品登録</h3>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">商品名</label>
        <input type="text" id="productName" placeholder="例: たこ焼き 6個入り" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">価格</label>
        <input type="number" id="productPrice" placeholder="例: 500" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">カテゴリ</label>
        <select id="productCategory" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
          <option value="">選択してください</option>
          <option value="たこ焼き">たこ焼き</option>
          <option value="お好み焼き">お好み焼き</option>
          <option value="焼きそば">焼きそば</option>
          <option value="飲み物">飲み物</option>
          <option value="サイド">サイド</option>
          <option value="その他">その他</option>
        </select>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">カスタムカテゴリ（プルダウンにない場合）</label>
        <input type="text" id="productCustomCategory" placeholder="新しいカテゴリ名" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Note（表示制限）</label>
        <input type="text" id="productNote" placeholder="例: 店内のみ, テイクアウトのみ" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
        <small style="color: #666;">「店内のみ」と入力するとテイクアウトでは非表示、「テイクアウトのみ」と入力すると店内では非表示になります</small>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 10px; font-weight: bold;">消費税率</label>
        <div style="display: flex; gap: 15px;">
          <label style="display: flex; align-items: center; padding: 12px 20px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; flex: 1; background: white;">
            <input type="radio" name="productTaxRate" value="8" style="margin-right: 8px; width: 20px; height: 20px; cursor: pointer;">
            <span style="font-size: 16px; font-weight: bold;">8%（持ち帰り）</span>
          </label>
          <label style="display: flex; align-items: center; padding: 12px 20px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; flex: 1; background: white;">
            <input type="radio" name="productTaxRate" value="10" checked style="margin-right: 8px; width: 20px; height: 20px; cursor: pointer;">
            <span style="font-size: 16px; font-weight: bold;">10%（店内・包材）</span>
          </label>
        </div>
        <small style="color: #666; margin-top: 5px; display: block;">レジ袋などの包材は10%を選択してください</small>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">商品画像をアップロード</label>
        <input type="file" id="productImageFile" accept="image/*" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
        <button type="button" onclick="uploadProductImage()" style="margin-top: 10px; padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;"> アップロード</button>
        <div id="upload-progress" style="margin-top: 10px; font-weight: bold;"></div>
        <div id="image-preview" style="margin-top: 10px;"></div>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">または画像URLを直接入力</label>
        <input type="text" id="productImage" placeholder="例: https://... または takoyaki1.jpg" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
        <small style="color: #666;">アップロードした画像のURLが自動的に入力されます</small>
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <h4 style="margin-bottom: 15px;">トッピングセット</h4>
        <div id="toppingSetsList">
          <!-- トッピングセットがここに追加されます -->
        </div>
        <button onclick="addToppingSetToProduct()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px;">+ トッピングセットを追加</button>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="registerProduct()">登録</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeProductRegistrationModal()">キャンセル</button>
      </div>
    </div>
  </div>
  <div id="productDeleteModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h3>商品削除</h3>
      
      <div style="margin: 20px 0;">
        <input type="text" id="productSearchInput" placeholder="商品名で検索..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 15px;" oninput="filterProductList()">
      </div>
      
      <div id="productDeleteList" style="max-height: 500px; overflow-y: auto;">
        
      </div>
      
      <button class="btn btn-secondary" style="width: 100%; margin-top: 20px;" onclick="closeProductDeleteModal()">閉じる</button>
    </div>
  </div>
  
  <!-- トッピング順序変更モーダル -->
  <div id="toppingOrderModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h3>トッピング順序変更</h3>
      
      <div style="margin: 20px 0;">
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
          ドラッグ＆ドロップまたは↑↓ボタンでトッピングセットの表示順序を変更できます
        </p>
        
        <div id="toppingOrderList" style="display: flex; flex-direction: column; gap: 10px;">
          <!-- トッピングセットのリストがここに表示されます -->
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveToppingOrder()">保存</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeToppingOrderModal()">キャンセル</button>
      </div>
    </div>
  </div>
  
  <!-- 並び順変更モーダル -->
  <div id="sortOrderModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <h3>並び順変更</h3>
      
      <div style="margin: 20px 0;">
        <label style="display: block; font-weight: bold; margin-bottom: 10px;">カテゴリを選択</label>
        <select id="sortCategorySelect" onchange="loadSortProducts()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
          <option value="">カテゴリを選択...</option>
        </select>
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196F3;">
        <div style="font-weight: bold; margin-bottom: 5px;"> 使い方</div>
        <div style="font-size: 14px; color: #666;">
          • 商品をドラッグ&ドロップで並び替え<br>
          • 「保存」ボタンで確定
        </div>
      </div>
      
      <div id="sortProductsList" style="min-height: 200px; margin: 20px 0;">
        <div style="text-align: center; color: #999; padding: 40px;">カテゴリを選択してください</div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveSortOrder()">保存</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeSortOrderModal()">キャンセル</button>
      </div>
    </div>
  </div>

  <!-- テーブル管理モーダル -->
  <div id="tableManagementModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <h3>テーブル管理</h3>
      
      <div style="margin: 20px 0; padding: 15px; background: #e1f5fe; border-radius: 8px; border-left: 4px solid #00BCD4;">
        <div style="font-weight: bold; margin-bottom: 5px;"> テーブルについて</div>
        <div style="font-size: 14px; color: #666;">
          • テーブルごとにQRコードを発行できます<br>
          • お客様がQRコードから注文すると、そのテーブルに注文が届きます<br>
          • テーブル名は英数字のみ使用可能です（例: table1, A01）
        </div>
      </div>
      
      <div style="margin: 20px 0;">
        <button onclick="showAddTableModal()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #00BCD4 0%, #0097A7 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold;"> 新しいテーブルを追加</button>
      </div>
      
      <div style="margin: 20px 0;">
        <h4 style="margin-bottom: 10px;">登録済みテーブル</h4>
        <div id="tablesList" style="max-height: 400px; overflow-y: auto;">
          <div style="text-align: center; color: #999; padding: 20px;">読み込み中...</div>
        </div>
      </div>
      
      <button class="btn btn-secondary" style="width: 100%;" onclick="closeTableManagementModal()">閉じる</button>
    </div>
  </div>

  <!-- テーブル追加モーダル -->
  <div id="addTableModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 600px;">
      <h3>テーブル追加</h3>
      
      <div style="margin: 20px 0;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">テーブル名 *</label>
        <input type="text" id="newTableName" placeholder="例: table1, A01, 予約1" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
        <small style="color: #666;">英数字のみ使用可能（日本語不可）</small>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">スタッフメモ</label>
        <textarea id="newTableStaffMemo" placeholder="予約の詳細、お客様情報など（スタッフ専用）" rows="3" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
        <small style="color: #666;">このメモはスタッフのみ確認できます（お客様には表示されません）</small>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; font-weight: bold; margin-bottom: 10px;">お客様メモ機能</label>
        <div style="display: flex; gap: 20px;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="radio" name="tableMemo" value="true" style="margin-right: 8px;">
            <span>必要</span>
          </label>
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="radio" name="tableMemo" value="false" checked style="margin-right: 8px;">
            <span>不要</span>
          </label>
        </div>
        <small style="color: #666;">お客様が注文時にメモを入力できるようにします</small>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="addTable()">追加</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeAddTableModal()">キャンセル</button>
      </div>
    </div>
  </div>

  <!-- テーブル編集モーダル -->
  <div id="editTableModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 600px;">
      <h3>テーブル編集</h3>
      
      <input type="hidden" id="editTableId">
      
      <div style="margin: 20px 0;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">テーブル名 *</label>
        <input type="text" id="editTableName" placeholder="例: table1, A01, 予約1" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
        <small style="color: #666;">英数字のみ使用可能（日本語不可）</small>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">スタッフメモ</label>
        <textarea id="editTableStaffMemo" placeholder="予約の詳細、お客様情報など（スタッフ専用）" rows="3" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
        <small style="color: #666;">このメモはスタッフのみ確認できます（お客様には表示されません）</small>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; font-weight: bold; margin-bottom: 10px;">お客様メモ機能</label>
        <div style="display: flex; gap: 20px;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="radio" name="editTableMemo" value="true" style="margin-right: 8px;">
            <span>必要</span>
          </label>
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="radio" name="editTableMemo" value="false" style="margin-right: 8px;">
            <span>不要</span>
          </label>
        </div>
        <small style="color: #666;">お客様が注文時にメモを入力できるようにします</small>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveTableEdit()">保存</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditTableModal()">キャンセル</button>
      </div>
    </div>
  </div>

  <!-- QRコード表示モーダル -->
  <div id="qrCodeModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 500px; text-align: center;">
      <h3 id="qrTableName">テーブル</h3>
      
      <div style="margin: 30px 0;">
        <div id="qrCodeContainer" style="display: flex; justify-content: center;"></div>
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px;">
        <div style="font-weight: bold; margin-bottom: 5px;">注文URL</div>
        <div id="qrTableUrl" style="word-break: break-all; color: #666; font-size: 14px;"></div>
      </div>
      
      <button class="btn btn-secondary" style="width: 100%;" onclick="closeQrCodeModal()">閉じる</button>
    </div>
  </div>

  <!-- テーブルメモモーダル -->
  <div id="tableMemoModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 600px;">
      <h3> スタッフメモ - <span id="memoTableName"></span></h3>
      
      <input type="hidden" id="memoTableId">
      
      <div style="margin: 20px 0;">
        <textarea id="memoTableStaffMemo" placeholder="予約の詳細、お客様情報など（スタッフ専用）" rows="5" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
        <small style="color: #666;">このメモはスタッフのみ確認できます（お客様には表示されません）</small>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveTableMemo()">保存</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeTableMemoModal()">キャンセル</button>
      </div>
    </div>
  </div>
  
  <!-- 削除確認モーダル -->
  <div id="deleteConfirmModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 500px;">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 60px; margin-bottom: 10px;">!</div>
        <h3 style="margin: 0; font-size: 24px; color: #f44336;">テーブルを削除しますか？</h3>
      </div>
      
      <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; margin: 20px 0;">
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #333;">
          <span id="deleteTableName"></span>
        </div>
        <div style="color: #666; line-height: 1.8;">
          このテーブルのQRコードは使用できなくなります<br>
          この操作は取り消せません
        </div>
      </div>
      
      <input type="hidden" id="deleteTableId">
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeDeleteConfirmModal()">キャンセル</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="confirmDeleteTable()">️ 削除する</button>
      </div>
    </div>
  </div>

  <!-- ログアウト確認モーダル -->
  <div id="logoutConfirmModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 500px;">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 60px; margin-bottom: 10px;"></div>
        <h3 style="margin: 0; font-size: 24px; color: #667eea;">ログアウトしますか？</h3>
      </div>
      
      <div style="background: #e3f2fd; border: 2px solid #2196F3; border-radius: 10px; padding: 20px; margin: 20px 0;">
        <div style="color: #666; line-height: 1.8; text-align: center;">
          ログアウトすると、再度ログインが必要になります
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeLogoutConfirmModal()">キャンセル</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="confirmLogout()">ログアウト</button>
      </div>
    </div>
  </div>

  <!-- 金額変更モーダル -->
  <div id="priceChangeModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 500px;">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 50px; margin-bottom: 10px;"></div>
        <h3 style="margin: 0; font-size: 20px; color: #333;" id="priceChangeTitle">金額を入力してください</h3>
      </div>
      
      <div style="background: #f5f5f5; border-radius: 10px; padding: 15px; margin: 20px 0; text-align: center;">
        <div style="color: #666; margin-bottom: 10px;" id="priceChangeItemInfo"></div>
        <div style="font-size: 18px; font-weight: bold; color: #333;">
          現在: <span id="priceChangeCurrentPrice"></span>
        </div>
      </div>
      
      <div style="margin: 20px 0;">
        <input type="number" id="priceChangeInput" placeholder="新しい金額を入力" style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 24px; text-align: center;">
      </div>
      
      <input type="hidden" id="priceChangeItemId">
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="closePriceChangeModal()">キャンセル</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="confirmPriceChange()"> 変更</button>
      </div>
    </div>
  </div>

  <!-- 商品編集モーダル -->
  <div id="productEditModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
      <h3>商品編集</h3>
      
      <input type="hidden" id="editProductId">
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">商品名 *</label>
        <input type="text" id="editProductName" placeholder="商品名を入力" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">価格 *</label>
        <input type="number" id="editProductPrice" placeholder="価格を入力" min="0" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">カテゴリ *</label>
        <input type="text" id="editProductCategory" placeholder="カテゴリを入力" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">トッピングセット</label>
        <div id="editToppingDiagnostic"></div>
        <div id="editToppingSetsContainer"></div>
        <button type="button" onclick="addEditToppingSet()" style="padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px;">+ トッピングセット追加</button>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">備考</label>
        <textarea id="editProductNote" placeholder="備考を入力" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; min-height: 80px;"></textarea>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 10px; font-weight: bold;">消費税率</label>
        <div style="display: flex; gap: 15px;">
          <label style="display: flex; align-items: center; padding: 12px 20px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; flex: 1; background: white;">
            <input type="radio" name="editProductTaxRate" value="8" style="margin-right: 8px; width: 20px; height: 20px; cursor: pointer;">
            <span style="font-size: 16px; font-weight: bold;">8%（持ち帰り）</span>
          </label>
          <label style="display: flex; align-items: center; padding: 12px 20px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; flex: 1; background: white;">
            <input type="radio" name="editProductTaxRate" value="10" style="margin-right: 8px; width: 20px; height: 20px; cursor: pointer;">
            <span style="font-size: 16px; font-weight: bold;">10%（店内・包材）</span>
          </label>
        </div>
        <small style="color: #666; margin-top: 5px; display: block;">レジ袋などの包材は10%を選択してください</small>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">商品画像をアップロード</label>
        <input type="file" id="editProductImageFile" accept="image/*" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
        <button type="button" onclick="uploadEditProductImage()" style="margin-top: 10px; padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;"> アップロード</button>
        <div id="edit-upload-progress" style="margin-top: 10px; font-weight: bold;"></div>
        <div id="edit-image-preview" style="margin-top: 10px;"></div>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">または画像URLを直接入力</label>
        <input type="text" id="editProductImage" placeholder="例: https://... または takoyaki1.jpg" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white;" onclick="saveEditedProduct()">️ 更新</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditProductModal()">キャンセル</button>
      </div>
    </div>
  </div>
  
  <div id="page-soldout" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 10000; padding: 20px; overflow-y: auto;">
    <div style="max-width: 1200px; margin: 0 auto;">
      <button onclick="backFromSoldOut()" style="padding: 15px 30px; font-size: 18px; background: #FFFF00; color: #333; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">← 戻る</button>
      
      <div style="background: white; color: #667eea; padding: 15px 20px; border-radius: 15px; margin-bottom: 15px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
        <h1 style="font-size: 20px; font-weight: bold; margin: 0;">品切れ設定</h1>
      </div>
      
      <div style="background: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <label style="display: block; font-size: 16px; font-weight: bold; margin-bottom: 10px;">カテゴリを選んでください</label>
        <select id="soldout-category-select" style="width: 100%; padding: 15px; font-size: 18px; border: 3px solid #9C27B0; border-radius: 12px;">
          <option value="">全ての商品</option>
        </select>
      </div>
      
      <div id="soldout-menu-list"></div>
    </div>
  </div>
  
  </div> 
  
  <script>
    // ========== 商品登録・削除機能 ==========
    
    // トッピングセットの管理用配列
    let productToppingSets = [];
    
    // 商品登録モーダルを表示
    window.showProductRegistrationModal = function() {
      document.getElementById('productRegistrationModal').classList.remove('hidden');
      
      // フォームをクリア
      document.getElementById('productName').value = '';
      document.getElementById('productPrice').value = '';
      document.getElementById('productCategory').value = 'メイン';
      document.getElementById('productCustomCategory').value = '';
      document.getElementById('productNote').value = '';
      document.getElementById('productImage').value = '';
      
      // 税率をデフォルト（10%）に設定
      const taxRateRadios = document.querySelectorAll('input[name="productTaxRate"]');
      taxRateRadios.forEach(radio => {
        radio.checked = (radio.value === '10');
      });
      
      // トッピングセットリストをクリア
      productToppingSets = [];
      const toppingSetsList = document.getElementById('toppingSetsList');
      if (toppingSetsList) {
        toppingSetsList.innerHTML = '';
      }
      
      console.log(' 商品登録モーダルを開きました（すべてクリア済み）');
    };
    
    // 商品登録モーダルを閉じる
    window.closeProductRegistrationModal = function() {
      document.getElementById('productRegistrationModal').classList.add('hidden');
      
      // 入力フィールドをクリア
      document.getElementById('productName').value = '';
      document.getElementById('productPrice').value = '';
      document.getElementById('productCategory').value = 'メイン';
      document.getElementById('productCustomCategory').value = '';
      document.getElementById('productNote').value = '';
      document.getElementById('productImage').value = '';
      
      // 税率をデフォルトに戻す
      const taxRateRadios = document.querySelectorAll('input[name="productTaxRate"]');
      taxRateRadios.forEach(radio => {
        radio.checked = (radio.value === '10');
      });
      
      // トッピングセットリストをクリア
      const toppingSetsList = document.getElementById('toppingSetsList');
      if (toppingSetsList) {
        toppingSetsList.innerHTML = '';
      }
      productToppingSets = [];
      
      console.log(' 商品登録モーダルをクリアしました');
    };
    
    // トッピングセットを追加
    window.addToppingSetToProduct = function() {
      const setDiv = document.createElement('div');
      setDiv.style.cssText = 'margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #ddd;';
      const setIndex = productToppingSets.length;
      
      setDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h5 style="margin: 0;">トッピングセット ${setIndex + 1}</h5>
          <button onclick="removeToppingSet(${setIndex})" style="padding: 5px 10px; background: #F44336; color: white; border: none; border-radius: 4px; cursor: pointer;">削除</button>
        </div>
        
        <div style="margin-bottom: 10px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">セット名</label>
          <input type="text" class="topping-set-name" placeholder="例: たこ焼きの味" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
        </div>
        
        <div style="margin-bottom: 10px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">選択タイプ</label>
          <select class="topping-set-type" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
            <option value="single">単一選択（プルダウン）</option>
            <option value="multiple">複数選択（チェックボックス）</option>
          </select>
        </div>
        
        <div style="margin-bottom: 10px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">トッピング項目</label>
          <div class="topping-options-list" style="margin-bottom: 10px;">
            <!-- トッピング項目がここに追加されます -->
          </div>
          <button onclick="addToppingOption(${setIndex})" style="padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">+ 項目を追加</button>
        </div>
      `;
      
      document.getElementById('toppingSetsList').appendChild(setDiv);
      productToppingSets.push({ options: [] });
      
      // 初期項目を1つ追加
      addToppingOption(setIndex);
    };
    
    // トッピングセットを削除
    window.removeToppingSet = function(index) {
      productToppingSets.splice(index, 1);
      renderToppingSets();
    };
    
    // トッピング項目を追加
    window.addToppingOption = function(setIndex) {
      const optionsList = document.getElementById('toppingSetsList').children[setIndex].querySelector('.topping-options-list');
      const optionDiv = document.createElement('div');
      optionDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 8px; align-items: center;';
      optionDiv.innerHTML = `
        <input type="text" class="topping-option-name" placeholder="例: ソース" style="flex: 2; padding: 6px; border: 2px solid #ddd; border-radius: 4px;">
        <input type="number" class="topping-option-price" placeholder="価格" value="0" style="flex: 1; padding: 6px; border: 2px solid #ddd; border-radius: 4px;">
        <button onclick="this.parentElement.remove()" style="padding: 6px 10px; background: #F44336; color: white; border: none; border-radius: 4px; cursor: pointer;">×</button>
      `;
      optionsList.appendChild(optionDiv);
    };
    
    // トッピングセットを再描画（入力内容を保持）
    function renderToppingSets() {
      const container = document.getElementById('toppingSetsList');
      
      // 現在の入力内容を保存
      const currentData = [];
      const setDivs = container.children;
      
      for (let i = 0; i < setDivs.length; i++) {
        const setDiv = setDivs[i];
        const setData = {
          name: setDiv.querySelector('.topping-set-name')?.value || '',
          type: setDiv.querySelector('.topping-set-type')?.value || 'single',
          options: []
        };
        
        const optionDivs = setDiv.querySelectorAll('.topping-options-list > div');
        optionDivs.forEach(optionDiv => {
          setData.options.push({
            name: optionDiv.querySelector('.topping-option-name')?.value || '',
            price: optionDiv.querySelector('.topping-option-price')?.value || '0'
          });
        });
        
        currentData.push(setData);
      }
      
      // コンテナをクリア
      container.innerHTML = '';
      
      // 保存したデータを使って再構築
      currentData.forEach((setData, setIndex) => {
        const setDiv = document.createElement('div');
        setDiv.style.cssText = 'margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #ddd;';
        
        setDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h5 style="margin: 0;">トッピングセット ${setIndex + 1}</h5>
            <button onclick="removeToppingSet(${setIndex})" style="padding: 5px 10px; background: #F44336; color: white; border: none; border-radius: 4px; cursor: pointer;">削除</button>
          </div>
          
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">セット名</label>
            <input type="text" class="topping-set-name" placeholder="例: たこ焼きの味" value="${setData.name}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
          </div>
          
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">選択タイプ</label>
            <select class="topping-set-type" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
              <option value="single" ${setData.type === 'single' ? 'selected' : ''}>単一選択（プルダウン）</option>
              <option value="multiple" ${setData.type === 'multiple' ? 'selected' : ''}>複数選択（チェックボックス）</option>
            </select>
          </div>
          
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">トッピング項目</label>
            <div class="topping-options-list" style="margin-bottom: 10px;">
              <!-- トッピング項目がここに追加されます -->
            </div>
            <button onclick="addToppingOption(${setIndex})" style="padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">+ 項目を追加</button>
          </div>
        `;
        
        container.appendChild(setDiv);
        
        // オプションを追加
        const optionsList = setDiv.querySelector('.topping-options-list');
        setData.options.forEach(option => {
          const optionDiv = document.createElement('div');
          optionDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 8px; align-items: center;';
          optionDiv.innerHTML = `
            <input type="text" class="topping-option-name" placeholder="例: ソース" value="${option.name}" style="flex: 2; padding: 6px; border: 2px solid #ddd; border-radius: 4px;">
            <input type="number" class="topping-option-price" placeholder="価格" value="${option.price}" style="flex: 1; padding: 6px; border: 2px solid #ddd; border-radius: 4px;">
            <button onclick="this.parentElement.remove()" style="padding: 6px 10px; background: #F44336; color: white; border: none; border-radius: 4px; cursor: pointer;">×</button>
          `;
          optionsList.appendChild(optionDiv);
        });
      });
    }
    
    // ========== 画像アップロード機能 ==========
    
    // 商品登録用の画像アップロード
    window.uploadProductImage = async function() {
      const fileInput = document.getElementById('productImageFile');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('画像を選択してください');
        return;
      }
      
      const progressDiv = document.getElementById('upload-progress');
      const previewDiv = document.getElementById('image-preview');
      progressDiv.textContent = ' アップロード中...';
      progressDiv.style.color = '#2196F3';
      
      try {
        // Firebase Storageにアップロード
        const timestamp = Date.now();
        const fileName = `${timestamp}_${file.name}`;
        const storageReference = window.storageRef(window.storage, `products/${fileName}`);
        
        await window.uploadBytes(storageReference, file);
        
        // URLを取得
        const imageUrl = await window.getDownloadURL(storageReference);
        
        // 商品画像フィールドに自動入力
        document.getElementById('productImage').value = imageUrl;
        
        // プレビュー表示
        previewDiv.innerHTML = `<img src="${imageUrl}" style="max-width: 200px; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">`;
        
        progressDiv.textContent = 'アップロード完了';
        progressDiv.style.color = '#4CAF50';
        
        setTimeout(() => {
          progressDiv.textContent = '';
        }, 3000);
      } catch (error) {
        console.error('アップロードエラー:', error);
        progressDiv.textContent = 'アップロード失敗: ' + error.message;
        progressDiv.style.color = '#f44336';
      }
    };
    
    // 商品編集用の画像アップロード
    window.uploadEditProductImage = async function() {
      const fileInput = document.getElementById('editProductImageFile');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('画像を選択してください');
        return;
      }
      
      const progressDiv = document.getElementById('edit-upload-progress');
      const previewDiv = document.getElementById('edit-image-preview');
      progressDiv.textContent = ' アップロード中...';
      progressDiv.style.color = '#2196F3';
      
      try {
        // Firebase Storageにアップロード
        const timestamp = Date.now();
        const fileName = `${timestamp}_${file.name}`;
        const storageReference = window.storageRef(window.storage, `products/${fileName}`);
        
        await window.uploadBytes(storageReference, file);
        
        // URLを取得
        const imageUrl = await window.getDownloadURL(storageReference);
        
        // 商品画像フィールドに自動入力
        document.getElementById('editProductImage').value = imageUrl;
        
        // プレビュー表示
        previewDiv.innerHTML = `<img src="${imageUrl}" style="max-width: 200px; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">`;
        
        progressDiv.textContent = 'アップロード完了';
        progressDiv.style.color = '#4CAF50';
        
        setTimeout(() => {
          progressDiv.textContent = '';
        }, 3000);
      } catch (error) {
        console.error('アップロードエラー:', error);
        progressDiv.textContent = 'アップロード失敗: ' + error.message;
        progressDiv.style.color = '#f44336';
      }
    };
    
    // 商品を登録
    window.registerProduct = async function() {
      const name = document.getElementById('productName').value.trim();
      const price = parseInt(document.getElementById('productPrice').value);
      const category = document.getElementById('productCategory').value;
      const customCategory = document.getElementById('productCustomCategory').value.trim();
      const note = document.getElementById('productNote').value.trim();
      const image = document.getElementById('productImage').value.trim();
      
      // 税率を取得
      const taxRateRadio = document.querySelector('input[name="productTaxRate"]:checked');
      const taxRate = taxRateRadio ? parseInt(taxRateRadio.value) : 10;
      
      // バリデーション
      if (!name) {
        alert('商品名を入力してください');
        return;
      }
      
      if (!price || price < 0) {
        alert('正しい価格を入力してください');
        return;
      }
      
      const finalCategory = customCategory || category;
      if (!finalCategory) {
        alert('カテゴリを選択するか、カスタムカテゴリを入力してください');
        return;
      }
      
      // トッピングセットを収集
      const toppingSets = [];
      const setDivs = document.getElementById('toppingSetsList').children;
      
      for (let i = 0; i < setDivs.length; i++) {
        const setDiv = setDivs[i];
        const setName = setDiv.querySelector('.topping-set-name').value.trim();
        const setType = setDiv.querySelector('.topping-set-type').value;
        
        if (!setName) continue; // 名前がない場合はスキップ
        
        const options = [];
        const optionDivs = setDiv.querySelectorAll('.topping-options-list > div');
        
        optionDivs.forEach(optionDiv => {
          const optionName = optionDiv.querySelector('.topping-option-name').value.trim();
          const optionPrice = parseInt(optionDiv.querySelector('.topping-option-price').value) || 0;
          
          if (optionName) {
            options.push({ name: optionName, price: optionPrice });
          }
        });
        
        if (options.length > 0) {
          toppingSets.push({
            name: setName,
            type: setType,
            options: options
          });
        }
      }
      
      try {
        console.log(' 商品登録開始');
        console.log('  toppingSets:', toppingSets);
        
        // トッピングをtoppingsコレクションに登録してIDを取得
        const toppingIds = [];
        
        if (toppingSets.length > 0) {
          console.log(' トッピングセットあり、toppingsコレクションに登録開始');
          
          // 最新のトッピングIDを取得
          const toppingsSnapshot = await window.getDocs(window.getStoreCollection('toppings'));
          let maxNum = 15; // T0016から開始
          
          toppingsSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.id && data.id.startsWith('T')) {
              const num = parseInt(data.id.substring(1));
              if (num > maxNum) maxNum = num;
            }
          });
          
          console.log('  現在の最大トッピング番号:', maxNum);
          
          // 各トッピングセットのオプションをtoppingsに登録
          for (const set of toppingSets) {
            console.log('  セット:', set.name);
            for (const option of set.options) {
              maxNum++;
              const toppingId = 'T' + String(maxNum).padStart(4, '0');
              
              console.log('    登録:', toppingId, option.name, option.price);
              
              await window.addDoc(window.getStoreCollection('toppings'), {
                id: toppingId,
                name: option.name,
                price: option.price,
                order: maxNum
              });
              
              toppingIds.push(toppingId);
            }
          }
          
          console.log('  登録完了。toppingIds:', toppingIds);
        } else {
          console.log(' トッピングセットなし');
        }
        
        // 既存のメニューから最大IDを取得
        const menusSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        let maxMenuNum = 0;
        let maxOrder = 0;
        
        menusSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.id) {
            // 既存のIDフォーマットに応じて処理
            const match = data.id.match(/\d+$/);
            if (match) {
              const num = parseInt(match[0]);
              if (num > maxMenuNum) maxMenuNum = num;
            }
          }
          // orderフィールドの最大値も取得
          if (data.order && data.order > maxOrder) {
            maxOrder = data.order;
          }
        });
        
        // 新しいIDを生成（M0001形式）
        maxMenuNum++;
        const productId = 'M' + String(maxMenuNum).padStart(4, '0');
        
        // 新しいorder値を生成
        maxOrder++;
        
        // Firebaseに商品を追加
        const productData = {
          id: productId,  // IDフィールドを追加
          name: name,
          price: price,
          category: finalCategory,
          toppingSets: toppingSets,
          toppingsId: toppingIds.join(','), // カンマ区切りで保存
          note: note,
          image: image || '',
          taxRate: taxRate,  // 選択した税率を保存
          order: maxOrder,  // 表示順フィールドを追加
          createdAt: window.Timestamp.now()
        };
        
        console.log(' 商品データ:', productData);
        console.log('  toppingsId:', productData.toppingsId);
        
        await window.addDoc(window.getStoreCollection('menus'), productData);
        
        await showCustomAlert('商品を登録しました');
        
        // トッピングセットリストを確実にクリア
        const toppingSetsList = document.getElementById('toppingSetsList');
        if (toppingSetsList) {
          toppingSetsList.innerHTML = '';
        }
        productToppingSets = [];
        console.log(' トッピングセットリストをクリアしました');
        
        closeProductRegistrationModal();
        
        // メニューを再読み込み
        await initializeSystem();
        
      } catch (error) {
        console.error('商品登録エラー:', error);
        await showCustomAlert('商品の登録に失敗しました\n\n' + error.message);
      }
    };
    
    // 商品削除モーダルを表示
    window.showProductDeleteModal = async function() {
      document.getElementById('productDeleteModal').classList.remove('hidden');
      await loadProductDeleteList();
    };
    
    // 商品削除モーダルを閉じる
    window.closeProductDeleteModal = function() {
      document.getElementById('productDeleteModal').classList.add('hidden');
    };
    
    // 削除用の商品リストを読み込み
    let allProductsForDelete = [];
    async function loadProductDeleteList() {
      try {
        const container = document.getElementById('productDeleteList');
        container.innerHTML = '<div style="text-align: center; padding: 20px;">読み込み中...</div>';
        
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        allProductsForDelete = [];
        
        menuSnapshot.forEach(doc => {
          allProductsForDelete.push({
            docId: doc.id,  // FirebaseのドキュメントID
            ...doc.data()
          });
        });
        
        // カテゴリ別にソート
        allProductsForDelete.sort((a, b) => {
          if (a.category !== b.category) {
            return a.category.localeCompare(b.category);
          }
          return a.name.localeCompare(b.name);
        });
        
        displayProductDeleteList(allProductsForDelete);
        
      } catch (error) {
        console.error('商品リスト読み込みエラー:', error);
        document.getElementById('productDeleteList').innerHTML = '<div style="text-align: center; padding: 20px; color: red;">読み込みに失敗しました</div>';
      }
    }
    
    // 商品削除リストを表示
    function displayProductDeleteList(products) {
      const container = document.getElementById('productDeleteList');
      
      if (products.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">商品がありません</div>';
        return;
      }
      
      container.innerHTML = '';
      
      products.forEach(product => {
        const productDiv = document.createElement('div');
        productDiv.style.cssText = 'padding: 15px; margin-bottom: 10px; background: white; border-radius: 8px; border: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;';
        
        const infoDiv = document.createElement('div');
        infoDiv.innerHTML = `
          <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${product.name}</div>
          <div style="color: #666; font-size: 14px;">
            <span style="background: #E3F2FD; padding: 2px 8px; border-radius: 4px; margin-right: 10px;">${product.category}</span>
            <span style="color: #4CAF50; font-weight: bold;">¥${product.price.toLocaleString()}</span>
          </div>
        `;
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '️ 削除';
        deleteBtn.style.cssText = 'padding: 8px 20px; background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-left: 10px;';
        deleteBtn.onclick = () => deleteProduct(product.docId, product.name);
        
        const editBtn = document.createElement('button');
        editBtn.textContent = '️ 編集';
        editBtn.style.cssText = 'padding: 8px 20px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;';
        editBtn.onclick = () => openEditProductModal(product);
        
        const orderBtn = document.createElement('button');
        orderBtn.textContent = ' 順序';
        orderBtn.style.cssText = 'padding: 8px 20px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;';
        orderBtn.onclick = () => openToppingOrderForProduct(product);
        
        const btnContainer = document.createElement('div');
        btnContainer.style.cssText = 'display: flex; gap: 10px;';
        btnContainer.appendChild(orderBtn);
        btnContainer.appendChild(editBtn);
        btnContainer.appendChild(deleteBtn);
        
        productDiv.appendChild(infoDiv);
        productDiv.appendChild(btnContainer);
        container.appendChild(productDiv);
      });
    }
    
    // ========== 並び順変更機能 ==========
    
    let sortProducts = [];
    let draggedElement = null;
    
    // 並び順変更モーダルを表示
    window.showSortOrderModal = async function() {
      document.getElementById('sortOrderModal').classList.remove('hidden');
      await loadSortCategories();
    };
    
    // 並び順変更モーダルを閉じる
    window.closeSortOrderModal = function() {
      document.getElementById('sortOrderModal').classList.add('hidden');
      sortProducts = [];
      document.getElementById('sortProductsList').innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">カテゴリを選択してください</div>';
    };
    
    // ========== テーブル管理機能 ==========
    
    // テーブル管理モーダルを開く
    window.showTableManagementModal = async function() {
      document.getElementById('tableManagementModal').classList.remove('hidden');
      await loadTablesList();
    };
    
    // テーブル管理モーダルを閉じる
    window.closeTableManagementModal = function() {
      document.getElementById('tableManagementModal').classList.add('hidden');
    };
    
    // ログアウト関数
    window.logout = function() {
      // カスタムログアウト確認モーダルを表示
      document.getElementById('logoutConfirmModal').classList.remove('hidden');
    };
    
    // ログアウト確認モーダルを閉じる
    window.closeLogoutConfirmModal = function() {
      document.getElementById('logoutConfirmModal').classList.add('hidden');
    };
    
    // ログアウトを確定
    window.confirmLogout = async function() {
      closeLogoutConfirmModal();
      
      try {
        await window.signOut(window.auth);
        // ログインページにリダイレクト
        window.location.href = 'index.html';
      } catch (error) {
        console.error('ログアウトエラー:', error);
        showErrorMessage('ログアウトに失敗しました: ' + error.message);
      }
    };
    
    // 金額変更モーダルを閉じる
    window.closePriceChangeModal = function() {
      document.getElementById('priceChangeModal').classList.add('hidden');
    };
    
    // 金額変更を確定
    window.confirmPriceChange = function() {
      const index = document.getElementById('priceChangeItemId').value;
      const newPrice = document.getElementById('priceChangeInput').value;
      
      if (!newPrice || newPrice === '') {
        showErrorMessage('金額を入力してください');
        return;
      }
      
      const numPrice = parseInt(newPrice);
      if (isNaN(numPrice) || numPrice < 0) {
        showErrorMessage('正しい金額を入力してください');
        return;
      }
      
      // 金額表示を更新
      document.getElementById(`itemPrice${index}`).textContent = `¥${numPrice.toLocaleString()}`;
      
      // ラジオボタンのdata-amountを更新
      document.querySelectorAll(`input[name="taxRate${index}"]`).forEach(radio => {
        radio.dataset.amount = numPrice;
      });
      
      // 税率別集計と請求額を再計算
      calculateTaxSummary();
      
      console.log(`商品${index}の金額を変更: ¥${numPrice}`);
      
      closePriceChangeModal();
      showSuccessMessage('金額を変更しました');
    };
    
    // テーブル一覧を読み込み
    async function loadTablesList() {
      try {
        const container = document.getElementById('tablesList');
        container.innerHTML = '<div style="text-align: center; padding: 20px;">読み込み中...</div>';
        
        const tablesSnapshot = await window.getDocs(window.getStoreCollection('tables'));
        const tables = [];
        
        tablesSnapshot.forEach(doc => {
          tables.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // orderフィールドでソート（orderがない場合は名前でソート）
        tables.sort((a, b) => {
          const orderA = a.order || 0;
          const orderB = b.order || 0;
          if (orderA !== orderB) {
            return orderA - orderB;
          }
          return a.name.localeCompare(b.name);
        });
        
        if (tables.length === 0) {
          container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">テーブルが登録されていません</div>';
          return;
        }
        
        container.innerHTML = '';
        
        tables.forEach(table => {
          const tableDiv = document.createElement('div');
          tableDiv.style.cssText = 'padding: 15px; margin-bottom: 10px; background: white; border-radius: 8px; border: 2px solid #00BCD4; display: flex; justify-content: space-between; align-items: center;';
          
          const infoDiv = document.createElement('div');
          infoDiv.innerHTML = `
            <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${table.name}</div>
            <div style="color: #666; font-size: 14px;">
              <span style="background: ${table.memoEnabled ? '#E8F5E9' : '#FFEBEE'}; padding: 2px 8px; border-radius: 4px; margin-right: 10px;">
                ${table.memoEnabled ? ' メモ機能: ON' : ' メモ機能: OFF'}
              </span>
            </div>
          `;
          
          const buttonContainer = document.createElement('div');
          buttonContainer.style.cssText = 'display: flex; gap: 10px;';
          
          // QRコード表示ボタン
          const qrBtn = document.createElement('button');
          qrBtn.textContent = 'QR';
          qrBtn.style.cssText = 'padding: 8px 20px; background: linear-gradient(135deg, #00BCD4 0%, #0097A7 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;';
          qrBtn.onclick = () => showQrCode(table.name);
          
          // 編集ボタン
          const editBtn = document.createElement('button');
          editBtn.textContent = '編集';
          editBtn.style.cssText = 'padding: 8px 20px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;';
          editBtn.onclick = () => showEditTableModal(table);
          
          // 削除ボタン
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = '削除';
          deleteBtn.style.cssText = 'padding: 8px 20px; background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;';
          deleteBtn.onclick = () => deleteTable(table.id, table.name);
          
          buttonContainer.appendChild(qrBtn);
          buttonContainer.appendChild(editBtn);
          buttonContainer.appendChild(deleteBtn);
          
          tableDiv.appendChild(infoDiv);
          tableDiv.appendChild(buttonContainer);
          container.appendChild(tableDiv);
        });
        
      } catch (error) {
        console.error('テーブル一覧読み込みエラー:', error);
        document.getElementById('tablesList').innerHTML = '<div style="text-align: center; color: red; padding: 20px;">読み込みに失敗しました</div>';
      }
    }
    
    // テーブル追加モーダルを開く
    window.showAddTableModal = function() {
      document.getElementById('newTableName').value = '';
      document.getElementById('newTableStaffMemo').value = '';
      document.querySelector('input[name="tableMemo"][value="false"]').checked = true;
      document.getElementById('addTableModal').classList.remove('hidden');
    };
    
    // テーブル追加モーダルを閉じる
    window.closeAddTableModal = function() {
      document.getElementById('addTableModal').classList.add('hidden');
    };
    
    // テーブルを追加
    window.addTable = async function() {
      const name = document.getElementById('newTableName').value.trim();
      const staffMemo = document.getElementById('newTableStaffMemo').value.trim();
      const memoEnabled = document.querySelector('input[name="tableMemo"]:checked').value === 'true';
      
      // バリデーション
      if (!name) {
        alert('テーブル名を入力してください');
        return;
      }
      
      // 英数字のみチェック
      if (!/^[a-zA-Z0-9]+$/.test(name)) {
        alert('テーブル名は英数字のみ使用可能です（日本語不可）');
        return;
      }
      
      try {
        // 同じ名前のテーブルが存在するかチェック
        const tablesSnapshot = await window.getDocs(window.getStoreCollection('tables'));
        let exists = false;
        tablesSnapshot.forEach(doc => {
          if (doc.data().name === name) {
            exists = true;
          }
        });
        
        if (exists) {
          alert('同じ名前のテーブルが既に存在します');
          return;
        }
        
        // テーブルを追加
        await window.addDoc(window.getStoreCollection('tables'), {
          name: name,
          staffMemo: staffMemo,
          memoEnabled: memoEnabled,
          createdAt: window.Timestamp.now()
        });
        
        alert(`テーブル「${name}」を追加しました`);
        closeAddTableModal();
        await loadTablesList();
        await loadTableButtons(); // テーブルボタンを再読み込み
        
      } catch (error) {
        console.error('テーブル追加エラー:', error);
        alert('テーブルの追加に失敗しました: ' + error.message);
      }
    };
    
    // テーブル編集モーダルを開く
    window.showEditTableModal = function(table) {
      document.getElementById('editTableId').value = table.id;
      document.getElementById('editTableName').value = table.name;
      document.getElementById('editTableStaffMemo').value = table.staffMemo || '';
      
      const memoRadios = document.querySelectorAll('input[name="editTableMemo"]');
      memoRadios.forEach(radio => {
        if (radio.value === String(table.memoEnabled)) {
          radio.checked = true;
        }
      });
      
      document.getElementById('editTableModal').classList.remove('hidden');
    };
    
    // テーブル編集モーダルを閉じる
    window.closeEditTableModal = function() {
      document.getElementById('editTableModal').classList.add('hidden');
    };
    
    // テーブル編集を保存
    window.saveTableEdit = async function() {
      const id = document.getElementById('editTableId').value;
      const name = document.getElementById('editTableName').value.trim();
      const staffMemo = document.getElementById('editTableStaffMemo').value.trim();
      const memoEnabled = document.querySelector('input[name="editTableMemo"]:checked').value === 'true';
      
      // バリデーション
      if (!name) {
        alert('テーブル名を入力してください');
        return;
      }
      
      // 英数字のみチェック
      if (!/^[a-zA-Z0-9]+$/.test(name)) {
        alert('テーブル名は英数字のみ使用可能です（日本語不可）');
        return;
      }
      
      try {
        // 同じ名前のテーブルが存在するかチェック（自分以外）
        const tablesSnapshot = await window.getDocs(window.getStoreCollection('tables'));
        let exists = false;
        tablesSnapshot.forEach(doc => {
          if (doc.id !== id && doc.data().name === name) {
            exists = true;
          }
        });
        
        if (exists) {
          alert('同じ名前のテーブルが既に存在します');
          return;
        }
        
        // テーブルを更新
        await window.updateDoc(window.getStoreDoc('tables', id), {
          name: name,
          staffMemo: staffMemo,
          memoEnabled: memoEnabled,
          updatedAt: window.Timestamp.now()
        });
        
        alert(`テーブル「${name}」を更新しました`);
        closeEditTableModal();
        await loadTablesList();
        await loadTableButtons(); // テーブルボタンを再読み込み
        
      } catch (error) {
        console.error('テーブル更新エラー:', error);
        alert('テーブルの更新に失敗しました: ' + error.message);
      }
    };
    
    // テーブルを削除
    async function deleteTable(id, name) {
      // カスタム削除確認モーダルを表示
      document.getElementById('deleteTableId').value = id;
      document.getElementById('deleteTableName').textContent = `テーブル「${name}」`;
      document.getElementById('deleteConfirmModal').classList.remove('hidden');
    }
    
    // 削除確認モーダルを閉じる
    window.closeDeleteConfirmModal = function() {
      document.getElementById('deleteConfirmModal').classList.add('hidden');
    };
    
    // 削除を確定
    window.confirmDeleteTable = async function() {
      const id = document.getElementById('deleteTableId').value;
      const name = document.getElementById('deleteTableName').textContent.replace('テーブル「', '').replace('」', '');
      
      closeDeleteConfirmModal();
      
      try {
        await window.deleteDoc(window.getStoreDoc('tables', id));
        
        // 成功メッセージをオシャレに表示
        showSuccessMessage(`テーブル「${name}」を削除しました`);
        
        await loadTablesList();
        await loadTableButtons(); // テーブルボタンを再読み込み
        
      } catch (error) {
        console.error('テーブル削除エラー:', error);
        showErrorMessage('テーブルの削除に失敗しました: ' + error.message);
      }
    };
    
    // 成功メッセージを表示
    function showSuccessMessage(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        z-index: 10000;
        font-size: 16px;
        font-weight: bold;
        animation: slideIn 0.3s ease-out;
      `;
      toast.innerHTML = `${message}`;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // エラーメッセージを表示
    function showErrorMessage(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        z-index: 10000;
        font-size: 16px;
        font-weight: bold;
        animation: slideIn 0.3s ease-out;
      `;
      toast.innerHTML = `${message}`;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // QRコードを表示
    window.showQrCode = function(tableName) {
      const baseUrl = 'https://gymnastmasaki-lang.github.io/takoyaki-/menu.html';
      
      // 店舗IDをURLパラメータに追加
      let storeParam = '';
      if (window.currentStoreId) {
        // 新しい店舗の場合
        storeParam = `store=${window.currentStoreId}&`;
      } else {
        // 下赤塚店の場合
        storeParam = 'store=shimoakatsuka&';
      }
      
      const tableUrl = `${baseUrl}?${storeParam}table=${encodeURIComponent(tableName)}`;
      
      document.getElementById('qrTableName').textContent = `テーブル: ${tableName}`;
      document.getElementById('qrTableUrl').textContent = tableUrl;
      
      // QRコードを生成
      const qrContainer = document.getElementById('qrCodeContainer');
      qrContainer.innerHTML = '';
      
      // QRコード生成ライブラリを使用（CDN経由）
      // 簡易版: テキストとして表示
      qrContainer.innerHTML = `
        <div style="padding: 20px; background: white; border: 2px solid #ddd; border-radius: 8px;">
          <div style="font-size: 14px; color: #666; margin-bottom: 10px;">QRコード生成用URL:</div>
          <div style="font-weight: bold; word-break: break-all;">${tableUrl}</div>
          <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 4px; font-size: 12px; color: #856404;">
            このURLをQRコード生成サイト（例: qr-code-generator.com）に入力してQRコードを作成してください
          </div>
        </div>
      `;
      
      document.getElementById('qrCodeModal').classList.remove('hidden');
    };
    
    // QRコードモーダルを閉じる
    window.closeQrCodeModal = function() {
      document.getElementById('qrCodeModal').classList.add('hidden');
    };
    
    // テーブルメモモーダルを表示
    window.showTableMemoModal = function(tableId, tableName, staffMemo) {
      document.getElementById('memoTableId').value = tableId;
      document.getElementById('memoTableName').textContent = tableName;
      document.getElementById('memoTableStaffMemo').value = staffMemo || '';
      document.getElementById('tableMemoModal').classList.remove('hidden');
    };
    
    // テーブルメモモーダルを閉じる
    window.closeTableMemoModal = function() {
      document.getElementById('tableMemoModal').classList.add('hidden');
    };
    
    // テーブルメモを保存
    window.saveTableMemo = async function() {
      const tableId = document.getElementById('memoTableId').value;
      const staffMemo = document.getElementById('memoTableStaffMemo').value.trim();
      
      try {
        await window.updateDoc(window.getStoreDoc('tables', tableId), {
          staffMemo: staffMemo,
          updatedAt: window.Timestamp.now()
        });
        
        alert('メモを保存しました');
        closeTableMemoModal();
        await loadTableButtons(); // ボタンの色を更新
        
      } catch (error) {
        console.error('メモ保存エラー:', error);
        alert('メモの保存に失敗しました: ' + error.message);
      }
    };
    
    // ========== テーブルボタン動的生成 ==========
    
    // 既存のテーブル（即会計、テイクアウト）を自動登録
    async function ensureDefaultTables() {
      try {
        const defaultTables = [
          { name: 'テイクアウト', memoEnabled: true }  // メモ機能ON
        ];
        
        // 既存のテーブル一覧を取得
        const tablesSnapshot = await window.getDocs(window.getStoreCollection('tables'));
        const existingTables = new Map(); // name -> [docIds]の配列
        
        tablesSnapshot.forEach(doc => {
          const data = doc.data();
          if (!existingTables.has(data.name)) {
            existingTables.set(data.name, []);
          }
          existingTables.get(data.name).push(doc.id);
        });
        
        console.log(' 既存テーブル一覧:', Array.from(existingTables.keys()));
        
        // 即会計テーブルが存在する場合は全て削除
        if (existingTables.has('即会計')) {
          const docIds = existingTables.get('即会計');
          for (const docId of docIds) {
            await window.deleteDoc(window.getStoreDoc('tables', docId));
          }
          console.log(`️ 即会計テーブルを${docIds.length}件削除しました`);
        }
        
        // テイクアウトテーブルの重複を削除
        if (existingTables.has('テイクアウト')) {
          const docIds = existingTables.get('テイクアウト');
          if (docIds.length > 1) {
            // 重複がある場合は全て削除して再作成
            console.log(`テイクアウトテーブルが${docIds.length}件重複しています。全て削除して再作成します。`);
            for (const docId of docIds) {
              await window.deleteDoc(window.getStoreDoc('tables', docId));
            }
            existingTables.delete('テイクアウト');
            console.log('️ 重複したテイクアウトテーブルを削除しました');
          }
        }
        
        // デフォルトテーブルを追加または更新
        for (const table of defaultTables) {
          const docIds = existingTables.get(table.name) || [];
          
          if (docIds.length === 0) {
            // 存在しない場合は追加
            await window.addDoc(window.getStoreCollection('tables'), {
              name: table.name,
              memoEnabled: table.memoEnabled,
              isDefault: true, // デフォルトテーブルであることを示すフラグ
              createdAt: window.Timestamp.now()
            });
            console.log(`デフォルトテーブル「${table.name}」を登録しました（メモ機能: ${table.memoEnabled ? 'ON' : 'OFF'}）`);
          } else if (docIds.length === 1) {
            // 1つだけ存在する場合はmemoEnabledを更新
            const docId = docIds[0];
            await window.updateDoc(window.getStoreDoc('tables', docId), {
              memoEnabled: table.memoEnabled,
              isDefault: true,
              updatedAt: window.Timestamp.now()
            });
            console.log(`デフォルトテーブル「${table.name}」のメモ機能を更新しました（メモ機能: ${table.memoEnabled ? 'ON' : 'OFF'}）`);
          }
        }
      } catch (error) {
        console.error('デフォルトテーブル登録エラー:', error);
      }
    }
    
    // テーブルボタンを読み込んで表示
    async function loadTableButtons() {
      try {
        const grid = document.getElementById('tableButtonsGrid');
        const fixedGrid = grid.previousElementSibling; // 固定ボタングリッド
        
        // 既存の動的テーブルボタンを削除
        const existingButtons = grid.querySelectorAll('.dynamic-table-btn');
        existingButtons.forEach(btn => btn.remove());
        
        // 固定グリッドからテイクアウトボタンを削除（再作成のため）
        const existingTakeout = fixedGrid.querySelector('.takeout-btn');
        if (existingTakeout) existingTakeout.remove();
        
        // Firebaseからテーブル一覧を取得
        const tablesSnapshot = await window.getDocs(window.getStoreCollection('tables'));
        const tables = [];
        
        tablesSnapshot.forEach(doc => {
          const data = doc.data();
          // 即会計テーブルは除外
          if (data.name !== '即会計') {
            tables.push({
              id: doc.id,
              ...data
            });
          }
        });
        
        // テイクアウトと他のテーブルを分離
        const takeoutTable = tables.find(t => t.name === 'テイクアウト');
        const otherTables = tables.filter(t => t.name !== 'テイクアウト');
        otherTables.sort((a, b) => a.name.localeCompare(b.name));
        
        // テイクアウトボタンを1行目（固定グリッド）に追加
        if (takeoutTable) {
          const btn = document.createElement('button');
          btn.className = 'table-btn takeout-btn';
          btn.id = `table-${takeoutTable.name}`;
          btn.onclick = () => selectTable(takeoutTable.name);
          
          const hasStaffMemo = takeoutTable.staffMemo && takeoutTable.staffMemo.trim() !== '';
          const bgColor = hasStaffMemo 
            ? 'linear-gradient(135deg, #FF9800 0%, #FF5722 100%)' 
            : 'linear-gradient(135deg, #00BCD4 0%, #0097A7 100%)';
          
          btn.style.cssText = `background: ${bgColor}; color: white; font-size: 13px; font-weight: bold; padding: 10px 15px; border-radius: 12px; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px;`;
          
          // メモアイコンを追加
          const memoIcon = document.createElement('span');
          memoIcon.textContent = '';
          memoIcon.style.cssText = 'position: absolute; top: 3px; right: 3px; font-size: 14px; cursor: pointer; z-index: 10;';
          memoIcon.onclick = (e) => {
            e.stopPropagation();
            showTableMemoModal(takeoutTable.id, takeoutTable.name, takeoutTable.staffMemo || '');
          };
          
          const textSpan = document.createElement('span');
          textSpan.textContent = takeoutTable.name;
          
          btn.appendChild(memoIcon);
          btn.appendChild(textSpan);
          fixedGrid.appendChild(btn);
        }
        
        // 他のテーブルボタンを2行目以降（通常グリッド）に生成
        otherTables.forEach(table => {
          const btn = document.createElement('button');
          btn.className = 'table-btn dynamic-table-btn';
          btn.id = `table-${table.name}`;
          btn.onclick = () => selectTable(table.name);
          
          // スタッフメモがある場合は色を変更
          const hasStaffMemo = table.staffMemo && table.staffMemo.trim() !== '';
          const bgColor = hasStaffMemo 
            ? 'linear-gradient(135deg, #FF9800 0%, #FF5722 100%)' 
            : 'linear-gradient(135deg, #00BCD4 0%, #0097A7 100%)';
          
          btn.style.cssText = `background: ${bgColor}; color: white; font-size: 16px; font-weight: bold; padding: 15px; border-radius: 12px; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative;`;
          
          // メモアイコンを追加
          const memoIcon = document.createElement('span');
          memoIcon.textContent = '';
          memoIcon.style.cssText = 'position: absolute; top: 3px; right: 3px; font-size: 14px; cursor: pointer; z-index: 10;';
          memoIcon.onclick = (e) => {
            e.stopPropagation();
            showTableMemoModal(table.id, table.name, table.staffMemo || '');
          };
          
          const textSpan = document.createElement('span');
          textSpan.textContent = table.name;
          
          btn.appendChild(memoIcon);
          btn.appendChild(textSpan);
          
          grid.appendChild(btn);
        });
        
        // TABLESグローバル変数も更新（手動入力用、テイクアウト含む全テーブル）
        const allTables = [];
        if (takeoutTable) allTables.push(takeoutTable.name);
        allTables.push(...otherTables.map(t => t.name));
        window.TABLES = allTables;
        
        // 手動入力のセレクトボックスも更新
        updateManualTableSelect();
        
        // 新しいテーブルのリアルタイム監視を開始
        if (takeoutTable) monitorTable(takeoutTable.name);
        otherTables.forEach(table => {
          monitorTable(table.name);
        });
        
      } catch (error) {
        console.error('テーブルボタン読み込みエラー:', error);
      }
    }
    
    // 手動入力用のテーブル選択肢を更新
    function updateManualTableSelect() {
      const manualTable = document.getElementById('manualTable');
      if (!manualTable) return;
      
      // 既存のオプションをクリア（最初のオプションを除く）
      while (manualTable.options.length > 1) {
        manualTable.remove(1);
      }
      
      // TABLESから選択肢を生成
      window.TABLES.forEach(table => {
        const option = document.createElement('option');
        option.value = table;
        option.textContent = `テーブル ${table}`;
        manualTable.appendChild(option);
      });
    }
    
    // カテゴリ一覧を読み込み
    async function loadSortCategories() {
      try {
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        const categoryInfo = new Map();
        
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.category && data.id) {
            const cat = data.category;
            const itemId = data.id;
            
            if (!categoryInfo.has(cat)) {
              categoryInfo.set(cat, { minId: itemId });
            } else {
              const info = categoryInfo.get(cat);
              if (itemId < info.minId) {
                info.minId = itemId;
              }
            }
          }
        });
        
        const select = document.getElementById('sortCategorySelect');
        select.innerHTML = '<option value="">カテゴリを選択...</option>';
        
        // menu.htmlと同じソート方法：各カテゴリの最小IDでソート
        const sortedCategories = Array.from(categoryInfo.entries())
          .sort((a, b) => a[1].minId.localeCompare(b[1].minId))
          .map(entry => entry[0]);
        
        sortedCategories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          select.appendChild(option);
        });
        
      } catch (error) {
        console.error('カテゴリ読み込みエラー:', error);
      }
    }
    
    // 選択したカテゴリの商品を読み込み
    window.loadSortProducts = async function() {
      const category = document.getElementById('sortCategorySelect').value;
      
      if (!category) {
        document.getElementById('sortProductsList').innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">カテゴリを選択してください</div>';
        return;
      }
      
      try {
        const container = document.getElementById('sortProductsList');
        container.innerHTML = '<div style="text-align: center; padding: 20px;">読み込み中...</div>';
        
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        sortProducts = [];
        
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.category === category) {
            sortProducts.push({
              id: doc.id,
              docId: doc.id,
              name: data.name || data.id,
              price: data.price,
              order: data.order || 999
            });
          }
        });
        
        // 現在の並び順でソート
        sortProducts.sort((a, b) => {
          if (a.order !== b.order) {
            return a.order - b.order;
          }
          return a.name.localeCompare(b.name, 'ja');
        });
        
        displaySortProducts();
        
      } catch (error) {
        console.error('商品読み込みエラー:', error);
        document.getElementById('sortProductsList').innerHTML = '<div style="text-align: center; padding: 20px; color: red;">読み込みに失敗しました</div>';
      }
    };
    
    // ドラッグ可能な商品リストを表示
    function displaySortProducts() {
      const container = document.getElementById('sortProductsList');
      
      if (sortProducts.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">このカテゴリには商品がありません</div>';
        return;
      }
      
      container.innerHTML = '';
      
      sortProducts.forEach((product, index) => {
        const productDiv = document.createElement('div');
        productDiv.draggable = true;
        productDiv.dataset.index = index;
        productDiv.style.cssText = `
          padding: 15px;
          margin-bottom: 10px;
          background: white;
          border-radius: 8px;
          border: 2px solid #ddd;
          display: flex;
          justify-content: space-between;
          align-items: center;
          cursor: move;
          transition: all 0.2s;
        `;
        
        productDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 15px;">
            <div style="font-size: 20px; color: #999;"></div>
            <div style="font-weight: bold; font-size: 18px; color: #333; min-width: 30px;">${index + 1}</div>
            <div>
              <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${product.name}</div>
              <div style="color: #4CAF50; font-weight: bold;">¥${product.price.toLocaleString()}</div>
            </div>
          </div>
        `;
        
        // ドラッグイベント
        productDiv.addEventListener('dragstart', handleDragStart);
        productDiv.addEventListener('dragover', handleDragOver);
        productDiv.addEventListener('drop', handleDrop);
        productDiv.addEventListener('dragend', handleDragEnd);
        
        container.appendChild(productDiv);
      });
    }
    
    // ドラッグ開始
    function handleDragStart(e) {
      draggedElement = this;
      this.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
    }
    
    // ドラッグオーバー
    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = 'move';
      
      const target = e.currentTarget;
      if (target !== draggedElement) {
        target.style.borderColor = '#2196F3';
        target.style.background = '#E3F2FD';
      }
      
      return false;
    }
    
    // ドロップ
    function handleDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }
      
      const target = e.currentTarget;
      target.style.borderColor = '#ddd';
      target.style.background = 'white';
      
      if (draggedElement !== target) {
        const draggedIndex = parseInt(draggedElement.dataset.index);
        const targetIndex = parseInt(target.dataset.index);
        
        // 配列を並び替え
        const [draggedItem] = sortProducts.splice(draggedIndex, 1);
        sortProducts.splice(targetIndex, 0, draggedItem);
        
        // 再描画
        displaySortProducts();
      }
      
      return false;
    }
    
    // ドラッグ終了
    function handleDragEnd(e) {
      this.style.opacity = '1';
      
      // すべての要素のスタイルをリセット
      const items = document.querySelectorAll('#sortProductsList > div');
      items.forEach(item => {
        item.style.borderColor = '#ddd';
        item.style.background = 'white';
      });
    }
    
    // 並び順を保存
    window.saveSortOrder = async function() {
      const category = document.getElementById('sortCategorySelect').value;
      
      if (!category || sortProducts.length === 0) {
        alert('保存する商品がありません');
        return;
      }
      
      // カスタム確認ダイアログを表示
      const confirmed = await showCustomConfirm({
        icon: '',
        title: '並び順を保存',
        message: '並び順を保存しますか？',
        confirmText: '保存する',
        confirmColor: '#4CAF50'
      });
      
      if (!confirmed) {
        return;
      }
      
      try {
        // 各商品にorder値を設定して保存
        const promises = sortProducts.map((product, index) => {
          return window.updateDoc(window.getStoreDoc('menus', product.docId), {
            order: index
          });
        });
        
        await Promise.all(promises);
        
        showCustomAlert('並び順を保存しました', '完了', '');
        closeSortOrderModal();
        
        // メニューを再読み込み
        if (typeof loadMenu === 'function') {
          loadMenu();
        }
        
      } catch (error) {
        console.error('保存エラー:', error);
        alert('保存に失敗しました: ' + error.message);
      }
    };
    
    // ========== 商品編集機能 ==========
    let editToppingSets = [];
    
    // 商品編集モーダルを開く
    window.openEditProductModal = function(product) {
      console.log('━━━━━━━━━━━━━━━━━━━━━━');
      console.log(' 商品編集モーダルを開きます');
      console.log('商品名:', product.name);
      console.log('商品ID:', product.id);
      console.log('トッピングセット数:', product.toppingSets ? product.toppingSets.length : 0);
      console.log('トッピングセット詳細:', product.toppingSets);
      console.log('━━━━━━━━━━━━━━━━━━━━━━');
      
      document.getElementById('productEditModal').classList.remove('hidden');
      document.getElementById('editProductId').value = product.id;
      document.getElementById('editProductName').value = product.name;
      document.getElementById('editProductPrice').value = product.price;
      document.getElementById('editProductCategory').value = product.category;
      document.getElementById('editProductNote').value = product.note || '';
      document.getElementById('editProductImage').value = product.image || '';
      
      // 税率を設定（デフォルトは10%）
      const taxRate = product.taxRate || 10;
      const taxRateRadios = document.querySelectorAll('input[name="editProductTaxRate"]');
      taxRateRadios.forEach(radio => {
        radio.checked = (parseInt(radio.value) === taxRate);
      });
      
      // トッピングセットを読み込み
      editToppingSets = product.toppingSets ? JSON.parse(JSON.stringify(product.toppingSets)) : [];
      
      // 診断情報を画面に表示
      const diagnosticDiv = document.getElementById('editToppingDiagnostic');
      if (diagnosticDiv) {
        const count = editToppingSets.length;
        diagnosticDiv.innerHTML = `
          <div style="padding: 10px; background: ${count > 5 ? '#ffebee' : '#e8f5e9'}; border-radius: 6px; margin-bottom: 15px;">
            <div style="font-weight: bold; margin-bottom: 5px;">
              ${count > 5 ? '警告' : '正常'}
            </div>
            <div style="font-size: 14px; margin-bottom: 10px;">
              この商品には現在 <strong>${count}個</strong> のトッピングセットが保存されています
            </div>
            ${count > 5 ? `
              <div style="font-size: 13px; color: #d32f2f; margin-bottom: 10px;">
                通常、1つの商品には1〜3個程度のトッピングセットが適切です。<br>
                不要なトッピングセットは下の「削除」ボタンで削除するか、<br>
                一括削除ボタンですべてクリアできます。
              </div>
              <button onclick="clearAllEditToppingSets()" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                すべてのトッピングセットを削除
              </button>
            ` : ''}
          </div>
        `;
      }
      
      renderEditToppingSets();
    };
    
    // 商品編集モーダルを閉じる
    window.closeEditProductModal = function() {
      document.getElementById('productEditModal').classList.add('hidden');
      editToppingSets = [];
    };
    
    // すべてのトッピングセットを削除
    window.clearAllEditToppingSets = function() {
      if (confirm('すべてのトッピングセットを削除しますか？\n\nこの操作は「️ 更新」ボタンを押すまで確定しません。')) {
        editToppingSets = [];
        renderEditToppingSets();
        
        // 診断情報を更新
        const diagnosticDiv = document.getElementById('editToppingDiagnostic');
        if (diagnosticDiv) {
          diagnosticDiv.innerHTML = `
            <div style="padding: 10px; background: #e8f5e9; border-radius: 6px; margin-bottom: 15px;">
              <div style="font-weight: bold; margin-bottom: 5px;">クリア完了</div>
              <div style="font-size: 14px;">
                すべてのトッピングセットを削除しました。<br>
                「️ 更新」ボタンを押して変更を保存してください。
              </div>
            </div>
          `;
        }
        
        console.log(' すべてのトッピングセットを削除しました');
      }
    };
    
    // トッピングセットを描画
    function renderEditToppingSets() {
      const container = document.getElementById('editToppingSetsContainer');
      container.innerHTML = '';
      
      editToppingSets.forEach((set, setIndex) => {
        const setDiv = document.createElement('div');
        setDiv.style.cssText = 'border: 2px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #f9f9f9;';
        
        setDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <input type="text" class="edit-topping-set-name" value="${set.name}" placeholder="セット名（例: ソース種類）" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
            <select class="edit-topping-set-type" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
              <option value="single" ${set.type === 'single' ? 'selected' : ''}>単一選択</option>
              <option value="multiple" ${set.type === 'multiple' ? 'selected' : ''}>複数選択</option>
            </select>
            <button onclick="removeEditToppingSet(${setIndex})" style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">削除</button>
          </div>
          <div class="edit-topping-options-list"></div>
          <button onclick="addEditToppingOption(${setIndex})" style="padding: 6px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px;">+ オプション追加</button>
        `;
        
        const optionsList = setDiv.querySelector('.edit-topping-options-list');
        set.options.forEach((option, optionIndex) => {
          const optionDiv = document.createElement('div');
          optionDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 8px; align-items: center;';
          optionDiv.innerHTML = `
            <input type="text" class="edit-option-name" value="${option.name}" placeholder="オプション名" style="flex: 2; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            <input type="number" class="edit-option-price" value="${option.price}" placeholder="追加料金" min="0" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            <button onclick="removeEditToppingOption(${setIndex}, ${optionIndex})" style="padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">×</button>
          `;
          optionsList.appendChild(optionDiv);
        });
        
        container.appendChild(setDiv);
      });
    }
    

    // トッピングオプションを追加
    window.addEditToppingOption = function(setIndex) {
      // 現在の入力内容を保存
      saveCurrentEditToppingData();
      
      // 新しいオプションを追加
      editToppingSets[setIndex].options.push({
        name: '',
        price: 0
      });
      renderEditToppingSets();
    };
    
    // トッピングオプションを削除
    window.removeEditToppingOption = function(setIndex, optionIndex) {
      // 現在の入力内容を保存
      saveCurrentEditToppingData();
      
      editToppingSets[setIndex].options.splice(optionIndex, 1);
      renderEditToppingSets();
    };
    
    // トッピングセットを追加
    window.addEditToppingSet = function() {
      // 現在の入力内容を保存
      saveCurrentEditToppingData();
      
      editToppingSets.push({
        name: '',
        type: 'single',
        options: []
      });
      renderEditToppingSets();
    };
    
    // トッピングセットを削除
    window.removeEditToppingSet = function(setIndex) {
      // 現在の入力内容を保存
      saveCurrentEditToppingData();
      
      editToppingSets.splice(setIndex, 1);
      renderEditToppingSets();
    };
    
    // 現在の入力内容をeditToppingSetsに保存
    function saveCurrentEditToppingData() {
      const container = document.getElementById('editToppingSetsContainer');
      const setDivs = container.children;
      
      for (let i = 0; i < setDivs.length && i < editToppingSets.length; i++) {
        const setDiv = setDivs[i];
        
        // セット名とタイプを保存
        const nameInput = setDiv.querySelector('.edit-topping-set-name');
        const typeSelect = setDiv.querySelector('.edit-topping-set-type');
        
        if (nameInput) editToppingSets[i].name = nameInput.value;
        if (typeSelect) editToppingSets[i].type = typeSelect.value;
        
        // オプションを保存
        const optionDivs = setDiv.querySelectorAll('.edit-topping-options-list > div');
        optionDivs.forEach((optionDiv, optIdx) => {
          if (editToppingSets[i].options[optIdx]) {
            const nameInput = optionDiv.querySelector('.edit-option-name');
            const priceInput = optionDiv.querySelector('.edit-option-price');
            
            if (nameInput) editToppingSets[i].options[optIdx].name = nameInput.value;
            if (priceInput) editToppingSets[i].options[optIdx].price = parseInt(priceInput.value) || 0;
          }
        });
      }
    }
    
    // 商品を更新
    window.saveEditedProduct = async function() {
      const productId = document.getElementById('editProductId').value;
      const name = document.getElementById('editProductName').value.trim();
      const price = parseInt(document.getElementById('editProductPrice').value);
      const category = document.getElementById('editProductCategory').value.trim();
      const note = document.getElementById('editProductNote').value.trim();
      const image = document.getElementById('editProductImage').value.trim();
      
      // 税率を取得
      const taxRateRadio = document.querySelector('input[name="editProductTaxRate"]:checked');
      const taxRate = taxRateRadio ? parseInt(taxRateRadio.value) : 10;
      
      if (!name || !price || !category) {
        alert('商品名、価格、カテゴリは必須です');
        return;
      }
      
      // トッピングセットの情報を収集
      const setDivs = document.querySelectorAll('#editToppingSetsContainer > div');
      const toppingSets = [];
      
      setDivs.forEach((setDiv, setIndex) => {
        const setName = setDiv.querySelector('.edit-topping-set-name').value.trim();
        const setType = setDiv.querySelector('.edit-topping-set-type').value;
        
        if (!setName) return;
        
        const options = [];
        const optionDivs = setDiv.querySelectorAll('.edit-topping-options-list > div');
        
        optionDivs.forEach(optionDiv => {
          const optionName = optionDiv.querySelector('.edit-option-name').value.trim();
          const optionPrice = parseInt(optionDiv.querySelector('.edit-option-price').value) || 0;
          
          if (optionName) {
            options.push({ name: optionName, price: optionPrice });
          }
        });
        
        if (options.length > 0) {
          toppingSets.push({
            name: setName,
            type: setType,
            options: options
          });
        }
      });
      
      try {
        // 既存商品を取得してdocIdを確認
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        let docId = null;
        let existingToppingsId = '';
        
        menuSnapshot.forEach(doc => {
          if (doc.data().id === productId || doc.id === productId) {
            docId = doc.id;
            existingToppingsId = doc.data().toppingsId || '';
          }
        });
        
        if (!docId) {
          throw new Error('商品が見つかりません');
        }
        
        // トッピングをtoppingsコレクションに登録してIDを取得
        const toppingIds = [];
        
        if (toppingSets.length > 0) {
          // 最新のトッピングIDを取得
          const toppingsSnapshot = await window.getDocs(window.getStoreCollection('toppings'));
          let maxNum = 15; // T0016から開始
          
          toppingsSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.id && data.id.startsWith('T')) {
              const num = parseInt(data.id.substring(1));
              if (num > maxNum) maxNum = num;
            }
          });
          
          // 各トッピングセットのオプションをtoppingsに登録
          for (const set of toppingSets) {
            for (const option of set.options) {
              maxNum++;
              const toppingId = 'T' + String(maxNum).padStart(4, '0');
              
              await window.addDoc(window.getStoreCollection('toppings'), {
                id: toppingId,
                name: option.name,
                price: option.price,
                order: maxNum
              });
              
              toppingIds.push(toppingId);
            }
          }
        }
        
        const productData = {
          id: productId,
          name: name,
          price: price,
          category: category,
          toppingSets: toppingSets,
          toppingsId: toppingIds.length > 0 ? toppingIds.join(',') : existingToppingsId,
          note: note,
          image: image || '',
          taxRate: taxRate  // 選択した税率を保存
        };
        
        // 既存のorderフィールドを保持（既に取得済みのドキュメントから）
        menuSnapshot.forEach(doc => {
          if (doc.id === docId && doc.data().order) {
            productData.order = doc.data().order;
          }
        });
        
        // docIdを使用して更新（idではなく）
        await window.setDoc(window.getStoreDoc('menus', docId), productData);
        
        await showCustomAlert('商品を更新しました');
        closeEditProductModal();
        
        // リストを再読み込み
        await loadProductDeleteList();
        
        // メニューを再読み込み
        await initializeSystem();
        
      } catch (error) {
        console.error('商品更新エラー:', error);
        await showCustomAlert('商品の更新に失敗しました\n\n' + error.message);
      }
    };
    
    // 商品を検索してフィルター
    window.filterProductList = function() {
      const searchText = document.getElementById('productSearchInput').value.toLowerCase();
      
      if (!searchText) {
        displayProductDeleteList(allProductsForDelete);
        return;
      }
      
      const filtered = allProductsForDelete.filter(product => 
        product.name.toLowerCase().includes(searchText) ||
        product.category.toLowerCase().includes(searchText)
      );
      
      displayProductDeleteList(filtered);
    };
    
    // 商品を削除
    async function deleteProduct(productId, productName) {
      const confirmed = await showCustomConfirm({
        icon: '️',
        title: '商品削除',
        message: `「${productName}」を削除しますか？\n\nこの操作は取り消せません。`,
        btnClass: 'modal-btn-danger',
        confirmText: '削除する',
        cancelText: 'キャンセル'
      });
      
      if (!confirmed) return;
      
      try {
        await window.deleteDoc(window.getStoreDoc('menus', productId));
        
        await showCustomAlert('商品を削除しました');
        
        // リストを再読み込み
        await loadProductDeleteList();
        
        // メニューを再読み込み
        
        
      } catch (error) {
        console.error('商品削除エラー:', error);
        await showCustomAlert('商品の削除に失敗しました\n\n' + error.message);
      }
    }
    
    // ========================================
    // トッピング順序変更機能
    // ========================================
    
    let toppingOrderData = [];
    
    // トッピング順序モーダルを表示
    window.showToppingOrderModal = async function() {
      document.getElementById('toppingOrderModal').classList.remove('hidden');
      await loadToppingOrderList();
    };
    
    // トッピング順序モーダルを閉じる
    window.closeToppingOrderModal = function() {
      document.getElementById('toppingOrderModal').classList.add('hidden');
      
      // モーダルタイトルを元に戻す
      const modalTitle = document.querySelector('#toppingOrderModal h3');
      modalTitle.textContent = 'トッピング順序変更';
      
      // 編集中の商品情報をクリア
      window.currentEditingProduct = null;
    };
    
    // トッピングセットリストを読み込み
    async function loadToppingOrderList() {
      try {
        const container = document.getElementById('toppingOrderList');
        container.innerHTML = '<div style="text-align: center; padding: 20px;">読み込み中...</div>';
        
        const toppingsSnapshot = await window.getDocs(window.getStoreCollection('toppings'));
        toppingOrderData = [];
        
        toppingsSnapshot.forEach(doc => {
          const data = doc.data();
          toppingOrderData.push({
            id: doc.id,
            name: data.name,
            order: data.order || 999,
            ...data
          });
        });
        
        // 現在の順序でソート
        toppingOrderData.sort((a, b) => a.order - b.order);
        
        displayToppingOrderList();
        
      } catch (error) {
        console.error('トッピングリスト読み込みエラー:', error);
        document.getElementById('toppingOrderList').innerHTML = '<div style="text-align: center; padding: 20px; color: red;">読み込みに失敗しました</div>';
      }
    }
    
    // トッピングセットリストを表示
    function displayToppingOrderList() {
      const container = document.getElementById('toppingOrderList');
      
      if (toppingOrderData.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">トッピングがありません</div>';
        return;
      }
      
      container.innerHTML = '';
      
      toppingOrderData.forEach((topping, index) => {
        const toppingDiv = document.createElement('div');
        toppingDiv.className = 'topping-order-item';
        toppingDiv.draggable = true;
        toppingDiv.dataset.index = index;
        toppingDiv.style.cssText = `
          background: white;
          border: 2px solid #e0e0e0;
          border-radius: 10px;
          padding: 15px;
          display: flex;
          align-items: center;
          gap: 15px;
          cursor: move;
          transition: all 0.2s;
        `;
        
        toppingDiv.innerHTML = `
          <div style="font-size: 24px; color: #999;"></div>
          <div style="flex: 1;">
            <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${topping.name}</div>
            <div style="font-size: 12px; color: #999;">順序: ${index + 1}</div>
          </div>
          <div style="display: flex; gap: 10px;">
            <button onclick="moveToppingUp(${index})" style="padding: 8px 12px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" ${index === 0 ? 'disabled' : ''}>↑</button>
            <button onclick="moveToppingDown(${index})" style="padding: 8px 12px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" ${index === toppingOrderData.length - 1 ? 'disabled' : ''}>↓</button>
          </div>
        `;
        
        // ドラッグ&ドロップイベント
        toppingDiv.addEventListener('dragstart', handleToppingDragStart);
        toppingDiv.addEventListener('dragover', handleToppingDragOver);
        toppingDiv.addEventListener('drop', handleToppingDrop);
        toppingDiv.addEventListener('dragenter', handleToppingDragEnter);
        toppingDiv.addEventListener('dragleave', handleToppingDragLeave);
        toppingDiv.addEventListener('dragend', handleToppingDragEnd);
        
        container.appendChild(toppingDiv);
      });
    }
    
    // トッピングを上に移動
    window.moveToppingUp = function(index) {
      if (index === 0) return;
      
      const temp = toppingOrderData[index];
      toppingOrderData[index] = toppingOrderData[index - 1];
      toppingOrderData[index - 1] = temp;
      
      displayToppingOrderList();
    };
    
    // トッピングを下に移動
    window.moveToppingDown = function(index) {
      if (index === toppingOrderData.length - 1) return;
      
      const temp = toppingOrderData[index];
      toppingOrderData[index] = toppingOrderData[index + 1];
      toppingOrderData[index + 1] = temp;
      
      displayToppingOrderList();
    };
    
    // ドラッグ&ドロップ処理
    let draggedToppingElement = null;
    let draggedToppingIndex = null;
    
    function handleToppingDragStart(e) {
      draggedToppingElement = e.currentTarget;
      draggedToppingIndex = parseInt(e.currentTarget.dataset.index);
      e.currentTarget.style.opacity = '0.5';
    }
    
    function handleToppingDragOver(e) {
      e.preventDefault();
      return false;
    }
    
    function handleToppingDragEnter(e) {
      if (e.currentTarget.className === 'topping-order-item') {
        e.currentTarget.style.borderColor = '#4CAF50';
        e.currentTarget.style.backgroundColor = '#e8f5e9';
      }
    }
    
    function handleToppingDragLeave(e) {
      if (e.currentTarget.className === 'topping-order-item') {
        e.currentTarget.style.borderColor = '#e0e0e0';
        e.currentTarget.style.backgroundColor = 'white';
      }
    }
    
    function handleToppingDrop(e) {
      e.preventDefault();
      
      if (e.currentTarget.className === 'topping-order-item') {
        const dropIndex = parseInt(e.currentTarget.dataset.index);
        
        if (draggedToppingIndex !== dropIndex) {
          // 配列の要素を入れ替え
          const temp = toppingOrderData[draggedToppingIndex];
          toppingOrderData.splice(draggedToppingIndex, 1);
          toppingOrderData.splice(dropIndex, 0, temp);
          
          displayToppingOrderList();
        }
        
        e.currentTarget.style.borderColor = '#e0e0e0';
        e.currentTarget.style.backgroundColor = 'white';
      }
      
      return false;
    }
    
    function handleToppingDragEnd(e) {
      e.currentTarget.style.opacity = '1';
    }
    
    // トッピング順序を保存
    window.saveToppingOrder = async function() {
      try {
        // 商品のトッピングセット順序を保存する場合
        if (window.currentEditingProduct) {
          const product = window.currentEditingProduct;
          
          // toppingOrderDataを新しい順序で更新
          const updatedToppingSets = toppingOrderData.map((set, index) => ({
            name: set.name,
            type: set.type,
            options: set.options,
            order: index
          }));
          
          // 商品ドキュメントを更新（docIdを使用）
          await window.updateDoc(window.getStoreDoc('menus', product.docId), {
            toppingSets: updatedToppingSets
          });
          
          await showCustomAlert('トッピング順序を保存しました');
          closeToppingOrderModal();
          
          // モーダルタイトルを元に戻す
          const modalTitle = document.querySelector('#toppingOrderModal h3');
          modalTitle.textContent = 'トッピング順序変更';
          
          // 商品リストを再読み込み
          await loadProductDeleteList();
          
          // 編集中の商品情報をクリア
          window.currentEditingProduct = null;
          
        } else {
          // グローバルなトッピング順序を保存する場合（将来の拡張用）
          const updatePromises = toppingOrderData.map((topping, index) => {
            return window.updateDoc(window.getStoreDoc('toppings', topping.id), {
              order: index
            });
          });
          
          await Promise.all(updatePromises);
          
          await showCustomAlert('トッピング順序を保存しました');
          closeToppingOrderModal();
        }
        
      } catch (error) {
        console.error('トッピング順序保存エラー:', error);
        await showCustomAlert('トッピング順序の保存に失敗しました\n\n' + error.message);
      }
    };
    
    // 商品のトッピング順序を変更
    window.openToppingOrderForProduct = async function(product) {
      // 商品にトッピングセットがない場合
      if (!product.toppingSets || product.toppingSets.length === 0) {
        await showCustomAlert('この商品にはトッピングセットが設定されていません');
        return;
      }
      
      // トッピングセットのデータを取得
      toppingOrderData = product.toppingSets.map((set, index) => ({
        ...set,
        originalIndex: index,
        order: index
      }));
      
      // モーダルのタイトルを変更
      const modalTitle = document.querySelector('#toppingOrderModal h3');
      modalTitle.textContent = `トッピング順序変更 - ${product.name}`;
      
      // リストを表示
      displayToppingOrderList();
      
      // モーダルを開く
      document.getElementById('toppingOrderModal').classList.remove('hidden');
      
      // 保存時に商品も一緒に更新するため、商品情報を保持
      window.currentEditingProduct = product;
    };
    
    // パスワード認証処理（店舗別認証 + 旧パスワード対応）
    let currentStoreId = null;
    let currentStoreName = null;
    
    async function handlePOSLogin(event) {
      event.preventDefault();
      
      console.log('=== POSログイン試行開始 ===');
      
      const storeNameInput = document.getElementById('posStoreNameInput').value.trim();
      const passwordInput = document.getElementById('posPasswordInput').value;
      const loginError = document.getElementById('loginError');
      
      console.log('入力された店舗名:', storeNameInput);
      console.log('パスワード長:', passwordInput.length);
      
      if (!storeNameInput || !passwordInput) {
        loginError.textContent = '店舗名とパスワードを入力してください';
        loginError.style.display = 'block';
        return;
      }

      try {
        // Firebaseの初期化を待つ
        console.log('Firebase初期化状態:', window.firebaseReady);
        if (!window.firebaseReady) {
          loginError.textContent = 'システムの初期化中です。少々お待ちください。';
          loginError.style.display = 'block';
          return;
        }

        // ========== 下赤塚店の特別処理（最優先） ==========
        if (storeNameInput === '下赤塚' && passwordInput === 'K12290619T') {
          console.log(' 下赤塚店として認証（旧システム）');
          // 旧システム用の認証
          currentStoreId = null; // 旧データパスを使用
          currentStoreName = '下赤塚';
          
          window.currentStoreId = null; // nullの場合は旧パスを使う
          window.currentStoreName = currentStoreName;
          
          sessionStorage.setItem('posStoreId', '');
          sessionStorage.setItem('posStoreName', currentStoreName);
          sessionStorage.setItem('posAuthenticated', 'true');
          
          const headerTitle = document.querySelector('.header-title');
          if (headerTitle) {
            headerTitle.textContent = currentStoreName + ' - レジシステム';
          }
          
          console.log(' 下赤塚店ログイン成功（旧システム）');
          console.log('   店舗ID:', window.currentStoreId);
          console.log('   店舗名:', window.currentStoreName);
          
          // ログイン画面を非表示にして日付選択モーダルを表示
          document.getElementById('loginScreen').style.display = 'none';
          showDateSelectionModal();
          
          return;
        }

        console.log('店舗データベース検索中...');
        // まず新しい店舗別認証を試みる
        const storesRef = window.collection(window.db, 'stores');
        const q = window.query(storesRef, window.where('storeName', '==', storeNameInput));
        const querySnapshot = await window.getDocs(q);
        
        console.log('検索結果:', querySnapshot.empty ? '店舗なし' : '店舗あり');

        // 新しい店舗別認証
        if (!querySnapshot.empty) {
          let authenticated = false;
          let storeData = null;
          let storeDocId = null;

          querySnapshot.forEach((doc) => {
            const data = doc.data();
            if (data.storePassword === passwordInput) {
              if (!data.isActive) {
                loginError.textContent = 'この店舗は無効化されています';
                loginError.style.display = 'block';
                return;
              }
              authenticated = true;
              storeData = data;
              storeDocId = doc.id;
            }
          });

          if (authenticated && storeData) {
            //  下赤塚店の特別処理: IDが shimoarekasuka または shimoakatsuka の場合は null に変換
            if (storeDocId === 'shimoarekasuka' || storeDocId === 'shimoakatsuka') {
              console.log(' 下赤塚店のIDを検出: ' + storeDocId + ' → null (旧パス使用)');
              currentStoreId = null;
            } else {
              currentStoreId = storeDocId;
            }
            
            currentStoreName = storeData.storeName;
            
            // グローバル変数に設定
            window.currentStoreId = currentStoreId;
            window.currentStoreName = currentStoreName;
            
            sessionStorage.setItem('posStoreId', currentStoreId || '');
            sessionStorage.setItem('posStoreName', currentStoreName);
            sessionStorage.setItem('posAuthenticated', 'true');
            
            // ヘッダーに店舗名を表示
            const headerTitle = document.querySelector('.header-title');
            if (headerTitle) {
              headerTitle.textContent = currentStoreName + ' - レジシステム';
            }
            
            console.log(' 店舗別ログイン成功:', currentStoreName, 'ID:', currentStoreId);
            
            // ログイン画面を非表示にして日付選択モーダルを表示
            document.getElementById('loginScreen').style.display = 'none';
            showDateSelectionModal();
            
            return;
          }
        }
        
        // 店舗が見つからない場合、旧パスワード認証を試す（下赤塚店用フォールバック）
        console.log('旧システム認証チェック:', storeNameInput, '===', '下赤塚', '?');
        if (storeNameInput === '下赤塚' && passwordInput === 'K12290619T') {
          console.log(' 旧システム認証条件に一致');
          // 旧システム用の認証
          currentStoreId = null; // 旧データパスを使用
          currentStoreName = '下赤塚';
          
          window.currentStoreId = null; // nullの場合は旧パスを使う
          window.currentStoreName = currentStoreName;
          
          sessionStorage.setItem('posStoreId', '');
          sessionStorage.setItem('posStoreName', currentStoreName);
          sessionStorage.setItem('posAuthenticated', 'true');
          
          console.log('セッションストレージ保存完了');
          
          // ログイン成功後、日付選択モーダルを表示
          document.getElementById('loginScreen').style.display = 'none';
          showDateSelectionModal();
          
          // メインコンテンツは日付選択後に表示
          
          const headerTitle = document.querySelector('.header-title');
          if (headerTitle) {
            headerTitle.textContent = currentStoreName + ' - レジシステム';
          }
          
          console.log(' 旧システムログイン成功（移行前）:', currentStoreName);
          
          return;
        } else {
          console.log(' 旧システム認証条件に不一致');
        }

        // ログイン失敗
        loginError.textContent = 'パスワードが正しくありません';
        loginError.style.display = 'block';
        document.getElementById('posPasswordInput').value = '';
        
        setTimeout(() => {
          loginError.style.display = 'none';
        }, 3000);
      } catch (error) {
        console.error(' ログインエラー:', error);
        loginError.textContent = 'ログインエラー: ' + error.message;
        loginError.style.display = 'block';
      }
    }
    
    //  レジ音を再生する関数
    function playBeepSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // AudioContextを再開（ブラウザの自動再生ポリシー対策）
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }
        
        // 2回のビープ音（ピッピッ）
        const beep = (frequency, startTime, duration) => {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.value = frequency;
          oscillator.type = 'sine';
          
          gainNode.gain.setValueAtTime(0.2, startTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
          
          oscillator.start(startTime);
          oscillator.stop(startTime + duration);
        };
        
        const now = audioContext.currentTime;
        beep(2000, now + 0.05, 0.08);
        beep(2000, now + 0.20, 0.08);
        
        console.log(' レジ音再生完了');
      } catch (e) {
        console.error(' 音声再生エラー:', e);
      }
    }
    
    // ページ読み込み時にセッションをチェック
    window.addEventListener('DOMContentLoaded', () => {
      // ログインフォームのイベントリスナーを設定
      const loginForm = document.getElementById('posLoginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', handlePOSLogin);
        console.log(' ログインフォームのイベントリスナー登録完了');
      }
      
      // iframeからのメッセージを受信
      window.addEventListener('message', (event) => {
        // セキュリティ: 同一オリジンからのメッセージのみ受け付ける
        if (event.origin !== window.location.origin) {
          return;
        }
        
        console.log(' iframeからメッセージ受信:', event.data);
        
        if (event.data.type === 'addToCart') {
          // menu.htmlから商品追加のメッセージを受信
          const item = event.data.item;
          console.log(' 商品をカートに追加:', item);
          
          // 商品追加関数を呼び出し
          if (window.addItemFromIframe) {
            window.addItemFromIframe(item);
          } else {
            console.error(' addItemFromIframe関数が見つかりません');
          }
        } else if (event.data.type === 'playBeep') {
          //  menu.htmlから音再生のメッセージを受信
          console.log(' レジ音再生リクエスト受信');
          playBeepSound();
        }
      });
      
      const isAuthenticated = sessionStorage.getItem('posAuthenticated');
      const savedStoreId = sessionStorage.getItem('posStoreId');
      const savedStoreName = sessionStorage.getItem('posStoreName');
      
      if (isAuthenticated === 'true' && savedStoreName) {
        //  下赤塚店の特別処理: IDが shimoarekasuka または shimoakatsuka の場合は null に変換
        let actualStoreId = (savedStoreId && savedStoreId !== '') ? savedStoreId : null;
        if (actualStoreId === 'shimoarekasuka' || actualStoreId === 'shimoakatsuka') {
          console.log(' 下赤塚店のIDを検出: ' + actualStoreId + ' → null (旧パス使用)');
          actualStoreId = null;
        }
        
        // 既にログイン済み（空文字列のstoreIdもOK - 旧システム用）
        currentStoreId = actualStoreId;
        currentStoreName = savedStoreName;
        window.currentStoreId = currentStoreId;
        window.currentStoreName = currentStoreName;
        
        // 営業日をセッションから復元
        const savedBusinessDate = sessionStorage.getItem('businessDate');
        if (savedBusinessDate) {
          window.selectedBusinessDate = savedBusinessDate;
          console.log('営業日復元:', window.selectedBusinessDate);
          
          // 営業日が保存されている場合はメインコンテンツを表示
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('mainContent').style.display = 'block';
          
          // 営業日表示を更新
          updateBusinessDateDisplay();
          
          // ヘッダーに店舗名を表示
          const headerTitle = document.querySelector('.header-title');
          if (headerTitle) {
            headerTitle.textContent = currentStoreName + ' - レジシステム';
          }
          
          console.log(' セッションから復元:', currentStoreName, 'StoreID:', currentStoreId || '(旧システム)');
          
          // メインコンテンツの表示を待ってから初期化（setTimeoutを使用）
          setTimeout(() => {
            console.log(' セッション復元後の初期化処理開始');
            
            // まずiframeを初期化
            console.log('️ iframe初期化を最優先で実行');
            updateMenuIframe();
            
            // その後、他の初期化処理を実行
            setTimeout(() => {
              if (window.firebaseReady) {
                // iframe以外の初期化処理
                loadStaffList();
                loadReceiptSettings();
                updateInventoryPanel();
                watchInventoryChanges();
              }
            }, 500);
          }, 300);
        } else {
          // セッションにない場合は営業日選択モーダルを表示
          console.log('営業日未設定 - 営業日選択モーダルを表示');
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('dateSelectionModal').style.display = 'flex';
        }
      }
    });
    
    // アプリケーション初期化処理
    function initializeApp() {
      // 既存の初期化処理が自動実行されるため、ここでは何もしない
      console.log(' POSシステム初期化完了');
      console.log('   店舗名:', window.currentStoreName);
      console.log('   店舗ID:', window.currentStoreId);
      console.log('   パス:', window.currentStoreId ? 'stores/' + window.currentStoreId : '旧パス(直接)');
      
      // 担当者リストを読み込む
      loadStaffList();
      
      // レシート設定を読み込む
      loadReceiptSettings();
      
      // menu.htmlのiframeに店舗IDを設定
      updateMenuIframe();
      
      // 在庫パネルを初期化
      updateInventoryPanel();
      watchInventoryChanges();
    }
    
    // 在庫更新後にアラートをチェック（ページロード時とは別）
    async function checkInventoryAlertsAfterUpdate() {
      try {
        console.log(' 在庫更新後のアラートチェック');
        
        // アラート設定を取得
        let alertSettingsRef;
        if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
          alertSettingsRef = window.doc(window.db, 'alert_settings', 'default');
        } else {
          alertSettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'alert_settings', 'default');
        }
        
        const alertSettingsDoc = await window.getDoc(alertSettingsRef);
        
        if (!alertSettingsDoc.exists()) {
          return;
        }
        
        const alertSettings = alertSettingsDoc.data();
        
        // メニュー設定を取得
        let menuSettingsRef;
        if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
          menuSettingsRef = window.doc(window.db, 'menu_settings', 'shimoakatsuka');
        } else {
          menuSettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'menu_settings', 'default');
        }
        
        const menuSettingsDoc = await window.getDoc(menuSettingsRef);
        
        if (!menuSettingsDoc.exists()) {
          return;
        }
        
        const menuSettings = menuSettingsDoc.data();
        const inventoryData = menuSettings.inventory || {};
        
        // 在庫が少ない商品をチェック
        const lowStockItems = [];
        
        for (const [itemName, settings] of Object.entries(alertSettings)) {
          if (typeof settings === 'object' && settings !== null && settings.enabled === true) {
            const threshold = settings.threshold || 0;
            const currentStock = inventoryData[itemName] || 0;
            
            if (currentStock <= threshold) {
              lowStockItems.push({
                name: itemName,
                current: currentStock,
                threshold: threshold
              });
            }
          }
        }
        
        // アラート表示（削除 - 在庫設定に関わらずアラートを表示しない）
        if (lowStockItems.length > 0) {
          console.log(' 在庫が少なくなっています（アラートは非表示）:', lowStockItems);
          // アラートは表示しない
        }
        
      } catch (error) {
        console.error(' 在庫アラートチェックエラー（更新後）:', error);
      }
    }
    
    // 在庫アラートをチェックする関数（ページロード時）
    async function checkInventoryAlerts() {
      try {
        console.log(' 在庫アラートをチェック開始 ');
        console.log('現在のStoreID:', window.currentStoreId);
        
        // 在庫設定を取得（kanri.htmlと同じパス）
        let inventorySettingsRef;
        if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
          inventorySettingsRef = window.doc(window.db, 'inventory_settings', 'default');
          console.log('  → 旧パス使用: inventory_settings/default');
        } else {
          inventorySettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
          console.log('  → 新パス使用: stores/' + window.currentStoreId + '/inventory_settings/default');
        }
        
        const inventorySettingsDoc = await window.getDoc(inventorySettingsRef);
        
        if (!inventorySettingsDoc.exists()) {
          console.log(' 在庫設定が見つかりません（在庫無限モード）');
          // 在庫無限の場合はアラートを表示せずに終了
          return;
        }
        
        const inventorySettingsData = inventorySettingsDoc.data();
        const alertSettings = inventorySettingsData.items || {};
        console.log(' 在庫設定（全データ）:', JSON.stringify(alertSettings, null, 2));
        
        // メニュー設定を取得
        let menuSettingsRef;
        if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
          menuSettingsRef = window.doc(window.db, 'menu_settings', 'shimoakatsuka');
          console.log('  → 旧パス使用: menu_settings/shimoakatsuka');
        } else {
          menuSettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'menu_settings', 'default');
          console.log('  → 新パス使用: stores/' + window.currentStoreId + '/menu_settings/default');
        }
        
        const menuSettingsDoc = await window.getDoc(menuSettingsRef);
        
        if (!menuSettingsDoc.exists()) {
          console.error('メニュー設定が見つかりません！');
          alert('メニュー設定が見つかりません。');
          return;
        }
        
        const menuSettings = menuSettingsDoc.data();
        const inventoryData = menuSettings.inventory || {};
        console.log(' 在庫データ（全データ）:', JSON.stringify(inventoryData, null, 2));
        
        // 在庫が少ない商品をチェック
        const lowStockItems = [];
        let checkedCount = 0;
        
        // inventory_settingsの各商品IDをチェック
        for (const [itemId, settings] of Object.entries(alertSettings)) {
          console.log(`\n--- チェック ${checkedCount + 1} ---`);
          console.log('商品ID:', itemId);
          console.log('設定:', settings);
          console.log('設定のタイプ:', typeof settings);
          
          if (typeof settings === 'object' && settings !== null) {
            const stock = settings.stock;
            const alertThreshold = settings.alertThreshold;
            
            console.log('  stock:', stock);
            console.log('  alertThreshold:', alertThreshold);
            
            // stockとalertThresholdの両方がnullでない場合のみチェック
            if (stock !== null && stock !== undefined && alertThreshold !== null && alertThreshold !== undefined) {
              checkedCount++;
              
              console.log(`  商品ID ${itemId}: 現在庫=${stock}, 閾値=${alertThreshold}`);
              console.log(`  比較: ${stock} <= ${alertThreshold} = ${stock <= alertThreshold}`);
              
              if (stock <= alertThreshold) {
                console.log(`   在庫不足検出！`);
                
                // メニュー名を取得（menusコレクションから）
                try {
                  const menuRef = window.getStoreDoc('menus', itemId);
                  const menuDoc = await window.getDoc(menuRef);
                  const itemName = menuDoc.exists() ? menuDoc.data().name : itemId;
                  
                  lowStockItems.push({
                    name: itemName,
                    current: stock,
                    threshold: alertThreshold
                  });
                } catch (e) {
                  console.error('メニュー名取得エラー:', e);
                  lowStockItems.push({
                    name: itemId,
                    current: stock,
                    threshold: alertThreshold
                  });
                }
              }
            } else {
              console.log(`  ️ 商品ID ${itemId}: アラート無効（stock=${stock}, alertThreshold=${alertThreshold}）`);
            }
          } else {
            console.log(`  ️ 商品ID ${itemId}: 無効な設定形式`);
          }
        }
        
        console.log('\n=== チェック結果 ===');
        console.log('チェックした商品数:', checkedCount);
        console.log('在庫不足商品数:', lowStockItems.length);
        console.log('在庫不足商品:', lowStockItems);
        
        // アラート表示（削除 - 在庫設定に関わらずアラートを表示しない）
        if (lowStockItems.length > 0) {
          console.log(' 在庫が少なくなっています（アラートは非表示）:', lowStockItems);
          // アラートは表示しない
        } else {
          console.log(' 在庫は十分です（または有効なアラート設定なし）');
        }
        
      } catch (error) {
        console.error('在庫アラートチェックエラー');
        console.error('エラー詳細:', error);
        console.error('スタックトレース:', error.stack);
        // エラーアラートも非表示
      }
    }
    
    // レシート設定をグローバル変数で保持
    window.receiptSettings = {
      storeName: '粉もん屋 八',
      branchName: '下赤塚店',
      address: '東京都板橋区赤塚新町',
      phone: '03-XXXX-XXXX'
    };
    
    // レシート設定を読み込む関数
    async function loadReceiptSettings() {
      try {
        console.log(' レシート設定を読み込み中...');
        
        // 下赤塚店（currentStoreId = null）の場合は旧パス、それ以外は新パス
        let receiptSettingsRef;
        if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
          receiptSettingsRef = window.doc(window.db, 'receipt_settings', 'shimoakatsuka');
          console.log('  → 旧パス: receipt_settings/shimoakatsuka');
        } else {
          receiptSettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'receipt_settings', 'default');
          console.log('  → 新パス: stores/' + window.currentStoreId + '/receipt_settings/default');
        }
        
        const receiptSettingsDoc = await window.getDoc(receiptSettingsRef);
        
        if (receiptSettingsDoc.exists()) {
          const settings = receiptSettingsDoc.data();
          window.receiptSettings = {
            storeName: settings.storeName || '粉もん屋 八',
            branchName: settings.branchName || '下赤塚店',
            address: settings.address || '東京都板橋区赤塚新町',
            phone: settings.phone || '03-XXXX-XXXX',
            postalCode: settings.postalCode || '',
            message: settings.message || '',
            stampImage: settings.stampImage || '',  // Base64画像データ
            stampCanvas: null  // Canvas context（印刷用）
          };
          console.log(' レシート設定を読み込みました:', window.receiptSettings);
          
          // 印鑑画像をCanvasに変換
          if (settings.stampImage) {
            console.log('   印鑑画像: あり - Canvasに変換中...');
            try {
              const img = new Image();
              img.src = settings.stampImage;
              
              await new Promise((resolve, reject) => {
                img.onload = () => {
                  const canvas = document.createElement('canvas');
                  canvas.width = img.width;
                  canvas.height = img.height;
                  const ctx = canvas.getContext('2d');
                  ctx.drawImage(img, 0, 0);
                  
                  window.receiptSettings.stampCanvas = ctx;
                  console.log('   印鑑画像をCanvasに変換しました (', img.width, 'x', img.height, ')');
                  resolve();
                };
                img.onerror = (error) => {
                  console.error('   印鑑画像の変換に失敗:', error);
                  resolve();  // エラーでも続行
                };
              });
            } catch (error) {
              console.error('   印鑑画像の変換エラー:', error);
            }
          }
        } else {
          console.log(' レシート設定が見つかりません。デフォルト設定を使用します。');
        }
      } catch (error) {
        console.error(' レシート設定読み込みエラー:', error);
      }
    }
    
    // menu.htmlのiframeのsrcを更新する関数
    function updateMenuIframe() {
      console.log('️ updateMenuIframe呼び出し');
      const iframe = document.getElementById('menuIframe');
      
      if (!iframe) {
        console.error(' menuIframeが見つかりません - 1秒後に再試行');
        setTimeout(() => {
          updateMenuIframe();
        }, 1000);
        return;
      }
      
      console.log(' menuIframe要素を発見');
      console.log('   iframe.style.display:', iframe.style.display);
      console.log('   iframe親要素の表示状態:', iframe.parentElement ? iframe.parentElement.style.display : 'N/A');
      
      let iframeSrc;
      if (window.currentStoreId) {
        iframeSrc = `menu.html?mode=pos&hideHeader=true&store=${window.currentStoreId}&t=${Date.now()}`;
        console.log('️ menu.htmlのiframeを更新 (店舗ID有):', iframeSrc);
      } else {
        // 旧システム（店舗IDなし）の場合
        iframeSrc = `menu.html?mode=pos&hideHeader=true&t=${Date.now()}`;
        console.log('️ menu.htmlのiframeを更新 (店舗IDなし):', iframeSrc);
      }
      
      // iframe srcを設定
      console.log(' iframe srcを設定中...');
      iframe.src = iframeSrc;
      
      // 読み込み監視
      iframe.onload = function() {
        console.log('menu.html iframe読み込み完了！');
      };
      
      iframe.onerror = function(e) {
        console.error(' menu.html iframe読み込みエラー:', e);
      };
      
      // 5秒後に読み込み状態を確認
      setTimeout(() => {
        if (iframe.src === iframeSrc) {
          console.log(' 5秒後の確認: iframe srcは正しく設定されています');
          console.log('   現在のsrc:', iframe.src);
        } else {
          console.warn(' 5秒後の確認: iframe srcが変更されています');
        }
      }, 5000);
    }
    
    // ログアウト処理（オシャレなモーダル使用）
    async function handleLogout() {
      const confirmed = await showCustomConfirm({
        icon: '',
        title: 'ログアウト',
        message: 'ログアウトしますか？\n保存されていないデータは失われます。',
        btnClass: 'modal-btn-danger',
        btnText: 'ログアウト'
      });
      
      if (confirmed) {
        sessionStorage.removeItem('posAuthenticated');
        sessionStorage.removeItem('posStoreId');
        sessionStorage.removeItem('posStoreName');
        sessionStorage.removeItem('businessDate');  // 営業日もクリア
        window.currentStoreId = null;
        window.currentStoreName = null;
        window.selectedBusinessDate = null;  // NEW
        
        // ログアウト完了メッセージ
        await showCustomConfirm({
          icon: '',
          title: 'ログアウト完了',
          message: 'またのご利用をお待ちしております',
          btnClass: 'modal-btn-success',
          btnText: 'OK'
        });
        
        location.reload();
      }
    }
  </script>
  
  <!-- カスタム確認モーダル -->
  <div id="customConfirmModal" class="custom-modal-overlay">
    <div class="custom-modal-box">
      <div class="modal-icon" id="modalIcon">!</div>
      <div class="modal-title" id="modalTitle">確認</div>
      <div class="modal-message" id="modalMessage">本当に実行しますか？</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeCustomModal()">キャンセル</button>
        <button class="modal-btn modal-btn-danger" id="modalConfirmBtn" onclick="confirmCustomModal()">実行</button>
      </div>
    </div>
  </div>
  
  <script>
    // カスタム確認モーダル
    let customModalResolve = null;
    
    function showCustomConfirm(options) {
      return new Promise((resolve) => {
        customModalResolve = resolve;
        
        const modal = document.getElementById('customConfirmModal');
        const icon = document.getElementById('modalIcon');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        
        icon.textContent = options.icon || '!';
        title.textContent = options.title || '確認';
        message.textContent = options.message || '本当に実行しますか？';
        
        confirmBtn.className = 'modal-btn ' + (options.btnClass || 'modal-btn-danger');
        confirmBtn.textContent = options.btnText || '実行';
        
        modal.style.display = 'flex';
      });
    }
    
    function closeCustomModal() {
      document.getElementById('customConfirmModal').style.display = 'none';
      if (customModalResolve) {
        customModalResolve(false);
        customModalResolve = null;
      }
    }
    
    function confirmCustomModal() {
      document.getElementById('customConfirmModal').style.display = 'none';
      if (customModalResolve) {
        customModalResolve(true);
        customModalResolve = null;
      }
    }
    
    // ========== リアルタイム在庫パネル ==========
    
    // 在庫パネルを更新
    async function updateInventoryPanel() {
      try {
        console.log(' 在庫パネルを更新中...');
        
        // inventory_settings を取得
        let inventorySettingsRef;
        if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
          inventorySettingsRef = window.doc(window.db, 'inventory_settings', 'default');
        } else {
          inventorySettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
        }
        
        const inventorySettingsSnap = await window.getDoc(inventorySettingsRef);
        
        if (!inventorySettingsSnap.exists()) {
          console.log(' 在庫設定が存在しません');
          document.getElementById('inventoryPanelContent').innerHTML = '<div style="padding: 10px; text-align: center; color: #999;">在庫設定なし</div>';
          // バーの色を通常に戻す
          document.getElementById('inventoryPanelBar').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          return;
        }
        
        const inventorySettingsData = inventorySettingsSnap.data();
        const inventoryItems = inventorySettingsData.items || {};
        
        // menusコレクションから商品名を取得
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        const idToNameMap = {};
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          const itemId = data.id || doc.id;
          if (data.name) {
            idToNameMap[itemId] = data.name;
          }
        });
        
        // 在庫が設定されている商品のみ表示（在庫少・品切れを優先）
        const lowStockItems = [];
        const outOfStockItems = [];
        const normalStockItems = [];
        
        for (const [itemId, settings] of Object.entries(inventoryItems)) {
          const stock = settings.stock;
          const alertThreshold = settings.alertThreshold;
          const itemName = idToNameMap[itemId] || itemId;
          
          // stockがnullでない（在庫管理対象）場合のみ表示
          if (stock !== null && stock !== undefined) {
            const item = { id: itemId, name: itemName, stock, alertThreshold };
            
            if (stock === 0) {
              outOfStockItems.push(item);
            } else if (alertThreshold !== null && alertThreshold !== undefined && stock <= alertThreshold) {
              lowStockItems.push(item);
            } else {
              normalStockItems.push(item);
            }
          }
        }
        
        // バーの色を在庫状態に応じて変更
        const panelBar = document.getElementById('inventoryPanelBar');
        if (outOfStockItems.length > 0) {
          // 在庫切れがある場合は赤
          panelBar.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
        } else if (lowStockItems.length > 0) {
          // 在庫少がある場合は黄色
          panelBar.style.background = 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
        } else {
          // 問題なしの場合は紫（通常）
          panelBar.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        }
        
        // 表示用HTML生成
        let html = '';
        
        // 品切れ（赤）
        outOfStockItems.forEach(item => {
          html += `
            <div style="padding: 8px 12px; background: #ffebee; border-left: 4px solid #f44336; margin-bottom: 6px; border-radius: 4px;">
              <div style="font-weight: bold; color: #f44336; font-size: 14px;">${item.name}</div>
              <div style="color: #f44336; font-size: 13px; font-weight: bold;">品切</div>
            </div>
          `;
        });
        
        // 在庫少（黄）
        lowStockItems.forEach(item => {
          html += `
            <div style="padding: 8px 12px; background: #fff9e6; border-left: 4px solid #ff9800; margin-bottom: 6px; border-radius: 4px;">
              <div style="font-weight: bold; color: #ff9800; font-size: 14px;">${item.name}</div>
              <div style="color: #ff9800; font-size: 13px;">残 ${item.stock}</div>
            </div>
          `;
        });
        
        // 通常在庫（表示しない、または折りたたみ）
        // ここでは在庫が少ないもののみ表示
        
        if (html === '') {
          html = '<div style="padding: 10px; text-align: center; color: #4caf50; font-weight: bold;">在庫充分</div>';
        }
        
        document.getElementById('inventoryPanelContent').innerHTML = html;
        console.log(' 在庫パネル更新完了');
        
      } catch (error) {
        console.error(' 在庫パネル更新エラー:', error);
      }
    }
    
    // 在庫パネルの表示/非表示切り替え
    function toggleInventoryPanel() {
      const panel = document.getElementById('inventoryPanel');
      const arrow = document.getElementById('inventoryPanelArrow');
      const isCollapsed = panel.classList.contains('collapsed');
      
      if (isCollapsed) {
        panel.classList.remove('collapsed');
        panel.style.maxHeight = '400px';
        arrow.textContent = '▼';
      } else {
        panel.classList.add('collapsed');
        panel.style.maxHeight = '45px';
        arrow.textContent = '▲';
      }
    }
    
    // プリンタ設定関数群
    
    // 接続方式を選択
    window.selectConnectionType = function(type) {
      PRINTER_CONNECTION_TYPE = type;
      
      const ethernetBtn = document.getElementById('connectionTypeEthernet');
      const bluetoothBtn = document.getElementById('connectionTypeBluetooth');
      const ethernetSettings = document.getElementById('ethernetSettings');
      const bluetoothSettings = document.getElementById('bluetoothSettings');
      
      if (type === 'ethernet') {
        ethernetBtn.style.background = '#667eea';
        ethernetBtn.style.color = 'white';
        bluetoothBtn.style.background = 'white';
        bluetoothBtn.style.color = '#666';
        ethernetSettings.style.display = 'block';
        bluetoothSettings.style.display = 'none';
      } else {
        ethernetBtn.style.background = 'white';
        ethernetBtn.style.color = '#666';
        bluetoothBtn.style.background = '#667eea';
        bluetoothBtn.style.color = 'white';
        ethernetSettings.style.display = 'none';
        bluetoothSettings.style.display = 'block';
      }
    };
    
    // Bluetooth検索の案内を表示
    window.showBluetoothSearchGuide = function() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;';
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <div style="text-align: center; margin-bottom: 25px;">
            <div style="width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 50%; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold;">
              BT
            </div>
            <h3 style="font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #333;">Bluetoothプリンタの検索</h3>
          </div>
          
          <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
            <p style="font-size: 15px; color: #555; margin-bottom: 12px; line-height: 1.6;">
              この後、ブラウザのペア設定画面が表示されます。
            </p>
            <p style="font-size: 14px; color: #666; line-height: 1.6;">
              <strong style="color: #333;">確認事項：</strong><br>
              • プリンタの電源が入っている<br>
              • BluetoothがONになっている<br>
              • ペアリングモードになっている
            </p>
          </div>
          
          <div style="display: flex; gap: 12px;">
            <button onclick="this.closest('.modal-overlay').remove()" style="flex: 1; padding: 15px; font-size: 16px; font-weight: bold; border: 2px solid #ddd; background: white; color: #666; border-radius: 10px; cursor: pointer;">
              キャンセル
            </button>
            <button onclick="this.closest('.modal-overlay').remove(); window.startBluetoothSearch();" style="flex: 1; padding: 15px; font-size: 16px; font-weight: bold; border: none; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 15px rgba(33,150,243,0.3);">
              検索開始
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    };
    
    // Bluetoothプリンタを検索（実際の検索処理）
    window.startBluetoothSearch = async function() {
      try {
        console.log('Bluetoothプリンタを検索中...');
        
        // Web Bluetooth APIを使用してデバイスを検索
        const device = await navigator.bluetooth.requestDevice({
          filters: [
            { services: ['000018f0-0000-1000-8000-00805f9b34fb'] }, // ESC/POS Service
          ],
          optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });
        
        console.log('デバイス発見:', device.name);
        
        // デバイスに接続
        const server = await device.gatt.connect();
        console.log('GATT接続成功');
        
        // プリンタサービスを取得
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        console.log('サービス取得成功');
        
        // 書き込み用Characteristicを取得
        const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
        console.log('Characteristic取得成功');
        
        // グローバル変数に保存
        BLUETOOTH_DEVICE = device;
        BLUETOOTH_CHARACTERISTIC = characteristic;
        
        // デバイス名を表示
        document.getElementById('bluetoothDeviceInfo').style.display = 'block';
        document.getElementById('bluetoothDeviceName').textContent = device.name || '不明なデバイス';
        
        // localStorageに保存
        localStorage.setItem('bluetoothDeviceName', device.name || '');
        
        // 成功メッセージ
        showCustomAlert('接続成功', 'Bluetoothプリンタに接続しました\n' + (device.name || '不明なデバイス'), 'success');
        
      } catch (error) {
        console.error('Bluetooth接続エラー:', error);
        
        // エラーメッセージ
        if (error.name === 'NotFoundError') {
          showCustomAlert('デバイスが見つかりません', 'Bluetoothプリンタが見つかりませんでした。\n\nプリンタの電源が入っているか確認してください。', 'error');
        } else if (error.name === 'SecurityError' || error.name === 'NotAllowedError') {
          // キャンセル時は何も表示しない
          console.log('検索がキャンセルされました');
        } else {
          showCustomAlert('接続エラー', 'Bluetoothプリンタの検索に失敗しました。\n\nブラウザがBluetooth対応か確認してください（Chrome、Edge推奨）', 'error');
        }
      }
    };
    
    // Bluetoothプリンタを検索（エントリーポイント）
    window.searchBluetoothPrinter = function() {
      showBluetoothSearchGuide();
    };
    
    // カスタムアラート表示関数
    function showCustomAlert(title, message, type = 'info') {
      const iconMap = {
        success: '',
        error: '',
        info: 'i'
      };
      
      const colorMap = {
        success: '#4CAF50',
        error: '#f44336',
        info: '#2196F3'
      };
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;';
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center;">
          <div style="width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 50%; background: ${colorMap[type]}; color: white; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold;">
            ${iconMap[type]}
          </div>
          <h3 style="font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #333;">${title}</h3>
          <p style="font-size: 16px; color: #666; margin-bottom: 30px; white-space: pre-line;">${message}</p>
          <button onclick="this.closest('.modal-overlay').remove()" style="padding: 15px 40px; font-size: 16px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: ${colorMap[type]}; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            OK
          </button>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    // ESC/POSコマンドを生成するヘルパー関数
    function createESCPOSCommand(text) {
      const encoder = new TextEncoder();
      const commands = [];
      
      // 初期化
      commands.push(new Uint8Array([0x1B, 0x40]));
      
      // テキストを追加
      commands.push(encoder.encode(text));
      
      // 改行 + カット
      commands.push(new Uint8Array([0x0A, 0x0A, 0x0A]));
      commands.push(new Uint8Array([0x1D, 0x56, 0x00])); // カット
      
      // すべてのコマンドを結合
      const totalLength = commands.reduce((sum, cmd) => sum + cmd.length, 0);
      const result = new Uint8Array(totalLength);
      let offset = 0;
      for (const cmd of commands) {
        result.set(cmd, offset);
        offset += cmd.length;
      }
      
      return result;
    }
    
    // Bluetooth印刷関数
    async function printViaBluetooth(text) {
      if (!BLUETOOTH_CHARACTERISTIC) {
        throw new Error('Bluetoothプリンタが接続されていません');
      }
      
      try {
        const command = createESCPOSCommand(text);
        
        // 512バイトずつ送信（Bluetoothの制限）
        const chunkSize = 512;
        for (let i = 0; i < command.length; i += chunkSize) {
          const chunk = command.slice(i, Math.min(i + chunkSize, command.length));
          await BLUETOOTH_CHARACTERISTIC.writeValue(chunk);
          await new Promise(resolve => setTimeout(resolve, 100)); // 少し待つ
        }
        
        console.log(' Bluetooth印刷完了');
      } catch (error) {
        console.error(' Bluetooth印刷エラー:', error);
        throw error;
      }
    }
    
    // プリンタ設定モーダルを表示
    window.showPrinterSettings = function() {
      document.getElementById('printerIPInput').value = PRINTER_IP;
      selectConnectionType(PRINTER_CONNECTION_TYPE);
      
      // 保存されているBluetoothデバイス名を表示
      const savedDeviceName = localStorage.getItem('bluetoothDeviceName');
      if (savedDeviceName && PRINTER_CONNECTION_TYPE === 'bluetooth') {
        document.getElementById('bluetoothDeviceInfo').style.display = 'block';
        document.getElementById('bluetoothDeviceName').textContent = savedDeviceName + ' (再接続が必要)';
      }
      
      document.getElementById('printerSettingsModal').style.display = 'flex';
      document.getElementById('printerTestResult').style.display = 'none';
    };
    
    // プリンタ設定モーダルを閉じる
    window.closePrinterSettings = function() {
      document.getElementById('printerSettingsModal').style.display = 'none';
    };
    
    // プリンタ設定を保存
    window.savePrinterSettings = function() {
      if (PRINTER_CONNECTION_TYPE === 'ethernet') {
        const newIP = document.getElementById('printerIPInput').value.trim();
        
        // IPアドレスの簡易バリデーション
        const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
        if (!ipPattern.test(newIP)) {
          alert('正しいIPアドレスを入力してください\n例: 192.168.1.100');
          return;
        }
        
        PRINTER_IP = newIP;
        localStorage.setItem('printerIP', newIP);
        localStorage.setItem('printerConnectionType', 'ethernet');
        
        alert('プリンタ設定を保存しました\n接続方式: WiFi/LAN\nIP: ' + newIP);
      } else {
        if (!BLUETOOTH_DEVICE) {
          alert('Bluetoothプリンタを検索して接続してください');
          return;
        }
        
        localStorage.setItem('printerConnectionType', 'bluetooth');
        alert('プリンタ設定を保存しました\n接続方式: Bluetooth\nデバイス: ' + (BLUETOOTH_DEVICE.name || '不明'));
      }
      
      closePrinterSettings();
    };
    
    // プリンタ接続テスト
    window.testPrinterConnection = async function() {
      const resultDiv = document.getElementById('printerTestResult');
      
      resultDiv.style.display = 'block';
      resultDiv.style.background = '#FFF9C4';
      resultDiv.style.color = '#F57F17';
      resultDiv.textContent = '接続テスト中...';
      
      try {
        if (PRINTER_CONNECTION_TYPE === 'bluetooth') {
          // Bluetooth接続テスト
          if (!BLUETOOTH_CHARACTERISTIC) {
            resultDiv.style.background = '#FFCDD2';
            resultDiv.style.color = '#C62828';
            resultDiv.innerHTML = 'Bluetoothプリンタが未接続<br>先にプリンタを検索してください';
            return;
          }
          
          await printViaBluetooth('=== 接続テスト ===\n印刷成功！\n\n');
          
          resultDiv.style.background = '#C8E6C9';
          resultDiv.style.color = '#2E7D32';
          resultDiv.innerHTML = '接続成功！<br>Bluetoothプリンタと通信できました';
          
        } else {
          // Ethernet接続テスト
          const testIP = document.getElementById('printerIPInput').value.trim();
          
          const builder = new StarWebPrintBuilder();
          builder.createInitializationElement();
          builder.createTextElement({data: '=== 接続テスト ===\n'});
          builder.createTextElement({data: '印刷成功！\n\n'});
          builder.createCutPaperElement({feed: true});
          
          const url = `http://${testIP}/StarWebPRNT/SendMessage`;
          const request = builder.toString();
          
          const trader = new StarWebPrintTrader({url: url});
          
          trader.onReceive = function(response) {
            console.log(' 接続テスト成功:', response);
            resultDiv.style.background = '#C8E6C9';
            resultDiv.style.color = '#2E7D32';
            resultDiv.innerHTML = '接続成功！<br>プリンタと通信できました';
          };
          
          trader.onError = function(response) {
            console.error(' 接続テスト失敗:', response);
            resultDiv.style.background = '#FFCDD2';
            resultDiv.style.color = '#C62828';
            resultDiv.innerHTML = `接続失敗<br>${response.status || 'プリンタに接続できません'}<br><small>IPアドレスとネットワーク接続を確認してください</small>`;
          };
          
          trader.sendMessage({request: request});
        }
        
      } catch (error) {
        console.error(' 接続テストエラー:', error);
        resultDiv.style.background = '#FFCDD2';
        resultDiv.style.color = '#C62828';
        resultDiv.innerHTML = `エラー<br>${error.message}`;
      }
    };
    
    // 初回読み込み時に設定を復元
    document.addEventListener('DOMContentLoaded', () => {
      // 自動印刷設定を復元
      const savedAutoPrint = localStorage.getItem('autoPrintEnabled') === 'true';
      autoPrintEnabled = savedAutoPrint;
      if (document.getElementById('autoPrintToggle')) {
        document.getElementById('autoPrintToggle').checked = savedAutoPrint;
        toggleAutoPrint();
      }
      
      // プリンタ接続方式を復元
      const savedConnectionType = localStorage.getItem('printerConnectionType') || 'ethernet';
      PRINTER_CONNECTION_TYPE = savedConnectionType;
      console.log(' プリンタ接続方式:', PRINTER_CONNECTION_TYPE);
      
      // Bluetoothの場合、自動再接続は行わない（ユーザーが手動で接続する必要がある）
      if (PRINTER_CONNECTION_TYPE === 'bluetooth') {
        console.log('Bluetooth接続モードです。プリンタ設定から接続してください。');
      }
    });
    
    // inventory_settingsの変更をリアルタイム監視
    function watchInventoryChanges() {
      let inventorySettingsRef;
      if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
        inventorySettingsRef = window.doc(window.db, 'inventory_settings', 'default');
      } else {
        inventorySettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
      }
      
      const unsubscribe = window.onSnapshot(inventorySettingsRef, (doc) => {
        if (doc.exists()) {
          console.log(' 在庫データが更新されました');
          updateInventoryPanel();
        }
      });
      
      return unsubscribe;
    }
  </script>
  
  <!-- 経費出力の年月選択モーダル -->
  <div id="expenseExportModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <div style="font-size: 64px; text-align: center; margin-bottom: 20px;"></div>
      <h3 style="font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 15px; color: #333;">経費出力</h3>
      <p style="text-align: center; font-size: 16px; color: #666; margin-bottom: 20px;">出力する年月を選択してください</p>
      <div style="margin: 20px 0;">
        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
          <select id="expenseExportYear" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 16px;">
            <!-- 年の選択肢 -->
          </select>
          <select id="expenseExportMonth" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 16px;">
            <option value="1">1月</option>
            <option value="2">2月</option>
            <option value="3">3月</option>
            <option value="4">4月</option>
            <option value="5">5月</option>
            <option value="6">6月</option>
            <option value="7">7月</option>
            <option value="8">8月</option>
            <option value="9">9月</option>
            <option value="10">10月</option>
            <option value="11">11月</option>
            <option value="12">12月</option>
          </select>
        </div>
      </div>
      <div style="display: flex; gap: 15px; margin-top: 30px;">
        <button onclick="closeExpenseExportModal()" style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: #e0e0e0; color: #666;">キャンセル</button>
        <button onclick="confirmExpenseExport()" style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white;">出力</button>
      </div>
    </div>
  </div>
  
  <!-- リアルタイム在庫パネル -->
  <div id="inventoryPanel" style="position: fixed; bottom: 20px; right: 20px; width: 300px; max-height: 400px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 9999; overflow: hidden; transition: all 0.3s ease;">
    <div id="inventoryPanelBar" onclick="toggleInventoryPanel()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.3s ease;">
      <div style="font-weight: bold; color: white; font-size: 15px;">在庫状況</div>
      <div id="inventoryPanelArrow" style="color: white; font-size: 18px;">▼</div>
    </div>
    <div id="inventoryPanelContent" style="max-height: 350px; overflow-y: auto; padding: 10px;">
      <div style="padding: 10px; text-align: center; color: #999;">読み込み中...</div>
    </div>
  </div>
  
  <!-- プリンタ設定モーダル -->
  <div id="printerSettingsModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <h3 style="font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 15px; color: #333;">プリンタ設定</h3>
      <p style="text-align: center; font-size: 16px; color: #666; margin-bottom: 30px;">TSP650II / mC-Print3 / Bluetooth対応</p>
      
      <!-- 接続方式選択 -->
      <div style="margin-bottom: 25px;">
        <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">接続方式</label>
        <div style="display: flex; gap: 10px;">
          <button id="connectionTypeEthernet" onclick="selectConnectionType('ethernet')" 
                  style="flex: 1; padding: 15px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
            WiFi / LAN
          </button>
          <button id="connectionTypeBluetooth" onclick="selectConnectionType('bluetooth')" 
                  style="flex: 1; padding: 15px; border: 2px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
            Bluetooth
          </button>
        </div>
      </div>
      
      <!-- Ethernet設定 -->
      <div id="ethernetSettings" style="display: block;">
        <div style="margin-bottom: 25px;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">プリンタIPアドレス</label>
          <input type="text" id="printerIPInput" placeholder="例: 192.168.1.100" 
                 style="width: 100%; padding: 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
          <div style="margin-top: 8px; font-size: 14px; color: #666;">
            プリンタのIPアドレスを入力してください<br>
            <small style="color: #999;">※プリンタの設定印刷で確認できます</small>
          </div>
        </div>
      </div>
      
      <!-- Bluetooth設定 -->
      <div id="bluetoothSettings" style="display: none;">
        <div style="margin-bottom: 25px;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">Bluetoothプリンタ</label>
          <button onclick="searchBluetoothPrinter()" 
                  style="width: 100%; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; box-shadow: 0 4px 15px rgba(33,150,243,0.3);">
            プリンタを検索
          </button>
          <div id="bluetoothDeviceInfo" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 8px; display: none;">
            <div style="font-weight: bold; color: #333;">接続済みプリンタ:</div>
            <div id="bluetoothDeviceName" style="color: #666; margin-top: 5px;">なし</div>
          </div>
          <div style="margin-top: 8px; font-size: 14px; color: #666;">
            ESC/POS対応のBluetoothプリンタを検索します<br>
            <small style="color: #999;">※Chrome、Edgeで利用可能</small>
          </div>
        </div>
      </div>
      
      <div style="margin-bottom: 25px;">
        <button onclick="testPrinterConnection()" id="testConnectionBtn"
                style="width: 100%; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; box-shadow: 0 4px 15px rgba(76,175,80,0.3);">
          接続テスト
        </button>
        <div id="printerTestResult" style="margin-top: 10px; padding: 10px; border-radius: 8px; display: none;"></div>
      </div>
      
      <div style="display: flex; gap: 15px; margin-top: 30px;">
        <button onclick="closePrinterSettings()" 
                style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: #e0e0e0; color: #666;">
          キャンセル
        </button>
        <button onclick="savePrinterSettings()" 
                style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          保存
        </button>
      </div>
    </div>
  </div>
  
</body>
</html>
