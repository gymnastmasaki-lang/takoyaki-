<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow, noarchive">
  <meta name="googlebot" content="noindex, nofollow, noarchive">
  <meta name="bingbot" content="noindex, nofollow, noarchive">
  <title>ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº— - ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ </title>
  <script src="https://www.star-m.jp/products/s_print/sdk/starwebprinttracer/v1.1.0/StarWebPrintTrader.js"></script>
  <script src="https://www.star-m.jp/products/s_print/sdk/starwebprintbuilder/v1.2.0/StarWebPrintBuilder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc, doc, Timestamp, onSnapshot, addDoc, orderBy, getDoc, setDoc, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.db = db;
    window.storage = storage;
    window.storageRef = ref;
    window.uploadBytes = uploadBytes;
    window.getDownloadURL = getDownloadURL;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.updateDoc = updateDoc;
    window.doc = doc;
    window.Timestamp = Timestamp;
    window.onSnapshot = onSnapshot;
    window.addDoc = addDoc;
    window.orderBy = orderBy;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.limit = limit;
    window.deleteDoc = deleteDoc;
    
    // åˆæœŸåŒ–å®Œäº†ãƒ•ãƒ©ã‚°
    window.firebaseReady = true;
    console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº† (Firestore + Storage)');
    
    // åˆæœŸåŒ–å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œ
    window.dispatchEvent(new Event('firebaseReady'));
    
    // æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
    loadStaffList();
  </script>
  
  <script>
    // æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€ï¼ˆkanri.htmlã®å¾“æ¥­å“¡ãƒªã‚¹ãƒˆã‹ã‚‰ï¼‰
    async function loadStaffList() {
      try {
        const staffSelect = document.getElementById('staffSelect');
        const staffSnapshot = await getDocs(collection(db, 'kintai_employees'));
        
        // ãƒªã‚»ãƒƒãƒˆ
        staffSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        
        staffSnapshot.forEach(doc => {
          const data = doc.data();
          const option = document.createElement('option');
          option.value = data.name || '';
          option.textContent = data.name || '';
          staffSelect.appendChild(option);
        });
        
        console.log('âœ… æ‹…å½“è€…ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å®Œäº†');
      } catch (e) {
        console.error('âŒ æ‹…å½“è€…ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-left h1 {
      font-size: 32px;
      color: #333;
      margin-bottom: 5px;
    }
    
    .header-left .status {
      font-size: 18px;
      color: #666;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .auto-print-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f8f9fa;
      padding: 12px 20px;
      border-radius: 12px;
    }
    
    .auto-print-toggle label {
      font-weight: bold;
      color: #333;
    }
    
    .toggle-switch {
      position: relative;
      width: 60px;
      height: 30px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 30px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: #4CAF50;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(30px);
    }
    
    .toggle-status {
      font-weight: bold;
      min-width: 50px;
    }
    
    .toggle-status.on {
      color: #4CAF50;
    }
    
    .toggle-status.off {
      color: #999;
    }
    
    .main-content {
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    
    @media (max-width: 1024px) {
      .main-content {
        flex-direction: column;
      }
      
      .header {
        flex-direction: column;
        gap: 15px;
      }
    }
    
    .section {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }
    
    .section h2 {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #667eea;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚°ãƒªãƒƒãƒ‰ */
    .table-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }
    
    @media (max-width: 768px) {
      .table-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    .table-btn {
      padding: 10px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      position: relative;
      min-height: 50px;
    }
    
    .table-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    .table-btn:active {
      transform: translateY(0);
    }
    
    .table-btn.has-orders {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
    }
    
    .order-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ff4444;
      color: white;
      font-size: 12px;
      font-weight: bold;
      min-width: 24px;
      height: 24px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
      animation: pulse 1.5s infinite;
      box-shadow: 0 2px 8px rgba(255, 68, 68, 0.5);
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }
    
    /* æ³¨æ–‡è©³ç´° */
    .order-details {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .order-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-left: 5px solid #667eea;
    }
    
    .order-card.completed {
      border-left-color: #4CAF50;
      opacity: 0.7;
    }
    
    .order-card.cancelled {
      border-left-color: #f44336;
      opacity: 0.7;
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .order-number {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    
    .order-time {
      font-size: 14px;
      color: #999;
    }
    
    .order-status {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      margin-left: 10px;
    }
    
    .order-status.pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .order-status.completed {
      background: #d4edda;
      color: #155724;
    }
    
    .order-status.cancelled {
      background: #f8d7da;
      color: #721c24;
    }
    
    .order-items {
      margin: 15px 0;
    }
    
    .order-item {
      padding: 10px 0;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .order-item:last-child {
      border-bottom: none;
    }
    
    .order-item-detailed {
      padding: 15px;
      margin-bottom: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }
    
    .item-name {
      font-weight: 500;
      color: #333;
    }
    
    .item-details {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    
    .item-price {
      font-weight: bold;
      color: #667eea;
    }
    
    .order-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 3px solid #667eea;
      font-size: 24px;
      font-weight: bold;
    }
    
    .total-label {
      color: #333;
    }
    
    .total-amount {
      color: #667eea;
      font-size: 28px;
    }
    
    /* æ³¨æ–‡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    .order-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px dashed #ddd;
    }
    
    .order-action-btn {
      padding: 12px;
      font-size: 14px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .order-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .pay-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .complete-btn {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    .cancel-btn {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
    }
    
    .delete-btn {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
    }
    
    /* ãƒœã‚¿ãƒ³ */
    .btn {
      width: 100%;
      padding: 18px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      margin: 8px 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
      color: white;
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* æ‰‹å‹•å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .manual-input {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-group label {
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }
    
    .input-group input,
    .input-group select {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      transition: border-color 0.3s;
    }
    
    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .menu-items-list {
      max-height: 300px;
      overflow-y: auto;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      background: white;
    }
    
    .menu-item-checkbox {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .menu-item-checkbox:hover {
      background: #f0f0f0;
    }
    
    .menu-item-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      cursor: pointer;
    }
    
    .menu-item-info {
      flex: 1;
    }
    
    .menu-item-name-small {
      font-weight: 500;
      color: #333;
    }
    
    .menu-item-price-small {
      color: #667eea;
      font-weight: bold;
    }
    
    .selected-items {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .selected-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .selected-item-detailed {
      padding: 15px;
      margin-bottom: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }
    
    .quantity-input {
      width: 60px;
      padding: 5px;
      text-align: center;
      border: 2px solid #ddd;
      border-radius: 5px;
    }
    
    .remove-btn {
      padding: 5px 12px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .edit-btn {
      padding: 5px 12px;
      background: #FF9800;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .edit-btn:hover {
      background: #F57C00;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 18px;
    }
    
    /* æ”¯æ‰•ã„æ–¹æ³•é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    }
    
    .modal h3 {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .payment-methods {
      display: grid;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .payment-method-btn {
      padding: 20px;
      font-size: 20px;
      font-weight: bold;
      border: 3px solid #ddd;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .payment-method-btn:hover {
      border-color: #667eea;
      background: #f8f9fa;
    }
    
    .payment-method-btn.selected {
      border-color: #667eea;
      background: #e8eaf6;
    }
    
    .cash-input-section {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    
    .cash-input-section label {
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
      font-size: 18px;
    }
    
    .cash-input-section input {
      width: 100%;
      padding: 15px;
      font-size: 24px;
      border: 2px solid #ddd;
      border-radius: 8px;
      text-align: right;
    }
    
    .change-display {
      margin-top: 15px;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    
    .change-amount {
      color: #4CAF50;
      font-size: 28px;
    }
    
    /* ãƒ¬ã‚·ãƒ¼ãƒˆå®Œäº†ç”»é¢ */
    .receipt-actions {
      display: grid;
      gap: 15px;
      margin-top: 20px;
    }
    
    .receipt-btn {
      padding: 20px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .receipt-btn.print {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
    }
    
    .receipt-btn.invoice {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
    }
    
    .receipt-btn.back {
      background: #e0e0e0;
      color: #333;
    }
    
    /* ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠ */
    .topping-item {
      display: flex;
      align-items: center;
      padding: 15px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .topping-item:hover {
      border-color: #667eea;
      transform: translateX(5px);
    }
    
    .topping-item input[type="checkbox"] {
      width: 24px;
      height: 24px;
      margin-right: 15px;
      cursor: pointer;
    }
    
    .topping-item-info {
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .topping-item-name {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
    
    .topping-item-price {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
    }
    
    .hidden {
      display: none !important;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    /* ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆ */
    .custom-alert-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 99999;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s;
    }
    .custom-alert-overlay.show {
      display: flex;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .custom-alert-box {
      background: white;
      border-radius: 25px;
      padding: 40px 30px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.4s;
    }
    .custom-alert-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: bounce 0.6s;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .custom-alert-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
    }
    .custom-alert-message {
      font-size: 16px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .custom-alert-button {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border: none;
      padding: 15px 50px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 25px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
      transition: all 0.3s;
    }
    .custom-alert-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
    }
    .custom-alert-button:active {
      transform: translateY(0);
    }
    
    /* å“åˆ‡ã‚Œãƒšãƒ¼ã‚¸ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .soldout-item {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .soldout-item.sold-out {
      background: #f5f5f5;
      opacity: 0.7;
    }
    .soldout-item-name {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
    .soldout-badge {
      background: #f44336;
      color: white;
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: bold;
      margin-top: 5px;
      display: inline-block;
    }
    .soldout-toggle-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      color: white;
    }
    .soldout-toggle-btn.set-soldout {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    }
    .soldout-toggle-btn.set-available {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    }
  </style>
  
  <script>
    // ã‚¿ãƒƒãƒ—éŸ³ã‚’å†ç”Ÿã™ã‚‹é–¢æ•°
    function playBeep() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800; // 800Hzã®ãƒ“ãƒ¼ãƒ—éŸ³
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    }
    
    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã«ãƒ“ãƒ¼ãƒ—éŸ³ã‚’è¿½åŠ 
    document.addEventListener('DOMContentLoaded', function() {
      document.addEventListener('click', function(e) {
        // ãƒœã‚¿ãƒ³ã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã€.table-btnã€.menu-item-checkboxã€.topping-itemã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒ“ãƒ¼ãƒ—éŸ³
        if (e.target.closest('button') || 
            e.target.closest('.table-btn') || 
            e.target.closest('.menu-item-checkbox') || 
            e.target.closest('.topping-item') ||
            e.target.type === 'checkbox') {
          playBeep();
        }
      });
    });
  </script>
</head>
<body>
  
  <div id="loginScreen" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
      <div style="text-align: center; margin-bottom: 30px;">
        <div style="font-size: 60px; margin-bottom: 10px;">ğŸ”</div>
        <h2 style="font-size: 24px; font-weight: bold; color: #333; margin: 0;">POSã‚·ã‚¹ãƒ†ãƒ </h2>
        <p style="color: #666; margin-top: 10px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
      </div>
      
      <form onsubmit="handlePOSLogin(event)" style="margin: 0;">
        <input
          type="password"
          id="posPasswordInput"
          placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰"
          style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box; margin-bottom: 20px;"
          autofocus
        />
        
        <button
          type="submit"
          style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s;"
          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 30px rgba(102,126,234,0.4)';"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
        >
          ãƒ­ã‚°ã‚¤ãƒ³
        </button>
      </form>
      
      <div id="loginError" style="display: none; margin-top: 20px; padding: 15px; background: #fee; border: 1px solid #fcc; border-radius: 10px; color: #c00; text-align: center; font-weight: bold;">
      </div>
    </div>
  </div>
  <div id="mainContent" style="display: none;">
  <div class="container">
    
    <div class="header">
      <div class="header-left">
        <div class="status">
          <label for="staffSelect" style="margin-right: 10px; font-weight: bold;">æ‹…å½“è€…:</label>
          <select id="staffSelect" style="padding: 8px 12px; font-size: 16px; border: 2px solid #667eea; border-radius: 8px; background: white; cursor: pointer;">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
      </div>
      <div class="header-right" style="display: flex; gap: 15px; align-items: stretch;">
        
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <button onclick="window.location.href='https://gymnastmasaki-lang.github.io/takoyaki-/kintai.html'" style="padding: 10px 20px; font-size: 48px; background: linear-gradient(135deg, #3F51B5 0%, #303F9F 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; height: 100%; line-height: 1; display: flex; align-items: center; justify-content: center;">â°</button>
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          
          <div style="display: flex; gap: 10px;">
            <button onclick="increaseWaiting()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">å¾…1</button>
            <button onclick="showSoldOutPage()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">å“åˆ‡</button>
            <button id="bulk-soldout-btn" onclick="toggleBulkSoldOut()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">ä¸€æ‹¬</button>
            <button id="time-override-btn" onclick="toggleTimeOverride()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">æ™‚å¤–</button>
            <button onclick="alert('ä¸¦ã³é †æ©Ÿèƒ½ã¯æ¬¡å›å®Ÿè£…äºˆå®š')" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">ä¸¦é †</button>
          </div>
          
          <div style="display: flex; gap: 10px;">
            <button onclick="showMonthlyReportModal()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">æœˆæ¬¡</button>
            <button onclick="showSalesModal()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">å£²ä¸Š</button>
            <button onclick="showHistoryModal()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">å±¥æ­´</button>
            <button onclick="showExpenseModal()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #FF5722 0%, #E64A19 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">æ”¯å‡º</button>
            <button onclick="openDrawer()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #FFC107 0%, #FFA000 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(255,193,7,0.3);">é–‹ã</button>
          </div>
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          
          <button onclick="showProductRegistrationModal()" style="padding: 12px 40px; font-size: 16px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; flex: 1;">å•†å“ç™»éŒ²</button>
          
          <button onclick="showProductDeleteModal()" style="padding: 12px 40px; font-size: 16px; background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; flex: 1;">å•†å“å‰Šé™¤</button>
        </div>
      </div>
    </div>
    
    <div class="main-content">
      
      <div class="section">
        <!-- ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠ h2å‰Šé™¤ -->
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
          
          <div style="background: linear-gradient(135deg, #81C784 0%, #66BB6A 100%); padding: 8px 10px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 5px; min-height: 50px;">
            <label style="margin: 0; white-space: nowrap; font-size: 12px; font-weight: bold; color: white;">ãƒ¬ã‚·ãƒ¼ãƒˆè‡ªå‹•ç™ºè¡Œ</label>
            <div style="display: flex; align-items: center; gap: 6px;">
              <label class="toggle-switch" style="margin: 0;">
                <input type="checkbox" id="autoPrintToggle" checked onchange="toggleAutoPrint()">
                <span class="toggle-slider"></span>
              </label>
              <span class="toggle-status on" id="autoPrintStatus" style="margin: 0; font-size: 12px; font-weight: bold; color: white;">ON</span>
            </div>
          </div>
          <div style="background: linear-gradient(135deg, #FFB74D 0%, #FFA726 100%); padding: 8px 10px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px; min-height: 50px;">
            <div style="font-size: 12px; font-weight: bold; color: white;">æ‰‹å‹•å¾…ã¡äººæ•°</div>
            <div style="font-size: 24px; font-weight: bold; color: white;" id="manual-count">0</div>
            <button onclick="resetWaiting()" style="padding: 5px 12px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; white-space: nowrap;">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
          <button class="table-btn" onclick="selectTable('å³ä¼šè¨ˆ')" id="table-å³ä¼šè¨ˆ" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-size: 16px; font-weight: bold;">å³ä¼šè¨ˆ</button>
          <button class="table-btn" onclick="selectTable('ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ')" id="table-ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ">ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ</button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
          <button class="table-btn" onclick="selectTable('c1')" id="table-c1">c1</button>
          <button class="table-btn" onclick="selectTable('c2')" id="table-c2">c2</button>
          <button class="table-btn" onclick="selectTable('T-H')" id="table-T-H">T-H</button>
          <button class="table-btn" onclick="selectTable('T-M')" id="table-T-M">T-M</button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 10px;">
          <button class="table-btn" onclick="selectTable('äºˆç´„1')" id="table-äºˆç´„1" style="position: relative;">
            <span style="position: absolute; top: 3px; right: 3px; font-size: 14px; cursor: pointer; z-index: 10;" onclick="event.stopPropagation(); showReservationMemoModal('äºˆç´„1');">ğŸ“</span>
            <span>äºˆç´„1</span>
          </button>
          <button class="table-btn" onclick="selectTable('äºˆç´„2')" id="table-äºˆç´„2" style="position: relative;">
            <span style="position: absolute; top: 3px; right: 3px; font-size: 14px; cursor: pointer; z-index: 10;" onclick="event.stopPropagation(); showReservationMemoModal('äºˆç´„2');">ğŸ“</span>
            <span>äºˆç´„2</span>
          </button>
          <button class="table-btn" onclick="selectTable('äºˆç´„3')" id="table-äºˆç´„3" style="position: relative;">
            <span style="position: absolute; top: 3px; right: 3px; font-size: 14px; cursor: pointer; z-index: 10;" onclick="event.stopPropagation(); showReservationMemoModal('äºˆç´„3');">ğŸ“</span>
            <span>äºˆç´„3</span>
          </button>
          <button class="table-btn" onclick="selectTable('äºˆç´„4')" id="table-äºˆç´„4" style="position: relative;">
            <span style="position: absolute; top: 3px; right: 3px; font-size: 14px; cursor: pointer; z-index: 10;" onclick="event.stopPropagation(); showReservationMemoModal('äºˆç´„4');">ğŸ“</span>
            <span>äºˆç´„4</span>
          </button>
          <button class="table-btn" onclick="selectTable('äºˆç´„5')" id="table-äºˆç´„5" style="position: relative;">
            <span style="position: absolute; top: 3px; right: 3px; font-size: 14px; cursor: pointer; z-index: 10;" onclick="event.stopPropagation(); showReservationMemoModal('äºˆç´„5');">ğŸ“</span>
            <span>äºˆç´„5</span>
          </button>
        </div>
        
        <div class="table-grid" id="tableGrid" style="display: none;">
          
        </div>
        </div>
        
        <div id="orderSection" class="hidden">
          <h2>æ³¨æ–‡è©³ç´° - <span id="selectedTableLabel"></span></h2>
          <div id="ordersList">
            <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
          
          <div id="totalSection" class="hidden">
            <div class="order-total">
              <span class="total-label">åˆè¨ˆé‡‘é¡:</span>
              <span class="total-amount" id="totalAmount">Â¥0</span>
            </div>
            <button class="btn btn-primary" onclick="showPaymentModal()">ä¼šè¨ˆå‡¦ç†</button>
            <button class="btn btn-secondary" onclick="clearSelection()">â† ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠã«æˆ»ã‚‹</button>
          </div>
        </div>
      </div>
      
      <div style="height: 30px;"></div>
      <div class="section">
        <!-- æ‰‹å‹•ãƒ¬ã‚¸å…¥åŠ› h2å‰Šé™¤ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; align-items: start;">
          
          <div>
            <div class="input-group">
              <label>ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·</label>
              <select id="manualTable">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              </select>
            </div>
            
            <div class="input-group">
              <label>ã‚«ãƒ†ã‚´ãƒªé¸æŠ</label>
              <select id="categoryFilter" onchange="filterMenuByCategory()">
                <option value="all">å…¨ã¦ã®å•†å“</option>
              </select>
            </div>
            
            <div class="input-group" style="display: flex; flex-direction: column; height: 100%;">
              <label>å•†å“ã‚’é¸æŠ</label>
              <div class="menu-items-list" id="menuItemsList" style="flex: 1; min-height: 400px;">
                <div class="loading">ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ä¸­...</div>
              </div>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; height: 100%;">
            <div class="selected-items" id="selectedItems" style="flex: 1; min-height: 400px; overflow-y: auto;"></div>
            
            <div class="input-group" style="margin-top: 15px;">
              <label>åˆè¨ˆé‡‘é¡: <span id="manualTotal" style="color: #667eea; font-size: 20px;">Â¥0</span></label>
            </div>
            
            <button class="btn btn-primary" onclick="submitManualOrder()" id="manualSubmitBtn" disabled style="margin-top: 15px;">æ³¨æ–‡ã‚’è¿½åŠ </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠ</h3>
      <div style="margin-bottom: 20px; padding: 15px; background: #f0f8ff; border-radius: 10px; border-left: 4px solid #667eea;">
        <button class="btn" style="width: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="showSplitPaymentModal()">
          åˆ†å‰²ä¼šè¨ˆ
        </button>
        <div style="font-size: 12px; color: #666; margin-top: 8px; text-align: center;">
          è¤‡æ•°ã®æ³¨æ–‡ã‚’é¸æŠã—ã¦ä¸€ç·’ã«ä¼šè¨ˆ
        </div>
      </div>
      <div id="taxRateSection" style="margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px; border-left: 4px solid #4CAF50; max-height: 200px; overflow-y: auto;">
        <h4 style="margin: 0 0 15px 0; color: #2e7d32; font-size: 16px;">å„å•†å“ã®ç¨ç‡ã‚’é¸æŠ</h4>
        <div id="taxRateItemsList"></div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #4CAF50; font-weight: bold; font-size: 14px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>8%å¯¾è±¡:</span>
            <span id="tax8Summary" style="color: #FF9800;">Â¥0</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>10%å¯¾è±¡:</span>
            <span id="tax10Summary" style="color: #2196F3;">Â¥0</span>
          </div>
        </div>
      </div>
      
      <div class="payment-methods">
        <button class="payment-method-btn" onclick="selectPaymentMethod('cash')">
          ç¾é‡‘
        </button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('emoney')">
          é›»å­ãƒãƒãƒ¼
        </button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('credit')">
          ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰
        </button>
      </div>
      
      <div id="cashInputSection" class="cash-input-section hidden">
        <label>ãŠé ã‹ã‚Šé‡‘é¡</label>
        <input type="number" id="cashReceived" placeholder="0" oninput="calculateChange()">
        <div class="change-display" id="changeDisplay">
          ãŠã¤ã‚Š: <span class="change-amount" id="changeAmount">Â¥0</span>
        </div>
      </div>
      <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 10px;">
        <label style="font-weight: bold; color: #856404;">å€¤å¼•ãé‡‘é¡</label>
        <input type="number" id="discountAmount" placeholder="0" value="0" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ffc107; border-radius: 8px; margin-top: 8px;" oninput="updatePaymentTotal()">
        <div style="text-align: center; margin-top: 10px; font-size: 18px; font-weight: bold; color: #333;">
          è«‹æ±‚é¡: <span id="finalPaymentAmount" style="color: #4CAF50;">Â¥0</span>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="completePayment()" id="completePaymentBtn" disabled>ä¼šè¨ˆå®Œäº†</button>
      <button class="btn btn-secondary" onclick="closePaymentModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  <div id="receiptCompleteModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ä¼šè¨ˆå®Œäº†</h3>
      <div style="text-align: center; margin: 20px 0; font-size: 18px; color: #4CAF50;">
        ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸ
      </div>
      <div class="receipt-actions">
        <button class="receipt-btn print" onclick="printReceipt()">ãƒ¬ã‚·ãƒ¼ãƒˆç™ºè¡Œ</button>
        <button class="receipt-btn invoice" onclick="printInvoice()">é ˜åæ›¸ç™ºè¡Œ</button>
        <button class="receipt-btn back" onclick="closeReceiptModal()">â† æˆ»ã‚‹</button>
      </div>
    </div>
  </div>
  <div id="toppingModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ´ ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’é¸æŠ</h3>
      <div id="toppingModalItemName" style="font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #667eea;"></div>
      <div id="toppingsList" style="max-height: 400px; overflow-y: auto;">
        
      </div>
      <button class="btn btn-primary" onclick="confirmTopping()">æ±ºå®š</button>
      <button class="btn btn-secondary" onclick="closeToppingModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  <div id="reservationMemoModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 500px;">
      <h3>ğŸ“ äºˆç´„ãƒ¡ãƒ¢</h3>
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 10px; font-weight: bold;">
          <span id="reservationTableName"></span>ã®ãƒ¡ãƒ¢
        </label>
        <textarea id="reservationMemoText" rows="5" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
      </div>
      <button class="btn btn-primary" onclick="saveReservationMemo()">ğŸ’¾ ä¿å­˜</button>
      <button class="btn btn-secondary" onclick="closeReservationMemoModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  <div id="splitPaymentModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
      <h3>âœ‚ï¸ åˆ†å‰²ä¼šè¨ˆ</h3>
      <p style="color: #666; margin-bottom: 20px;">ä¸€ç·’ã«ä¼šè¨ˆã™ã‚‹æ³¨æ–‡ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
      
      <div id="splitOrdersList" style="margin-bottom: 20px;">
        
      </div>
      
      <div style="padding: 15px; background: #f8f9fa; border-radius: 10px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: bold;">
          <span>é¸æŠã—ãŸæ³¨æ–‡ã®åˆè¨ˆ:</span>
          <span id="splitTotalAmount" style="color: #667eea;">Â¥0</span>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="proceedToSplitPayment()" id="splitPaymentBtn" disabled>é¸æŠã—ãŸæ³¨æ–‡ã‚’ä¼šè¨ˆ</button>
      <button class="btn btn-secondary" onclick="closeSplitPaymentModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  <div id="historyModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h3>ğŸ“œ æ³¨æ–‡å±¥æ­´</h3>
      
      <div style="margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap;">
        <select id="historyDateFilter" onchange="filterHistory()" style="padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
          <option value="today">ä»Šæ—¥</option>
          <option value="yesterday">æ˜¨æ—¥</option>
          <option value="week">ä»Šé€±</option>
          <option value="month">ä»Šæœˆ</option>
          <option value="all">å…¨æœŸé–“</option>
        </select>
        
        <select id="historyStatusFilter" onchange="filterHistory()" style="padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
          <option value="all">ã™ã¹ã¦</option>
          <option value="deleted">å‰Šé™¤æ¸ˆã¿</option>
          <option value="paid">ä¼šè¨ˆæ¸ˆã¿</option>
          <option value="completed">å®Œäº†</option>
          <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
        </select>
        
        <button onclick="refreshHistory()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;">ğŸ”„ æ›´æ–°</button>
      </div>
      
      <div id="historyList" style="max-height: 60vh; overflow-y: auto;">
        
      </div>
      
      <button class="btn btn-secondary" onclick="closeHistoryModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  <div id="customerCountModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 600px;">
      <h3>ğŸ‘¥ æœ¬æ—¥ã®å®¢æ•°</h3>
      
      <div id="customerCountContent" style="padding: 20px;">
        
      </div>
      
      <button class="btn btn-secondary" onclick="closeCustomerCountModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  <div id="salesModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 700px;">
      <h3>æœ¬æ—¥ã®å£²ä¸Š</h3>
      
      <div style="margin: 20px 0; display: flex; justify-content: flex-end;">
        <button onclick="showSettlementModal()" style="padding: 10px 20px; background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">ğŸ”„ ç²¾ç®—</button>
      </div>
      
      <div id="salesContent">
        
      </div>
      
      <button class="btn btn-secondary" onclick="closeSalesModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  <div id="settlementModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 500px;">
      <h3 style="color: #ff6b6b;">ğŸ”„ ç²¾ç®—ç¢ºèª</h3>
      
      <div style="margin: 20px 0; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
        <p style="margin: 0 0 10px 0; font-weight: bold; color: #856404;">æ³¨æ„äº‹é …:</p>
        <ul style="margin: 0; padding-left: 20px; color: #856404;">
          <li>æœ¬æ—¥ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºå®šã—ã¾ã™</li>
          <li>ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ï¼ˆPNGç”»åƒï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™</li>
          <li>å£²ä¸Šã¯åˆå‰3æ™‚ã«è‡ªå‹•çš„ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</li>
        </ul>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">ç²¾ç®—æ—¥ä»˜ã‚’é¸æŠ</label>
        <input type="date" id="settlementDate" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
        <p style="font-size: 12px; color: #666; margin-top: 5px;">â€» æ˜¨æ—¥ã®ç²¾ç®—ã‚’ä¸Šã’å¿˜ã‚ŒãŸå ´åˆãªã©ã€éå»ã®æ—¥ä»˜ã‚’é¸æŠã§ãã¾ã™</p>
      </div>
      
      <div id="settlementSummary" style="margin: 20px 0;">
        
      </div>
      
      <button class="btn" style="width: 100%; background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%); color: white; margin-bottom: 10px;" onclick="confirmSettlement()">ç²¾ç®—ã‚’å®Ÿè¡Œ</button>
      <button class="btn" style="width: 100%; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; margin-bottom: 10px;" onclick="generateDailyReport()">ğŸ“Š æ—¥è¨ˆè¡¨å‡ºåŠ›</button>
      <button class="btn btn-secondary" onclick="closeSettlementModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  <div id="expenseModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h3 style="color: #f093fb;">ğŸ’° æ”¯å‡ºå…¥åŠ›</h3>
      
      <div style="margin: 20px 0;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f5f5f5;">
              <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">åº—å</th>
              <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">å‹˜å®šç§‘ç›®</th>
              <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">è©³ç´°</th>
              <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">é‡‘é¡</th>
              <th style="padding: 10px; border: 1px solid #ddd; width: 60px;"></th>
            </tr>
          </thead>
          <tbody id="expenseTableBody">
            
          </tbody>
        </table>
        
        <button class="btn" style="margin-top: 10px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="addExpenseRow()">ï¼‹ è¡Œã‚’è¿½åŠ </button>
        
        <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; text-align: right;">
          <span style="font-size: 18px; font-weight: bold;">åˆè¨ˆ: Â¥</span>
          <span id="expenseTotal" style="font-size: 24px; font-weight: bold; color: #f093fb;">0</span>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="saveExpenses()">ä¿å­˜</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="exportExpensesToCSV()">CSVå‡ºåŠ›</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeExpenseModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  <div id="monthlyReportModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <h3>ğŸ“Š æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</h3>
      
      <div style="margin: 20px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">é–‹å§‹æ—¥</label>
          <input type="date" id="reportStartDate" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
        </div>
        
        <div style="flex: 1; min-width: 200px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">çµ‚äº†æ—¥</label>
          <input type="date" id="reportEndDate" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
        </div>
        
        <button onclick="generatePeriodJournal()" style="padding: 12px 24px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px;">ğŸ“Š ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆ</button>
      </div>
      
      <div id="monthlyReportContent">
        
      </div>
      
      <button class="btn btn-secondary" onclick="closeMonthlyReportModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  <div id="editOrderModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
      <h3>âœï¸ æ³¨æ–‡ç·¨é›†</h3>
      
      <div id="editOrderContent" style="margin: 20px 0;">
        
      </div>
      
      <div id="editOrderButtons" style="display: flex; gap: 10px; margin-top: 20px;">
        
      </div>
    </div>
  </div>
  <script>
    let selectedTable = null;
    let currentOrders = [];
    let menuItems = [];
    let manualCart = [];
    let autoPrintEnabled = true;
    let selectedPaymentMethod = null;
    let totalAmountToPay = 0;
    let cashReceived = 0;
    let changeAmount = 0;
    let lastPaymentData = null;
    let currentReservationTable = null; // äºˆç´„ãƒ¡ãƒ¢ç·¨é›†ä¸­ã®ãƒ†ãƒ¼ãƒ–ãƒ«
    let allMenuItems = [];
    let isBulkSoldOut = false;
    
    // éŸ³å£°é€šçŸ¥ç”¨
    let audioEnabled = false;
    let lastOrderCount = 0;
    let isFirstOrderLoad = true;
    
    // ãƒ—ãƒªãƒ³ã‚¿ãƒ¼IPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆç”»åƒã‹ã‚‰ï¼‰
    const PRINTER_IP = '192.168.244.41';
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆFirebaseã‹ã‚‰å–å¾—ï¼‰
    let menuData = [];
    let toppingsData = [];
    let reservationMemos = {}; // äºˆç´„ãƒ¡ãƒ¢ã‚’ä¿å­˜
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©
    const TABLES = [
      'å³ä¼šè¨ˆ', 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ', 'c1', 'c2', 'T-H', 'T-M', 
      'äºˆç´„1', 'äºˆç´„2', 'äºˆç´„3', 'äºˆç´„4', 'äºˆç´„5'
    ];
    
    // åˆæœŸåŒ–
    window.addEventListener('load', async () => {
      await initializeSystem();
    });
    
    async function initializeSystem() {
      // Firebaseã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å–å¾—
      try {
        const menuSnapshot = await window.getDocs(window.collection(window.db, 'menu'));
        menuData = [];
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          menuData.push({
            id: data.id || doc.id, // data.idã‚’å„ªå…ˆã€ãªã‘ã‚Œã°doc.id
            docId: doc.id, // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚‚ä¿æŒ
            name: data.name || '',
            price: data.price || 0,
            category: data.category || 'ãã®ä»–',
            taxRate: data.taxRate || 10,
            toppingsId: data.toppingsId || '', // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®ãƒˆãƒƒãƒ”ãƒ³ã‚°IDæ–‡å­—åˆ—
            toppings: data.toppings || [], // é…åˆ—å½¢å¼ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
            toppingSets: data.toppingSets || [], // æ–°ã—ã„ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆå½¢å¼
            note: data.note || '' // è¡¨ç¤ºåˆ¶é™ç”¨ã®note
          });
        });
        
        // menu.htmlã¨åŒã˜ã‚½ãƒ¼ãƒˆæ–¹æ³•ï¼šæ–‡å­—åˆ—æ¯”è¼ƒ
        console.log('ã‚½ãƒ¼ãƒˆå‰ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ID:', menuData.map(m => m.id).join(', '));
        menuData.sort((a, b) => {
          if (a.id < b.id) return -1;
          if (a.id > b.id) return 1;
          return 0;
        });
        
        console.log('âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', menuData.length, 'ä»¶');
        console.log('ã‚½ãƒ¼ãƒˆå¾Œã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ID:', menuData.map(m => m.id).join(', '));
      } catch (e) {
        console.error('âŒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
      }
      
      // Firebaseã‹ã‚‰ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’å–å¾—
      try {
        const toppingsSnapshot = await window.getDocs(window.collection(window.db, 'toppings'));
        toppingsData = [];
        toppingsSnapshot.forEach(doc => {
          const data = doc.data();
          toppingsData.push({
            id: data.id || doc.id, // data.idã‚’å„ªå…ˆ
            docId: doc.id,
            name: data.name || '',
            price: data.price || 0,
            order: data.order || 99 // ä¸¦ã³é †ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
          });
        });
        
        // menu.htmlã¨åŒã˜ã‚½ãƒ¼ãƒˆæ–¹æ³•ï¼šorderãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã‚½ãƒ¼ãƒˆ
        console.log('ã‚½ãƒ¼ãƒˆå‰ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ID:', toppingsData.map(t => t.id).join(', '));
        toppingsData.sort((a, b) => a.order - b.order);
        
        console.log('âœ… ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', toppingsData.length, 'ä»¶');
        console.log('ã‚½ãƒ¼ãƒˆå¾Œã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ID:', toppingsData.map(t => t.id).join(', '));
      } catch (e) {
        console.error('âŒ ãƒˆãƒƒãƒ”ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
      }
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
      const tableGrid = document.getElementById('tableGrid');
      // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã¯æ—¢ã«HTMLã§é…ç½®æ¸ˆã¿ã®ãŸã‚ã€è‡ªå‹•ç”Ÿæˆã¯ã‚¹ã‚­ãƒƒãƒ—
      // tableGrid.innerHTML = '';
      // ãŸã ã—ã€äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ¡ãƒ¢çŠ¶æ…‹ã¯æ›´æ–°ã™ã‚‹
      TABLES.forEach(table => {
        const btn = document.getElementById(`table-${table}`);
        if (btn && table.startsWith('äºˆç´„')) {
          if (reservationMemos[table]) {
            btn.style.background = 'linear-gradient(135deg, #FF9800 0%, #FF5722 100%)';
            btn.style.color = 'white';
          }
        }
      });
      
      // æ‰‹å‹•å…¥åŠ›ç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠè‚¢ã‚’ç”Ÿæˆ
      const manualTable = document.getElementById('manualTable');
      TABLES.forEach(table => {
        const option = document.createElement('option');
        option.value = table;
        option.textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${table}`;
        manualTable.appendChild(option);
      });
      
      // ã‚«ãƒ†ã‚´ãƒªã‚’åˆæœŸåŒ–
      initializeCategories();
      
      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’è¡¨ç¤º
      displayMenuItems();
      
      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹
      startRealtimeUpdates();
      
      // éŸ³å£°é€šçŸ¥ã‚’åˆæœŸåŒ–
      showAudioEnablePopup();
      watchOrders();
      watchStaffCalls();
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã®è‰²ã‚’æ›´æ–°
    function updateTableButtons() {
      TABLES.forEach(table => {
        if (table.startsWith('äºˆç´„')) {
          const btn = document.getElementById(`table-${table}`);
          if (btn) {
            if (reservationMemos[table]) {
              // ãƒ¡ãƒ¢ãŒã‚ã‚‹å ´åˆã¯ã‚ªãƒ¬ãƒ³ã‚¸è‰²
              btn.style.background = 'linear-gradient(135deg, #FF9800 0%, #FF5722 100%)';
              btn.style.color = 'white';
            } else {
              // ãƒ¡ãƒ¢ãŒãªã„å ´åˆã¯é€šå¸¸è‰²
              btn.style.background = '';
              btn.style.color = '';
            }
          }
        }
      });
    }
    
    // è‡ªå‹•å°åˆ·ãƒˆã‚°ãƒ«
    window.toggleAutoPrint = function() {
      autoPrintEnabled = document.getElementById('autoPrintToggle').checked;
      const status = document.getElementById('autoPrintStatus');
      status.textContent = autoPrintEnabled ? 'ON' : 'OFF';
      status.className = autoPrintEnabled ? 'toggle-status on' : 'toggle-status off';
    };
    
    // ã‚«ãƒ†ã‚´ãƒªã‚’åˆæœŸåŒ–
    function initializeCategories() {
      const categoryFilter = document.getElementById('categoryFilter');
      
      // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®æœ€å°IDã‚’è¨ˆç®—
      const categoryInfo = new Map();
      menuData.forEach(item => {
        if (!item.category) return;
        const cat = item.category;
        if (!categoryInfo.has(cat)) {
          categoryInfo.set(cat, { minId: item.id });
        } else {
          const info = categoryInfo.get(cat);
          if (item.id < info.minId) {
            info.minId = item.id;
          }
        }
      });
      
      // æœ€å°IDã§ã‚½ãƒ¼ãƒˆ
      const sortedCategories = Array.from(categoryInfo.entries())
        .sort((a, b) => a[1].minId.localeCompare(b[1].minId))
        .map(entry => entry[0]);
      
      // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆã€Œå…¨ã¦ã®å•†å“ã€ä»¥å¤–ï¼‰
      categoryFilter.innerHTML = '<option value="all">å…¨ã¦ã®å•†å“</option>';
      
      // ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ 
      sortedCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryFilter.appendChild(option);
      });
    }
    
    // ã‚«ãƒ†ã‚´ãƒªã§ãƒ•ã‚£ãƒ«ã‚¿
    window.filterMenuByCategory = function() {
      const selectedCategory = document.getElementById('categoryFilter').value;
      displayMenuItems(selectedCategory);
    };
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’è¡¨ç¤º
    function displayMenuItems(categoryFilter = 'all') {
      const container = document.getElementById('menuItemsList');
      container.innerHTML = '';
      
      const filteredMenu = categoryFilter === 'all' 
        ? menuData 
        : menuData.filter(item => item.category === categoryFilter);
      
      filteredMenu.forEach(item => {
        const div = document.createElement('div');
        div.className = 'menu-item-checkbox';
        div.style.cursor = 'pointer';
        div.innerHTML = `
          <input type="checkbox" id="menu-${item.id}" value="${item.id}" style="pointer-events: none;">
          <div class="menu-item-info">
            <div class="menu-item-name-small">${item.name}</div>
            <div class="menu-item-price-small">Â¥${item.price.toLocaleString()}</div>
          </div>
        `;
        
        // divå…¨ä½“ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«
        div.onclick = () => {
          const checkbox = document.getElementById(`menu-${item.id}`);
          checkbox.checked = !checkbox.checked;
          toggleMenuItem(item.id);
        };
        
        container.appendChild(div);
      });
    }
    
    // ä¸€æ™‚çš„ãªé¸æŠä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ 
    let currentSelectingItem = null;
    let selectedToppings = [];
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®é¸æŠåˆ‡ã‚Šæ›¿ãˆ
    window.toggleMenuItem = function(itemId) {
      const checkbox = document.getElementById(`menu-${itemId}`);
      const item = menuData.find(m => m.id === itemId);
      
      if (checkbox.checked) {
        currentSelectingItem = { ...item };
        selectedToppings = [];
        
        // toppingsIdãŒç©ºã¾ãŸã¯å­˜åœ¨ã—ãªã„å ´åˆã¯ã€ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ç›´æ¥ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
        if (!item.toppingsId || item.toppingsId.trim() === '') {
          manualCart.push({
            ...currentSelectingItem,
            toppings: 'æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°',
            toppingPrice: 0,
            quantity: 1
          });
          updateManualCart();
          currentSelectingItem = null;
        } else {
          // ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          showToppingModal(item);
        }
      } else {
        manualCart = manualCart.filter(i => i.id !== itemId);
        updateManualCart();
      }
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showToppingModal(item) {
      document.getElementById('toppingModalItemName').textContent = item.name;
      const list = document.getElementById('toppingsList');
      list.innerHTML = '';
      
      // ã€Œãªã—ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³
      const noneDiv = document.createElement('div');
      noneDiv.className = 'topping-item';
      noneDiv.style.cursor = 'pointer';
      noneDiv.innerHTML = `
        <input type="checkbox" id="topping-none" style="pointer-events: none;">
        <div class="topping-item-info">
          <span class="topping-item-name">æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°</span>
          <span class="topping-item-price">Â¥0</span>
        </div>
      `;
      
      // divå…¨ä½“ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«
      noneDiv.onclick = () => {
        const checkbox = document.getElementById('topping-none');
        checkbox.checked = !checkbox.checked;
        selectNoneTopping(checkbox);
      };
      
      list.appendChild(noneDiv);
      
      // toppingsIdã‹ã‚‰ãƒˆãƒƒãƒ”ãƒ³ã‚°IDã®ãƒªã‚¹ãƒˆã‚’å–å¾—
      let allowedToppingIds = [];
      if (item.toppingsId && typeof item.toppingsId === 'string') {
        // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šæ–‡å­—åˆ—ã‹ã‚‰é…åˆ—ã«å¤‰æ›
        allowedToppingIds = item.toppingsId.split(',').map(id => id.trim());
      } else if (item.toppings && Array.isArray(item.toppings)) {
        // é…åˆ—å½¢å¼ã®å ´åˆ
        allowedToppingIds = item.toppings;
      }
      
      toppingsData.forEach(topping => {
        // toppingsIdã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼ˆç©ºã®å ´åˆã¯è¡¨ç¤ºã—ãªã„ï¼‰
        if (allowedToppingIds.length > 0 && allowedToppingIds.includes(topping.id)) {
          const div = document.createElement('div');
          div.className = 'topping-item';
          div.style.cursor = 'pointer';
          div.innerHTML = `
            <input type="checkbox" id="topping-${topping.id}" value="${topping.id}" style="pointer-events: none;">
            <div class="topping-item-info">
              <span class="topping-item-name">${topping.name}</span>
              <span class="topping-item-price">+Â¥${topping.price.toLocaleString()}</span>
            </div>
          `;
          
          // divå…¨ä½“ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«
          div.onclick = () => {
            const checkbox = document.getElementById(`topping-${topping.id}`);
            checkbox.checked = !checkbox.checked;
            selectTopping(checkbox);
          };
          
          list.appendChild(div);
        }
      });
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œãªã—ã€ã‚’é¸æŠ
      document.getElementById('topping-none').checked = true;
      
      document.getElementById('toppingModal').classList.remove('hidden');
    }
    
    // ã€Œãªã—ã€ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’é¸æŠ
    window.selectNoneTopping = function(checkbox) {
      if (checkbox.checked) {
        // ä»–ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
        selectedToppings = [];
        toppingsData.forEach(t => {
          const cb = document.getElementById(`topping-${t.id}`);
          if (cb) cb.checked = false;
        });
      }
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’é¸æŠ
    window.selectTopping = function(checkbox) {
      const noneCheckbox = document.getElementById('topping-none');
      
      if (checkbox.checked) {
        // ã€Œãªã—ã€ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™
        noneCheckbox.checked = false;
        
        // é¸æŠã•ã‚ŒãŸãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’è¿½åŠ 
        const toppingId = checkbox.value;
        const topping = toppingsData.find(t => t.id === toppingId);
        if (topping && !selectedToppings.find(t => t.id === toppingId)) {
          selectedToppings.push(topping);
        }
      } else {
        // é¸æŠè§£é™¤
        selectedToppings = selectedToppings.filter(t => t.id !== checkbox.value);
        
        // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãŒä½•ã‚‚é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€Œãªã—ã€ã‚’é¸æŠ
        if (selectedToppings.length === 0) {
          noneCheckbox.checked = true;
        }
      }
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠã‚’ç¢ºå®š
    window.confirmTopping = function() {
      if (!currentSelectingItem) return;
      
      let toppingNames = 'ãªã—';
      let toppingPrice = 0;
      
      if (selectedToppings.length > 0) {
        toppingNames = selectedToppings.map(t => t.name).join(', ');
        toppingPrice = selectedToppings.reduce((sum, t) => sum + t.price, 0);
      }
      
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’ç¢ºèª
      if (currentSelectingItem.editIndex !== undefined) {
        // æ—¢å­˜ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ›´æ–°
        manualCart[currentSelectingItem.editIndex].toppings = toppingNames;
        manualCart[currentSelectingItem.editIndex].toppingPrice = toppingPrice;
      } else {
        // æ–°è¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
        manualCart.push({
          ...currentSelectingItem,
          quantity: 1,
          toppings: toppingNames,
          toppingPrice: toppingPrice
        });
      }
      
      closeToppingModal();
      updateManualCart();
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeToppingModal = function() {
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
      if (currentSelectingItem) {
        const checkbox = document.getElementById(`menu-${currentSelectingItem.id}`);
        if (checkbox && manualCart.filter(i => i.id === currentSelectingItem.id).length === 0) {
          checkbox.checked = false;
        }
      }
      
      document.getElementById('toppingModal').classList.add('hidden');
      currentSelectingItem = null;
      selectedToppings = [];
    };
    
    // äºˆç´„ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showReservationMemoModal = function(tableName) {
      currentReservationTable = tableName;
      document.getElementById('reservationTableName').textContent = tableName;
      document.getElementById('reservationMemoText').value = reservationMemos[tableName] || '';
      document.getElementById('reservationMemoModal').classList.remove('hidden');
    };
    
    // äºˆç´„ãƒ¡ãƒ¢ã‚’ä¿å­˜
    window.saveReservationMemo = function() {
      if (!currentReservationTable) return;
      
      const memo = document.getElementById('reservationMemoText').value.trim();
      if (memo) {
        reservationMemos[currentReservationTable] = memo;
      } else {
        delete reservationMemos[currentReservationTable];
      }
      
      // ãƒœã‚¿ãƒ³ã®è‰²ã‚’æ›´æ–°
      updateTableButtons();
      
      closeReservationMemoModal();
    };
    
    // äºˆç´„ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeReservationMemoModal = function() {
      document.getElementById('reservationMemoModal').classList.add('hidden');
      currentReservationTable = null;
    };
    
    // åˆ†å‰²ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    let selectedSplitOrders = [];
    window.showSplitPaymentModal = function() {
      // æœªæ‰•ã„ã®æ³¨æ–‡ã®ã¿ã‚’è¡¨ç¤º
      const unpaidOrders = currentOrders.filter(o => !o.paidAt && !o.cancelledAt);
      
      if (unpaidOrders.length === 0) {
        alert('ä¼šè¨ˆå¯èƒ½ãªæ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      const list = document.getElementById('splitOrdersList');
      list.innerHTML = '';
      selectedSplitOrders = [];
      
      unpaidOrders.forEach(order => {
        const div = document.createElement('div');
        div.style.cssText = `
          padding: 15px;
          margin-bottom: 10px;
          border: 2px solid #ddd;
          border-radius: 10px;
          cursor: pointer;
          transition: all 0.2s;
        `;
        
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <input type="checkbox" id="split-${order.id}" style="width: 20px; height: 20px; margin-right: 10px;">
              <strong style="font-size: 18px;">#${order.orderNumber}</strong>
              <span style="color: #666; margin-left: 10px;">${new Date(order.timestamp.toDate()).toLocaleTimeString('ja-JP', {hour: '2-digit', minute: '2-digit'})}</span>
            </div>
            <div style="font-size: 20px; font-weight: bold; color: #667eea;">Â¥${order.totalAmount.toLocaleString()}</div>
          </div>
        `;
        
        const checkbox = div.querySelector('input');
        div.onclick = () => {
          checkbox.checked = !checkbox.checked;
          updateSplitSelection();
        };
        checkbox.onclick = (e) => e.stopPropagation();
        checkbox.onchange = updateSplitSelection;
        
        list.appendChild(div);
      });
      
      document.getElementById('paymentModal').classList.add('hidden');
      document.getElementById('splitPaymentModal').classList.remove('hidden');
      updateSplitSelection();
    };
    
    // åˆ†å‰²ä¼šè¨ˆã®é¸æŠã‚’æ›´æ–°
    function updateSplitSelection() {
      selectedSplitOrders = [];
      let total = 0;
      
      currentOrders.forEach(order => {
        const checkbox = document.getElementById(`split-${order.id}`);
        if (checkbox && checkbox.checked) {
          selectedSplitOrders.push(order);
          total += order.totalAmount || 0;
        }
      });
      
      document.getElementById('splitTotalAmount').textContent = `Â¥${total.toLocaleString()}`;
      document.getElementById('splitPaymentBtn').disabled = selectedSplitOrders.length === 0;
    }
    
    // åˆ†å‰²ä¼šè¨ˆã‚’å®Ÿè¡Œ
    window.proceedToSplitPayment = function() {
      if (selectedSplitOrders.length === 0) {
        alert('æ³¨æ–‡ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      // é¸æŠã—ãŸæ³¨æ–‡ã‚’currentOrdersã«ã‚»ãƒƒãƒˆ
      currentOrders = selectedSplitOrders;
      totalAmountToPay = selectedSplitOrders.reduce((sum, o) => sum + (o.totalAmount || 0), 0);
      
      // åˆ†å‰²ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦æ”¯æ‰•ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      document.getElementById('splitPaymentModal').classList.add('hidden');
      document.getElementById('paymentModal').classList.remove('hidden');
      
      // æ”¯æ‰•ã„æ–¹æ³•ã‚’ãƒªã‚»ãƒƒãƒˆ
      selectedPaymentMethod = null;
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('completePaymentBtn').disabled = true;
    };
    
    // åˆ†å‰²ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeSplitPaymentModal = function() {
      document.getElementById('splitPaymentModal').classList.add('hidden');
      document.getElementById('paymentModal').classList.remove('hidden');
      selectedSplitOrders = [];
    };
    
    // ========== å±¥æ­´æ©Ÿèƒ½ ==========
    
    let historyOrders = [];
    
    // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showHistoryModal = async function() {
      document.getElementById('historyModal').classList.remove('hidden');
      await loadHistory();
    };
    
    // å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
    async function loadHistory() {
      try {
        // timestampã§æ˜‡é †ï¼ˆå¤ã„é †ï¼‰ã«ã‚¯ã‚¨ãƒª
        const q = window.query(
          window.collection(window.db, 'orders'),
          window.orderBy('timestamp', 'asc')
        );
        const ordersSnapshot = await window.getDocs(q);
        historyOrders = [];
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          historyOrders.push({
            id: doc.id,
            orderNumber: data.orderNumber || 0,
            timestamp: data.timestamp,
            tableNumber: data.tableNumber || '',
            items: data.items || [],
            totalAmount: data.totalAmount || 0,
            paymentMethod: data.paymentMethod || 'cash',  // æ”¯æ‰•æ–¹æ³•ã‚’è¿½åŠ 
            paidAt: data.paidAt || null,
            completedAt: data.completedAt || null,
            cancelledAt: data.cancelledAt || null,
            deleted: data.deleted || false,
            deletedAt: data.deletedAt || null
          });
        });
        
        // Firebaseã®ã‚¯ã‚¨ãƒªã§æ—¢ã«æ™‚ç³»åˆ—é †ï¼ˆå¤ã„é †ï¼‰ã«ã‚½ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹
        console.log('âœ… å±¥æ­´èª­ã¿è¾¼ã¿å®Œäº†:', historyOrders.length, 'ä»¶');
        
        filterHistory();
      } catch (e) {
        console.error('âŒ å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        alert('å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
    
    // å±¥æ­´ã‚’ãƒ•ã‚£ãƒ«ã‚¿è¡¨ç¤º
    window.filterHistory = function() {
      const dateFilter = document.getElementById('historyDateFilter').value;
      const statusFilter = document.getElementById('historyStatusFilter').value;
      
      const now = new Date();
      
      let filtered = historyOrders.filter(order => {
        // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿
        const orderDate = order.timestamp.toDate();
        
        let dateMatch = true;
        if (dateFilter === 'today') {
          // ä»Šæ—¥ï¼ˆåˆå‰3æ™‚åŒºåˆ‡ã‚Šï¼‰
          const todayStart = new Date(now);
          todayStart.setHours(3, 0, 0, 0);
          if (now.getHours() < 3) {
            todayStart.setDate(todayStart.getDate() - 1);
          }
          const todayEnd = new Date(todayStart);
          todayEnd.setDate(todayEnd.getDate() + 1);
          dateMatch = orderDate >= todayStart && orderDate < todayEnd;
        } else if (dateFilter === 'yesterday') {
          // æ˜¨æ—¥ï¼ˆåˆå‰3æ™‚åŒºåˆ‡ã‚Šï¼‰
          const yesterdayStart = new Date(now);
          yesterdayStart.setHours(3, 0, 0, 0);
          if (now.getHours() < 3) {
            yesterdayStart.setDate(yesterdayStart.getDate() - 1);
          }
          yesterdayStart.setDate(yesterdayStart.getDate() - 1);
          const yesterdayEnd = new Date(yesterdayStart);
          yesterdayEnd.setDate(yesterdayEnd.getDate() + 1);
          dateMatch = orderDate >= yesterdayStart && orderDate < yesterdayEnd;
        } else if (dateFilter === 'week') {
          // éå»7æ—¥é–“
          const weekAgo = new Date(now);
          weekAgo.setDate(weekAgo.getDate() - 7);
          weekAgo.setHours(0, 0, 0, 0);
          dateMatch = orderDate >= weekAgo;
        } else if (dateFilter === 'month') {
          // ä»Šæœˆ
          const monthStart = new Date(now);
          monthStart.setDate(1);
          monthStart.setHours(0, 0, 0, 0);
          dateMatch = orderDate >= monthStart;
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿
        let statusMatch = true;
        if (statusFilter === 'deleted') {
          statusMatch = order.deleted;
        } else if (statusFilter === 'paid') {
          statusMatch = order.paidAt && !order.deleted;
        } else if (statusFilter === 'completed') {
          statusMatch = order.completedAt && !order.deleted;
        } else if (statusFilter === 'cancelled') {
          statusMatch = order.cancelledAt && !order.deleted;
        }
        
        return dateMatch && statusMatch;
      });
      
      displayHistory(filtered);
    };
    
    // å±¥æ­´ã‚’è¡¨ç¤º
    function displayHistory(orders) {
      const container = document.getElementById('historyList');
      
      if (orders.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">è©²å½“ã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = '';
      
      // å¤ã„é †ã«è¡¨ç¤ºï¼ˆæ™‚ç³»åˆ—é †ï¼‰
      // æ—¢ã«Firebaseã‹ã‚‰å–å¾—ã—ãŸordersã¯æ™‚é–“é †ãªã®ã§ã€ãã®ã¾ã¾è¡¨ç¤º
      orders.forEach(order => {
        const card = document.createElement('div');
        card.style.cssText = `
          background: white;
          border-radius: 12px;
          padding: 15px;
          margin-bottom: 15px;
          border: 2px solid #ddd;
        `;
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸
        let badges = [];
        if (order.deleted) badges.push('<span style="background: #666; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">å‰Šé™¤æ¸ˆã¿</span>');
        if (order.paidAt) badges.push('<span style="background: #2196F3; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">ä¼šè¨ˆæ¸ˆ</span>');
        if (order.completedAt) badges.push('<span style="background: #4CAF50; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">å®Œäº†</span>');
        if (order.cancelledAt) badges.push('<span style="background: #f44336; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>');
        
        const orderDate = order.timestamp.toDate();
        const dateStr = orderDate.toLocaleString('ja-JP');
        
        // æ”¯æ‰•æ–¹æ³•ã‚’æ—¥æœ¬èªã«å¤‰æ›
        const paymentMethodNames = {
          'cash': 'ç¾é‡‘',
          'emoney': 'é›»å­ãƒãƒãƒ¼',
          'credit': 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰'
        };
        const paymentMethodLabel = paymentMethodNames[order.paymentMethod] || 'ç¾é‡‘';
        
        let itemsHtml = '';
        order.items.forEach(item => {
          itemsHtml += `<div style="padding: 5px 0; border-bottom: 1px solid #eee;">
            ${item.name} Ã—${item.quantity} - Â¥${((item.price + (item.toppingPrice || 0)) * item.quantity).toLocaleString()}
          </div>`;
        });
        
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ï¼ˆã™ã¹ã¦ã®æ³¨æ–‡ãŒç·¨é›†å¯èƒ½ï¼‰
        let actionsHtml = `
          <div style="display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 2px solid #eee;">
            <button onclick="editOrder('${order.id}')" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
              âœï¸ ç·¨é›†
            </button>
            ${order.paidAt ? `
              <button onclick="reprintReceipt('${order.id}')" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                ãƒ¬ã‚·ãƒ¼ãƒˆå†å°åˆ·
              </button>
              <button onclick="reprintInvoice('${order.id}')" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                é ˜åæ›¸å†å°åˆ·
              </button>
            ` : ''}
          </div>
        `;
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div>
              <strong style="font-size: 18px;">#${order.orderNumber}</strong>
              <span style="color: #666; margin-left: 10px;">${order.tableNumber}</span>
            </div>
            <div>${badges.join('')}</div>
          </div>
          <div style="font-size: 12px; color: #999; margin-bottom: 10px;">
            ${dateStr}
            ${order.paidAt ? `<span style="margin-left: 15px; padding: 4px 8px; background: #e3f2fd; color: #1976d2; border-radius: 4px; font-weight: bold;">ğŸ’³ ${paymentMethodLabel}</span>` : ''}
          </div>
          <div style="max-height: 150px; overflow-y: auto; margin: 10px 0;">
            ${itemsHtml}
          </div>
          <div style="text-align: right; font-size: 18px; font-weight: bold; color: #667eea; margin-top: 10px;">
            åˆè¨ˆ: Â¥${order.totalAmount.toLocaleString()}
          </div>
          ${actionsHtml}
        `;
        
        container.appendChild(card);
      });
    }
    
    // å±¥æ­´ã‹ã‚‰ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å†å°åˆ·
    window.reprintReceipt = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(doc(db, 'orders', orderId));
        if (!orderDoc.exists()) {
          alert('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        const orderData = orderDoc.data();
        
        // å•†å“ãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆç¨ç‡æƒ…å ±ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§10%ï¼‰
        const itemsWithTaxRate = [];
        
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            itemsWithTaxRate.push({
              name: item.name,
              quantity: item.quantity,
              price: item.price + (item.toppingPrice || 0),
              toppings: item.toppings || 'ãªã—',
              taxRate: 10  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            });
          });
        }
        
        // ãƒ¬ã‚¸è¢‹ã‚’è¿½åŠ 
        if (orderData.bagNeeded && orderData.bagQuantity > 0) {
          const bagTotal = orderData.bagPrice || (orderData.bagQuantity * 3);
          itemsWithTaxRate.push({
            name: 'ğŸ›ï¸ ãƒ¬ã‚¸è¢‹',
            quantity: orderData.bagQuantity,
            price: 3,
            toppings: 'ãªã—',
            taxRate: 10
          });
        }
        
        // lastPaymentDataã‚’å†æ§‹ç¯‰
        lastPaymentData = {
          orderNumbers: [orderData.orderNumber],
          tableNumber: orderData.tableNumber,
          items: itemsWithTaxRate,
          totalAmount: orderData.totalAmount,
          paymentMethod: orderData.paymentMethod || 'cash',
          staffName: orderData.staffName || 'ãƒ¬ã‚¸ä¿‚',
          cashReceived: orderData.totalAmount,
          change: 0,
          timestamp: orderData.paidAt ? orderData.paidAt.toDate() : orderData.timestamp.toDate()
        };
        
        await printReceipt();
      } catch (e) {
        console.error('å†å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        alert('ãƒ¬ã‚·ãƒ¼ãƒˆã®å†å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // å±¥æ­´ã‹ã‚‰é ˜åæ›¸ã‚’å†å°åˆ·
    window.reprintInvoice = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(doc(db, 'orders', orderId));
        if (!orderDoc.exists()) {
          alert('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        const orderData = orderDoc.data();
        
        // å•†å“ãƒªã‚¹ãƒˆã‚’ä½œæˆ
        const itemsWithTaxRate = [];
        
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            itemsWithTaxRate.push({
              name: item.name,
              quantity: item.quantity,
              price: item.price + (item.toppingPrice || 0),
              toppings: item.toppings || 'ãªã—',
              taxRate: 10
            });
          });
        }
        
        // ãƒ¬ã‚¸è¢‹ã‚’è¿½åŠ 
        if (orderData.bagNeeded && orderData.bagQuantity > 0) {
          itemsWithTaxRate.push({
            name: 'ğŸ›ï¸ ãƒ¬ã‚¸è¢‹',
            quantity: orderData.bagQuantity,
            price: 3,
            toppings: 'ãªã—',
            taxRate: 10
          });
        }
        
        // lastPaymentDataã‚’å†æ§‹ç¯‰
        lastPaymentData = {
          orderNumbers: [orderData.orderNumber],
          tableNumber: orderData.tableNumber,
          items: itemsWithTaxRate,
          totalAmount: orderData.totalAmount,
          paymentMethod: orderData.paymentMethod || 'cash',
          staffName: orderData.staffName || 'ãƒ¬ã‚¸ä¿‚',
          cashReceived: orderData.totalAmount,
          change: 0,
          timestamp: orderData.paidAt ? orderData.paidAt.toDate() : orderData.timestamp.toDate()
        };
        
        await printInvoice();
      } catch (e) {
        console.error('å†å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        alert('é ˜åæ›¸ã®å†å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // å±¥æ­´ã‚’æ›´æ–°
    window.refreshHistory = async function() {
      await loadHistory();
    };
    
    // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeHistoryModal = function() {
      document.getElementById('historyModal').classList.add('hidden');
    };
    
    // ===== æ³¨æ–‡ç·¨é›†æ©Ÿèƒ½ =====
    let currentEditingOrder = null;
    
    // æ³¨æ–‡ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.editOrder = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.doc(window.db, 'orders', orderId));
        if (!orderDoc.exists()) {
          alert('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        const orderData = orderDoc.data();
        currentEditingOrder = {
          id: orderId,
          ...orderData
        };
        
        // æ”¯æ‰•æ–¹æ³•ã®é¸æŠè‚¢
        const paymentMethods = {
          'cash': 'ç¾é‡‘',
          'emoney': 'é›»å­ãƒãƒãƒ¼',
          'credit': 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰'
        };
        
        let paymentMethodOptions = '';
        Object.keys(paymentMethods).forEach(method => {
          const selected = orderData.paymentMethod === method ? 'selected' : '';
          paymentMethodOptions += `<option value="${method}" ${selected}>${paymentMethods[method]}</option>`;
        });
        
        // å•†å“ãƒªã‚¹ãƒˆ
        let itemsHtml = '';
        if (orderData.items && orderData.items.length > 0) {
          orderData.items.forEach((item, index) => {
            itemsHtml += `
              <div style="padding: 10px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong>${item.name}</strong>
                    ${item.topping ? `<div style="font-size: 12px; color: #666;">ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${item.topping}</div>` : ''}
                  </div>
                  <button onclick="removeItemFromOrder(${index})" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
                </div>
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                  <label>æ•°é‡:</label>
                  <input type="number" value="${item.quantity}" onchange="updateItemQuantity(${index}, this.value)" min="1" style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                  <span style="margin-left: auto; font-weight: bold;">Â¥${((item.price + (item.toppingPrice || 0)) * item.quantity).toLocaleString()}</span>
                </div>
              </div>
            `;
          });
        }
        
        const content = document.getElementById('editOrderContent');
        content.innerHTML = `
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ³¨æ–‡ç•ªå·</label>
            <div style="font-size: 24px; color: #667eea;">#${orderData.orderNumber || 0}</div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·</label>
            <input type="text" id="editTableNumber" value="${orderData.tableNumber || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ”¯æ‰•æ–¹æ³•</label>
            <select id="editPaymentMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
              ${paymentMethodOptions}
            </select>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">æ³¨æ–‡å•†å“</label>
            ${itemsHtml || '<div style="text-align: center; padding: 20px; color: #999;">å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>'}
          </div>
          
          <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; text-align: right;">
            <span style="font-size: 18px; font-weight: bold;">åˆè¨ˆ: </span>
            <span id="editTotalAmount" style="font-size: 24px; font-weight: bold; color: #1976d2;">Â¥${(orderData.totalAmount || 0).toLocaleString()}</span>
          </div>
        `;
        
        // ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«ç”Ÿæˆï¼ˆå‰Šé™¤æ¸ˆã¿ã‹ã©ã†ã‹ã§å¤‰ã‚ã‚‹ï¼‰
        const buttonsContainer = document.getElementById('editOrderButtons');
        if (orderData.deleted) {
          // å‰Šé™¤æ¸ˆã¿æ³¨æ–‡ï¼šä¿å­˜ã¨å¾©å…ƒãƒœã‚¿ãƒ³
          buttonsContainer.innerHTML = `
            <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveOrderEdit()">ä¿å­˜</button>
            <button class="btn" style="flex: 1; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white;" onclick="restoreOrder()">æ³¨æ–‡ã‚’å¾©å…ƒ</button>
            <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditOrderModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          `;
        } else {
          // é€šå¸¸ã®æ³¨æ–‡ï¼šä¿å­˜ã¨å‰Šé™¤ãƒœã‚¿ãƒ³
          buttonsContainer.innerHTML = `
            <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveOrderEdit()">ä¿å­˜</button>
            <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="deleteOrderFromEdit()">æ³¨æ–‡å‰Šé™¤</button>
            <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditOrderModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          `;
        }
        
        document.getElementById('editOrderModal').classList.remove('hidden');
        
      } catch (e) {
        console.error('æ³¨æ–‡ç·¨é›†ã‚¨ãƒ©ãƒ¼:', e);
        alert('æ³¨æ–‡ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };
    
    // æ³¨æ–‡ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeEditOrderModal = function() {
      document.getElementById('editOrderModal').classList.add('hidden');
      currentEditingOrder = null;
    };
    
    // å•†å“ã‚’æ³¨æ–‡ã‹ã‚‰å‰Šé™¤
    window.removeItemFromOrder = function(index) {
      if (!currentEditingOrder) return;
      
      if (confirm('ã“ã®å•†å“ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        currentEditingOrder.items.splice(index, 1);
        
        // åˆè¨ˆé‡‘é¡ã‚’å†è¨ˆç®—
        let total = 0;
        currentEditingOrder.items.forEach(item => {
          total += (item.price + (item.toppingPrice || 0)) * item.quantity;
        });
        currentEditingOrder.totalAmount = total;
        
        // è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†æç”»ï¼‰
        editOrder(currentEditingOrder.id);
      }
    };
    
    // å•†å“ã®æ•°é‡ã‚’æ›´æ–°
    window.updateItemQuantity = function(index, newQuantity) {
      if (!currentEditingOrder) return;
      
      const quantity = parseInt(newQuantity) || 1;
      currentEditingOrder.items[index].quantity = quantity;
      
      // åˆè¨ˆé‡‘é¡ã‚’å†è¨ˆç®—
      let total = 0;
      currentEditingOrder.items.forEach(item => {
        total += (item.price + (item.toppingPrice || 0)) * item.quantity;
      });
      currentEditingOrder.totalAmount = total;
      
      // åˆè¨ˆé‡‘é¡ã®è¡¨ç¤ºã‚’æ›´æ–°
      document.getElementById('editTotalAmount').textContent = `Â¥${total.toLocaleString()}`;
    };
    
    // æ³¨æ–‡ã®å¤‰æ›´ã‚’ä¿å­˜
    window.saveOrderEdit = async function() {
      if (!currentEditingOrder) return;
      
      try {
        const tableNumber = document.getElementById('editTableNumber').value;
        const paymentMethod = document.getElementById('editPaymentMethod').value;
        
        // æ³¨æ–‡ã‚’æ›´æ–°
        await window.updateDoc(window.doc(window.db, 'orders', currentEditingOrder.id), {
          tableNumber: tableNumber,
          paymentMethod: paymentMethod,
          items: currentEditingOrder.items,
          totalAmount: currentEditingOrder.totalAmount
        });
        
        alert('æ³¨æ–‡ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        closeEditOrderModal();
        
        // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
        await loadHistory();
        
      } catch (e) {
        console.error('æ³¨æ–‡æ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
        alert('æ³¨æ–‡ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰æ³¨æ–‡ã‚’å‰Šé™¤
    window.deleteOrderFromEdit = async function() {
      if (!currentEditingOrder) return;
      
      if (!confirm(`æ³¨æ–‡ #${currentEditingOrder.orderNumber} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }
      
      try {
        await window.updateDoc(window.doc(window.db, 'orders', currentEditingOrder.id), {
          deleted: true,
          deletedAt: window.Timestamp.now()
        });
        
        alert('æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        closeEditOrderModal();
        
        // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
        await loadHistory();
        
      } catch (e) {
        console.error('æ³¨æ–‡å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e);
        alert('æ³¨æ–‡ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // æ³¨æ–‡ã‚’å¾©å…ƒ
    window.restoreOrder = async function() {
      if (!currentEditingOrder) return;
      
      if (!confirm(`æ³¨æ–‡ #${currentEditingOrder.orderNumber} ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }
      
      try {
        await window.updateDoc(window.doc(window.db, 'orders', currentEditingOrder.id), {
          deleted: false,
          deletedAt: null
        });
        
        alert('æ³¨æ–‡ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
        closeEditOrderModal();
        
        // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
        await loadHistory();
        
      } catch (e) {
        console.error('æ³¨æ–‡å¾©å…ƒã‚¨ãƒ©ãƒ¼:', e);
        alert('æ³¨æ–‡ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ========== æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ==========
    
    // æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showMonthlyReportModal = function() {
      // å½“æœˆã®é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’åˆæœŸå€¤ã¨ã—ã¦è¨­å®š
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      
      const startDate = `${year}-${month}-01`;
      const lastDay = new Date(year, now.getMonth() + 1, 0).getDate();
      const endDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;
      
      document.getElementById('reportStartDate').value = startDate;
      document.getElementById('reportEndDate').value = endDate;
      
      document.getElementById('monthlyReportModal').classList.remove('hidden');
    };
    // æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeMonthlyReportModal = function() {
      document.getElementById('monthlyReportModal').classList.add('hidden');
    };
    
    // ===== æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆ =====
    window.generatePeriodJournal = async function() {
      try {
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;
        
        if (!startDate || !endDate) {
          alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        
        if (startDate > endDate) {
          alert('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        
        console.log(`ğŸ“Š æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆ: ${startDate} ï½ ${endDate}`);
        
        const container = document.getElementById('monthlyReportContent');
        container.innerHTML = '<div style="text-align: center; padding: 40px;">ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆä¸­...</div>';
        
        // æœŸé–“å†…ã®å…¨æ—¥ä»˜ã‚’ç”Ÿæˆ
        const start = new Date(startDate);
        const end = new Date(endDate);
        const dates = [];
        
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
          dates.push(dateStr);
        }
        
        // å„æ—¥ä»˜ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦åˆè¨ˆ
        let totalCustomerCount = 0;
        let totalItems = 0;
        let totalCashSales = 0;
        let totalEmoneSales = 0;
        let totalCreditSales = 0;
        let totalDiscount = 0;
        let totalTax8 = 0;
        let totalTax10 = 0;
        let totalDrawerOpen = 0;
        let totalExpense = 0;
        let totalLaborCost = 0;
        const itemCounts = {}; // å•†å“åˆ¥ã‚«ã‚¦ãƒ³ãƒˆ
        
        // ordersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç›´æ¥å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
        const ordersQuery = window.query(
          window.collection(window.db, 'orders'),
          window.where('paidAt', '!=', null)
        );
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          const orderDate = data.timestamp.toDate();
          const orderDateStr = `${orderDate.getFullYear()}-${String(orderDate.getMonth() + 1).padStart(2, '0')}-${String(orderDate.getDate()).padStart(2, '0')}`;
          
          // æœŸé–“å†…ã®æ³¨æ–‡ã®ã¿
          if (dates.includes(orderDateStr) && data.items && data.paidAt) {
            data.items.forEach(item => {
              itemCounts[item.name] = (itemCounts[item.name] || 0) + (item.quantity || 1);
            });
          }
        });
        
        console.log('ğŸ“¦ ordersã‹ã‚‰é›†è¨ˆã—ãŸå•†å“ãƒ‡ãƒ¼ã‚¿:', itemCounts);
        
        for (const dateStr of dates) {
          // å£²ä¸Šãƒ‡ãƒ¼ã‚¿
          const salesDoc = await window.getDoc(window.doc(window.db, 'dailySales', dateStr));
          if (salesDoc.exists()) {
            const data = salesDoc.data();
            totalCustomerCount += data.customerCount || 0;
            totalItems += data.totalItems || 0;
            totalCashSales += data.cashSales || 0;
            totalEmoneSales += data.emoneSales || 0;
            totalCreditSales += data.creditSales || 0;
            totalDiscount += data.totalDiscount || 0;
            totalTax8 += data.tax8Total || 0;
            totalTax10 += data.tax10Total || 0;
            totalDrawerOpen += data.drawerOpenCount || 0;
          }
          
          // æ”¯å‡ºãƒ‡ãƒ¼ã‚¿
          const expenseDoc = await window.getDoc(window.doc(window.db, 'expenses', dateStr));
          if (expenseDoc.exists()) {
            totalExpense += expenseDoc.data().total || 0;
          }
          
          // äººä»¶è²»ãƒ‡ãƒ¼ã‚¿
          const attendanceSnapshot = await window.getDocs(window.collection(window.db, 'kintai_attendance'));
          attendanceSnapshot.forEach(doc => {
            const attData = doc.data();
            if (attData.date === dateStr && attData.clockIn && attData.clockOut) {
              const clockIn = new Date(`${dateStr} ${attData.clockIn}`);
              const clockOut = new Date(`${dateStr} ${attData.clockOut}`);
              let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
              
              if (attData.breakStart1 && attData.breakEnd1) {
                const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
              }
              if (attData.breakStart2 && attData.breakEnd2) {
                const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
              }
              
              const hourlyRate = attData.hourlyRate || 1150;
              totalLaborCost += workHours * hourlyRate;
            }
          });
        }
        
        // è¨ˆç®—
        const totalSales = totalCashSales + totalEmoneSales + totalCreditSales;
        const averageSpend = totalCustomerCount > 0 ? Math.round(totalSales / totalCustomerCount) : 0;
        
        const tax8Excluded = Math.floor(totalTax8 / 1.08);
        const tax10Excluded = Math.floor(totalTax10 / 1.10);
        const tax8Amount = totalTax8 - tax8Excluded;
        const tax10Amount = totalTax10 - tax10Excluded;
        const totalTax = tax8Amount + tax10Amount;
        const taxExcludedTotal = tax8Excluded + tax10Excluded;
        const taxIncludedTotal = totalTax8 + totalTax10;
        const finalTotalSales = taxIncludedTotal - totalDiscount - totalExpense;
        
        const now = new Date();
        const outputTime = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        
        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
        const journalText = `
=====================================
      æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«
=====================================
æœŸé–“: ${startDate} ï½ ${endDate}
å‡ºåŠ›æ™‚åˆ»: ${outputTime}
å®¢æ•°: ${totalCustomerCount}çµ„
ç·å£²ä¸Šç‚¹æ•°: ${totalItems}ç‚¹
å¹³å‡å®¢å˜ä¾¡: Â¥${averageSpend.toLocaleString()}
åˆè¨ˆå£²ä¸Š: Â¥${totalSales.toLocaleString()}

-------------------------------------
å£²ä¸Šå†…è¨³
-------------------------------------
ç¾é‡‘: Â¥${totalCashSales.toLocaleString()}
é›»å­ãƒãƒãƒ¼: Â¥${totalEmoneSales.toLocaleString()}
ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰: Â¥${totalCreditSales.toLocaleString()}
å€¤å¼•ã: Â¥${totalDiscount.toLocaleString()}

-------------------------------------
ç¨é‡‘å†…è¨³ï¼ˆå†…ç¨ï¼‰
-------------------------------------
8%ã®å•†å“åˆè¨ˆï¼ˆç¨æŠœï¼‰: Â¥${tax8Excluded.toLocaleString()}
8%ã®å•†å“åˆè¨ˆï¼ˆç¨è¾¼ï¼‰: Â¥${totalTax8.toLocaleString()}
8%ã®æ¶ˆè²»ç¨: Â¥${tax8Amount.toLocaleString()}

10%ã®å•†å“åˆè¨ˆï¼ˆç¨æŠœï¼‰: Â¥${tax10Excluded.toLocaleString()}
10%ã®å•†å“åˆè¨ˆï¼ˆç¨è¾¼ï¼‰: Â¥${totalTax10.toLocaleString()}
10%ã®æ¶ˆè²»ç¨: Â¥${tax10Amount.toLocaleString()}

æ¶ˆè²»ç¨ã®åˆè¨ˆ: Â¥${totalTax.toLocaleString()}
ç¨æŠœåˆè¨ˆ: Â¥${taxExcludedTotal.toLocaleString()}
ç¨è¾¼åˆè¨ˆ: Â¥${taxIncludedTotal.toLocaleString()}
å€¤å¼•ãé‡‘é¡: Â¥${totalDiscount.toLocaleString()}
æ”¯å‡º: Â¥${totalExpense.toLocaleString()}
åˆè¨ˆå£²ä¸Š: Â¥${finalTotalSales.toLocaleString()}

-------------------------------------
ãã®ä»–
-------------------------------------
ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æ•°: ${totalDrawerOpen}å›
äººä»¶è²»: Â¥${Math.round(totalLaborCost).toLocaleString()}

=====================================
`;
        
        // PNGç”»åƒã¨ã—ã¦ä¿å­˜
        const journalDiv = document.createElement('div');
        journalDiv.style.cssText = `
          font-family: 'Courier New', monospace;
          font-size: 14px;
          line-height: 1.6;
          padding: 30px;
          background: white;
          color: black;
          white-space: pre-wrap;
          position: absolute;
          left: -9999px;
        `;
        journalDiv.textContent = journalText;
        document.body.appendChild(journalDiv);
        
        const canvas = await html2canvas(journalDiv, {
          backgroundColor: '#ffffff',
          scale: 2
        });
        
        document.body.removeChild(journalDiv);
        
        const link = document.createElement('a');
        link.download = `æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«_${startDate}_${endDate}.png`;
        link.href = canvas.toDataURL();
        link.click();
        
        console.log('âœ… æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆå®Œäº†');
        
        // å•†å“ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚½ãƒ¼ãƒˆï¼ˆè²©å£²æ•°ãŒå¤šã„é †ï¼‰
        const sortedItems = Object.entries(itemCounts).sort((a, b) => b[1] - a[1]);
        console.log('ğŸ“Š é›†è¨ˆã•ã‚ŒãŸå•†å“ãƒ‡ãƒ¼ã‚¿:', itemCounts);
        console.log('ğŸ“Š ã‚½ãƒ¼ãƒˆå¾Œã®å•†å“ãƒ‡ãƒ¼ã‚¿:', sortedItems);
        
        // å•†å“ã‚«ã‚¦ãƒ³ãƒˆã®HTMLç”Ÿæˆ
        let itemCountsHtml = '';
        sortedItems.forEach(([itemName, count]) => {
          itemCountsHtml += `
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
              <span>${itemName}</span>
              <strong>${count}å€‹</strong>
            </div>
          `;
        });
        
        // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        container.innerHTML = `
          <div style="padding: 20px;">
            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border-radius: 12px; margin-bottom: 20px;">
              <div style="font-size: 18px; margin-bottom: 10px;">âœ… ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ</div>
              <div style="font-size: 14px; opacity: 0.9;">æœŸé–“: ${startDate} ï½ ${endDate}</div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
              <h4 style="margin: 0 0 15px 0; color: #333;">ğŸ“Š æœŸé–“ã‚µãƒãƒªãƒ¼</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ç·å£²ä¸Š</div>
                  <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">Â¥${(totalCashSales + totalEmoneSales + totalCreditSales).toLocaleString()}</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">å®¢æ•°</div>
                  <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${totalCustomerCount}çµ„</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">è²©å£²ç‚¹æ•°</div>
                  <div style="font-size: 24px; font-weight: bold; color: #FF9800;">${totalItems}ç‚¹</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">å¹³å‡å®¢å˜ä¾¡</div>
                  <div style="font-size: 24px; font-weight: bold; color: #9C27B0;">Â¥${totalCustomerCount > 0 ? Math.round((totalCashSales + totalEmoneSales + totalCreditSales) / totalCustomerCount).toLocaleString() : 0}</div>
                </div>
              </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
              <h4 style="margin: 0 0 15px 0; color: #333;">ğŸ’³ æ”¯æ‰•æ–¹æ³•åˆ¥</h4>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>ç¾é‡‘</span>
                <strong>Â¥${totalCashSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>é›»å­ãƒãƒãƒ¼</span>
                <strong>Â¥${totalEmoneSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</span>
                <strong>Â¥${totalCreditSales.toLocaleString()}</strong>
              </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
              <h4 style="margin: 0 0 15px 0; color: #333;">ğŸ½ï¸ å•†å“åˆ¥è²©å£²æ•°</h4>
              <div style="max-height: 300px; overflow-y: auto;">
                ${itemCountsHtml || '<div style="text-align: center; color: #999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'}
              </div>
            </div>
          </div>
        `;
        
      } catch (e) {
        console.error('âŒ æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', e);
        alert('æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ========== å®¢æ•°æ©Ÿèƒ½ ==========
    
    // å®¢æ•°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showCustomerCountModal = async function() {
      document.getElementById('customerCountModal').classList.remove('hidden');
      await calculateCustomerCount();
    };
    
    // å®¢æ•°ã‚’è¨ˆç®—
    async function calculateCustomerCount() {
      const container = document.getElementById('customerCountContent');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">é›†è¨ˆä¸­...</div>';
      
      try {
        console.log('=== å®¢æ•°è¨ˆç®—é–‹å§‹ ===');
        
        // FirebaseåˆæœŸåŒ–ã‚’å¾…ã¤
        if (!window.firebaseReady) {
          console.log('â³ FirebaseåˆæœŸåŒ–å¾…æ©Ÿä¸­...');
          await new Promise(resolve => {
            window.addEventListener('firebaseReady', resolve, { once: true });
          });
          console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†ã‚’ç¢ºèª');
        }
        
        const now = new Date();
        const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        
        console.log('æ—¥ä»˜ã‚­ãƒ¼:', dateStr);
        
        const salesRef = window.doc(window.db, 'dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        let customerCount = 0;
        if (salesDoc.exists()) {
          customerCount = salesDoc.data().customerCount || 0;
          console.log('å–å¾—ã—ãŸå®¢æ•°:', customerCount);
        } else {
          console.log('æœ¬æ—¥ã®ãƒ‡ãƒ¼ã‚¿ãªã—');
        }
        
        console.log('æœ€çµ‚å®¢æ•°:', customerCount);
        
        container.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 80px; font-weight: bold; color: #00bcd4; margin: 20px 0;">
              ${customerCount}
            </div>
            <div style="font-size: 24px; color: #666;">
              çµ„
            </div>
          </div>
        `;
      } catch (e) {
        console.error('å®¢æ•°è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', e);
        container.innerHTML = '<div style="text-align: center; color: red;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    }
    
    // å®¢æ•°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeCustomerCountModal = function() {
      document.getElementById('customerCountModal').classList.add('hidden');
    };
    
    // ========== å£²ä¸Šæ©Ÿèƒ½ ==========
    
    // å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showSalesModal = function() {
      document.getElementById('salesModal').classList.remove('hidden');
      calculateSales();
    };
    
    // å£²ä¸Šã‚’è¨ˆç®—
    window.calculateSales = async function() {
      const container = document.getElementById('salesContent');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">é›†è¨ˆä¸­...</div>';
      
      try {
        // FirebaseåˆæœŸåŒ–ã‚’å¾…ã¤
        if (!window.firebaseReady) {
          await new Promise(resolve => {
            window.addEventListener('firebaseReady', resolve, { once: true });
          });
        }
        
        // ä»Šæ—¥ã®æ—¥æ¬¡å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ï¼ˆåˆå‰3æ™‚åŸºæº–ï¼‰
        const now = new Date();
        let targetDate = new Date(now);
        
        // åˆå‰3æ™‚ã‚ˆã‚Šå‰ãªã‚‰æ˜¨æ—¥æ‰±ã„
        if (now.getHours() < 3) {
          targetDate.setDate(targetDate.getDate() - 1);
        }
        
        const year = targetDate.getFullYear();
        const month = String(targetDate.getMonth() + 1).padStart(2, '0');
        const day = String(targetDate.getDate()).padStart(2, '0');
        const dateStr = `${year}-${month}-${day}`;
        
        console.log('ğŸ“Š å£²ä¸Šå–å¾—æ—¥ä»˜:', dateStr);
        
        const salesRef = window.doc(window.db, 'dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        console.log('ğŸ“„ dailySalesãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå­˜åœ¨:', salesDoc.exists());
        
        let totalSales = 0;
        let cashSales = 0;
        let emoneSales = 0;
        let creditSales = 0;
        let orderCount = 0;
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          console.log('ğŸ’° å£²ä¸Šãƒ‡ãƒ¼ã‚¿:', data);
          totalSales = data.totalSales || 0;
          cashSales = data.cashSales || 0;
          emoneSales = data.emoneSales || 0;
          creditSales = data.creditSales || 0;
          orderCount = data.customerCount || 0;
        } else {
          console.log('âš ï¸ å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
        }
        
        console.log('æœ€çµ‚å£²ä¸Š:', totalSales, 'æ³¨æ–‡æ•°:', orderCount);
        
        // å£²ä¸Šç›®æ¨™é”æˆç‡ã‚’è¨ˆç®—
        const dayOfWeek = now.getDay(); // 0=æ—¥æ›œ, 6=åœŸæ›œ
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
        const targetSales = isWeekend ? 70000 : 50000;
        const achievementRate = Math.round((totalSales / targetSales) * 100);
        
        const rateColor = achievementRate >= 100 ? '#4CAF50' : achievementRate >= 80 ? '#FF9800' : '#f44336';
        
        const targetSection = `
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
              <h4 style="margin: 0 0 10px 0;">ğŸ“Š å£²ä¸Šç›®æ¨™</h4>
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>ç›®æ¨™é‡‘é¡ï¼ˆ${isWeekend ? 'åœŸæ—¥ç¥' : 'å¹³æ—¥'}ï¼‰</span>
                <strong>Â¥${targetSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>ç¾åœ¨ã®å£²ä¸Š</span>
                <strong>Â¥${totalSales.toLocaleString()}</strong>
              </div>
              <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px;">
                <div style="font-size: 32px; font-weight: bold; color: ${rateColor};">
                  ${achievementRate}%
                </div>
                <div style="font-size: 14px; opacity: 0.9;">é”æˆç‡</div>
              </div>
            </div>
          `;
        
        container.innerHTML = `
          <div style="background: white; border-radius: 12px; padding: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
              <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;">ç·å£²ä¸Š</div>
                <div style="font-size: 28px; font-weight: bold;">Â¥${totalSales.toLocaleString()}</div>
              </div>
              <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;">å®¢æ•°</div>
                <div style="font-size: 28px; font-weight: bold;">${orderCount}ä»¶</div>
              </div>
            </div>
            
            ${targetSection}
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
              <h4 style="margin: 0 0 15px 0;">æ”¯æ‰•ã„æ–¹æ³•åˆ¥</h4>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>ç¾é‡‘</span>
                <strong>Â¥${cashSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>ã‚«ãƒ¼ãƒ‰</span>
                <strong>Â¥${creditSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span>é›»å­ãƒãƒãƒ¼</span>
                <strong>Â¥${emoneSales.toLocaleString()}</strong>
              </div>
            </div>
          </div>
        `;
      } catch (e) {
        console.error('å£²ä¸Šè¨ˆç®—ã‚¨ãƒ©ãƒ¼:', e);
        container.innerHTML = '<div style="text-align: center; color: red;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    };
    
    // å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeSalesModal = function() {
      document.getElementById('salesModal').classList.add('hidden');
    };
    
    // ========== ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æ©Ÿèƒ½ ==========
    
    // ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³
    window.openDrawer = async function() {
      try {
        const now = new Date();
        const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        
        // æ‹…å½“è€…ã‚’å–å¾—
        const staffSelect = document.getElementById('staffSelect');
        const staffName = staffSelect.value || 'ãƒ¬ã‚¸ä¿‚';
        
        // dailySalesã®ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æ•°ã‚’æ›´æ–°
        const salesRef = doc(db, 'dailySales', dateStr);
        const salesDoc = await getDoc(salesRef);
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          await updateDoc(salesRef, {
            drawerOpenCount: (data.drawerOpenCount || 0) + 1,
            updatedAt: Timestamp.now()
          });
        } else {
          // ä»Šæ—¥ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯æ–°è¦ä½œæˆ
          await setDoc(salesRef, {
            date: dateStr,
            totalSales: 0,
            customerCount: 0,
            totalItems: 0,
            tax8Total: 0,
            tax10Total: 0,
            cashSales: 0,
            emoneSales: 0,
            creditSales: 0,
            drawerOpenCount: 1,
            createdAt: Timestamp.now(),
            updatedAt: Timestamp.now()
          });
        }
        
        // ãƒ‰ãƒ­ã‚¢é–‹é–‰ãƒ­ã‚°ã‚’è¨˜éŒ²
        await addDoc(collection(db, 'drawer_logs'), {
          timestamp: Timestamp.now(),
          staffName: staffName,
          action: 'open'
        });
        
        console.log('ğŸ’° ãƒ‰ãƒ­ã‚¢é–‹: æ‹…å½“è€…', staffName);
        alert('ãƒ‰ãƒ­ã‚¢ã‚’é–‹ãã¾ã—ãŸ\næ‹…å½“è€…: ' + staffName);
        
      } catch (error) {
        console.error('âŒ ãƒ‰ãƒ­ã‚¢é–‹ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ‰ãƒ­ã‚¢é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };
    
    // ========== ç²¾ç®—æ©Ÿèƒ½ ==========
    
    // ç²¾ç®—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showSettlementModal = async function() {
      // FirebaseåˆæœŸåŒ–ã‚’å¾…ã¤
      if (!window.firebaseReady) {
        await new Promise(resolve => {
          window.addEventListener('firebaseReady', resolve, { once: true });
        });
      }
      
      // ä»Šæ—¥ã®æ—¥ä»˜ã‚’åˆæœŸå€¤ã¨ã—ã¦è¨­å®šï¼ˆåˆå‰3æ™‚åŸºæº–ï¼‰
      const now = new Date();
      let targetDate = new Date(now);
      
      // åˆå‰3æ™‚ã‚ˆã‚Šå‰ãªã‚‰æ˜¨æ—¥æ‰±ã„
      if (now.getHours() < 3) {
        targetDate.setDate(targetDate.getDate() - 1);
      }
      
      const year = targetDate.getFullYear();
      const month = String(targetDate.getMonth() + 1).padStart(2, '0');
      const day = String(targetDate.getDate()).padStart(2, '0');
      const todayDateStr = `${year}-${month}-${day}`;
      
      console.log('ğŸ“… ç²¾ç®—æ—¥ä»˜:', todayDateStr);
      
      document.getElementById('settlementDate').value = todayDateStr;
      
      const container = document.getElementById('settlementSummary');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">é›†è¨ˆä¸­...</div>';
      
      document.getElementById('settlementModal').classList.remove('hidden');
      
      // æ—¥ä»˜å¤‰æ›´æ™‚ã«ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
      document.getElementById('settlementDate').onchange = updateSettlementSummary;
      
      await updateSettlementSummary();
    };
    
    // ç²¾ç®—ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
    async function updateSettlementSummary() {
      const container = document.getElementById('settlementSummary');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">é›†è¨ˆä¸­...</div>';
      
      try {
        const dateStr = document.getElementById('settlementDate').value;
        
        // æ—¥æ¬¡å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
        const salesRef = window.doc(window.db, 'dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        let settlementData = {
          totalSales: 0,
          customerCount: 0,
          totalItems: 0,
          cashSales: 0,
          emoneSales: 0,
          creditSales: 0,
          totalDiscount: 0,
          tax8Total: 0,
          tax10Total: 0,
          drawerOpenCount: 0
        };
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          settlementData = {
            totalSales: data.totalSales || 0,
            customerCount: data.customerCount || 0,
            totalItems: data.totalItems || 0,
            cashSales: data.cashSales || 0,
            emoneSales: data.emoneSales || 0,
            creditSales: data.creditSales || 0,
            totalDiscount: data.totalDiscount || 0,
            tax8Total: data.tax8Total || 0,
            tax10Total: data.tax10Total || 0,
            drawerOpenCount: data.drawerOpenCount || 0
          };
        }
        
        // settlementDataã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ï¼ˆCSVç”Ÿæˆã§ä½¿ç”¨ï¼‰
        window.currentSettlementData = settlementData;
        window.currentSettlementDate = dateStr;
        
        container.innerHTML = `
          <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 2px solid #ddd;">
              <span style="font-size: 16px;">ç·å£²ä¸Š</span>
              <strong style="font-size: 20px; color: #4CAF50;">Â¥${settlementData.totalSales.toLocaleString()}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
              <span>å®¢æ•°</span>
              <strong>${settlementData.customerCount}çµ„</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
              <span>ç¾é‡‘</span>
              <strong>Â¥${settlementData.cashSales.toLocaleString()}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
              <span>ã‚«ãƒ¼ãƒ‰</span>
              <strong>Â¥${settlementData.creditSales.toLocaleString()}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0;">
              <span>é›»å­ãƒãƒãƒ¼</span>
              <strong>Â¥${settlementData.emoneSales.toLocaleString()}</strong>
            </div>
          </div>
        `;
      } catch (e) {
        console.error('ç²¾ç®—ã‚µãƒãƒªãƒ¼ã‚¨ãƒ©ãƒ¼:', e);
        container.innerHTML = '<div style="text-align: center; color: red;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    }
    
    // ç²¾ç®—ã‚’å®Ÿè¡Œï¼ˆCSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
    window.confirmSettlement = async function() {
      // FirebaseåˆæœŸåŒ–ã‚’å¾…ã¤
      if (!window.firebaseReady) {
        await new Promise(resolve => {
          window.addEventListener('firebaseReady', resolve, { once: true });
        });
      }
      
      try {
        const settlementData = window.currentSettlementData;
        const dateStr = window.currentSettlementDate;
        
        if (!settlementData) {
          alert('ç²¾ç®—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        console.log('ğŸ” ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆé–‹å§‹');
        console.log('ğŸ“Š settlementData:', settlementData);
        
        // ===== ç¾åœ¨æ™‚åˆ»ã‚’å–å¾— =====
        const now = new Date();
        const outputTime = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        
        // ===== æ‹…å½“è€…ã‚’å–å¾— =====
        const staffSelect = document.getElementById('staffSelect');
        const staffName = staffSelect.value || 'æœªé¸æŠ';
        
        // ===== dailySalesã‹ã‚‰åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— =====
        const customerCount = settlementData.customerCount || 0;
        const totalItems = settlementData.totalItems || 0;
        const totalSales = settlementData.totalSales || 0;
        const averageSpend = customerCount > 0 ? Math.round(totalSales / customerCount) : 0;
        
        // ===== å£²ä¸Šå†…è¨³ =====
        const cashSales = settlementData.cashSales || 0;
        const emoneSales = settlementData.emoneSales || 0;
        const creditSales = settlementData.creditSales || 0;
        const discountTotal = settlementData.totalDiscount || 0;
        
        // ===== ç¨é‡‘å†…è¨³ï¼ˆå†…ç¨ï¼‰ =====
        const tax8TotalWithTax = settlementData.tax8Total || 0;  // 8%å•†å“åˆè¨ˆï¼ˆç¨è¾¼ï¼‰
        const tax10TotalWithTax = settlementData.tax10Total || 0; // 10%å•†å“åˆè¨ˆï¼ˆç¨è¾¼ï¼‰
        
        // ç¨æŠœä¾¡æ ¼ã‚’è¨ˆç®—ï¼ˆå†…ç¨ãªã®ã§ç¨è¾¼ä¾¡æ ¼ã‹ã‚‰é€†ç®—ï¼‰
        const tax8Excluded = Math.floor(tax8TotalWithTax / 1.08);  // 8%å•†å“åˆè¨ˆï¼ˆç¨æŠœï¼‰
        const tax10Excluded = Math.floor(tax10TotalWithTax / 1.10); // 10%å•†å“åˆè¨ˆï¼ˆç¨æŠœï¼‰
        
        // æ¶ˆè²»ç¨é¡ã‚’è¨ˆç®—
        const tax8Amount = tax8TotalWithTax - tax8Excluded;  // 8%ã®æ¶ˆè²»ç¨
        const tax10Amount = tax10TotalWithTax - tax10Excluded; // 10%ã®æ¶ˆè²»ç¨
        
        // åˆè¨ˆ
        const totalTax = tax8Amount + tax10Amount;  // æ¶ˆè²»ç¨ã®åˆè¨ˆ
        const taxExcludedTotal = tax8Excluded + tax10Excluded;  // ç¨æŠœåˆè¨ˆ
        const taxIncludedTotal = tax8TotalWithTax + tax10TotalWithTax;  // ç¨è¾¼åˆè¨ˆï¼ˆ8%ã¨10%ã®åˆè¨ˆï¼‰
        
        // ===== ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æ•° =====
        const drawerOpenCount = settlementData.drawerOpenCount || 0;
        
        // ===== æ”¯å‡ºã‚’å–å¾— =====
        let expenseTotal = 0;
        try {
          const expenseDoc = await window.getDoc(window.doc(window.db, 'expenses', dateStr));
          if (expenseDoc.exists()) {
            expenseTotal = expenseDoc.data().total || 0;
            console.log('ğŸ’¸ æ”¯å‡º:', expenseTotal);
          }
        } catch (e) {
          console.error('æ”¯å‡ºå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        }
        
        // ===== äººä»¶è²»ã‚’å–å¾— =====
        let laborCost = 0;
        try {
          const attendanceSnapshot = await window.getDocs(window.collection(window.db, 'kintai_attendance'));
          attendanceSnapshot.forEach(docData => {
            const data = docData.data();
            if (data.date === dateStr && data.clockIn && data.clockOut) {
              // å‹¤å‹™æ™‚é–“ã‚’è¨ˆç®—
              const clockIn = new Date(`${dateStr} ${data.clockIn}`);
              const clockOut = new Date(`${dateStr} ${data.clockOut}`);
              let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
              
              // ä¼‘æ†©æ™‚é–“ã‚’å¼•ã
              if (data.breakStart1 && data.breakEnd1) {
                const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
              }
              if (data.breakStart2 && data.breakEnd2) {
                const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
              }
              
              const hourlyRate = data.hourlyRate || 1150;
              laborCost += workHours * hourlyRate;
            }
          });
          console.log('ğŸ‘· äººä»¶è²»:', laborCost);
        } catch (e) {
          console.error('äººä»¶è²»å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        }
        
        // å€¤å¼•ããƒ»æ”¯å‡ºã‚’å¼•ã„ãŸæœ€çµ‚åˆè¨ˆå£²ä¸Š
        const finalTotalSales = taxIncludedTotal - discountTotal - expenseTotal;
        
        // ===== ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° =====
        console.log('ğŸ“… æ—¥ä»˜:', dateStr);
        console.log('ğŸ• å‡ºåŠ›æ™‚åˆ»:', outputTime);
        console.log('ğŸ‘¥ å®¢æ•°:', customerCount);
        console.log('ğŸ“¦ ç·å£²ä¸Šç‚¹æ•°:', totalItems);
        console.log('ğŸ’° å¹³å‡å®¢å˜ä¾¡:', averageSpend);
        console.log('ğŸ’µ åˆè¨ˆå£²ä¸Š:', totalSales);
        console.log('ğŸ’¸ å€¤å¼•ã:', discountTotal);
        console.log('ğŸª 8%å•†å“ï¼ˆç¨è¾¼ï¼‰:', tax8TotalWithTax);
        console.log('ğŸª 8%å•†å“ï¼ˆç¨æŠœï¼‰:', tax8Excluded);
        console.log('ğŸª 8%æ¶ˆè²»ç¨:', tax8Amount);
        console.log('ğŸª 10%å•†å“ï¼ˆç¨è¾¼ï¼‰:', tax10TotalWithTax);
        console.log('ğŸª 10%å•†å“ï¼ˆç¨æŠœï¼‰:', tax10Excluded);
        console.log('ğŸª 10%æ¶ˆè²»ç¨:', tax10Amount);
        console.log('ğŸ”“ ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æ•°:', drawerOpenCount);
        console.log('ğŸ‘¤ æ‹…å½“è€…:', staffName);
        
        // ===== ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ =====
        const journalText = `
=====================================
      ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«
=====================================
å‡ºåŠ›æ™‚åˆ»: ${outputTime}
å®¢æ•°: ${customerCount}çµ„
ç·å£²ä¸Šç‚¹æ•°: ${totalItems}ç‚¹
å¹³å‡å®¢å˜ä¾¡: Â¥${averageSpend.toLocaleString()}
åˆè¨ˆå£²ä¸Š: Â¥${totalSales.toLocaleString()}

-------------------------------------
å£²ä¸Šå†…è¨³
-------------------------------------
ç¾é‡‘: Â¥${cashSales.toLocaleString()}
é›»å­ãƒãƒãƒ¼: Â¥${emoneSales.toLocaleString()}
ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰: Â¥${creditSales.toLocaleString()}
å€¤å¼•ã: Â¥${discountTotal.toLocaleString()}

-------------------------------------
ç¨é‡‘å†…è¨³ï¼ˆå†…ç¨ï¼‰
-------------------------------------
8%ã®å•†å“åˆè¨ˆï¼ˆç¨æŠœï¼‰: Â¥${tax8Excluded.toLocaleString()}
8%ã®å•†å“åˆè¨ˆï¼ˆç¨è¾¼ï¼‰: Â¥${tax8TotalWithTax.toLocaleString()}
8%ã®æ¶ˆè²»ç¨: Â¥${tax8Amount.toLocaleString()}

10%ã®å•†å“åˆè¨ˆï¼ˆç¨æŠœï¼‰: Â¥${tax10Excluded.toLocaleString()}
10%ã®å•†å“åˆè¨ˆï¼ˆç¨è¾¼ï¼‰: Â¥${tax10TotalWithTax.toLocaleString()}
10%ã®æ¶ˆè²»ç¨: Â¥${tax10Amount.toLocaleString()}

æ¶ˆè²»ç¨ã®åˆè¨ˆ: Â¥${totalTax.toLocaleString()}
ç¨æŠœåˆè¨ˆ: Â¥${taxExcludedTotal.toLocaleString()}
ç¨è¾¼åˆè¨ˆ: Â¥${taxIncludedTotal.toLocaleString()}
å€¤å¼•ãé‡‘é¡: Â¥${discountTotal.toLocaleString()}
æ”¯å‡º: Â¥${expenseTotal.toLocaleString()}
åˆè¨ˆå£²ä¸Š: Â¥${finalTotalSales.toLocaleString()}

-------------------------------------
ãã®ä»–
-------------------------------------
ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æ•°: ${drawerOpenCount}å›
äººä»¶è²»: Â¥${Math.round(laborCost).toLocaleString()}
æ‹…å½“è€…: ${staffName}

=====================================
`;
        
        // ===== HTMLè¦ç´ ã‚’ä½œæˆã—ã¦PNGç”»åƒã¨ã—ã¦ä¿å­˜ =====
        const journalDiv = document.createElement('div');
        journalDiv.style.cssText = `
          font-family: 'Courier New', monospace;
          font-size: 14px;
          line-height: 1.6;
          padding: 30px;
          background: white;
          color: black;
          white-space: pre-wrap;
          width: 800px;
          position: absolute;
          left: -9999px;
        `;
        journalDiv.textContent = journalText;
        document.body.appendChild(journalDiv);
        
        // html2canvasã§ç”»åƒåŒ–
        const canvas = await html2canvas(journalDiv, {
          scale: 2,
          backgroundColor: '#ffffff',
          logging: false
        });
        
        // PNGç”»åƒã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«_${dateStr}.png`;
          link.click();
          URL.revokeObjectURL(url);
          document.body.removeChild(journalDiv);
        });
        
        // ===== ç²¾ç®—è¨˜éŒ²ã‚’Firebaseã«ä¿å­˜ =====
        await window.addDoc(window.collection(window.db, 'settlements'), {
          date: dateStr,
          outputTime: outputTime,
          timestamp: window.Timestamp.now(),
          customerCount: customerCount,
          totalItems: totalItems,
          averageSpend: averageSpend,
          totalSales: totalSales,
          cashSales: cashSales,
          emoneSales: emoneSales,
          creditSales: creditSales,
          discountTotal: discountTotal,
          tax8TotalWithTax: tax8TotalWithTax,
          tax8Excluded: tax8Excluded,
          tax8Amount: tax8Amount,
          tax10TotalWithTax: tax10TotalWithTax,
          tax10Excluded: tax10Excluded,
          tax10Amount: tax10Amount,
          totalTax: totalTax,
          taxExcludedTotal: taxExcludedTotal,
          taxIncludedTotal: taxIncludedTotal,
          drawerOpenCount: drawerOpenCount,
          staffName: staffName,
          aiComment: aiComment
        });
        
        console.log('âœ… ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆå®Œäº†');
        closeSettlementModal();
        
      } catch (e) {
        console.error('âŒ ç²¾ç®—ã‚¨ãƒ©ãƒ¼:', e);
        alert('ç²¾ç®—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ç²¾ç®—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeSettlementModal = function() {
      document.getElementById('settlementModal').classList.add('hidden');
    };
    
    // ===== æ”¯å‡ºæ©Ÿèƒ½ =====
    let expenseRows = [];
    let currentExpenseDate = null;
    
    // æ”¯å‡ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.showExpenseModal = async function() {
      const now = new Date();
      const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
      
      // æœ¬æ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆåˆå‰3æ™‚åŸºæº–ï¼‰
      const todayStart = new Date(jstNow);
      todayStart.setHours(3, 0, 0, 0);
      if (jstNow.getHours() < 3) {
        todayStart.setDate(todayStart.getDate() - 1);
      }
      
      const year = todayStart.getFullYear();
      const month = String(todayStart.getMonth() + 1).padStart(2, '0');
      const day = String(todayStart.getDate()).padStart(2, '0');
      currentExpenseDate = `${year}-${month}-${day}`;
      
      console.log('æ”¯å‡ºãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º:', currentExpenseDate);
      
      // Firebaseã‹ã‚‰æœ¬æ—¥ã®æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      try {
        const expenseDoc = await window.getDoc(window.doc(window.db, 'expenses', currentExpenseDate));
        
        if (expenseDoc.exists()) {
          expenseRows = expenseDoc.data().items || [];
          console.log('æ—¢å­˜ã®æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿:', expenseRows);
        } else {
          // æ–°è¦ã®å ´åˆã¯åˆæœŸè¡Œã‚’è¿½åŠ 
          expenseRows = [
            { storeName: '', category: '', detail: '', amount: 0 },
            { storeName: '', category: '', detail: '', amount: 0 },
            { storeName: '', category: '', detail: '', amount: 0 }
          ];
        }
      } catch (e) {
        console.error('æ”¯å‡ºãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        expenseRows = [
          { storeName: '', category: '', detail: '', amount: 0 },
          { storeName: '', category: '', detail: '', amount: 0 },
          { storeName: '', category: '', detail: '', amount: 0 }
        ];
      }
      
      renderExpenseTable();
      document.getElementById('expenseModal').classList.remove('hidden');
    };
    
    // æ”¯å‡ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeExpenseModal = function() {
      document.getElementById('expenseModal').classList.add('hidden');
    };
    
    // æ”¯å‡ºè¡Œã‚’è¿½åŠ 
    window.addExpenseRow = function() {
      expenseRows.push({
        storeName: '',
        category: '',
        detail: '',
        amount: 0
      });
      renderExpenseTable();
    };
    
    // æ”¯å‡ºè¡Œã‚’å‰Šé™¤
    window.deleteExpenseRow = function(index) {
      expenseRows.splice(index, 1);
      renderExpenseTable();
    };
    
    // æ”¯å‡ºãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
    // å‹˜å®šç§‘ç›®ã¨ç¨ç‡ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const categoryTaxRates = {
      'ææ–™è²»': 8,
      'æ—¥ç”¨å“': 10,
      'æ°´å…‰ç†±è²»': 10,
      'é›‘è²»ãƒ»é›‘å“': 10,
      'ãã®ä»–': 10
    };
    
    function renderExpenseTable() {
      const tbody = document.getElementById('expenseTableBody');
      tbody.innerHTML = '';
      
      expenseRows.forEach((row, index) => {
        const taxRate = categoryTaxRates[row.category] || 10;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding: 8px; border: 1px solid #ddd;">
            <input type="text" value="${row.storeName}" onchange="updateExpenseRow(${index}, 'storeName', this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <select onchange="updateExpenseRow(${index}, 'category', this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="ææ–™è²»" ${row.category === 'ææ–™è²»' ? 'selected' : ''}>ææ–™è²» (8%)</option>
              <option value="æ—¥ç”¨å“" ${row.category === 'æ—¥ç”¨å“' ? 'selected' : ''}>æ—¥ç”¨å“ (10%)</option>
              <option value="æ°´å…‰ç†±è²»" ${row.category === 'æ°´å…‰ç†±è²»' ? 'selected' : ''}>æ°´å…‰ç†±è²» (10%)</option>
              <option value="é›‘è²»ãƒ»é›‘å“" ${row.category === 'é›‘è²»ãƒ»é›‘å“' ? 'selected' : ''}>é›‘è²»ãƒ»é›‘å“ (10%)</option>
              <option value="ãã®ä»–" ${row.category === 'ãã®ä»–' ? 'selected' : ''}>ãã®ä»– (10%)</option>
            </select>
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <input type="text" value="${row.detail}" onchange="updateExpenseRow(${index}, 'detail', this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <input type="number" value="${row.amount}" onchange="updateExpenseRow(${index}, 'amount', parseFloat(this.value) || 0)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
            <button onclick="deleteExpenseRow(${index})" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      updateExpenseTotal();
    }
    
    // æ”¯å‡ºè¡Œã‚’æ›´æ–°
    window.updateExpenseRow = function(index, field, value) {
      expenseRows[index][field] = value;
      updateExpenseTotal();
    };
    
    // æ”¯å‡ºåˆè¨ˆã‚’æ›´æ–°
    function updateExpenseTotal() {
      const total = expenseRows.reduce((sum, row) => sum + (parseFloat(row.amount) || 0), 0);
      document.getElementById('expenseTotal').textContent = total.toLocaleString();
    }
    
    // æ”¯å‡ºã‚’ä¿å­˜
    window.saveExpenses = async function() {
      try {
        console.log('æ”¯å‡ºã‚’ä¿å­˜ä¸­:', currentExpenseDate, expenseRows);
        
        const total = expenseRows.reduce((sum, row) => sum + (parseFloat(row.amount) || 0), 0);
        
        await window.setDoc(window.doc(window.db, 'expenses', currentExpenseDate), {
          date: currentExpenseDate,
          items: expenseRows,
          total: total,
          updatedAt: window.Timestamp.now()
        });
        
        console.log('âœ… æ”¯å‡ºä¿å­˜å®Œäº†');
        alert('æ”¯å‡ºã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        closeExpenseModal();
        
      } catch (e) {
        console.error('âŒ æ”¯å‡ºä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
        alert('æ”¯å‡ºã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // æ”¯å‡ºã‚’HTMLå½¢å¼ã§å‡ºåŠ›
    window.exportExpensesToCSV = function() {
      try {
        console.log('ğŸ“„ æ”¯å‡ºHTMLå‡ºåŠ›é–‹å§‹');
        
        // å‹˜å®šç§‘ç›®ã¨ç¨ç‡ã®ãƒãƒƒãƒ”ãƒ³ã‚°
        const categoryTaxRates = {
          'ææ–™è²»': 8,
          'æ—¥ç”¨å“': 10,
          'æ°´å…‰ç†±è²»': 10,
          'é›‘è²»ãƒ»é›‘å“': 10,
          'ãã®ä»–': 10
        };
        
        // HTMLã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ä½œæˆ
        let htmlContent = `
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>æ”¯å‡ºæ˜ç´°_${currentExpenseDate}</title>
  <style>
    body { font-family: 'Meiryo', sans-serif; padding: 20px; }
    h2 { color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 30px; }
    th { background: #4CAF50; color: white; padding: 10px; text-align: left; }
    td { border: 1px solid #ddd; padding: 8px; }
    tr:nth-child(even) { background: #f9f9f9; }
    .summary-table th { background: #667eea; }
    .total-row { font-weight: bold; background: #e8f5e9 !important; }
  </style>
</head>
<body>
  <h1>æ”¯å‡ºæ˜ç´°æ›¸</h1>
  <p>æ—¥ä»˜: ${currentExpenseDate}</p>
  
  <h2>æ”¯å‡ºä¸€è¦§</h2>
  <table>
    <thead>
      <tr>
        <th>åº—å</th>
        <th>å‹˜å®šç§‘ç›®</th>
        <th>è©³ç´°</th>
        <th>é‡‘é¡</th>
        <th>ç¨ç‡</th>
      </tr>
    </thead>
    <tbody>
`;
        
        // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’è¿½åŠ 
        expenseRows.forEach(row => {
          const category = row.category || 'ãã®ä»–';
          const taxRate = categoryTaxRates[category] || 10;
          htmlContent += `
      <tr>
        <td>${row.storeName || ''}</td>
        <td>${category}</td>
        <td>${row.detail || ''}</td>
        <td style="text-align: right;">Â¥${(row.amount || 0).toLocaleString()}</td>
        <td style="text-align: center;">${taxRate}%</td>
      </tr>
`;
        });
        
        htmlContent += `
    </tbody>
  </table>
  
  <h2>å‹˜å®šç§‘ç›®åˆ¥åˆè¨ˆ</h2>
  <table class="summary-table">
    <thead>
      <tr>
        <th>å‹˜å®šç§‘ç›®</th>
        <th>é‡‘é¡</th>
        <th>ç¨ç‡</th>
      </tr>
    </thead>
    <tbody>
`;
        
        // å‹˜å®šç§‘ç›®ã”ã¨ã®åˆè¨ˆã‚’è¨ˆç®—
        const categoryTotals = {};
        expenseRows.forEach(row => {
          const category = row.category || 'ãã®ä»–';
          if (!categoryTotals[category]) {
            categoryTotals[category] = 0;
          }
          categoryTotals[category] += parseFloat(row.amount) || 0;
        });
        
        // å‹˜å®šç§‘ç›®ã”ã¨ã®åˆè¨ˆã‚’å‡ºåŠ›
        Object.keys(categoryTotals).forEach(category => {
          const total = categoryTotals[category];
          const taxRate = categoryTaxRates[category] || 10;
          htmlContent += `
      <tr>
        <td>${category}</td>
        <td style="text-align: right;">Â¥${total.toLocaleString()}</td>
        <td style="text-align: center;">${taxRate}%</td>
      </tr>
`;
        });
        
        htmlContent += `
    </tbody>
  </table>
  
  <h2>ç¨ç‡åˆ¥åˆè¨ˆ</h2>
  <table class="summary-table">
    <thead>
      <tr>
        <th>ç¨ç‡</th>
        <th>åˆè¨ˆé‡‘é¡</th>
      </tr>
    </thead>
    <tbody>
`;
        
        // ç¨ç‡åˆ¥ã®åˆè¨ˆã‚’è¨ˆç®—
        let tax8Total = 0;
        let tax10Total = 0;
        
        expenseRows.forEach(row => {
          const category = row.category || 'ãã®ä»–';
          const amount = parseFloat(row.amount) || 0;
          const taxRate = categoryTaxRates[category] || 10;
          
          if (taxRate === 8) {
            tax8Total += amount;
          } else {
            tax10Total += amount;
          }
        });
        
        htmlContent += `
      <tr>
        <td>8%</td>
        <td style="text-align: right;">Â¥${tax8Total.toLocaleString()}</td>
      </tr>
      <tr>
        <td>10%</td>
        <td style="text-align: right;">Â¥${tax10Total.toLocaleString()}</td>
      </tr>
      <tr class="total-row">
        <td>ç·åˆè¨ˆ</td>
        <td style="text-align: right;">Â¥${(tax8Total + tax10Total).toLocaleString()}</td>
      </tr>
    </tbody>
  </table>
</body>
</html>
`;
        
        // Blobã‚’ä½œæˆã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const blob = new Blob([htmlContent], { type: 'text/html;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        
        link.setAttribute('href', url);
        link.setAttribute('download', `æ”¯å‡º_${currentExpenseDate}.html`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('âœ… CSVå‡ºåŠ›å®Œäº†');
        alert('CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
        
      } catch (e) {
        console.error('âŒ CSVå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', e);
        alert('CSVå‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ===== æ—¥è¨ˆè¡¨ç”Ÿæˆæ©Ÿèƒ½ =====
    window.generateDailyReport = async function() {
      try {
        console.log('ğŸ“Š æ—¥è¨ˆè¡¨ç”Ÿæˆé–‹å§‹');
        
        // å½“æœˆã®å…¨ã¦ã®æ—¥æ¬¡å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        
        // æœˆã®æœ€åˆã®æ—¥ã¨æœ€å¾Œã®æ—¥ã‚’è¨ˆç®—
        const firstDay = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0);
        const daysInMonth = lastDay.getDate();
        
        console.log(`${year}å¹´${month}æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...`);
        
        // Firestoreã‹ã‚‰å½“æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const dailySalesSnapshot = await window.getDocs(window.collection(window.db, 'dailySales'));
        
        // æ—¥ä»˜ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†
        const salesByDate = {};
        dailySalesSnapshot.forEach(doc => {
          const data = doc.data();
          const date = data.date;
          
          // å½“æœˆã®ãƒ‡ãƒ¼ã‚¿ã®ã¿
          if (date && date.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
            salesByDate[date] = data;
          }
        });
        
        console.log('å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:', salesByDate);
        
        // Excelãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
        const excelData = [];
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ1ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‰
        excelData.push(['', 'å£²ä¸Šæ—¥è¨ˆè¡¨', '', '', '', '', '', '', '', '', 'ç²‰ã‚‚ã‚“å±‹ å…«  ä¸‹èµ¤å¡šåº—', '', '', '']);
        excelData.push(['', '', '', '', '', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', `${year}-${String(month).padStart(2, '0')}-01`, '', '', '', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', '', '', '', '', '', '', '', '', '', '', '', '', '']);
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ2ï¼ˆåˆ—åï¼‰
        excelData.push(['', 'æ—¥', 'æ›œæ—¥', 'ä¼ç¥¨æ•°', 'ç¾é‡‘', 'ã‚«ãƒ¼ãƒ‰', 'é›»å­ãƒãƒãƒ¼', 'å£²ä¸Šåˆè¨ˆ', 'äººä»¶è²»', 'äººä»¶è²»%', 'æ”¯æ‰•ã„', 'ç´”å£²ä¸Š', 'TOTALç²—åˆ©', 'å¤©æ°—']);
        
        // æ›œæ—¥é…åˆ—
        const weekDays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
        
        // ç´¯è¨ˆç²—åˆ©
        let totalGrossProfit = 0;
        
        // åˆè¨ˆç”¨ã®å¤‰æ•°
        let sumCustomerCount = 0;
        let sumCashSales = 0;
        let sumCreditSales = 0;
        let sumEmoneSales = 0;
        let sumTotalSales = 0;
        let sumLaborCost = 0;
        let sumPayment = 0;
        let sumNetSales = 0;
        
        // å„æ—¥ã®ãƒ‡ãƒ¼ã‚¿
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const date = new Date(year, month - 1, day);
          const weekDay = weekDays[date.getDay()];
          
          const data = salesByDate[dateStr];
          
          if (data) {
            // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
            const customerCount = data.customerCount || 0;
            const cashSales = data.cashSales || 0;
            const creditSales = data.creditSales || 0;
            const emoneSales = data.emoneSales || 0;
            const totalSales = cashSales + creditSales + emoneSales;
            
            // äººä»¶è²»ã‚’kintai_attendanceã‹ã‚‰å–å¾—
            let laborCost = 0;
            try {
              const attendanceSnapshot = await window.getDocs(window.collection(window.db, 'kintai_attendance'));
              attendanceSnapshot.forEach(docData => {
                const attData = docData.data();
                if (attData.date === dateStr && attData.clockIn && attData.clockOut) {
                  const clockIn = new Date(`${dateStr} ${attData.clockIn}`);
                  const clockOut = new Date(`${dateStr} ${attData.clockOut}`);
                  let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                  
                  if (attData.breakStart1 && attData.breakEnd1) {
                    const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                    const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                    workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                  }
                  if (attData.breakStart2 && attData.breakEnd2) {
                    const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                    const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                    workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                  }
                  
                  const hourlyRate = attData.hourlyRate || 1150;
                  laborCost += workHours * hourlyRate;
                }
              });
            } catch (e) {
              console.error('äººä»¶è²»å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
            }
            
            const laborCostPercent = totalSales > 0 ? Math.round(laborCost / totalSales * 100) : 0;
            
            // æ”¯å‡ºã‚’expensesã‹ã‚‰å–å¾—
            let payment = 0;
            try {
              const expenseDoc = await window.getDoc(window.doc(window.db, 'expenses', dateStr));
              if (expenseDoc.exists()) {
                payment = expenseDoc.data().total || 0;
              }
            } catch (e) {
              console.error('æ”¯å‡ºå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
            }
            
            // ç´”å£²ä¸Š
            const netSales = totalSales - laborCost - payment;
            
            // ç´¯è¨ˆç²—åˆ©
            totalGrossProfit += netSales;
            
            // åˆè¨ˆã«åŠ ç®—
            sumCustomerCount += customerCount;
            sumCashSales += cashSales;
            sumCreditSales += creditSales;
            sumEmoneSales += emoneSales;
            sumTotalSales += totalSales;
            sumLaborCost += laborCost;
            sumPayment += payment;
            sumNetSales += netSales;
            
            excelData.push([
              '',
              date,
              weekDay,
              customerCount,
              cashSales,
              creditSales,
              emoneSales,
              totalSales,
              Math.round(laborCost),
              laborCostPercent + '%',  // %è¨˜å·ã‚’ä»˜ã‘ã‚‹
              payment,
              Math.round(netSales),
              Math.round(totalGrossProfit),
              '' // å¤©æ°—ã¯æ‰‹å‹•å…¥åŠ›
            ]);
          } else {
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆï¼ˆç©ºè¡Œï¼‰
            excelData.push([
              '',
              date,
              weekDay,
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              ''
            ]);
          }
        }
        
        // åˆè¨ˆè¡Œã‚’è¿½åŠ 
        const avgLaborCostPercent = sumTotalSales > 0 ? Math.round(sumLaborCost / sumTotalSales * 100) : 0;
        excelData.push([
          '',
          '',
          'åˆè¨ˆ',
          sumCustomerCount,
          sumCashSales,
          sumCreditSales,
          sumEmoneSales,
          sumTotalSales,
          Math.round(sumLaborCost),
          avgLaborCostPercent + '%',
          sumPayment,
          Math.round(sumNetSales),
          '', // TOTALç²—åˆ©ã¯æœ€å¾Œã®è¡Œã®å€¤
          ''
        ]);
        
        console.log('Excelãƒ‡ãƒ¼ã‚¿ä½œæˆå®Œäº†:', excelData.length, 'è¡Œ');
        
        // SheetJSã§Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // åˆ—å¹…ã‚’è¨­å®š
        ws['!cols'] = [
          { wch: 3 },  // Aåˆ—
          { wch: 12 }, // Båˆ—ï¼ˆæ—¥ä»˜ï¼‰
          { wch: 5 },  // Cåˆ—ï¼ˆæ›œæ—¥ï¼‰
          { wch: 8 },  // Dåˆ—ï¼ˆä¼ç¥¨æ•°ï¼‰
          { wch: 10 }, // Eåˆ—ï¼ˆç¾é‡‘ï¼‰
          { wch: 10 }, // Fåˆ—ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰
          { wch: 10 }, // Gåˆ—ï¼ˆpaypayï¼‰
          { wch: 10 }, // Håˆ—ï¼ˆå£²ä¸Šåˆè¨ˆï¼‰
          { wch: 10 }, // Iåˆ—ï¼ˆäººä»¶è²»ï¼‰
          { wch: 10 }, // Jåˆ—ï¼ˆäººä»¶è²»%ï¼‰
          { wch: 10 }, // Kåˆ—ï¼ˆæ”¯æ‰•ã„ï¼‰
          { wch: 10 }, // Låˆ—ï¼ˆç´”å£²ä¸Šï¼‰
          { wch: 12 }, // Måˆ—ï¼ˆTOTALç²—åˆ©ï¼‰
          { wch: 10 }  // Nåˆ—ï¼ˆå¤©æ°—ï¼‰
        ];
        
        XLSX.utils.book_append_sheet(wb, ws, 'å£²ä¸Šæ—¥è¨ˆè¡¨');
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const fileName = `æ—¥è¨ˆè¡¨${year}å¹´${month}æœˆ.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        console.log('âœ… æ—¥è¨ˆè¡¨å‡ºåŠ›å®Œäº†:', fileName);
        alert(`æ—¥è¨ˆè¡¨ã‚’å‡ºåŠ›ã—ã¾ã—ãŸï¼\n${fileName}`);
        
      } catch (e) {
        console.error('âŒ æ—¥è¨ˆè¡¨ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', e);
        alert('æ—¥è¨ˆè¡¨ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // æ‰‹å‹•ã‚«ãƒ¼ãƒˆã®è¡¨ç¤ºæ›´æ–°
    function updateManualCart() {
      const container = document.getElementById('selectedItems');
      const submitBtn = document.getElementById('manualSubmitBtn');
      const manualTable = document.getElementById('manualTable');
      
      if (manualCart.length === 0) {
        container.innerHTML = '<div class="empty-state">å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
        submitBtn.disabled = true;
        document.getElementById('manualTotal').textContent = 'Â¥0';
        return;
      }
      
      container.innerHTML = '';
      let total = 0;
      
      manualCart.forEach((item, index) => {
        const itemBasePrice = item.price;
        const itemWithTopping = itemBasePrice + (item.toppingPrice || 0);
        const itemTotal = itemWithTopping * item.quantity;
        total += itemTotal;
        
        // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’æ”¹è¡Œã§è¡¨ç¤º
        let toppingsHtml = '';
        if (item.toppings && item.toppings !== 'ãªã—') {
          const toppingList = item.toppings.split(', ');
          toppingsHtml = toppingList.map(t => `<div style="font-size: 12px; color: #666; padding-left: 10px;">ã€€${t}</div>`).join('');
        }
        
        const div = document.createElement('div');
        div.className = 'selected-item-detailed';
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <div style="font-weight: bold;">${item.name} Ã—${item.quantity}</div>
            <div>Â¥${itemBasePrice.toLocaleString()}</div>
          </div>
          ${toppingsHtml}
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 5px; border-top: 1px dashed #ddd;">
            <div style="display: flex; gap: 5px;">
              <input type="number" class="quantity-input" min="1" value="${item.quantity}" 
                     onchange="updateQuantity(${index}, this.value)">
              <button class="edit-btn" onclick="editCartItem(${index})">ä¿®æ­£</button>
              <button class="remove-btn" onclick="removeFromManualCart(${index})">å‰Šé™¤</button>
            </div>
            <div style="font-weight: bold; color: #667eea;">Â¥${itemWithTopping.toLocaleString()} Ã— ${item.quantity} = Â¥${itemTotal.toLocaleString()}</div>
          </div>
        `;
        container.appendChild(div);
      });
      
      document.getElementById('manualTotal').textContent = `Â¥${total.toLocaleString()}`;
      submitBtn.disabled = manualCart.length === 0 || !manualTable.value;
    }
    
    // ã‚«ãƒ¼ãƒˆå†…ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä¿®æ­£
    window.editCartItem = function(index) {
      const item = manualCart[index];
      
      // ç¾åœ¨ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°æƒ…å ±ã‚’ä¿æŒ
      currentSelectingItem = { ...item };
      currentSelectingItem.editIndex = index;
      
      // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’å¾©å…ƒ
      selectedToppings = [];
      if (item.toppings && item.toppings !== 'ãªã—') {
        const toppingNames = item.toppings.split(', ');
        toppingNames.forEach(name => {
          const topping = toppingsData.find(t => t.name === name);
          if (topping) {
            selectedToppings.push(topping);
          }
        });
      }
      
      // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      showToppingModalForEdit(item, index);
    };
    
    // ä¿®æ­£ç”¨ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«
    function showToppingModalForEdit(item, index) {
      document.getElementById('toppingModalItemName').textContent = item.name + ' (ä¿®æ­£)';
      const list = document.getElementById('toppingsList');
      list.innerHTML = '';
      
      // ã€Œãªã—ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³
      const noneDiv = document.createElement('div');
      noneDiv.className = 'topping-item';
      noneDiv.style.cursor = 'pointer';
      noneDiv.innerHTML = `
        <input type="checkbox" id="topping-none" style="pointer-events: none;">
        <div class="topping-item-info">
          <span class="topping-item-name">æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°</span>
          <span class="topping-item-price">Â¥0</span>
        </div>
      `;
      
      // divå…¨ä½“ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«
      noneDiv.onclick = () => {
        const checkbox = document.getElementById('topping-none');
        checkbox.checked = !checkbox.checked;
        selectNoneTopping(checkbox);
      };
      
      list.appendChild(noneDiv);
      
      // toppingsIdã‹ã‚‰ãƒˆãƒƒãƒ”ãƒ³ã‚°IDã®ãƒªã‚¹ãƒˆã‚’å–å¾—
      let allowedToppingIds = [];
      if (item.toppingsId && typeof item.toppingsId === 'string') {
        allowedToppingIds = item.toppingsId.split(',').map(id => id.trim());
      } else if (item.toppings && Array.isArray(item.toppings)) {
        allowedToppingIds = item.toppings;
      }
      
      toppingsData.forEach(topping => {
        // toppingsIdãŒç©ºã¾ãŸã¯å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã«è¡¨ç¤º
        if (allowedToppingIds.length === 0 || allowedToppingIds.includes(topping.id)) {
          const isSelected = selectedToppings.some(t => t.id === topping.id);
          const div = document.createElement('div');
          div.className = 'topping-item';
          div.style.cursor = 'pointer';
          div.innerHTML = `
            <input type="checkbox" id="topping-${topping.id}" value="${topping.id}" 
                   style="pointer-events: none;" ${isSelected ? 'checked' : ''}>
            <div class="topping-item-info">
              <span class="topping-item-name">${topping.name}</span>
              <span class="topping-item-price">+Â¥${topping.price.toLocaleString()}</span>
            </div>
          `;
          
          // divå…¨ä½“ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«
          div.onclick = () => {
            const checkbox = document.getElementById(`topping-${topping.id}`);
            checkbox.checked = !checkbox.checked;
            selectTopping(checkbox);
          };
          
          list.appendChild(div);
        }
      });
      
      // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€Œãªã—ã€ã‚’é¸æŠ
      if (selectedToppings.length === 0) {
        document.getElementById('topping-none').checked = true;
      }
      
      document.getElementById('toppingModal').classList.remove('hidden');
    }
    
    // æ•°é‡æ›´æ–°
    window.updateQuantity = function(index, value) {
      const qty = parseInt(value) || 1;
      manualCart[index].quantity = Math.max(1, qty);
      updateManualCart();
    };
    
    // ã‚«ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤
    window.removeFromManualCart = function(index) {
      const item = manualCart[index];
      const checkbox = document.getElementById(`menu-${item.id}`);
      if (checkbox) checkbox.checked = false;
      
      manualCart.splice(index, 1);
      updateManualCart();
    };
    
    // æ‰‹å‹•æ³¨æ–‡ã‚’é€ä¿¡
    window.submitManualOrder = async function() {
      const tableNumber = document.getElementById('manualTable').value;
      
      if (!tableNumber || manualCart.length === 0) {
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã¨å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        const now = new Date();
        const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        
        const todayStart = new Date(jstNow);
        todayStart.setHours(1, 0, 0, 0);
        if (jstNow < todayStart) {
          todayStart.setDate(todayStart.getDate() - 1);
        }
        
        const ordersSnapshot = await window.getDocs(window.collection(window.db, 'orders'));
        let maxOrderNumber = 618;
        let hasActiveOrders = false;
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          
          // å‰Šé™¤ã•ã‚Œã¦ã„ãªã„æ³¨æ–‡ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if (!data.deleted) {
            hasActiveOrders = true;
            
            // å‰Šé™¤ã•ã‚Œã¦ã„ãªã„æ³¨æ–‡ã®ã¿ã‹ã‚‰æœ€å¤§ç•ªå·ã‚’å–å¾—
            const orderDate = data.timestamp.toDate();
            const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
            
            if (jstOrderDate >= todayStart && data.orderNumber > maxOrderNumber) {
              maxOrderNumber = data.orderNumber;
            }
          }
        });
        
        // å‰Šé™¤ã•ã‚Œã¦ã„ãªã„æ³¨æ–‡ãŒ0ä»¶ãªã‚‰619ç•ªã‹ã‚‰é–‹å§‹
        const orderNumber = hasActiveOrders ? (maxOrderNumber + 1) : 619;
        
        console.log('æ³¨æ–‡ç•ªå·ç”Ÿæˆ:', {
          hasActiveOrders,
          maxOrderNumber,
          nextOrderNumber: orderNumber
        });
        
        let totalAmount = 0;
        manualCart.forEach(item => {
          totalAmount += item.price * item.quantity;
        });
        
        const deleteAt = new Date(now.getTime() + 10 * 60 * 1000);
        
        const orderData = {
          orderNumber: orderNumber,
          timestamp: window.Timestamp.fromDate(now),
          tableNumber: tableNumber,
          items: manualCart,
          totalAmount: totalAmount,
          status: 'pending',
          deleteAt: window.Timestamp.fromDate(deleteAt),
          cancelledAt: null,
          completedAt: null,
          paidAt: null,
          notifiedComplete: false,
          notifiedCancel: false,
          notifiedPaid: false,
          manualEntry: true
        };
        
        const docRef = await window.addDoc(window.collection(window.db, 'orders'), orderData);
        
        await window.updateDoc(docRef, {
          orderId: docRef.id
        });
        
        manualCart = [];
        document.getElementById('manualTable').value = '';
        document.querySelectorAll('#menuItemsList input[type="checkbox"]').forEach(cb => cb.checked = false);
        updateManualCart();
        
      } catch (e) {
        console.error('æ³¨æ–‡ã‚¨ãƒ©ãƒ¼:', e);
        alert('æ³¨æ–‡ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹
    function startRealtimeUpdates() {
      TABLES.forEach(table => {
        monitorTable(table);
      });
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ³¨æ–‡ã‚’ç›£è¦–
    async function monitorTable(tableNum) {
      const q = query(
        window.collection(window.db, 'orders'),
        where('tableNumber', '==', String(tableNum))
      );
      
      onSnapshot(q, (snapshot) => {
        const unpaidOrders = snapshot.docs.filter(doc => {
          const data = doc.data();
          // å‰Šé™¤æ¸ˆã¿ã€ä¼šè¨ˆæ¸ˆã¿ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿ã‚’é™¤å¤–
          return !data.deleted && !data.paidAt && !data.cancelledAt;
        });
        
        const hasActiveOrders = unpaidOrders.length > 0;
        const orderCount = unpaidOrders.length;
        
        const btn = document.getElementById(`table-${tableNum}`);
        if (btn) {
          // has-ordersã‚¯ãƒ©ã‚¹ã®æ›´æ–°
          if (hasActiveOrders) {
            btn.classList.add('has-orders');
          } else {
            btn.classList.remove('has-orders');
          }
          
          // æ—¢å­˜ã®ãƒãƒƒã‚¸ã‚’å‰Šé™¤
          const existingBadge = btn.querySelector('.order-badge');
          if (existingBadge) {
            existingBadge.remove();
          }
          
          // æ³¨æ–‡ãŒã‚ã‚‹å ´åˆã¯ãƒãƒƒã‚¸ã‚’è¿½åŠ 
          if (orderCount > 0) {
            const badge = document.createElement('span');
            badge.className = 'order-badge';
            badge.textContent = orderCount;
            btn.appendChild(badge);
          }
        }
        
        if (selectedTable === tableNum) {
          loadOrders(tableNum);
        }
      });
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠ
    window.selectTable = async function(tableNum) {
      selectedTable = tableNum;
      document.getElementById('selectedTableLabel').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${tableNum}`;
      document.getElementById('orderSection').classList.remove('hidden');
      
      await loadOrders(tableNum);
    };
    
    // æ³¨æ–‡ã‚’èª­ã¿è¾¼ã¿
    async function loadOrders(tableNum) {
      const container = document.getElementById('ordersList');
      container.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      try {
        const q = query(
          window.collection(window.db, 'orders'),
          where('tableNumber', '==', String(tableNum))
        );
        
        const snapshot = await window.getDocs(q);
        
        if (snapshot.empty) {
          container.innerHTML = '<div class="empty-state">ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
          document.getElementById('totalSection').classList.add('hidden');
          return;
        }
        
        container.innerHTML = '';
        currentOrders = [];
        let totalAmount = 0;
        let hasUnpaidOrders = false;
        
        // æ³¨æ–‡ã‚’é…åˆ—ã«å¤‰æ›ã—ã¦ã‚½ãƒ¼ãƒˆ
        const orders = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          orders.push({ id: doc.id, ...data });
        });
        
        // æ³¨æ–‡ç•ªå·ã§ã‚½ãƒ¼ãƒˆï¼ˆå¤ã„é †: 619â†’620â†’621ï¼‰
        orders.sort((a, b) => {
          return a.orderNumber - b.orderNumber;
        });
        
        // å‰Šé™¤ã•ã‚Œã¦ã„ãªã„æ³¨æ–‡ã®ã¿è¡¨ç¤º
        console.log('å…¨æ³¨æ–‡æ•°:', orders.length);
        orders.forEach(order => {
          console.log(`æ³¨æ–‡#${order.orderNumber}: deleted=${order.deleted}, paidAt=${order.paidAt}, cancelledAt=${order.cancelledAt}`);
          
          // deletedãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã‚‹æ³¨æ–‡ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå±¥æ­´ã§ã¯è¡¨ç¤ºï¼‰
          if (order.deleted) {
            console.log(`  â†’ ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå‰Šé™¤æ¸ˆã¿ï¼‰`);
            return;
          }
          
          const card = createOrderCard(order);
          container.appendChild(card);
          
          // æœªæ‰•ã„æ³¨æ–‡ã®ã¿åˆè¨ˆã«å«ã‚ã‚‹
          if (!order.cancelledAt && !order.paidAt) {
            currentOrders.push(order);
            totalAmount += order.totalAmount || 0;
            hasUnpaidOrders = true;
          }
        });
        
        console.log('è¡¨ç¤ºã•ã‚ŒãŸæ³¨æ–‡æ•°:', container.children.length);
        
        // æ³¨æ–‡ãŒ1ã¤ã‚‚è¡¨ç¤ºã•ã‚Œãªã‹ã£ãŸå ´åˆ
        if (container.children.length === 0) {
          container.innerHTML = '<div class="empty-state">ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        }
        
        if (!hasUnpaidOrders) {
          document.getElementById('totalSection').classList.add('hidden');
        } else {
          document.getElementById('totalAmount').textContent = `Â¥${totalAmount.toLocaleString()}`;
          document.getElementById('totalSection').classList.remove('hidden');
          totalAmountToPay = totalAmount;
        }
        
      } catch (e) {
        console.error('æ³¨æ–‡èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', e.message);
        container.innerHTML = '<div class="empty-state">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message + '</div>';
      }
    }
    
    // æ³¨æ–‡ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
    function createOrderCard(order) {
      const card = document.createElement('div');
      card.className = 'order-card';
      
      if (order.completedAt) card.classList.add('completed');
      if (order.cancelledAt) card.classList.add('cancelled');
      
      let timeStr = '--:--';
      try {
        if (order.timestamp && order.timestamp.toDate) {
          const timestamp = order.timestamp.toDate();
          timeStr = `${timestamp.getHours()}:${String(timestamp.getMinutes()).padStart(2, '0')}`;
        }
      } catch (e) {
        console.error('Timestampå¤‰æ›ã‚¨ãƒ©ãƒ¼:', e);
      }
      
      // è¤‡æ•°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
      let statusBadges = [];
      if (order.paidAt) {
        statusBadges.push('<span class="order-status" style="background: #2196F3; color: white;">ä¼šè¨ˆæ¸ˆ</span>');
      }
      if (order.completedAt) {
        statusBadges.push('<span class="order-status completed">æä¾›æ¸ˆã¿</span>');
      }
      if (order.cancelledAt) {
        statusBadges.push('<span class="order-status cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>');
      }
      if (statusBadges.length === 0) {
        statusBadges.push('<span class="order-status pending">èª¿ç†ä¸­</span>');
      }
      const statusHtml = statusBadges.join(' ');
      
      let itemsHtml = '';
      if (order.items && Array.isArray(order.items) && order.items.length > 0) {
        order.items.forEach(item => {
          const itemBasePrice = item.price;
          const itemWithTopping = itemBasePrice + (item.toppingPrice || 0);
          const itemTotal = itemWithTopping * item.quantity;
          
          // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’æ”¹è¡Œã§è¡¨ç¤º
          let toppingsHtml = '';
          if (item.toppings && item.toppings !== 'ãªã—') {
            const toppingList = item.toppings.split(', ');
            toppingsHtml = toppingList.map(t => `<div style="font-size: 12px; color: #666; padding-left: 10px;">ã€€${t}</div>`).join('');
          }
          
          itemsHtml += `
            <div class="order-item-detailed">
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <div style="font-weight: bold;">${item.name} Ã—${item.quantity}</div>
                <div>Â¥${itemBasePrice.toLocaleString()}</div>
              </div>
              ${toppingsHtml}
              <div style="display: flex; justify-content: flex-end; margin-top: 5px; padding-top: 5px; border-top: 1px dashed #ddd;">
                <div style="font-weight: bold; color: #667eea;">Â¥${itemWithTopping.toLocaleString()} Ã— ${item.quantity} = Â¥${itemTotal.toLocaleString()}</div>
              </div>
            </div>
          `;
        });
      } else {
        // itemsãŒãªã„å ´åˆã¯è­¦å‘Šè¡¨ç¤º
        itemsHtml = `
          <div style="padding: 10px; background: #fff3cd; border-radius: 8px; color: #856404;">
            âš ï¸ å•†å“è©³ç´°ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br>
            åˆè¨ˆé‡‘é¡: Â¥${(order.totalAmount || 0).toLocaleString()}
          </div>
        `;
      }
      
      // ãƒ¬ã‚¸è¢‹æƒ…å ±ã‚’è¿½åŠ 
      if (order.bagNeeded && order.bagQuantity > 0) {
        const bagTotal = order.bagPrice || (order.bagQuantity * 3);
        itemsHtml += `
          <div class="order-item-detailed" style="background: #fff3e0;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <div style="font-weight: bold;">ğŸ›ï¸ ãƒ¬ã‚¸è¢‹ Ã—${order.bagQuantity}</div>
              <div>Â¥3</div>
            </div>
            <div style="display: flex; justify-content: flex-end; margin-top: 5px; padding-top: 5px; border-top: 1px dashed #ddd;">
              <div style="font-weight: bold; color: #667eea;">Â¥3 Ã— ${order.bagQuantity} = Â¥${bagTotal.toLocaleString()}</div>
            </div>
          </div>
        `;
      }
      
      card.innerHTML = `
        <div class="order-header">
          <div>
            <span class="order-number">#${order.orderNumber || '---'}</span>
            ${statusHtml}
          </div>
          <div class="order-time">${timeStr}</div>
        </div>
        <div class="order-items">
          ${itemsHtml}
        </div>
        <div class="order-total">
          <span class="total-label">åˆè¨ˆ:</span>
          <span class="total-amount">Â¥${(order.totalAmount || 0).toLocaleString()}</span>
        </div>
        <div class="order-actions">
          ${!order.paidAt && !order.cancelledAt ? `<button class="order-action-btn pay-btn" onclick="payOrderIndividual('${order.id}', ${order.totalAmount || 0})">ä¼šè¨ˆ</button>` : ''}
          <button class="order-action-btn complete-btn" onclick="completeOrder('${order.id}')">å®Œäº†</button>
          <button class="order-action-btn cancel-btn" onclick="cancelOrder('${order.id}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          ${order.completedAt || order.cancelledAt ? `<button class="order-action-btn delete-btn" onclick="deleteOrder('${order.id}')">å‰Šé™¤</button>` : ''}
        </div>
      `;
      
      return card;
    }
    
    // å€‹åˆ¥æ³¨æ–‡ã®ä¼šè¨ˆ
    window.payOrderIndividual = function(orderId, amount) {
      const order = currentOrders.find(o => o.id === orderId);
      if (!order) {
        alert('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // å˜ä¸€æ³¨æ–‡ã‚’é¸æŠã—ã¦ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      currentOrders = [order];
      totalAmountToPay = amount;
      
      // å€¤å¼•ãé‡‘é¡ã‚’åˆæœŸåŒ–
      document.getElementById('discountAmount').value = '0';
      
      // ç¨ç‡é¸æŠãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
      buildTaxRateSelectionList();
      
      // è«‹æ±‚é¡ã‚’è¡¨ç¤º
      updatePaymentTotal();
      
      document.getElementById('paymentModal').classList.remove('hidden');
      selectedPaymentMethod = null;
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('completePaymentBtn').disabled = true;
    };
    
    // æ³¨æ–‡ã‚’å®Œäº†ã«ã™ã‚‹
    window.completeOrder = async function(orderId) {
      try {
        // æ³¨æ–‡ã‚’å®Œäº†ã«ã™ã‚‹
        await window.updateDoc(doc(db, 'orders', orderId), {
          completedAt: window.Timestamp.now()
        });
        
        await loadOrders(selectedTable);
      } catch (e) {
        console.error('å®Œäº†ã‚¨ãƒ©ãƒ¼:', e);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    };
    
    // æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹
    window.cancelOrder = async function(orderId) {
      try {
        await window.updateDoc(doc(db, 'orders', orderId), {
          cancelledAt: window.Timestamp.now()
        });
        await loadOrders(selectedTable);
      } catch (e) {
        console.error('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¨ãƒ©ãƒ¼:', e);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    };
    
    // æ³¨æ–‡ã‚’å‰Šé™¤ã™ã‚‹
    window.deleteOrder = async function(orderId) {
      console.log('å‰Šé™¤é–‹å§‹: orderId =', orderId);
      console.log('selectedTable =', selectedTable);
      
      try {
        // â˜…â˜…â˜… å‰Šé™¤å‰ã«Firestoreã‹ã‚‰æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— â˜…â˜…â˜…
        console.log('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...');
        const orderRef = doc(db, 'orders', orderId);
        const orderSnap = await window.getDoc(orderRef);
        
        if (!orderSnap.exists()) {
          alert('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        const orderData = orderSnap.data();
        console.log('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿:', orderData);
        
        // â˜…â˜…â˜… ä¼šè¨ˆæ¸ˆã¿ã®æ³¨æ–‡ã®ã¿å•†å“ç‚¹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ â˜…â˜…â˜…
        if (orderData.paidAt && !orderData.deleted) {
          console.log('ğŸ“¦ ä¼šè¨ˆæ¸ˆã¿æ³¨æ–‡ã®å•†å“ç‚¹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã¾ã™');
          
          let itemCount = 0;
          let tax8Total = 0;
          let tax10Total = 0;
          
          // å•†å“ç‚¹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          if (orderData.items && Array.isArray(orderData.items) && orderData.items.length > 0) {
            orderData.items.forEach(item => {
              const qty = item.quantity || 0;
              itemCount += qty;
              console.log(`  â†’ ${item.name} x${qty}ç‚¹`);
              
              // å•†å“ã”ã¨ã®é‡‘é¡ã‚’è¨ˆç®—ï¼ˆãƒˆãƒƒãƒ”ãƒ³ã‚°è¾¼ã¿ï¼‰
              const basePrice = item.price || 0;
              const toppingPrice = item.toppingPrice || 0;
              const totalPrice = basePrice + toppingPrice;
              const itemTotal = totalPrice * qty;
              
              // ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã«ã‚ˆã‚‹ç¨ç‡åˆ¤å®š
              const tableNumber = orderData.tableNumber || '';
              const itemName = item.name || '';
              
              // ã€10%ã€‘åº—å†…ãƒ†ãƒ¼ãƒ–ãƒ«: c1, c2, T-M, T-H ã®ã¿
              if (tableNumber.match(/^(c1|c2|T-M|T-H)$/)) {
                tax10Total += itemTotal;
              }
              // ã€10%ã€‘ãƒ¬ã‚¸è¢‹
              else if (itemName.includes('ãƒ¬ã‚¸è¢‹') || itemName.includes('è¢‹')) {
                tax10Total += itemTotal;
              }
              // ã€8%ã€‘å³ä¼šè¨ˆã€ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã€äºˆç´„ãªã©
              else {
                tax8Total += itemTotal;
              }
            });
          } else {
            // itemsãŒãªã„å ´åˆã¯1ç‚¹ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ
            itemCount = 1;
            console.log('  â†’ æ³¨æ–‡å…¨ä½“ã‚’1ç‚¹ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ');
          }
          
          // ãƒ¬ã‚¸è¢‹ã‚‚ã‚«ã‚¦ãƒ³ãƒˆ
          if (orderData.bagNeeded && orderData.bagQuantity > 0) {
            itemCount += orderData.bagQuantity;
            const bagTotal = orderData.bagPrice || (orderData.bagQuantity * 3);
            tax10Total += bagTotal;
            console.log(`  â†’ ãƒ¬ã‚¸è¢‹ x${orderData.bagQuantity}ç‚¹ (10%å¯¾è±¡)`);
          }
          
          console.log('ğŸ“¦ å•†å“ç‚¹æ•°:', itemCount);
          console.log('ğŸ’° ç¨ç‡åˆ¥å£²ä¸Š:', { tax8Total, tax10Total });
          
          // æ—¥æ¬¡å£²ä¸Šã‚’æ›´æ–°ï¼ˆå•†å“ç‚¹æ•°ã®ã¿ã€å£²ä¸Šé‡‘é¡ãƒ»ç¨é‡‘ãƒ»å€¤å¼•ããƒ»å®¢æ•°ã¯ä»–ã§è¨˜éŒ²æ¸ˆã¿ï¼‰
          const paymentMethod = orderData.paymentMethod || 'cash';
          
          console.log('ğŸ’¾ å•†å“ç‚¹æ•°ã®ã¿æ›´æ–°ä¸­...');
          console.log('  - itemCount:', itemCount);
          await updateDailySales(0, paymentMethod, itemCount, 0, 0, 0, 0);
          console.log('âœ… å•†å“ç‚¹æ•°æ›´æ–°å®Œäº†');
        } else {
          console.log('âš ï¸ æœªä¼šè¨ˆã¾ãŸã¯æ—¢ã«å‰Šé™¤æ¸ˆã¿ã®æ³¨æ–‡ã®ãŸã‚ã‚«ã‚¦ãƒ³ãƒˆã—ã¾ã›ã‚“');
        }
        
        // deleteDocã§ã¯ãªãdeletedãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
        console.log('updateDocå®Ÿè¡Œä¸­...');
        await window.updateDoc(orderRef, {
          deleted: true,
          deletedAt: window.Timestamp.now()
        });
        console.log('updateDocæˆåŠŸ');
        console.log('loadOrderså®Ÿè¡Œä¸­...');
        await loadOrders(selectedTable);
        console.log('loadOrderså®Œäº†');
      } catch (e) {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e);
        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', e.message, e.code);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // æ”¯æ‰•ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showPaymentModal = function() {
      if (currentOrders.length === 0) {
        alert('ä¼šè¨ˆã™ã‚‹æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // å€¤å¼•ãé‡‘é¡ã‚’åˆæœŸåŒ–
      document.getElementById('discountAmount').value = '0';
      
      // ç¨ç‡é¸æŠãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
      buildTaxRateSelectionList();
      
      // è«‹æ±‚é¡ã‚’è¡¨ç¤º
      updatePaymentTotal();
      
      document.getElementById('paymentModal').classList.remove('hidden');
      selectedPaymentMethod = null;
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('completePaymentBtn').disabled = true;
    };
    
    // ç¨ç‡é¸æŠãƒªã‚¹ãƒˆã‚’æ§‹ç¯‰
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã«åŸºã¥ã„ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡ã‚’æ±ºå®š
    function determineDefaultTaxRate(tableNumber) {
      // å³ä¼šè¨ˆã€ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã€äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ«: 8%
      if (tableNumber === 'å³ä¼šè¨ˆ' || tableNumber === 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ' || tableNumber === 'äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ«') {
        return 8;
      }
      // c1, c2, T-M, T-H: 10%
      if (tableNumber === 'c1' || tableNumber === 'c2' || tableNumber === 'T-M' || tableNumber === 'T-H') {
        return 10;
      }
      // ãã‚Œä»¥å¤–ã®ãƒ†ãƒ¼ãƒ–ãƒ«: 10%ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
      return 10;
    }
    
    function buildTaxRateSelectionList() {
      const container = document.getElementById('taxRateItemsList');
      container.innerHTML = '';
      
      console.log('ğŸ”µ buildTaxRateSelectionListé–‹å§‹');
      console.log('currentOrders:', currentOrders);
      console.log('currentOrders.length:', currentOrders.length);
      
      if (!container) {
        console.error('âŒ taxRateItemsListã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      if (currentOrders.length === 0) {
        console.warn('âŒ currentOrdersãŒç©ºã§ã™');
        container.innerHTML = '<div style="padding: 15px; text-align: center; color: #666;">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      let itemIndex = 0;
      
      currentOrders.forEach((order, orderIdx) => {
        console.log(`ğŸ“¦ æ³¨æ–‡${orderIdx}:`, order);
        if (!order.items || !Array.isArray(order.items) || order.items.length === 0) {
          // itemsãŒãªã„å ´åˆã¯æ³¨æ–‡å…¨ä½“ã¨ã—ã¦è¡¨ç¤º
          const orderTotal = order.totalAmount || 0;
          console.log(`  æ³¨æ–‡å…¨ä½“ã¨ã—ã¦è¿½åŠ : #${order.orderNumber}, é‡‘é¡:${orderTotal}`);
          
          // ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã«åŸºã¥ã„ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡ã‚’æ±ºå®š
          const defaultTaxRate = determineDefaultTaxRate(order.tableNumber);
          addTaxRateItem(container, `æ³¨æ–‡ #${order.orderNumber}`, 1, orderTotal, itemIndex, defaultTaxRate);
          itemIndex++;
        } else {
          // å„å•†å“ã‚’è¡¨ç¤º
          order.items.forEach((item, itemIdx) => {
            const itemTotal = (item.price + (item.toppingPrice || 0)) * (item.quantity || 1);
            console.log(`  å•†å“è¿½åŠ : ${item.name} x${item.quantity}, é‡‘é¡:${itemTotal}`);
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã«åŸºã¥ã„ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡ã‚’æ±ºå®š
            const defaultTaxRate = determineDefaultTaxRate(order.tableNumber);
            addTaxRateItem(container, item.name, item.quantity, itemTotal, itemIndex, defaultTaxRate);
            itemIndex++;
          });
          
          // ãƒ¬ã‚¸è¢‹ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯10%ï¼‰
          if (order.bagNeeded && order.bagQuantity > 0) {
            const bagTotal = order.bagPrice || (order.bagQuantity * 3);
            console.log(`  ãƒ¬ã‚¸è¢‹è¿½åŠ : ${order.bagQuantity}æš, é‡‘é¡:${bagTotal}`);
            addTaxRateItem(container, 'ğŸ›ï¸ ãƒ¬ã‚¸è¢‹', order.bagQuantity, bagTotal, itemIndex, 10);
            itemIndex++;
          }
        }
      });
      
      console.log(`âœ… ç¨ç‡é¸æŠé …ç›®ã‚’${itemIndex}å€‹ç”Ÿæˆã—ã¾ã—ãŸ`);
      calculateTaxSummary();
    }
    
    // ç¨ç‡é¸æŠé …ç›®ã‚’è¿½åŠ 
    function addTaxRateItem(container, itemName, quantity, itemTotal, index, defaultTaxRate = 10) {
      console.log(`  addTaxRateItem: ${itemName}, æ•°é‡:${quantity}, é‡‘é¡:${itemTotal}, index:${index}, ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡:${defaultTaxRate}%`);
      
      const itemDiv = document.createElement('div');
      itemDiv.style.cssText = 'padding: 10px; margin-bottom: 8px; background: white; border-radius: 6px; border: 1px solid #ddd;';
      
      const headerDiv = document.createElement('div');
      headerDiv.style.cssText = 'display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; font-size: 14px; cursor: pointer;';
      headerDiv.innerHTML = `
        <span>${itemName} Ã—${quantity}</span>
        <span style="color: #667eea;" id="itemPrice${index}">Â¥${itemTotal.toLocaleString()}</span>
      `;
      
      // å•†å“è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã§é‡‘é¡ç·¨é›†
      headerDiv.onclick = function() {
        const newPrice = prompt(`${itemName} Ã—${quantity} ã®é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nï¼ˆç¾åœ¨: Â¥${itemTotal.toLocaleString()}ï¼‰`, itemTotal);
        
        if (newPrice === null) return; // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        
        const numPrice = parseInt(newPrice);
        if (isNaN(numPrice) || numPrice < 0) {
          alert('æ­£ã—ã„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
          return;
        }
        
        // é‡‘é¡è¡¨ç¤ºã‚’æ›´æ–°
        document.getElementById(`itemPrice${index}`).textContent = `Â¥${numPrice.toLocaleString()}`;
        
        // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®data-amountã‚’æ›´æ–°
        document.querySelectorAll(`input[name="taxRate${index}"]`).forEach(radio => {
          radio.dataset.amount = numPrice;
        });
        
        // ç¨ç‡åˆ¥é›†è¨ˆã¨è«‹æ±‚é¡ã‚’å†è¨ˆç®—
        calculateTaxSummary();
        
        console.log(`âœ… å•†å“${index}ã®é‡‘é¡ã‚’${itemTotal}å††ã‹ã‚‰${numPrice}å††ã«å¤‰æ›´`);
      };
      
      itemDiv.appendChild(headerDiv);
      
      const radioDiv = document.createElement('div');
      radioDiv.style.cssText = 'display: flex; gap: 10px; justify-content: center;';
      
      // 8%ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³
      const label8 = document.createElement('label');
      label8.style.cssText = 'flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 6px 10px; border-radius: 4px; background: #fff3e0; border: 2px solid #FF9800; font-size: 13px;';
      const radio8 = document.createElement('input');
      radio8.type = 'radio';
      radio8.name = `taxRate${index}`;
      radio8.value = '8';
      radio8.checked = (defaultTaxRate === 8);
      radio8.dataset.amount = itemTotal;
      radio8.dataset.index = index;
      radio8.style.cssText = 'margin-right: 5px; width: 18px; height: 18px;';
      radio8.onchange = calculateTaxSummary;
      label8.appendChild(radio8);
      label8.appendChild(document.createTextNode('8%æŒã¡å¸°ã‚Š'));
      
      // 10%ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³
      const label10 = document.createElement('label');
      label10.style.cssText = 'flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 6px 10px; border-radius: 4px; background: #e3f2fd; border: 2px solid #2196F3; font-size: 13px;';
      const radio10 = document.createElement('input');
      radio10.type = 'radio';
      radio10.name = `taxRate${index}`;
      radio10.value = '10';
      radio10.checked = (defaultTaxRate === 10);
      radio10.dataset.amount = itemTotal;
      radio10.dataset.index = index;
      radio10.style.cssText = 'margin-right: 5px; width: 18px; height: 18px;';
      radio10.onchange = calculateTaxSummary;
      label10.appendChild(radio10);
      label10.appendChild(document.createTextNode('10%åº—å†…'));
      
      console.log(`    ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ç”Ÿæˆ: taxRate${index}, 8%=${radio8.checked}, 10%=${radio10.checked}`);
      
      radioDiv.appendChild(label8);
      radioDiv.appendChild(label10);
      itemDiv.appendChild(radioDiv);
      
      container.appendChild(itemDiv);
    }
    
    // ç¨ç‡åˆ¥é›†è¨ˆã‚’è¨ˆç®—
    function calculateTaxSummary() {
      let tax8Total = 0;
      let tax10Total = 0;
      
      const radios = document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked');
      radios.forEach(radio => {
        const amount = parseFloat(radio.dataset.amount) || 0;
        if (radio.value === '8') {
          tax8Total += amount;
        } else if (radio.value === '10') {
          tax10Total += amount;
        }
      });
      
      document.getElementById('tax8Summary').textContent = 'Â¥' + tax8Total.toLocaleString();
      document.getElementById('tax10Summary').textContent = 'Â¥' + tax10Total.toLocaleString();
      
      // è«‹æ±‚é¡ã‚‚æ›´æ–°
      updatePaymentTotal();
    }
    
    // å€¤å¼•ãå¾Œã®è«‹æ±‚é¡ã‚’æ›´æ–°
    window.updatePaymentTotal = function() {
      // ç·¨é›†ã•ã‚ŒãŸé‡‘é¡ã‚’å…¨ã¦åˆè¨ˆï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®data-amountã‹ã‚‰å–å¾—ï¼‰
      let total = 0;
      const radios = document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked');
      radios.forEach(radio => {
        total += parseFloat(radio.dataset.amount) || 0;
      });
      
      const discount = parseInt(document.getElementById('discountAmount').value) || 0;
      const finalAmount = Math.max(0, total - discount);
      totalAmountToPay = finalAmount;
      
      document.getElementById('finalPaymentAmount').textContent = 'Â¥' + finalAmount.toLocaleString();
      
      // ç¾é‡‘ã®å ´åˆã¯ãŠã¤ã‚Šè¨ˆç®—ã‚‚æ›´æ–°
      if (selectedPaymentMethod === 'cash') {
        calculateChange();
      }
    };
    
    // æ”¯æ‰•ã„æ–¹æ³•é¸æŠ
    window.selectPaymentMethod = function(method) {
      selectedPaymentMethod = method;
      
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');
      
      if (method === 'cash') {
        document.getElementById('cashInputSection').classList.remove('hidden');
        document.getElementById('completePaymentBtn').disabled = true;
      } else {
        document.getElementById('cashInputSection').classList.add('hidden');
        document.getElementById('completePaymentBtn').disabled = false;
      }
    };
    
    // ãŠã¤ã‚Šè¨ˆç®—
    window.calculateChange = function() {
      cashReceived = parseInt(document.getElementById('cashReceived').value) || 0;
      
      // å€¤å¼•ãå¾Œã®é‡‘é¡ã‚’ä½¿ç”¨
      changeAmount = cashReceived - totalAmountToPay;
      
      document.getElementById('changeAmount').textContent = `Â¥${changeAmount.toLocaleString()}`;
      
      document.getElementById('completePaymentBtn').disabled = cashReceived < totalAmountToPay;
    };
    
    // ä¼šè¨ˆå®Œäº†
    window.completePayment = async function() {
      console.log('ğŸŸ¢ completePaymenté–‹å§‹');
      
      if (!selectedPaymentMethod) {
        alert('æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      if (selectedPaymentMethod === 'cash' && cashReceived < totalAmountToPay) {
        alert('ãŠé ã‹ã‚Šé‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
        return;
      }
      
      console.log('âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é€šéã€‚ç¨ç‡èª­ã¿å–ã‚Šé–‹å§‹');
      
      // æ‹…å½“è€…ã‚’å–å¾—ï¼ˆæœªé¸æŠã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
      const staffSelect = document.getElementById('staffSelect');
      const staffName = staffSelect.value || 'é«˜ç”°';
      
      try {
        const now = window.Timestamp.now();
        
        // æ³¨æ–‡ç•ªå·ãƒªã‚¹ãƒˆã‚’å–å¾—
        const orderNumbers = currentOrders.map(o => o.orderNumber);
        
        // å…¨ã¦ã®æ³¨æ–‡ã«æ”¯æ‰•ã„æ¸ˆã¿ãƒ•ãƒ©ã‚°ã¨æ‹…å½“è€…ã‚’è¨­å®š
        for (const order of currentOrders) {
          await window.updateDoc(doc(db, 'orders', order.id), {
            paidAt: now,
            notifiedPaid: true,
            paymentMethod: selectedPaymentMethod,
            staffName: staffName  // æ‹…å½“è€…åã‚’è¿½åŠ 
          });
        }
        
        // å•†å“ç‚¹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ & é¸æŠã•ã‚ŒãŸç¨ç‡ã§é›†è¨ˆ
        let itemCount = 0;
        let tax8Total = 0;
        let tax10Total = 0;
        
        // é¸æŠã•ã‚ŒãŸç¨ç‡ã‹ã‚‰é›†è¨ˆ
        const radios = document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked');
        console.log('ğŸ“» é¸æŠã•ã‚ŒãŸãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³æ•°:', radios.length);
        
        radios.forEach((radio, idx) => {
          const amount = parseFloat(radio.dataset.amount) || 0;
          const taxRate = radio.value;
          console.log(`ğŸ“» ãƒ©ã‚¸ã‚ª${idx}: ç¨ç‡=${taxRate}%, é‡‘é¡=${amount}`);
          
          if (taxRate === '8') {
            tax8Total += amount;
          } else if (taxRate === '10') {
            tax10Total += amount;
          }
        });
        
        console.log('ğŸ’° ç¨ç‡åˆ¥é›†è¨ˆçµæœ:', { tax8Total, tax10Total });
        
        // å•†å“ç‚¹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆãƒ¬ã‚¸è¢‹å«ã‚€ï¼‰
        currentOrders.forEach(order => {
          if (!order.items || !Array.isArray(order.items) || order.items.length === 0) {
            itemCount += 1;
          } else {
            order.items.forEach(item => {
              itemCount += item.quantity || 0;
            });
          }
          
          // ãƒ¬ã‚¸è¢‹ã‚‚ã‚«ã‚¦ãƒ³ãƒˆ
          if (order.bagNeeded && order.bagQuantity > 0) {
            itemCount += order.bagQuantity;
            console.log(`  ãƒ¬ã‚¸è¢‹ã‚’å•†å“ç‚¹æ•°ã«è¿½åŠ : ${order.bagQuantity}æš`);
          }
        });
        
        console.log('ğŸ“¦ ä¼šè¨ˆå•†å“ç‚¹æ•°:', itemCount);
        console.log('ğŸ’° ç¨ç‡åˆ¥å£²ä¸Š:', { tax8Total, tax10Total });
        
        // ãƒ‡ãƒãƒƒã‚°: å•†å“ç‚¹æ•°ãŒ0ã®å ´åˆã¯è­¦å‘Š
        if (itemCount === 0) {
          alert('è­¦å‘Š: å•†å“ç‚¹æ•°ãŒ0ã§ã™ï¼\ncurrentOrders: ' + currentOrders.length + 'ä»¶');
          console.error('currentOrders:', currentOrders);
        } else {
          console.log('âœ… å•†å“ç‚¹æ•°ã‚«ã‚¦ãƒ³ãƒˆæˆåŠŸ:', itemCount + 'ç‚¹');
        }
        
        // å…ƒã®åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—ï¼ˆå€¤å¼•ãå‰ï¼‰
        let originalTotal = 0;
        currentOrders.forEach(order => {
          originalTotal += order.totalAmount || 0;
        });
        
        // å€¤å¼•ãé‡‘é¡ã‚’å–å¾—
        const discountAmount = parseInt(document.getElementById('discountAmount').value) || 0;
        console.log('ğŸ’¸ å…ƒã®é‡‘é¡:', originalTotal);
        console.log('ğŸ’¸ å€¤å¼•ãé‡‘é¡:', discountAmount);
        console.log('ğŸ’¸ å€¤å¼•ãå¾Œé‡‘é¡:', totalAmountToPay);
        
        console.log('ğŸ“Š å£²ä¸Šé‡‘é¡ãƒ»å®¢æ•°ã¯ä¼šè¨ˆæ™‚ã€å•†å“ç‚¹æ•°ã¯å‰Šé™¤æ™‚ã«ã‚«ã‚¦ãƒ³ãƒˆã—ã¾ã™');
        console.log('  - totalAmount:', totalAmountToPay);
        console.log('  - paymentMethod:', selectedPaymentMethod);
        console.log('  - itemCount: 0ï¼ˆå‰Šé™¤æ™‚ã«ã‚«ã‚¦ãƒ³ãƒˆï¼‰');
        console.log('  - customerCountIncrement: 1ï¼ˆä¼šè¨ˆæ™‚ã«ã‚«ã‚¦ãƒ³ãƒˆï¼‰');
        console.log('  - tax8Total:', tax8Total);
        console.log('  - tax10Total:', tax10Total);
        console.log('  - discountAmount:', discountAmount);
        
        // å•†å“ãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆitemCountsä¿å­˜ç”¨ï¼‰
        const allItems = [];
        currentOrders.forEach(order => {
          if (order.items && Array.isArray(order.items)) {
            order.items.forEach(item => {
              allItems.push({
                name: item.name,
                quantity: item.quantity || 1
              });
            });
          }
          // ãƒ¬ã‚¸è¢‹ã‚‚å•†å“ã¨ã—ã¦è¿½åŠ 
          if (order.bagNeeded && order.bagQuantity > 0) {
            allItems.push({
              name: 'ãƒ¬ã‚¸è¢‹',
              quantity: order.bagQuantity
            });
          }
        });
        
        console.log('ğŸ›’ å•†å“ãƒªã‚¹ãƒˆï¼ˆitemCountsç”¨ï¼‰:', allItems);
        
        // â˜… å£²ä¸Šé‡‘é¡ãƒ»å®¢æ•°ãƒ»å€¤å¼•ãã‚’è¨˜éŒ²ï¼ˆå•†å“ç‚¹æ•°ã¯å‰Šé™¤æ™‚ã«ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ãŸã‚0ï¼‰ â˜…
        await updateDailySales(totalAmountToPay, selectedPaymentMethod, 0, tax8Total, tax10Total, discountAmount, 1, allItems);
        
        // å•†å“ãƒªã‚¹ãƒˆã‚’ç¨ç‡æƒ…å ±ä»˜ãã§ä½œæˆ
        const itemsWithTaxRate = [];
        let itemIndex = 0;
        
        currentOrders.forEach(order => {
          if (!order.items || !Array.isArray(order.items) || order.items.length === 0) {
            // itemsãŒãªã„å ´åˆ
            const radio = document.querySelector(`input[name="taxRate${itemIndex}"]:checked`);
            const taxRate = radio ? parseInt(radio.value) : 10;
            const editedPrice = radio ? parseFloat(radio.dataset.amount) : (order.totalAmount || 0);
            itemsWithTaxRate.push({
              name: `æ³¨æ–‡ #${order.orderNumber}`,
              quantity: 1,
              price: editedPrice,
              toppings: 'ãªã—',
              taxRate: taxRate
            });
            itemIndex++;
          } else {
            // å„å•†å“ã‚’è¿½åŠ 
            order.items.forEach(item => {
              const radio = document.querySelector(`input[name="taxRate${itemIndex}"]:checked`);
              const taxRate = radio ? parseInt(radio.value) : 10;
              const editedPrice = radio ? parseFloat(radio.dataset.amount) : ((item.price + (item.toppingPrice || 0)) * item.quantity);
              itemsWithTaxRate.push({
                name: item.name,
                quantity: item.quantity,
                price: editedPrice / item.quantity, // å˜ä¾¡ã«æˆ»ã™
                toppings: item.toppings || 'ãªã—',
                taxRate: taxRate
              });
              itemIndex++;
            });
            
            // ãƒ¬ã‚¸è¢‹ã‚’è¿½åŠ 
            if (order.bagNeeded && order.bagQuantity > 0) {
              const radio = document.querySelector(`input[name="taxRate${itemIndex}"]:checked`);
              const taxRate = radio ? parseInt(radio.value) : 10;
              const editedPrice = radio ? parseFloat(radio.dataset.amount) : (order.bagQuantity * 3);
              itemsWithTaxRate.push({
                name: 'ğŸ›ï¸ ãƒ¬ã‚¸è¢‹',
                quantity: order.bagQuantity,
                price: editedPrice / order.bagQuantity, // å˜ä¾¡ã«æˆ»ã™
                toppings: 'ãªã—',
                taxRate: taxRate
              });
              itemIndex++;
            }
          }
        });
        
        // æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·ç”¨ï¼‰
        lastPaymentData = {
          tableNumber: selectedTable,
          orderNumbers: orderNumbers,
          items: itemsWithTaxRate,
          totalAmount: totalAmountToPay,
          discountAmount: discountAmount,
          paymentMethod: selectedPaymentMethod,
          cashReceived: selectedPaymentMethod === 'cash' ? cashReceived : totalAmountToPay,
          change: selectedPaymentMethod === 'cash' ? changeAmount : 0,
          timestamp: new Date(),
          staffName: staffName  // æ‹…å½“è€…åã‚’è¿½åŠ 
        };
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closePaymentModal();
        
        // è‡ªå‹•å°åˆ·ãŒæœ‰åŠ¹ãªã‚‰å°åˆ·
        if (autoPrintEnabled) {
          await printReceipt();
        } else {
          // ãƒ¬ã‚·ãƒ¼ãƒˆå®Œäº†ç”»é¢ã‚’è¡¨ç¤º
          document.getElementById('receiptCompleteModal').classList.remove('hidden');
        }
        
        // è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
        await loadOrders(selectedTable);
        
      } catch (e) {
        console.error('ä¼šè¨ˆã‚¨ãƒ©ãƒ¼:', e);
        alert('ä¼šè¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // æ”¯æ‰•ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
      document.getElementById('cashReceived').value = '';
      calculateChange();
    };
    
    // ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·ï¼ˆ58mmå¹…å¯¾å¿œï¼‰
    window.printReceipt = async function() {
      if (!lastPaymentData) {
        alert('å°åˆ·ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        // 58mmå¹…è¨­å®š
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        // ãƒ¬ã‚·ãƒ¼ãƒˆä½œæˆ
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: 'ç²‰ã‚‚ã‚“å±‹ å…«\n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createTextElement({data: 'ä¸‹èµ¤å¡šåº—\n'});
        builder.createTextElement({data: 'æ±äº¬éƒ½æ¿æ©‹åŒºèµ¤å¡šæ–°ç”º\n'});
        builder.createTextElement({data: 'TEL: 03-XXXX-XXXX\n'});
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createAlignmentElement({position: 'left'});
        const now = lastPaymentData.timestamp;
        const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        builder.createTextElement({data: `æ—¥æ™‚: ${dateStr}\n`});
        builder.createTextElement({data: `æ‹…å½“: ${lastPaymentData.staffName || 'ãƒ¬ã‚¸ä¿‚'}\n`});
        builder.createTextElement({data: `ãƒ†ãƒ¼ãƒ–ãƒ«: ${lastPaymentData.tableNumber}\n`});
        builder.createTextElement({data: `æ³¨æ–‡No: ${lastPaymentData.orderNumbers.join(',')}\n`});
        builder.createRuledLineElement({thickness: 'thin'});
        
        // å•†å“æ˜ç´°
        let itemCount = 0;
        let tax8Total = 0;
        let tax10Total = 0;
        
        lastPaymentData.items.forEach(item => {
          const subtotal = item.price * item.quantity;
          itemCount += item.quantity;
          
          // ç¨ç‡åˆ¥é›†è¨ˆ
          if (item.taxRate === 8) {
            tax8Total += subtotal;
          } else {
            tax10Total += subtotal;
          }
          
          // å•†å“åã‚’32æ–‡å­—ä»¥å†…ã«èª¿æ•´
          const itemName = item.name.length > 16 ? item.name.substring(0, 15) + 'â€¦' : item.name;
          builder.createTextElement({data: `${itemName}\n`});
          
          // å˜ä¾¡Ã—æ•°é‡ï¼å°è¨ˆã®å½¢å¼ï¼ˆ58mmå¹…ã«æœ€é©åŒ–ï¼‰
          const priceInfo = `@${item.price} x${item.quantity}`;
          const subtotalStr = `${subtotal.toLocaleString()}å††`;
          const spaces = ' '.repeat(Math.max(1, 32 - priceInfo.length - subtotalStr.length));
          builder.createTextElement({data: `${priceInfo}${spaces}${subtotalStr}\n`});
          
          if (item.toppings && item.toppings !== 'ãªã—') {
            builder.createTextElement({data: ` TP:${item.toppings}\n`});
          }
        });
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createTextElement({data: `å°è¨ˆ${' '.repeat(20)}${lastPaymentData.totalAmount.toLocaleString()}å††\n`});
        builder.createTextElement({data: `ç‚¹æ•°: ${itemCount}ç‚¹\n`});
        builder.createRuledLineElement({thickness: 'thin'});
        
        // ç¨é¡è¨ˆç®—
        const tax8Amount = Math.floor(tax8Total * 8 / 108);
        const tax10Amount = Math.floor(tax10Total * 10 / 110);
        
        if (tax8Total > 0) {
          builder.createTextElement({data: `8%å¯¾è±¡${' '.repeat(16)}${tax8Total.toLocaleString()}å††\n`});
          builder.createTextElement({data: `(å†…æ¶ˆè²»ç¨${' '.repeat(15)}${tax8Amount.toLocaleString()}å††)\n`});
        }
        if (tax10Total > 0) {
          builder.createTextElement({data: `10%å¯¾è±¡${' '.repeat(15)}${tax10Total.toLocaleString()}å††\n`});
          builder.createTextElement({data: `(å†…æ¶ˆè²»ç¨${' '.repeat(15)}${tax10Amount.toLocaleString()}å††)\n`});
        }
        
        builder.createRuledLineElement({thickness: 'medium'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `åˆè¨ˆ ${lastPaymentData.totalAmount.toLocaleString()}å††\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createRuledLineElement({thickness: 'medium'});
        
        // æ”¯æ‰•ã„æƒ…å ±
        let paymentMethodStr = '';
        if (lastPaymentData.paymentMethod === 'cash') {
          paymentMethodStr = 'ç¾é‡‘';
          builder.createTextElement({data: `ãŠé ã‚Š${' '.repeat(18)}${lastPaymentData.cashReceived.toLocaleString()}å††\n`});
          builder.createTextElement({data: `ãŠã¤ã‚Š${' '.repeat(18)}${lastPaymentData.change.toLocaleString()}å††\n`});
        } else if (lastPaymentData.paymentMethod === 'emoney') {
          paymentMethodStr = 'é›»å­ãƒãƒãƒ¼';
        } else if (lastPaymentData.paymentMethod === 'credit') {
          paymentMethodStr = 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰';
        }
        builder.createTextElement({data: `æ”¯æ‰•: ${paymentMethodStr}\n`});
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({data: '\nã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ\n'});
        builder.createTextElement({data: 'ã¾ãŸã®ã”æ¥åº—ã‚’\n'});
        builder.createTextElement({data: 'ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™\n\n\n'});
        
        builder.createCutPaperElement({feed: true});
        
        const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
        
        const trader = new StarWebPrintTrader({url: url});
        trader.onReceive = function(response) {
          console.log('å°åˆ·æˆåŠŸ:', response);
          closeReceiptModal();
        };
        trader.onError = function(response) {
          console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', response);
          alert('å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.status);
        };
        
        trader.sendMessage({request: request});
        
      } catch (e) {
        console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        alert('å°åˆ·å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // é ˜åæ›¸å°åˆ·ï¼ˆå°é‘‘æ¬„ä»˜ããƒ»58mmå¹…å¯¾å¿œï¼‰
    window.printInvoice = async function() {
      if (!lastPaymentData) {
        alert('å°åˆ·ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        // 58mmå¹…è¨­å®š
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: 'é ˜ å æ›¸\n\n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        builder.createAlignmentElement({position: 'left'});
        const now = lastPaymentData.timestamp;
        const dateStr = `${now.getFullYear()}å¹´${String(now.getMonth()+1).padStart(2,'0')}æœˆ${String(now.getDate()).padStart(2,'0')}æ—¥`;
        builder.createTextElement({data: `${dateStr}\n\n`});
        
        builder.createTextElement({data: 'ãŠå®¢æ§˜\n\n'});
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `Â¥${lastPaymentData.totalAmount.toLocaleString()}-\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createAlignmentElement({position: 'left'});
        builder.createTextElement({data: '\nä¸Šè¨˜æ­£ã«é ˜åã„ãŸã—ã¾ã—ãŸ\n\n'});
        builder.createTextElement({data: 'ä½†ã— é£²é£Ÿä»£ã¨ã—ã¦\n\n\n'});
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createAlignmentElement({position: 'right'});
        builder.createTextElement({data: 'ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—\n'});
        builder.createTextElement({data: 'æ±äº¬éƒ½æ¿æ©‹åŒºèµ¤å¡šæ–°ç”º\n'});
        builder.createTextElement({data: 'TEL: 03-XXXX-XXXX\n\n'});
        
        // å°é‘‘æ¬„ã‚’ä½œæˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆã§â—¯ã‚’æç”»ï¼‰
        builder.createAlignmentElement({position: 'right'});
        builder.createTextElement({data: '        â—¯â—¯â—¯\n'});
        builder.createTextElement({data: '       â—¯   â—¯\n'});
        builder.createTextElement({data: '      â—¯  å° â—¯\n'});
        builder.createTextElement({data: '       â—¯   â—¯\n'});
        builder.createTextElement({data: '        â—¯â—¯â—¯\n\n'});
        
        builder.createAlignmentElement({position: 'left'});
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createTextElement({data: `\nãƒ†ãƒ¼ãƒ–ãƒ«: ${lastPaymentData.tableNumber}\n`});
        builder.createTextElement({data: `æ³¨æ–‡No: ${lastPaymentData.orderNumbers.join(',')}\n`});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({data: '\n\n'});
        
        builder.createCutPaperElement({feed: true});
        
        const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
        
        const trader = new StarWebPrintTrader({url: url});
        trader.onReceive = function(response) {
          console.log('å°åˆ·æˆåŠŸ:', response);
          closeReceiptModal();
        };
        trader.onError = function(response) {
          console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', response);
          alert('å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.status);
        };
        
        trader.sendMessage({request: request});
        
      } catch (e) {
        console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        alert('å°åˆ·å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ãƒ¬ã‚·ãƒ¼ãƒˆå®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeReceiptModal = function() {
      document.getElementById('receiptCompleteModal').classList.add('hidden');
      clearSelection();
    };
    
    // é¸æŠã‚’ã‚¯ãƒªã‚¢
    window.clearSelection = function() {
      selectedTable = null;
      currentOrders = [];
      document.getElementById('orderSection').classList.add('hidden');
    };
    
    // æ—¥æ¬¡å£²ä¸Šæ›´æ–°é–¢æ•°
    window.updateDailySales = async function(totalAmount, paymentMethod, itemCount, tax8Total, tax10Total, discountAmount = 0, customerCountIncrement = 0, items = []) {
      try {
        // åˆå‰3æ™‚åŸºæº–ã§æ—¥ä»˜ã‚’æ±ºå®š
        const now = new Date();
        let targetDate = new Date(now);
        
        // åˆå‰3æ™‚ã‚ˆã‚Šå‰ãªã‚‰æ˜¨æ—¥æ‰±ã„
        if (now.getHours() < 3) {
          targetDate.setDate(targetDate.getDate() - 1);
        }
        
        const dateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth()+1).padStart(2,'0')}-${String(targetDate.getDate()).padStart(2,'0')}`;
        
        console.log('ğŸ“Š æ—¥æ¬¡å£²ä¸Šæ›´æ–°é–‹å§‹:', { dateStr, totalAmount, paymentMethod, itemCount, tax8Total, tax10Total, discountAmount, customerCountIncrement });
        
        // ãƒ‡ãƒãƒƒã‚°: itemCountãŒ0ã®å ´åˆã¯è­¦å‘Š
        if (itemCount === 0) {
          console.error('âŒ updateDailySalesã«æ¸¡ã•ã‚ŒãŸitemCountãŒ0ã§ã™ï¼');
          alert('ã‚¨ãƒ©ãƒ¼: å•†å“ç‚¹æ•°ãŒ0ã§ä¿å­˜ã•ã‚Œã‚ˆã†ã¨ã—ã¦ã„ã¾ã™ï¼');
        }
        
        const salesRef = doc(db, 'dailySales', dateStr);
        const salesDoc = await getDoc(salesRef);
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          console.log('æ—¢å­˜ãƒ‡ãƒ¼ã‚¿:', data);
          
          // å•†å“åˆ¥ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨ˆç®—
          const currentItemCounts = data.itemCounts || {};
          items.forEach(item => {
            const itemName = item.name;
            currentItemCounts[itemName] = (currentItemCounts[itemName] || 0) + item.quantity;
          });
          
          const updates = {
            totalSales: (data.totalSales || 0) + totalAmount,
            customerCount: (data.customerCount || 0) + customerCountIncrement,
            totalItems: (data.totalItems || 0) + itemCount,
            tax8Total: (data.tax8Total || 0) + tax8Total,
            tax10Total: (data.tax10Total || 0) + tax10Total,
            totalDiscount: (data.totalDiscount || 0) + discountAmount,
            itemCounts: currentItemCounts,
            drawerOpenCount: data.drawerOpenCount || 0,  // ç¾åœ¨ã®å€¤ã‚’ä¿æŒ
            cashSales: (data.cashSales || 0),  // æ—¢å­˜å€¤ã‚’ä¿æŒ
            emoneSales: (data.emoneSales || 0),  // æ—¢å­˜å€¤ã‚’ä¿æŒ
            creditSales: (data.creditSales || 0),  // æ—¢å­˜å€¤ã‚’ä¿æŒ
            updatedAt: Timestamp.now()
          };
          
          console.log('ğŸ’¡ æ›´æ–°å‰ - totalItems:', data.totalItems || 0, 'tax8Total:', data.tax8Total || 0, 'tax10Total:', data.tax10Total || 0, 'totalDiscount:', data.totalDiscount || 0);
          console.log('ğŸ’¡ è¿½åŠ åˆ† - itemCount:', itemCount, 'tax8Total:', tax8Total, 'tax10Total:', tax10Total, 'discountAmount:', discountAmount);
          console.log('ğŸ’¡ æ›´æ–°å¾Œ - totalItems:', updates.totalItems, 'tax8Total:', updates.tax8Total, 'tax10Total:', updates.tax10Total, 'totalDiscount:', updates.totalDiscount);
          
          // æ”¯æ‰•ã„æ–¹æ³•åˆ¥ã®å£²ä¸Šã‚’åŠ ç®—
          if (paymentMethod === 'cash') {
            updates.cashSales += totalAmount;
            // ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³ã‚«ã‚¦ãƒ³ãƒˆã¯æ‰‹å‹•ãƒœã‚¿ãƒ³ã®ã¿
          } else if (paymentMethod === 'emoney') {
            updates.emoneSales += totalAmount;
          } else if (paymentMethod === 'credit') {
            updates.creditSales += totalAmount;
          }
          
          await updateDoc(salesRef, updates);
          console.log('âœ… æ—¢å­˜å£²ä¸Šãƒ‡ãƒ¼ã‚¿æ›´æ–°:', updates);
          
        } else {
          // å•†å“åˆ¥ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨ˆç®—
          const newItemCounts = {};
          items.forEach(item => {
            const itemName = item.name;
            newItemCounts[itemName] = (newItemCounts[itemName] || 0) + item.quantity;
          });
          
          const newData = {
            date: dateStr,
            totalSales: totalAmount,
            customerCount: customerCountIncrement,
            totalItems: itemCount,
            tax8Total: tax8Total,
            tax10Total: tax10Total,
            totalDiscount: discountAmount,
            itemCounts: newItemCounts,
            cashSales: paymentMethod === 'cash' ? totalAmount : 0,
            emoneSales: paymentMethod === 'emoney' ? totalAmount : 0,
            creditSales: paymentMethod === 'credit' ? totalAmount : 0,
            drawerOpenCount: 0,  // ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ•°ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
            createdAt: Timestamp.now(),
            updatedAt: Timestamp.now()
          };
          
          await setDoc(salesRef, newData);
          console.log('âœ… æ–°è¦å£²ä¸Šãƒ‡ãƒ¼ã‚¿ä½œæˆ:', newData);
        }
        
        // æ›´æ–°å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ç¢ºèª
        const updatedDoc = await getDoc(salesRef);
        console.log('æ›´æ–°å¾Œã®ãƒ‡ãƒ¼ã‚¿:', updatedDoc.data());
        
      } catch (error) {
        console.error('âŒ æ—¥æ¬¡å£²ä¸Šæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
      }
    };
    
    // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆé–¢æ•°
    function showCustomAlert(message, title = 'é€šçŸ¥', icon = '') {
      document.getElementById('customAlertIcon').textContent = icon;
      document.getElementById('customAlertTitle').textContent = title;
      document.getElementById('customAlertMessage').textContent = message;
      document.getElementById('customAlert').classList.add('show');
    }
    
    function closeCustomAlert() {
      document.getElementById('customAlert').classList.remove('show');
    }
    
    // å…¨ã¦ã®alertã‚’showCustomAlertã«ç½®ãæ›ãˆ
    window.alert = function(message) {
      let title = 'é€šçŸ¥';
      let icon = 'ğŸ“¢';
      
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¿œã˜ã¦ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰æ›´
      if (message.includes('æˆåŠŸ') || message.includes('å®Œäº†') || message.includes('âœ“') || message.includes('âœ…')) {
        icon = '';
        title = 'å®Œäº†';
      } else if (message.includes('ã‚¨ãƒ©ãƒ¼') || message.includes('å¤±æ•—')) {
        icon = '';
        title = 'ã‚¨ãƒ©ãƒ¼';
      } else if (message.includes('è­¦å‘Š')) {
        icon = '';
        title = 'è­¦å‘Š';
      } else if (message.includes('å‰Šé™¤')) {
        icon = '';
        title = 'å‰Šé™¤';
      } else if (message.includes('è¿½åŠ ') || message.includes('æ³¨æ–‡')) {
        icon = '';
        title = 'å®Œäº†';
      }
      
      showCustomAlert(message, title, icon);
    };
    
    // ========== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼æ©Ÿèƒ½ ==========
    
    // å¾…ã¡äººæ•°+1
    window.increaseWaiting = async function() {
      try {
        const ref = window.doc(window.db, 'settings', 'waiting');
        const snapshot = await window.getDocs(window.collection(window.db, 'settings'));
        let count = 0;
        snapshot.forEach(d => { if (d.id === 'waiting') count = d.data().manualCount || 0; });
        await window.setDoc(ref, { manualCount: count + 1 });
        showToast('å¾…ã¡+1');
      } catch (e) {
        console.error(e);
        alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    };
    
    // å¾…ã¡äººæ•°ãƒªã‚»ãƒƒãƒˆ
    window.resetWaiting = async function() {
      try {
        await window.setDoc(window.doc(window.db, 'settings', 'waiting'), { manualCount: 0 });
        showToast('ãƒªã‚»ãƒƒãƒˆ');
      } catch (e) {
        console.error(e);
        alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    };
    
    // å¾…ã¡äººæ•°ã‚’ç›£è¦–
    function watchWaiting() {
      const unsubscribe = window.onSnapshot(
        window.doc(window.db, 'settings', 'waiting'),
        (doc) => {
          if (doc.exists()) {
            const count = doc.data().manualCount || 0;
            document.getElementById('manual-count').textContent = count;
          }
        }
      );
      return unsubscribe;
    }
    
    // å“åˆ‡ã‚Œãƒšãƒ¼ã‚¸è¡¨ç¤º
    window.showSoldOutPage = async function() {
      try {
        const menuSnapshot = await window.getDocs(window.collection(window.db, 'menu'));
        allMenuItems = [];
        const categories = new Set();
        
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          allMenuItems.push({
            id: data.id,
            name: data.name,
            price: data.price,
            category: data.category
          });
          if (data.category) categories.add(data.category);
        });
        
        const select = document.getElementById('soldout-category-select');
        select.innerHTML = '<option value="">å…¨ã¦ã®å•†å“</option>';
        Array.from(categories).sort().forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          select.appendChild(opt);
        });
        
        select.onchange = () => {
          const filtered = select.value === '' ? allMenuItems : allMenuItems.filter(i => i.category === select.value);
          displaySoldOutItems(filtered);
        };
        
        await displaySoldOutItems(allMenuItems);
        document.getElementById('page-soldout').style.display = 'block';
      } catch (e) {
        console.error(e);
        alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    };
    
    // å“åˆ‡ã‚Œãƒšãƒ¼ã‚¸ã‹ã‚‰æˆ»ã‚‹
    window.backFromSoldOut = function() {
      document.getElementById('page-soldout').style.display = 'none';
    };
    
    // å“åˆ‡ã‚Œå•†å“ãƒªã‚¹ãƒˆè¡¨ç¤º
    async function displaySoldOutItems(items) {
      const list = document.getElementById('soldout-menu-list');
      list.innerHTML = '';
      
      const soldOutSnapshot = await window.getDocs(window.collection(window.db, 'sold_out'));
      const soldOutIds = new Set();
      soldOutSnapshot.forEach(doc => soldOutIds.add(doc.data().menuId));
      
      items.sort((a, b) => {
        const numA = parseInt(a.id.replace(/\D/g, ''));
        const numB = parseInt(b.id.replace(/\D/g, ''));
        return numA - numB;
      });
      
      items.forEach(item => {
        const isSoldOut = soldOutIds.has(item.id);
        const div = document.createElement('div');
        div.className = 'soldout-item' + (isSoldOut ? ' sold-out' : '');
        
        div.innerHTML = `
          <div>
            <div class="soldout-item-name">${item.name}</div>
            <div style="font-size:14px;color:#666;">Â¥${item.price.toLocaleString()}</div>
            ${isSoldOut ? '<span class="soldout-badge">å“åˆ‡ã‚Œä¸­</span>' : ''}
          </div>
          <button class="soldout-toggle-btn ${isSoldOut ? 'set-available' : 'set-soldout'}" 
                  onclick="toggleSoldOut('${item.id}', ${!isSoldOut})">
            ${isSoldOut ? 'è²©å£²å†é–‹' : 'å“åˆ‡ã‚Œ'}
          </button>
        `;
        
        list.appendChild(div);
      });
    }
    
    // å€‹åˆ¥å“åˆ‡ã‚Œåˆ‡ã‚Šæ›¿ãˆ
    window.toggleSoldOut = async function(menuId, setSoldOut) {
      try {
        if (setSoldOut) {
          await window.setDoc(window.doc(window.db, 'sold_out', menuId), {
            menuId: menuId,
            timestamp: window.Timestamp.now()
          });
          showToast('å“åˆ‡ã‚Œã«è¨­å®š');
        } else {
          await window.deleteDoc(window.doc(window.db, 'sold_out', menuId));
          showToast('è²©å£²å†é–‹');
        }
        
        const sel = document.getElementById('soldout-category-select');
        const filtered = sel.value === '' ? allMenuItems : allMenuItems.filter(i => i.category === sel.value);
        await displaySoldOutItems(filtered);
      } catch (e) {
        console.error(e);
        alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    };
    
    // ä¸€æ‹¬å“åˆ‡ã‚Œåˆ‡ã‚Šæ›¿ãˆ
    window.toggleBulkSoldOut = async function() {
      const btn = document.getElementById('bulk-soldout-btn');
      
      if (!isBulkSoldOut) {
        if (!confirm('å…¨å•†å“ã‚’å“åˆ‡ã‚Œã«è¨­å®šã—ã¾ã™ã‹?')) return;
        
        try {
          const menuSnapshot = await window.getDocs(window.collection(window.db, 'menu'));
          const promises = [];
          
          menuSnapshot.forEach(docSnap => {
            const data = docSnap.data();
            if (data.id) {
              promises.push(window.setDoc(window.doc(window.db, 'sold_out', data.id), {
                menuId: data.id,
                timestamp: window.Timestamp.now()
              }));
            }
          });
          
          await Promise.all(promises);
          isBulkSoldOut = true;
          btn.textContent = 'å†è²©';
          btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
          showToast('å…¨å•†å“ã‚’å“åˆ‡ã‚Œã«è¨­å®š');
        } catch (e) {
          console.error(e);
          alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
        }
      } else {
        if (!confirm('å…¨å•†å“ã‚’è²©å£²å†é–‹ã—ã¾ã™ã‹?')) return;
        
        try {
          const soldOutSnapshot = await window.getDocs(window.collection(window.db, 'sold_out'));
          const promises = [];
          soldOutSnapshot.forEach(docSnap => promises.push(window.deleteDoc(docSnap.ref)));
          
          await Promise.all(promises);
          isBulkSoldOut = false;
          btn.textContent = 'ä¸€æ‹¬';
          btn.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
          showToast('å…¨å•†å“ã‚’è²©å£²å†é–‹');
        } catch (e) {
          console.error(e);
          alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
        }
      }
    };
    
    // æ™‚é–“å¤–è¨­å®šåˆ‡ã‚Šæ›¿ãˆ
    window.toggleTimeOverride = async function() {
      const btn = document.getElementById('time-override-btn');
      
      try {
        const settingsRef = window.doc(window.db, 'settings', 'timeOverride');
        const settingsSnap = await window.getDoc(settingsRef);
        const currentOverride = settingsSnap.exists() ? settingsSnap.data().enabled : false;
        
        const newOverride = !currentOverride;
        
        await window.setDoc(settingsRef, {
          enabled: newOverride,
          timestamp: window.Timestamp.now()
        });
        
        if (newOverride) {
          btn.textContent = 'å–¶æ¥­';
          btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
          showToast('å–¶æ¥­æ™‚é–“å¤–ã§ã‚‚æ³¨æ–‡å¯èƒ½ã«ã—ã¾ã—ãŸ');
        } else {
          btn.textContent = 'æ™‚å¤–';
          btn.style.background = 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)';
          showToast('å–¶æ¥­æ™‚é–“å¤–ãƒã‚§ãƒƒã‚¯ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸ');
        }
      } catch (e) {
        console.error(e);
        alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    };
    
    // æ™‚é–“å¤–è¨­å®šã‚’èª­ã¿è¾¼ã¿
    async function loadTimeOverrideStatus() {
      try {
        const settingsRef = window.doc(window.db, 'settings', 'timeOverride');
        const settingsSnap = await window.getDoc(settingsRef);
        const overrideEnabled = settingsSnap.exists() ? settingsSnap.data().enabled : false;
        
        const btn = document.getElementById('time-override-btn');
        if (overrideEnabled) {
          btn.textContent = 'å–¶æ¥­';
          btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
        } else {
          btn.textContent = 'æ™‚å¤–';
          btn.style.background = 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)';
        }
      } catch (e) {
        console.error('æ™‚é–“ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
    function showToast(msg) {
      const toast = document.createElement('div');
      toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);color:white;padding:30px 50px;border-radius:15px;font-size:24px;font-weight:bold;z-index:10001;';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }
    
    // åˆæœŸåŒ–æ™‚ã«ç›£è¦–ã‚’é–‹å§‹
    if (window.firebaseReady) {
      watchWaiting();
      loadTimeOverrideStatus();
    } else {
      window.addEventListener('firebaseReady', () => {
        watchWaiting();
        loadTimeOverrideStatus();
      });
    }
    
    // ========== éŸ³å£°é€šçŸ¥æ©Ÿèƒ½ ==========
    
    function showAudioEnablePopup() {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:20000;display:flex;align-items:center;justify-content:center;';
      
      const popup = document.createElement('div');
      popup.style.cssText = 'background:white;padding:40px;border-radius:20px;max-width:500px;text-align:center;box-shadow:0 10px 50px rgba(0,0,0,0.5);';
      popup.innerHTML = `
        <h2 style="font-size:24px;font-weight:bold;margin-bottom:20px;color:#667eea;">ğŸ”” é€šçŸ¥éŸ³ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã‹ï¼Ÿ</h2>
        <p style="margin-bottom:30px;font-size:16px;color:#666;">æ³¨æ–‡ãƒ»å‘¼ã³å‡ºã—ãƒ»ãŠä¼šè¨ˆã®é€šçŸ¥éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã¨ã€<br>æ³¨æ–‡ãŒå…¥ã£ãŸæ™‚ã‚„å‘¼ã³å‡ºã—ãŒã‚ã£ãŸæ™‚ã«éŸ³ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™ã€‚</p>
        <button id="enableAudioBtn" style="padding:15px 40px;font-size:18px;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;border:none;border-radius:12px;cursor:pointer;font-weight:bold;box-shadow:0 4px 15px rgba(102,126,234,0.4);">éŸ³ã‚’æœ‰åŠ¹ã«ã™ã‚‹</button>
        <button id="skipAudioBtn" style="padding:15px 40px;font-size:16px;background:#ccc;color:#666;border:none;border-radius:12px;cursor:pointer;margin-left:10px;">ã‚¹ã‚­ãƒƒãƒ—</button>
      `;
      
      popup.querySelector('#enableAudioBtn').onclick = () => {
        audioEnabled = true;
        // ãƒ€ãƒŸãƒ¼éŸ³å£°ã‚’å†ç”Ÿã—ã¦ãƒ–ãƒ©ã‚¦ã‚¶ã®åˆ¶é™ã‚’è§£é™¤
        const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGi77eifTRAMUKjj8LZjHAY4ktfyzXksBS');
        audio.volume = 0.01;
        audio.play().catch(e => console.log('ãƒ€ãƒŸãƒ¼éŸ³å£°å†ç”Ÿå¤±æ•—:', e));
        overlay.remove();
        showToast('ğŸ”” é€šçŸ¥éŸ³ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
      };
      
      popup.querySelector('#skipAudioBtn').onclick = () => {
        audioEnabled = false;
        overlay.remove();
      };
      
      overlay.appendChild(popup);
      document.body.appendChild(overlay);
    }
    
    function playOrderSound() {
      console.log('ğŸ”Š æ³¨æ–‡éŸ³å£°å†ç”Ÿè©¦è¡Œ - audioEnabled:', audioEnabled);
      if (!audioEnabled) {
        console.log('âš ï¸ éŸ³å£°ãŒç„¡åŠ¹ã§ã™');
        return;
      }
      try {
        const audio = new Audio('./order.wav');
        audio.volume = 1.0;
        audio.addEventListener('loadeddata', () => console.log('âœ… order.wav ãƒ­ãƒ¼ãƒ‰æˆåŠŸ'));
        audio.addEventListener('error', (e) => console.error('âŒ order.wav ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', e));
        audio.play()
          .then(() => console.log('âœ… order.wav å†ç”ŸæˆåŠŸ'))
          .catch(e => console.error('âŒ order.wav å†ç”Ÿå¤±æ•—:', e));
      } catch (e) {
        console.error('âŒ order.wav ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    function playCallSound() {
      console.log('ğŸ”Š å‘¼ã³å‡ºã—éŸ³å£°å†ç”Ÿè©¦è¡Œ - audioEnabled:', audioEnabled);
      if (!audioEnabled) {
        console.log('âš ï¸ éŸ³å£°ãŒç„¡åŠ¹ã§ã™');
        return;
      }
      try {
        const audio = new Audio('./call.wav');
        audio.volume = 1.0;
        audio.addEventListener('loadeddata', () => console.log('âœ… call.wav ãƒ­ãƒ¼ãƒ‰æˆåŠŸ'));
        audio.addEventListener('error', (e) => console.error('âŒ call.wav ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', e));
        audio.play()
          .then(() => console.log('âœ… call.wav å†ç”ŸæˆåŠŸ'))
          .catch(e => console.error('âŒ call.wav å†ç”Ÿå¤±æ•—:', e));
      } catch (e) {
        console.error('âŒ call.wav ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    function playBillSound() {
      console.log('ğŸ”Š ãŠä¼šè¨ˆéŸ³å£°å†ç”Ÿè©¦è¡Œ - audioEnabled:', audioEnabled);
      if (!audioEnabled) {
        console.log('âš ï¸ éŸ³å£°ãŒç„¡åŠ¹ã§ã™');
        return;
      }
      try {
        const audio = new Audio('./okaikei.wav');
        audio.volume = 1.0;
        audio.addEventListener('loadeddata', () => console.log('âœ… okaikei.wav ãƒ­ãƒ¼ãƒ‰æˆåŠŸ'));
        audio.addEventListener('error', (e) => console.error('âŒ okaikei.wav ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', e));
        audio.play()
          .then(() => console.log('âœ… okaikei.wav å†ç”ŸæˆåŠŸ'))
          .catch(e => console.error('âŒ okaikei.wav å†ç”Ÿå¤±æ•—:', e));
      } catch (e) {
        console.error('âŒ okaikei.wav ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    function watchOrders() {
      console.log('ğŸ‘€ æ³¨æ–‡ç›£è¦–é–‹å§‹');
      const unsubscribe = window.onSnapshot(
        window.collection(window.db, 'orders'), 
        (snapshot) => {
          const currentCount = snapshot.size;
          console.log('ğŸ“Š æ³¨æ–‡æ•°å¤‰åŒ–:', {
            å‰å›: lastOrderCount,
            ä»Šå›: currentCount,
            åˆå›: isFirstOrderLoad
          });
          
          if (!isFirstOrderLoad && currentCount > lastOrderCount) {
            console.log('ğŸ†• æ–°ã—ã„æ³¨æ–‡ã‚’æ¤œå‡ºï¼éŸ³å£°å†ç”Ÿã—ã¾ã™');
            playOrderSound();
          }
          
          lastOrderCount = currentCount;
          isFirstOrderLoad = false;
        }
      );
      
      return unsubscribe;
    }
    
    function watchStaffCalls() {
      console.log('ğŸ‘€ ã‚¹ã‚¿ãƒƒãƒ•ã‚³ãƒ¼ãƒ«ç›£è¦–é–‹å§‹');
      let isFirstLoad = true;
      let lastCallsSnapshot = [];
      
      const unsubscribe = window.onSnapshot(
        window.collection(window.db, 'staff_calls'),
        (snapshot) => {
          const calls = [];
          snapshot.forEach(doc => calls.push({ id: doc.id, ...doc.data() }));
          calls.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
          
          console.log('ğŸ“ ã‚¹ã‚¿ãƒƒãƒ•ã‚³ãƒ¼ãƒ«å¤‰åŒ–:', {
            ã‚³ãƒ¼ãƒ«æ•°: calls.length,
            åˆå›: isFirstLoad
          });
          
          // æ–°ã—ã„å‘¼ã³å‡ºã—ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if (!isFirstLoad && calls.length > 0) {
            const isBill = calls[0].type === 'bill';
            console.log('ğŸ†• æ–°ã—ã„å‘¼ã³å‡ºã—æ¤œå‡ºï¼', isBill ? 'ãŠä¼šè¨ˆ' : 'å‘¼ã³å‡ºã—');
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
            showStaffCallPopup(calls[0], isBill);
            
            // éŸ³å£°ã‚’å†ç”Ÿ
            if (isBill) playBillSound();
            else playCallSound();
          }
          isFirstLoad = false;
          lastCallsSnapshot = calls;
        }
      );
      
      return unsubscribe;
    }
    
    function showStaffCallPopup(call, isBill) {
      // æ—¢å­˜ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒã‚ã‚Œã°å‰Šé™¤
      const existing = document.getElementById('staff-call-popup');
      if (existing) existing.remove();
      
      const overlay = document.createElement('div');
      overlay.id = 'staff-call-popup';
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:20000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s;';
      
      const popup = document.createElement('div');
      popup.style.cssText = `
        background:${isBill ? 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)' : 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)'};
        padding:60px;
        border-radius:30px;
        text-align:center;
        box-shadow:0 20px 60px rgba(0,0,0,0.5);
        color:white;
        animation:bounceIn 0.5s;
      `;
      
      const orderNumberHtml = call.orderNumber 
        ? `<div style="font-size:36px;margin-top:20px;font-weight:bold;">æ³¨æ–‡ç•ªå·: #${call.orderNumber}</div>` 
        : '';
      
      popup.innerHTML = `
        <div style="font-size:80px;margin-bottom:20px;">${isBill ? 'ğŸ’³' : 'ğŸ“'}</div>
        <div style="font-size:48px;font-weight:bold;margin-bottom:20px;">
          ${isBill ? 'ãŠä¼šè¨ˆã§ã™' : 'å‘¼ã³å‡ºã—'}
        </div>
        <div style="font-size:64px;font-weight:bold;background:rgba(255,255,255,0.3);padding:20px;border-radius:15px;margin-bottom:20px;">
          ${call.tableNumber || 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ'}
        </div>
        ${orderNumberHtml}
        <button onclick="dismissStaffCallPopup('${call.id}')" style="
          margin-top:30px;
          padding:20px 60px;
          font-size:24px;
          background:white;
          color:${isBill ? '#2196F3' : '#FF9800'};
          border:none;
          border-radius:15px;
          cursor:pointer;
          font-weight:bold;
          box-shadow:0 4px 15px rgba(0,0,0,0.3);
        ">å¯¾å¿œå®Œäº†</button>
      `;
      
      overlay.appendChild(popup);
      document.body.appendChild(overlay);
    }
    
    window.dismissStaffCallPopup = async function(callId) {
      await window.deleteDoc(window.doc(window.db, 'staff_calls', callId));
      const popup = document.getElementById('staff-call-popup');
      if (popup) popup.remove();
      showToast('âœ“ å¯¾å¿œå®Œäº†');
    };
    
  </script>
  
  <style>
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
  <div id="customAlert" class="custom-alert-overlay">
    <div class="custom-alert-box">
      <div class="custom-alert-icon" id="customAlertIcon"></div>
      <div class="custom-alert-title" id="customAlertTitle">é€šçŸ¥</div>
      <div class="custom-alert-message" id="customAlertMessage"></div>
      <button class="custom-alert-button" onclick="closeCustomAlert()">OK</button>
    </div>
  </div>
  <div id="productRegistrationModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h3>å•†å“ç™»éŒ²</h3>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å•†å“å</label>
        <input type="text" id="productName" placeholder="ä¾‹: ãŸã“ç„¼ã 6å€‹å…¥ã‚Š" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ä¾¡æ ¼</label>
        <input type="number" id="productPrice" placeholder="ä¾‹: 500" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚«ãƒ†ã‚´ãƒª</label>
        <select id="productCategory" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="ãŸã“ç„¼ã">ãŸã“ç„¼ã</option>
          <option value="ãŠå¥½ã¿ç„¼ã">ãŠå¥½ã¿ç„¼ã</option>
          <option value="ç„¼ããã°">ç„¼ããã°</option>
          <option value="é£²ã¿ç‰©">é£²ã¿ç‰©</option>
          <option value="ã‚µã‚¤ãƒ‰">ã‚µã‚¤ãƒ‰</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ†ã‚´ãƒªï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«ãªã„å ´åˆï¼‰</label>
        <input type="text" id="productCustomCategory" placeholder="æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªå" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Noteï¼ˆè¡¨ç¤ºåˆ¶é™ï¼‰</label>
        <input type="text" id="productNote" placeholder="ä¾‹: åº—å†…ã®ã¿, ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã®ã¿" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
        <small style="color: #666;">ã€Œåº—å†…ã®ã¿ã€ã¨å…¥åŠ›ã™ã‚‹ã¨ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã§ã¯éè¡¨ç¤ºã€ã€Œãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã®ã¿ã€ã¨å…¥åŠ›ã™ã‚‹ã¨åº—å†…ã§ã¯éè¡¨ç¤ºã«ãªã‚Šã¾ã™</small>
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 2px dashed #2196F3;">
        <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #1976D2;">ğŸ“¸ å•†å“ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
        <input type="file" id="productImageFile" accept="image/*" style="width: 100%; padding: 10px; border: 2px solid #2196F3; border-radius: 8px; background: white; margin-bottom: 10px;">
        <button type="button" onclick="uploadProductImage()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        <div id="upload-progress" style="margin-top: 10px; font-weight: bold;"></div>
        <div id="image-preview" style="margin-top: 10px;"></div>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã¾ãŸã¯ç”»åƒURLã‚’ç›´æ¥å…¥åŠ›</label>
        <input type="text" id="productImage" placeholder="ä¾‹: takoyaki1.jpg ã¾ãŸã¯ https://..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
        <small style="color: #666;">GitHubã®imagesãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«åã€ã¾ãŸã¯https://ã§å§‹ã¾ã‚‹ç”»åƒURLã‚’å…¥åŠ›</small>
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <h4 style="margin-bottom: 15px;">ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆ</h4>
        <div id="toppingSetsList">
          <!-- ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
        </div>
        <button onclick="addToppingSetToProduct()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px;">+ ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’è¿½åŠ </button>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="registerProduct()">ç™»éŒ²</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeProductRegistrationModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>
  <div id="productDeleteModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h3>å•†å“å‰Šé™¤</h3>
      
      <div style="margin: 20px 0;">
        <input type="text" id="productSearchInput" placeholder="å•†å“åã§æ¤œç´¢..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 15px;" oninput="filterProductList()">
      </div>
      
      <div id="productDeleteList" style="max-height: 500px; overflow-y: auto;">
        
      </div>
      
      <button class="btn btn-secondary" style="width: 100%; margin-top: 20px;" onclick="closeProductDeleteModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- å•†å“ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="productEditModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h3>å•†å“ç·¨é›†</h3>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å•†å“å</label>
        <input type="text" id="editProductName" placeholder="ä¾‹: ãŸã“ç„¼ã 6å€‹å…¥ã‚Š" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ä¾¡æ ¼</label>
        <input type="number" id="editProductPrice" placeholder="ä¾‹: 500" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚«ãƒ†ã‚´ãƒª</label>
        <select id="editProductCategory" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="ãŸã“ç„¼ã">ãŸã“ç„¼ã</option>
          <option value="ãŠå¥½ã¿ç„¼ã">ãŠå¥½ã¿ç„¼ã</option>
          <option value="ç„¼ããã°">ç„¼ããã°</option>
          <option value="é£²ã¿ç‰©">é£²ã¿ç‰©</option>
          <option value="ã‚µã‚¤ãƒ‰">ã‚µã‚¤ãƒ‰</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ†ã‚´ãƒªï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«ãªã„å ´åˆï¼‰</label>
        <input type="text" id="editProductCustomCategory" placeholder="æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªå" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Noteï¼ˆè¡¨ç¤ºåˆ¶é™ï¼‰</label>
        <input type="text" id="editProductNote" placeholder="ä¾‹: åº—å†…ã®ã¿, ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã®ã¿" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
        <small style="color: #666;">ã€Œåº—å†…ã®ã¿ã€ã¨å…¥åŠ›ã™ã‚‹ã¨ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã§ã¯éè¡¨ç¤ºã€ã€Œãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã®ã¿ã€ã¨å…¥åŠ›ã™ã‚‹ã¨åº—å†…ã§ã¯éè¡¨ç¤ºã«ãªã‚Šã¾ã™</small>
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 8px; border: 2px dashed #2196F3;">
        <label style="display: block; margin-bottom: 10px; font-weight: bold; color: #1976D2;">ğŸ“¸ å•†å“ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
        <input type="file" id="editProductImageFile" accept="image/*" style="width: 100%; padding: 10px; border: 2px solid #2196F3; border-radius: 8px; background: white; margin-bottom: 10px;">
        <button type="button" onclick="uploadEditProductImage()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        <div id="edit-upload-progress" style="margin-top: 10px; font-weight: bold;"></div>
        <div id="edit-image-preview" style="margin-top: 10px;"></div>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã¾ãŸã¯ç”»åƒURLã‚’ç›´æ¥å…¥åŠ›</label>
        <input type="text" id="editProductImage" placeholder="ä¾‹: takoyaki1.jpg ã¾ãŸã¯ https://..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
        <small style="color: #666;">GitHubã®imagesãƒ•ã‚©ãƒ«ãƒ€å†…ã®ãƒ•ã‚¡ã‚¤ãƒ«åã€ã¾ãŸã¯https://ã§å§‹ã¾ã‚‹ç”»åƒURLã‚’å…¥åŠ›</small>
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <h4 style="margin-bottom: 15px;">ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆ</h4>
        <div id="editToppingSetsContainer">
          <!-- ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
        <button type="button" onclick="addEditToppingSet()" style="padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px;">+ ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆè¿½åŠ </button>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button onclick="saveProductEdit()" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold;">ä¿å­˜</button>
        <button onclick="closeEditProductModal()" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #999 0%, #666 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <div id="page-soldout" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 10000; padding: 20px; overflow-y: auto;">
    <div style="max-width: 1200px; margin: 0 auto;">
      <button onclick="backFromSoldOut()" style="padding: 15px 30px; font-size: 18px; background: #FFFF00; color: #333; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">â† æˆ»ã‚‹</button>
      
      <div style="background: white; color: #667eea; padding: 15px 20px; border-radius: 15px; margin-bottom: 15px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
        <h1 style="font-size: 20px; font-weight: bold; margin: 0;">å“åˆ‡ã‚Œè¨­å®š</h1>
      </div>
      
      <div style="background: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <label style="display: block; font-size: 16px; font-weight: bold; margin-bottom: 10px;">ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„</label>
        <select id="soldout-category-select" style="width: 100%; padding: 15px; font-size: 18px; border: 3px solid #9C27B0; border-radius: 12px;">
          <option value="">å…¨ã¦ã®å•†å“</option>
        </select>
      </div>
      
      <div id="soldout-menu-list"></div>
    </div>
  </div>
  
  </div> 
  
  <script>
    // ========== å•†å“ç™»éŒ²ãƒ»å‰Šé™¤æ©Ÿèƒ½ ==========
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã®ç®¡ç†ç”¨é…åˆ—
    let productToppingSets = [];
    
    // å•†å“ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showProductRegistrationModal = function() {
      document.getElementById('productRegistrationModal').classList.remove('hidden');
      // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('productName').value = '';
      document.getElementById('productPrice').value = '';
      document.getElementById('productCategory').value = '';
      document.getElementById('productCustomCategory').value = '';
      document.getElementById('productNote').value = '';
      productToppingSets = [];
      document.getElementById('toppingSetsList').innerHTML = '';
    };
    
    // å•†å“ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeProductRegistrationModal = function() {
      document.getElementById('productRegistrationModal').classList.add('hidden');
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’è¿½åŠ 
    window.addToppingSetToProduct = function() {
      const setDiv = document.createElement('div');
      setDiv.style.cssText = 'margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #ddd;';
      const setIndex = productToppingSets.length;
      
      setDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h5 style="margin: 0;">ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆ ${setIndex + 1}</h5>
          <button onclick="removeToppingSet(${setIndex})" style="padding: 5px 10px; background: #F44336; color: white; border: none; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
        </div>
        
        <div style="margin-bottom: 10px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚»ãƒƒãƒˆå</label>
          <input type="text" class="topping-set-name" placeholder="ä¾‹: ãŸã“ç„¼ãã®å‘³" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
        </div>
        
        <div style="margin-bottom: 10px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">é¸æŠã‚¿ã‚¤ãƒ—</label>
          <select class="topping-set-type" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
            <option value="single">å˜ä¸€é¸æŠï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰</option>
            <option value="multiple">è¤‡æ•°é¸æŠï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰</option>
          </select>
        </div>
        
        <div style="margin-bottom: 10px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">ãƒˆãƒƒãƒ”ãƒ³ã‚°é …ç›®</label>
          <div class="topping-options-list" style="margin-bottom: 10px;">
            <!-- ãƒˆãƒƒãƒ”ãƒ³ã‚°é …ç›®ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
          </div>
          <button onclick="addToppingOption(${setIndex})" style="padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">+ é …ç›®ã‚’è¿½åŠ </button>
        </div>
      `;
      
      document.getElementById('toppingSetsList').appendChild(setDiv);
      productToppingSets.push({ options: [] });
      
      // åˆæœŸé …ç›®ã‚’1ã¤è¿½åŠ 
      addToppingOption(setIndex);
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’å‰Šé™¤
    window.removeToppingSet = function(index) {
      productToppingSets.splice(index, 1);
      renderToppingSets();
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°é …ç›®ã‚’è¿½åŠ 
    window.addToppingOption = function(setIndex) {
      const optionsList = document.getElementById('toppingSetsList').children[setIndex].querySelector('.topping-options-list');
      const optionDiv = document.createElement('div');
      optionDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 8px; align-items: center;';
      optionDiv.innerHTML = `
        <input type="text" class="topping-option-name" placeholder="ä¾‹: ã‚½ãƒ¼ã‚¹" style="flex: 2; padding: 6px; border: 2px solid #ddd; border-radius: 4px;">
        <input type="number" class="topping-option-price" placeholder="ä¾¡æ ¼" value="0" style="flex: 1; padding: 6px; border: 2px solid #ddd; border-radius: 4px;">
        <button onclick="this.parentElement.remove()" style="padding: 6px 10px; background: #F44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Ã—</button>
      `;
      optionsList.appendChild(optionDiv);
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’å†æç”»
    function renderToppingSets() {
      const container = document.getElementById('toppingSetsList');
      container.innerHTML = '';
      productToppingSets.forEach((set, index) => {
        addToppingSetToProduct();
      });
    }
    
    // ========== ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ ==========
    
    // å•†å“ç™»éŒ²ç”¨ã®ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    window.uploadProductImage = async function() {
      const fileInput = document.getElementById('productImageFile');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      const progressDiv = document.getElementById('upload-progress');
      const previewDiv = document.getElementById('image-preview');
      progressDiv.textContent = 'â³ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
      progressDiv.style.color = '#2196F3';
      
      try {
        // Firebase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        const timestamp = Date.now();
        const fileName = `${timestamp}_${file.name}`;
        const storageReference = window.storageRef(window.storage, `products/${fileName}`);
        
        await window.uploadBytes(storageReference, file);
        
        // URLã‚’å–å¾—
        const imageUrl = await window.getDownloadURL(storageReference);
        
        // å•†å“ç”»åƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è‡ªå‹•å…¥åŠ›
        document.getElementById('productImage').value = imageUrl;
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        previewDiv.innerHTML = `<img src="${imageUrl}" style="max-width: 200px; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">`;
        
        progressDiv.textContent = 'âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†';
        progressDiv.style.color = '#4CAF50';
        
        setTimeout(() => {
          progressDiv.textContent = '';
        }, 3000);
      } catch (error) {
        console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        progressDiv.textContent = 'âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ' + error.message;
        progressDiv.style.color = '#f44336';
      }
    };
    
    // å•†å“ç·¨é›†ç”¨ã®ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    window.uploadEditProductImage = async function() {
      const fileInput = document.getElementById('editProductImageFile');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      const progressDiv = document.getElementById('edit-upload-progress');
      const previewDiv = document.getElementById('edit-image-preview');
      progressDiv.textContent = 'â³ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
      progressDiv.style.color = '#2196F3';
      
      try {
        // Firebase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        const timestamp = Date.now();
        const fileName = `${timestamp}_${file.name}`;
        const storageReference = window.storageRef(window.storage, `products/${fileName}`);
        
        await window.uploadBytes(storageReference, file);
        
        // URLã‚’å–å¾—
        const imageUrl = await window.getDownloadURL(storageReference);
        
        // å•†å“ç”»åƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è‡ªå‹•å…¥åŠ›
        document.getElementById('editProductImage').value = imageUrl;
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        previewDiv.innerHTML = `<img src="${imageUrl}" style="max-width: 200px; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">`;
        
        progressDiv.textContent = 'âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†';
        progressDiv.style.color = '#4CAF50';
        
        setTimeout(() => {
          progressDiv.textContent = '';
        }, 3000);
      } catch (error) {
        console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        progressDiv.textContent = 'âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ' + error.message;
        progressDiv.style.color = '#f44336';
      }
    };
    
    // å•†å“ã‚’ç™»éŒ²
    window.registerProduct = async function() {
      const name = document.getElementById('productName').value.trim();
      const price = parseInt(document.getElementById('productPrice').value);
      const category = document.getElementById('productCategory').value;
      const customCategory = document.getElementById('productCustomCategory').value.trim();
      const note = document.getElementById('productNote').value.trim();
      
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!name) {
        alert('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!price || price < 0) {
        alert('æ­£ã—ã„ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      const finalCategory = customCategory || category;
      if (!finalCategory) {
        alert('ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã™ã‚‹ã‹ã€ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ†ã‚´ãƒªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’åé›†
      const toppingSets = [];
      const setDivs = document.getElementById('toppingSetsList').children;
      
      for (let i = 0; i < setDivs.length; i++) {
        const setDiv = setDivs[i];
        const setName = setDiv.querySelector('.topping-set-name').value.trim();
        const setType = setDiv.querySelector('.topping-set-type').value;
        
        if (!setName) continue; // åå‰ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        
        const options = [];
        const optionDivs = setDiv.querySelectorAll('.topping-options-list > div');
        
        optionDivs.forEach(optionDiv => {
          const optionName = optionDiv.querySelector('.topping-option-name').value.trim();
          const optionPrice = parseInt(optionDiv.querySelector('.topping-option-price').value) || 0;
          
          if (optionName) {
            options.push({ name: optionName, price: optionPrice });
          }
        });
        
        if (options.length > 0) {
          toppingSets.push({
            name: setName,
            type: setType,
            options: options
          });
        }
      }
      
      try {
        // Firebaseã«å•†å“ã‚’è¿½åŠ 
        const productData = {
          name: name,
          price: price,
          category: finalCategory,
          toppingSets: toppingSets,
          note: note,
          createdAt: window.Timestamp.now()
        };
        
        await window.addDoc(window.collection(window.db, 'menu'), productData);
        
        alert('å•†å“ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
        closeProductRegistrationModal();
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å†èª­ã¿è¾¼ã¿
        
        
      } catch (error) {
        console.error('å•†å“ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
        alert('å•†å“ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };
    
    // å•†å“å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showProductDeleteModal = async function() {
      document.getElementById('productDeleteModal').classList.remove('hidden');
      await loadProductDeleteList();
    };
    
    // å•†å“å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeProductDeleteModal = function() {
      document.getElementById('productDeleteModal').classList.add('hidden');
    };
    
    // å‰Šé™¤ç”¨ã®å•†å“ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
    let allProductsForDelete = [];
    async function loadProductDeleteList() {
      try {
        const container = document.getElementById('productDeleteList');
        container.innerHTML = '<div style="text-align: center; padding: 20px;">èª­ã¿è¾¼ã¿ä¸­...</div>';
        
        const menuSnapshot = await window.getDocs(window.collection(window.db, 'menu'));
        allProductsForDelete = [];
        
        menuSnapshot.forEach(doc => {
          allProductsForDelete.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚½ãƒ¼ãƒˆ
        allProductsForDelete.sort((a, b) => {
          if (a.category !== b.category) {
            return a.category.localeCompare(b.category);
          }
          return a.name.localeCompare(b.name);
        });
        
        displayProductDeleteList(allProductsForDelete);
        
      } catch (error) {
        console.error('å•†å“ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('productDeleteList').innerHTML = '<div style="text-align: center; padding: 20px; color: red;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    }
    
    // å•†å“å‰Šé™¤ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
    function displayProductDeleteList(products) {
      const container = document.getElementById('productDeleteList');
      
      if (products.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = '';
      
      products.forEach(product => {
        const productDiv = document.createElement('div');
        productDiv.style.cssText = 'padding: 15px; margin-bottom: 10px; background: white; border-radius: 8px; border: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;';
        
        const infoDiv = document.createElement('div');
        infoDiv.innerHTML = `
          <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${product.name}</div>
          <div style="color: #666; font-size: 14px;">
            <span style="background: #E3F2FD; padding: 2px 8px; border-radius: 4px; margin-right: 10px;">${product.category}</span>
            <span style="color: #4CAF50; font-weight: bold;">Â¥${product.price.toLocaleString()}</span>
          </div>
        `;
        
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = 'display: flex; gap: 10px;';
        
        const editBtn = document.createElement('button');
        editBtn.textContent = 'ç·¨é›†';
        editBtn.style.cssText = 'padding: 8px 20px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;';
        editBtn.onclick = () => showEditProductModal(product);
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'å‰Šé™¤';
        deleteBtn.style.cssText = 'padding: 8px 20px; background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;';
        deleteBtn.onclick = () => deleteProduct(product.id, product.name);
        
        buttonContainer.appendChild(editBtn);
        buttonContainer.appendChild(deleteBtn);
        
        productDiv.appendChild(infoDiv);
        productDiv.appendChild(buttonContainer);
        container.appendChild(productDiv);
      });
    }
    
    // å•†å“ã‚’æ¤œç´¢ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    window.filterProductList = function() {
      const searchText = document.getElementById('productSearchInput').value.toLowerCase();
      
      if (!searchText) {
        displayProductDeleteList(allProductsForDelete);
        return;
      }
      
      const filtered = allProductsForDelete.filter(product => 
        product.name.toLowerCase().includes(searchText) ||
        product.category.toLowerCase().includes(searchText)
      );
      
      displayProductDeleteList(filtered);
    };
    
    // å•†å“ã‚’å‰Šé™¤
    async function deleteProduct(productId, productName) {
      if (!confirm(`ã€Œ${productName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`)) {
        return;
      }
      
      try {
        await window.deleteDoc(window.doc(window.db, 'menu', productId));
        
        alert('å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        
        // ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
        await loadProductDeleteList();
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å†èª­ã¿è¾¼ã¿
        
        
      } catch (error) {
        console.error('å•†å“å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('å•†å“ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }
    
    // ========== å•†å“ç·¨é›†æ©Ÿèƒ½ ==========
    
    let editingProductId = null;
    let editToppingSets = [];
    
    // å•†å“ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.showEditProductModal = function(product) {
      editingProductId = product.id;
      
      // ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®š
      document.getElementById('editProductName').value = product.name || '';
      document.getElementById('editProductPrice').value = product.price || '';
      document.getElementById('editProductCategory').value = product.category || '';
      document.getElementById('editProductCustomCategory').value = '';
      document.getElementById('editProductNote').value = product.note || '';
      document.getElementById('editProductImage').value = product.image || '';
      
      // ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
      const previewDiv = document.getElementById('edit-image-preview');
      if (product.image) {
        previewDiv.innerHTML = `<img src="${product.image}" style="max-width: 200px; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">`;
      } else {
        previewDiv.innerHTML = '';
      }
      
      // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’è¨­å®š
      editToppingSets = product.toppingSets ? JSON.parse(JSON.stringify(product.toppingSets)) : [];
      renderEditToppingSets();
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      document.getElementById('productEditModal').classList.remove('hidden');
    };
    
    // å•†å“ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeEditProductModal = function() {
      document.getElementById('productEditModal').classList.add('hidden');
      editingProductId = null;
      editToppingSets = [];
    };
    
    // ç·¨é›†ç”¨ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’è¡¨ç¤º
    function renderEditToppingSets() {
      const container = document.getElementById('editToppingSetsContainer');
      container.innerHTML = '';
      
      if (editToppingSets.length === 0) {
        container.innerHTML = '<p style="color: #999;">ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã¯ã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }
      
      editToppingSets.forEach((set, setIndex) => {
        const setDiv = document.createElement('div');
        setDiv.style.cssText = 'margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #E3F2FD;';
        
        setDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h5 style="margin: 0;">ã‚»ãƒƒãƒˆ ${setIndex + 1}</h5>
            <button onclick="removeEditToppingSet(${setIndex})" style="padding: 4px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
          </div>
          
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚»ãƒƒãƒˆå</label>
            <input type="text" class="edit-topping-set-name" value="${set.name || ''}" onchange="updateEditToppingSetName(${setIndex}, this.value)" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
          </div>
          
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">é¸æŠã‚¿ã‚¤ãƒ—</label>
            <select class="edit-topping-set-type" onchange="updateEditToppingSetType(${setIndex}, this.value)" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
              <option value="single" ${set.type === 'single' ? 'selected' : ''}>å˜ä¸€é¸æŠï¼ˆ1ã¤ã ã‘é¸æŠå¯èƒ½ï¼‰</option>
              <option value="multiple" ${set.type === 'multiple' ? 'selected' : ''}>è¤‡æ•°é¸æŠï¼ˆè¤‡æ•°é¸æŠå¯èƒ½ï¼‰</option>
            </select>
          </div>
          
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚ªãƒ—ã‚·ãƒ§ãƒ³</label>
            <div class="edit-topping-options-list">
              ${(set.options || []).map((option, optIndex) => `
                <div style="display: flex; gap: 10px; margin-bottom: 8px; align-items: center;">
                  <input type="text" class="edit-option-name" value="${option.name || ''}" onchange="updateEditOption(${setIndex}, ${optIndex}, 'name', this.value)" placeholder="ã‚ªãƒ—ã‚·ãƒ§ãƒ³å" style="flex: 1; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                  <input type="number" class="edit-option-price" value="${option.price || 0}" onchange="updateEditOption(${setIndex}, ${optIndex}, 'price', this.value)" placeholder="è¿½åŠ æ–™é‡‘" style="width: 100px; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
                  <button onclick="removeEditOption(${setIndex}, ${optIndex})" style="padding: 8px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
                </div>
              `).join('')}
            </div>
            <button onclick="addEditToppingOption(${setIndex})" style="padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px;">+ ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ </button>
          </div>
        `;
        
        container.appendChild(setDiv);
      });
    }
    
    // ç·¨é›†ç”¨ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆè¿½åŠ 
    window.addEditToppingSet = function() {
      editToppingSets.push({
        name: '',
        type: 'single',
        options: [{ name: '', price: 0 }]
      });
      renderEditToppingSets();
    };
    
    // ç·¨é›†ç”¨ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆå‰Šé™¤
    window.removeEditToppingSet = function(setIndex) {
      editToppingSets.splice(setIndex, 1);
      renderEditToppingSets();
    };
    
    // ç·¨é›†ç”¨ã‚»ãƒƒãƒˆåæ›´æ–°
    window.updateEditToppingSetName = function(setIndex, value) {
      editToppingSets[setIndex].name = value;
    };
    
    // ç·¨é›†ç”¨ã‚»ãƒƒãƒˆã‚¿ã‚¤ãƒ—æ›´æ–°
    window.updateEditToppingSetType = function(setIndex, value) {
      editToppingSets[setIndex].type = value;
    };
    
    // ç·¨é›†ç”¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ 
    window.addEditToppingOption = function(setIndex) {
      if (!editToppingSets[setIndex].options) {
        editToppingSets[setIndex].options = [];
      }
      editToppingSets[setIndex].options.push({ name: '', price: 0 });
      renderEditToppingSets();
    };
    
    // ç·¨é›†ç”¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³å‰Šé™¤
    window.removeEditOption = function(setIndex, optIndex) {
      editToppingSets[setIndex].options.splice(optIndex, 1);
      renderEditToppingSets();
    };
    
    // ç·¨é›†ç”¨ã‚ªãƒ—ã‚·ãƒ§ãƒ³æ›´æ–°
    window.updateEditOption = function(setIndex, optIndex, field, value) {
      if (field === 'price') {
        editToppingSets[setIndex].options[optIndex][field] = parseInt(value) || 0;
      } else {
        editToppingSets[setIndex].options[optIndex][field] = value;
      }
    };
    
    // å•†å“ç·¨é›†ã‚’ä¿å­˜
    window.saveProductEdit = async function() {
      if (!editingProductId) {
        alert('ã‚¨ãƒ©ãƒ¼: ç·¨é›†ä¸­ã®å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      const name = document.getElementById('editProductName').value.trim();
      const price = parseInt(document.getElementById('editProductPrice').value);
      const category = document.getElementById('editProductCategory').value;
      const customCategory = document.getElementById('editProductCustomCategory').value.trim();
      const note = document.getElementById('editProductNote').value.trim();
      const image = document.getElementById('editProductImage').value.trim();
      
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!name) {
        alert('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!price || price < 0) {
        alert('æ­£ã—ã„ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      const finalCategory = customCategory || category;
      if (!finalCategory) {
        alert('ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã®æ¤œè¨¼
      for (let i = 0; i < editToppingSets.length; i++) {
        const set = editToppingSets[i];
        if (!set.name) {
          alert(`ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆ ${i + 1} ã®ã‚»ãƒƒãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`);
          return;
        }
        
        if (!set.options || set.options.length === 0) {
          alert(`ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆ ${i + 1} ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„`);
          return;
        }
        
        for (let j = 0; j < set.options.length; j++) {
          const option = set.options[j];
          if (!option.name) {
            alert(`ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆ ${i + 1} ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ ${j + 1} ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`);
            return;
          }
        }
      }
      
      try {
        const productData = {
          name: name,
          price: price,
          category: finalCategory,
          note: note,
          image: image,
          toppingSets: editToppingSets,
          updatedAt: window.Timestamp.now()
        };
        
        await window.updateDoc(window.doc(window.db, 'menu', editingProductId), productData);
        
        alert('å•†å“ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        closeEditProductModal();
        
        // ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
        await loadProductDeleteList();
        
      } catch (error) {
        console.error('å•†å“æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        alert('å•†å“ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };
    
    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼å‡¦ç†
    function handlePOSLogin(event) {
      event.preventDefault();
      
      const passwordInput = document.getElementById('posPasswordInput');
      const loginError = document.getElementById('loginError');
      const correctPassword = 'K12290619T';
      
      if (passwordInput.value === correctPassword) {
        // ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«èªè¨¼ãƒ•ãƒ©ã‚°ã‚’ä¿å­˜
        sessionStorage.setItem('posAuthenticated', 'true');
        
        // åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
        if (window.firebaseReady) {
          initializeApp();
        } else {
          window.addEventListener('firebaseReady', initializeApp);
        }
      } else {
        // ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—
        loginError.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
        loginError.style.display = 'block';
        passwordInput.value = '';
        passwordInput.focus();
        
        setTimeout(() => {
          loginError.style.display = 'none';
        }, 3000);
      }
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
    window.addEventListener('DOMContentLoaded', () => {
      const isAuthenticated = sessionStorage.getItem('posAuthenticated');
      
      if (isAuthenticated === 'true') {
        // æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
        // åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
        if (window.firebaseReady) {
          initializeApp();
        } else {
          window.addEventListener('firebaseReady', initializeApp);
        }
      }
    });
    
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–å‡¦ç†
    function initializeApp() {
      // æ—¢å­˜ã®åˆæœŸåŒ–å‡¦ç†ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
      console.log('âœ… POSã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
    }
  </script>
  
</body>
</html>
