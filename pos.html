<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <title>ç²‰ã‚‚ã‚“å±‹ å…« - ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ </title>
  
  <!-- Star mC-Print3 SDK - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã‹ã‚‰èª­ã¿è¾¼ã¿ -->
  <script src="http://192.168.244.41:8001/StarWebPrintBuilder.js"></script>
  <script src="http://192.168.244.41:8001/StarWebPrintTrader.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, getDoc, setDoc, updateDoc, doc, Timestamp, onSnapshot, addDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ
    console.log('ğŸ”¥ FirebaseåˆæœŸåŒ–å®Œäº†');
    console.log('ğŸ“¦ Project ID:', firebaseConfig.projectId);
    console.log('ğŸŒ Auth Domain:', firebaseConfig.authDomain);
    
    // åŒ¿åèªè¨¼
    async function authenticateUser() {
      try {
        console.log('ğŸ” åŒ¿åèªè¨¼ã‚’é–‹å§‹...');
        const userCredential = await signInAnonymously(auth);
        console.log('âœ… åŒ¿åèªè¨¼æˆåŠŸ:', userCredential.user.uid);
        window.isAuthenticated = true;
        return true;
      } catch (error) {
        console.error('âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
        console.error('ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:', error.code);
        console.error('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', error.message);
        return false;
      }
    }
    
    // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log('ğŸ‘¤ èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user.uid);
        window.isAuthenticated = true;
      } else {
        console.log('âŒ æœªèªè¨¼');
        window.isAuthenticated = false;
      }
    });
    
    // æ¥ç¶šãƒ†ã‚¹ãƒˆç”¨ã®ç°¡å˜ãªã‚¯ã‚¨ãƒª
    async function testFirebaseConnection() {
      try {
        console.log('ğŸ” Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹...');
        const testQuery = query(collection(db, 'menuItems'), limit(1));
        const testSnapshot = await getDocs(testQuery);
        console.log('âœ… Firebaseæ¥ç¶šæˆåŠŸï¼', 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—:', testSnapshot.size);
        return true;
      } catch (e) {
        console.error('âŒ Firebaseæ¥ç¶šå¤±æ•—:', e);
        console.error('ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:', e.code);
        console.error('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', e.message);
        return false;
      }
    }
    
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.updateDoc = updateDoc;
    window.doc = doc;
    window.Timestamp = Timestamp;
    window.onSnapshot = onSnapshot;
    window.addDoc = addDoc;
    window.orderBy = orderBy;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.authenticateUser = authenticateUser;
    window.testFirebaseConnection = testFirebaseConnection;
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .header-left h1 {
      font-size: 32px;
      color: #333;
      margin-bottom: 5px;
    }
    
    .header-left .status {
      font-size: 18px;
      color: #666;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .auto-print-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f8f9fa;
      padding: 12px 20px;
      border-radius: 12px;
    }
    
    .auto-print-toggle label {
      font-weight: bold;
      color: #333;
    }
    
    .toggle-switch {
      position: relative;
      width: 60px;
      height: 30px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 30px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: #4CAF50;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(30px);
    }
    
    .toggle-status {
      font-weight: bold;
      min-width: 50px;
    }
    
    .toggle-status.on {
      color: #4CAF50;
    }
    
    .toggle-status.off {
      color: #999;
    }
    
    .sales-summary {
      background: #f8f9fa;
      padding: 15px 20px;
      border-radius: 12px;
      display: flex;
      gap: 30px;
      align-items: center;
    }
    
    .sales-item {
      text-align: center;
    }
    
    .sales-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .sales-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    
    .sales-value.highlight {
      color: #4CAF50;
    }
    
    .btn-settlement {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 12px 30px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-settlement:hover {
      background: #ff5252;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 25px;
    }
    
    .section {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }
    
    .section-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 12px;
    }
    
    .table-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 20px;
      border-radius: 15px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
      min-height: 80px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 5px;
    }
    
    .table-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .table-btn.has-order {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .table-btn.selected {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.3);
    }
    
    .table-status {
      font-size: 12px;
      opacity: 0.9;
    }
    
    .order-count {
      background: rgba(255,255,255,0.3);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }
    
    .memo-icon {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 16px;
      opacity: 0.3;
      cursor: pointer;
      transition: opacity 0.3s;
    }
    
    .memo-icon:hover {
      opacity: 1;
    }
    
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      max-height: 500px;
      overflow-y: auto;
      padding-right: 10px;
    }
    
    .menu-item {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 18px;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }
    
    .menu-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .menu-item-name {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    
    .menu-item-price {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .order-section {
      grid-column: 1 / -1;
      margin-top: 25px;
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-radius: 15px;
    }
    
    .order-table-name {
      font-size: 24px;
      font-weight: bold;
    }
    
    .order-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 20px;
    }
    
    .order-item {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .order-item-info {
      flex: 1;
    }
    
    .order-item-name {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
    }
    
    .order-item-details {
      font-size: 13px;
      color: #666;
    }
    
    .order-item-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .btn-qty {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .btn-qty:hover {
      background: #5568d3;
    }
    
    .qty-display {
      font-size: 18px;
      font-weight: bold;
      min-width: 30px;
      text-align: center;
    }
    
    .btn-remove {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .btn-remove:hover {
      background: #ff5252;
    }
    
    .order-summary {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .summary-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 16px;
    }
    
    .summary-row.total {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
      border-top: 2px solid #ddd;
      padding-top: 10px;
      margin-top: 10px;
    }
    
    .discount-section {
      margin-bottom: 20px;
    }
    
    .discount-buttons {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .btn-discount {
      background: #ffc107;
      color: #333;
      border: none;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }
    
    .btn-discount:hover {
      background: #ffb300;
      transform: translateY(-2px);
    }
    
    .action-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 18px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: #6c757d;
      color: white;
      border: none;
      padding: 18px;
      border-radius: 12px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-secondary:hover {
      background: #5a6268;
      transform: translateY(-2px);
    }
    
    .hidden {
      display: none !important;
    }
    
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      padding: 30px;
      border-radius: 20px;
      max-width: 500px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .modal-header {
      font-size: 24px;
      font-weight: bold;
      margin-bottom: 20px;
      color: #333;
    }
    
    .modal-body {
      margin-bottom: 20px;
    }
    
    .modal-footer {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    .topping-option {
      display: flex;
      align-items: center;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 10px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .topping-option:hover {
      background: #e9ecef;
    }
    
    .topping-option input[type="radio"] {
      margin-right: 10px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      font-size: 18px;
      color: #666;
    }
    
    @media (max-width: 1200px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: stretch;
      }
      
      .header-right {
        flex-direction: column;
      }
      
      .sales-summary {
        flex-direction: column;
        gap: 15px;
      }
      
      .tables-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
      
      .menu-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
      
      .action-buttons {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
      <div class="header-left">
        <h1>ğŸ¢ ç²‰ã‚‚ã‚“å±‹ å…« - ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ </h1>
        <div class="status" id="statusText">ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ä¸­...</div>
      </div>
      <div class="header-right">
        <div class="auto-print-toggle">
          <label>è‡ªå‹•å°åˆ·</label>
          <label class="toggle-switch">
            <input type="checkbox" id="autoPrintToggle" checked>
            <span class="toggle-slider"></span>
          </label>
          <span class="toggle-status on" id="toggleStatus">ON</span>
        </div>
        <div class="sales-summary">
          <div class="sales-item">
            <div class="sales-label">æœ¬æ—¥å£²ä¸Š</div>
            <div class="sales-value highlight" id="todaySales">Â¥0</div>
          </div>
          <div class="sales-item">
            <div class="sales-label">æ³¨æ–‡æ•°</div>
            <div class="sales-value" id="orderCount">0</div>
          </div>
        </div>
        <button class="btn-settlement" onclick="showSettlementModal()">ç²¾ç®—</button>
      </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="main-content">
      <!-- ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠ -->
      <div class="section">
        <div class="section-title">ğŸª‘ ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠ</div>
        <div class="tables-grid" id="tablesGrid">
          <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>

      <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
      <div class="section">
        <div class="section-title">ğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼</div>
        <div class="menu-grid" id="menuGrid">
          <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>

      <!-- æ³¨æ–‡ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div class="section order-section hidden" id="orderSection">
        <div class="order-header">
          <div class="order-table-name" id="selectedTableLabel">ãƒ†ãƒ¼ãƒ–ãƒ« æœªé¸æŠ</div>
          <button class="btn-secondary" onclick="clearSelection()">ã‚¯ãƒªã‚¢</button>
        </div>

        <div class="order-list" id="orderList"></div>

        <div class="discount-section">
          <div class="section-title">ğŸ’° å‰²å¼•</div>
          <div class="discount-buttons">
            <button class="btn-discount" onclick="applyDiscount(100)">-Â¥100</button>
            <button class="btn-discount" onclick="applyDiscount(200)">-Â¥200</button>
            <button class="btn-discount" onclick="applyDiscount(500)">-Â¥500</button>
            <button class="btn-discount" onclick="applyDiscount(1000)">-Â¥1000</button>
          </div>
          <button class="btn-secondary" onclick="resetDiscount()" style="width: 100%;">å‰²å¼•ãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <div class="order-summary">
          <div class="summary-row">
            <span>å°è¨ˆ</span>
            <span id="subtotal">Â¥0</span>
          </div>
          <div class="summary-row">
            <span>å‰²å¼•</span>
            <span id="discount">-Â¥0</span>
          </div>
          <div class="summary-row total">
            <span>åˆè¨ˆ</span>
            <span id="total">Â¥0</span>
          </div>
        </div>

        <div class="action-buttons">
          <button class="btn-primary" onclick="processPayment('cash')">ğŸ’´ ç¾é‡‘æ±ºæ¸ˆ</button>
          <button class="btn-primary" onclick="processPayment('card')">ğŸ’³ ã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆ</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="toppingModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’é¸æŠ</div>
      <div class="modal-body" id="toppingOptions"></div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeToppingModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-primary" onclick="confirmTopping()">æ±ºå®š</button>
      </div>
    </div>
  </div>

  <!-- ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="memoModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">ãƒ¡ãƒ¢ - <span id="memoTableName"></span></div>
      <div class="modal-body">
        <textarea id="memoTextarea" style="width: 100%; height: 150px; padding: 10px; border-radius: 8px; border: 1px solid #ddd; font-size: 14px;" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..."></textarea>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeMemoModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn-primary" onclick="saveMemo()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- ãƒ¬ã‚·ãƒ¼ãƒˆå®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="receiptCompleteModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">âœ… æ±ºæ¸ˆå®Œäº†</div>
      <div class="modal-body">
        <p style="font-size: 18px; margin-bottom: 20px;">æ±ºæ¸ˆãŒå®Œäº†ã—ã¾ã—ãŸ</p>
        <div style="display: flex; gap: 10px; flex-direction: column;">
          <button class="btn-primary" onclick="printReceipt()">ğŸ“„ ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·</button>
          <button class="btn-primary" onclick="printCreditReceipt()">ğŸ’³ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·</button>
          <button class="btn-primary" onclick="printInvoice()">ğŸ“‹ é ˜åæ›¸å°åˆ·</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeReceiptModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ç²¾ç®—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="settlementModal" class="modal hidden">
    <div class="modal-content">
      <div class="modal-header">ğŸ’° æœ¬æ—¥ã®ç²¾ç®—</div>
      <div class="modal-body">
        <div class="order-summary">
          <div class="summary-row">
            <span>ç¾é‡‘å£²ä¸Š</span>
            <span id="cashSales">Â¥0</span>
          </div>
          <div class="summary-row">
            <span>ã‚«ãƒ¼ãƒ‰å£²ä¸Š</span>
            <span id="cardSales">Â¥0</span>
          </div>
          <div class="summary-row total">
            <span>åˆè¨ˆå£²ä¸Š</span>
            <span id="totalSales">Â¥0</span>
          </div>
          <div class="summary-row">
            <span>æ³¨æ–‡ä»¶æ•°</span>
            <span id="totalOrders">0ä»¶</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeSettlementModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>

  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let menuItems = [];
    let selectedTable = null;
    let currentOrders = [];
    let discountAmount = 0;
    let currentMenuItem = null;
    let selectedTopping = 'ãªã—';
    let tableMemos = {};
    let autoPrintEnabled = true;
    let lastPaymentData = null;
    let isAuthenticated = false;
    const PRINTER_IP = '192.168.244.41';
    
    // è‡ªå‹•å°åˆ·ãƒˆã‚°ãƒ«
    document.getElementById('autoPrintToggle').addEventListener('change', function() {
      autoPrintEnabled = this.checked;
      const status = document.getElementById('toggleStatus');
      if (this.checked) {
        status.textContent = 'ON';
        status.className = 'toggle-status on';
      } else {
        status.textContent = 'OFF';
        status.className = 'toggle-status off';
      }
    });
    
    // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆasyncã§ä½¿ãˆã‚‹ã‚ˆã†ã«ï¼‰
    function customAlert(message) {
      return new Promise((resolve) => {
        alert(message);
        resolve();
      });
    }
    
    // åˆæœŸåŒ–å‡¦ç†
    async function initialize() {
      console.log('ğŸš€ åˆæœŸåŒ–é–‹å§‹...');
      
      try {
        // èªè¨¼
        const authSuccess = await window.authenticateUser();
        if (!authSuccess) {
          document.getElementById('statusText').textContent = 'âŒ èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸ';
          return;
        }
        
        // æ¥ç¶šãƒ†ã‚¹ãƒˆ
        const connectionSuccess = await window.testFirebaseConnection();
        if (!connectionSuccess) {
          document.getElementById('statusText').textContent = 'âŒ Firebaseæ¥ç¶šã«å¤±æ•—ã—ã¾ã—ãŸ';
          return;
        }
        
        document.getElementById('statusText').textContent = 'âœ… æ¥ç¶šå®Œäº†';
        
        // ãƒ¡ãƒ¢ã‚’localStorageã‹ã‚‰èª­ã¿è¾¼ã¿
        const savedMemos = localStorage.getItem('tableMemos');
        if (savedMemos) {
          tableMemos = JSON.parse(savedMemos);
        }
        
        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        await loadMenuItems();
        await loadTables();
        await updateSalesSummary();
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–é–‹å§‹
        startRealtimeListeners();
        
        console.log('âœ… åˆæœŸåŒ–å®Œäº†');
      } catch (error) {
        console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('statusText').textContent = 'âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼';
      }
    }
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿
    async function loadMenuItems() {
      try {
        console.log('ğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿é–‹å§‹...');
        const q = window.query(window.collection(window.db, 'menuItems'));
        const snapshot = await window.getDocs(q);
        
        menuItems = [];
        snapshot.forEach((doc) => {
          menuItems.push({ id: doc.id, ...doc.data() });
        });
        
        console.log('âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿å®Œäº†:', menuItems.length, 'ä»¶');
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
        const menuGrid = document.getElementById('menuGrid');
        if (menuItems.length === 0) {
          menuGrid.innerHTML = '<div class="loading">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        } else {
          menuGrid.innerHTML = menuItems.map(item => `
            <button class="menu-item" onclick="selectMenuItem('${item.id}')">
              <div class="menu-item-name">${item.name}</div>
              <div class="menu-item-price">Â¥${item.price}</div>
            </button>
          `).join('');
        }
      } catch (error) {
        console.error('âŒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('menuGrid').innerHTML = '<div class="loading">ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
      }
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿
    async function loadTables() {
      try {
        console.log('ğŸª‘ ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿é–‹å§‹...');
        
        // é€šå¸¸ãƒ†ãƒ¼ãƒ–ãƒ«: 1-8
        const normalTables = Array.from({length: 8}, (_, i) => `ãƒ†ãƒ¼ãƒ–ãƒ« ${i + 1}`);
        
        // äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ«: 1-5
        const reservedTables = Array.from({length: 5}, (_, i) => `äºˆç´„ ${i + 1}`);
        
        const allTables = [...normalTables, ...reservedTables];
        
        // å„ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ³¨æ–‡çŠ¶æ³ã‚’å–å¾—
        const tableOrders = {};
        for (const table of allTables) {
          const q = window.query(
            window.collection(window.db, 'orders'),
            window.where('tableNumber', '==', table),
            window.where('status', '==', 'active')
          );
          const snapshot = await window.getDocs(q);
          tableOrders[table] = snapshot.size;
        }
        
        console.log('âœ… ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿å®Œäº†:', allTables.length, 'ä»¶');
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«è¡¨ç¤º
        const tablesGrid = document.getElementById('tablesGrid');
        tablesGrid.innerHTML = allTables.map(table => {
          const orderCount = tableOrders[table] || 0;
          const hasOrder = orderCount > 0;
          const isReserved = table.startsWith('äºˆç´„');
          
          return `
            <button class="table-btn ${hasOrder ? 'has-order' : ''}" 
                    id="table-${table}" 
                    onclick="selectTable('${table}')">
              <span class="memo-icon" onclick="event.stopPropagation(); showMemoModal('${table}')">ğŸ“</span>
              <div>${table}</div>
              ${hasOrder ? `<div class="order-count">${orderCount}ä»¶</div>` : ''}
              ${isReserved ? '<div class="table-status">äºˆç´„å¸­</div>' : ''}
            </button>
          `;
        }).join('');
        
        // ãƒ¡ãƒ¢ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ›´æ–°
        allTables.forEach(table => {
          updateMemoIndicator(table);
        });
        
      } catch (error) {
        console.error('âŒ ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('tablesGrid').innerHTML = '<div class="loading">ãƒ†ãƒ¼ãƒ–ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼</div>';
      }
    }
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ é¸æŠ
    window.selectMenuItem = function(itemId) {
      if (!selectedTable) {
        alert('å…ˆã«ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      const item = menuItems.find(m => m.id === itemId);
      if (!item) return;
      
      currentMenuItem = item;
      
      // ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      showToppingModal(item);
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    function showToppingModal(item) {
      const modal = document.getElementById('toppingModal');
      const optionsContainer = document.getElementById('toppingOptions');
      
      const toppings = ['ãªã—', 'ãƒã‚®', 'ãƒãƒ¨ãƒãƒ¼ã‚º', 'ãƒãƒ¼ã‚º', 'ç‰¹è£½ã‚½ãƒ¼ã‚¹'];
      
      optionsContainer.innerHTML = toppings.map(topping => `
        <label class="topping-option">
          <input type="radio" name="topping" value="${topping}" ${topping === 'ãªã—' ? 'checked' : ''}>
          <span>${topping}</span>
        </label>
      `).join('');
      
      selectedTopping = 'ãªã—';
      
      // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
      optionsContainer.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
          selectedTopping = this.value;
        });
      });
      
      modal.classList.remove('hidden');
    }
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ç¢ºå®š
    window.confirmTopping = function() {
      if (!currentMenuItem) return;
      
      // æ³¨æ–‡ã«è¿½åŠ 
      addToOrder(currentMenuItem, selectedTopping);
      
      closeToppingModal();
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeToppingModal = function() {
      document.getElementById('toppingModal').classList.add('hidden');
      currentMenuItem = null;
      selectedTopping = 'ãªã—';
    };
    
    // æ³¨æ–‡ã«è¿½åŠ 
    function addToOrder(item, topping) {
      const existingIndex = currentOrders.findIndex(
        order => order.id === item.id && order.toppings === topping
      );
      
      if (existingIndex !== -1) {
        currentOrders[existingIndex].quantity++;
      } else {
        currentOrders.push({
          id: item.id,
          name: item.name,
          price: item.price,
          quantity: 1,
          toppings: topping
        });
      }
      
      updateOrderDisplay();
    }
    
    // æ³¨æ–‡è¡¨ç¤ºã‚’æ›´æ–°
    function updateOrderDisplay() {
      const orderList = document.getElementById('orderList');
      
      if (currentOrders.length === 0) {
        orderList.innerHTML = '<div class="loading">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      } else {
        orderList.innerHTML = currentOrders.map((order, index) => `
          <div class="order-item">
            <div class="order-item-info">
              <div class="order-item-name">${order.name}</div>
              <div class="order-item-details">
                ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${order.toppings} | å˜ä¾¡: Â¥${order.price}
              </div>
            </div>
            <div class="order-item-actions">
              <button class="btn-qty" onclick="updateQuantity(${index}, -1)">-</button>
              <span class="qty-display">${order.quantity}</span>
              <button class="btn-qty" onclick="updateQuantity(${index}, 1)">+</button>
              <button class="btn-remove" onclick="removeOrder(${index})">å‰Šé™¤</button>
            </div>
          </div>
        `).join('');
      }
      
      updateSummary();
    }
    
    // æ•°é‡æ›´æ–°
    window.updateQuantity = function(index, delta) {
      if (currentOrders[index]) {
        currentOrders[index].quantity += delta;
        if (currentOrders[index].quantity <= 0) {
          currentOrders.splice(index, 1);
        }
        updateOrderDisplay();
      }
    };
    
    // æ³¨æ–‡å‰Šé™¤
    window.removeOrder = function(index) {
      currentOrders.splice(index, 1);
      updateOrderDisplay();
    };
    
    // ã‚µãƒãƒªãƒ¼æ›´æ–°
    function updateSummary() {
      const subtotalAmount = currentOrders.reduce((sum, order) => sum + (order.price * order.quantity), 0);
      const totalAmount = Math.max(0, subtotalAmount - discountAmount);
      
      document.getElementById('subtotal').textContent = `Â¥${subtotalAmount.toLocaleString()}`;
      document.getElementById('discount').textContent = `-Â¥${discountAmount.toLocaleString()}`;
      document.getElementById('total').textContent = `Â¥${totalAmount.toLocaleString()}`;
    }
    
    // å‰²å¼•é©ç”¨
    window.applyDiscount = function(amount) {
      discountAmount += amount;
      updateSummary();
    };
    
    // å‰²å¼•ãƒªã‚»ãƒƒãƒˆ
    window.resetDiscount = function() {
      discountAmount = 0;
      updateSummary();
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠ
    window.selectTable = async function(tableNum) {
      selectedTable = tableNum;
      document.getElementById('selectedTableLabel').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${tableNum}`;
      
      // å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll('.table-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // é¸æŠã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      const tableBtn = document.getElementById(`table-${tableNum}`);
      if (tableBtn) {
        tableBtn.classList.add('selected');
      }
      
      // äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã®å ´åˆã€ãƒ¡ãƒ¢ã‚’è¡¨ç¤º
      if (tableNum.startsWith('äºˆç´„') && tableMemos[tableNum]) {
        const memoDisplay = document.createElement('div');
        memoDisplay.id = 'tableMemoDisplay';
        memoDisplay.style.cssText = 'background: #fff3cd; padding: 15px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #ffc107;';
        memoDisplay.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 8px; color: #856404;">ğŸ“ äºˆç´„ãƒ¡ãƒ¢</div>
          <div style="white-space: pre-wrap; color: #333;">${tableMemos[tableNum]}</div>
        `;
        
        // æ—¢å­˜ã®ãƒ¡ãƒ¢è¡¨ç¤ºã‚’å‰Šé™¤
        const existingMemo = document.getElementById('tableMemoDisplay');
        if (existingMemo) existingMemo.remove();
        
        // orderSectionã®æœ€åˆã«æŒ¿å…¥
        const orderSection = document.getElementById('orderSection');
        const firstChild = orderSection.firstChild;
        orderSection.insertBefore(memoDisplay, firstChild);
      }
      
      document.getElementById('orderSection').classList.remove('hidden');
      discountAmount = 0;
      
      await loadOrders(tableNum);
    };
    
    // æ³¨æ–‡èª­ã¿è¾¼ã¿
    async function loadOrders(tableNum) {
      try {
        const q = window.query(
          window.collection(window.db, 'orders'),
          window.where('tableNumber', '==', tableNum),
          window.where('status', '==', 'active')
        );
        
        const snapshot = await window.getDocs(q);
        currentOrders = [];
        
        snapshot.forEach((doc) => {
          const data = doc.data();
          data.items.forEach(item => {
            currentOrders.push({
              orderId: doc.id,
              ...item
            });
          });
        });
        
        updateOrderDisplay();
      } catch (error) {
        console.error('æ³¨æ–‡èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // æ±ºæ¸ˆå‡¦ç†
    window.processPayment = async function(paymentMethod) {
      if (!selectedTable || currentOrders.length === 0) {
        await customAlert('æ³¨æ–‡ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
        return;
      }
      
      const subtotalAmount = currentOrders.reduce((sum, order) => sum + (order.price * order.quantity), 0);
      const totalAmount = Math.max(0, subtotalAmount - discountAmount);
      
      if (totalAmount === 0) {
        await customAlert('åˆè¨ˆé‡‘é¡ãŒ0å††ã§ã™');
        return;
      }
      
      try {
        // æ³¨æ–‡ã‚’Firebaseã«ä¿å­˜
        const orderRef = await window.addDoc(window.collection(window.db, 'orders'), {
          tableNumber: selectedTable,
          items: currentOrders.map(order => ({
            id: order.id,
            name: order.name,
            price: order.price,
            quantity: order.quantity,
            toppings: order.toppings || 'ãªã—'
          })),
          subtotal: subtotalAmount,
          discount: discountAmount,
          totalAmount: totalAmount,
          paymentMethod: paymentMethod,
          status: 'completed',
          timestamp: window.Timestamp.now(),
          createdAt: new Date()
        });
        
        // æ±ºæ¸ˆãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        lastPaymentData = {
          orderNumber: orderRef.id,
          orderNumbers: [orderRef.id.substring(0, 8)],
          tableNumber: selectedTable,
          items: currentOrders,
          subtotal: subtotalAmount,
          discount: discountAmount,
          totalAmount: totalAmount,
          paymentMethod: paymentMethod,
          timestamp: new Date()
        };
        
        // è‡ªå‹•å°åˆ·ãŒæœ‰åŠ¹ãªå ´åˆ
        if (autoPrintEnabled) {
          await printReceipt();
        }
        
        // ãƒ¬ã‚·ãƒ¼ãƒˆå®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        document.getElementById('receiptCompleteModal').classList.remove('hidden');
        
        // å£²ä¸Šã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
        await updateSalesSummary();
        
      } catch (error) {
        console.error('æ±ºæ¸ˆã‚¨ãƒ©ãƒ¼:', error);
        await customAlert('æ±ºæ¸ˆå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    };
    
    // ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·
    window.printReceipt = async function() {
      if (!lastPaymentData) {
        await customAlert('å°åˆ·ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: 'ç²‰ã‚‚ã‚“å±‹ å…«\n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createTextElement({data: 'ä¸‹èµ¤å¡šåº—\n'});
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createAlignmentElement({position: 'left'});
        const now = lastPaymentData.timestamp;
        const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        builder.createTextElement({data: `æ—¥æ™‚: ${dateStr}\n`});
        builder.createTextElement({data: `ãƒ†ãƒ¼ãƒ–ãƒ«: ${lastPaymentData.tableNumber}\n`});
        builder.createTextElement({data: `æ³¨æ–‡No: ${lastPaymentData.orderNumbers.join(',')}\n`});
        builder.createRuledLineElement({thickness: 'thin'});
        
        // å•†å“æ˜ç´°
        lastPaymentData.items.forEach(item => {
          const subtotal = item.price * item.quantity;
          builder.createTextElement({data: `${item.name}\n`});
          builder.createTextElement({data: ` @${item.price} x${item.quantity} = ${subtotal.toLocaleString()}å††\n`});
          if (item.toppings && item.toppings !== 'ãªã—') {
            builder.createTextElement({data: ` ãƒˆãƒƒãƒ”ãƒ³ã‚°:${item.toppings}\n`});
          }
        });
        
        builder.createRuledLineElement({thickness: 'medium'});
        builder.createTextElement({data: `å°è¨ˆ: ${lastPaymentData.subtotal.toLocaleString()}å††\n`});
        if (lastPaymentData.discount > 0) {
          builder.createTextElement({data: `å‰²å¼•: -${lastPaymentData.discount.toLocaleString()}å††\n`});
        }
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `åˆè¨ˆ ${lastPaymentData.totalAmount.toLocaleString()}å††\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createRuledLineElement({thickness: 'medium'});
        
        const paymentText = lastPaymentData.paymentMethod === 'cash' ? 'ç¾é‡‘' : 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰';
        builder.createTextElement({data: `æ”¯æ‰•æ–¹æ³•: ${paymentText}\n`});
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({data: '\nã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ\n\n\n'});
        
        builder.createCutPaperElement({feed: true});
        
        const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
        
        const trader = new StarWebPrintTrader({url: url});
        trader.onReceive = function(response) {
          console.log('å°åˆ·æˆåŠŸ:', response);
        };
        trader.onError = function(response) {
          console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', response);
          alert('å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.status);
        };
        
        trader.sendMessage({request: request});
        
      } catch (e) {
        console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        await customAlert('å°åˆ·å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·ï¼ˆ3æšï¼‰
    window.printCreditReceipt = async function() {
      if (!lastPaymentData) {
        await customAlert('å°åˆ·ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      const copyNames = ['åŠ ç›Ÿåº—æ§', 'ãŠå®¢æ§˜æ§', 'åˆ©ç”¨è€…æ§'];
      let printedCount = 0;
      
      for (const copyName of copyNames) {
        try {
          const builder = new StarWebPrintBuilder();
          const request = builder.createInitializationElement();
          
          builder.createPeripheralElement({channel: 1, on: 100, off: 100});
          
          builder.createAlignmentElement({position: 'center'});
          builder.createTextElement({emphasis: true, width: 2, height: 2});
          builder.createTextElement({data: `${copyName}\n`});
          builder.createTextElement({emphasis: false, width: 1, height: 1});
          builder.createRuledLineElement({thickness: 'thin'});
          
          builder.createTextElement({emphasis: true, width: 2, height: 2});
          builder.createTextElement({data: 'ç²‰ã‚‚ã‚“å±‹ å…«\n'});
          builder.createTextElement({emphasis: false, width: 1, height: 1});
          builder.createTextElement({data: 'ä¸‹èµ¤å¡šåº—\n'});
          builder.createRuledLineElement({thickness: 'thin'});
          
          builder.createAlignmentElement({position: 'left'});
          const now = lastPaymentData.timestamp;
          const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2, '0')}`;
          builder.createTextElement({data: `æ—¥æ™‚: ${dateStr}\n`});
          builder.createTextElement({data: `ãƒ†ãƒ¼ãƒ–ãƒ«: ${lastPaymentData.tableNumber}\n`});
          builder.createTextElement({data: `æ³¨æ–‡No: ${lastPaymentData.orderNumbers.join(',')}\n`});
          builder.createRuledLineElement({thickness: 'thin'});
          
          // å•†å“æ˜ç´°
          lastPaymentData.items.forEach(item => {
            const subtotal = item.price * item.quantity;
            builder.createTextElement({data: `${item.name}\n`});
            builder.createTextElement({data: ` @${item.price} x${item.quantity} = ${subtotal.toLocaleString()}å††\n`});
            if (item.toppings && item.toppings !== 'ãªã—') {
              builder.createTextElement({data: ` TP:${item.toppings}\n`});
            }
          });
          
          builder.createRuledLineElement({thickness: 'medium'});
          builder.createTextElement({emphasis: true, width: 2, height: 2});
          builder.createTextElement({data: `åˆè¨ˆ ${lastPaymentData.totalAmount.toLocaleString()}å††\n`});
          builder.createTextElement({emphasis: false, width: 1, height: 1});
          builder.createRuledLineElement({thickness: 'medium'});
          
          builder.createTextElement({data: `æ”¯æ‰•: ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰\n`});
          builder.createRuledLineElement({thickness: 'thin'});
          builder.createAlignmentElement({position: 'center'});
          builder.createTextElement({data: '\nã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ\n\n\n'});
          
          builder.createCutPaperElement({feed: true});
          
          const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
          
          await new Promise((resolve, reject) => {
            const trader = new StarWebPrintTrader({url: url});
            trader.onReceive = function(response) {
              console.log(`${copyName}å°åˆ·æˆåŠŸ:`, response);
              printedCount++;
              resolve();
            };
            trader.onError = function(response) {
              console.error(`${copyName}å°åˆ·ã‚¨ãƒ©ãƒ¼:`, response);
              reject(new Error(`${copyName}ã®å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ`));
            };
            
            trader.sendMessage({request: request});
          });
          
          // å°‘ã—å¾…æ©Ÿï¼ˆãƒ—ãƒªãƒ³ã‚¿ãƒ¼è² è·è»½æ¸›ï¼‰
          await new Promise(resolve => setTimeout(resolve, 500));
          
        } catch (e) {
          console.error(`${copyName}å°åˆ·ã‚¨ãƒ©ãƒ¼:`, e);
        }
      }
      
      await customAlert(`ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰æ±ºæ¸ˆã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’${printedCount}æšå°åˆ·ã—ã¾ã—ãŸ`);
    };
    
    // é ˜åæ›¸å°åˆ·
    window.printInvoice = async function() {
      if (!lastPaymentData) {
        await customAlert('å°åˆ·ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: 'é ˜ å æ›¸\n\n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        builder.createAlignmentElement({position: 'left'});
        const now = lastPaymentData.timestamp;
        const dateStr = `${now.getFullYear()}å¹´${String(now.getMonth()+1).padStart(2,'0')}æœˆ${String(now.getDate()).padStart(2,'0')}æ—¥`;
        builder.createTextElement({data: `${dateStr}\n\n`});
        
        builder.createTextElement({data: 'ãŠå®¢æ§˜\n\n'});
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `Â¥${lastPaymentData.totalAmount.toLocaleString()}-\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createAlignmentElement({position: 'left'});
        builder.createTextElement({data: '\nä¸Šè¨˜æ­£ã«é ˜åã„ãŸã—ã¾ã—ãŸ\n\n'});
        builder.createTextElement({data: 'ä½†ã— é£²é£Ÿä»£ã¨ã—ã¦\n\n\n'});
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createAlignmentElement({position: 'right'});
        builder.createTextElement({data: 'ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—\n'});
        builder.createTextElement({data: 'æ±äº¬éƒ½æ¿æ©‹åŒºèµ¤å¡šæ–°ç”º\n'});
        builder.createTextElement({data: 'TEL: 03-XXXX-XXXX\n\n'});
        
        builder.createAlignmentElement({position: 'right'});
        builder.createTextElement({data: '        â—¯â—¯â—¯\n'});
        builder.createTextElement({data: '       â—¯   â—¯\n'});
        builder.createTextElement({data: '      â—¯  å° â—¯\n'});
        builder.createTextElement({data: '       â—¯   â—¯\n'});
        builder.createTextElement({data: '        â—¯â—¯â—¯\n\n'});
        
        builder.createAlignmentElement({position: 'left'});
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createTextElement({data: `\nãƒ†ãƒ¼ãƒ–ãƒ«: ${lastPaymentData.tableNumber}\n`});
        builder.createTextElement({data: `æ³¨æ–‡No: ${lastPaymentData.orderNumbers.join(',')}\n`});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({data: '\n\n'});
        
        builder.createCutPaperElement({feed: true});
        
        const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
        
        const trader = new StarWebPrintTrader({url: url});
        trader.onReceive = async function(response) {
          console.log('å°åˆ·æˆåŠŸ:', response);
          await customAlert('é ˜åæ›¸ã‚’å°åˆ·ã—ã¾ã—ãŸ');
        };
        trader.onError = async function(response) {
          console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', response);
          await customAlert('å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.status);
        };
        
        trader.sendMessage({request: request});
        
      } catch (e) {
        console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        await customAlert('å°åˆ·å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ãƒ¬ã‚·ãƒ¼ãƒˆå®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeReceiptModal = function() {
      document.getElementById('receiptCompleteModal').classList.add('hidden');
      clearSelection();
    };
    
    // é¸æŠã‚’ã‚¯ãƒªã‚¢
    window.clearSelection = function() {
      selectedTable = null;
      currentOrders = [];
      discountAmount = 0;
      document.getElementById('orderSection').classList.add('hidden');
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«ã®é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
      document.querySelectorAll('.table-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
    };
    
    // ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    window.showMemoModal = function(tableNum) {
      const currentMemoTable = tableNum;
      document.getElementById('memoModal').classList.remove('hidden');
      document.getElementById('memoTableName').textContent = tableNum;
      document.getElementById('memoTextarea').value = tableMemos[tableNum] || '';
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦ä¿å­˜
      window.currentMemoTable = currentMemoTable;
    };
    
    // ãƒ¡ãƒ¢ä¿å­˜
    window.saveMemo = function() {
      const currentMemoTable = window.currentMemoTable;
      if (!currentMemoTable) return;
      
      const memo = document.getElementById('memoTextarea').value;
      tableMemos[currentMemoTable] = memo;
      
      // localStorageã«ä¿å­˜
      localStorage.setItem('tableMemos', JSON.stringify(tableMemos));
      
      // ãƒ¡ãƒ¢ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ›´æ–°
      updateMemoIndicator(currentMemoTable);
      
      alert(`${currentMemoTable}ã®ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
      closeMemoModal();
    };
    
    // ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeMemoModal = function() {
      document.getElementById('memoModal').classList.add('hidden');
      window.currentMemoTable = null;
    };
    
    // ãƒ¡ãƒ¢ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ›´æ–°
    function updateMemoIndicator(tableNum) {
      const btn = document.getElementById(`table-${tableNum}`);
      if (!btn) return;
      
      const hasMemo = tableMemos[tableNum] && tableMemos[tableNum].trim().length > 0;
      const memoIcon = btn.querySelector('.memo-icon');
      
      if (memoIcon) {
        if (hasMemo) {
          memoIcon.style.opacity = '1';
          memoIcon.title = tableMemos[tableNum];
        } else {
          memoIcon.style.opacity = '0.3';
          memoIcon.title = 'ãƒ¡ãƒ¢ã‚’è¿½åŠ ';
        }
      }
    }
    
    // å£²ä¸Šã‚µãƒãƒªãƒ¼æ›´æ–°
    async function updateSalesSummary() {
      try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const q = window.query(
          window.collection(window.db, 'orders'),
          window.where('status', '==', 'completed'),
          window.where('timestamp', '>=', window.Timestamp.fromDate(today))
        );
        
        const snapshot = await window.getDocs(q);
        
        let totalSales = 0;
        let orderCount = 0;
        
        snapshot.forEach((doc) => {
          const data = doc.data();
          totalSales += data.totalAmount || 0;
          orderCount++;
        });
        
        document.getElementById('todaySales').textContent = `Â¥${totalSales.toLocaleString()}`;
        document.getElementById('orderCount').textContent = orderCount;
        
      } catch (error) {
        console.error('å£²ä¸Šã‚µãƒãƒªãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // ç²¾ç®—ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    window.showSettlementModal = async function() {
      try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const q = window.query(
          window.collection(window.db, 'orders'),
          window.where('status', '==', 'completed'),
          window.where('timestamp', '>=', window.Timestamp.fromDate(today))
        );
        
        const snapshot = await window.getDocs(q);
        
        let cashTotal = 0;
        let cardTotal = 0;
        let orderCount = 0;
        
        snapshot.forEach((doc) => {
          const data = doc.data();
          if (data.paymentMethod === 'cash') {
            cashTotal += data.totalAmount || 0;
          } else if (data.paymentMethod === 'card') {
            cardTotal += data.totalAmount || 0;
          }
          orderCount++;
        });
        
        const total = cashTotal + cardTotal;
        
        document.getElementById('cashSales').textContent = `Â¥${cashTotal.toLocaleString()}`;
        document.getElementById('cardSales').textContent = `Â¥${cardTotal.toLocaleString()}`;
        document.getElementById('totalSales').textContent = `Â¥${total.toLocaleString()}`;
        document.getElementById('totalOrders').textContent = `${orderCount}ä»¶`;
        
        document.getElementById('settlementModal').classList.remove('hidden');
        
      } catch (error) {
        console.error('ç²¾ç®—ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        await customAlert('ç²¾ç®—ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };
    
    // ç²¾ç®—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeSettlementModal = function() {
      document.getElementById('settlementModal').classList.add('hidden');
    };
    
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒªã‚¹ãƒŠãƒ¼é–‹å§‹
    function startRealtimeListeners() {
      // æ³¨æ–‡ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
      window.onSnapshot(window.collection(window.db, 'orders'), (snapshot) => {
        loadTables();
        updateSalesSummary();
      });
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', initialize);
  </script>
</body>
</html>
