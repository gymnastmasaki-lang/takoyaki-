<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="robots" content="noindex, nofollow, noarchive">
  <meta name="googlebot" content="noindex, nofollow, noarchive">
  <meta name="bingbot" content="noindex, nofollow, noarchive">
  <title>ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ </title>
  <style>
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
  </style>
  <script src="https://www.star-m.jp/products/s_print/sdk/starwebprinttracer/v1.1.0/StarWebPrintTrader.js"></script>
  <script src="https://www.star-m.jp/products/s_print/sdk/starwebprintbuilder/v1.2.0/StarWebPrintBuilder.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc, doc, Timestamp, onSnapshot, addDoc, orderBy, getDoc, setDoc, limit, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";
    import { getAuth, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);
    const auth = getAuth(app);
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.db = db;
    window.storage = storage;
    window.auth = auth;
    window.signOut = signOut;
    window.storageRef = ref;
    window.uploadBytes = uploadBytes;
    window.getDownloadURL = getDownloadURL;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.updateDoc = updateDoc;
    window.doc = doc;
    window.Timestamp = Timestamp;
    window.onSnapshot = onSnapshot;
    window.addDoc = addDoc;
    window.orderBy = orderBy;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.limit = limit;
    window.deleteDoc = deleteDoc;
    
    // åº—èˆ—åˆ¥ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    window.getStoreCollection = function(collectionName) {
      console.log('ğŸ” POS getStoreCollection:', collectionName, 'currentStoreId:', window.currentStoreId, 'type:', typeof window.currentStoreId);
      if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
        console.warn('åº—èˆ—IDãŒæœªè¨­å®šã®ãŸã‚ã€æ—§ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™');
        // æ—§ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã®ãƒãƒƒãƒ”ãƒ³ã‚°
        const oldPathMap = {
          'menus': 'menu',
          'employees': 'kintai_employees',
          'attendance': 'kintai_attendance'
        };
        const path = oldPathMap[collectionName] || collectionName;
        console.log('  â†’ æ—§ãƒ‘ã‚¹:', path);
        return window.collection(window.db, path);
      }
      console.log('  â†’ æ–°ãƒ‘ã‚¹: stores/' + window.currentStoreId + '/' + collectionName);
      return window.collection(window.db, 'stores', window.currentStoreId, collectionName);
    };
    
    // åº—èˆ—åˆ¥ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ã‚’å–å¾—ã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    window.getStoreDoc = function(collectionName, docId) {
      if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
        console.warn('åº—èˆ—IDãŒæœªè¨­å®šã®ãŸã‚ã€æ—§ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™');
        // æ—§ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã®ãƒãƒƒãƒ”ãƒ³ã‚°
        const oldPathMap = {
          'menus': 'menu',
          'employees': 'kintai_employees',
          'attendance': 'kintai_attendance'
        };
        return window.doc(window.db, oldPathMap[collectionName] || collectionName, docId);
      }
      
      return window.doc(window.db, 'stores', window.currentStoreId, collectionName, docId);
    };
    
    // åˆæœŸåŒ–å®Œäº†ãƒ•ãƒ©ã‚°
    window.firebaseReady = true;
    console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº† (Firestore + Storage)');
    
    // åˆæœŸåŒ–å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œ
    window.dispatchEvent(new Event('firebaseReady'));
    
    // ========== ğŸ“… å–¶æ¥­æ—¥é¸æŠæ©Ÿèƒ½ ==========
    
    // é¸æŠã•ã‚ŒãŸå–¶æ¥­æ—¥ã‚’ä¿å­˜
    window.selectedBusinessDate = null;
    
    // æ—¥ä»˜é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showDateSelectionModal = function() {
      // æœ¬æ—¥ã€æ˜¨æ—¥ã€ä¸€æ˜¨æ—¥ã®æ—¥ä»˜ã‚’è¨ˆç®—ï¼ˆ3æ™‚åŸºæº–ï¼‰
      const now = new Date();
      let today = new Date(now);
      if (now.getHours() < 3) {
        today.setDate(today.getDate() - 1);
      }
      
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);
      
      const dayBeforeYesterday = new Date(today);
      dayBeforeYesterday.setDate(dayBeforeYesterday.getDate() - 2);
      
      // æ—¥ä»˜è¡¨ç¤ºã‚’æ›´æ–°
      document.getElementById('todayDateDisplay').textContent = formatDateJP(today);
      document.getElementById('yesterdayDateDisplay').textContent = formatDateJP(yesterday);
      document.getElementById('dayBeforeYesterdayDateDisplay').textContent = formatDateJP(dayBeforeYesterday);
      
      // ã‚«ã‚¹ã‚¿ãƒ æ—¥ä»˜ã®åˆæœŸå€¤ã‚’æ˜¨æ—¥ã«è¨­å®š
      document.getElementById('customDateInput').value = formatDateISO(yesterday);
      document.getElementById('customDateInput').max = formatDateISO(today);  // æœªæ¥ã®æ—¥ä»˜ã¯é¸æŠä¸å¯
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      document.getElementById('dateSelectionModal').style.display = 'flex';
    };
    
    // å–¶æ¥­æ—¥ã‚’é¸æŠ
    window.selectBusinessDate = function(type) {
      const now = new Date();
      let today = new Date(now);
      if (now.getHours() < 3) {
        today.setDate(today.getDate() - 1);
      }
      
      let selectedDate;
      
      if (type === 'today') {
        selectedDate = today;
      } else if (type === 'yesterday') {
        selectedDate = new Date(today);
        selectedDate.setDate(selectedDate.getDate() - 1);
      } else if (type === 'dayBeforeYesterday') {
        selectedDate = new Date(today);
        selectedDate.setDate(selectedDate.getDate() - 2);
      } else if (type === 'custom') {
        const customInput = document.getElementById('customDateInput').value;
        if (!customInput) {
          alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        selectedDate = new Date(customInput + 'T00:00:00');
      }
      
      // å–¶æ¥­æ—¥ã‚’ä¿å­˜
      window.selectedBusinessDate = formatDateISO(selectedDate);
      sessionStorage.setItem('businessDate', window.selectedBusinessDate);
      
      console.log('ğŸ“… å–¶æ¥­æ—¥é¸æŠ:', window.selectedBusinessDate);
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼ã®å–¶æ¥­æ—¥è¡¨ç¤ºã‚’æ›´æ–°
      updateBusinessDateDisplay();
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
      document.getElementById('dateSelectionModal').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      
      // æ—§UIã‚’éè¡¨ç¤º
      const oldUIContainer = document.getElementById('oldUIContainer');
      if (oldUIContainer) {
        oldUIContainer.style.display = 'none';
      }
      
      console.log('ğŸ“± ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºã—ã¾ã—ãŸ');
      
      // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºã‚’å¾…ã£ã¦ã‹ã‚‰åˆæœŸåŒ–ï¼ˆsetTimeoutã‚’ä½¿ç”¨ï¼‰
      setTimeout(() => {
        console.log('ğŸš€ åˆæœŸåŒ–å‡¦ç†é–‹å§‹');
        
        // ã¾ãšiframeã‚’åˆæœŸåŒ–
        console.log('ğŸ–¼ï¸ iframeåˆæœŸåŒ–ã‚’æœ€å„ªå…ˆã§å®Ÿè¡Œ');
        updateMenuIframe();
        
        // ãã®å¾Œã€ä»–ã®åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
        setTimeout(() => {
          if (window.firebaseReady) {
            // iframeä»¥å¤–ã®åˆæœŸåŒ–å‡¦ç†
            loadStaffList();
            loadReceiptSettings();
            updateInventoryPanel();
            watchInventoryChanges();
            
            // æ–°UIã®åˆæœŸåŒ–
            console.log('ğŸ†• æ–°UIåˆæœŸåŒ–é–‹å§‹');
            initNewUI();
          }
        }, 500);
      }, 300);
    };
    
    // å–¶æ¥­æ—¥è¡¨ç¤ºã‚’æ›´æ–°
    window.updateBusinessDateDisplay = function() {
      if (!window.selectedBusinessDate) return;
      
      const date = new Date(window.selectedBusinessDate + 'T00:00:00');
      const now = new Date();
      let today = new Date(now);
      if (now.getHours() < 3) {
        today.setDate(today.getDate() - 1);
      }
      
      const todayStr = formatDateISO(today);
      
      let displayText;
      if (window.selectedBusinessDate === todayStr) {
        displayText = 'å–¶æ¥­æ—¥: æœ¬æ—¥\n' + formatDateJP(date);
      } else {
        displayText = 'å–¶æ¥­æ—¥:\n' + formatDateJP(date);
      }
      
      // æ”¹è¡Œã‚’<br>ã«å¤‰æ›ã—ã¦HTMLã¨ã—ã¦è¨­å®š
      document.getElementById('businessDateText').innerHTML = displayText.replace(/\n/g, '<br>');
    };
    
    // å–¶æ¥­æ—¥ã‚’å¤‰æ›´
    window.changeDateSelection = function() {
      showDateSelectionModal();
    };
    
    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆæ—¥æœ¬èªï¼‰
    function formatDateJP(date) {
      const year = date.getFullYear();
      const month = date.getMonth() + 1;
      const day = date.getDate();
      const weekday = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
      return `${year}å¹´${month}æœˆ${day}æ—¥ (${weekday})`;
    }
    
    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆISOï¼‰
    function formatDateISO(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
    
    // å–¶æ¥­æ—¥ã‹ã‚‰æ—¥ä»˜æ–‡å­—åˆ—ã‚’å–å¾—ï¼ˆå£²ä¸Šè¨˜éŒ²ç”¨ï¼‰
    window.getBusinessDateString = function() {
      if (window.selectedBusinessDate) {
        return window.selectedBusinessDate;
      }
      
      // é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯æœ¬æ—¥ï¼ˆ3æ™‚åŸºæº–ï¼‰
      const now = new Date();
      let today = new Date(now);
      if (now.getHours() < 3) {
        today.setDate(today.getDate() - 1);
      }
      return formatDateISO(today);
    };
    
    // ========== å–¶æ¥­æ—¥é¸æŠæ©Ÿèƒ½ã“ã“ã¾ã§ ==========
    
    // æ‹…å½“è€…ãƒªã‚¹ãƒˆã¯èªè¨¼å¾Œã«èª­ã¿è¾¼ã‚€
  </script>
  
  <script>
    // ======================================
    // å¤–ç¨å¯¾å¿œ: ä¾¡æ ¼è¨ˆç®—ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    // ======================================
    
    /**
     * å•†å“ã®è¡¨ç¤ºä¾¡æ ¼ã‚’è¨ˆç®—ï¼ˆãŠå®¢æ§˜ãŒè¦‹ã‚‹ä¾¡æ ¼ï¼‰
     */
    function getDisplayPrice(item) {
      const taxType = item.taxType || 'inclusive';
      if (taxType === 'exclusive') {
        return Math.floor(item.price * (1 + (item.taxRate || 10) / 100));
      }
      return item.price;
    }
    
    /**
     * å•†å“ã®ç¨æŠœä¾¡æ ¼ã‚’è¨ˆç®—
     */
    function getPreTaxPrice(item) {
      const taxType = item.taxType || 'inclusive';
      if (taxType === 'exclusive') {
        return item.price;
      }
      return Math.floor(item.price / (1 + (item.taxRate || 10) / 100));
    }
    
    /**
     * å•†å“ã®ç¨é¡ã‚’è¨ˆç®—
     */
    function getTaxAmount(item, quantity = 1) {
      const taxType = item.taxType || 'inclusive';
      const basePrice = item.price + (item.toppingPrice || 0);
      
      // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã«åŸºã¥ã„ã¦é©ç”¨ç¨ç‡ã‚’æ±ºå®š
      const taxRate = getApplicableTaxRate(item, currentTableSettings);
      
      if (taxType === 'exclusive') {
        return Math.floor(basePrice * quantity * taxRate / 100);
      } else {
        const totalWithTax = basePrice * quantity;
        const totalWithoutTax = Math.floor(totalWithTax / (1 + taxRate / 100));
        return totalWithTax - totalWithoutTax;
      }
    }
    
    /**
     * å•†å“ã®åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—ï¼ˆãŠå®¢æ§˜æ”¯æ‰•ã„é¡ï¼‰
     */
    function getItemTotal(item, quantity = 1) {
      const taxType = item.taxType || 'inclusive';
      const basePrice = item.price + (item.toppingPrice || 0);
      
      // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã«åŸºã¥ã„ã¦é©ç”¨ç¨ç‡ã‚’æ±ºå®š
      const taxRate = getApplicableTaxRate(item, currentTableSettings);
      
      if (taxType === 'exclusive') {
        return Math.floor(basePrice * quantity * (1 + taxRate / 100));
      }
      return basePrice * quantity;
    }
    
    /**
     * æ³¨æ–‡å…¨ä½“ã®åˆè¨ˆã‚’è¨ˆç®—
     */
    function calculateOrderTotals(items) {
      let total = 0;
      let tax8Total = 0;
      let tax10Total = 0;
      let tax8Inclusive = 0;
      let tax10Inclusive = 0;
      let tax8Exclusive = 0;
      let tax10Exclusive = 0;
      
      items.forEach(item => {
        const quantity = item.quantity || 1;
        const itemTotal = getItemTotal(item, quantity);
        const itemTax = getTaxAmount(item, quantity);
        const taxType = item.taxType || 'inclusive';
        
        // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã«åŸºã¥ã„ã¦é©ç”¨ç¨ç‡ã‚’æ±ºå®š
        const applicableTaxRate = getApplicableTaxRate(item, currentTableSettings);
        
        total += itemTotal;
        
        if (applicableTaxRate === 8) {
          tax8Total += itemTax;
          if (taxType === 'exclusive') {
            tax8Exclusive += itemTax;
          } else {
            tax8Inclusive += itemTax;
          }
        } else {
          tax10Total += itemTax;
          if (taxType === 'exclusive') {
            tax10Exclusive += itemTax;
          } else {
            tax10Inclusive += itemTax;
          }
        }
      });
      
      return {
        total,
        tax8Total,
        tax10Total,
        tax8Inclusive,
        tax10Inclusive,
        tax8Exclusive,
        tax10Exclusive
      };
    }
    
    // æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€ï¼ˆkanri.htmlã®å¾“æ¥­å“¡ãƒªã‚¹ãƒˆã‹ã‚‰ï¼‰
    async function loadStaffList() {
      try {
        const staffSelect = document.getElementById('staffSelect');
        if (!staffSelect) return;
        
        console.log('ğŸ“‹ æ‹…å½“è€…ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹');
        console.log('   window.currentStoreId:', window.currentStoreId);
        console.log('   window.currentStoreName:', window.currentStoreName);
        
        // åº—èˆ—åˆ¥ã®å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        const employeesRef = window.getStoreCollection('employees');
        console.log('   employeesRef:', employeesRef);
        
        const staffSnapshot = await getDocs(employeesRef);
        console.log('   å–å¾—ã—ãŸå¾“æ¥­å“¡æ•°:', staffSnapshot.size);
        
        // ãƒªã‚»ãƒƒãƒˆ
        staffSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
        
        // å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«å¤‰æ›
        const employees = [];
        staffSnapshot.forEach(doc => {
          const empData = { id: doc.id, ...doc.data() };
          console.log('   å¾“æ¥­å“¡:', empData.name, '(ID:', doc.id + ')');
          employees.push(empData);
        });
        
        if (employees.length === 0) {
          console.warn('âš ï¸ å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼');
          console.warn('   ç¢ºèªã—ã¦ãã ã•ã„: Firestore ã®', window.currentStoreId ? `stores/${window.currentStoreId}/employees` : 'kintai_employees');
        }
        
        // sortOrderã§ã‚½ãƒ¼ãƒˆï¼ˆkanri.htmlã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        employees.sort((a, b) => {
          if (a.sortOrder !== undefined && b.sortOrder !== undefined) {
            return a.sortOrder - b.sortOrder;
          }
          if (a.sortOrder !== undefined) return -1;
          if (b.sortOrder !== undefined) return 1;
          return (a.name || '').localeCompare(b.name || '');
        });
        
        // ã‚½ãƒ¼ãƒˆæ¸ˆã¿ã®å¾“æ¥­å“¡ãƒªã‚¹ãƒˆã‚’ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«è¿½åŠ 
        employees.forEach(emp => {
          const option = document.createElement('option');
          option.value = emp.name || '';
          option.textContent = emp.name || '';
          staffSelect.appendChild(option);
        });
        
        console.log('âœ… æ‹…å½“è€…ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿å®Œäº† (sortOrderé †) - åº—èˆ—:', window.currentStoreName);
        console.log('   è¿½åŠ ã—ãŸå¾“æ¥­å“¡æ•°:', employees.length);
      } catch (e) {
        console.error('âŒ æ‹…å½“è€…ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    /**
     * ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’å–å¾—
     */
    async function getTableSettings(tableId) {
      if (!tableId) {
        return null;
      }
      
      try {
        const tableSettingsRef = window.getStoreDoc('tableSettings', tableId);
        const tableDoc = await getDoc(tableSettingsRef);
        
        if (tableDoc.exists()) {
          return tableDoc.data();
        }
        return null;
      } catch (e) {
        console.error('ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        return null;
      }
    }
    
    /**
     * ğŸ†• å•†å“ã®é©ç”¨ç¨ç‡ã‚’æ±ºå®šï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã¨foodTypeã‚’è€ƒæ…®ï¼‰
     * ğŸ”¥ æ”¹å–„: ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šï¼ˆtakeout/dine-inï¼‰ãŒæœ‰åŠ¹ãªå ´åˆã€å•†å“ã®taxRateã‚ˆã‚Šã‚‚foodTypeã‚’å„ªå…ˆ
     */
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡è¨­å®š
    let globalDefaultTaxRate = 10;  // åˆæœŸå€¤ã¯10%
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡è¨­å®šã‚’Firebaseã‹ã‚‰èª­ã¿è¾¼ã‚€
    async function loadDefaultTaxRateSettings() {
      try {
        const settingsRef = window.getStoreDoc('settings', 'defaultTaxRate');
        const settingsDoc = await window.getDoc(settingsRef);
        
        if (settingsDoc.exists()) {
          const data = settingsDoc.data();
          globalDefaultTaxRate = data.rate || 10;
          console.log(`âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: ${globalDefaultTaxRate}%`);
        } else {
          console.log(`âš ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚10%ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`);
        }
      } catch (error) {
        console.error('âŒ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡è¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        globalDefaultTaxRate = 10;
      }
    }
    
    function getApplicableTaxRate(item, tableSettings) {
      // ğŸ”¥ ç‰¹åˆ¥å‡¦ç†: ãƒ¬ã‚¸è¢‹ã¯å¸¸ã«10%ï¼ˆæœ€å„ªå…ˆï¼‰
      if (item.name?.includes('ãƒ¬ã‚¸è¢‹') || item.name?.includes('ğŸ›ï¸') || item.name?.includes('è¢‹')) {
        console.log(`ğŸ”¥ ãƒ¬ã‚¸è¢‹åˆ¤å®š: ${item.name} â†’ å¼·åˆ¶çš„ã«10%`);
        return 10;
      }
      
      // ğŸ†• foodTypeã‚’æ±ºå®šï¼ˆæœªè¨­å®šã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§'food'ï¼‰
      let foodType = item.foodType || 'food';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é£Ÿæ
      if (!item.foodType) {
        // ã‚«ãƒ†ã‚´ãƒªãŒã€ŒåŒ…æã€ã¾ãŸã¯å•†å“åã«ã€ŒåŒ…æã€ã€Œãƒ¬ã‚¸è¢‹ã€ã‚’å«ã‚€å ´åˆã¯é£Ÿæä»¥å¤–
        if (item.category === 'åŒ…æ' || item.name?.includes('åŒ…æ') || item.name?.includes('ãƒ¬ã‚¸è¢‹') || item.name?.includes('ğŸ›ï¸') || item.name?.includes('è¢‹')) {
          foodType = 'non-food';
          console.log(`âš ï¸ foodTypeæœªè¨­å®š â†’ category/name(${item.category}/${item.name})ã‹ã‚‰æ¨æ¸¬: non-foodï¼ˆé£Ÿæä»¥å¤–ï¼‰`);
        } else {
          console.log(`âš ï¸ foodTypeæœªè¨­å®š â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: foodï¼ˆé£Ÿæï¼‰, å•†å“å: ${item.name}`);
        }
      } else {
        console.log(`âœ… foodTypeè¨­å®šæ¸ˆã¿: ${foodType} (å•†å“: ${item.name})`);
      }
      
      // ğŸ”¥ æ”¹å–„: ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãŒæœ‰åŠ¹ï¼ˆtakeout/dine-inï¼‰ãªå ´åˆã€foodTypeã‚’å„ªå…ˆ
      if (tableSettings && tableSettings.taxRule && tableSettings.taxRule !== 'none') {
        const taxRule = tableSettings.taxRule;
        console.log(`[ç¨ç‡æ±ºå®š] å•†å“: ${item.name}, foodType: ${foodType}, taxRule: ${taxRule}`);
        
        switch(taxRule) {
          case 'takeout':
            // ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ: é£Ÿæã¯8%ã€é£Ÿæä»¥å¤–ã¯10%
            const takeoutRate = (foodType === 'food') ? 8 : 10;
            console.log(`  â†’ ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆãƒ¢ãƒ¼ãƒ‰: ${foodType === 'food' ? 'é£Ÿæ(8%)' : 'é£Ÿæä»¥å¤–(10%)'} = ${takeoutRate}%`);
            return takeoutRate;
          
          case 'dine-in':
            // åº—å†…é£²é£ŸåŠã³é£Ÿæä»¥å¤–: å…¨éƒ¨10%
            console.log(`  â†’ åº—å†…é£²é£ŸåŠã³é£Ÿæä»¥å¤–ãƒ¢ãƒ¼ãƒ‰: 10%`);
            return 10;
          
          default:
            // ä¸æ˜ãªtaxRule: å•†å“ã®taxRateã‚’å„ªå…ˆã€æœªè¨­å®šãªã‚‰foodTypeã‹ã‚‰æ¨æ¸¬
            if (item.taxRate !== undefined && item.taxRate !== null) {
              console.log(`  â†’ ä¸æ˜ãªtaxRule: ${taxRule} â†’ å•†å“ã®taxRate: ${item.taxRate}%`);
              return item.taxRate;
            }
            const defaultRate = (foodType === 'non-food') ? globalDefaultTaxRate : 8;
            console.log(`  â†’ ä¸æ˜ãªtaxRule: ${taxRule}, taxRateæœªè¨­å®š â†’ foodType(${foodType})ã‹ã‚‰: ${defaultRate}%`);
            return defaultRate;
        }
      }
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãŒãªã„ã€ã¾ãŸã¯taxRuleãŒ'none'ã®å ´åˆã¯å•†å“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡ã‚’ä½¿ç”¨
      // å•†å“ã®taxRateã‚’å„ªå…ˆä½¿ç”¨
      if (item.taxRate !== undefined && item.taxRate !== null) {
        console.log(`[ç¨ç‡æ±ºå®š] ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãªã— â†’ å•†å“ã®taxRate: ${item.taxRate}%`);
        return item.taxRate;
      }
      
      // taxRateãŒãªã„å ´åˆã€foodTypeã‹ã‚‰æ¨æ¸¬ï¼ˆé£Ÿæ:8%, é£Ÿæä»¥å¤–:10%ï¼‰
      const inferredRate = (foodType === 'non-food') ? 10 : 8;
      console.log(`[ç¨ç‡æ±ºå®š] ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãªã—ã€taxRateæœªè¨­å®š â†’ foodType(${foodType})ã‹ã‚‰æ¨æ¸¬: ${inferredRate}%`);
      return inferredRate;
    }
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      background: linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%);
      min-height: 100vh;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }
    
    .container {
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    
    /* å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ */
    .sidebar {
      width: 200px;
      background: white;
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding-top: 15px;
    }
    
    .sidebar-section {
      padding: 15px 10px;
      border-bottom: 1px solid #eee;
    }
    
    .sidebar-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 8px;
      font-weight: bold;
    }
    
    .sidebar-button {
      width: 100%;
      padding: 18px 10px;
      margin-bottom: 8px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.3s;
      text-align: center;
    }
    
    .sidebar-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }
    
    /* ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .header {
      background: white;
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
    }
    
    .header-left h1 {
      font-size: 32px;
      color: #333;
      margin-bottom: 5px;
    }
    
    .header-left .status {
      font-size: 18px;
      color: #666;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .header-right {
      display: flex;
      align-items: flex-start;
      gap: 15px;
    }
    
    .auto-print-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f8f9fa;
      padding: 12px 20px;
      border-radius: 12px;
    }
    
    .auto-print-toggle label {
      font-weight: bold;
      color: #333;
    }
    
    .toggle-switch {
      position: relative;
      width: 60px;
      height: 30px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 30px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: #4CAF50;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(30px);
    }
    
    .toggle-status {
      font-weight: bold;
      min-width: 50px;
    }
    
    .toggle-status.on {
      color: #4CAF50;
    }
    
    .toggle-status.off {
      color: #999;
    }
    
    .main-content {
      display: flex;
      flex-direction: column;
      gap: 25px;
    }
    
    @media (max-width: 1024px) {
      .main-content {
        flex-direction: column;
      }
      
      .header {
        flex-direction: column;
        gap: 15px;
      }
    }
    
    .section {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚¨ãƒªã‚¢ï¼ˆæ–°UIï¼‰ */
    .tables-area {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: #f5f5f5;
    }
    
    .tables-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .table-card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 3px solid transparent;
      position: relative;
      min-height: 120px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    
    .table-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
      border-color: #667eea;
    }
    
    .table-card.selected {
      border-color: #667eea;
      background: linear-gradient(135deg, #e8eaf6 0%, #c5cae9 100%);
    }
    
    .table-card.has-orders {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      border-color: #ff9800;
    }
    
    .table-card.has-orders .table-name {
      color: #e65100;
    }
    
    .table-card.has-pending-orders {
      background: linear-gradient(135deg, #fff4e6 0%, #ffe0b2 100%);
      border: 2px solid #ff9800;
    }
    
    .table-card.has-pending-orders .table-name {
      color: #f57c00;
    }
    
    .table-card.has-pending-orders .pending-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ff9800;
      color: white;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
    }
    
    .status-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 10px;
      padding: 4px 8px;
      border-radius: 12px;
      font-weight: bold;
    }
    
    .unpaid-badge {
      background: #f57c00;
      color: white;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.7;
      }
    }
    
    .table-name {
      font-size: 14px !important;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    .table-order-count {
      font-size: 14px;
      color: #666;
      background: #f0f0f0;
      padding: 5px 12px;
      border-radius: 12px;
      margin-top: 8px;
    }
    
    .table-card.has-orders .table-order-count {
      background: #ff9800;
      color: white;
      font-weight: bold;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°ã‚¨ãƒªã‚¢ï¼ˆé¸æŠå¾Œï¼‰ */
    .table-detail-area {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      background: white;
      display: none;
    }
    
    .table-detail-area.show {
      display: block;
    }
    
    .table-detail-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #667eea;
    }
    
    .table-detail-title {
      font-size: 28px;
      font-weight: bold;
      color: #333;
    }
    
    .table-actions {
      display: flex;
      gap: 10px;
    }
    
    .action-btn {
      padding: 15px 30px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .action-btn.order {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    .action-btn.payment {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
    }
    
    .action-btn.back {
      background: #e0e0e0;
      color: #333;
    }
    
    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.2);
    }
    
    /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼iframeã‚³ãƒ³ãƒ†ãƒŠ */
    .menu-iframe-container {
      display: none;
      position: fixed;
      top: 0;
      left: 200px;
      right: 0;
      bottom: 0;
      background: white;
      z-index: 1000;
      overflow: hidden;
    }
    
    .menu-iframe-container.show {
      display: flex;
      flex-direction: column;
    }
    
    .menu-iframe-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .menu-iframe-title {
      font-size: 20px;
      font-weight: bold;
    }
    
    .menu-iframe-close {
      background: white;
      color: #667eea;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .menu-iframe-close:hover {
      transform: scale(1.05);
      box-shadow: 0 4px 12px rgba(255,255,255,0.3);
    }
    
    .menu-iframe-content {
      flex: 1;
      display: flex;
      overflow: hidden;
    }
    
    .menu-iframe-left {
      flex: 1;
      overflow: hidden;
    }
    
    .menu-iframe-right {
      width: 400px;
      background: #f5f5f5;
      padding: 20px;
      overflow-y: auto;
      border-left: 2px solid #ddd;
    }
    
    .section h2 {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #667eea;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚°ãƒªãƒƒãƒ‰ */
    .table-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }
    
    @media (max-width: 768px) {
      .table-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    .table-btn {
      padding: 10px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      position: relative;
      min-height: 50px;
    }
    
    .table-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    .table-btn:active {
      transform: translateY(0);
    }
    
    .table-btn.has-orders {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
    }
    
    .order-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ff4444;
      color: white;
      font-size: 12px;
      font-weight: bold;
      min-width: 24px;
      height: 24px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
      animation: pulse 1.5s infinite;
      box-shadow: 0 2px 8px rgba(255, 68, 68, 0.5);
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }
    
    /* æ³¨æ–‡è©³ç´° */
    .order-details {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .order-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-left: 5px solid #667eea;
    }
    
    .order-card.completed {
      border-left-color: #4CAF50;
      opacity: 0.7;
    }
    
    .order-card.cancelled {
      border-left-color: #f44336;
      opacity: 0.7;
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .order-number {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    
    .order-time {
      font-size: 14px;
      color: #999;
    }
    
    .order-status {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      margin-left: 10px;
    }
    
    .order-status.pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .order-status.completed {
      background: #d4edda;
      color: #155724;
    }
    
    .order-status.cancelled {
      background: #f8d7da;
      color: #721c24;
    }
    
    .order-items {
      margin: 15px 0;
    }
    
    .order-item {
      padding: 10px 0;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .order-item:last-child {
      border-bottom: none;
    }
    
    .order-item-detailed {
      padding: 15px;
      margin-bottom: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }
    
    .item-name {
      font-weight: 500;
      color: #333;
    }
    
    .item-details {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    
    .item-price {
      font-weight: bold;
      color: #667eea;
    }
    
    .order-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 3px solid #667eea;
      font-size: 24px;
      font-weight: bold;
    }
    
    .total-label {
      color: #333;
    }
    
    .total-amount {
      color: #667eea;
      font-size: 28px;
    }
    
    /* æ³¨æ–‡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    .order-actions {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 2px dashed #ddd;
    }
    
    .order-action-btn {
      padding: 12px;
      font-size: 14px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .order-action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .pay-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .complete-btn {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    .cancel-btn {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
    }
    
    .delete-btn {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
    }
    
    /* ãƒœã‚¿ãƒ³ */
    .btn {
      width: 100%;
      padding: 18px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      margin: 8px 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
      color: white;
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* æ‰‹å‹•å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .manual-input {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-group label {
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }
    
    .input-group input,
    .input-group select {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      transition: border-color 0.3s;
    }
    
    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .menu-items-list {
      max-height: 300px;
      overflow-y: auto;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      background: white;
    }
    
    .menu-item-checkbox {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .menu-item-checkbox:hover {
      background: #f0f0f0;
    }
    
    .menu-item-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      cursor: pointer;
    }
    
    .menu-item-info {
      flex: 1;
    }
    
    .menu-item-name-small {
      font-weight: 500;
      color: #333;
    }
    
    .menu-item-price-small {
      color: #667eea;
      font-weight: bold;
    }
    
    .selected-items {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .selected-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .selected-item-detailed {
      padding: 15px;
      margin-bottom: 15px;
      background: #f8f9fa;
      border-radius: 10px;
      border-left: 4px solid #667eea;
    }
    
    .quantity-input {
      width: 60px;
      padding: 5px;
      text-align: center;
      border: 2px solid #ddd;
      border-radius: 5px;
    }
    
    .remove-btn {
      padding: 5px 12px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .edit-btn {
      padding: 5px 12px;
      background: #FF9800;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .edit-btn:hover {
      background: #F57C00;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 18px;
    }
    
    /* æ”¯æ‰•ã„æ–¹æ³•é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    }
    
    .modal h3 {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .payment-methods {
      display: grid;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .payment-method-btn {
      padding: 20px;
      font-size: 20px;
      font-weight: bold;
      border: 3px solid #ddd;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .payment-method-btn:hover {
      border-color: #667eea;
      background: #f8f9fa;
    }
    
    .payment-method-btn.selected {
      border-color: #667eea;
      background: #e8eaf6;
    }
    
    .cash-input-section {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    
    .cash-input-section label {
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
      font-size: 18px;
    }
    
    .cash-input-section input {
      width: 100%;
      padding: 15px;
      font-size: 24px;
      border: 2px solid #ddd;
      border-radius: 8px;
      text-align: right;
    }
    
    .change-display {
      margin-top: 15px;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    
    .change-amount {
      color: #4CAF50;
      font-size: 28px;
    }
    
    /* ãƒ¬ã‚·ãƒ¼ãƒˆå®Œäº†ç”»é¢ */
    .receipt-actions {
      display: grid;
      gap: 15px;
      margin-top: 20px;
    }
    
    .receipt-btn {
      padding: 20px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .receipt-btn.print {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
    }
    
    .receipt-btn.invoice {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
    }
    
    .receipt-btn.back {
      background: #e0e0e0;
      color: #333;
    }
    
    /* ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠ */
    .topping-item {
      display: flex;
      align-items: center;
      padding: 15px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .topping-item:hover {
      border-color: #667eea;
      transform: translateX(5px);
    }
    
    .topping-item input[type="checkbox"] {
      width: 24px;
      height: 24px;
      margin-right: 15px;
      cursor: pointer;
    }
    
    .topping-item-info {
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .topping-item-name {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
    
    .topping-item-price {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
    }
    
    .hidden {
      display: none !important;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    /* ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆ */
    .custom-alert-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 99999;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.3s;
    }
    .custom-alert-overlay.show {
      display: flex;
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .custom-alert-box {
      background: white;
      border-radius: 25px;
      padding: 40px 30px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      animation: slideUp 0.4s;
    }
    .custom-alert-icon {
      font-size: 80px;
      margin-bottom: 20px;
      animation: bounce 0.6s;
    }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }
    .custom-alert-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
    }
    .custom-alert-message {
      font-size: 16px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.5;
      white-space: pre-wrap;
    }
    .custom-alert-button {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border: none;
      padding: 15px 50px;
      font-size: 18px;
      font-weight: bold;
      border-radius: 25px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
      transition: all 0.3s;
    }
    .custom-alert-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
    }
    .custom-alert-button:active {
      transform: translateY(0);
    }
    
    /* å“åˆ‡ã‚Œãƒšãƒ¼ã‚¸ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .soldout-item {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .soldout-item.sold-out {
      background: #f5f5f5;
      opacity: 0.7;
    }
    .soldout-item-name {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
    .soldout-badge {
      background: #f44336;
      color: white;
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: bold;
      margin-top: 5px;
      display: inline-block;
    }
    .soldout-toggle-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      color: white;
    }
    .soldout-toggle-btn.set-soldout {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
    }
    .soldout-toggle-btn.set-available {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    }
    
    /* ãƒˆãƒ¼ã‚¹ãƒˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
    
    /* ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */
    .custom-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(5px);
      z-index: 10000;
      align-items: center;
      justify-content: center;
    }
    
    .custom-modal-box {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 450px;
      width: 90%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      animation: modalSlideIn 0.3s ease-out;
    }
    
    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }
    
    .modal-icon {
      font-size: 64px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 15px;
      color: #333;
    }
    
    .modal-message {
      text-align: center;
      font-size: 16px;
      color: #666;
      margin-bottom: 30px;
      line-height: 1.6;
    }
    
    .modal-buttons {
      display: flex;
      gap: 15px;
    }
    
    .modal-btn {
      flex: 1;
      padding: 18px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .modal-btn:active {
      transform: scale(0.95);
    }
    
    .modal-btn-cancel {
      background: #e0e0e0;
      color: #333;
    }
    
    .modal-btn-cancel:hover {
      background: #d0d0d0;
    }
    
    .modal-btn-danger {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
    }
    
    .modal-btn-warning {
      background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
      color: white;
    }
    
    .modal-btn-success {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
  </style>
  
  <script>
    // ã‚¿ãƒƒãƒ—éŸ³ã‚’å†ç”Ÿã™ã‚‹é–¢æ•°
    function playBeep() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800; // 800Hzã®ãƒ“ãƒ¼ãƒ—éŸ³
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    }
    
    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã«ãƒ“ãƒ¼ãƒ—éŸ³ã‚’è¿½åŠ 
    document.addEventListener('DOMContentLoaded', function() {
      document.addEventListener('click', function(e) {
        // ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ãªå…¨ã¦ã®è¦ç´ ã«ã‚¿ãƒƒãƒ—éŸ³ã‚’é©ç”¨
        if (e.target.closest('button') || 
            e.target.closest('.table-btn') || 
            e.target.closest('.table-card') || 
            e.target.closest('.menu-item-checkbox') || 
            e.target.closest('.topping-item') ||
            e.target.closest('.sidebar-button') ||
            e.target.closest('.action-btn') ||
            e.target.closest('.payment-method-btn') ||
            e.target.closest('.receipt-btn') ||
            e.target.closest('a') ||
            e.target.closest('[onclick]') ||
            e.target.type === 'checkbox' ||
            e.target.type === 'radio') {
          playBeep();
        }
      });
    });
  </script>
</head>
<body>
  
  <div id="loginScreen" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
    <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
      <div style="text-align: center; margin-bottom: 30px;">
        <div style="font-size: 60px; margin-bottom: 10px;">ğŸ”</div>
        <h2 style="font-size: 24px; font-weight: bold; color: #333; margin: 0;">POSã‚·ã‚¹ãƒ†ãƒ </h2>
        <p style="color: #666; margin-top: 10px;">åº—èˆ—æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
      </div>
      
      <form id="posLoginForm" style="margin: 0;">
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #333; font-weight: bold; margin-bottom: 8px; font-size: 14px;">åº—èˆ—å</label>
          <input
            type="text"
            id="posStoreNameInput"
            placeholder="åº—èˆ—åã‚’å…¥åŠ›"
            style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box;"
            required
            autofocus
          />
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #333; font-weight: bold; margin-bottom: 8px; font-size: 14px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input
            type="password"
            id="posPasswordInput"
            placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›"
            style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box;"
            required
          />
        </div>
        
        <button
          type="submit"
          style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s;"
          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 30px rgba(102,126,234,0.4)';"
          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';"
        >
          ãƒ­ã‚°ã‚¤ãƒ³
        </button>
      </form>
      
      <div id="loginError" style="display: none; margin-top: 20px; padding: 15px; background: #fee; border: 1px solid #fcc; border-radius: 10px; color: #c00; text-align: center; font-weight: bold;">
      </div>
    </div>
  </div>
  
  <!-- ğŸ“… æ—¥ä»˜é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="dateSelectionModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 500px; width: 90%;">
      <div style="text-align: center; margin-bottom: 30px;">
        <div style="font-size: 60px; margin-bottom: 10px;">ğŸ“…</div>
        <h2 style="font-size: 28px; font-weight: bold; color: #333; margin: 0;">å–¶æ¥­æ—¥ã‚’é¸æŠ</h2>
        <p style="color: #666; margin-top: 10px;">æœ¬æ—¥ã¾ãŸã¯éå»ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
      </div>
      
      <div style="display: flex; flex-direction: column; gap: 15px;">
        <!-- æœ¬æ—¥ãƒœã‚¿ãƒ³ -->
        <button onclick="selectBusinessDate('today')" style="padding: 20px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(76,175,80,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(76,175,80,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(76,175,80,0.3)';">
          âœ… æœ¬æ—¥ <span id="todayDateDisplay" style="font-size: 16px; opacity: 0.9;"></span>
        </button>
        
        <!-- æ˜¨æ—¥ãƒœã‚¿ãƒ³ -->
        <button onclick="selectBusinessDate('yesterday')" style="padding: 20px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(33,150,243,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(33,150,243,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(33,150,243,0.3)';">
          ğŸ“† æ˜¨æ—¥ <span id="yesterdayDateDisplay" style="font-size: 16px; opacity: 0.9;"></span>
        </button>
        
        <!-- ä¸€æ˜¨æ—¥ãƒœã‚¿ãƒ³ -->
        <button onclick="selectBusinessDate('dayBeforeYesterday')" style="padding: 20px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 12px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s; box-shadow: 0 4px 15px rgba(255,152,0,0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(255,152,0,0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255,152,0,0.3)';">
          ğŸ“… ä¸€æ˜¨æ—¥ <span id="dayBeforeYesterdayDateDisplay" style="font-size: 16px; opacity: 0.9;"></span>
        </button>
        
        <!-- ã‚«ã‚¹ã‚¿ãƒ æ—¥ä»˜ -->
        <div style="margin-top: 10px;">
          <label style="display: block; color: #333; font-weight: bold; margin-bottom: 8px; font-size: 14px;">ãã®ä»–ã®æ—¥ä»˜</label>
          <div style="display: flex; gap: 10px;">
            <input type="date" id="customDateInput" style="flex: 1; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px;" />
            <button onclick="selectBusinessDate('custom')" style="padding: 15px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer;">é¸æŠ</button>
          </div>
        </div>
      </div>
      
      <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffc107; border-radius: 10px; font-size: 14px; color: #856404;">
        <strong>âš ï¸ æ³¨æ„:</strong> éå»ã®æ—¥ä»˜ã‚’é¸æŠã™ã‚‹ã¨ã€ãã®æ—¥ã®å£²ä¸Šã¨ã—ã¦è¨˜éŒ²ã•ã‚Œã¾ã™
      </div>
    </div>
  </div>
  
  <div id="mainContent" style="display: none;">
  <!-- æ–°ã—ã„UIæ§‹é€  -->
  <div class="container">
    <!-- å·¦ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <div class="sidebar">
      
      <!-- å–¶æ¥­æ—¥è¡¨ç¤º -->
      <div class="sidebar-section">
        <div class="sidebar-label">å–¶æ¥­æ—¥</div>
        <div id="sidebarBusinessDate" onclick="changeDateSelection()" style="padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-weight: bold; font-size: 13px; cursor: pointer; line-height: 1.4; text-align: center;">
          <span id="sidebarBusinessDateText">èª­ã¿è¾¼ã¿ä¸­...</span>
        </div>
      </div>
      
      <!-- æ‹…å½“è€…é¸æŠ -->
      <div class="sidebar-section">
        <div class="sidebar-label">æ‹…å½“è€…</div>
        <select id="sidebarStaffSelect" style="width: 100%; padding: 10px; font-size: 14px; border: 2px solid #667eea; border-radius: 8px; background: white; cursor: pointer;">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
        </select>
      </div>
      
      <!-- ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
      <div class="sidebar-section">
        <button class="sidebar-button" onclick="window.location.href='https://gymnastmasaki-lang.github.io/takoyaki-/kintai.html'">
          <span>å‹¤æ€ </span>
        </button>
        <button class="sidebar-button" id="salesMenuBtn" onclick="toggleSalesMenu()">
          <span>å£²ä¸Šãƒ»å±¥æ­´</span>
        </button>
        <!-- å£²ä¸Šã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div id="salesSubMenu" style="display: none; padding-left: 10px;">
          <button class="sidebar-button" onclick="showSalesModal()" style="font-size: 12px; padding: 8px;">
            <span>å£²ä¸Š</span>
          </button>
          <button class="sidebar-button" onclick="showMonthlyReportModal()" style="font-size: 12px; padding: 8px;">
            <span>æœˆæ¬¡</span>
          </button>
          <button class="sidebar-button" onclick="showHistoryModal()" style="font-size: 12px; padding: 8px;">
            <span>å±¥æ­´</span>
          </button>
        </div>
        <button class="sidebar-button" onclick="openDrawer()">
          <span>ãƒ‰ãƒ­ã‚¢é–‹</span>
        </button>
        <button class="sidebar-button" onclick="showExpenseModal()">
          <span>æ”¯å‡º</span>
        </button>
        <button class="sidebar-button" id="settingsMenuBtn" onclick="toggleSettingsMenu()">
          <span>ç™ºæ³¨ãƒ»è¨­å®š</span>
        </button>
        <!-- è¨­å®šã‚µãƒ–ãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
        <div id="settingsSubMenu" style="display: none; padding-left: 10px;">
          <button class="sidebar-button" onclick="window.open('https://gymnastmasaki-lang.github.io/takoyaki-/order.html', '_blank')" style="font-size: 12px; padding: 8px;">
            <span>ç™ºæ³¨</span>
          </button>
          <button class="sidebar-button" onclick="showPrinterSettings()" style="font-size: 12px; padding: 8px;">
            <span>ãƒ—ãƒªãƒ³ã‚¿è¨­å®š</span>
          </button>
          <button class="sidebar-button" onclick="window.open('https://gymnastmasaki-lang.github.io/takoyaki-/kanri.html', '_blank')" style="font-size: 12px; padding: 8px;">
            <span>è¨­å®šãƒ»ç®¡ç†</span>
          </button>
        </div>
        <button class="sidebar-button" onclick="handleLogout()">
          <span>ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</span>
        </button>
      </div>
    </div>
    
    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ -->
    <div class="main-content">
      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <div class="header">
        <div style="display: flex; align-items: center; gap: 15px;">
          <div style="background: linear-gradient(135deg, #81C784 0%, #66BB6A 100%); padding: 8px 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
            <label style="margin: 0; font-size: 13px; font-weight: bold; color: white;">è‡ªå‹•å°åˆ·</label>
            <label class="toggle-switch" style="margin: 0;">
              <input type="checkbox" id="newAutoPrintToggle" onchange="toggleAutoPrint()">
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-status off" id="newAutoPrintStatus" style="margin: 0; font-size: 13px; font-weight: bold; color: white;">OFF</span>
          </div>
        </div>
        <div style="display: flex; gap: 10px; align-items: stretch;">
          <button id="time-override-btn-new" onclick="toggleTimeOverride()" style="padding: 8px 15px; font-size: 13px; background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; display: flex; align-items: center;">æ™‚é–“å¤–å–¶æ¥­è§£é™¤</button>
          <div style="background: linear-gradient(135deg, #FFB74D 0%, #FFA726 100%); padding: 8px 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px;">
            <span style="font-size: 13px; font-weight: bold; color: white;">å¾…ã¡</span>
            <span style="font-size: 20px; font-weight: bold; color: white;" id="newManualCount">0</span>
            <button onclick="increaseWaiting()" style="padding: 4px 10px; background: white; color: #FF9800; border: none; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer;">+</button>
            <button onclick="resetWaiting()" style="padding: 4px 10px; background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer;">R</button>
          </div>
        </div>
      </div>
      
      <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚¨ãƒªã‚¢ -->
      <div class="tables-area" id="tablesArea">
        <div class="tables-grid" id="newTablesGrid">
          <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
        </div>
      </div>
      
      <!-- ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°ã‚¨ãƒªã‚¢ -->
      <div class="table-detail-area" id="tableDetailArea">
        <div class="table-detail-header">
          <div>
            <div class="table-detail-title" id="detailTableName">ãƒ†ãƒ¼ãƒ–ãƒ«1</div>
            <div id="detailOrderCount" style="font-size: 16px; color: #666; margin-top: 5px;">æ³¨æ–‡: 0ä»¶</div>
          </div>
          <div class="table-actions">
            <button class="action-btn order" id="orderBtn" onclick="showMenuIframe()">
              <span>æ³¨æ–‡è¿½åŠ </span>
            </button>
            <button class="action-btn payment" id="paymentBtn" onclick="showPaymentFromTable()">
              <span>ä¼šè¨ˆ</span>
            </button>
            <button class="action-btn back" onclick="backToTablesList()">
              <span>â† æˆ»ã‚‹</span>
            </button>
          </div>
        </div>
        
        <!-- æ³¨æ–‡ä¸€è¦§ -->
        <div id="detailOrdersList" style="margin-top: 20px;">
          <div class="loading">æ³¨æ–‡ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
        </div>
      </div>
      
      <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼iframeã‚³ãƒ³ãƒ†ãƒŠ -->
      <div class="menu-iframe-container" id="menuIframeContainer">
        <div class="menu-iframe-header">
          <div class="menu-iframe-title" id="iframeTableName">ãƒ†ãƒ¼ãƒ–ãƒ«1 - ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ</div>
          <button class="menu-iframe-close" onclick="closeMenuIframe()">âœ• é–‰ã˜ã‚‹</button>
        </div>
        <div class="menu-iframe-content">
          <div class="menu-iframe-left">
            <iframe 
              id="newMenuIframe"
              src=""
              style="width: 100%; height: 100%; border: none;"
              frameborder="0"
            ></iframe>
          </div>
          <div class="menu-iframe-right">
            <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: bold; color: #333;">é¸æŠä¸­ã®å•†å“</h3>
            <div id="iframeSelectedItems" style="background: white; border-radius: 8px; padding: 15px; min-height: 200px;">
              <!-- é¸æŠä¸­ã®å•†å“ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
            <div style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px;">
              <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px;">åˆè¨ˆé‡‘é¡</div>
              <div style="font-size: 28px; font-weight: bold; color: #667eea;" id="iframeTotal">Â¥0</div>
            </div>
            <button onclick="submitIframeOrder()" id="iframeSubmitBtn" disabled style="width: 100%; margin-top: 15px; padding: 15px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
              æ³¨æ–‡ã‚’è¿½åŠ 
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- æ—§UIï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰ -->
  <div id="oldUIContainer" style="display: none;">
  <div class="container" style="max-width: 1400px; margin: 0 auto; padding: 20px;">
    
    <div class="header">
      <div class="header-left">
        <div class="status">
          <!-- ğŸ“… å–¶æ¥­æ—¥è¡¨ç¤º -->
          <div id="businessDateDisplay" style="padding: 10px 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 8px; font-weight: bold; margin-right: 15px; font-size: 14px; cursor: pointer; line-height: 1.4; text-align: center; width: 280px; box-sizing: border-box; display: flex; align-items: center; justify-content: center;" onclick="changeDateSelection()">
            <span id="businessDateText">å–¶æ¥­æ—¥:<br>èª­ã¿è¾¼ã¿ä¸­...</span>
          </div>
          
          <div style="display: flex; align-items: center; width: 280px; min-height: 44px;">
            <label for="staffSelect" style="margin-right: 10px; font-weight: bold; white-space: nowrap;">æ‹…å½“è€…:</label>
            <select id="staffSelect" style="padding: 10px 12px; font-size: 16px; border: 2px solid #667eea; border-radius: 8px; background: white; cursor: pointer; flex: 1; box-sizing: border-box;">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
        </div>
      </div>
      <div class="header-right" style="display: flex; gap: 15px; align-items: flex-start;">
        
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <button onclick="window.location.href='https://gymnastmasaki-lang.github.io/takoyaki-/kintai.html'" style="padding: 10px 45px; font-size: 16px; background: linear-gradient(135deg, #3F51B5 0%, #303F9F 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; display: flex; flex-direction: column; align-items: center; justify-content: space-evenly; line-height: 1.2; height: 122px; box-sizing: border-box;">
            <div style="font-size: 26px; margin-bottom: 2px;">â°</div>
            <div style="font-size: 15px;">å‹¤æ€ </div>
          </button>
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          
          <div style="display: flex; gap: 10px;">
            <button onclick="increaseWaiting()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">å¾…å¢—</button>
            <button id="time-override-btn" onclick="toggleTimeOverride()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">æ™‚é–“å¤–è¨­å®šè§£é™¤</button>
            <button onclick="window.open('https://gymnastmasaki-lang.github.io/takoyaki-/order.html', '_blank')" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">ç™ºæ³¨</button>
            <button onclick="showPrinterSettings()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã®è¨­å®š</button>
          </div>
          
          <div style="display: flex; gap: 10px;">
            <button onclick="showMonthlyReportModal()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">æœˆæ¬¡</button>
            <button onclick="showSalesModal()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">å£²ä¸Š</button>
            <button onclick="showHistoryModal()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">å±¥æ­´</button>
            <button onclick="showExpenseModal()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #FF5722 0%, #E64A19 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">æ”¯å‡º</button>
            <button onclick="openDrawer()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #FFC107 0%, #FFA000 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 15px rgba(255,193,7,0.3);">é–‹ã</button>
          </div>
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <button onclick="window.open('https://gymnastmasaki-lang.github.io/takoyaki-/kanri.html', '_blank')" style="padding: 12px 40px; font-size: 16px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">è¨­å®šâ€¢ç®¡ç†</button>
          <button onclick="handleLogout()" style="padding: 12px 40px; font-size: 16px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>
    </div>
    
    <div class="main-content">
      
      <div class="section">
        <!-- å›ºå®šãƒœã‚¿ãƒ³ï¼ˆ1è¡Œç›®ï¼š3åˆ—ï¼‰ -->
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px;">
          
          <div style="background: linear-gradient(135deg, #81C784 0%, #66BB6A 100%); padding: 25px 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;">
            <label style="margin: 0; white-space: nowrap; font-size: 20px; font-weight: bold; color: white;">ãƒ¬ã‚·ãƒ¼ãƒˆè‡ªå‹•ç™ºè¡Œ</label>
            <div style="display: flex; align-items: center; gap: 10px;">
              <label class="toggle-switch" style="margin: 0;">
                <input type="checkbox" id="autoPrintToggle" onchange="toggleAutoPrint()">
                <span class="toggle-slider"></span>
              </label>
              <span class="toggle-status off" id="autoPrintStatus" style="margin: 0; font-size: 20px; font-weight: bold; color: white;">OFF</span>
            </div>
          </div>
          <div style="background: linear-gradient(135deg, #FFB74D 0%, #FFA726 100%); padding: 25px 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;">
            <div style="font-size: 20px; font-weight: bold; color: white;">æ‰‹å‹•å¾…ã¡äººæ•°</div>
            <div style="font-size: 36px; font-weight: bold; color: white;" id="manual-count">0</div>
            <button onclick="resetWaiting()" style="padding: 12px 24px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; white-space: nowrap;">ãƒªã‚»ãƒƒãƒˆ</button>
          </div>
          <!-- ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã‚‹ -->
        </div>
        
        <!-- ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠï¼ˆ2è¡Œç›®ä»¥é™ï¼š4åˆ—ï¼‰ -->
        <div id="tableButtonsGrid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 10px;">
          <!-- å‹•çš„ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
        </div>
        
        <!-- å…¨ãƒ†ãƒ¼ãƒ–ãƒ«åˆè¨ˆé‡‘é¡è¡¨ç¤º -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.2); margin-bottom: 15px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <span style="font-size: 22px; font-weight: bold; color: white;">å…¨ãƒ†ãƒ¼ãƒ–ãƒ«åˆè¨ˆ:</span>
            <span id="allTablesTotal" style="font-size: 32px; font-weight: bold; color: #FFD700;">Â¥0</span>
          </div>
          <button onclick="payAllTables()" style="width: 100%; padding: 18px; background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; border-radius: 10px; font-size: 20px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ä¼šè¨ˆ
          </button>
        </div>
        
        <div class="table-grid" id="tableGrid" style="display: none;">
          
        </div>
        </div>
        
        <div id="orderSection" class="hidden">
          <h2>æ³¨æ–‡è©³ç´° - <span id="selectedTableLabel"></span></h2>
          <div id="ordersList">
            <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
          
          <div id="totalSection" class="hidden">
            <div class="order-total">
              <span class="total-label">åˆè¨ˆé‡‘é¡:</span>
              <span class="total-amount" id="totalAmount">Â¥0</span>
            </div>
            <button class="btn btn-primary" onclick="showPaymentModal()">ä¼šè¨ˆå‡¦ç†</button>
            <button class="btn" onclick="window.printBill()" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; font-weight: bold;">ãŠä¼šè¨ˆä¼ç¥¨</button>
            <button class="btn btn-secondary" onclick="clearSelection()">â† ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠã«æˆ»ã‚‹</button>
          </div>
        </div>
      </div>
      
      <div style="height: 30px;"></div>
      <div class="section">
        <!-- æ‰‹å‹•ãƒ¬ã‚¸å…¥åŠ› -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; align-items: start;">
          
          <div>
            <!-- menu.htmlã‚’iframeã§åŸ‹ã‚è¾¼ã¿ -->
            <div class="input-group" style="display: flex; flex-direction: column; height: 100%;">
              <label>å•†å“ã‚’é¸æŠ</label>
              <iframe 
                id="menuIframe"
                src=""
                style="
                  flex: 1; 
                  min-height: 700px; 
                  width: 100%; 
                  border: 2px solid #667eea; 
                  border-radius: 8px;
                  background: white;
                "
                frameborder="0"
              ></iframe>
            </div>
          </div>
          <div style="display: flex; flex-direction: column; height: 100%;">
            <div class="selected-items" id="selectedItems" style="flex: 1; min-height: 400px; overflow-y: auto;"></div>
            
            <div class="input-group" style="margin-top: 15px;">
              <label>ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·</label>
              <select id="manualTable">
                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              </select>
            </div>
            
            <div class="input-group" style="margin-top: 15px;">
              <label>åˆè¨ˆé‡‘é¡: <span id="manualTotal" style="color: #667eea; font-size: 20px;">Â¥0</span></label>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button class="btn btn-primary" onclick="submitManualOrder()" id="manualSubmitBtn" disabled style="flex: 1;">ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ </button>
              <button class="btn btn-success" id="directPaymentBtn" disabled style="flex: 1;">å³ä¼šè¨ˆ</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠ</h3>
      <div id="taxRateSection" style="margin-bottom: 20px; padding: 15px; background: #e8f5e9; border-radius: 10px; border-left: 4px solid #4CAF50; max-height: 200px; overflow-y: auto;">
        <h4 style="margin: 0 0 15px 0; color: #2e7d32; font-size: 16px;">å„å•†å“ã®ç¨ç‡ã‚’é¸æŠ</h4>
        <div id="taxRateItemsList"></div>
        <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #4CAF50; font-weight: bold; font-size: 14px;">
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <span>8%å¯¾è±¡:</span>
            <span id="tax8Summary" style="color: #FF9800;">Â¥0</span>
          </div>
          <div style="display: flex; justify-content: space-between;">
            <span>10%å¯¾è±¡:</span>
            <span id="tax10Summary" style="color: #2196F3;">Â¥0</span>
          </div>
        </div>
      </div>
      
      <div class="payment-methods">
        <button class="payment-method-btn" onclick="selectPaymentMethod('cash')">
          ç¾é‡‘
        </button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('emoney')">
          é›»å­ãƒãƒãƒ¼
        </button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('credit')">
          ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰
        </button>
      </div>
      
      <div id="cashInputSection" class="cash-input-section hidden">
        <label>ãŠé ã‹ã‚Šé‡‘é¡</label>
        <input type="number" id="cashReceived" placeholder="0" oninput="calculateChange()">
        <div class="change-display" id="changeDisplay">
          ãŠã¤ã‚Š: <span class="change-amount" id="changeAmount">Â¥0</span>
        </div>
      </div>
      <div style="margin: 20px 0; padding: 15px; background: #fff3cd; border-radius: 10px;">
        <label style="font-weight: bold; color: #856404;">å€¤å¼•ãé‡‘é¡</label>
        <input type="number" id="discountAmount" placeholder="0" value="0" style="width: 100%; padding: 10px; font-size: 16px; border: 2px solid #ffc107; border-radius: 8px; margin-top: 8px;" oninput="updatePaymentTotal()">
        <div style="text-align: center; margin-top: 10px; font-size: 18px; font-weight: bold; color: #333;">
          è«‹æ±‚é¡: <span id="finalPaymentAmount" style="color: #4CAF50;">Â¥0</span>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="completePayment()" id="completePaymentBtn" disabled>ä¼šè¨ˆå®Œäº†</button>
      <button class="btn btn-secondary" onclick="closePaymentModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  <div id="receiptCompleteModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ä¼šè¨ˆå®Œäº†</h3>
      <div style="text-align: center; margin: 20px 0; font-size: 18px; color: #4CAF50;">
        ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸ
      </div>
      <div class="receipt-actions">
        <button class="receipt-btn print" onclick="printReceipt()">ãƒ¬ã‚·ãƒ¼ãƒˆç™ºè¡Œ</button>
        <button class="receipt-btn invoice" onclick="printInvoice()">é ˜åæ›¸ç™ºè¡Œ</button>
        <button class="receipt-btn back" onclick="closeReceiptModal()">â† æˆ»ã‚‹</button>
      </div>
    </div>
  </div>
  <div id="toppingModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’é¸æŠ</h3>
      <div id="toppingModalItemName" style="font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #667eea;"></div>
      
      <!-- æ•°é‡é¸æŠ -->
      <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
        <span style="font-size: 16px; font-weight: bold; color: #333;">æ•°é‡:</span>
        <button onclick="decrementToppingQuantity()" style="width: 40px; height: 40px; border-radius: 50%; background: #dc3545; color: white; border: none; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold;">âˆ’</button>
        <span id="toppingQuantityDisplay" style="font-size: 28px; font-weight: bold; min-width: 50px; text-align: center; color: #667eea;">1</span>
        <button onclick="incrementToppingQuantity()" style="width: 40px; height: 40px; border-radius: 50%; background: #28a745; color: white; border: none; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-weight: bold;">+</button>
      </div>
      
      <div id="toppingsList" style="max-height: 400px; overflow-y: auto;">
        
      </div>
      <button class="btn btn-primary" onclick="confirmTopping()">æ±ºå®š</button>
      <button class="btn btn-secondary" onclick="closeToppingModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  <div id="historyModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h3>æ³¨æ–‡å±¥æ­´</h3>
      
      <div style="margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap;">
        <select id="historyDateFilter" onchange="filterHistory()" style="padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
          <option value="today">ä»Šæ—¥</option>
          <option value="yesterday">æ˜¨æ—¥</option>
          <option value="week">ä»Šé€±</option>
          <option value="month">ä»Šæœˆ</option>
          <option value="all">å…¨æœŸé–“</option>
        </select>
        
        <select id="historyStatusFilter" onchange="filterHistory()" style="padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
          <option value="all">ã™ã¹ã¦</option>
          <option value="deleted">å‰Šé™¤æ¸ˆã¿</option>
          <option value="paid">ä¼šè¨ˆæ¸ˆã¿</option>
          <option value="completed">å®Œäº†</option>
          <option value="cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</option>
        </select>
        
        <button onclick="refreshHistory()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;">ğŸ”„ æ›´æ–°</button>
      </div>
      
      <div id="historyList" style="max-height: 60vh; overflow-y: auto;">
        
      </div>
      
      <button class="btn btn-secondary" onclick="closeHistoryModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  <div id="customerCountModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 600px;">
      <h3>æœ¬æ—¥ã®å®¢æ•°</h3>
      
      <div id="customerCountContent" style="padding: 20px;">
        
      </div>
      
      <button class="btn btn-secondary" onclick="closeCustomerCountModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  <div id="salesModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 700px;">
      <h3 id="salesModalTitle">æœ¬æ—¥ã®å£²ä¸Š</h3>
      
      <div style="margin: 20px 0; display: flex; justify-content: flex-end;">
        <button onclick="showSettlementModal()" style="padding: 10px 20px; background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px;">ğŸ”„ ç²¾ç®—</button>
      </div>
      
      <div id="salesContent">
        
      </div>
      
      <button class="btn btn-secondary" onclick="closeSalesModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  <div id="settlementModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 500px;">
      <h3 style="color: #ff6b6b;">ğŸ”„ ç²¾ç®—ç¢ºèª</h3>
      
      <div style="margin: 20px 0; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px;">
        <p style="margin: 0 0 10px 0; font-weight: bold; color: #856404;">æ³¨æ„äº‹é …:</p>
        <ul style="margin: 0; padding-left: 20px; color: #856404;">
          <li>æœ¬æ—¥ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºå®šã—ã¾ã™</li>
          <li>ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ï¼ˆPNGç”»åƒï¼‰ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™</li>
          <li>å£²ä¸Šã¯åˆå‰3æ™‚ã«è‡ªå‹•çš„ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™</li>
        </ul>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #333;">ç²¾ç®—æ—¥ä»˜ã‚’é¸æŠ</label>
        <input type="date" id="settlementDate" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
        <p style="font-size: 12px; color: #666; margin-top: 5px;">â€» æ˜¨æ—¥ã®ç²¾ç®—ã‚’ä¸Šã’å¿˜ã‚ŒãŸå ´åˆãªã©ã€éå»ã®æ—¥ä»˜ã‚’é¸æŠã§ãã¾ã™</p>
      </div>
      
      <div id="settlementSummary" style="margin: 20px 0;">
        
      </div>
      
      <button class="btn" style="width: 100%; background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%); color: white; margin-bottom: 10px;" onclick="confirmSettlement()">ç²¾ç®—ã‚’å®Ÿè¡Œ</button>
      <button class="btn" style="width: 100%; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; margin-bottom: 10px;" onclick="generateDailyReport()">æ—¥è¨ˆè¡¨å‡ºåŠ›</button>
      <button class="btn" style="width: 100%; background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); color: white; margin-bottom: 10px;" onclick="window.open('arari.html', '_blank')">ç´ç¨é¡/ç²—åˆ©æ—©è¦‹è¡¨</button>
      <button class="btn btn-secondary" onclick="closeSettlementModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  <div id="expenseModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h3 style="color: #f093fb;">æ”¯å‡ºå…¥åŠ›</h3>
      
      <div style="margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; gap: 15px;">
        <label style="font-weight: bold; font-size: 16px;">æ—¥ä»˜:</label>
        <input type="date" id="expenseDateInput" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 16px; flex: 1;" onchange="loadExpensesByDate()" />
      </div>
      
      <div style="margin: 20px 0;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="background: #f5f5f5;">
              <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">åº—å</th>
              <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">å‹˜å®šç§‘ç›®</th>
              <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">è©³ç´°</th>
              <th style="padding: 10px; border: 1px solid #ddd; text-align: left;">é‡‘é¡</th>
              <th style="padding: 10px; border: 1px solid #ddd; width: 60px;"></th>
            </tr>
          </thead>
          <tbody id="expenseTableBody">
            
          </tbody>
        </table>
        
        <button class="btn" style="margin-top: 10px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="addExpenseRow()">ï¼‹ è¡Œã‚’è¿½åŠ </button>
        
        <div style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px; text-align: right;">
          <span style="font-size: 18px; font-weight: bold;">åˆè¨ˆ: Â¥</span>
          <span id="expenseTotal" style="font-size: 24px; font-weight: bold; color: #f093fb;">0</span>
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button class="btn" style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="saveExpenses()">ä¿å­˜</button>
        <button class="btn" style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="exportExpensesToCSV()">æœ¬æ—¥åˆ†å‡ºåŠ›</button>
        <button class="btn" style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white;" onclick="showExpenseExportModal()">çµŒè²»å‡ºåŠ›</button>
        <button class="btn" style="flex: 1; min-width: 150px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;" onclick="window.open('https://gymnastmasaki-lang.github.io/takoyaki-/receipt.html', '_blank')">é ˜åæ›¸ç®¡ç†</button>
        <button class="btn btn-secondary" style="flex: 1; min-width: 150px;" onclick="closeExpenseModal()">é–‰ã˜ã‚‹</button>
      </div>
    </div>
  </div>
  <div id="monthlyReportModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <h3>æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</h3>
      
      <div style="margin: 20px 0; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
        <div style="flex: 1; min-width: 200px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">é–‹å§‹æ—¥</label>
          <input type="date" id="reportStartDate" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
        </div>
        
        <div style="flex: 1; min-width: 200px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">çµ‚äº†æ—¥</label>
          <input type="date" id="reportEndDate" style="width: 100%; padding: 8px; border-radius: 8px; border: 2px solid #ddd; font-size: 14px;">
        </div>
        
        <button onclick="generatePeriodJournal()" style="padding: 12px 24px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px;">ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆ</button>
        <button onclick="exportPeriodCSV()" style="padding: 12px 24px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-top: 20px;">CSVå‡ºåŠ›</button>
      </div>
      
      <div id="monthlyReportContent">
        
      </div>
      
      <!-- ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ -->
      <div id="monthlyChartsArea" style="margin-top: 30px; display: none;">
        <h4 style="margin-bottom: 20px; color: #333; border-bottom: 2px solid #667eea; padding-bottom: 10px;">ğŸ“Š æœˆæ¬¡æ¨ç§»ã‚°ãƒ©ãƒ•</h4>
        
        <!-- å£²ä¸Šæ¨ç§»ã‚°ãƒ©ãƒ• -->
        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <h5 style="margin-bottom: 15px; color: #4CAF50;">å£²ä¸Šæ¨ç§»</h5>
          <canvas id="salesTrendChart" style="max-height: 300px;"></canvas>
        </div>
        
        <!-- äººä»¶è²»ç‡æ¨ç§»ã‚°ãƒ©ãƒ• -->
        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <h5 style="margin-bottom: 15px; color: #FF9800;">äººä»¶è²»ç‡æ¨ç§»ï¼ˆç›®æ¨™35%ï¼‰</h5>
          <canvas id="laborCostRateChart" style="max-height: 300px;"></canvas>
        </div>
        
        <!-- ç²—åˆ©ç‡æ¨ç§»ã‚°ãƒ©ãƒ• -->
        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <h5 style="margin-bottom: 15px; color: #2196F3;">ç²—åˆ©ç‡æ¨ç§»ï¼ˆå£²ä¸Š - äººä»¶è²»ï¼‰</h5>
          <canvas id="profitRateChart" style="max-height: 300px;"></canvas>
        </div>
        
        <!-- ç´”åˆ©ç›Šç‡æ¨ç§»ã‚°ãƒ©ãƒ• -->
        <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <h5 style="margin-bottom: 15px; color: #9C27B0;">ç´”åˆ©ç›Šç‡æ¨ç§»ï¼ˆå£²ä¸Š - äººä»¶è²» - æ”¯å‡ºï¼‰</h5>
          <canvas id="netProfitRateChart" style="max-height: 300px;"></canvas>
        </div>
        
        <!-- æ•°å€¤è¡¨ -->
        <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
          <h5 style="margin-bottom: 15px; color: #333;">ğŸ“‹ è©³ç´°æ•°å€¤</h5>
          <table id="monthlyDataTable" style="width: 100%; border-collapse: collapse;">
            <thead>
              <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <th style="padding: 12px; text-align: center; border: 2px solid #555;">æœˆ</th>
                <th style="padding: 12px; text-align: right; border: 2px solid #555;">å£²ä¸Š</th>
                <th style="padding: 12px; text-align: right; border: 2px solid #555;">äººä»¶è²»</th>
                <th style="padding: 12px; text-align: right; border: 2px solid #555;">äººä»¶è²»ç‡</th>
                <th style="padding: 12px; text-align: right; border: 2px solid #555;">æ”¯å‡º</th>
                <th style="padding: 12px; text-align: right; border: 2px solid #555;">ç²—åˆ©</th>
                <th style="padding: 12px; text-align: right; border: 2px solid #555;">ç²—åˆ©ç‡</th>
                <th style="padding: 12px; text-align: right; border: 2px solid #555;">ç´”åˆ©ç›Š</th>
                <th style="padding: 12px; text-align: right; border: 2px solid #555;">ç´”åˆ©ç›Šç‡</th>
              </tr>
            </thead>
            <tbody id="monthlyDataTableBody">
              <!-- JavaScriptã§å‹•çš„ã«ç”Ÿæˆ -->
            </tbody>
          </table>
        </div>
      </div>
      
      <button class="btn btn-secondary" onclick="closeMonthlyReportModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  <div id="editOrderModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
      <h3>âœï¸ æ³¨æ–‡ç·¨é›†</h3>
      
      <div id="editOrderContent" style="margin: 20px 0;">
        
      </div>
      
      <div id="editOrderButtons" style="display: flex; gap: 10px; margin-top: 20px;">
        
      </div>
    </div>
  </div>
  <script>
    let selectedTable = null;
    let currentTableSettings = null;  // ğŸ†• ç¾åœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š
    let currentOrders = [];
    let isDirectPaymentMode = false;  // å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°
    let menuItems = [];
    let manualCart = [];
    let selectedPaymentMethod = null;
    let totalAmountToPay = 0;
    let cashReceived = 0;
    let changeAmount = 0;
    let lastPaymentData = null;
    
    let allMenuItems = [];
    let isBulkSoldOut = false;
    
    // éŸ³å£°é€šçŸ¥ç”¨
    let audioEnabled = false;
    let lastOrderCount = 0;
    let isFirstOrderLoad = true;
    
    // ãƒ—ãƒªãƒ³ã‚¿ãƒ¼è¨­å®šï¼ˆlocalStorageã‹ã‚‰èª­ã¿è¾¼ã¿ï¼‰
    let PRINTER_IP = localStorage.getItem('printerIP') || '192.168.1.100';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆIPã‚¢ãƒ‰ãƒ¬ã‚¹
    let PRINTER_CONNECTION_TYPE = localStorage.getItem('printerConnectionType') || 'ethernet'; // ethernet or bluetooth
    let BLUETOOTH_DEVICE = null; // Bluetoothãƒ‡ãƒã‚¤ã‚¹
    let BLUETOOTH_CHARACTERISTIC = null; // Bluetoothé€šä¿¡ç”¨
    let autoPrintEnabled = localStorage.getItem('autoPrintEnabled') === 'true';
    
    // ğŸ†• ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã®URLï¼ˆHTTPSã‹ã‚‰HTTPã¸ã®é€šä¿¡ã‚’ä¸­ç¶™ï¼‰
    // ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§èµ·å‹•ã—ãŸNode.jsã‚µãƒ¼ãƒãƒ¼ã®URL
    const PRINTER_PROXY_URL = 'http://localhost:3000/print';
    
    // ãƒ—ãƒ­ã‚­ã‚·ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã©ã†ã‹ï¼ˆHTTPSã‚µã‚¤ãƒˆã®å ´åˆã¯trueï¼‰
    const USE_PROXY = window.location.protocol === 'https:';
    
    // ğŸ†• ãƒ—ãƒ­ã‚­ã‚·å¯¾å¿œã®å°åˆ·ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    // ğŸ†• ãƒ—ãƒ­ã‚­ã‚·å¯¾å¿œ + Bluetoothå¯¾å¿œã®å°åˆ·ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    async function sendPrintRequest(builder, onSuccess, onError) {
      try {
        // Bluetoothæ¥ç¶šã®å ´åˆ
        if (PRINTER_CONNECTION_TYPE === 'bluetooth') {
          console.log('ğŸ“± BluetoothçµŒç”±ã§å°åˆ·ã—ã¾ã™');
          
          if (!BLUETOOTH_CHARACTERISTIC) {
            throw new Error('Bluetoothãƒ—ãƒªãƒ³ã‚¿ãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ—ãƒªãƒ³ã‚¿è¨­å®šã‹ã‚‰æ¥ç¶šã—ã¦ãã ã•ã„ã€‚');
          }
          
          // StarWebPrintBuilderã‹ã‚‰ç”Ÿãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºï¼ˆç°¡æ˜“ç‰ˆï¼‰
          // æ³¨æ„: StarWebPrintBuilderã¯XMLã‚’ç”Ÿæˆã™ã‚‹ã®ã§ã€ãƒ†ã‚­ã‚¹ãƒˆã®ã¿ã‚’æŠ½å‡º
          const xmlString = builder.toString();
          const textMatch = xmlString.match(/<text[^>]*>([^<]*)<\/text>/g);
          let text = '';
          if (textMatch) {
            textMatch.forEach(match => {
              const content = match.replace(/<[^>]+>/g, '');
              text += content + '\n';
            });
          }
          
          await printViaBluetooth(text);
          
          if (onSuccess) onSuccess({ status: 'success', message: 'Bluetoothå°åˆ·å®Œäº†' });
          return;
        }
        
        // Ethernet/WiFiæ¥ç¶šã®å ´åˆ
        if (USE_PROXY) {
          console.log('ğŸ”„ ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§å°åˆ·ã—ã¾ã™');
          
          // XMLãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å–å¾—
          const request = builder.toString();
          
          // ãƒ—ãƒ­ã‚­ã‚·ã‚µãƒ¼ãƒãƒ¼ã«é€ä¿¡
          const response = await fetch(PRINTER_PROXY_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'text/xml; charset=utf-8'
            },
            body: request
          });
          
          if (response.ok) {
            console.log('âœ… å°åˆ·æˆåŠŸ');
            const data = await response.text();
            if (onSuccess) onSuccess({ status: 'success', data: data });
          } else {
            const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
            console.error('âŒ å°åˆ·ã‚¨ãƒ©ãƒ¼:', errorData);
            if (onError) onError({ status: response.status, message: errorData.error || response.statusText });
          }
        } else {
          console.log('ğŸ–¨ï¸ ãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã«ç›´æ¥å°åˆ·ã—ã¾ã™');
          
          const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
          const request = builder.toString();
          
          const trader = new StarWebPrintTrader({url: url});
          trader.onReceive = function(response) {
            console.log('å°åˆ·æˆåŠŸ:', response);
            if (onSuccess) onSuccess(response);
          };
          trader.onError = function(response) {
            console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', response);
            if (onError) onError(response);
          };
          
          trader.sendMessage({request: request});
        }
      } catch (error) {
        console.error('âŒ å°åˆ·å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        if (onError) onError({ status: 'error', message: error.message });
      }
    }
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆFirebaseã‹ã‚‰å–å¾—ï¼‰
    let menuData = [];
    let toppingsData = [];
    
        // åˆæœŸåŒ–
    window.addEventListener('load', async () => {
      await initializeSystem();
    });
    
    async function initializeSystem() {
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡è¨­å®šã‚’èª­ã¿è¾¼ã¿
      await loadDefaultTaxRateSettings();
      
      // Firebaseã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å–å¾—
      try {
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        // controller.htmlã¨åŒã˜å½¢å¼ã§sold_outã‚’å–å¾—
        const soldOutSnapshot = await window.getDocs(window.collection(window.db, 'sold_out'));
        const soldOutIds = new Set();
        soldOutSnapshot.forEach(doc => soldOutIds.add(doc.data().menuId));
        
        menuData = [];
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          const menuId = data.id || doc.id;
          menuData.push({
            id: menuId,
            docId: doc.id, // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚‚ä¿æŒ
            name: data.name || '',
            price: data.price || 0,
            category: data.category || 'ãã®ä»–',
            taxRate: data.taxRate || 10,
            taxType: data.taxType || 'inclusive',  // ğŸ†• å¤–ç¨/å†…ç¨ã‚¿ã‚¤ãƒ—ã‚’è¿½åŠ 
            foodType: data.foodType || 'food',  // ğŸ†• é£ŸæåŒºåˆ†ã‚’è¿½åŠ 
            toppingsId: data.toppingsId || '', // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã®ãƒˆãƒƒãƒ”ãƒ³ã‚°IDæ–‡å­—åˆ—
            toppings: data.toppings || [], // é…åˆ—å½¢å¼ï¼ˆäº’æ›æ€§ã®ãŸã‚ï¼‰
            toppingSets: data.toppingSets || [], // æ–°ã—ã„ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆå½¢å¼
            note: data.note || '', // è¡¨ç¤ºåˆ¶é™ç”¨ã®note
            outOfStock: soldOutIds.has(menuId) // å“åˆ‡ã‚Œåˆ¤å®š
          });
        });
        
        // menu.htmlã¨åŒã˜ã‚½ãƒ¼ãƒˆæ–¹æ³•ï¼šIDã§ã‚½ãƒ¼ãƒˆ
        console.log('ã‚½ãƒ¼ãƒˆå‰ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ID:', menuData.map(m => m.id).join(', '));
        menuData.sort((a, b) => {
          if (a.id < b.id) return -1;
          if (a.id > b.id) return 1;
          return 0;
        });
        
        console.log('âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', menuData.length, 'ä»¶ (å“åˆ‡ã‚Œ:', soldOutIds.size, 'ä»¶)');
        console.log('ã‚½ãƒ¼ãƒˆå¾Œã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ID:', menuData.map(m => m.id).join(', '));
      } catch (e) {
        console.error('âŒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
      }
      
      // Firebaseã‹ã‚‰ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’å–å¾—
      try {
        const toppingsSnapshot = await window.getDocs(window.getStoreCollection('toppings'));
        toppingsData = [];
        toppingsSnapshot.forEach(doc => {
          const data = doc.data();
          toppingsData.push({
            id: data.id || doc.id, // data.idã‚’å„ªå…ˆ
            docId: doc.id,
            name: data.name || '',
            price: data.price || 0,
            order: data.order || 99 // ä¸¦ã³é †ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
          });
        });
        
        // menu.htmlã¨åŒã˜ã‚½ãƒ¼ãƒˆæ–¹æ³•ï¼šorderãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã‚½ãƒ¼ãƒˆ
        console.log('ã‚½ãƒ¼ãƒˆå‰ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ID:', toppingsData.map(t => t.id).join(', '));
        toppingsData.sort((a, b) => a.order - b.order);
        
        console.log('âœ… ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', toppingsData.length, 'ä»¶');
        console.log('ã‚½ãƒ¼ãƒˆå¾Œã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ID:', toppingsData.map(t => t.id).join(', '));
      } catch (e) {
        console.error('âŒ ãƒˆãƒƒãƒ”ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
      }
      
      // æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå³ä¼šè¨ˆã€ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆï¼‰ã‚’è‡ªå‹•ç™»éŒ²
      await ensureDefaultTables();
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
      await loadTableButtons();
      
      // ã‚«ãƒ†ã‚´ãƒªã‚’åˆæœŸåŒ–
      initializeCategories();
      
      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’è¡¨ç¤º
      displayMenuItems();
      
      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹
      startRealtimeUpdates();
      
      // éŸ³å£°é€šçŸ¥ã‚’åˆæœŸåŒ–
      showAudioEnablePopup();
      watchOrders();
      watchStaffCalls();
      
      // 7å¹´ä»¥ä¸Šå¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•å‰Šé™¤
      deleteOldDataAutomatically();
    }
    
    // 7å¹´ä»¥ä¸Šå¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’è‡ªå‹•å‰Šé™¤ã™ã‚‹é–¢æ•°
    async function deleteOldDataAutomatically() {
      try {
        console.log('=== 7å¹´ä»¥ä¸Šå¤ã„ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•å‰Šé™¤é–‹å§‹ ===');
        
        // 7å¹´å‰ã®æ—¥æ™‚ã‚’è¨ˆç®—
        const sevenYearsAgo = new Date();
        sevenYearsAgo.setFullYear(sevenYearsAgo.getFullYear() - 7);
        const cutoffTimestamp = window.Timestamp.fromDate(sevenYearsAgo);
        
        console.log('åŸºæº–æ—¥:', sevenYearsAgo.toLocaleDateString('ja-JP'));
        
        let deletedCount = 0;
        
        // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
        try {
          const ordersCollection = window.getStoreCollection('orders');
          const ordersSnapshot = await window.getDocs(ordersCollection);
          
          for (const docSnap of ordersSnapshot.docs) {
            const data = docSnap.data();
            
            // createdAtãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹å ´åˆã®ã¿ãƒã‚§ãƒƒã‚¯
            if (data.createdAt) {
              const docDate = data.createdAt.toDate();
              
              // 7å¹´ä»¥ä¸Šå‰ã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤
              if (docDate < sevenYearsAgo) {
                await window.deleteDoc(docSnap.ref);
                deletedCount++;
                console.log(`å‰Šé™¤: æ³¨æ–‡/${docSnap.id} (${docDate.toLocaleDateString('ja-JP')})`);
              }
            }
          }
        } catch (error) {
          console.warn('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªã§ã‚¨ãƒ©ãƒ¼:', error.message);
        }
        
        // å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
        try {
          const attendanceCollection = window.getStoreCollection('attendance');
          const attendanceSnapshot = await window.getDocs(attendanceCollection);
          
          for (const docSnap of attendanceSnapshot.docs) {
            const data = docSnap.data();
            
            // createdAtãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒã‚ã‚‹å ´åˆã®ã¿ãƒã‚§ãƒƒã‚¯
            if (data.createdAt) {
              const docDate = data.createdAt.toDate();
              
              // 7å¹´ä»¥ä¸Šå‰ã®ãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤
              if (docDate < sevenYearsAgo) {
                await window.deleteDoc(docSnap.ref);
                deletedCount++;
                console.log(`å‰Šé™¤: å‹¤æ€ /${docSnap.id} (${docDate.toLocaleDateString('ja-JP')})`);
              }
            }
          }
        } catch (error) {
          console.warn('å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèªã§ã‚¨ãƒ©ãƒ¼:', error.message);
        }
        
        console.log('=== 7å¹´ä»¥ä¸Šå¤ã„ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤å®Œäº† ===');
        console.log('å‰Šé™¤ä»¶æ•°:', deletedCount);
        
        if (deletedCount > 0) {
          console.log(`7å¹´ä»¥ä¸Šå¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’${deletedCount}ä»¶è‡ªå‹•å‰Šé™¤ã—ã¾ã—ãŸ`);
        }
      } catch (error) {
        console.error('å¤ã„ãƒ‡ãƒ¼ã‚¿è‡ªå‹•å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã®è‰²ã‚’æ›´æ–°
    
    // è‡ªå‹•å°åˆ·ãƒˆã‚°ãƒ«
    window.toggleAutoPrint = function() {
      autoPrintEnabled = document.getElementById('autoPrintToggle').checked;
      localStorage.setItem('autoPrintEnabled', autoPrintEnabled.toString());
      const status = document.getElementById('autoPrintStatus');
      status.textContent = autoPrintEnabled ? 'ON' : 'OFF';
      status.className = autoPrintEnabled ? 'toggle-status on' : 'toggle-status off';
    };
    
    // ã‚«ãƒ†ã‚´ãƒªã‚’åˆæœŸåŒ–
    function initializeCategories() {
      const categoryFilter = document.getElementById('categoryFilter');
      
      // categoryFilterè¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å†…ãªã©ï¼‰
      if (!categoryFilter) {
        console.log('âš ï¸ categoryFilterè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®å¯èƒ½æ€§ï¼‰');
        return;
      }
      
      // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®æœ€å°IDã‚’è¨ˆç®—
      const categoryInfo = new Map();
      menuData.forEach(item => {
        if (!item.category) return;
        const cat = item.category;
        if (!categoryInfo.has(cat)) {
          categoryInfo.set(cat, { minId: item.id });
        } else {
          const info = categoryInfo.get(cat);
          if (item.id < info.minId) {
            info.minId = item.id;
          }
        }
      });
      
      // æœ€å°IDã§ã‚½ãƒ¼ãƒˆ
      const sortedCategories = Array.from(categoryInfo.entries())
        .sort((a, b) => a[1].minId.localeCompare(b[1].minId))
        .map(entry => entry[0]);
      
      // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆã€Œå…¨ã¦ã®å•†å“ã€ä»¥å¤–ï¼‰
      categoryFilter.innerHTML = '<option value="all">å…¨ã¦ã®å•†å“</option>';
      
      // ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ 
      sortedCategories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryFilter.appendChild(option);
      });
    }
    
    // ã‚«ãƒ†ã‚´ãƒªã§ãƒ•ã‚£ãƒ«ã‚¿
    window.filterMenuByCategory = function() {
      const categoryFilterElement = document.getElementById('categoryFilter');
      if (!categoryFilterElement) {
        console.log('âš ï¸ categoryFilterè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      const selectedCategory = categoryFilterElement.value;
      displayMenuItems(selectedCategory);
    };
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’è¡¨ç¤º
    function displayMenuItems(categoryFilter = 'all') {
      const container = document.getElementById('menuItemsList');
      
      // containerè¦ç´ ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
      if (!container) {
        console.log('âš ï¸ menuItemsListè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      container.innerHTML = '';
      
      const filteredMenu = categoryFilter === 'all' 
        ? menuData 
        : menuData.filter(item => item.category === categoryFilter);
      
      filteredMenu.forEach(item => {
        // ğŸ†• å¤–ç¨ã®å ´åˆã¯ç¨è¾¼ä¾¡æ ¼ã‚’è¨ˆç®—ã—ã¦è¡¨ç¤º
        let displayPrice = item.price;
        if (item.taxType === 'exclusive') {
          const taxRate = item.taxRate || 10;
          displayPrice = Math.floor(item.price * (1 + taxRate / 100));
        }
        
        const div = document.createElement('div');
        div.className = 'menu-item-checkbox';
        div.style.cursor = 'pointer';
        div.innerHTML = `
          <input type="checkbox" id="menu-${item.id}" value="${item.id}" style="pointer-events: none;">
          <div class="menu-item-info">
            <div class="menu-item-name-small">${item.name}</div>
            <div class="menu-item-price-small">Â¥${displayPrice.toLocaleString()}</div>
          </div>
        `;
        
        // divå…¨ä½“ã‚’ã‚¯ãƒªãƒƒã‚¯å¯èƒ½ã«
        div.onclick = () => {
          const checkbox = document.getElementById(`menu-${item.id}`);
          checkbox.checked = !checkbox.checked;
          toggleMenuItem(item.id);
        };
        
        container.appendChild(div);
      });
    }
    
    // ä¸€æ™‚çš„ãªé¸æŠä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ 
    let currentSelectingItem = null;
    let selectedToppings = [];
    let currentToppingQuantity = 1; // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã§ã®æ•°é‡
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®é¸æŠåˆ‡ã‚Šæ›¿ãˆ
    window.toggleMenuItem = function(itemId) {
      const checkbox = document.getElementById(`menu-${itemId}`);
      const item = menuData.find(m => m.id === itemId);
      
      if (checkbox.checked) {
        currentSelectingItem = { ...item };
        selectedToppings = [];
        
        // toppingsIdãŒç©ºã¾ãŸã¯å­˜åœ¨ã—ãªã„å ´åˆã§ã‚‚ã€ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºï¼ˆæ•°é‡é¸æŠã®ãŸã‚ï¼‰
        showToppingModal(item);
      } else {
        manualCart = manualCart.filter(i => i.id !== itemId);
        updateManualCart();
      }
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showToppingModal(item) {
      currentSelectingItem = item;
      selectedToppings = [];
      currentToppingQuantity = 1; // æ•°é‡ã‚’åˆæœŸåŒ–
      
      console.log('ğŸ” ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º:', item);
      console.log('  toppingsData:', toppingsData);
      console.log('  item.toppingsId:', item.toppingsId);
      console.log('  item.toppingSets:', item.toppingSets);
      
      document.getElementById('toppingModalItemName').textContent = item.name;
      document.getElementById('toppingQuantityDisplay').textContent = currentToppingQuantity; // æ•°é‡è¡¨ç¤ºã‚’æ›´æ–°
      const list = document.getElementById('toppingsList');
      list.innerHTML = '';
      
      // toppingSetsãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯æ–°ã—ã„å½¢å¼ã‚’ä½¿ç”¨
      if (item.toppingSets && item.toppingSets.length > 0) {
        console.log('âœ… toppingSetså½¢å¼ã§è¡¨ç¤º');
        item.toppingSets.forEach((set, setIndex) => {
          const setDiv = document.createElement('div');
          setDiv.style.cssText = 'margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;';
          
          const setTitle = document.createElement('div');
          setTitle.style.cssText = 'font-weight: bold; font-size: 16px; margin-bottom: 10px; color: #333;';
          setTitle.textContent = set.name + (set.type === 'single' ? ' ï¼ˆ1ã¤é¸æŠï¼‰' : ' ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰');
          setDiv.appendChild(setTitle);
          
          set.options.forEach((option, optionIndex) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'topping-item';
            optionDiv.style.cursor = 'pointer';
            
            const inputType = set.type === 'single' ? 'radio' : 'checkbox';
            const inputName = set.type === 'single' ? `topping-set-${setIndex}` : '';
            
            optionDiv.innerHTML = `
              <input type="${inputType}" id="topping-${setIndex}-${optionIndex}" name="${inputName}" style="pointer-events: none;">
              <div class="topping-item-info">
                <span class="topping-item-name">${option.name}</span>
                <span class="topping-item-price">+Â¥${option.price.toLocaleString()}</span>
              </div>
            `;
            
            optionDiv.onclick = () => {
              const input = document.getElementById(`topping-${setIndex}-${optionIndex}`);
              
              if (set.type === 'single') {
                // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å ´åˆã€ä»–ã®é¸æŠã‚’è§£é™¤
                set.options.forEach((_, idx) => {
                  const otherInput = document.getElementById(`topping-${setIndex}-${idx}`);
                  if (otherInput) otherInput.checked = false;
                });
                input.checked = true;
                
                // é¸æŠçŠ¶æ…‹ã‚’ä¿å­˜
                selectedToppings = selectedToppings.filter(t => t.setIndex !== setIndex);
                selectedToppings.push({
                  setIndex: setIndex,
                  setName: set.name,
                  optionIndex: optionIndex,
                  optionName: option.name,
                  price: option.price
                });
              } else {
                // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®å ´åˆ
                input.checked = !input.checked;
                
                if (input.checked) {
                  selectedToppings.push({
                    setIndex: setIndex,
                    setName: set.name,
                    optionIndex: optionIndex,
                    optionName: option.name,
                    price: option.price
                  });
                } else {
                  selectedToppings = selectedToppings.filter(
                    t => !(t.setIndex === setIndex && t.optionIndex === optionIndex)
                  );
                }
              }
              
              console.log('é¸æŠã•ã‚ŒãŸãƒˆãƒƒãƒ”ãƒ³ã‚°:', selectedToppings);
            };
            
            setDiv.appendChild(optionDiv);
          });
          
          list.appendChild(setDiv);
        });
      } else {
        // å¤ã„å½¢å¼ï¼ˆtoppingsIdï¼‰ã®å ´åˆ
        console.log('âœ… toppingsIdå½¢å¼ã§è¡¨ç¤º');
        
        // ã€Œãªã—ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³
        const noneDiv = document.createElement('div');
        noneDiv.className = 'topping-item';
        noneDiv.style.cursor = 'pointer';
        noneDiv.innerHTML = `
          <input type="checkbox" id="topping-none" style="pointer-events: none;">
          <div class="topping-item-info">
            <span class="topping-item-name">æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°</span>
            <span class="topping-item-price">Â¥0</span>
          </div>
        `;
        
        noneDiv.onclick = () => {
          const checkbox = document.getElementById('topping-none');
          checkbox.checked = !checkbox.checked;
          selectNoneTopping(checkbox);
        };
        
        list.appendChild(noneDiv);
        
        // toppingsIdã‹ã‚‰ãƒˆãƒƒãƒ”ãƒ³ã‚°IDã®ãƒªã‚¹ãƒˆã‚’å–å¾—
        let allowedToppingIds = [];
        if (item.toppingsId && typeof item.toppingsId === 'string') {
          allowedToppingIds = item.toppingsId.split(',').map(id => id.trim());
        } else if (item.toppings && Array.isArray(item.toppings)) {
          allowedToppingIds = item.toppings;
        }
        
        console.log('  allowedToppingIds:', allowedToppingIds);
        console.log('  toppingsDataä»¶æ•°:', toppingsData.length);
        
        let displayedCount = 0;
        toppingsData.forEach(topping => {
          console.log('  ãƒã‚§ãƒƒã‚¯ä¸­:', topping.id, 'ãŒ', allowedToppingIds, 'ã«å«ã¾ã‚Œã‚‹?', allowedToppingIds.includes(topping.id));
          if (allowedToppingIds.length > 0 && allowedToppingIds.includes(topping.id)) {
            displayedCount++;
            const div = document.createElement('div');
            div.className = 'topping-item';
            div.style.cursor = 'pointer';
            div.innerHTML = `
              <input type="checkbox" id="topping-${topping.id}" value="${topping.id}" style="pointer-events: none;">
              <div class="topping-item-info">
                <span class="topping-item-name">${topping.name}</span>
                <span class="topping-item-price">+Â¥${topping.price.toLocaleString()}</span>
              </div>
            `;
            
            div.onclick = () => {
              const checkbox = document.getElementById(`topping-${topping.id}`);
              checkbox.checked = !checkbox.checked;
              selectTopping(checkbox);
            };
            
            list.appendChild(div);
          }
        });
        
        console.log('  è¡¨ç¤ºã•ã‚ŒãŸãƒˆãƒƒãƒ”ãƒ³ã‚°æ•°:', displayedCount);
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œãªã—ã€ã‚’é¸æŠ
        const noneCheckbox = document.getElementById('topping-none');
        if (noneCheckbox) noneCheckbox.checked = true;
      }
      
      document.getElementById('toppingModal').classList.remove('hidden');
    }
    
    // ã€Œãªã—ã€ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’é¸æŠ
    window.selectNoneTopping = function(checkbox) {
      if (checkbox.checked) {
        // ä»–ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
        selectedToppings = [];
        toppingsData.forEach(t => {
          const cb = document.getElementById(`topping-${t.id}`);
          if (cb) cb.checked = false;
        });
      }
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’é¸æŠ
    window.selectTopping = function(checkbox) {
      const noneCheckbox = document.getElementById('topping-none');
      
      if (checkbox.checked) {
        // ã€Œãªã—ã€ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™
        noneCheckbox.checked = false;
        
        // é¸æŠã•ã‚ŒãŸãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’è¿½åŠ 
        const toppingId = checkbox.value;
        const topping = toppingsData.find(t => t.id === toppingId);
        if (topping && !selectedToppings.find(t => t.id === toppingId)) {
          selectedToppings.push(topping);
        }
      } else {
        // é¸æŠè§£é™¤
        selectedToppings = selectedToppings.filter(t => t.id !== checkbox.value);
        
        // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãŒä½•ã‚‚é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€Œãªã—ã€ã‚’é¸æŠ
        if (selectedToppings.length === 0) {
          noneCheckbox.checked = true;
        }
      }
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠã‚’ç¢ºå®š
    window.confirmTopping = function() {
      if (!currentSelectingItem) return;
      
      let toppingNames = 'ãªã—';
      let toppingPrice = 0;
      let toppingDetails = [];
      
      // æ–°ã—ã„å½¢å¼ï¼ˆtoppingSetsï¼‰ã®å ´åˆ
      if (currentSelectingItem.toppingSets && currentSelectingItem.toppingSets.length > 0) {
        if (selectedToppings.length > 0) {
          toppingNames = selectedToppings.map(t => t.optionName).join(', ');
          toppingPrice = selectedToppings.reduce((sum, t) => sum + t.price, 0);
          toppingDetails = selectedToppings.map(t => ({
            setName: t.setName,
            optionName: t.optionName,
            price: t.price
          }));
        }
      } else {
        // å¤ã„å½¢å¼ï¼ˆtoppingsIdï¼‰ã®å ´åˆ
        if (selectedToppings.length > 0) {
          toppingNames = selectedToppings.map(t => t.name).join(', ');
          toppingPrice = selectedToppings.reduce((sum, t) => sum + t.price, 0);
        }
      }
      
      // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’ç¢ºèª
      if (currentSelectingItem.editIndex !== undefined) {
        // æ—¢å­˜ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ›´æ–°
        manualCart[currentSelectingItem.editIndex].toppings = toppingNames;
        manualCart[currentSelectingItem.editIndex].toppingPrice = toppingPrice;
        manualCart[currentSelectingItem.editIndex].toppingDetails = toppingDetails;
        manualCart[currentSelectingItem.editIndex].quantity = currentToppingQuantity; // æ•°é‡ã‚‚æ›´æ–°
      } else {
        // æ–°è¦ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
        manualCart.push({
          ...currentSelectingItem,
          toppingsId: currentSelectingItem.toppingsId,  // æ˜ç¤ºçš„ã«ä¿å­˜
          quantity: currentToppingQuantity, // é¸æŠã—ãŸæ•°é‡ã‚’ä½¿ç”¨
          toppings: toppingNames,
          toppingPrice: toppingPrice,
          toppingDetails: toppingDetails
        });
      }
      
      closeToppingModal();
      updateManualCart();
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeToppingModal = function() {
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
      if (currentSelectingItem) {
        const checkbox = document.getElementById(`menu-${currentSelectingItem.id}`);
        if (checkbox && manualCart.filter(i => i.id === currentSelectingItem.id).length === 0) {
          checkbox.checked = false;
        }
      }
      
      document.getElementById('toppingModal').classList.add('hidden');
      currentSelectingItem = null;
      selectedToppings = [];
      currentToppingQuantity = 1; // æ•°é‡ã‚’ãƒªã‚»ãƒƒãƒˆ
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ•°é‡ã‚’å¢—ã‚„ã™
    window.incrementToppingQuantity = function() {
      currentToppingQuantity++;
      document.getElementById('toppingQuantityDisplay').textContent = currentToppingQuantity;
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã®æ•°é‡ã‚’æ¸›ã‚‰ã™
    window.decrementToppingQuantity = function() {
      if (currentToppingQuantity > 1) {
        currentToppingQuantity--;
        document.getElementById('toppingQuantityDisplay').textContent = currentToppingQuantity;
      }
    };
    
    // äºˆç´„ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    
    
    // ========== å±¥æ­´æ©Ÿèƒ½ ==========
    
    let historyOrders = [];
    
    // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showHistoryModal = async function() {
      document.getElementById('historyModal').classList.remove('hidden');
      await loadHistory();
    };
    
    // å±¥æ­´ã‚’èª­ã¿è¾¼ã¿
    async function loadHistory() {
      try {
        // timestampã§æ˜‡é †ï¼ˆå¤ã„é †ï¼‰ã«ã‚¯ã‚¨ãƒª
        const q = window.query(
          window.getStoreCollection('orders'),
          window.orderBy('timestamp', 'asc')
        );
        const ordersSnapshot = await window.getDocs(q);
        historyOrders = [];
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          historyOrders.push({
            id: doc.id,
            orderNumber: data.orderNumber || 0,
            timestamp: data.timestamp,
            tableNumber: data.tableNumber || '',
            items: data.items || [],
            totalAmount: data.totalAmount || 0,
            paymentMethod: data.paymentMethod || 'cash',  // æ”¯æ‰•æ–¹æ³•ã‚’è¿½åŠ 
            paidAt: data.paidAt || null,
            completedAt: data.completedAt || null,
            cancelledAt: data.cancelledAt || null,
            deleted: data.deleted || false,
            deletedAt: data.deletedAt || null
          });
        });
        
        // Firebaseã®ã‚¯ã‚¨ãƒªã§æ—¢ã«æ™‚ç³»åˆ—é †ï¼ˆå¤ã„é †ï¼‰ã«ã‚½ãƒ¼ãƒˆã•ã‚Œã¦ã„ã‚‹
        console.log('âœ… å±¥æ­´èª­ã¿è¾¼ã¿å®Œäº†:', historyOrders.length, 'ä»¶');
        
        filterHistory();
      } catch (e) {
        console.error('âŒ å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        alert('å±¥æ­´ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }
    
    // å±¥æ­´ã‚’ãƒ•ã‚£ãƒ«ã‚¿è¡¨ç¤º
    window.filterHistory = function() {
      const dateFilter = document.getElementById('historyDateFilter').value;
      const statusFilter = document.getElementById('historyStatusFilter').value;
      
      const now = new Date();
      
      let filtered = historyOrders.filter(order => {
        // æ—¥ä»˜ãƒ•ã‚£ãƒ«ã‚¿
        const orderDate = order.timestamp.toDate();
        
        let dateMatch = true;
        if (dateFilter === 'today') {
          // ä»Šæ—¥ï¼ˆåˆå‰3æ™‚åŒºåˆ‡ã‚Šï¼‰
          const todayStart = new Date(now);
          todayStart.setHours(3, 0, 0, 0);
          if (now.getHours() < 3) {
            todayStart.setDate(todayStart.getDate() - 1);
          }
          const todayEnd = new Date(todayStart);
          todayEnd.setDate(todayEnd.getDate() + 1);
          dateMatch = orderDate >= todayStart && orderDate < todayEnd;
        } else if (dateFilter === 'yesterday') {
          // æ˜¨æ—¥ï¼ˆåˆå‰3æ™‚åŒºåˆ‡ã‚Šï¼‰
          const yesterdayStart = new Date(now);
          yesterdayStart.setHours(3, 0, 0, 0);
          if (now.getHours() < 3) {
            yesterdayStart.setDate(yesterdayStart.getDate() - 1);
          }
          yesterdayStart.setDate(yesterdayStart.getDate() - 1);
          const yesterdayEnd = new Date(yesterdayStart);
          yesterdayEnd.setDate(yesterdayEnd.getDate() + 1);
          dateMatch = orderDate >= yesterdayStart && orderDate < yesterdayEnd;
        } else if (dateFilter === 'week') {
          // éå»7æ—¥é–“
          const weekAgo = new Date(now);
          weekAgo.setDate(weekAgo.getDate() - 7);
          weekAgo.setHours(0, 0, 0, 0);
          dateMatch = orderDate >= weekAgo;
        } else if (dateFilter === 'month') {
          // ä»Šæœˆ
          const monthStart = new Date(now);
          monthStart.setDate(1);
          monthStart.setHours(0, 0, 0, 0);
          dateMatch = orderDate >= monthStart;
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿
        let statusMatch = true;
        if (statusFilter === 'deleted') {
          statusMatch = order.deleted;
        } else if (statusFilter === 'paid') {
          statusMatch = order.paidAt && !order.deleted;
        } else if (statusFilter === 'completed') {
          statusMatch = order.completedAt && !order.deleted;
        } else if (statusFilter === 'cancelled') {
          statusMatch = order.cancelledAt && !order.deleted;
        }
        
        return dateMatch && statusMatch;
      });
      
      displayHistory(filtered);
    };
    
    // å±¥æ­´ã‚’è¡¨ç¤º
    function displayHistory(orders) {
      const container = document.getElementById('historyList');
      
      if (orders.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">è©²å½“ã™ã‚‹å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = '';
      
      // å¤ã„é †ã«è¡¨ç¤ºï¼ˆæ™‚ç³»åˆ—é †ï¼‰
      // æ—¢ã«Firebaseã‹ã‚‰å–å¾—ã—ãŸordersã¯æ™‚é–“é †ãªã®ã§ã€ãã®ã¾ã¾è¡¨ç¤º
      orders.forEach(order => {
        const card = document.createElement('div');
        card.style.cssText = `
          background: white;
          border-radius: 12px;
          padding: 15px;
          margin-bottom: 15px;
          border: 2px solid #ddd;
        `;
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸
        let badges = [];
        if (order.deleted) badges.push('<span style="background: #666; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">å‰Šé™¤æ¸ˆã¿</span>');
        if (order.paidAt) badges.push('<span style="background: #2196F3; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">ä¼šè¨ˆæ¸ˆ</span>');
        if (order.completedAt) badges.push('<span style="background: #4CAF50; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">å®Œäº†</span>');
        if (order.cancelledAt) badges.push('<span style="background: #f44336; color: white; padding: 4px 8px; border-radius: 6px; font-size: 12px; margin-right: 5px;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>');
        
        const orderDate = order.timestamp.toDate();
        const dateStr = orderDate.toLocaleString('ja-JP');
        
        // æ”¯æ‰•æ–¹æ³•ã‚’æ—¥æœ¬èªã«å¤‰æ›
        const paymentMethodNames = {
          'cash': 'ç¾é‡‘',
          'emoney': 'é›»å­ãƒãƒãƒ¼',
          'credit': 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰'
        };
        const paymentMethodLabel = paymentMethodNames[order.paymentMethod] || 'ç¾é‡‘';
        
        let itemsHtml = '';
        order.items.forEach(item => {
          itemsHtml += `<div style="padding: 5px 0; border-bottom: 1px solid #eee;">
            ${item.name} Ã—${item.quantity} - Â¥${((item.price + (item.toppingPrice || 0)) * item.quantity).toLocaleString()}
          </div>`;
        });
        
        // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
        let actionsHtml = `
          <div style="display: flex; gap: 10px; margin-top: 15px; padding-top: 15px; border-top: 2px solid #eee; flex-wrap: wrap;">
            <button onclick="editOrder('${order.id}')" style="flex: 1; min-width: 120px; padding: 10px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
              âœï¸ ç·¨é›†
            </button>
            ${order.paidAt ? `
              <button onclick="redSlip('${order.id}')" style="flex: 1; min-width: 120px; padding: 10px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                ğŸ”´ èµ¤ä¼ç¥¨
              </button>
            ` : `
              ${!order.deleted ? `
                <button onclick="deleteOrderFromHistory('${order.id}')" style="flex: 1; min-width: 120px; padding: 10px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                  ğŸ—‘ï¸ å–æ¶ˆ
                </button>
              ` : `
                <button onclick="restoreOrderFromHistory('${order.id}')" style="flex: 1; min-width: 120px; padding: 10px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                  ğŸ”„ å¾©å…ƒ
                </button>
              `}
            `}
            ${order.paidAt ? `
              <button onclick="reprintReceipt('${order.id}')" style="flex: 1; min-width: 120px; padding: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                ãƒ¬ã‚·ãƒ¼ãƒˆå†å°åˆ·
              </button>
              <button onclick="reprintInvoice('${order.id}')" style="flex: 1; min-width: 120px; padding: 10px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                é ˜åæ›¸å†å°åˆ·
              </button>
            ` : ''}
          </div>
        `;
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div>
              <strong style="font-size: 18px;">#${order.orderNumber}</strong>
              <span style="color: #666; margin-left: 10px;">${order.tableNumber}</span>
            </div>
            <div>${badges.join('')}</div>
          </div>
          <div style="font-size: 12px; color: #999; margin-bottom: 10px;">
            ${dateStr}
            ${order.paidAt ? `<span style="margin-left: 15px; padding: 4px 8px; background: #e3f2fd; color: #1976d2; border-radius: 4px; font-weight: bold;">ğŸ’³ ${paymentMethodLabel}</span>` : ''}
          </div>
          <div style="max-height: 150px; overflow-y: auto; margin: 10px 0;">
            ${itemsHtml}
          </div>
          <div style="text-align: right; font-size: 18px; font-weight: bold; color: #667eea; margin-top: 10px;">
            åˆè¨ˆ: Â¥${order.totalAmount.toLocaleString()}
          </div>
          ${actionsHtml}
        `;
        
        container.appendChild(card);
      });
    }
    
    // å±¥æ­´ã‹ã‚‰ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å†å°åˆ·
    window.reprintReceipt = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        if (!orderDoc.exists()) {
          alert('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        const orderData = orderDoc.data();
        
        // å•†å“ãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆä¿å­˜ã•ã‚Œã¦ã„ã‚‹ç¨ç‡æƒ…å ±ã‚’ä½¿ç”¨ï¼‰
        const itemsWithTaxRate = [];
        
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            itemsWithTaxRate.push({
              name: item.name,
              quantity: item.quantity,
              price: item.price + (item.toppingPrice || 0),
              toppings: item.toppings || 'ãªã—',
              taxRate: item.taxRate || 10,  // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ç¨ç‡ã‚’ä½¿ç”¨
              taxType: item.taxType || 'inclusive'  // ğŸ†• taxTypeã‚‚ä¿å­˜
            });
          });
        }
        
        // ãƒ¬ã‚¸è¢‹ã‚’è¿½åŠ 
        if (orderData.bagNeeded && orderData.bagQuantity > 0) {
          const bagTotal = orderData.bagPrice || (orderData.bagQuantity * 3);
          const bagUnitPrice = Math.round(bagTotal / orderData.bagQuantity);
          itemsWithTaxRate.push({
            name: 'ğŸ›ï¸ ãƒ¬ã‚¸è¢‹',
            quantity: orderData.bagQuantity,
            price: bagUnitPrice,
            toppings: 'ãªã—',
            taxRate: 10,
            taxType: 'inclusive'
          });
        }
        
        // lastPaymentDataã‚’å†æ§‹ç¯‰
        lastPaymentData = {
          orderNumbers: [orderData.orderNumber],
          tableNumber: orderData.tableNumber,
          items: itemsWithTaxRate,
          totalAmount: orderData.totalAmount,
          paymentMethod: orderData.paymentMethod || 'cash',
          staffName: orderData.staffName || 'ãƒ¬ã‚¸ä¿‚',
          cashReceived: orderData.totalAmount,
          change: 0,
          timestamp: orderData.paidAt ? orderData.paidAt.toDate() : orderData.timestamp.toDate()
        };
        
        await printReceipt();
      } catch (e) {
        console.error('å†å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        alert('ãƒ¬ã‚·ãƒ¼ãƒˆã®å†å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // å±¥æ­´ã‹ã‚‰é ˜åæ›¸ã‚’å†å°åˆ·
    window.reprintInvoice = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        if (!orderDoc.exists()) {
          alert('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        const orderData = orderDoc.data();
        
        // å•†å“ãƒªã‚¹ãƒˆã‚’ä½œæˆ
        const itemsWithTaxRate = [];
        
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            itemsWithTaxRate.push({
              name: item.name,
              quantity: item.quantity,
              price: item.price + (item.toppingPrice || 0),
              toppings: item.toppings || 'ãªã—',
              taxRate: item.taxRate || 10,  // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ç¨ç‡ã‚’ä½¿ç”¨
              taxType: item.taxType || 'inclusive'  // ğŸ†• taxTypeã‚‚ä¿å­˜
            });
          });
        }
        
        // ãƒ¬ã‚¸è¢‹ã‚’è¿½åŠ 
        if (orderData.bagNeeded && orderData.bagQuantity > 0) {
          const bagTotal = orderData.bagPrice || (orderData.bagQuantity * 3);
          const bagUnitPrice = Math.round(bagTotal / orderData.bagQuantity);
          itemsWithTaxRate.push({
            name: 'ğŸ›ï¸ ãƒ¬ã‚¸è¢‹',
            quantity: orderData.bagQuantity,
            price: bagUnitPrice,
            toppings: 'ãªã—',
            taxRate: 10,
            taxType: 'inclusive'
          });
        }
        
        // lastPaymentDataã‚’å†æ§‹ç¯‰
        lastPaymentData = {
          orderNumbers: [orderData.orderNumber],
          tableNumber: orderData.tableNumber,
          items: itemsWithTaxRate,
          totalAmount: orderData.totalAmount,
          paymentMethod: orderData.paymentMethod || 'cash',
          staffName: orderData.staffName || 'ãƒ¬ã‚¸ä¿‚',
          cashReceived: orderData.totalAmount,
          change: 0,
          timestamp: orderData.paidAt ? orderData.paidAt.toDate() : orderData.timestamp.toDate()
        };
        
        await printInvoice();
      } catch (e) {
        console.error('å†å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        alert('é ˜åæ›¸ã®å†å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // å±¥æ­´ã‚’æ›´æ–°
    window.refreshHistory = async function() {
      await loadHistory();
    };
    
    // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeHistoryModal = function() {
      document.getElementById('historyModal').classList.add('hidden');
    };
    
    // ===== æ³¨æ–‡ç·¨é›†æ©Ÿèƒ½ =====
    let currentEditingOrder = null;
    
    // æ³¨æ–‡ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.editOrder = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        if (!orderDoc.exists()) {
          alert('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        const orderData = orderDoc.data();
        
        // ğŸ” ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°: æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
        console.log('ğŸ” æ³¨æ–‡ç·¨é›†é–‹å§‹:', {
          æ³¨æ–‡ID: orderId,
          æ³¨æ–‡ç•ªå·: orderData.orderNumber,
          ãƒ†ãƒ¼ãƒ–ãƒ«: orderData.tableNumber,
          é‡‘é¡: orderData.totalAmount,
          æ”¯æ‰•æ–¹æ³•: orderData.paymentMethod,
          paidAt: orderData.paidAt,
          paidAtã‚¿ã‚¤ãƒ—: typeof orderData.paidAt,
          timestamp: orderData.timestamp
        });
        
        currentEditingOrder = {
          id: orderId,
          ...orderData,
          originalTotalAmount: orderData.totalAmount,  // ğŸ†• å…ƒã®é‡‘é¡ã‚’ä¿å­˜
          originalPaymentMethod: orderData.paymentMethod  // ğŸ†• å…ƒã®æ”¯æ‰•æ–¹æ³•ã‚‚ä¿å­˜
        };
        
        // æ”¯æ‰•æ–¹æ³•ã®é¸æŠè‚¢
        const paymentMethods = {
          'cash': 'ç¾é‡‘',
          'emoney': 'é›»å­ãƒãƒãƒ¼',
          'credit': 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰'
        };
        
        let paymentMethodOptions = '';
        Object.keys(paymentMethods).forEach(method => {
          const selected = orderData.paymentMethod === method ? 'selected' : '';
          paymentMethodOptions += `<option value="${method}" ${selected}>${paymentMethods[method]}</option>`;
        });
        
        // å•†å“ãƒªã‚¹ãƒˆ
        let itemsHtml = '';
        if (orderData.items && orderData.items.length > 0) {
          orderData.items.forEach((item, index) => {
            // ãƒˆãƒƒãƒ”ãƒ³ã‚°è¡¨ç¤ºï¼ˆtoppingDetailsã¾ãŸã¯toppingsDataã‚’å„ªå…ˆï¼‰
            let toppingsHtml = '';
            if (item.toppingDetails && item.toppingDetails.length > 0) {
              // æ–°ã—ã„å½¢å¼: toppingDetailsãŒã‚ã‚‹å ´åˆ
              const groupedBySet = {};
              item.toppingDetails.forEach(detail => {
                if (!groupedBySet[detail.setName]) {
                  groupedBySet[detail.setName] = [];
                }
                groupedBySet[detail.setName].push(detail.optionName);
              });
              
              toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
                return `
                  <div style="font-size: 12px; color: #666; font-weight: bold; margin-top: 5px;">${setName}</div>
                  ${options.map(opt => `<div style="font-size: 12px; color: #666; margin-left: 10px;">ãƒ»${opt}</div>`).join('')}
                `;
              }).join('');
            } else if (item.toppingsData && item.toppingsData.length > 0) {
              // ğŸ†• menu.htmlã‹ã‚‰ã®æ–°ã—ã„å½¢å¼: toppingsDataãŒã‚ã‚‹å ´åˆ
              const groupedBySet = {};
              item.toppingsData.forEach(topping => {
                const setName = topping.setName || 'ãƒˆãƒƒãƒ”ãƒ³ã‚°';
                if (!groupedBySet[setName]) {
                  groupedBySet[setName] = [];
                }
                groupedBySet[setName].push(topping.name);
              });
              
              toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
                return `
                  <div style="font-size: 12px; color: #666; font-weight: bold; margin-top: 5px;">${setName}</div>
                  ${options.map(opt => `<div style="font-size: 12px; color: #666; margin-left: 10px;">ãƒ»${opt}</div>`).join('')}
                `;
              }).join('');
            } else if (item.toppings && item.toppings !== 'ãªã—' && item.toppings !== 'æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°') {
              // å¤ã„å½¢å¼: toppingsã®ã¿ã®å ´åˆ
              toppingsHtml = `<div style="font-size: 12px; color: #666;">ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${item.toppings}</div>`;
            }
            
            itemsHtml += `
              <div style="padding: 10px; background: #f5f5f5; border-radius: 8px; margin-bottom: 10px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <strong>${item.name}</strong>
                    ${toppingsHtml}
                  </div>
                  <button onclick="removeItemFromOrder(${index})" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
                </div>
                <div style="display: flex; gap: 10px; align-items: center; margin-top: 10px;">
                  <label>æ•°é‡:</label>
                  <input type="number" value="${item.quantity}" onchange="updateItemQuantity(${index}, this.value)" min="1" style="width: 80px; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
                  <span style="margin-left: auto; font-weight: bold;">Â¥${((item.price + (item.toppingPrice || 0)) * item.quantity).toLocaleString()}</span>
                </div>
              </div>
            `;
          });
        }
        
        const content = document.getElementById('editOrderContent');
        content.innerHTML = `
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ³¨æ–‡ç•ªå·</label>
            <div style="font-size: 24px; color: #667eea;">#${orderData.orderNumber || 0}</div>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·</label>
            <input type="text" id="editTableNumber" value="${orderData.tableNumber || ''}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">æ”¯æ‰•æ–¹æ³•</label>
            <select id="editPaymentMethod" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;">
              ${paymentMethodOptions}
            </select>
          </div>
          
          <div style="margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 10px; font-weight: bold;">æ³¨æ–‡å•†å“</label>
            ${itemsHtml || '<div style="text-align: center; padding: 20px; color: #999;">å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>'}
          </div>
          
          <div style="padding: 15px; background: #e3f2fd; border-radius: 8px; text-align: right;">
            <span style="font-size: 18px; font-weight: bold;">åˆè¨ˆ: </span>
            <span id="editTotalAmount" style="font-size: 24px; font-weight: bold; color: #1976d2;">Â¥${(orderData.totalAmount || 0).toLocaleString()}</span>
          </div>
        `;
        
        // ãƒœã‚¿ãƒ³ã‚’å‹•çš„ã«ç”Ÿæˆï¼ˆå‰Šé™¤æ¸ˆã¿ã‹ã©ã†ã‹ã§å¤‰ã‚ã‚‹ï¼‰
        const buttonsContainer = document.getElementById('editOrderButtons');
        if (orderData.paidAt) {
          // ä¼šè¨ˆæ¸ˆã¿æ³¨æ–‡ï¼šå‰Šé™¤çŠ¶æ…‹ã«é–¢ã‚ã‚‰ãšèµ¤ä¼ç¥¨
          buttonsContainer.innerHTML = `
            <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveOrderEdit()">ä¿å­˜</button>
            <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="redSlipFromEdit()">ğŸ”´ èµ¤ä¼ç¥¨</button>
            <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditOrderModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
          `;
        } else {
          // æœªä¼šè¨ˆæ³¨æ–‡
          if (orderData.deleted) {
            // å‰Šé™¤æ¸ˆã¿æœªä¼šè¨ˆæ³¨æ–‡ï¼šå¾©å…ƒå¯èƒ½
            buttonsContainer.innerHTML = `
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveOrderEdit()">ä¿å­˜</button>
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white;" onclick="restoreOrder()">æ³¨æ–‡ã‚’å¾©å…ƒ</button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditOrderModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            `;
          } else {
            // é€šå¸¸ã®æœªä¼šè¨ˆæ³¨æ–‡ï¼šå–æ¶ˆå¯èƒ½
            buttonsContainer.innerHTML = `
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveOrderEdit()">ä¿å­˜</button>
              <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="deleteOrderFromEdit()">ğŸ—‘ï¸ æ³¨æ–‡å–æ¶ˆ</button>
              <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditOrderModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            `;
          }
        }
        
        document.getElementById('editOrderModal').classList.remove('hidden');
        
      } catch (e) {
        console.error('æ³¨æ–‡ç·¨é›†ã‚¨ãƒ©ãƒ¼:', e);
        alert('æ³¨æ–‡ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };
    
    // æ³¨æ–‡ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeEditOrderModal = function() {
      document.getElementById('editOrderModal').classList.add('hidden');
      currentEditingOrder = null;
    };
    
    // å•†å“ã‚’æ³¨æ–‡ã‹ã‚‰å‰Šé™¤
    window.removeItemFromOrder = async function(index) {
      if (!currentEditingOrder) return;
      
      const item = currentEditingOrder.items[index];
      const itemName = item.name || 'å•†å“';
      const itemPrice = (item.price + (item.toppingPrice || 0)) * item.quantity;
      
      // ğŸ¨ ã‚ªã‚·ãƒ£ãƒ¬ãªç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      const confirmed = await showCustomConfirm({
        icon: 'ğŸ—‘ï¸',
        title: 'å•†å“ã‚’å‰Šé™¤',
        message: `${itemName}\nÂ¥${itemPrice.toLocaleString()}\n\nã“ã®å•†å“ã‚’æ³¨æ–‡ã‹ã‚‰å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`,
        confirmText: 'å‰Šé™¤ã™ã‚‹',
        confirmColor: '#f44336'
      });
      
      if (confirmed) {
        try {
          console.log('ğŸ—‘ï¸ å•†å“å‰Šé™¤å‡¦ç†é–‹å§‹:', itemName);
          
          // å•†å“ã‚’é…åˆ—ã‹ã‚‰å‰Šé™¤
          currentEditingOrder.items.splice(index, 1);
          
          // åˆè¨ˆé‡‘é¡ã‚’å†è¨ˆç®—
          let total = 0;
          let tax8Total = 0;
          let tax10Total = 0;
          
          currentEditingOrder.items.forEach(item => {
            const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
            total += itemTotal;
            
            // ç¨ç‡åˆ¥é›†è¨ˆ
            if (item.taxRate === 8) {
              tax8Total += itemTotal;
            } else {
              tax10Total += itemTotal;
            }
          });
          
          currentEditingOrder.totalAmount = total;
          currentEditingOrder.tax8Total = tax8Total;
          currentEditingOrder.tax10Total = tax10Total;
          
          // ğŸ”¥ Firestoreã«ä¿å­˜
          await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), {
            items: currentEditingOrder.items,
            totalAmount: total,
            tax8Total: tax8Total,
            tax10Total: tax10Total,
            updatedAt: window.Timestamp.now()
          });
          
          console.log('âœ… å•†å“ã‚’å‰Šé™¤ã—ã¦Firestoreã«ä¿å­˜ã—ã¾ã—ãŸ');
          
          // è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å†æç”»ï¼‰
          editOrder(currentEditingOrder.id);
          
          showCustomAlert('å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'âœ… å®Œäº†', 'ğŸ—‘ï¸');
          
        } catch (e) {
          console.error('å•†å“å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e);
          showCustomAlert('å•†å“ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'âŒ ã‚¨ãƒ©ãƒ¼', 'âš ï¸');
        }
      }
    };
    
    // å•†å“ã®æ•°é‡ã‚’æ›´æ–°
    window.updateItemQuantity = function(index, newQuantity) {
      if (!currentEditingOrder) return;
      
      const quantity = parseInt(newQuantity) || 1;
      currentEditingOrder.items[index].quantity = quantity;
      
      // åˆè¨ˆé‡‘é¡ã‚’å†è¨ˆç®—
      let total = 0;
      currentEditingOrder.items.forEach(item => {
        total += (item.price + (item.toppingPrice || 0)) * item.quantity;
      });
      currentEditingOrder.totalAmount = total;
      
      // åˆè¨ˆé‡‘é¡ã®è¡¨ç¤ºã‚’æ›´æ–°
      document.getElementById('editTotalAmount').textContent = `Â¥${total.toLocaleString()}`;
    };
    
    // æ³¨æ–‡ã®å¤‰æ›´ã‚’ä¿å­˜
    window.saveOrderEdit = async function() {
      if (!currentEditingOrder) return;
      
      try {
        const tableNumber = document.getElementById('editTableNumber').value;
        const paymentMethod = document.getElementById('editPaymentMethod').value;
        
        // å…ƒã®æ”¯æ‰•ã„æ–¹æ³•ã¨é‡‘é¡ã‚’å–å¾—ï¼ˆå£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£ç”¨ï¼‰
        const oldPaymentMethod = currentEditingOrder.originalPaymentMethod || currentEditingOrder.paymentMethod;
        const oldTotalAmount = currentEditingOrder.originalTotalAmount || currentEditingOrder.totalAmount;
        const newTotalAmount = currentEditingOrder.totalAmount;
        
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('ğŸ“ æ³¨æ–‡ç·¨é›†ä¿å­˜é–‹å§‹');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('æ³¨æ–‡ID:', currentEditingOrder.id);
        console.log('æ³¨æ–‡ç•ªå·:', currentEditingOrder.orderNumber);
        console.log('paidAt:', currentEditingOrder.paidAt);
        console.log('timestamp:', currentEditingOrder.timestamp);
        console.log('æ—§æ”¯æ‰•æ–¹æ³•:', oldPaymentMethod);
        console.log('æ–°æ”¯æ‰•æ–¹æ³•:', paymentMethod);
        console.log('æ—§é‡‘é¡:', oldTotalAmount);
        console.log('æ–°é‡‘é¡:', newTotalAmount);
        
        // å…ƒã®paidAtã‹ã‚‰æ—¥ä»˜ã‚’å–å¾—ï¼ˆå£²ä¸Šãƒ‡ãƒ¼ã‚¿æ›´æ–°ç”¨ï¼‰
        let originalDateStr = null;
        let useTimestamp = false;
        let isUnpaidOrder = false;
        
        try {
          let dateToUse = null;
          
          // paidAtãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
          if (currentEditingOrder.paidAt) {
            dateToUse = currentEditingOrder.paidAt.toDate();
            console.log('ğŸ“… paidAtã‚’ä½¿ç”¨:', dateToUse);
          }
          // paidAtãŒãªã„å ´åˆã¯timestampã‚’ä½¿ç”¨
          else if (currentEditingOrder.timestamp) {
            dateToUse = currentEditingOrder.timestamp.toDate();
            useTimestamp = true;
            isUnpaidOrder = true;
            console.log('ğŸ“… timestampã‚’ä½¿ç”¨:', dateToUse);
            console.log('âš ï¸ ã“ã®æ³¨æ–‡ã¯æœªä¼šè¨ˆã§ã™');
          }
          
          if (dateToUse) {
            let targetDate = new Date(dateToUse);
            
            // åˆå‰3æ™‚ã‚ˆã‚Šå‰ãªã‚‰æ˜¨æ—¥æ‰±ã„
            if (dateToUse.getHours() < 3) {
              targetDate.setDate(targetDate.getDate() - 1);
            }
            
            originalDateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth()+1).padStart(2,'0')}-${String(targetDate.getDate()).padStart(2,'0')}`;
            console.log('ğŸ“… å…ƒã®ä¼šè¨ˆæ—¥ä»˜:', originalDateStr);
            console.log('   å…ƒã®æ—¥æ™‚:', dateToUse.toLocaleString('ja-JP'));
          } else {
            throw new Error('paidAtã‚‚timestampã‚‚å­˜åœ¨ã—ã¾ã›ã‚“');
          }
        } catch (error) {
          console.error('âŒ æ—¥ä»˜ã®å¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
          console.error('   paidAt:', currentEditingOrder.paidAt);
          console.error('   timestamp:', currentEditingOrder.timestamp);
          showCustomAlert('æ—¥ä»˜ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã®ã¿æ›´æ–°ã—ã¾ã™ã€‚', 'âš ï¸ è­¦å‘Š', 'âš ï¸');
          
          // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã®ã¿æ›´æ–°
          await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), {
            tableNumber: tableNumber,
            paymentMethod: paymentMethod,
            items: currentEditingOrder.items,
            totalAmount: currentEditingOrder.totalAmount
          });
          
          closeEditOrderModal();
          await loadHistory();
          return;
        }
        
        // ç¾åœ¨ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆæœ¬æ—¥ã®å£²ä¸Šã‹ã‚‰æ¸›ç®—ã™ã‚‹ãŸã‚ï¼‰
        const now = new Date();
        let todayDate = new Date(now);
        if (now.getHours() < 3) {
          todayDate.setDate(todayDate.getDate() - 1);
        }
        const todayDateStr = `${todayDate.getFullYear()}-${String(todayDate.getMonth()+1).padStart(2,'0')}-${String(todayDate.getDate()).padStart(2,'0')}`;
        console.log('ğŸ“… æœ¬æ—¥ã®æ—¥ä»˜:', todayDateStr);
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        
        // æ³¨æ–‡ã‚’æ›´æ–°
        const orderUpdates = {
          tableNumber: tableNumber,
          paymentMethod: paymentMethod,
          items: currentEditingOrder.items,
          totalAmount: currentEditingOrder.totalAmount
        };
        
        // ğŸ†• æœªä¼šè¨ˆã®æ³¨æ–‡ã‚’ç·¨é›†ã—ãŸå ´åˆã¯ã€ä¼šè¨ˆæ¸ˆã¿ã«ã™ã‚‹
        if (isUnpaidOrder) {
          console.log('ğŸ’¡ æœªä¼šè¨ˆã®æ³¨æ–‡ãªã®ã§ã€ä¼šè¨ˆæ¸ˆã¿ã¨ã—ã¦æ›´æ–°ã—ã¾ã™');
          console.log('   å…ƒã®æ³¨æ–‡æ—¥æ™‚:', currentEditingOrder.timestamp.toDate().toLocaleString('ja-JP'));
          console.log('   paidAtã¨ã—ã¦è¨­å®šã™ã‚‹æ—¥æ™‚:', currentEditingOrder.timestamp.toDate().toLocaleString('ja-JP'));
          
          // timestampã‚’paidAtã¨ã—ã¦è¨­å®šï¼ˆå…ƒã®æ³¨æ–‡æ—¥æ™‚ã§ä¼šè¨ˆæ¸ˆã¿ã«ã™ã‚‹ï¼‰
          orderUpdates.paidAt = currentEditingOrder.timestamp;
          orderUpdates.notifiedPaid = true;
          
          showCustomAlert(
            `æ³¨æ–‡ã‚’æ›´æ–°ã—ã€ä¼šè¨ˆæ¸ˆã¿ã¨ã—ã¾ã—ãŸ\n\nä¼šè¨ˆæ—¥æ™‚: ${originalDateStr}`,
            'âœ… å®Œäº†',
            'ğŸ’¾'
          );
        }
        
        await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), orderUpdates);
        console.log('âœ… æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿æ›´æ–°å®Œäº†');
        
        // å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’ä¿®æ­£
        const isDateDifferent = originalDateStr !== todayDateStr;
        const isPaymentMethodChanged = oldPaymentMethod !== paymentMethod;
        const isAmountChanged = oldTotalAmount !== newTotalAmount;
        
        // ğŸ†• æœªä¼šè¨ˆæ³¨æ–‡ã®å ´åˆã¯å¸¸ã«æ›´æ–°ãŒå¿…è¦
        const needsUpdate = isUnpaidOrder || isDateDifferent || isPaymentMethodChanged || isAmountChanged;
        
        console.log('ğŸ’¡ å£²ä¸Šæ›´æ–°åˆ¤å®š:', {
          å…ƒã®æ—¥ä»˜: originalDateStr,
          æœ¬æ—¥: todayDateStr,
          æœªä¼šè¨ˆæ³¨æ–‡: isUnpaidOrder,
          æ—¥ä»˜ãŒç•°ãªã‚‹: isDateDifferent,
          æ”¯æ‰•æ–¹æ³•å¤‰æ›´: isPaymentMethodChanged,
          é‡‘é¡å¤‰æ›´: isAmountChanged,
          æ›´æ–°ãŒå¿…è¦: needsUpdate
        });
        
        if (!needsUpdate) {
          console.log('â„¹ï¸ å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã®æ›´æ–°ã¯ä¸è¦ã§ã™');
          showCustomAlert('æ³¨æ–‡ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'âœ… å®Œäº†', 'ğŸ’¾');
          closeEditOrderModal();
          await loadHistory();
          return;
        }
        
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('ğŸ’° å£²ä¸Šãƒ‡ãƒ¼ã‚¿ä¿®æ­£é–‹å§‹');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
          
          // ============================================
          // STEP 1: æœ¬æ—¥ã®å£²ä¸Šã‹ã‚‰æ¸›ç®—ï¼ˆèª¤ã£ã¦æœ¬æ—¥ã«è¨ˆä¸Šã•ã‚Œã¦ã„ã‚‹åˆ†ï¼‰
          // â€» æœªä¼šè¨ˆæ³¨æ–‡ã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆã¾ã å£²ä¸Šã«è¨ˆä¸Šã•ã‚Œã¦ã„ãªã„ï¼‰
          // ============================================
          if (isDateDifferent && !isUnpaidOrder) {
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('ğŸ”½ STEP 1: æœ¬æ—¥ã®å£²ä¸Šã‹ã‚‰æ¸›ç®—');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('å¯¾è±¡æ—¥ä»˜:', todayDateStr);
            console.log('æ¸›ç®—ã™ã‚‹é‡‘é¡:', oldTotalAmount);
            console.log('æ¸›ç®—ã™ã‚‹æ”¯æ‰•æ–¹æ³•:', oldPaymentMethod);
            
            const todaySalesRef = window.getStoreDoc('dailySales', todayDateStr);
            const todaySalesDoc = await window.getDoc(todaySalesRef);
            
            if (todaySalesDoc.exists()) {
              const todayData = todaySalesDoc.data();
              console.log('æœ¬æ—¥ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ï¼ˆæ›´æ–°å‰ï¼‰:', {
                totalSales: todayData.totalSales,
                cashSales: todayData.cashSales,
                emoneSales: todayData.emoneSales,
                creditSales: todayData.creditSales
              });
              
              const todayUpdates = {
                updatedAt: window.Timestamp.now()
              };
              
              // ã€æ³¨æ„ã€‘æœ¬æ—¥ã®å£²ä¸Šã‹ã‚‰ã€ç·¨é›†å‰ã®æ³¨æ–‡ã‚’æ¸›ç®—
              // æ”¯æ‰•æ–¹æ³•ã¯ã€Œç·¨é›†å‰ã€ã®ã‚‚ã®ã‚’ä½¿ã†
              if (oldPaymentMethod === 'cash') {
                todayUpdates.cashSales = Math.max(0, (todayData.cashSales || 0) - oldTotalAmount);
                console.log(`   ç¾é‡‘å£²ä¸Š: ${todayData.cashSales} - ${oldTotalAmount} = ${todayUpdates.cashSales}`);
              } else if (oldPaymentMethod === 'emoney') {
                todayUpdates.emoneSales = Math.max(0, (todayData.emoneSales || 0) - oldTotalAmount);
                console.log(`   é›»å­ãƒãƒãƒ¼å£²ä¸Š: ${todayData.emoneSales} - ${oldTotalAmount} = ${todayUpdates.emoneSales}`);
              } else if (oldPaymentMethod === 'credit') {
                todayUpdates.creditSales = Math.max(0, (todayData.creditSales || 0) - oldTotalAmount);
                console.log(`   ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå£²ä¸Š: ${todayData.creditSales} - ${oldTotalAmount} = ${todayUpdates.creditSales}`);
              }
              
              todayUpdates.totalSales = Math.max(0, (todayData.totalSales || 0) - oldTotalAmount);
              console.log(`   åˆè¨ˆå£²ä¸Š: ${todayData.totalSales} - ${oldTotalAmount} = ${todayUpdates.totalSales}`);
              
              await window.updateDoc(todaySalesRef, todayUpdates);
              console.log('âœ… æœ¬æ—¥ã®å£²ä¸Šã‹ã‚‰æ¸›ç®—å®Œäº†');
            } else {
              console.warn('âš ï¸ æœ¬æ—¥ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', todayDateStr);
            }
          } else {
            console.log('â„¹ï¸ æœ¬æ—¥ã¨å…ƒã®æ—¥ä»˜ãŒåŒã˜ã€ã¾ãŸã¯æœªä¼šè¨ˆæ³¨æ–‡ã®ãŸã‚ã€STEP 1ã¯ã‚¹ã‚­ãƒƒãƒ—');
          }
          
          // ============================================
          // STEP 2: å…ƒã®æ—¥ä»˜ã®å£²ä¸Šã‚’ä¿®æ­£ï¼ˆæ­£ã—ã„æ—¥ä»˜ã«è¨ˆä¸Šï¼‰
          // ============================================
          console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
          console.log('ğŸ”¼ STEP 2: å…ƒã®æ—¥ä»˜ã®å£²ä¸Šã‚’ä¿®æ­£');
          console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
          console.log('å¯¾è±¡æ—¥ä»˜:', originalDateStr);
          
          const originalSalesRef = window.getStoreDoc('dailySales', originalDateStr);
          const originalSalesDoc = await window.getDoc(originalSalesRef);
          
          if (originalSalesDoc.exists()) {
            const originalData = originalSalesDoc.data();
            console.log('å…ƒã®æ—¥ä»˜ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ï¼ˆæ›´æ–°å‰ï¼‰:', {
              totalSales: originalData.totalSales,
              cashSales: originalData.cashSales,
              emoneSales: originalData.emoneSales,
              creditSales: originalData.creditSales
            });
            
            const originalUpdates = {
              updatedAt: window.Timestamp.now()
            };
            
            // ğŸ†• ã€ãƒ‘ã‚¿ãƒ¼ãƒ³Aã€‘æœªä¼šè¨ˆæ³¨æ–‡ã®å ´åˆ
            // â†’ å˜ç´”ã«æ–°ã—ã„å†…å®¹ã‚’åŠ ç®—ï¼ˆæ¸›ç®—ã¯ä¸è¦ï¼‰
            if (isUnpaidOrder) {
              console.log('ğŸ“Œ ãƒ‘ã‚¿ãƒ¼ãƒ³A: æœªä¼šè¨ˆæ³¨æ–‡ãªã®ã§æ–°ã—ã„å†…å®¹ã‚’åŠ ç®—');
              console.log('   åŠ ç®—ã™ã‚‹é‡‘é¡:', newTotalAmount);
              console.log('   åŠ ç®—ã™ã‚‹æ”¯æ‰•æ–¹æ³•:', paymentMethod);
              
              if (paymentMethod === 'cash') {
                originalUpdates.cashSales = (originalData.cashSales || 0) + newTotalAmount;
                console.log(`   ç¾é‡‘å£²ä¸Š: ${originalData.cashSales} + ${newTotalAmount} = ${originalUpdates.cashSales}`);
              } else if (paymentMethod === 'emoney') {
                originalUpdates.emoneSales = (originalData.emoneSales || 0) + newTotalAmount;
                console.log(`   é›»å­ãƒãƒãƒ¼å£²ä¸Š: ${originalData.emoneSales} + ${newTotalAmount} = ${originalUpdates.emoneSales}`);
              } else if (paymentMethod === 'credit') {
                originalUpdates.creditSales = (originalData.creditSales || 0) + newTotalAmount;
                console.log(`   ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå£²ä¸Š: ${originalData.creditSales} + ${newTotalAmount} = ${originalUpdates.creditSales}`);
              }
              originalUpdates.totalSales = (originalData.totalSales || 0) + newTotalAmount;
              originalUpdates.customerCount = (originalData.customerCount || 0) + 1;  // å®¢æ•°ã‚‚åŠ ç®—
              console.log(`   åˆè¨ˆå£²ä¸Š: ${originalData.totalSales} + ${newTotalAmount} = ${originalUpdates.totalSales}`);
              console.log(`   å®¢æ•°: ${originalData.customerCount} + 1 = ${originalUpdates.customerCount}`);
            }
            // ã€ãƒ‘ã‚¿ãƒ¼ãƒ³Bã€‘å…ƒã®æ—¥ä»˜ã¨æœ¬æ—¥ãŒç•°ãªã‚‹å ´åˆ
            // â†’ å…ƒã®æ—¥ä»˜ã«æ–°ã—ã„å†…å®¹ã‚’ã€ŒåŠ ç®—ã€
            else if (isDateDifferent) {
              console.log('ğŸ“Œ ãƒ‘ã‚¿ãƒ¼ãƒ³B: ç•°ãªã‚‹æ—¥ä»˜ãªã®ã§æ–°ã—ã„å†…å®¹ã‚’åŠ ç®—');
              console.log('   åŠ ç®—ã™ã‚‹é‡‘é¡:', newTotalAmount);
              console.log('   åŠ ç®—ã™ã‚‹æ”¯æ‰•æ–¹æ³•:', paymentMethod);
              
              if (paymentMethod === 'cash') {
                originalUpdates.cashSales = (originalData.cashSales || 0) + newTotalAmount;
                console.log(`   ç¾é‡‘å£²ä¸Š: ${originalData.cashSales} + ${newTotalAmount} = ${originalUpdates.cashSales}`);
              } else if (paymentMethod === 'emoney') {
                originalUpdates.emoneSales = (originalData.emoneSales || 0) + newTotalAmount;
                console.log(`   é›»å­ãƒãƒãƒ¼å£²ä¸Š: ${originalData.emoneSales} + ${newTotalAmount} = ${originalUpdates.emoneSales}`);
              } else if (paymentMethod === 'credit') {
                originalUpdates.creditSales = (originalData.creditSales || 0) + newTotalAmount;
                console.log(`   ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå£²ä¸Š: ${originalData.creditSales} + ${newTotalAmount} = ${originalUpdates.creditSales}`);
              }
              originalUpdates.totalSales = (originalData.totalSales || 0) + newTotalAmount;
              console.log(`   åˆè¨ˆå£²ä¸Š: ${originalData.totalSales} + ${newTotalAmount} = ${originalUpdates.totalSales}`);
            }
            // ã€ãƒ‘ã‚¿ãƒ¼ãƒ³Cã€‘å…ƒã®æ—¥ä»˜ã¨æœ¬æ—¥ãŒåŒã˜å ´åˆ
            // â†’ æ”¯æ‰•æ–¹æ³•ã‚„é‡‘é¡ã®å¤‰æ›´ã‚’åæ˜ ï¼ˆå·®åˆ†è¨ˆç®—ï¼‰
            else {
              console.log('ğŸ“Œ ãƒ‘ã‚¿ãƒ¼ãƒ³C: åŒã˜æ—¥ä»˜ãªã®ã§å·®åˆ†ã‚’è¨ˆç®—');
              console.log('   æ—§:', oldPaymentMethod, oldTotalAmount);
              console.log('   æ–°:', paymentMethod, newTotalAmount);
              
              // æ—§æ”¯æ‰•æ–¹æ³•ã‹ã‚‰æ¸›ç®—
              if (oldPaymentMethod === 'cash') {
                originalUpdates.cashSales = (originalData.cashSales || 0) - oldTotalAmount;
                console.log(`   ç¾é‡‘å£²ä¸Šï¼ˆæ¸›ç®—ï¼‰: ${originalData.cashSales} - ${oldTotalAmount} = ${originalUpdates.cashSales}`);
              } else if (oldPaymentMethod === 'emoney') {
                originalUpdates.emoneSales = (originalData.emoneSales || 0) - oldTotalAmount;
                console.log(`   é›»å­ãƒãƒãƒ¼å£²ä¸Šï¼ˆæ¸›ç®—ï¼‰: ${originalData.emoneSales} - ${oldTotalAmount} = ${originalUpdates.emoneSales}`);
              } else if (oldPaymentMethod === 'credit') {
                originalUpdates.creditSales = (originalData.creditSales || 0) - oldTotalAmount;
                console.log(`   ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå£²ä¸Šï¼ˆæ¸›ç®—ï¼‰: ${originalData.creditSales} - ${oldTotalAmount} = ${originalUpdates.creditSales}`);
              }
              
              // æ–°æ”¯æ‰•æ–¹æ³•ã«åŠ ç®—
              if (paymentMethod === 'cash') {
                originalUpdates.cashSales = (originalUpdates.cashSales !== undefined ? originalUpdates.cashSales : originalData.cashSales || 0) + newTotalAmount;
                console.log(`   ç¾é‡‘å£²ä¸Šï¼ˆåŠ ç®—ï¼‰: + ${newTotalAmount} = ${originalUpdates.cashSales}`);
              } else if (paymentMethod === 'emoney') {
                originalUpdates.emoneSales = (originalUpdates.emoneSales !== undefined ? originalUpdates.emoneSales : originalData.emoneSales || 0) + newTotalAmount;
                console.log(`   é›»å­ãƒãƒãƒ¼å£²ä¸Šï¼ˆåŠ ç®—ï¼‰: + ${newTotalAmount} = ${originalUpdates.emoneSales}`);
              } else if (paymentMethod === 'credit') {
                originalUpdates.creditSales = (originalUpdates.creditSales !== undefined ? originalUpdates.creditSales : originalData.creditSales || 0) + newTotalAmount;
                console.log(`   ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå£²ä¸Šï¼ˆåŠ ç®—ï¼‰: + ${newTotalAmount} = ${originalUpdates.creditSales}`);
              }
              
              // åˆè¨ˆå£²ä¸Šã®å·®é¡
              const amountDiff = newTotalAmount - oldTotalAmount;
              originalUpdates.totalSales = (originalData.totalSales || 0) + amountDiff;
              console.log(`   åˆè¨ˆå£²ä¸Š: ${originalData.totalSales} + ${amountDiff} = ${originalUpdates.totalSales}`);
            }
            
            // è² ã®å€¤ã«ãªã‚‰ãªã„ã‚ˆã†ã«èª¿æ•´
            if (originalUpdates.cashSales !== undefined) originalUpdates.cashSales = Math.max(0, originalUpdates.cashSales);
            if (originalUpdates.emoneSales !== undefined) originalUpdates.emoneSales = Math.max(0, originalUpdates.emoneSales);
            if (originalUpdates.creditSales !== undefined) originalUpdates.creditSales = Math.max(0, originalUpdates.creditSales);
            if (originalUpdates.totalSales !== undefined) originalUpdates.totalSales = Math.max(0, originalUpdates.totalSales);
            
            console.log('æœ€çµ‚æ›´æ–°ãƒ‡ãƒ¼ã‚¿:', originalUpdates);
            await window.updateDoc(originalSalesRef, originalUpdates);
            console.log('âœ… å…ƒã®æ—¥ä»˜ã®å£²ä¸Šä¿®æ­£å®Œäº†');
          } else {
            console.error('âŒ å…ƒã®æ—¥ä»˜ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', originalDateStr);
          }
        
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('ğŸ‰ å£²ä¸Šãƒ‡ãƒ¼ã‚¿ä¿®æ­£å®Œäº†');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        
        // æœªä¼šè¨ˆæ³¨æ–‡ã®å ´åˆã¯ä¸Šã§æ—¢ã«ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºæ¸ˆã¿
        if (!isUnpaidOrder) {
          showCustomAlert('æ³¨æ–‡ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'âœ… å®Œäº†', 'ğŸ’¾');
        }
        closeEditOrderModal();
        
        // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
        await loadHistory();
        
      } catch (e) {
        console.error('æ³¨æ–‡æ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
        showCustomAlert('æ³¨æ–‡ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'âŒ ã‚¨ãƒ©ãƒ¼', 'âš ï¸');
      }
    };
    
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰æ³¨æ–‡ã‚’å‰Šé™¤
    window.deleteOrderFromEdit = async function() {
      if (!currentEditingOrder) return;
      
      // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      const confirmed = await showCustomConfirm({
        icon: 'ğŸ—‘ï¸',
        title: 'æ³¨æ–‡å–æ¶ˆï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰',
        message: `æ³¨æ–‡ #${currentEditingOrder.orderNumber} ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ\né‡‘é¡: Â¥${currentEditingOrder.totalAmount.toLocaleString()}\n\nâš ï¸ å–æ¶ˆå¾Œã€ã“ã®æ³¨æ–‡ã¯å£²ä¸Šã‹ã‚‰é™¤å¤–ã•ã‚Œã¾ã™ã€‚\nâ€» å±¥æ­´ã‹ã‚‰å¾©å…ƒã§ãã¾ã™`,
        confirmText: 'å–æ¶ˆã™ã‚‹',
        confirmColor: '#f44336'
      });
      
      if (!confirmed) return;
      
      try {
        console.log('ğŸ—‘ï¸ æ³¨æ–‡å–æ¶ˆå‡¦ç†é–‹å§‹:', {
          æ³¨æ–‡ID: currentEditingOrder.id,
          æ³¨æ–‡ç•ªå·: currentEditingOrder.orderNumber,
          é‡‘é¡: currentEditingOrder.totalAmount,
          ä¼šè¨ˆæ¸ˆã¿: !!currentEditingOrder.paidAt
        });
        
        // 1. æ³¨æ–‡ã‚’å–æ¶ˆï¼ˆdeleted: trueï¼‰
        await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), {
          deleted: true,
          deletedAt: window.Timestamp.now(),
          cancelReason: 'æ³¨æ–‡å–æ¶ˆ'
        });
        
        console.log('âœ… æ³¨æ–‡ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸã€‚');
        
        // 2. ğŸ†• ä¼šè¨ˆæ¸ˆã¿ã®æ³¨æ–‡ã®å ´åˆã€dailySalesã‹ã‚‰æ¸›ç®—
        if (currentEditingOrder.paidAt) {
          console.log('ğŸ’° ä¼šè¨ˆæ¸ˆã¿æ³¨æ–‡ã®ãŸã‚ã€dailySalesã‚’æ›´æ–°ã—ã¾ã™');
          
          // æ³¨æ–‡æ—¥ã‚’å–å¾—ï¼ˆJSTã«å¤‰æ›ï¼‰
          const orderDate = currentEditingOrder.timestamp.toDate();
          const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
          const dateStr = `${jstOrderDate.getFullYear()}-${String(jstOrderDate.getMonth() + 1).padStart(2, '0')}-${String(jstOrderDate.getDate()).padStart(2, '0')}`;
          
          console.log('ğŸ“… æ³¨æ–‡æ—¥:', dateStr);
          
          // dailySalesã‚’å–å¾—
          const dailySalesRef = window.getStoreDoc('dailySales', dateStr);
          const dailySalesDoc = await window.getDoc(dailySalesRef);
          
          if (dailySalesDoc.exists()) {
            const dailyData = dailySalesDoc.data();
            
            // æ³¨æ–‡é‡‘é¡ã¨ç¨é‡‘ã‚’å–å¾—
            const totalAmount = currentEditingOrder.totalAmount || 0;
            const tax8Total = currentEditingOrder.tax8Total || 0;
            const tax10Total = currentEditingOrder.tax10Total || 0;
            
            // æ”¯æ‰•ã„æ–¹æ³•åˆ¥ã®é‡‘é¡
            let cashSales = 0, emoneSales = 0, creditSales = 0;
            if (currentEditingOrder.paymentMethod === 'ç¾é‡‘') cashSales = totalAmount;
            else if (currentEditingOrder.paymentMethod === 'é›»å­ãƒãƒãƒ¼') emoneSales = totalAmount;
            else if (currentEditingOrder.paymentMethod === 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰') creditSales = totalAmount;
            
            // å•†å“æ•°ã‚’è¨ˆç®—
            let totalItems = 0;
            if (currentEditingOrder.items && Array.isArray(currentEditingOrder.items)) {
              currentEditingOrder.items.forEach(item => {
                totalItems += item.quantity || 0;
              });
            }
            
            // æ›´æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆï¼ˆãƒã‚¤ãƒŠã‚¹ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
            const updateData = {
              totalSales: Math.max(0, (dailyData.totalSales || 0) - totalAmount),
              customerCount: Math.max(0, (dailyData.customerCount || 0) - 1),
              totalItems: Math.max(0, (dailyData.totalItems || 0) - totalItems),
              cashSales: Math.max(0, (dailyData.cashSales || 0) - cashSales),
              emoneSales: Math.max(0, (dailyData.emoneSales || 0) - emoneSales),
              creditSales: Math.max(0, (dailyData.creditSales || 0) - creditSales),
              tax8Total: Math.max(0, (dailyData.tax8Total || 0) - tax8Total),
              tax10Total: Math.max(0, (dailyData.tax10Total || 0) - tax10Total)
            };
            
            console.log('ğŸ“Š dailySalesæ›´æ–°:', {
              å…ƒã®ç·å£²ä¸Š: dailyData.totalSales,
              æ¸›ç®—é¡: totalAmount,
              æ–°ã—ã„ç·å£²ä¸Š: updateData.totalSales
            });
            
            // dailySalesã‚’æ›´æ–°
            await window.updateDoc(dailySalesRef, updateData);
            
            console.log('âœ… dailySalesã‚’æ›´æ–°ã—ã¾ã—ãŸ');
          } else {
            console.warn('âš ï¸ dailySalesãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', dateStr);
          }
        } else {
          console.log('â„¹ï¸ æœªä¼šè¨ˆã®æ³¨æ–‡ã®ãŸã‚ã€dailySalesã®æ›´æ–°ã¯ä¸è¦ã§ã™');
        }
        
        showCustomAlert(
          `æ³¨æ–‡ #${currentEditingOrder.orderNumber} ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ\n\nå£²ä¸Šã‹ã‚‰é™¤å¤–ã•ã‚Œã¾ã™`,
          'âœ… å–æ¶ˆå®Œäº†',
          'ğŸ—‘ï¸'
        );
        closeEditOrderModal();
        
        // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
        await loadHistory();
        
      } catch (e) {
        console.error('æ³¨æ–‡å–æ¶ˆã‚¨ãƒ©ãƒ¼:', e);
        showCustomAlert('æ³¨æ–‡ã®å–æ¶ˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'âŒ ã‚¨ãƒ©ãƒ¼', 'âš ï¸');
      }
    };
    
    // ğŸ†• èµ¤ä¼ç¥¨ç”¨ã®ç¨ç‡é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«
    window.showTaxRateSelectionModal = async function(orderData) {
      console.log('ğŸ¯ showTaxRateSelectionModal called with:', orderData);
      
      return new Promise((resolve) => {
        console.log('ğŸ“ Creating tax rate selection modal...');
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
        const modalHtml = `
          <div id="taxRateSelectionModal" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 10000;">
            <div style="background: white; border-radius: 20px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
              <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #333; text-align: center;">ğŸ”´ èµ¤ä¼ç¥¨ï¼šç¨ç‡é¸æŠ</h2>
              <p style="text-align: center; color: #666; margin-bottom: 20px; font-size: 14px;">å„å•†å“ã®ç¨ç‡ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
              
              <div id="taxRateItemsList" style="margin-bottom: 20px;">
                <!-- å•†å“ãƒªã‚¹ãƒˆãŒã“ã“ã«æŒ¿å…¥ã•ã‚Œã¾ã™ -->
              </div>
              
              <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="cancelTaxRateSelection()" style="flex: 1; padding: 15px; background: #999; color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer;">
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button onclick="confirmTaxRateSelection()" style="flex: 1; padding: 15px; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: bold; cursor: pointer;">
                  ç¢ºå®šã—ã¦æ¬¡ã¸
                </button>
              </div>
            </div>
          </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        console.log('âœ… Modal HTML inserted');
        
        // å•†å“ãƒªã‚¹ãƒˆã‚’ä½œæˆ
        const itemsList = document.getElementById('taxRateItemsList');
        let itemsHtml = '';
        
        console.log('ğŸ“¦ Building items list...');
        
        if (orderData.items && Array.isArray(orderData.items)) {
          console.log(`ğŸ“ Found ${orderData.items.length} items`);
          
          orderData.items.forEach((item, index) => {
            const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
            const defaultTaxRate = item.taxRate || 10;
            
            console.log(`  Item ${index}: ${item.name}, taxRate: ${defaultTaxRate}`);
            
            itemsHtml += `
              <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #667eea;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                  <div style="flex: 1;">
                    <div style="font-weight: bold; color: #333; font-size: 16px;">${item.name}</div>
                    ${item.toppingName ? `<div style="font-size: 13px; color: #666; margin-top: 3px;">ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${item.toppingName}</div>` : ''}
                    <div style="font-size: 14px; color: #666; margin-top: 5px;">æ•°é‡: ${item.quantity} Ã— Â¥${(item.price + (item.toppingPrice || 0)).toLocaleString()}</div>
                  </div>
                  <div style="font-size: 18px; font-weight: bold; color: #667eea;">
                    Â¥${itemTotal.toLocaleString()}
                  </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 10px;">
                  <label style="flex: 1; cursor: pointer;">
                    <input type="radio" name="taxRate${index}" value="8" ${defaultTaxRate === 8 ? 'checked' : ''} style="margin-right: 5px;">
                    <span style="font-size: 15px; font-weight: bold; color: #4CAF50;">8% (è»½æ¸›ç¨ç‡)</span>
                  </label>
                  <label style="flex: 1; cursor: pointer;">
                    <input type="radio" name="taxRate${index}" value="10" ${defaultTaxRate === 10 ? 'checked' : ''} style="margin-right: 5px;">
                    <span style="font-size: 15px; font-weight: bold; color: #667eea;">10% (æ¨™æº–ç¨ç‡)</span>
                  </label>
                </div>
              </div>
            `;
          });
        } else {
          console.warn('âš ï¸ No items found in orderData');
        }
        
        itemsList.innerHTML = itemsHtml;
        console.log('âœ… Items list populated');
        
        // ç¢ºå®šãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©
        window.confirmTaxRateSelection = function() {
          console.log('âœ… Confirm button clicked');
          const selections = [];
          
          if (orderData.items && Array.isArray(orderData.items)) {
            orderData.items.forEach((item, index) => {
              const selected = document.querySelector(`input[name="taxRate${index}"]:checked`);
              const selectedValue = selected ? parseInt(selected.value) : 10;
              selections.push(selectedValue);
              console.log(`  Item ${index} (${item.name}): ${selectedValue}%`);
            });
          }
          
          const modal = document.getElementById('taxRateSelectionModal');
          modal.remove();
          
          delete window.confirmTaxRateSelection;
          delete window.cancelTaxRateSelection;
          
          console.log('âœ… Resolving with selections:', selections);
          resolve(selections);
        };
        
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®ãƒãƒ³ãƒ‰ãƒ©
        window.cancelTaxRateSelection = function() {
          console.log('âŒ Cancel button clicked');
          const modal = document.getElementById('taxRateSelectionModal');
          modal.remove();
          
          delete window.confirmTaxRateSelection;
          delete window.cancelTaxRateSelection;
          
          resolve(null);
        };
      });
    };
    
    // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰èµ¤ä¼ç¥¨ï¼ˆä¼šè¨ˆæ¸ˆã¿æ³¨æ–‡ã®å®Œå…¨å–æ¶ˆï¼‰
    window.redSlipFromEdit = async function() {
      console.log('ğŸ”´ èµ¤ä¼ç¥¨å‡¦ç†é–‹å§‹');
      
      if (!currentEditingOrder) return;
      
      const orderData = currentEditingOrder;
      
      if (!orderData.paidAt) {
        showCustomAlert('ä¼šè¨ˆæ¸ˆã¿ã®æ³¨æ–‡ã®ã¿èµ¤ä¼ç¥¨ã§ãã¾ã™', 'âš ï¸ è­¦å‘Š', 'âš ï¸');
        return;
      }
      
      console.log('ğŸ“‹ æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿:', orderData);
      console.log('ğŸ“¦ å•†å“ä¸€è¦§:', orderData.items);
      
      // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
      const confirmed = await showCustomConfirm({
        icon: 'ğŸ”´',
        title: 'èµ¤ä¼ç¥¨ï¼ˆå®Œå…¨å–æ¶ˆï¼‰',
        message: `æ³¨æ–‡ #${orderData.orderNumber} ã‚’èµ¤ä¼ç¥¨ã§å®Œå…¨å–æ¶ˆã—ã¾ã™ã‹ï¼Ÿ\n\né‡‘é¡: Â¥${orderData.totalAmount.toLocaleString()}\n\nâš ï¸ é‡è¦ãªæ³¨æ„äº‹é …:\nâ€¢ å£²ä¸Šã‹ã‚‰å®Œå…¨ã«é™¤å¤–ã•ã‚Œã¾ã™\nâ€¢ å®¢æ•°ã‚‚æ¸›å°‘ã—ã¾ã™\nâ€¢ å¾©å…ƒã§ãã¾ã›ã‚“ï¼ˆä¼ç¥¨æ‰“ã¡ç›´ã—ãŒå¿…è¦ï¼‰\nâ€¢ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“`,
        btnText: 'èµ¤ä¼ç¥¨ã§å–æ¶ˆ',
        btnClass: 'modal-btn-danger'
      });
      
      if (!confirmed) return;
      
      try {
        console.log('ğŸ”´ èµ¤ä¼ç¥¨å‡¦ç†é–‹å§‹ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‹ã‚‰ï¼‰:', {
          æ³¨æ–‡ID: orderData.id,
          æ³¨æ–‡ç•ªå·: orderData.orderNumber,
          é‡‘é¡: orderData.totalAmount
        });
        
        // ä¼šè¨ˆæ—¥æ™‚ã‹ã‚‰å–¶æ¥­æ—¥ã‚’è¨ˆç®—ï¼ˆ3æ™‚åŸºæº–ï¼‰
        const paidDate = orderData.paidAt.toDate();
        let businessDate = new Date(paidDate);
        
        if (paidDate.getHours() < 3) {
          businessDate.setDate(businessDate.getDate() - 1);
        }
        
        const dateStr = `${businessDate.getFullYear()}-${String(businessDate.getMonth() + 1).padStart(2, '0')}-${String(businessDate.getDate()).padStart(2, '0')}`;
        
        console.log('ğŸ“… å–¶æ¥­æ—¥:', dateStr);
        
        // dailySalesã‚’å–å¾—
        const dailySalesRef = window.getStoreDoc('dailySales', dateStr);
        const dailySalesDoc = await window.getDoc(dailySalesRef);
        
        if (!dailySalesDoc.exists()) {
          showCustomAlert('ã“ã®å–¶æ¥­æ—¥ã®dailySalesãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\nå–¶æ¥­æ—¥: ' + dateStr, 'âš ï¸ è­¦å‘Š', 'âš ï¸');
          return;
        }
        
        const dailyData = dailySalesDoc.data();
        
        // æ³¨æ–‡é‡‘é¡ã‚’å–å¾—
        const totalAmount = orderData.totalAmount || 0;
        
        // ä¼šè¨ˆæ™‚ã®ç¨ç‡ã§è¨ˆç®—
        let tax8Total = 0;
        let tax10Total = 0;
        
        console.log('ğŸ“Š èµ¤ä¼ç¥¨ã®ç¨ç‡è¨ˆç®—é–‹å§‹:');
        
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach((item, index) => {
            const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
            // ä¼šè¨ˆæ™‚ã«è¨˜éŒ²ã•ã‚ŒãŸç¨ç‡ã‚’ä½¿ç”¨
            let itemTaxRate = item.taxRate;
            
            // taxRateãŒãªã„å ´åˆã¯takeoutãƒ•ãƒ©ã‚°ã§åˆ¤å®š
            if (!itemTaxRate) {
              itemTaxRate = item.takeout ? 8 : 10;
            }
            
            console.log(`  å•†å“ ${index + 1}: ${item.name}`, {
              price: item.price,
              toppingPrice: item.toppingPrice || 0,
              quantity: item.quantity,
              itemTotal: itemTotal,
              taxRate: itemTaxRate,
              takeout: item.takeout
            });
            
            if (itemTaxRate === 8) {
              tax8Total += itemTotal;
            } else if (itemTaxRate === 10) {
              tax10Total += itemTotal;
            }
          });
          
          // ãƒ¬ã‚¸è¢‹ã®ç¨é‡‘ã‚‚åŠ ç®—
          if (orderData.bagNeeded && orderData.bagQuantity > 0) {
            const bagTotal = orderData.bagQuantity * 3;
            console.log('  ãƒ¬ã‚¸è¢‹:', {
              quantity: orderData.bagQuantity,
              total: bagTotal,
              taxRate: 10
            });
            tax10Total += bagTotal;
          }
          
          console.log('ğŸ“Š ç¨ç‡åˆ¥åˆè¨ˆ:', {
            ç¨è¾¼åˆè¨ˆ: totalAmount,
            '8%å¯¾è±¡': tax8Total,
            '10%å¯¾è±¡': tax10Total,
            'åˆè¨ˆ': tax8Total + tax10Total
          });
        }
        
        // æ”¯æ‰•ã„æ–¹æ³•åˆ¥ã®é‡‘é¡
        let cashSales = 0, emoneSales = 0, creditSales = 0;
        const paymentMethod = orderData.paymentMethod || '';
        if (paymentMethod === 'ç¾é‡‘' || paymentMethod === 'cash') cashSales = totalAmount;
        else if (paymentMethod === 'é›»å­ãƒãƒãƒ¼' || paymentMethod === 'emoney') emoneSales = totalAmount;
        else if (paymentMethod === 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰' || paymentMethod === 'credit') creditSales = totalAmount;
        
        // å•†å“æ•°ã‚’è¨ˆç®—
        let totalItems = 0;
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            totalItems += item.quantity || 0;
          });
        }
        
        console.log('ğŸ“Š dailySalesã‹ã‚‰æ¸›ç®—:', {
          å£²ä¸Š: totalAmount,
          å®¢æ•°: 1,
          å•†å“æ•°: totalItems,
          '8%ç¨é‡‘': tax8Total,
          '10%ç¨é‡‘': tax10Total
        });
        
        // dailySalesã‹ã‚‰æ¸›ç®— + èµ¤ä¼ç¥¨æƒ…å ±ã‚’è¨˜éŒ²
        const updateData = {
          totalSales: Math.max(0, (dailyData.totalSales || 0) - totalAmount),
          customerCount: Math.max(0, (dailyData.customerCount || 0) - 1),
          totalItems: Math.max(0, (dailyData.totalItems || 0) - totalItems),
          cashSales: Math.max(0, (dailyData.cashSales || 0) - cashSales),
          emoneSales: Math.max(0, (dailyData.emoneSales || 0) - emoneSales),
          creditSales: Math.max(0, (dailyData.creditSales || 0) - creditSales),
          tax8Total: Math.max(0, (dailyData.tax8Total || 0) - tax8Total),
          tax10Total: Math.max(0, (dailyData.tax10Total || 0) - tax10Total),
          redSlipCount: (dailyData.redSlipCount || 0) + 1,  // ğŸ†• èµ¤ä¼ç¥¨ä»¶æ•°
          redSlipAmount: (dailyData.redSlipAmount || 0) + totalAmount,  // ğŸ†• èµ¤ä¼ç¥¨é‡‘é¡
          redSlipTax8Total: (dailyData.redSlipTax8Total || 0) + tax8Total,  // ğŸ†• èµ¤ä¼ç¥¨8%ç¨é‡‘
          redSlipTax10Total: (dailyData.redSlipTax10Total || 0) + tax10Total  // ğŸ†• èµ¤ä¼ç¥¨10%ç¨é‡‘
        };
        
        console.log('ğŸ“Š dailySalesæ›´æ–°:', {
          æ›´æ–°å‰: { 
            totalSales: dailyData.totalSales, 
            customerCount: dailyData.customerCount,
            èµ¤ä¼ç¥¨ä»¶æ•°: dailyData.redSlipCount || 0,
            èµ¤ä¼ç¥¨é‡‘é¡: dailyData.redSlipAmount || 0
          },
          æ›´æ–°å¾Œ: { 
            totalSales: updateData.totalSales, 
            customerCount: updateData.customerCount,
            èµ¤ä¼ç¥¨ä»¶æ•°: updateData.redSlipCount,
            èµ¤ä¼ç¥¨é‡‘é¡: updateData.redSlipAmount
          }
        });
        
        // dailySalesã‚’æ›´æ–°
        await window.updateDoc(dailySalesRef, updateData);
        
        // ğŸ†• redSlipsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜ï¼ˆç›£æŸ»ç”¨ï¼‰
        const redSlipData = {
          ...orderData,
          redSlippedAt: window.Timestamp.now(),
          redSlippedBy: window.currentStoreId,
          businessDate: dateStr,
          originalOrderId: orderData.id,
          calculatedTax8Total: tax8Total,
          calculatedTax10Total: tax10Total
        };
        
        const redSlipRef = window.doc(window.collection(window.db, 'stores', window.currentStoreId, 'redSlips'));
        await window.setDoc(redSlipRef, redSlipData);
        
        console.log('ğŸ“ redSlipsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜ã—ã¾ã—ãŸ:', redSlipRef.id);
        
        // æ³¨æ–‡ã‚’å‰Šé™¤ï¼ˆredSlipsã«ç§»å‹•æ¸ˆã¿ï¼‰
        await window.deleteDoc(window.getStoreDoc('orders', orderData.id));
        
        console.log('âœ… èµ¤ä¼ç¥¨å‡¦ç†å®Œäº† - æ³¨æ–‡ã‚’å‰Šé™¤ã—ã€redSlipsã«ä¿å­˜ã—ã¾ã—ãŸ');
        
        showCustomAlert(
          `æ³¨æ–‡ #${orderData.orderNumber} ã‚’èµ¤ä¼ç¥¨ã§å–ã‚Šæ¶ˆã—ã¾ã—ãŸ\n\né‡‘é¡: Â¥${totalAmount.toLocaleString()}\n8%å¯¾è±¡: Â¥${tax8Total.toLocaleString()}\n10%å¯¾è±¡: Â¥${tax10Total.toLocaleString()}\n\nå£²ä¸Šãƒ»å®¢æ•°ã‹ã‚‰é™¤å¤–ã•ã‚Œã¾ã—ãŸ\nâ€» å¾©å…ƒä¸å¯ï¼ˆä¼ç¥¨æ‰“ã¡ç›´ã—ãŒå¿…è¦ï¼‰`,
          'âœ… èµ¤ä¼ç¥¨å®Œäº†',
          'ğŸ”´'
        );
        
        closeEditOrderModal();
        
        // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
        await loadHistory();
        
      } catch (e) {
        console.error('èµ¤ä¼ç¥¨ã‚¨ãƒ©ãƒ¼:', e);
        showCustomAlert('èµ¤ä¼ç¥¨å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'âŒ ã‚¨ãƒ©ãƒ¼', 'âš ï¸');
      }
    };
    
    // æ³¨æ–‡ã‚’å¾©å…ƒï¼ˆæœªä¼šè¨ˆæ³¨æ–‡ã®ã¿ï¼‰
    window.restoreOrder = async function() {
      if (!currentEditingOrder) return;
      
      // paidAtã®æœ‰ç„¡ã‚’ç¢ºèª
      const hasPaidAt = !!currentEditingOrder.paidAt;
      
      // ä¼šè¨ˆæ¸ˆã¿æ³¨æ–‡ã¯å¾©å…ƒä¸å¯
      if (hasPaidAt) {
        showCustomAlert('ä¼šè¨ˆæ¸ˆã¿ã®æ³¨æ–‡ã¯å¾©å…ƒã§ãã¾ã›ã‚“\n\nèµ¤ä¼ç¥¨ã§å–ã‚Šæ¶ˆã•ã‚ŒãŸæ³¨æ–‡ã¯ã€\næ–°ã—ãä¼ç¥¨ã‚’æ‰“ã¡ç›´ã—ã¦ãã ã•ã„', 'âš ï¸ å¾©å…ƒä¸å¯', 'ğŸš«');
        return;
      }
      
      // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      const confirmed = await showCustomConfirm({
        icon: 'ğŸ”„',
        title: 'æ³¨æ–‡ã‚’å¾©å…ƒ',
        message: `æ³¨æ–‡ #${currentEditingOrder.orderNumber} ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ³¨æ–‡ã¯æœªä¼šè¨ˆã§ã™ã€‚\nå¾©å…ƒå¾Œã«ä¼šè¨ˆå‡¦ç†ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚`,
        btnText: 'å¾©å…ƒã™ã‚‹',
        btnClass: 'modal-btn-primary'
      });
      
      if (!confirmed) return;
      
      try {
        const updates = {
          deleted: false,
          deletedAt: null
        };
        
        console.log('ğŸ”„ æœªä¼šè¨ˆæ³¨æ–‡å¾©å…ƒ:', {
          æ³¨æ–‡ç•ªå·: currentEditingOrder.orderNumber,
          timestamp: currentEditingOrder.timestamp
        });
        
        await window.updateDoc(window.getStoreDoc('orders', currentEditingOrder.id), updates);
        
        console.log('âœ… æœªä¼šè¨ˆæ³¨æ–‡ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
        
        showCustomAlert(
          'æ³¨æ–‡ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼ˆæœªä¼šè¨ˆï¼‰\n\nä¼šè¨ˆå‡¦ç†ã‚’è¡Œã£ã¦ãã ã•ã„',
          'âœ… æˆåŠŸ',
          'ğŸ”„'
        );
        closeEditOrderModal();
        
        // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
        await loadHistory();
        
      } catch (e) {
        console.error('æ³¨æ–‡å¾©å…ƒã‚¨ãƒ©ãƒ¼:', e);
        showCustomAlert('æ³¨æ–‡ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'âŒ ã‚¨ãƒ©ãƒ¼', 'âš ï¸');
      }
    };
    
    // å±¥æ­´ç”»é¢ã‹ã‚‰ç›´æ¥å‰Šé™¤ï¼ˆæ³¨æ–‡å–æ¶ˆï¼‰
    window.deleteOrderFromHistory = async function(orderId) {
      console.log('ğŸ” å‰Šé™¤ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚æ³¨æ–‡ID:', orderId);
      
      try {
        console.log('ğŸ“¡ Firestoreã‹ã‚‰æ³¨æ–‡ã‚’å–å¾—ä¸­...');
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        
        if (!orderDoc.exists()) {
          console.error('âŒ æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', orderId);
          showCustomAlert('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'âŒ ã‚¨ãƒ©ãƒ¼', 'âš ï¸');
          return;
        }
        
        const orderData = orderDoc.data();
        console.log('âœ… æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸ:', {
          æ³¨æ–‡ID: orderId,
          æ³¨æ–‡ç•ªå·: orderData.orderNumber,
          é‡‘é¡: orderData.totalAmount,
          ä¼šè¨ˆæ¸ˆã¿: !!orderData.paidAt,
          æ—¢ã«å‰Šé™¤æ¸ˆã¿: !!orderData.deleted
        });
        
        // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        console.log('ğŸ’¬ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºä¸­...');
        const confirmed = await showCustomConfirm({
          icon: 'ğŸ—‘ï¸',
          title: 'æ³¨æ–‡å–æ¶ˆï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ï¼‰',
          message: `æ³¨æ–‡ #${orderData.orderNumber} ã‚’å–ã‚Šæ¶ˆã—ã¾ã™ã‹ï¼Ÿ\né‡‘é¡: Â¥${orderData.totalAmount.toLocaleString()}\n\nâš ï¸ å–æ¶ˆå¾Œã€ã“ã®æ³¨æ–‡ã¯å£²ä¸Šã‹ã‚‰é™¤å¤–ã•ã‚Œã¾ã™ã€‚\nâ€» å±¥æ­´ã‹ã‚‰å¾©å…ƒã§ãã¾ã™`,
          confirmText: 'å–æ¶ˆã™ã‚‹',
          confirmColor: '#f44336'
        });
        
        if (!confirmed) {
          console.log('â¸ï¸ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
          return;
        }
        
        console.log('ğŸ—‘ï¸ æ³¨æ–‡å–æ¶ˆå‡¦ç†ã‚’å®Ÿè¡Œä¸­...');
        console.log('ğŸ“ æ›´æ–°ã™ã‚‹ãƒ‘ã‚¹:', window.getStoreDoc('orders', orderId).path);
        
        // 1. æ³¨æ–‡ã‚’å‰Šé™¤ï¼ˆå–æ¶ˆï¼‰æ‰±ã„ã«ã™ã‚‹
        await window.updateDoc(window.getStoreDoc('orders', orderId), {
          deleted: true,
          deletedAt: window.Timestamp.now(),
          cancelReason: 'æ³¨æ–‡å–æ¶ˆ'
        });
        
        console.log('âœ… æ³¨æ–‡ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸï¼');
        
        // 2. ğŸ†• ä¼šè¨ˆæ¸ˆã¿ã®æ³¨æ–‡ã®å ´åˆã€dailySalesã‹ã‚‰æ¸›ç®—
        if (orderData.paidAt) {
          console.log('ğŸ’° ä¼šè¨ˆæ¸ˆã¿æ³¨æ–‡ã®ãŸã‚ã€dailySalesã‚’æ›´æ–°ã—ã¾ã™');
          console.log('ğŸ“‹ æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿è©³ç´°:', JSON.stringify(orderData, null, 2));
          
          // ğŸ”§ ä¿®æ­£: ä¼šè¨ˆæ—¥æ™‚ã‹ã‚‰å–¶æ¥­æ—¥ã‚’è¨ˆç®—ï¼ˆ3æ™‚åŸºæº–ï¼‰
          const paidDate = orderData.paidAt.toDate();
          console.log('ğŸ• ä¼šè¨ˆæ—¥æ™‚ï¼ˆpaidAtï¼‰:', paidDate);
          console.log('ğŸ• paidDate.getHours():', paidDate.getHours());
          
          let businessDate = new Date(paidDate);
          
          // 3æ™‚ã‚ˆã‚Šå‰ã®å ´åˆã¯å‰æ—¥ã®å–¶æ¥­æ—¥æ‰±ã„
          if (paidDate.getHours() < 3) {
            businessDate.setDate(businessDate.getDate() - 1);
            console.log('â° 3æ™‚ã‚ˆã‚Šå‰ãªã®ã§å‰æ—¥æ‰±ã„');
          }
          
          const dateStr = `${businessDate.getFullYear()}-${String(businessDate.getMonth() + 1).padStart(2, '0')}-${String(businessDate.getDate()).padStart(2, '0')}`;
          
          console.log('ğŸ“… ä¼šè¨ˆæ—¥æ™‚:', paidDate);
          console.log('ğŸ“… å–¶æ¥­æ—¥:', dateStr);
          
          // dailySalesã‚’å–å¾—
          const dailySalesRef = window.getStoreDoc('dailySales', dateStr);
          console.log('ğŸ“ dailySalesãƒ‘ã‚¹:', dailySalesRef.path);
          
          const dailySalesDoc = await window.getDoc(dailySalesRef);
          console.log('ğŸ“Š dailySaleså­˜åœ¨:', dailySalesDoc.exists());
          
          if (dailySalesDoc.exists()) {
            const dailyData = dailySalesDoc.data();
            console.log('ğŸ“Š ç¾åœ¨ã®dailySalesãƒ‡ãƒ¼ã‚¿:', JSON.stringify(dailyData, null, 2));
            
            // æ³¨æ–‡é‡‘é¡ã¨ç¨é‡‘ã‚’å–å¾—
            const totalAmount = orderData.totalAmount || 0;
            const tax8Total = orderData.tax8Total || 0;
            const tax10Total = orderData.tax10Total || 0;
            
            // æ”¯æ‰•ã„æ–¹æ³•åˆ¥ã®é‡‘é¡ï¼ˆæ—¥æœ¬èªã¨è‹±èªã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰
            let cashSales = 0, emoneSales = 0, creditSales = 0;
            const paymentMethod = orderData.paymentMethod || '';
            console.log('ğŸ’³ æ”¯æ‰•ã„æ–¹æ³•ï¼ˆç”Ÿãƒ‡ãƒ¼ã‚¿ï¼‰:', paymentMethod, 'å‹:', typeof paymentMethod);
            
            if (paymentMethod === 'ç¾é‡‘' || paymentMethod === 'cash') cashSales = totalAmount;
            else if (paymentMethod === 'é›»å­ãƒãƒãƒ¼' || paymentMethod === 'emoney') emoneSales = totalAmount;
            else if (paymentMethod === 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰' || paymentMethod === 'credit') creditSales = totalAmount;
            
            console.log('ğŸ’³ æ”¯æ‰•ã„æ–¹æ³•:', paymentMethod, 'â†’ æ¸›ç®—é¡:', { cashSales, emoneSales, creditSales });
            
            // å•†å“æ•°ã‚’è¨ˆç®—
            let totalItems = 0;
            if (orderData.items && Array.isArray(orderData.items)) {
              orderData.items.forEach(item => {
                totalItems += item.quantity || 0;
              });
            }
            console.log('ğŸ“¦ å•†å“æ•°:', totalItems);
            
            // æ›´æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆï¼ˆãƒã‚¤ãƒŠã‚¹ã«ãªã‚‰ãªã„ã‚ˆã†ã«ã™ã‚‹ï¼‰
            const updateData = {
              totalSales: Math.max(0, (dailyData.totalSales || 0) - totalAmount),
              customerCount: Math.max(0, (dailyData.customerCount || 0) - 1),
              totalItems: Math.max(0, (dailyData.totalItems || 0) - totalItems),
              cashSales: Math.max(0, (dailyData.cashSales || 0) - cashSales),
              emoneSales: Math.max(0, (dailyData.emoneSales || 0) - emoneSales),
              creditSales: Math.max(0, (dailyData.creditSales || 0) - creditSales),
              tax8Total: Math.max(0, (dailyData.tax8Total || 0) - tax8Total),
              tax10Total: Math.max(0, (dailyData.tax10Total || 0) - tax10Total)
            };
            
            console.log('ğŸ“Š dailySalesæ›´æ–°:', {
              å…ƒã®ç·å£²ä¸Š: dailyData.totalSales,
              æ¸›ç®—é¡: totalAmount,
              æ–°ã—ã„ç·å£²ä¸Š: updateData.totalSales,
              å…ƒã®å®¢æ•°: dailyData.customerCount,
              æ–°ã—ã„å®¢æ•°: updateData.customerCount,
              å…ƒã®cashSales: dailyData.cashSales,
              æ–°ã—ã„cashSales: updateData.cashSales,
              å…ƒã®emoneSales: dailyData.emoneSales,
              æ–°ã—ã„emoneSales: updateData.emoneSales,
              å…ƒã®creditSales: dailyData.creditSales,
              æ–°ã—ã„creditSales: updateData.creditSales
            });
            
            // dailySalesã‚’æ›´æ–°
            console.log('ğŸ”„ dailySalesã‚’æ›´æ–°ä¸­...');
            await window.updateDoc(dailySalesRef, updateData);
            
            console.log('âœ… dailySalesã‚’æ›´æ–°ã—ã¾ã—ãŸ');
            
            // æ›´æ–°å¾Œã®ç¢ºèª
            const updatedDoc = await window.getDoc(dailySalesRef);
            console.log('âœ… æ›´æ–°å¾Œã®dailySalesãƒ‡ãƒ¼ã‚¿:', JSON.stringify(updatedDoc.data(), null, 2));
          } else {
            console.warn('âš ï¸ dailySalesãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', dateStr);
            alert('âš ï¸ è­¦å‘Š: ã“ã®å–¶æ¥­æ—¥ã®dailySalesãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\nå–¶æ¥­æ—¥: ' + dateStr);
          }
        } else {
          console.log('â„¹ï¸ æœªä¼šè¨ˆã®æ³¨æ–‡ã®ãŸã‚ã€dailySalesã®æ›´æ–°ã¯ä¸è¦ã§ã™');
        }
        
        console.log('ğŸ“Š ç¢ºå®šç”³å‘Šã¨ç²¾ç®—å®Ÿè¡Œã®å£²ä¸Šã‹ã‚‰é™¤å¤–ã•ã‚Œã¾ã™');
        
        showCustomAlert(
          `æ³¨æ–‡ #${orderData.orderNumber} ã‚’å–ã‚Šæ¶ˆã—ã¾ã—ãŸ\n\nå£²ä¸Šã‹ã‚‰é™¤å¤–ã•ã‚Œã¾ã™`,
          'âœ… å–æ¶ˆå®Œäº†',
          'ğŸ—‘ï¸'
        );
        
        // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
        console.log('ğŸ”„ å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿ä¸­...');
        await loadHistory();
        console.log('âœ… å±¥æ­´ã®å†èª­ã¿è¾¼ã¿å®Œäº†');
        
      } catch (e) {
        console.error('âŒ æ³¨æ–‡å–æ¶ˆã‚¨ãƒ©ãƒ¼:', e);
        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', e.stack);
        showCustomAlert('æ³¨æ–‡ã®å–æ¶ˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'âŒ ã‚¨ãƒ©ãƒ¼', 'âš ï¸');
      }
    };
    
    // å±¥æ­´ç”»é¢ã‹ã‚‰ç›´æ¥å¾©å…ƒï¼ˆæœªä¼šè¨ˆæ³¨æ–‡ã®ã¿ï¼‰
    window.restoreOrderFromHistory = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        if (!orderDoc.exists()) {
          showCustomAlert('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'âŒ ã‚¨ãƒ©ãƒ¼', 'âš ï¸');
          return;
        }
        
        const orderData = orderDoc.data();
        const hasPaidAt = !!orderData.paidAt;
        
        // ä¼šè¨ˆæ¸ˆã¿æ³¨æ–‡ã¯å¾©å…ƒä¸å¯
        if (hasPaidAt) {
          showCustomAlert('ä¼šè¨ˆæ¸ˆã¿ã®æ³¨æ–‡ã¯å¾©å…ƒã§ãã¾ã›ã‚“\n\nèµ¤ä¼ç¥¨ã§å–ã‚Šæ¶ˆã•ã‚ŒãŸæ³¨æ–‡ã¯ã€\næ–°ã—ãä¼ç¥¨ã‚’æ‰“ã¡ç›´ã—ã¦ãã ã•ã„', 'âš ï¸ å¾©å…ƒä¸å¯', 'ğŸš«');
          return;
        }
        
        // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        const confirmed = await showCustomConfirm({
          icon: 'ğŸ”„',
          title: 'æ³¨æ–‡ã‚’å¾©å…ƒ',
          message: `æ³¨æ–‡ #${orderData.orderNumber} ã‚’å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ\n\nâš ï¸ ã“ã®æ³¨æ–‡ã¯æœªä¼šè¨ˆã§ã™ã€‚\nå¾©å…ƒå¾Œã«ä¼šè¨ˆå‡¦ç†ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚`,
          btnText: 'å¾©å…ƒã™ã‚‹',
          btnClass: 'modal-btn-primary'
        });
        
        if (!confirmed) return;
        
        // æ³¨æ–‡ã‚’å¾©å…ƒï¼ˆæœªä¼šè¨ˆæ³¨æ–‡ã®ã¿ï¼‰
        await window.updateDoc(window.getStoreDoc('orders', orderId), {
          deleted: false,
          deletedAt: null
        });
        
        console.log('âœ… æœªä¼šè¨ˆæ³¨æ–‡ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
        
        showCustomAlert(
          'æ³¨æ–‡ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼ˆæœªä¼šè¨ˆï¼‰\n\nä¼šè¨ˆå‡¦ç†ã‚’è¡Œã£ã¦ãã ã•ã„',
          'âœ… æˆåŠŸ',
          'ğŸ”„'
        );
        
        // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
        await loadHistory();
        
      } catch (e) {
        console.error('æ³¨æ–‡å¾©å…ƒã‚¨ãƒ©ãƒ¼:', e);
        showCustomAlert('æ³¨æ–‡ã®å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'âŒ ã‚¨ãƒ©ãƒ¼', 'âš ï¸');
      }
    };
    
    // ========== ğŸ”´ èµ¤ä¼ç¥¨æ©Ÿèƒ½ ==========
    
    // èµ¤ä¼ç¥¨å‡¦ç†ï¼ˆä¼šè¨ˆæ¸ˆã¿æ³¨æ–‡ã®å®Œå…¨å–æ¶ˆï¼‰
    window.redSlip = async function(orderId) {
      try {
        const orderDoc = await window.getDoc(window.getStoreDoc('orders', orderId));
        if (!orderDoc.exists()) {
          showCustomAlert('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'âŒ ã‚¨ãƒ©ãƒ¼', 'âš ï¸');
          return;
        }
        
        const orderData = orderDoc.data();
        
        if (!orderData.paidAt) {
          showCustomAlert('ä¼šè¨ˆæ¸ˆã¿ã®æ³¨æ–‡ã®ã¿èµ¤ä¼ç¥¨ã§ãã¾ã™', 'âš ï¸ è­¦å‘Š', 'âš ï¸');
          return;
        }
        
        // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
        const confirmed = await showCustomConfirm({
          icon: 'ğŸ”´',
          title: 'èµ¤ä¼ç¥¨ï¼ˆå®Œå…¨å–æ¶ˆï¼‰',
          message: `æ³¨æ–‡ #${orderData.orderNumber} ã‚’èµ¤ä¼ç¥¨ã§å®Œå…¨å–æ¶ˆã—ã¾ã™ã‹ï¼Ÿ\n\né‡‘é¡: Â¥${orderData.totalAmount.toLocaleString()}\n\nâš ï¸ é‡è¦ãªæ³¨æ„äº‹é …:\nâ€¢ å£²ä¸Šã‹ã‚‰å®Œå…¨ã«é™¤å¤–ã•ã‚Œã¾ã™\nâ€¢ å®¢æ•°ã‚‚æ¸›å°‘ã—ã¾ã™\nâ€¢ å¾©å…ƒã§ãã¾ã›ã‚“ï¼ˆä¼ç¥¨æ‰“ã¡ç›´ã—ãŒå¿…è¦ï¼‰\nâ€¢ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“`,
          btnText: 'èµ¤ä¼ç¥¨ã§å–æ¶ˆ',
          btnClass: 'modal-btn-danger'
        });
        
        if (!confirmed) return;
        
        console.log('ğŸ”´ èµ¤ä¼ç¥¨å‡¦ç†é–‹å§‹:', {
          æ³¨æ–‡ID: orderId,
          æ³¨æ–‡ç•ªå·: orderData.orderNumber,
          é‡‘é¡: orderData.totalAmount
        });
        
        // ä¼šè¨ˆæ—¥æ™‚ã‹ã‚‰å–¶æ¥­æ—¥ã‚’è¨ˆç®—ï¼ˆ3æ™‚åŸºæº–ï¼‰
        const paidDate = orderData.paidAt.toDate();
        let businessDate = new Date(paidDate);
        
        if (paidDate.getHours() < 3) {
          businessDate.setDate(businessDate.getDate() - 1);
        }
        
        const dateStr = `${businessDate.getFullYear()}-${String(businessDate.getMonth() + 1).padStart(2, '0')}-${String(businessDate.getDate()).padStart(2, '0')}`;
        
        console.log('ğŸ“… å–¶æ¥­æ—¥:', dateStr);
        
        // dailySalesã‚’å–å¾—
        const dailySalesRef = window.getStoreDoc('dailySales', dateStr);
        const dailySalesDoc = await window.getDoc(dailySalesRef);
        
        if (!dailySalesDoc.exists()) {
          showCustomAlert('ã“ã®å–¶æ¥­æ—¥ã®dailySalesãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“\nå–¶æ¥­æ—¥: ' + dateStr, 'âš ï¸ è­¦å‘Š', 'âš ï¸');
          return;
        }
        
        const dailyData = dailySalesDoc.data();
        
        // æ³¨æ–‡é‡‘é¡ã‚’å–å¾—
        const totalAmount = orderData.totalAmount || 0;
        
        // ç¨é‡‘ã‚’å–å¾—ã¾ãŸã¯å†è¨ˆç®—
        let tax8Total = orderData.tax8Total || 0;
        let tax10Total = orderData.tax10Total || 0;
        
        // ğŸ”§ ç¨é‡‘æƒ…å ±ãŒãªã„å ´åˆã€itemsã‹ã‚‰å†è¨ˆç®—
        if (tax8Total === 0 && tax10Total === 0 && orderData.items && Array.isArray(orderData.items)) {
          console.log('âš ï¸ ç¨é‡‘æƒ…å ±ãŒãªã„ãŸã‚ã€itemsã‹ã‚‰å†è¨ˆç®—ã—ã¾ã™');
          
          orderData.items.forEach(item => {
            const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
            const taxRate = item.taxRate || 10; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯10%
            
            if (taxRate === 8) {
              tax8Total += itemTotal;
            } else if (taxRate === 10) {
              tax10Total += itemTotal;
            }
          });
          
          // ãƒ¬ã‚¸è¢‹ã®ç¨é‡‘ã‚‚åŠ ç®—
          if (orderData.bagNeeded && orderData.bagQuantity > 0) {
            const bagTotal = orderData.bagQuantity * 3;
            // ãƒ¬ã‚¸è¢‹ã¯é€šå¸¸10%
            tax10Total += bagTotal;
          }
          
          console.log('ğŸ“Š å†è¨ˆç®—ã—ãŸç¨é‡‘:', {
            ç¨è¾¼åˆè¨ˆ: totalAmount,
            '8%å¯¾è±¡': tax8Total,
            '10%å¯¾è±¡': tax10Total
          });
        }
        
        // æ”¯æ‰•ã„æ–¹æ³•åˆ¥ã®é‡‘é¡
        let cashSales = 0, emoneSales = 0, creditSales = 0;
        const paymentMethod = orderData.paymentMethod || '';
        if (paymentMethod === 'ç¾é‡‘' || paymentMethod === 'cash') cashSales = totalAmount;
        else if (paymentMethod === 'é›»å­ãƒãƒãƒ¼' || paymentMethod === 'emoney') emoneSales = totalAmount;
        else if (paymentMethod === 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰' || paymentMethod === 'credit') creditSales = totalAmount;
        
        // å•†å“æ•°ã‚’è¨ˆç®—
        let totalItems = 0;
        if (orderData.items && Array.isArray(orderData.items)) {
          orderData.items.forEach(item => {
            totalItems += item.quantity || 0;
          });
        }
        
        console.log('ğŸ“Š dailySalesã‹ã‚‰æ¸›ç®—:', {
          å£²ä¸Š: totalAmount,
          å®¢æ•°: 1,
          å•†å“æ•°: totalItems,
          ç¾é‡‘: cashSales,
          é›»å­ãƒãƒãƒ¼: emoneSales,
          ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ: creditSales,
          '8%ç¨é‡‘': tax8Total,
          '10%ç¨é‡‘': tax10Total
        });
        
        // dailySalesã‹ã‚‰æ¸›ç®— + èµ¤ä¼ç¥¨æƒ…å ±ã‚’è¨˜éŒ²
        const updateData = {
          totalSales: Math.max(0, (dailyData.totalSales || 0) - totalAmount),
          customerCount: Math.max(0, (dailyData.customerCount || 0) - 1),
          totalItems: Math.max(0, (dailyData.totalItems || 0) - totalItems),
          cashSales: Math.max(0, (dailyData.cashSales || 0) - cashSales),
          emoneSales: Math.max(0, (dailyData.emoneSales || 0) - emoneSales),
          creditSales: Math.max(0, (dailyData.creditSales || 0) - creditSales),
          tax8Total: Math.max(0, (dailyData.tax8Total || 0) - tax8Total),
          tax10Total: Math.max(0, (dailyData.tax10Total || 0) - tax10Total),
          redSlipCount: (dailyData.redSlipCount || 0) + 1,  // ğŸ†• èµ¤ä¼ç¥¨ä»¶æ•°
          redSlipAmount: (dailyData.redSlipAmount || 0) + totalAmount,  // ğŸ†• èµ¤ä¼ç¥¨é‡‘é¡
          redSlipTax8Total: (dailyData.redSlipTax8Total || 0) + tax8Total,  // ğŸ†• èµ¤ä¼ç¥¨8%ç¨é‡‘
          redSlipTax10Total: (dailyData.redSlipTax10Total || 0) + tax10Total  // ğŸ†• èµ¤ä¼ç¥¨10%ç¨é‡‘
        };
        
        console.log('ğŸ“Š dailySalesæ›´æ–°:', {
          æ›´æ–°å‰: {
            totalSales: dailyData.totalSales,
            customerCount: dailyData.customerCount,
            èµ¤ä¼ç¥¨ä»¶æ•°: dailyData.redSlipCount || 0,
            èµ¤ä¼ç¥¨é‡‘é¡: dailyData.redSlipAmount || 0
          },
          æ›´æ–°å¾Œ: {
            totalSales: updateData.totalSales,
            customerCount: updateData.customerCount,
            èµ¤ä¼ç¥¨ä»¶æ•°: updateData.redSlipCount,
            èµ¤ä¼ç¥¨é‡‘é¡: updateData.redSlipAmount
          }
        });
        
        // dailySalesã‚’æ›´æ–°
        await window.updateDoc(dailySalesRef, updateData);
        
        // ğŸ†• redSlipsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜ï¼ˆç›£æŸ»ç”¨ï¼‰
        const redSlipData = {
          ...orderData,
          redSlippedAt: window.Timestamp.now(),
          redSlippedBy: window.currentStoreId,
          businessDate: dateStr,
          originalOrderId: orderId
        };
        
        const redSlipRef = window.doc(window.collection(window.db, 'stores', window.currentStoreId, 'redSlips'));
        await window.setDoc(redSlipRef, redSlipData);
        
        console.log('ğŸ“ redSlipsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ä¿å­˜ã—ã¾ã—ãŸ:', redSlipRef.id);
        
        // æ³¨æ–‡ã‚’å‰Šé™¤ï¼ˆredSlipsã«ç§»å‹•æ¸ˆã¿ï¼‰
        await window.deleteDoc(window.getStoreDoc('orders', orderId));
        
        console.log('âœ… èµ¤ä¼ç¥¨å‡¦ç†å®Œäº† - æ³¨æ–‡ã‚’å‰Šé™¤ã—ã€redSlipsã«ä¿å­˜ã—ã¾ã—ãŸ');
        
        showCustomAlert(
          `æ³¨æ–‡ #${orderData.orderNumber} ã‚’èµ¤ä¼ç¥¨ã§å–ã‚Šæ¶ˆã—ã¾ã—ãŸ\n\né‡‘é¡: Â¥${totalAmount.toLocaleString()}\n\nå£²ä¸Šãƒ»å®¢æ•°ã‹ã‚‰é™¤å¤–ã•ã‚Œã¾ã—ãŸ\nâ€» å¾©å…ƒä¸å¯ï¼ˆä¼ç¥¨æ‰“ã¡ç›´ã—ãŒå¿…è¦ï¼‰`,
          'âœ… èµ¤ä¼ç¥¨å®Œäº†',
          'ğŸ”´'
        );
        
        // å±¥æ­´ã‚’å†èª­ã¿è¾¼ã¿
        await loadHistory();
        
      } catch (e) {
        console.error('èµ¤ä¼ç¥¨ã‚¨ãƒ©ãƒ¼:', e);
        showCustomAlert('èµ¤ä¼ç¥¨å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'âŒ ã‚¨ãƒ©ãƒ¼', 'âš ï¸');
      }
    };
    
    // ========== æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½ ==========
    
    // æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showMonthlyReportModal = async function() {
      // å½“æœˆã®é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’åˆæœŸå€¤ã¨ã—ã¦è¨­å®š
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      
      const startDate = `${year}-${month}-01`;
      const lastDay = new Date(year, now.getMonth() + 1, 0).getDate();
      const endDate = `${year}-${month}-${String(lastDay).padStart(2, '0')}`;
      
      document.getElementById('reportStartDate').value = startDate;
      document.getElementById('reportEndDate').value = endDate;
      
      document.getElementById('monthlyReportModal').classList.remove('hidden');
      
      // ã‚°ãƒ©ãƒ•ã‚’ç”Ÿæˆ
      await generateMonthlyCharts();
    };
    
    // æœˆæ¬¡æ¨ç§»ã‚°ãƒ©ãƒ•ã‚’ç”Ÿæˆ
    window.generateMonthlyCharts = async function() {
      try {
        console.log('ğŸ“Š æœˆæ¬¡ã‚°ãƒ©ãƒ•ç”Ÿæˆé–‹å§‹');
        
        // FirebaseåˆæœŸåŒ–ã‚’å¾…ã¤
        if (!window.firebaseReady) {
          await new Promise(resolve => {
            window.addEventListener('firebaseReady', resolve, { once: true });
          });
        }
        
        // éå»3ãƒ¶æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const now = new Date();
        const monthsData = [];
        
        for (let i = 2; i >= 0; i--) {
          const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
          const year = targetDate.getFullYear();
          const month = targetDate.getMonth() + 1;
          const monthStr = String(month).padStart(2, '0');
          const lastDay = new Date(year, month, 0).getDate();
          
          // ãã®æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
          let totalSales = 0;
          let totalLaborCost = 0;
          let totalExpense = 0;
          let workDays = 0;
          
          // æ—¥æ¬¡å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
          const salesSnapshot = await window.getDocs(window.getStoreCollection('dailySales'));
          salesSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.date && data.date.startsWith(`${year}-${monthStr}`)) {
              totalSales += data.totalSales || 0;
            }
          });
          
          // å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰äººä»¶è²»ã‚’è¨ˆç®—
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.date && data.date.startsWith(`${year}-${monthStr}`)) {
              // æ—¢ã«è¨ˆç®—æ¸ˆã¿ã®ç·è³ƒé‡‘ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
              if (data.totalWage && data.totalWage > 0) {
                totalLaborCost += data.totalWage;
                workDays++;
              } else if (data.clockIn && data.clockOut) {
                // ç·è³ƒé‡‘ãŒãªã„å ´åˆã¯è¨ˆç®—ã™ã‚‹
                const clockIn = new Date(`${data.date} ${data.clockIn}`);
                const clockOut = new Date(`${data.date} ${data.clockOut}`);
                let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                
                if (data.breakStart1 && data.breakEnd1) {
                  const breakStart1 = new Date(`${data.date} ${data.breakStart1}`);
                  const breakEnd1 = new Date(`${data.date} ${data.breakEnd1}`);
                  workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                }
                if (data.breakStart2 && data.breakEnd2) {
                  const breakStart2 = new Date(`${data.date} ${data.breakStart2}`);
                  const breakEnd2 = new Date(`${data.date} ${data.breakEnd2}`);
                  workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                }
                
                const hourlyRate = data.hourlyRate || 1150;
                
                // å‰²å¢—è³ƒé‡‘ã®è¨ˆç®—
                let totalWage = 0;
                const isHoliday = data.isHoliday || false;
                
                // æ™‚é–“ã”ã¨ã«å‰²å¢—ç‡ã‚’è¨ˆç®—
                let currentTime = new Date(clockIn);
                const endTime = new Date(clockOut);
                
                while (currentTime < endTime) {
                  const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                  const segmentEnd = nextHour > endTime ? endTime : nextHour;
                  
                  // ä¼‘æ†©æ™‚é–“ã‚’é™¤å¤–
                  let isBreak = false;
                  if (data.breakStart1 && data.breakEnd1) {
                    const breakStart1 = new Date(`${data.date} ${data.breakStart1}`);
                    const breakEnd1 = new Date(`${data.date} ${data.breakEnd1}`);
                    if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                      isBreak = true;
                    }
                  }
                  if (data.breakStart2 && data.breakEnd2) {
                    const breakStart2 = new Date(`${data.date} ${data.breakStart2}`);
                    const breakEnd2 = new Date(`${data.date} ${data.breakEnd2}`);
                    if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                      isBreak = true;
                    }
                  }
                  
                  if (!isBreak) {
                    const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                    const hour = currentTime.getHours();
                    
                    let rate = 1.0;
                    if (isHoliday) {
                      // ä¼‘æ—¥å‡ºå‹¤: åŸºæœ¬35%å¢—
                      rate = 1.35;
                      // 22æ™‚ï½5æ™‚ã¯æ·±å¤œå‰²å¢—25%ã‚’è¿½åŠ ï¼ˆåˆè¨ˆ60%å¢—ï¼‰
                      if (hour >= 22 || hour < 5) {
                        rate = 1.60;
                      }
                    } else {
                      // å¹³æ—¥: 22æ™‚ï½5æ™‚ã¯æ·±å¤œå‰²å¢—25%
                      if (hour >= 22 || hour < 5) {
                        rate = 1.25;
                      }
                    }
                    
                    totalWage += segmentHours * hourlyRate * rate;
                  }
                  
                  currentTime = segmentEnd;
                }
                
                totalLaborCost += totalWage;
                workDays++;
              }
            }
          });
          
          // æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
          const expensesSnapshot = await window.getDocs(window.getStoreCollection('expenses'));
          expensesSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.date && data.date.startsWith(`${year}-${monthStr}`)) {
              totalExpense += data.total || 0;
            }
          });
          
          const laborCostRate = totalSales > 0 ? (totalLaborCost / totalSales) * 100 : 0;
          const grossProfitRate = totalSales > 0 ? ((totalSales - totalLaborCost) / totalSales) * 100 : 0;
          const grossProfit = totalSales - totalLaborCost;
          const netProfit = totalSales - totalLaborCost - totalExpense; // ç´”åˆ©ç›Š
          const netProfitRate = totalSales > 0 ? (netProfit / totalSales) * 100 : 0;
          
          monthsData.push({
            label: `${month}æœˆ`,
            sales: Math.round(totalSales),
            laborCost: Math.round(totalLaborCost),
            expense: Math.round(totalExpense),
            laborCostRate: laborCostRate.toFixed(1),
            grossProfit: Math.round(grossProfit),
            grossProfitRate: grossProfitRate.toFixed(1),
            netProfit: Math.round(netProfit),
            netProfitRate: netProfitRate.toFixed(1)
          });
        }
        
        console.log('ğŸ“Š é›†è¨ˆãƒ‡ãƒ¼ã‚¿:', monthsData);
        
        // ã‚°ãƒ©ãƒ•ã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
        document.getElementById('monthlyChartsArea').style.display = 'block';
        
        // æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„
        if (window.salesChart) window.salesChart.destroy();
        if (window.laborChart) window.laborChart.destroy();
        if (window.profitChart) window.profitChart.destroy();
        if (window.netProfitChart) window.netProfitChart.destroy();
        
        // å£²ä¸Šæ¨ç§»ã‚°ãƒ©ãƒ•
        const salesCtx = document.getElementById('salesTrendChart').getContext('2d');
        window.salesChart = new Chart(salesCtx, {
          type: 'line',
          data: {
            labels: monthsData.map(d => d.label),
            datasets: [{
              label: 'å£²ä¸Šï¼ˆå††ï¼‰',
              data: monthsData.map(d => d.sales),
              borderColor: '#4CAF50',
              backgroundColor: 'rgba(76, 175, 80, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return 'Â¥' + value.toLocaleString();
                  }
                }
              }
            }
          }
        });
        
        // äººä»¶è²»ç‡æ¨ç§»ã‚°ãƒ©ãƒ•
        const laborCtx = document.getElementById('laborCostRateChart').getContext('2d');
        window.laborChart = new Chart(laborCtx, {
          type: 'line',
          data: {
            labels: monthsData.map(d => d.label),
            datasets: [
              {
                label: 'äººä»¶è²»ç‡ï¼ˆ%ï¼‰',
                data: monthsData.map(d => d.laborCostRate),
                borderColor: '#FF9800',
                backgroundColor: 'rgba(255, 152, 0, 0.1)',
                tension: 0.4,
                fill: true
              },
              {
                label: 'ç›®æ¨™35%',
                data: monthsData.map(() => 35),
                borderColor: '#f44336',
                borderDash: [5, 5],
                borderWidth: 2,
                pointRadius: 0,
                fill: false
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 50,
                ticks: {
                  callback: function(value) {
                    return value + '%';
                  }
                }
              }
            }
          }
        });
        
        // ç²—åˆ©ç‡æ¨ç§»ã‚°ãƒ©ãƒ•
        const profitCtx = document.getElementById('profitRateChart').getContext('2d');
        window.profitChart = new Chart(profitCtx, {
          type: 'line',
          data: {
            labels: monthsData.map(d => d.label),
            datasets: [{
              label: 'ç²—åˆ©ç‡ï¼ˆ%ï¼‰',
              data: monthsData.map(d => d.profitRate),
              borderColor: '#2196F3',
              backgroundColor: 'rgba(33, 150, 243, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return value + '%';
                  }
                }
              }
            }
          }
        });
        
        // ç´”åˆ©ç›Šç‡æ¨ç§»ã‚°ãƒ©ãƒ•
        const netProfitCtx = document.getElementById('netProfitRateChart').getContext('2d');
        window.netProfitChart = new Chart(netProfitCtx, {
          type: 'line',
          data: {
            labels: monthsData.map(d => d.label),
            datasets: [{
              label: 'ç´”åˆ©ç›Šç‡ï¼ˆ%ï¼‰',
              data: monthsData.map(d => d.netProfitRate),
              borderColor: '#9C27B0',
              backgroundColor: 'rgba(156, 39, 176, 0.1)',
              tension: 0.4,
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return value + '%';
                  }
                }
              }
            }
          }
        });
        
        // æ•°å€¤ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆ
        const tableBody = document.getElementById('monthlyDataTableBody');
        tableBody.innerHTML = '';
        
        monthsData.forEach((data, index) => {
          const row = document.createElement('tr');
          row.style.background = index % 2 === 0 ? '#f8f9fa' : 'white';
          
          const laborRateClass = parseFloat(data.laborCostRate) > 35 ? 'color: #f44336; font-weight: bold;' : 'color: #4CAF50;';
          const netProfitClass = parseFloat(data.netProfit) >= 0 ? 'color: #9C27B0; font-weight: bold;' : 'color: #f44336; font-weight: bold;';
          
          row.innerHTML = `
            <td style="padding: 10px; text-align: center; border: 1px solid #ddd; font-weight: bold;">${data.label}</td>
            <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">Â¥${data.sales.toLocaleString()}</td>
            <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">Â¥${data.laborCost.toLocaleString()}</td>
            <td style="padding: 10px; text-align: right; border: 1px solid #ddd; ${laborRateClass}">${data.laborCostRate}%</td>
            <td style="padding: 10px; text-align: right; border: 1px solid #ddd;">Â¥${data.expense.toLocaleString()}</td>
            <td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: #2196F3; font-weight: bold;">Â¥${data.grossProfit.toLocaleString()}</td>
            <td style="padding: 10px; text-align: right; border: 1px solid #ddd; color: #2196F3; font-weight: bold;">${data.grossProfitRate}%</td>
            <td style="padding: 10px; text-align: right; border: 1px solid #ddd; ${netProfitClass}">Â¥${data.netProfit.toLocaleString()}</td>
            <td style="padding: 10px; text-align: right; border: 1px solid #ddd; ${netProfitClass}">${data.netProfitRate}%</td>
          `;
          
          tableBody.appendChild(row);
        });
        
        console.log('âœ… æœˆæ¬¡ã‚°ãƒ©ãƒ•ç”Ÿæˆå®Œäº†');
      } catch (e) {
        console.error('âŒ æœˆæ¬¡ã‚°ãƒ©ãƒ•ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', e);
      }
    };
    
    // æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeMonthlyReportModal = function() {
      document.getElementById('monthlyReportModal').classList.add('hidden');
    };
    
    // ===== æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆ =====
    window.generatePeriodJournal = async function() {
      try {
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;
        
        if (!startDate || !endDate) {
          alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        
        if (startDate > endDate) {
          alert('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        
        console.log(`ğŸ“Š æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆ: ${startDate} ï½ ${endDate}`);
        
        const container = document.getElementById('monthlyReportContent');
        container.innerHTML = '<div style="text-align: center; padding: 40px;">ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆä¸­...</div>';
        
        // æœŸé–“å†…ã®å…¨æ—¥ä»˜ã‚’ç”Ÿæˆ
        const start = new Date(startDate);
        const end = new Date(endDate);
        const dates = [];
        
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
          dates.push(dateStr);
        }
        
        // å„æ—¥ä»˜ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦åˆè¨ˆ
        let totalCustomerCount = 0;
        let totalItems = 0;
        let totalCashSales = 0;
        let totalEmoneSales = 0;
        let totalCreditSales = 0;
        let totalDiscount = 0;
        let totalTax8 = 0;
        let totalTax10 = 0;
        let totalDrawerOpen = 0;
        let totalRedSlipCount = 0;  // ğŸ†• èµ¤ä¼ç¥¨ä»¶æ•°
        let totalRedSlipAmount = 0;  // ğŸ†• èµ¤ä¼ç¥¨é‡‘é¡
        let totalRedSlipTax8 = 0;  // ğŸ†• èµ¤ä¼ç¥¨8%ç¨é‡‘
        let totalRedSlipTax10 = 0;  // ğŸ†• èµ¤ä¼ç¥¨10%ç¨é‡‘
        let totalExpense = 0;
        let totalLaborCost = 0;
        const itemCounts = {}; // å•†å“åˆ¥ã‚«ã‚¦ãƒ³ãƒˆ
        
        // ordersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç›´æ¥å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
        const ordersQuery = window.query(
          window.getStoreCollection('orders'),
          window.where('paidAt', '!=', null)
        );
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          // paidAtã‚’ä½¿ç”¨ã—ã¦ä¼šè¨ˆæ—¥æ™‚ã‚’å–å¾—
          if (!data.paidAt) return;
          
          const orderDate = data.paidAt.toDate();
          
          // 3æ™‚åŸºæº–ã®å–¶æ¥­æ—¥è¨ˆç®—
          let targetDate = new Date(orderDate);
          if (orderDate.getHours() < 3) {
            targetDate.setDate(targetDate.getDate() - 1);
          }
          
          const orderDateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-${String(targetDate.getDate()).padStart(2, '0')}`;
          
          // æœŸé–“å†…ã®æ³¨æ–‡ã®ã¿
          if (dates.includes(orderDateStr) && data.items) {
            data.items.forEach(item => {
              itemCounts[item.name] = (itemCounts[item.name] || 0) + (item.quantity || 1);
            });
          }
        });
        
        console.log('ğŸ“¦ ordersã‹ã‚‰é›†è¨ˆã—ãŸå•†å“ãƒ‡ãƒ¼ã‚¿:', itemCounts);
        
        for (const dateStr of dates) {
          // å£²ä¸Šãƒ‡ãƒ¼ã‚¿
          const salesDoc = await window.getDoc(window.getStoreDoc('dailySales', dateStr));
          if (salesDoc.exists()) {
            const data = salesDoc.data();
            totalCustomerCount += data.customerCount || 0;
            totalItems += data.totalItems || 0;
            totalCashSales += data.cashSales || 0;
            totalEmoneSales += data.emoneSales || 0;
            totalCreditSales += data.creditSales || 0;
            totalDiscount += data.totalDiscount || 0;
            totalTax8 += data.tax8Total || 0;
            totalTax10 += data.tax10Total || 0;
            totalDrawerOpen += data.drawerOpenCount || 0;
            totalRedSlipCount += data.redSlipCount || 0;  // ğŸ†• èµ¤ä¼ç¥¨ä»¶æ•°
            totalRedSlipAmount += data.redSlipAmount || 0;  // ğŸ†• èµ¤ä¼ç¥¨é‡‘é¡
            totalRedSlipTax8 += data.redSlipTax8Total || 0;  // ğŸ†• èµ¤ä¼ç¥¨8%ç¨é‡‘
            totalRedSlipTax10 += data.redSlipTax10Total || 0;  // ğŸ†• èµ¤ä¼ç¥¨10%ç¨é‡‘
          }
          
          // æ”¯å‡ºãƒ‡ãƒ¼ã‚¿
          const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
          if (expenseDoc.exists()) {
            totalExpense += expenseDoc.data().total || 0;
          }
          
          // äººä»¶è²»ãƒ‡ãƒ¼ã‚¿
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(doc => {
            const attData = doc.data();
            if (attData.date === dateStr) {
              // æ—¢ã«è¨ˆç®—æ¸ˆã¿ã®ç·è³ƒé‡‘ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
              if (attData.totalWage && attData.totalWage > 0) {
                totalLaborCost += attData.totalWage;
              } else if (attData.clockIn && attData.clockOut) {
                // ç·è³ƒé‡‘ãŒãªã„å ´åˆã¯è¨ˆç®—ã™ã‚‹
                const clockIn = new Date(`${dateStr} ${attData.clockIn}`);
                const clockOut = new Date(`${dateStr} ${attData.clockOut}`);
                let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                
                if (attData.breakStart1 && attData.breakEnd1) {
                  const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                  const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                  workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                }
                if (attData.breakStart2 && attData.breakEnd2) {
                  const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                  const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                  workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                }
                
                const hourlyRate = attData.hourlyRate || 1150;
                
                // å‰²å¢—è³ƒé‡‘ã®è¨ˆç®—
                let totalWage = 0;
                const isHoliday = attData.isHoliday || false;
                
                // æ™‚é–“ã”ã¨ã«å‰²å¢—ç‡ã‚’è¨ˆç®—
                let currentTime = new Date(clockIn);
                const endTime = new Date(clockOut);
                
                while (currentTime < endTime) {
                  const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                  const segmentEnd = nextHour > endTime ? endTime : nextHour;
                  
                  // ä¼‘æ†©æ™‚é–“ã‚’é™¤å¤–
                  let isBreak = false;
                  if (attData.breakStart1 && attData.breakEnd1) {
                    const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                    const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                    if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                      isBreak = true;
                    }
                  }
                  if (attData.breakStart2 && attData.breakEnd2) {
                    const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                    const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                    if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                      isBreak = true;
                    }
                  }
                  
                  if (!isBreak) {
                    const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                    const hour = currentTime.getHours();
                    
                    let rate = 1.0;
                    if (isHoliday) {
                      // ä¼‘æ—¥å‡ºå‹¤: åŸºæœ¬35%å¢—
                      rate = 1.35;
                      // 22æ™‚ï½5æ™‚ã¯æ·±å¤œå‰²å¢—25%ã‚’è¿½åŠ ï¼ˆåˆè¨ˆ60%å¢—ï¼‰
                      if (hour >= 22 || hour < 5) {
                        rate = 1.60;
                      }
                    } else {
                      // å¹³æ—¥: 22æ™‚ï½5æ™‚ã¯æ·±å¤œå‰²å¢—25%
                      if (hour >= 22 || hour < 5) {
                        rate = 1.25;
                      }
                    }
                    
                    totalWage += segmentHours * hourlyRate * rate;
                  }
                  
                  currentTime = segmentEnd;
                }
                
                totalLaborCost += totalWage;
              }
            }
          });
        }
        
        // è¨ˆç®—
        const totalSales = totalCashSales + totalEmoneSales + totalCreditSales;
        const averageSpend = totalCustomerCount > 0 ? Math.round(totalSales / totalCustomerCount) : 0;
        
        // ğŸ†• å¤–ç¨ãƒ»å†…ç¨ã‚’åŒºåˆ¥ã—ã¦è¨ˆç®—
        // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¤–ç¨ã¨å†…ç¨ã‚’åˆ†é›¢
        let tax8InclusiveTotal = 0;
        let tax10InclusiveTotal = 0;
        let tax8ExclusiveTotal = 0;
        let tax10ExclusiveTotal = 0;
        // ğŸ†• èµ¤ä¼ç¥¨ã®å†…ç¨ãƒ»å¤–ç¨
        let redSlipTax8Inclusive = 0;
        let redSlipTax10Inclusive = 0;
        let redSlipTax8Exclusive = 0;
        let redSlipTax10Exclusive = 0;
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          if (!data.paidAt || !data.items) return;
          
          const orderDate = data.paidAt.toDate();
          let targetDate = new Date(orderDate);
          if (orderDate.getHours() < 3) {
            targetDate.setDate(targetDate.getDate() - 1);
          }
          
          const orderDateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-${String(targetDate.getDate()).padStart(2, '0')}`;
          
          if (dates.includes(orderDateStr)) {
            const isRedSlip = data.isRedSlip || false;  // ğŸ†• èµ¤ä¼ç¥¨åˆ¤å®š
            
            data.items.forEach(item => {
              const taxType = item.taxType || 'inclusive';
              const taxAmount = getTaxAmount(item, item.quantity || 1);
              
              if ((item.taxRate || 10) === 8) {
                if (taxType === 'exclusive') {
                  tax8ExclusiveTotal += taxAmount;
                  if (isRedSlip) redSlipTax8Exclusive += taxAmount;  // ğŸ†•
                } else {
                  tax8InclusiveTotal += taxAmount;
                  if (isRedSlip) redSlipTax8Inclusive += taxAmount;  // ğŸ†•
                }
              } else {
                if (taxType === 'exclusive') {
                  tax10ExclusiveTotal += taxAmount;
                  if (isRedSlip) redSlipTax10Exclusive += taxAmount;  // ğŸ†•
                } else {
                  tax10InclusiveTotal += taxAmount;
                  if (isRedSlip) redSlipTax10Inclusive += taxAmount;  // ğŸ†•
                }
              }
            });
          }
        });
        
        // æ—§è¨ˆç®—ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
        const tax8Excluded = Math.floor(totalTax8 / 1.08);
        const tax10Excluded = Math.floor(totalTax10 / 1.10);
        const tax8Amount = totalTax8 - tax8Excluded;
        const tax10Amount = totalTax10 - tax10Excluded;
        const totalTax = tax8Amount + tax10Amount;
        const taxExcludedTotal = tax8Excluded + tax10Excluded;
        const taxIncludedTotal = totalTax8 + totalTax10;
        const finalTotalSales = taxIncludedTotal - totalDiscount - totalExpense;
        
        const now = new Date();
        const outputTime = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        
        // ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
        const journalText = `
=====================================
      æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«
=====================================
æœŸé–“: ${startDate} ï½ ${endDate}
å‡ºåŠ›æ™‚åˆ»: ${outputTime}
å®¢æ•°: ${totalCustomerCount}çµ„
ç·å£²ä¸Šç‚¹æ•°: ${totalItems}ç‚¹
å¹³å‡å®¢å˜ä¾¡: Â¥${averageSpend.toLocaleString()}
åˆè¨ˆå£²ä¸Š: Â¥${totalSales.toLocaleString()}

-------------------------------------
å£²ä¸Šå†…è¨³
-------------------------------------
ç¾é‡‘: Â¥${totalCashSales.toLocaleString()}
é›»å­ãƒãƒãƒ¼: Â¥${totalEmoneSales.toLocaleString()}
ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰: Â¥${totalCreditSales.toLocaleString()}
å€¤å¼•ã: Â¥${totalDiscount.toLocaleString()}

-------------------------------------
ç¨é‡‘å†…è¨³â€»èµ¤ä¼ç¥¨æ¸›ç®—å‰
-------------------------------------
ã€8%è»½æ¸›ç¨ç‡ã€‘
å†…ç¨ã®æ¶ˆè²»ç¨: Â¥${tax8InclusiveTotal.toLocaleString()}
å¤–ç¨ã®æ¶ˆè²»ç¨: Â¥${tax8ExclusiveTotal.toLocaleString()}
8%åˆè¨ˆ: Â¥${(tax8InclusiveTotal + tax8ExclusiveTotal).toLocaleString()}

ã€10%æ¨™æº–ç¨ç‡ã€‘
å†…ç¨ã®æ¶ˆè²»ç¨: Â¥${tax10InclusiveTotal.toLocaleString()}
å¤–ç¨ã®æ¶ˆè²»ç¨: Â¥${tax10ExclusiveTotal.toLocaleString()}
10%åˆè¨ˆ: Â¥${(tax10InclusiveTotal + tax10ExclusiveTotal).toLocaleString()}

æ¶ˆè²»ç¨ã®åˆè¨ˆ: Â¥${(tax8InclusiveTotal + tax8ExclusiveTotal + tax10InclusiveTotal + tax10ExclusiveTotal).toLocaleString()}
ç¨æŠœåˆè¨ˆ: Â¥${taxExcludedTotal.toLocaleString()}
ç¨è¾¼åˆè¨ˆ: Â¥${taxIncludedTotal.toLocaleString()}
${totalRedSlipCount > 0 ? `
-------------------------------------
èµ¤ä¼ç¥¨ã®ç¨é‡‘å†…è¨³
-------------------------------------
8%ã®èµ¤ä¼ç¥¨ï¼ˆç¨æŠœï¼‰: -Â¥${Math.floor(totalRedSlipTax8 / 1.08).toLocaleString()}
8%ã®èµ¤ä¼ç¥¨ï¼ˆç¨è¾¼ï¼‰: -Â¥${totalRedSlipTax8.toLocaleString()}
8%ã®èµ¤ä¼ç¥¨ã®æ¶ˆè²»ç¨: -Â¥${(totalRedSlipTax8 - Math.floor(totalRedSlipTax8 / 1.08)).toLocaleString()}
  å†…ç¨: -Â¥${redSlipTax8Inclusive.toLocaleString()}
  å¤–ç¨: -Â¥${redSlipTax8Exclusive.toLocaleString()}

10%ã®èµ¤ä¼ç¥¨ï¼ˆç¨æŠœï¼‰: -Â¥${Math.floor(totalRedSlipTax10 / 1.10).toLocaleString()}
10%ã®èµ¤ä¼ç¥¨ï¼ˆç¨è¾¼ï¼‰: -Â¥${totalRedSlipTax10.toLocaleString()}
10%ã®èµ¤ä¼ç¥¨ã®æ¶ˆè²»ç¨: -Â¥${(totalRedSlipTax10 - Math.floor(totalRedSlipTax10 / 1.10)).toLocaleString()}
  å†…ç¨: -Â¥${redSlipTax10Inclusive.toLocaleString()}
  å¤–ç¨: -Â¥${redSlipTax10Exclusive.toLocaleString()}

èµ¤ä¼ç¥¨æ¶ˆè²»ç¨ã®åˆè¨ˆ: -Â¥${((totalRedSlipTax8 - Math.floor(totalRedSlipTax8 / 1.08)) + (totalRedSlipTax10 - Math.floor(totalRedSlipTax10 / 1.10))).toLocaleString()}
èµ¤ä¼ç¥¨ç¨æŠœåˆè¨ˆ: -Â¥${(Math.floor(totalRedSlipTax8 / 1.08) + Math.floor(totalRedSlipTax10 / 1.10)).toLocaleString()}
èµ¤ä¼ç¥¨ç¨è¾¼åˆè¨ˆ: -Â¥${(totalRedSlipTax8 + totalRedSlipTax10).toLocaleString()}

-------------------------------------
ç¨é‡‘å†…è¨³ æ­£å¼è¨ˆç®—ï¼ˆèµ¤ä¼ç¥¨æ¸›ç®—å¾Œï¼‰
-------------------------------------
8%ã®å•†å“åˆè¨ˆï¼ˆç¨æŠœï¼‰: Â¥${Math.floor((totalTax8 - totalRedSlipTax8) / 1.08).toLocaleString()}
8%ã®å•†å“åˆè¨ˆï¼ˆç¨è¾¼ï¼‰: Â¥${(totalTax8 - totalRedSlipTax8).toLocaleString()}
8%ã®æ¶ˆè²»ç¨: Â¥${((totalTax8 - totalRedSlipTax8) - Math.floor((totalTax8 - totalRedSlipTax8) / 1.08)).toLocaleString()}
  å†…ç¨: Â¥${(tax8InclusiveTotal - redSlipTax8Inclusive).toLocaleString()}
  å¤–ç¨: Â¥${(tax8ExclusiveTotal - redSlipTax8Exclusive).toLocaleString()}

10%ã®å•†å“åˆè¨ˆï¼ˆç¨æŠœï¼‰: Â¥${Math.floor((totalTax10 - totalRedSlipTax10) / 1.10).toLocaleString()}
10%ã®å•†å“åˆè¨ˆï¼ˆç¨è¾¼ï¼‰: Â¥${(totalTax10 - totalRedSlipTax10).toLocaleString()}
10%ã®æ¶ˆè²»ç¨: Â¥${((totalTax10 - totalRedSlipTax10) - Math.floor((totalTax10 - totalRedSlipTax10) / 1.10)).toLocaleString()}
  å†…ç¨: Â¥${(tax10InclusiveTotal - redSlipTax10Inclusive).toLocaleString()}
  å¤–ç¨: Â¥${(tax10ExclusiveTotal - redSlipTax10Exclusive).toLocaleString()}

æ¶ˆè²»ç¨ã®åˆè¨ˆ: Â¥${(((totalTax8 - totalRedSlipTax8) - Math.floor((totalTax8 - totalRedSlipTax8) / 1.08)) + ((totalTax10 - totalRedSlipTax10) - Math.floor((totalTax10 - totalRedSlipTax10) / 1.10))).toLocaleString()}
ç¨æŠœåˆè¨ˆ: Â¥${(Math.floor((totalTax8 - totalRedSlipTax8) / 1.08) + Math.floor((totalTax10 - totalRedSlipTax10) / 1.10)).toLocaleString()}
ç¨è¾¼åˆè¨ˆ: Â¥${((totalTax8 - totalRedSlipTax8) + (totalTax10 - totalRedSlipTax10)).toLocaleString()}
` : ''}
æ”¯å‡º: Â¥${totalExpense.toLocaleString()}
åˆè¨ˆå£²ä¸Š: Â¥${(totalRedSlipCount > 0 ? ((totalTax8 - totalRedSlipTax8) + (totalTax10 - totalRedSlipTax10)) - totalExpense : taxIncludedTotal - totalExpense).toLocaleString()}

-------------------------------------
ãã®ä»–
-------------------------------------
ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æ•°: ${totalDrawerOpen}å›
èµ¤ä¼ç¥¨ä»¶æ•°: ${totalRedSlipCount}ä»¶
èµ¤ä¼ç¥¨é‡‘é¡: Â¥${totalRedSlipAmount.toLocaleString()}
äººä»¶è²»: Â¥${Math.round(totalLaborCost).toLocaleString()}

=====================================
`;
        
        // PNGç”»åƒã¨ã—ã¦ä¿å­˜
        const journalDiv = document.createElement('div');
        journalDiv.style.cssText = `
          font-family: 'Courier New', monospace;
          font-size: 14px;
          line-height: 1.6;
          padding: 30px;
          background: white;
          color: black;
          white-space: pre-wrap;
          position: absolute;
          left: -9999px;
        `;
        
        // HTMLã¨ã—ã¦ç”Ÿæˆã—ã€æ”¯å‡ºã¨åˆè¨ˆå£²ä¸Šã‚’èµ¤è‰²ã«ã™ã‚‹
        journalDiv.innerHTML = journalText
          .replace(/^(æ”¯å‡º: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>')
          .replace(/^(åˆè¨ˆå£²ä¸Š: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>')
          .replace(/^(ç¨é‡‘å†…è¨³ æ­£å¼è¨ˆç®—ï¼ˆèµ¤ä¼ç¥¨æ¸›ç®—å¾Œï¼‰)$/gm, '<span style="color: #1976d2; font-weight: bold;">$1</span>');
        
        document.body.appendChild(journalDiv);
        
        const canvas = await html2canvas(journalDiv, {
          backgroundColor: '#ffffff',
          scale: 2
        });
        
        document.body.removeChild(journalDiv);
        
        const link = document.createElement('a');
        link.download = `æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«_${startDate}_${endDate}.png`;
        link.href = canvas.toDataURL();
        link.click();
        
        console.log('âœ… æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆå®Œäº†');
        
        // å•†å“ã‚«ã‚¦ãƒ³ãƒˆã‚’ã‚½ãƒ¼ãƒˆï¼ˆè²©å£²æ•°ãŒå¤šã„é †ï¼‰
        const sortedItems = Object.entries(itemCounts).sort((a, b) => b[1] - a[1]);
        console.log('ğŸ“Š é›†è¨ˆã•ã‚ŒãŸå•†å“ãƒ‡ãƒ¼ã‚¿:', itemCounts);
        console.log('ğŸ“Š ã‚½ãƒ¼ãƒˆå¾Œã®å•†å“ãƒ‡ãƒ¼ã‚¿:', sortedItems);
        
        // å•†å“ã‚«ã‚¦ãƒ³ãƒˆã®HTMLç”Ÿæˆ
        let itemCountsHtml = '';
        sortedItems.forEach(([itemName, count]) => {
          itemCountsHtml += `
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee;">
              <span>${itemName}</span>
              <strong>${count}å€‹</strong>
            </div>
          `;
        });
        
        // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        container.innerHTML = `
          <div style="padding: 20px;">
            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border-radius: 12px; margin-bottom: 20px;">
              <div style="font-size: 18px; margin-bottom: 10px;">âœ… ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ</div>
              <div style="font-size: 14px; opacity: 0.9;">æœŸé–“: ${startDate} ï½ ${endDate}</div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
              <h4 style="margin: 0 0 15px 0; color: #333;">æœŸé–“ã‚µãƒãƒªãƒ¼</h4>
              <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">ç·å£²ä¸Š</div>
                  <div style="font-size: 24px; font-weight: bold; color: #4CAF50;">Â¥${(totalCashSales + totalEmoneSales + totalCreditSales).toLocaleString()}</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">å®¢æ•°</div>
                  <div style="font-size: 24px; font-weight: bold; color: #2196F3;">${totalCustomerCount}çµ„</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">è²©å£²ç‚¹æ•°</div>
                  <div style="font-size: 24px; font-weight: bold; color: #FF9800;">${totalItems}ç‚¹</div>
                </div>
                <div style="background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <div style="font-size: 12px; color: #666; margin-bottom: 5px;">å¹³å‡å®¢å˜ä¾¡</div>
                  <div style="font-size: 24px; font-weight: bold; color: #9C27B0;">Â¥${totalCustomerCount > 0 ? Math.round((totalCashSales + totalEmoneSales + totalCreditSales) / totalCustomerCount).toLocaleString() : 0}</div>
                </div>
              </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
              <h4 style="margin: 0 0 15px 0; color: #333;">ğŸ’³ æ”¯æ‰•æ–¹æ³•åˆ¥</h4>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>ç¾é‡‘</span>
                <strong>Â¥${totalCashSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>é›»å­ãƒãƒãƒ¼</span>
                <strong>Â¥${totalEmoneSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</span>
                <strong>Â¥${totalCreditSales.toLocaleString()}</strong>
              </div>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 12px;">
              <h4 style="margin: 0 0 15px 0; color: #333;">å•†å“åˆ¥è²©å£²æ•°</h4>
              <div style="max-height: 300px; overflow-y: auto;">
                ${itemCountsHtml || '<div style="text-align: center; color: #999;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'}
              </div>
            </div>
          </div>
        `;
        
      } catch (e) {
        console.error('âŒ æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', e);
        alert('æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ===== æœŸé–“CSVå‡ºåŠ› =====
    window.exportPeriodCSV = async function() {
      try {
        const startDate = document.getElementById('reportStartDate').value;
        const endDate = document.getElementById('reportEndDate').value;
        
        if (!startDate || !endDate) {
          alert('é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        
        if (startDate > endDate) {
          alert('é–‹å§‹æ—¥ã¯çµ‚äº†æ—¥ã‚ˆã‚Šå‰ã®æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
          return;
        }
        
        console.log(`ğŸ“Š æœŸé–“CSVå‡ºåŠ›: ${startDate} ï½ ${endDate}`);
        
        // æœŸé–“å†…ã®å…¨æ—¥ä»˜ã‚’ç”Ÿæˆ
        const start = new Date(startDate);
        const end = new Date(endDate);
        const dates = [];
        
        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
          const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
          dates.push(dateStr);
        }
        
        // å„æ—¥ä»˜ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦åˆè¨ˆ
        let totalCustomerCount = 0;
        let totalItems = 0;
        let totalCashSales = 0;
        let totalEmoneSales = 0;
        let totalCreditSales = 0;
        let totalDiscount = 0;
        let totalTax8 = 0;
        let totalTax10 = 0;
        let totalDrawerOpen = 0;
        let totalRedSlipCount = 0;
        let totalRedSlipAmount = 0;
        let totalRedSlipTax8 = 0;
        let totalRedSlipTax10 = 0;
        let totalExpense = 0;
        let totalLaborCost = 0;
        const itemCounts = {};
        const dailyData = [];
        
        // ordersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ç›´æ¥å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
        const ordersQuery = window.query(
          window.getStoreCollection('orders'),
          window.where('paidAt', '!=', null)
        );
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          if (!data.paidAt) return;
          
          const orderDate = data.paidAt.toDate();
          let targetDate = new Date(orderDate);
          if (orderDate.getHours() < 3) {
            targetDate.setDate(targetDate.getDate() - 1);
          }
          
          const orderDateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-${String(targetDate.getDate()).padStart(2, '0')}`;
          
          if (dates.includes(orderDateStr) && data.items) {
            data.items.forEach(item => {
              itemCounts[item.name] = (itemCounts[item.name] || 0) + (item.quantity || 1);
            });
          }
        });
        
        // æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
        for (const dateStr of dates) {
          const dayData = { date: dateStr };
          
          // å£²ä¸Šãƒ‡ãƒ¼ã‚¿
          const salesDoc = await window.getDoc(window.getStoreDoc('dailySales', dateStr));
          if (salesDoc.exists()) {
            const data = salesDoc.data();
            dayData.customerCount = data.customerCount || 0;
            dayData.totalItems = data.totalItems || 0;
            dayData.cashSales = data.cashSales || 0;
            dayData.emoneSales = data.emoneSales || 0;
            dayData.creditSales = data.creditSales || 0;
            dayData.discount = data.totalDiscount || 0;
            dayData.tax8 = data.tax8Total || 0;
            dayData.tax10 = data.tax10Total || 0;
            dayData.drawerOpen = data.drawerOpenCount || 0;
            dayData.redSlipCount = data.redSlipCount || 0;
            dayData.redSlipAmount = data.redSlipAmount || 0;
            
            totalCustomerCount += dayData.customerCount;
            totalItems += dayData.totalItems;
            totalCashSales += dayData.cashSales;
            totalEmoneSales += dayData.emoneSales;
            totalCreditSales += dayData.creditSales;
            totalDiscount += dayData.discount;
            totalTax8 += dayData.tax8;
            totalTax10 += dayData.tax10;
            totalDrawerOpen += dayData.drawerOpen;
            totalRedSlipCount += dayData.redSlipCount;
            totalRedSlipAmount += dayData.redSlipAmount;
          } else {
            dayData.customerCount = 0;
            dayData.totalItems = 0;
            dayData.cashSales = 0;
            dayData.emoneSales = 0;
            dayData.creditSales = 0;
            dayData.discount = 0;
            dayData.tax8 = 0;
            dayData.tax10 = 0;
            dayData.drawerOpen = 0;
            dayData.redSlipCount = 0;
            dayData.redSlipAmount = 0;
          }
          
          // æ”¯å‡ºãƒ‡ãƒ¼ã‚¿
          const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
          if (expenseDoc.exists()) {
            dayData.expense = expenseDoc.data().total || 0;
            totalExpense += dayData.expense;
          } else {
            dayData.expense = 0;
          }
          
          // äººä»¶è²»ãƒ‡ãƒ¼ã‚¿
          let dayLaborCost = 0;
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(doc => {
            const attData = doc.data();
            if (attData.date === dateStr) {
              if (attData.totalWage && attData.totalWage > 0) {
                dayLaborCost += attData.totalWage;
              }
            }
          });
          dayData.laborCost = dayLaborCost;
          totalLaborCost += dayLaborCost;
          
          dailyData.push(dayData);
        }
        
        // CSVãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
        const totalSales = totalCashSales + totalEmoneSales + totalCreditSales;
        const averageSpend = totalCustomerCount > 0 ? Math.round(totalSales / totalCustomerCount) : 0;
        
        const now = new Date();
        const outputTime = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        
        let csvContent = '';
        
        // åŸºæœ¬æƒ…å ±
        csvContent += 'æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ« CSVå‡ºåŠ›\n';
        csvContent += `æœŸé–“,${startDate},ï½,${endDate}\n`;
        csvContent += `å‡ºåŠ›æ—¥æ™‚,${outputTime}\n`;
        csvContent += '\n';
        
        // ã‚µãƒãƒªãƒ¼
        csvContent += 'ã€å£²ä¸Šã‚µãƒãƒªãƒ¼ã€‘\n';
        csvContent += 'é …ç›®,é‡‘é¡\n';
        csvContent += `å®¢æ•°,${totalCustomerCount.toLocaleString()}äºº\n`;
        csvContent += `å®¢å˜ä¾¡,Â¥${averageSpend.toLocaleString()}\n`;
        csvContent += `ç·å£²ä¸Š,Â¥${totalSales.toLocaleString()}\n`;
        csvContent += `ç¾é‡‘å£²ä¸Š,Â¥${totalCashSales.toLocaleString()}\n`;
        csvContent += `emoneyå£²ä¸Š,Â¥${totalEmoneSales.toLocaleString()}\n`;
        csvContent += `ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆå£²ä¸Š,Â¥${totalCreditSales.toLocaleString()}\n`;
        csvContent += `å€¤å¼•ã,Â¥${totalDiscount.toLocaleString()}\n`;
        csvContent += `8%å¯¾è±¡,Â¥${totalTax8.toLocaleString()}\n`;
        csvContent += `10%å¯¾è±¡,Â¥${totalTax10.toLocaleString()}\n`;
        csvContent += `æ”¯å‡º,Â¥${totalExpense.toLocaleString()}\n`;
        csvContent += `äººä»¶è²»,Â¥${Math.round(totalLaborCost).toLocaleString()}\n`;
        csvContent += `ãƒ‰ãƒ­ã‚¢é–‹,${totalDrawerOpen}å›\n`;
        csvContent += `èµ¤ä¼ç¥¨ä»¶æ•°,${totalRedSlipCount}ä»¶\n`;
        csvContent += `èµ¤ä¼ç¥¨é‡‘é¡,Â¥${totalRedSlipAmount.toLocaleString()}\n`;
        csvContent += '\n';
        
        // å•†å“åˆ¥å£²ä¸Š
        csvContent += 'ã€å•†å“åˆ¥å£²ä¸Šã€‘\n';
        csvContent += 'å•†å“å,è²©å£²æ•°\n';
        const sortedItems = Object.entries(itemCounts).sort((a, b) => b[1] - a[1]);
        sortedItems.forEach(([name, count]) => {
          csvContent += `${name},${count}\n`;
        });
        csvContent += '\n';
        
        // æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿
        csvContent += 'ã€æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ã€‘\n';
        csvContent += 'æ—¥ä»˜,å®¢æ•°,å£²ä¸Šåˆè¨ˆ,ç¾é‡‘,emoney,ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ,å€¤å¼•ã,8%å¯¾è±¡,10%å¯¾è±¡,æ”¯å‡º,äººä»¶è²»,ãƒ‰ãƒ­ã‚¢é–‹,èµ¤ä¼ç¥¨ä»¶æ•°,èµ¤ä¼ç¥¨é‡‘é¡\n';
        dailyData.forEach(day => {
          const dayTotal = day.cashSales + day.emoneSales + day.creditSales;
          csvContent += `${day.date},${day.customerCount},Â¥${dayTotal.toLocaleString()},Â¥${day.cashSales.toLocaleString()},Â¥${day.emoneSales.toLocaleString()},Â¥${day.creditSales.toLocaleString()},Â¥${day.discount.toLocaleString()},Â¥${day.tax8.toLocaleString()},Â¥${day.tax10.toLocaleString()},Â¥${day.expense.toLocaleString()},Â¥${Math.round(day.laborCost).toLocaleString()},${day.drawerOpen},${day.redSlipCount},Â¥${day.redSlipAmount.toLocaleString()}\n`;
        });
        
        // BOMã‚’è¿½åŠ ã—ã¦Excelã§æ–‡å­—åŒ–ã‘ã‚’é˜²ã
        const bom = '\uFEFF';
        const blob = new Blob([bom + csvContent], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«_${startDate}_${endDate}.csv`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        showCustomAlert('CSVå‡ºåŠ›å®Œäº†', `æœŸé–“ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ã‚’CSVå½¢å¼ã§å‡ºåŠ›ã—ã¾ã—ãŸ`, 'success');
        
      } catch (e) {
        console.error('âŒ CSVå‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', e);
        showCustomAlert('CSVå‡ºåŠ›ã‚¨ãƒ©ãƒ¼', 'CSVã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message, 'error');
      }
    };
    
    // ========== å®¢æ•°æ©Ÿèƒ½ ==========
    
    // å®¢æ•°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showCustomerCountModal = async function() {
      document.getElementById('customerCountModal').classList.remove('hidden');
      await calculateCustomerCount();
    };
    
    // å®¢æ•°ã‚’è¨ˆç®—
    async function calculateCustomerCount() {
      const container = document.getElementById('customerCountContent');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">é›†è¨ˆä¸­...</div>';
      
      try {
        console.log('=== å®¢æ•°è¨ˆç®—é–‹å§‹ ===');
        
        // FirebaseåˆæœŸåŒ–ã‚’å¾…ã¤
        if (!window.firebaseReady) {
          console.log('â³ FirebaseåˆæœŸåŒ–å¾…æ©Ÿä¸­...');
          await new Promise(resolve => {
            window.addEventListener('firebaseReady', resolve, { once: true });
          });
          console.log('âœ… FirebaseåˆæœŸåŒ–å®Œäº†ã‚’ç¢ºèª');
        }
        
        const now = new Date();
        const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        
        console.log('æ—¥ä»˜ã‚­ãƒ¼:', dateStr);
        
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        let customerCount = 0;
        if (salesDoc.exists()) {
          customerCount = salesDoc.data().customerCount || 0;
          console.log('å–å¾—ã—ãŸå®¢æ•°:', customerCount);
        } else {
          console.log('æœ¬æ—¥ã®ãƒ‡ãƒ¼ã‚¿ãªã—');
        }
        
        console.log('æœ€çµ‚å®¢æ•°:', customerCount);
        
        container.innerHTML = `
          <div style="text-align: center;">
            <div style="font-size: 80px; font-weight: bold; color: #00bcd4; margin: 20px 0;">
              ${customerCount}
            </div>
            <div style="font-size: 24px; color: #666;">
              çµ„
            </div>
          </div>
        `;
      } catch (e) {
        console.error('å®¢æ•°è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', e);
        container.innerHTML = '<div style="text-align: center; color: red;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    }
    
    // å®¢æ•°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeCustomerCountModal = function() {
      document.getElementById('customerCountModal').classList.add('hidden');
    };
    
    // ========== å£²ä¸Šæ©Ÿèƒ½ ==========
    
    // å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showSalesModal = function() {
      // ğŸ†• ã‚¿ã‚¤ãƒˆãƒ«ã‚’å–¶æ¥­æ—¥ã«å¿œã˜ã¦å¤‰æ›´
      const dateStr = window.getBusinessDateString();
      const displayDate = new Date(dateStr + 'T00:00:00');
      const now = new Date();
      let today = new Date(now);
      if (now.getHours() < 3) {
        today.setDate(today.getDate() - 1);
      }
      
      const isToday = dateStr === window.getBusinessDateString();
      const year = displayDate.getFullYear();
      const month = displayDate.getMonth() + 1;
      const day = displayDate.getDate();
      
      let title;
      const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      
      if (dateStr === todayStr) {
        title = 'æœ¬æ—¥ã®å£²ä¸Š';
      } else {
        title = `${year}å¹´${month}æœˆ${day}æ—¥ã®å£²ä¸Š`;
      }
      
      document.getElementById('salesModalTitle').textContent = title;
      document.getElementById('salesModal').classList.remove('hidden');
      calculateSales();
    };
    
    // å£²ä¸Šã‚’è¨ˆç®—
    window.calculateSales = async function() {
      const container = document.getElementById('salesContent');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">é›†è¨ˆä¸­...</div>';
      
      try {
        // FirebaseåˆæœŸåŒ–ã‚’å¾…ã¤
        if (!window.firebaseReady) {
          await new Promise(resolve => {
            window.addEventListener('firebaseReady', resolve, { once: true });
          });
        }
        
        // ğŸ†• é¸æŠã•ã‚ŒãŸå–¶æ¥­æ—¥ã®å£²ä¸Šã‚’å–å¾—
        const dateStr = window.getBusinessDateString();
        const displayDate = new Date(dateStr + 'T00:00:00');
        
        console.log('ğŸ“Š å£²ä¸Šå–å¾—æ—¥ä»˜:', dateStr);
        
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        console.log('ğŸ“„ dailySalesãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå­˜åœ¨:', salesDoc.exists());
        
        let totalSales = 0;
        let cashSales = 0;
        let emoneSales = 0;
        let creditSales = 0;
        let orderCount = 0;
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          console.log('ğŸ’° å£²ä¸Šãƒ‡ãƒ¼ã‚¿:', data);
          totalSales = data.totalSales || 0;
          cashSales = data.cashSales || 0;
          emoneSales = data.emoneSales || 0;
          creditSales = data.creditSales || 0;
          orderCount = data.customerCount || 0;
        } else {
          console.log('âš ï¸ å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã›ã‚“');
        }
        
        console.log('æœ€çµ‚å£²ä¸Š:', totalSales, 'æ³¨æ–‡æ•°:', orderCount);
        
        // æœ¬æ—¥ã®äººä»¶è²»ã‚’å–å¾—
        let todayLaborCost = 0;
        try {
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.date === dateStr) {
              // æ—¢ã«è¨ˆç®—æ¸ˆã¿ã®ç·è³ƒé‡‘ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
              if (data.totalWage && data.totalWage > 0) {
                todayLaborCost += data.totalWage;
              } else if (data.clockIn && data.clockOut) {
                // ç·è³ƒé‡‘ãŒãªã„å ´åˆã¯è¨ˆç®—ã™ã‚‹
                const clockIn = new Date(`${dateStr} ${data.clockIn}`);
                const clockOut = new Date(`${dateStr} ${data.clockOut}`);
                let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                
                if (data.breakStart1 && data.breakEnd1) {
                  const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                  const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                  workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                }
                if (data.breakStart2 && data.breakEnd2) {
                  const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                  const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                  workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                }
                
                const hourlyRate = data.hourlyRate || 1150;
                
                // å‰²å¢—è³ƒé‡‘ã®è¨ˆç®—
                let totalWage = 0;
                const isHoliday = data.isHoliday || false;
                
                // æ™‚é–“ã”ã¨ã«å‰²å¢—ç‡ã‚’è¨ˆç®—
                let currentTime = new Date(clockIn);
                const endTime = new Date(clockOut);
                
                while (currentTime < endTime) {
                  const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                  const segmentEnd = nextHour > endTime ? endTime : nextHour;
                  
                  // ä¼‘æ†©æ™‚é–“ã‚’é™¤å¤–
                  let isBreak = false;
                  if (data.breakStart1 && data.breakEnd1) {
                    const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                    const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                    if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                      isBreak = true;
                    }
                  }
                  if (data.breakStart2 && data.breakEnd2) {
                    const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                    const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                    if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                      isBreak = true;
                    }
                  }
                  
                  if (!isBreak) {
                    const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                    const hour = currentTime.getHours();
                    
                    let rate = 1.0;
                    if (isHoliday) {
                      // ä¼‘æ—¥å‡ºå‹¤: åŸºæœ¬35%å¢—
                      rate = 1.35;
                      // 22æ™‚ï½5æ™‚ã¯æ·±å¤œå‰²å¢—25%ã‚’è¿½åŠ ï¼ˆåˆè¨ˆ60%å¢—ï¼‰
                      if (hour >= 22 || hour < 5) {
                        rate = 1.60;
                      }
                    } else {
                      // å¹³æ—¥: 22æ™‚ï½5æ™‚ã¯æ·±å¤œå‰²å¢—25%
                      if (hour >= 22 || hour < 5) {
                        rate = 1.25;
                      }
                    }
                    
                    totalWage += segmentHours * hourlyRate * rate;
                  }
                  
                  currentTime = segmentEnd;
                }
                
                todayLaborCost += totalWage;
              }
            }
          });
        } catch (e) {
          console.error('äººä»¶è²»å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        }
        
        // æœ¬æ—¥ã®æ”¯å‡ºã‚’å–å¾—
        let todayExpense = 0;
        try {
          const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
          if (expenseDoc.exists()) {
            todayExpense = expenseDoc.data().total || 0;
          }
        } catch (e) {
          console.error('æ”¯å‡ºå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        }
        
        // ç´”åˆ©ç›Šè¨ˆç®—
        const grossProfit = totalSales - todayLaborCost; // ç²—åˆ©ï¼ˆå£²ä¸Š - äººä»¶è²»ï¼‰
        const netProfit = totalSales - todayLaborCost - todayExpense; // ç´”åˆ©ç›Šï¼ˆå£²ä¸Š - äººä»¶è²» - æ”¯å‡ºï¼‰
        const netProfitRate = totalSales > 0 ? (netProfit / totalSales * 100).toFixed(1) : 0;
        const laborCostRate = totalSales > 0 ? (todayLaborCost / totalSales * 100).toFixed(1) : 0;
        const expenseRate = totalSales > 0 ? (todayExpense / totalSales * 100).toFixed(1) : 0;
        
        console.log('ğŸ’° æœ¬æ—¥ã®åç›Š:', {
          å£²ä¸Š: totalSales,
          äººä»¶è²»: todayLaborCost,
          æ”¯å‡º: todayExpense,
          ç²—åˆ©: grossProfit,
          ç´”åˆ©ç›Š: netProfit
        });
        
        // å£²ä¸ŠãŒ0ã®å ´åˆã®è¡¨ç¤ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const noSalesMessage = totalSales === 0 ? '<div style="font-size: 12px; opacity: 0.8; margin-top: 5px;">â€» æœ¬æ—¥ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>' : '';
        
        // ğŸ†• å£²ä¸Šç›®æ¨™é”æˆç‡ã‚’è¨ˆç®—ï¼ˆé¸æŠã•ã‚ŒãŸå–¶æ¥­æ—¥ã®æ›œæ—¥ã§åˆ¤å®šï¼‰
        const dayOfWeek = displayDate.getDay(); // 0=æ—¥æ›œ, 6=åœŸæ›œ
        const isWeekend = (dayOfWeek === 0 || dayOfWeek === 6);
        const targetSales = isWeekend ? 70000 : 50000;
        const achievementRate = Math.round((totalSales / targetSales) * 100);
        
        const rateColor = achievementRate >= 100 ? '#4CAF50' : achievementRate >= 80 ? '#FF9800' : '#f44336';
        const netProfitColor = netProfit >= 0 ? '#4CAF50' : '#f44336';
        
        const targetSection = `
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
              <h4 style="margin: 0 0 10px 0;">å£²ä¸Šç›®æ¨™</h4>
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>ç›®æ¨™é‡‘é¡ï¼ˆ${isWeekend ? 'åœŸæ—¥ç¥' : 'å¹³æ—¥'}ï¼‰</span>
                <strong>Â¥${targetSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                <span>ç¾åœ¨ã®å£²ä¸Š</span>
                <strong>Â¥${totalSales.toLocaleString()}</strong>
              </div>
              <div style="text-align: center; padding: 10px; background: rgba(255,255,255,0.2); border-radius: 8px;">
                <div style="font-size: 32px; font-weight: bold; color: ${rateColor};">
                  ${achievementRate}%
                </div>
                <div style="font-size: 14px; opacity: 0.9;">é”æˆç‡</div>
              </div>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #FF6B6B 0%, #C92A2A 100%); border-radius: 10px; color: white;">
              <h4 style="margin: 0 0 15px 0;">æœ¬æ—¥ã®ç´”åˆ©ç›Š</h4>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                <span>å£²ä¸Š</span>
                <strong>Â¥${totalSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px;">
                <span>âˆ’ äººä»¶è²»${totalSales > 0 ? 'ï¼ˆ' + laborCostRate + '%ï¼‰' : ''}</span>
                <strong>Â¥${Math.round(todayLaborCost).toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 12px; font-size: 14px;">
                <span>âˆ’ æ”¯å‡º${totalSales > 0 ? 'ï¼ˆ' + expenseRate + '%ï¼‰' : ''}</span>
                <strong>Â¥${Math.round(todayExpense).toLocaleString()}</strong>
              </div>
              <div style="border-top: 2px solid rgba(255,255,255,0.3); padding-top: 12px;">
                <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                  <div style="font-size: 16px; opacity: 0.9; margin-bottom: 5px;">ç´”åˆ©ç›Š</div>
                  <div style="font-size: 32px; font-weight: bold; color: ${netProfitColor};">
                    Â¥${Math.round(netProfit).toLocaleString()}
                  </div>
                  <div style="font-size: 14px; opacity: 0.9; margin-top: 5px;">ç´”åˆ©ç›Šç‡: ${netProfitRate}%</div>
                  ${noSalesMessage}
                </div>
              </div>
            </div>
          `;
        
        container.innerHTML = `
          <div style="background: white; border-radius: 12px; padding: 20px;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 20px;">
              <div style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;">ç·å£²ä¸Š</div>
                <div style="font-size: 28px; font-weight: bold;">Â¥${totalSales.toLocaleString()}</div>
              </div>
              <div style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                <div style="font-size: 14px; opacity: 0.9;">å®¢æ•°</div>
                <div style="font-size: 28px; font-weight: bold;">${orderCount}ä»¶</div>
              </div>
            </div>
            
            ${targetSection}
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
              <h4 style="margin: 0 0 15px 0;">æ”¯æ‰•ã„æ–¹æ³•åˆ¥</h4>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>ç¾é‡‘</span>
                <strong>Â¥${cashSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
                <span>ã‚«ãƒ¼ãƒ‰</span>
                <strong>Â¥${creditSales.toLocaleString()}</strong>
              </div>
              <div style="display: flex; justify-content: space-between; padding: 10px 0;">
                <span>é›»å­ãƒãƒãƒ¼</span>
                <strong>Â¥${emoneSales.toLocaleString()}</strong>
              </div>
            </div>
            
            <div id="taxForecastSection" style="margin-top: 20px;">
              <div style="text-align: center; padding: 10px;">ç´ç¨é¡ã‚’è¨ˆç®—ä¸­...</div>
            </div>
          </div>
        `;
        
        // ç´ç¨é¡äºˆæ¸¬ã‚’éåŒæœŸã§è¨ˆç®—ãƒ»è¡¨ç¤º
        calculateTaxForecast().then(html => {
          document.getElementById('taxForecastSection').innerHTML = html;
        }).catch(err => {
          console.error('ç´ç¨é¡äºˆæ¸¬ã‚¨ãƒ©ãƒ¼:', err);
          document.getElementById('taxForecastSection').innerHTML = `
            <div style="padding: 15px; background: #fff3cd; border-radius: 10px; color: #856404;">
              <strong>âš ï¸ ç´ç¨é¡ã®è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ</strong>
              <div style="font-size: 12px; margin-top: 5px;">${err.message}</div>
            </div>
          `;
        });
      } catch (e) {
        console.error('å£²ä¸Šè¨ˆç®—ã‚¨ãƒ©ãƒ¼:', e);
        container.innerHTML = '<div style="text-align: center; color: red;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    };
    
    // ç´ç¨é¡äºˆæ¸¬ã‚’è¨ˆç®—
    window.calculateTaxForecast = async function() {
      try {
        const now = new Date();
        const currentYear = now.getFullYear();
        const currentMonth = now.getMonth() + 1;
        
        // ä»Šå¹´ã¨æ¥å¹´ã®å¹´åº¦ã‚’è¨ˆç®—ï¼ˆ1-3æœˆã¯å‰å¹´åº¦ï¼‰
        const fiscalYear = currentMonth <= 3 ? currentYear - 1 : currentYear;
        const nextFiscalYear = fiscalYear + 1;
        const lastFiscalYear = fiscalYear - 1;
        
        console.log(`ğŸ“Š ç´ç¨é¡è¨ˆç®—: ä»Šå¹´åº¦=${fiscalYear}, æ¥å¹´åº¦=${nextFiscalYear}, å‰å¹´åº¦=${lastFiscalYear}`);
        
        // ä»Šå¹´åº¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆï¼ˆæ¥å¹´ã®ç´ç¨é¡äºˆæ¸¬ç”¨ï¼‰
        const currentYearTax = await calculateYearlyConsumptionTax(fiscalYear);
        
        // å‰å¹´åº¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆï¼ˆå®Ÿç¸¾ï¼‰
        const lastYearTax = await calculateYearlyConsumptionTax(lastFiscalYear);
        
        const html = `
          <div style="padding: 15px; background: linear-gradient(135deg, #FF6B6B 0%, #C92A2A 100%); border-radius: 10px; color: white;">
            <h4 style="margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
              ğŸ’° æ¶ˆè²»ç¨ç´ç¨é¡
            </h4>
            
            <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 12px; margin-bottom: 10px;">
              <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">æ¥å¹´ï¼ˆ${nextFiscalYear}å¹´ï¼‰ã®äºˆæ¸¬ç´ç¨é¡</div>
              <div style="font-size: 24px; font-weight: bold;">
                Â¥${Math.round(currentYearTax.netTax).toLocaleString()}
              </div>
              <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">
                ä»Šå¹´åº¦ï¼ˆ${fiscalYear}/${fiscalYear + 1}ï¼‰ã®å®Ÿç¸¾ãƒ™ãƒ¼ã‚¹
              </div>
            </div>
            
            <div style="background: rgba(255,255,255,0.15); border-radius: 8px; padding: 12px;">
              <div style="font-size: 13px; opacity: 0.9; margin-bottom: 5px;">å‰å¹´ï¼ˆ${fiscalYear}å¹´ï¼‰ã®ç´ç¨é¡</div>
              <div style="font-size: 24px; font-weight: bold;">
                Â¥${Math.round(lastYearTax.netTax).toLocaleString()}
              </div>
              <div style="font-size: 11px; opacity: 0.8; margin-top: 5px;">
                å‰å¹´åº¦ï¼ˆ${lastFiscalYear}/${lastFiscalYear + 1}ï¼‰ã®å®Ÿç¸¾
              </div>
            </div>
            
            <div style="margin-top: 12px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 6px; font-size: 11px;">
              <div style="margin-bottom: 5px;">
                <strong>ğŸ“ˆ å†…è¨³ï¼ˆä»Šå¹´åº¦ï¼‰</strong>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                <span>ä»®å—æ¶ˆè²»ç¨ï¼ˆå£²ä¸Š8%ï¼‰</span>
                <span>Â¥${Math.round(currentYearTax.receivedTax8).toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                <span>ä»®å—æ¶ˆè²»ç¨ï¼ˆå£²ä¸Š10%ï¼‰</span>
                <span>Â¥${Math.round(currentYearTax.receivedTax10).toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 2px; padding-left: 10px; opacity: 0.9;">
                <span>å°è¨ˆ</span>
                <span>Â¥${Math.round(currentYearTax.receivedTax).toLocaleString()}</span>
              </div>
              <div style="height: 1px; background: rgba(255,255,255,0.2); margin: 5px 0;"></div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 2px;">
                <span>ä»®æ‰•æ¶ˆè²»ç¨ï¼ˆæ”¯å‡º8%ï¼‰</span>
                <span>Â¥${Math.round(currentYearTax.paidTax8).toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                <span>ä»®æ‰•æ¶ˆè²»ç¨ï¼ˆæ”¯å‡º10%ï¼‰</span>
                <span>Â¥${Math.round(currentYearTax.paidTax10).toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 3px; padding-left: 10px; opacity: 0.9;">
                <span>å°è¨ˆ</span>
                <span>Â¥${Math.round(currentYearTax.paidTax).toLocaleString()}</span>
              </div>
              <div style="height: 1px; background: rgba(255,255,255,0.2); margin: 5px 0;"></div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 3px; opacity: 0.7;">
                <span>äººä»¶è²»ï¼ˆå¯¾è±¡å¤–ï¼‰</span>
                <span>Â¥${Math.round(currentYearTax.laborCost).toLocaleString()}</span>
              </div>
              <div style="height: 1px; background: rgba(255,255,255,0.3); margin: 8px 0;"></div>
              <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 12px;">
                <span>ç´ç¨é¡</span>
                <span>Â¥${Math.round(currentYearTax.netTax).toLocaleString()}</span>
              </div>
            </div>
            
            <div style="margin-top: 8px; font-size: 10px; opacity: 0.8;">
              â€» ç°¡æ˜“èª²ç¨åˆ¶åº¦ãƒ»ã‚¤ãƒ³ãƒœã‚¤ã‚¹åˆ¶åº¦ã¯è€ƒæ…®ã—ã¦ã„ã¾ã›ã‚“<br/>
              â€» å®Ÿéš›ã®ç´ç¨é¡ã¯ç¨ç†å£«ã«ã”ç¢ºèªãã ã•ã„
            </div>
          </div>
        `;
        
        return html;
      } catch (err) {
        console.error('ç´ç¨é¡äºˆæ¸¬è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', err);
        throw err;
      }
    };
    
    // å¹´åº¦ã®æ¶ˆè²»ç¨ã‚’è¨ˆç®—
    async function calculateYearlyConsumptionTax(fiscalYear) {
      const startDate = new Date(fiscalYear, 3, 1); // 4æœˆ1æ—¥
      const endDate = new Date(fiscalYear + 1, 2, 31, 23, 59, 59); // ç¿Œå¹´3æœˆ31æ—¥
      
      console.log(`ğŸ“… é›†è¨ˆæœŸé–“: ${startDate.toLocaleDateString()} ã€œ ${endDate.toLocaleDateString()}`);
      
      let receivedTax8 = 0; // ä»®å—æ¶ˆè²»ç¨8%
      let receivedTax10 = 0; // ä»®å—æ¶ˆè²»ç¨10%
      let paidTax8 = 0; // ä»®æ‰•æ¶ˆè²»ç¨8%
      let paidTax10 = 0; // ä»®æ‰•æ¶ˆè²»ç¨10%
      let laborCost = 0; // äººä»¶è²»ï¼ˆæ¶ˆè²»ç¨å¯¾è±¡å¤–ï¼‰
      
      const startDateStr = `${fiscalYear}-${String(4).padStart(2, '0')}-01`;
      const endYear = fiscalYear + 1;
      const endDateStr = `${endYear}-${String(3).padStart(2, '0')}-31`;
      
      // 1. æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä»®å—æ¶ˆè²»ç¨ã‚’è¨ˆç®—ï¼ˆå•†å“ã”ã¨ã®ç¨ç‡ã‚’ä½¿ç”¨ï¼‰
      try {
        const ordersQuery = window.query(
          window.getStoreCollection('orders'),
          window.where('paidAt', '>=', window.Timestamp.fromDate(startDate)),
          window.where('paidAt', '<=', window.Timestamp.fromDate(endDate))
        );
        
        const ordersSnapshot = await window.getDocs(ordersQuery);
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.items && Array.isArray(data.items)) {
            data.items.forEach(item => {
              const itemTotal = (item.price || 0) * (item.quantity || 1);
              const taxRate = item.taxRate || 10;
              
              if (taxRate === 8) {
                receivedTax8 += itemTotal * (8 / 108);
              } else {
                receivedTax10 += itemTotal * (10 / 110);
              }
            });
          }
        });
        
        console.log(`ğŸ§¾ ä»®å—æ¶ˆè²»ç¨: 8%=Â¥${receivedTax8.toFixed(0)}, 10%=Â¥${receivedTax10.toFixed(0)}`);
      } catch (err) {
        console.warn('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
      }
      
      // 2. æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ä»®æ‰•æ¶ˆè²»ç¨ã‚’è¨ˆç®—
      try {
        const expensesSnapshot = await window.getDocs(window.getStoreCollection('expenses'));
        
        expensesSnapshot.forEach(doc => {
          const data = doc.data();
          const date = data.date;
          
          // æœŸé–“å†…ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿
          if (date && date >= startDateStr && date <= endDateStr) {
            if (data.items && Array.isArray(data.items)) {
              data.items.forEach(item => {
                const amount = item.amount || 0;
                const category = item.category;
                
                // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã”ã¨ã®ç¨ç‡åˆ¤å®š
                if (category === 'ææ–™è²»' || category === 'é£Ÿè²»' || 
                    category === 'æ¥å¾…äº¤éš›è²»' || category === 'äº¤é€šè²»') {
                  // 8%å¯¾è±¡
                  paidTax8 += amount * (8 / 108);
                } else if (category === 'æ—¥ç”¨å“' || category === 'é›‘è²»ãƒ»é›‘å“' || 
                           category === 'æ°´å…‰ç†±è²»' || category === 'ãã®ä»–') {
                  // 10%å¯¾è±¡
                  paidTax10 += amount * (10 / 110);
                }
                // ãã®ä»–ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã¯æ¶ˆè²»ç¨å¯¾è±¡å¤–
              });
            }
          }
        });
        
        console.log(`ğŸ§¾ ä»®æ‰•æ¶ˆè²»ç¨: 8%=Â¥${paidTax8.toFixed(0)}, 10%=Â¥${paidTax10.toFixed(0)}`);
      } catch (err) {
        console.warn('æ”¯å‡ºãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
      }
      
      // 3. äººä»¶è²»ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      try {
        const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
        
        attendanceSnapshot.forEach(doc => {
          const data = doc.data();
          const dateStr = data.date;
          
          // æœŸé–“å†…ã®ãƒ‡ãƒ¼ã‚¿ã®ã¿
          if (dateStr && dateStr >= startDateStr && dateStr <= endDateStr) {
            // æ—¢ã«è¨ˆç®—æ¸ˆã¿ã®ç·è³ƒé‡‘ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
            if (data.totalWage && data.totalWage > 0) {
              laborCost += data.totalWage;
            } else if (data.clockIn && data.clockOut) {
              // ç·è³ƒé‡‘ãŒãªã„å ´åˆã¯è¨ˆç®—ã™ã‚‹
              const clockIn = new Date(`${dateStr} ${data.clockIn}`);
              const clockOut = new Date(`${dateStr} ${data.clockOut}`);
              let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
              
              // ä¼‘æ†©æ™‚é–“ã‚’å¼•ã
              if (data.breakStart1 && data.breakEnd1) {
                const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
              }
              if (data.breakStart2 && data.breakEnd2) {
                const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
              }
              
              const hourlyRate = data.hourlyRate || 1150;
              
              // å‰²å¢—è³ƒé‡‘ã®è¨ˆç®—
              let totalWage = 0;
              const isHoliday = data.isHoliday || false;
              
              // æ™‚é–“ã”ã¨ã«å‰²å¢—ç‡ã‚’è¨ˆç®—
              let currentTime = new Date(clockIn);
              const endTime = new Date(clockOut);
              
              while (currentTime < endTime) {
                const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                const segmentEnd = nextHour > endTime ? endTime : nextHour;
                
                // ä¼‘æ†©æ™‚é–“ã‚’é™¤å¤–
                let isBreak = false;
                if (data.breakStart1 && data.breakEnd1) {
                  const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                  const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                  if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                    isBreak = true;
                  }
                }
                if (data.breakStart2 && data.breakEnd2) {
                  const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                  const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                  if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                    isBreak = true;
                  }
                }
                
                if (!isBreak) {
                  const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                  const hour = currentTime.getHours();
                  
                  let rate = 1.0;
                  if (isHoliday) {
                    // ä¼‘æ—¥å‡ºå‹¤: åŸºæœ¬35%å¢—
                    rate = 1.35;
                    // 22æ™‚ï½5æ™‚ã¯æ·±å¤œå‰²å¢—25%ã‚’è¿½åŠ ï¼ˆåˆè¨ˆ60%å¢—ï¼‰
                    if (hour >= 22 || hour < 5) {
                      rate = 1.60;
                    }
                  } else {
                    // å¹³æ—¥: 22æ™‚ï½5æ™‚ã¯æ·±å¤œå‰²å¢—25%
                    if (hour >= 22 || hour < 5) {
                      rate = 1.25;
                    }
                  }
                  
                  totalWage += segmentHours * hourlyRate * rate;
                }
                
                currentTime = segmentEnd;
              }
              
              laborCost += totalWage;
            }
          }
        });
        
        console.log(`ğŸ‘· äººä»¶è²»: Â¥${laborCost.toFixed(0)}`);
      } catch (err) {
        console.warn('äººä»¶è²»ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:', err);
      }
      
      const receivedTax = receivedTax8 + receivedTax10;
      const paidTax = paidTax8 + paidTax10;
      const netTax = receivedTax - paidTax;
      
      console.log(`ğŸ’° è¨ˆç®—çµæœ: ä»®å—=Â¥${receivedTax.toFixed(0)}, ä»®æ‰•=Â¥${paidTax.toFixed(0)}, äººä»¶è²»=Â¥${laborCost.toFixed(0)}, ç´ç¨é¡=Â¥${netTax.toFixed(0)}`);
      
      return {
        receivedTax,
        receivedTax8,
        receivedTax10,
        paidTax,
        paidTax8,
        paidTax10,
        laborCost,
        netTax
      };
    }
    
    // å£²ä¸Šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeSalesModal = function() {
      document.getElementById('salesModal').classList.add('hidden');
    };
    
    // ========== ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æ©Ÿèƒ½ ==========
    
    // ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³
    window.openDrawer = async function() {
      try {
        console.log('ğŸ”“ ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³é–‹å§‹');
        
        const now = new Date();
        const dateStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
        
        console.log('ğŸ“… æ—¥ä»˜:', dateStr);
        
        // æ‹…å½“è€…ã‚’å–å¾—
        const staffSelect = document.getElementById('staffSelect');
        const staffName = staffSelect.value || 'ãƒ¬ã‚¸ä¿‚';
        
        console.log('ğŸ‘¤ æ‹…å½“è€…:', staffName);
        
        // dailySalesã®ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æ•°ã‚’æ›´æ–°
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        console.log('ğŸ“„ salesRef:', salesRef);
        
        const salesDoc = await window.getDoc(salesRef);
        console.log('ğŸ“„ salesDoc exists:', salesDoc.exists());
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          const currentCount = data.drawerOpenCount || 0;
          const newCount = currentCount + 1;
          
          console.log('ğŸ“Š ç¾åœ¨ã®ã‚«ã‚¦ãƒ³ãƒˆ:', currentCount);
          console.log('ğŸ“Š æ–°ã—ã„ã‚«ã‚¦ãƒ³ãƒˆ:', newCount);
          
          await window.updateDoc(salesRef, {
            drawerOpenCount: newCount,
            updatedAt: window.Timestamp.now()
          });
          
          console.log('âœ… drawerOpenCountã‚’æ›´æ–°:', newCount);
        } else {
          // ä»Šæ—¥ã®å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯æ–°è¦ä½œæˆ
          console.log('ğŸ“ æ–°è¦dailySalesãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆ');
          
          await window.setDoc(salesRef, {
            date: dateStr,
            totalSales: 0,
            customerCount: 0,
            totalItems: 0,
            tax8Total: 0,
            tax10Total: 0,
            cashSales: 0,
            emoneSales: 0,
            creditSales: 0,
            drawerOpenCount: 1,
            createdAt: window.Timestamp.now(),
            updatedAt: window.Timestamp.now()
          });
          
          console.log('âœ… æ–°è¦ä½œæˆ drawerOpenCount: 1');
        }
        
        // ãƒ‰ãƒ­ã‚¢é–‹é–‰ãƒ­ã‚°ã‚’è¨˜éŒ²
        await window.addDoc(window.collection(window.db, 'drawer_logs'), {
          timestamp: window.Timestamp.now(),
          staffName: staffName,
          action: 'open'
        });
        
        console.log('ğŸ’° ãƒ‰ãƒ­ã‚¢é–‹: æ‹…å½“è€…', staffName);
        showCustomAlert('ãƒ‰ãƒ­ã‚¢ã‚’é–‹ãã¾ã—ãŸ\næ‹…å½“è€…: ' + staffName, 'é€šçŸ¥', 'ğŸ’°');
        
      } catch (error) {
        console.error('âŒ ãƒ‰ãƒ­ã‚¢é–‹ã‚¨ãƒ©ãƒ¼:', error);
        console.error('âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.stack);
        showCustomAlert('ãƒ‰ãƒ­ã‚¢é–‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'ã‚¨ãƒ©ãƒ¼', 'âŒ');
      }
    };
    
    // ========== ğŸ†• ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ ==========
    
    /**
     * è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼ˆ7æ—¥ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
     * å‰Šé™¤è¨­å®šã§å‰Šé™¤ã•ã‚Œã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
     */
    window.createAutoBackup = async function() {
      try {
        console.log('ğŸ”„ è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–‹å§‹ï¼ˆ7æ—¥ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰');
        
        const { getDocs, setDoc, doc, Timestamp } = window;
        const today = new Date();
        const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
        
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
        const backupData = {
          timestamp: Timestamp.now(),
          date: dateStr,
          type: 'auto',
          data: {}
        };
        
        // 1. å•†å“ãƒ‡ãƒ¼ã‚¿ï¼ˆmenusï¼‰
        const menusSnapshot = await getDocs(window.getStoreCollection('menus'));
        backupData.data.menus = [];
        menusSnapshot.forEach(docSnap => {
          backupData.data.menus.push({
            id: docSnap.id,
            ...docSnap.data()
          });
        });
        console.log(`ğŸ“¦ å•†å“: ${backupData.data.menus.length}ä»¶`);
        
        // 2. å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ï¼ˆemployeesï¼‰
        const employeesSnapshot = await getDocs(window.getStoreCollection('employees'));
        backupData.data.employees = [];
        employeesSnapshot.forEach(docSnap => {
          backupData.data.employees.push({
            id: docSnap.id,
            ...docSnap.data()
          });
        });
        console.log(`ğŸ‘¥ å¾“æ¥­å“¡: ${backupData.data.employees.length}å`);
        
        // 3. æ³¨æ–‡å±¥æ­´ï¼ˆordersï¼‰- æœ€è¿‘1000ä»¶ã®ã¿
        const ordersCollection = window.getStoreCollection('orders');
        const ordersSnapshot = await getDocs(ordersCollection);
        const ordersList = [];
        ordersSnapshot.forEach(docSnap => {
          const data = docSnap.data();
          ordersList.push({
            id: docSnap.id,
            ...data,
            _timestamp: data.createdAt || data.timestamp || new Date(0)
          });
        });
        
        // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
        ordersList.sort((a, b) => {
          const timeA = a._timestamp?.toDate ? a._timestamp.toDate() : new Date(a._timestamp);
          const timeB = b._timestamp?.toDate ? b._timestamp.toDate() : new Date(b._timestamp);
          return timeB - timeA;
        });
        
        // æœ€æ–°1000ä»¶ã®ã¿ä¿å­˜
        backupData.data.orders = ordersList.slice(0, 1000).map(item => {
          const { _timestamp, ...rest } = item;
          return rest;
        });
        console.log(`ğŸ“ æ³¨æ–‡å±¥æ­´: ${backupData.data.orders.length}ä»¶`);
        
        // 4. å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ï¼ˆattendanceï¼‰- æœ€è¿‘1000ä»¶ã®ã¿
        const attendanceCollection = window.getStoreCollection('attendance');
        const attendanceSnapshot = await getDocs(attendanceCollection);
        const attendanceList = [];
        attendanceSnapshot.forEach(docSnap => {
          const data = docSnap.data();
          attendanceList.push({
            id: docSnap.id,
            ...data,
            _timestamp: data.createdAt || data.timestamp || new Date(0)
          });
        });
        
        // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
        attendanceList.sort((a, b) => {
          const timeA = a._timestamp?.toDate ? a._timestamp.toDate() : new Date(a._timestamp);
          const timeB = b._timestamp?.toDate ? b._timestamp.toDate() : new Date(b._timestamp);
          return timeB - timeA;
        });
        
        // æœ€æ–°1000ä»¶ã®ã¿ä¿å­˜
        backupData.data.attendance = attendanceList.slice(0, 1000).map(item => {
          const { _timestamp, ...rest } = item;
          return rest;
        });
        console.log(`â° å‹¤æ€ : ${backupData.data.attendance.length}ä»¶`);
        
        // ğŸ†• è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        const { getDoc } = window;
        
        // ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®š
        try {
          let receiptRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            receiptRef = doc(window.db, 'stores', window.currentStoreId, 'receipt_settings', 'default');
          } else {
            receiptRef = doc(window.db, 'receipt_settings', 'default');
          }
          const receiptDoc = await getDoc(receiptRef);
          backupData.data.receipt_settings = receiptDoc.exists() ? receiptDoc.data() : null;
        } catch (e) { backupData.data.receipt_settings = null; }
        
        // å•†å“ã‚«ãƒ†ã‚´ãƒªè¨­å®šã¨ãƒˆãƒƒãƒ”ãƒ³ã‚°
        try {
          let menuSettingsRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            menuSettingsRef = doc(window.db, 'stores', window.currentStoreId, 'menu_settings', 'default');
          } else {
            menuSettingsRef = doc(window.db, 'menu_settings', 'default');
          }
          const menuSettingsDoc = await getDoc(menuSettingsRef);
          const menuSettingsData = menuSettingsDoc.exists() ? menuSettingsDoc.data() : null;
          
          // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’è¿½åŠ 
          if (menuSettingsData) {
            try {
              const toppingsSnapshot = await getDocs(window.getStoreCollection('toppings'));
              const toppings = [];
              toppingsSnapshot.forEach(docSnap => {
                toppings.push({ id: docSnap.id, ...docSnap.data() });
              });
              menuSettingsData.toppings = toppings;
            } catch (e) {
              menuSettingsData.toppings = [];
            }
          }
          
          backupData.data.menu_settings = menuSettingsData;
        } catch (e) { backupData.data.menu_settings = null; }
        
        // åœ¨åº«è¨­å®š
        try {
          let inventoryRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            inventoryRef = doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
          } else {
            inventoryRef = doc(window.db, 'inventory_settings', 'default');
          }
          const inventoryDoc = await getDoc(inventoryRef);
          backupData.data.inventory_settings = inventoryDoc.exists() ? inventoryDoc.data() : null;
        } catch (e) { backupData.data.inventory_settings = null; }
        
        // ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
        try {
          let alertRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            alertRef = doc(window.db, 'stores', window.currentStoreId, 'alert_settings', 'default');
          } else {
            alertRef = doc(window.db, 'alert_settings', 'default');
          }
          const alertDoc = await getDoc(alertRef);
          backupData.data.alert_settings = alertDoc.exists() ? alertDoc.data() : null;
        } catch (e) { backupData.data.alert_settings = null; }
        
        // å–¶æ¥­æ™‚é–“è¨­å®š
        try {
          let businessRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            businessRef = doc(window.db, 'stores', window.currentStoreId, 'business_hours', 'default');
          } else {
            businessRef = doc(window.db, 'business_hours', 'default');
          }
          const businessDoc = await getDoc(businessRef);
          backupData.data.business_hours = businessDoc.exists() ? businessDoc.data() : null;
        } catch (e) { backupData.data.business_hours = null; }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š
        try {
          let tableRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            tableRef = doc(window.db, 'stores', window.currentStoreId, 'table_settings', 'default');
          } else {
            tableRef = doc(window.db, 'table_settings', 'default');
          }
          const tableDoc = await getDoc(tableRef);
          backupData.data.table_settings = tableDoc.exists() ? tableDoc.data() : null;
        } catch (e) { backupData.data.table_settings = null; }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆå„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼‰
        try {
          const tablesSnapshot = await getDocs(window.getStoreCollection('tables'));
          backupData.data.tables = [];
          tablesSnapshot.forEach(docSnap => {
            backupData.data.tables.push({ id: docSnap.id, ...docSnap.data() });
          });
          console.log(`ğŸ½ï¸ ãƒ†ãƒ¼ãƒ–ãƒ«: ${backupData.data.tables.length}ä»¶`);
        } catch (e) {
          console.warn('ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—:', e.message);
          backupData.data.tables = [];
        }
        
        const settingsCount = [
          backupData.data.menu_settings,
          backupData.data.receipt_settings,
          backupData.data.inventory_settings,
          backupData.data.alert_settings,
          backupData.data.business_hours,
          backupData.data.table_settings
        ].filter(s => s !== null).length;
        console.log(`âš™ï¸ è¨­å®š: ${settingsCount}ç¨®é¡`);
        
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ï¼ˆ7æ—¥ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰
        const dayOfWeek = today.getDay(); // 0=æ—¥æ›œ, 1=æœˆæ›œ, ..., 6=åœŸæ›œ
        const backupId = `auto_day${dayOfWeek}`; // day0ã€œday6ã§7æ—¥ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
        
        let backupRef;
        if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
          backupRef = doc(window.db, 'stores', window.currentStoreId, 'backups', backupId);
        } else {
          backupRef = doc(window.db, 'backups', backupId);
        }
        
        await setDoc(backupRef, backupData);
        
        console.log(`âœ… è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†: ${backupId} (${dateStr})`);
        return true;
      } catch (error) {
        console.error('âŒ è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
        return false;
      }
    };
    
    /**
     * æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
     */
    window.createManualBackup = async function() {
      try {
        console.log('ğŸ’¾ æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—é–‹å§‹');
        
        const { getDocs, setDoc, doc, Timestamp } = window;
        const now = new Date();
        const dateTimeStr = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;
        
        // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’åé›†
        const backupData = {
          timestamp: Timestamp.now(),
          date: dateTimeStr,
          type: 'manual',
          data: {}
        };
        
        // 1. å•†å“ãƒ‡ãƒ¼ã‚¿
        const menusSnapshot = await getDocs(window.getStoreCollection('menus'));
        backupData.data.menus = [];
        menusSnapshot.forEach(docSnap => {
          backupData.data.menus.push({
            id: docSnap.id,
            ...docSnap.data()
          });
        });
        
        // 2. å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿
        const employeesSnapshot = await getDocs(window.getStoreCollection('employees'));
        backupData.data.employees = [];
        employeesSnapshot.forEach(docSnap => {
          backupData.data.employees.push({
            id: docSnap.id,
            ...docSnap.data()
          });
        });
        
        // 3. æ³¨æ–‡å±¥æ­´ï¼ˆæœ€è¿‘1000ä»¶ï¼‰
        const ordersCollection = window.getStoreCollection('orders');
        const ordersSnapshot = await getDocs(ordersCollection);
        const ordersList = [];
        ordersSnapshot.forEach(docSnap => {
          const data = docSnap.data();
          ordersList.push({
            id: docSnap.id,
            ...data,
            _timestamp: data.createdAt || data.timestamp || new Date(0)
          });
        });
        
        // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
        ordersList.sort((a, b) => {
          const timeA = a._timestamp?.toDate ? a._timestamp.toDate() : new Date(a._timestamp);
          const timeB = b._timestamp?.toDate ? b._timestamp.toDate() : new Date(b._timestamp);
          return timeB - timeA;
        });
        
        // æœ€æ–°1000ä»¶ã®ã¿ä¿å­˜
        backupData.data.orders = ordersList.slice(0, 1000).map(item => {
          const { _timestamp, ...rest } = item;
          return rest;
        });
        
        // 4. å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€è¿‘1000ä»¶ï¼‰
        const attendanceCollection = window.getStoreCollection('attendance');
        const attendanceSnapshot = await getDocs(attendanceCollection);
        const attendanceList = [];
        attendanceSnapshot.forEach(docSnap => {
          const data = docSnap.data();
          attendanceList.push({
            id: docSnap.id,
            ...data,
            _timestamp: data.createdAt || data.timestamp || new Date(0)
          });
        });
        
        // æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
        attendanceList.sort((a, b) => {
          const timeA = a._timestamp?.toDate ? a._timestamp.toDate() : new Date(a._timestamp);
          const timeB = b._timestamp?.toDate ? b._timestamp.toDate() : new Date(b._timestamp);
          return timeB - timeA;
        });
        
        // æœ€æ–°1000ä»¶ã®ã¿ä¿å­˜
        backupData.data.attendance = attendanceList.slice(0, 1000).map(item => {
          const { _timestamp, ...rest } = item;
          return rest;
        });
        
        // ğŸ†• è¨­å®šãƒ‡ãƒ¼ã‚¿ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
        const { getDoc } = window;
        
        // ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®š
        try {
          let receiptRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            receiptRef = doc(window.db, 'stores', window.currentStoreId, 'receipt_settings', 'default');
          } else {
            receiptRef = doc(window.db, 'receipt_settings', 'default');
          }
          const receiptDoc = await getDoc(receiptRef);
          backupData.data.receipt_settings = receiptDoc.exists() ? receiptDoc.data() : null;
        } catch (e) { backupData.data.receipt_settings = null; }
        
        // å•†å“ã‚«ãƒ†ã‚´ãƒªè¨­å®šã¨ãƒˆãƒƒãƒ”ãƒ³ã‚°
        try {
          let menuSettingsRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            menuSettingsRef = doc(window.db, 'stores', window.currentStoreId, 'menu_settings', 'default');
          } else {
            menuSettingsRef = doc(window.db, 'menu_settings', 'default');
          }
          const menuSettingsDoc = await getDoc(menuSettingsRef);
          const menuSettingsData = menuSettingsDoc.exists() ? menuSettingsDoc.data() : null;
          
          // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’è¿½åŠ 
          if (menuSettingsData) {
            try {
              const toppingsSnapshot = await getDocs(window.getStoreCollection('toppings'));
              const toppings = [];
              toppingsSnapshot.forEach(docSnap => {
                toppings.push({ id: docSnap.id, ...docSnap.data() });
              });
              menuSettingsData.toppings = toppings;
            } catch (e) {
              menuSettingsData.toppings = [];
            }
          }
          
          backupData.data.menu_settings = menuSettingsData;
        } catch (e) { backupData.data.menu_settings = null; }
        
        // åœ¨åº«è¨­å®š
        try {
          let inventoryRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            inventoryRef = doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
          } else {
            inventoryRef = doc(window.db, 'inventory_settings', 'default');
          }
          const inventoryDoc = await getDoc(inventoryRef);
          backupData.data.inventory_settings = inventoryDoc.exists() ? inventoryDoc.data() : null;
        } catch (e) { backupData.data.inventory_settings = null; }
        
        // ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
        try {
          let alertRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            alertRef = doc(window.db, 'stores', window.currentStoreId, 'alert_settings', 'default');
          } else {
            alertRef = doc(window.db, 'alert_settings', 'default');
          }
          const alertDoc = await getDoc(alertRef);
          backupData.data.alert_settings = alertDoc.exists() ? alertDoc.data() : null;
        } catch (e) { backupData.data.alert_settings = null; }
        
        // å–¶æ¥­æ™‚é–“è¨­å®š
        try {
          let businessRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            businessRef = doc(window.db, 'stores', window.currentStoreId, 'business_hours', 'default');
          } else {
            businessRef = doc(window.db, 'business_hours', 'default');
          }
          const businessDoc = await getDoc(businessRef);
          backupData.data.business_hours = businessDoc.exists() ? businessDoc.data() : null;
        } catch (e) { backupData.data.business_hours = null; }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š
        try {
          let tableRef;
          if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
            tableRef = doc(window.db, 'stores', window.currentStoreId, 'table_settings', 'default');
          } else {
            tableRef = doc(window.db, 'table_settings', 'default');
          }
          const tableDoc = await getDoc(tableRef);
          backupData.data.table_settings = tableDoc.exists() ? tableDoc.data() : null;
        } catch (e) { backupData.data.table_settings = null; }
        
        const settingsCount = [
          backupData.data.menu_settings,
          backupData.data.receipt_settings,
          backupData.data.inventory_settings,
          backupData.data.alert_settings,
          backupData.data.business_hours,
          backupData.data.table_settings
        ].filter(s => s !== null).length;
        
        // æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜
        const backupId = `manual_${dateTimeStr}`;
        
        let backupRef;
        if (window.currentStoreId && window.currentStoreId !== '' && window.currentStoreId !== null) {
          backupRef = doc(window.db, 'stores', window.currentStoreId, 'backups', backupId);
        } else {
          backupRef = doc(window.db, 'backups', backupId);
        }
        
        await setDoc(backupRef, backupData);
        
        console.log(`âœ… æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†: ${backupId}`);
        alert(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ\n\nå•†å“: ${backupData.data.menus.length}ä»¶\nå¾“æ¥­å“¡: ${backupData.data.employees.length}å\næ³¨æ–‡: ${backupData.data.orders.length}ä»¶\nå‹¤æ€ : ${backupData.data.attendance.length}ä»¶\nè¨­å®š: ${settingsCount}ç¨®é¡`);
        return true;
      } catch (error) {
        console.error('âŒ æ‰‹å‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        return false;
      }
    };
    
    // ========== ç²¾ç®—æ©Ÿèƒ½ ==========
    
    // ç²¾ç®—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showSettlementModal = async function() {
      // FirebaseåˆæœŸåŒ–ã‚’å¾…ã¤
      if (!window.firebaseReady) {
        await new Promise(resolve => {
          window.addEventListener('firebaseReady', resolve, { once: true });
        });
      }
      
      // ğŸ†• é¸æŠã•ã‚ŒãŸå–¶æ¥­æ—¥ã‚’åˆæœŸå€¤ã¨ã—ã¦è¨­å®š
      const dateStr = window.getBusinessDateString();
      
      console.log('ğŸ“… ç²¾ç®—æ—¥ä»˜:', dateStr);
      
      document.getElementById('settlementDate').value = dateStr;
      
      const container = document.getElementById('settlementSummary');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">é›†è¨ˆä¸­...</div>';
      
      document.getElementById('settlementModal').classList.remove('hidden');
      
      // æ—¥ä»˜å¤‰æ›´æ™‚ã«ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
      document.getElementById('settlementDate').onchange = updateSettlementSummary;
      
      await updateSettlementSummary();
    };
    
    // ç²¾ç®—ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
    async function updateSettlementSummary() {
      const container = document.getElementById('settlementSummary');
      container.innerHTML = '<div style="text-align: center; padding: 20px;">é›†è¨ˆä¸­...</div>';
      
      try {
        const dateStr = document.getElementById('settlementDate').value;
        
        // æ—¥æ¬¡å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await window.getDoc(salesRef);
        
        let settlementData = {
          totalSales: 0,
          customerCount: 0,
          totalItems: 0,
          cashSales: 0,
          emoneSales: 0,
          creditSales: 0,
          totalDiscount: 0,
          tax8Total: 0,
          tax10Total: 0,
          drawerOpenCount: 0,
          redSlipCount: 0,  // ğŸ†•
          redSlipAmount: 0,  // ğŸ†•
          redSlipTax8Total: 0,  // ğŸ†•
          redSlipTax10Total: 0  // ğŸ†•
        };
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          console.log('ğŸ“Š dailySalesãƒ‡ãƒ¼ã‚¿:', data);
          console.log('ğŸ”“ drawerOpenCount:', data.drawerOpenCount);
          
          settlementData = {
            totalSales: data.totalSales || 0,
            customerCount: data.customerCount || 0,
            totalItems: data.totalItems || 0,
            cashSales: data.cashSales || 0,
            emoneSales: data.emoneSales || 0,
            creditSales: data.creditSales || 0,
            totalDiscount: data.totalDiscount || 0,
            tax8Total: data.tax8Total || 0,
            tax10Total: data.tax10Total || 0,
            drawerOpenCount: data.drawerOpenCount || 0,
            redSlipCount: data.redSlipCount || 0,  // ğŸ†•
            redSlipAmount: data.redSlipAmount || 0,  // ğŸ†•
            redSlipTax8Total: data.redSlipTax8Total || 0,  // ğŸ†•
            redSlipTax10Total: data.redSlipTax10Total || 0  // ğŸ†•
          };
          
          console.log('ğŸ“Š settlementData:', settlementData);
        }
        
        // settlementDataã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜ï¼ˆCSVç”Ÿæˆã§ä½¿ç”¨ï¼‰
        window.currentSettlementData = settlementData;
        window.currentSettlementDate = dateStr;
        
        container.innerHTML = `
          <div style="background: #f8f9fa; padding: 20px; border-radius: 10px;">
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 2px solid #ddd;">
              <span style="font-size: 16px;">ç·å£²ä¸Š</span>
              <strong style="font-size: 20px; color: #4CAF50;">Â¥${settlementData.totalSales.toLocaleString()}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
              <span>å®¢æ•°</span>
              <strong>${settlementData.customerCount}çµ„</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
              <span>ç¾é‡‘</span>
              <strong>Â¥${settlementData.cashSales.toLocaleString()}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #ddd;">
              <span>ã‚«ãƒ¼ãƒ‰</span>
              <strong>Â¥${settlementData.creditSales.toLocaleString()}</strong>
            </div>
            <div style="display: flex; justify-content: space-between; padding: 10px 0;">
              <span>é›»å­ãƒãƒãƒ¼</span>
              <strong>Â¥${settlementData.emoneSales.toLocaleString()}</strong>
            </div>
          </div>
        `;
      } catch (e) {
        console.error('ç²¾ç®—ã‚µãƒãƒªãƒ¼ã‚¨ãƒ©ãƒ¼:', e);
        container.innerHTML = '<div style="text-align: center; color: red;">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    }
    
    // ç²¾ç®—ã‚’å®Ÿè¡Œï¼ˆCSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼‰
    window.confirmSettlement = async function() {
      // FirebaseåˆæœŸåŒ–ã‚’å¾…ã¤
      if (!window.firebaseReady) {
        await new Promise(resolve => {
          window.addEventListener('firebaseReady', resolve, { once: true });
        });
      }
      
      // ğŸ†• ã‚ªã‚·ãƒ£ãƒ¬ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
      const shouldBackup = await new Promise((resolve) => {
        // ãƒ¢ãƒ¼ãƒ€ãƒ«HTMLä½œæˆ
        const modal = document.createElement('div');
        modal.id = 'backupConfirmModal';
        modal.style.cssText = `
          position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
          background: rgba(0,0,0,0.7); display: flex; align-items: center; 
          justify-content: center; z-index: 999999; animation: fadeIn 0.2s;
        `;
        
        modal.innerHTML = `
          <div style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px; padding: 0; max-width: 500px; width: 90%;
            box-shadow: 0 25px 60px rgba(0,0,0,0.4); overflow: hidden;
            animation: slideUp 0.3s;
          ">
            <div style="background: white; padding: 32px; border-radius: 0 0 24px 24px;">
              <div style="text-align: center; margin-bottom: 24px;">
                <h3 style="font-size: 24px; font-weight: bold; color: #333; margin-bottom: 8px;">
                  ç²¾ç®—ã‚’å®Ÿè¡Œã™ã‚‹å‰ã«ã€ãƒ‡ãƒ¼ã‚¿ã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ
                </h3>
              </div>
              
              <div style="background: #f0f7ff; border-left: 4px solid #667eea; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="font-weight: bold; color: #667eea; margin-bottom: 12px; font-size: 16px;">ã€æ¨å¥¨: ã¯ã„ã€‘</div>
                <div style="color: #555; font-size: 14px; line-height: 1.8;">
                  ä»¥ä¸‹ãŒãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã•ã‚Œã¾ã™ï¼š<br>
                  â€¢ å•†å“<br>
                  â€¢ å¾“æ¥­å“¡<br>
                  â€¢ æ³¨æ–‡å±¥æ­´<br>
                  â€¢ å‹¤æ€ ãƒ‡ãƒ¼ã‚¿<br>
                  â€¢ å•†å“ã‚«ãƒ†ã‚´ãƒªè¨­å®š<br>
                  â€¢ ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®š<br>
                  â€¢ åœ¨åº«è¨­å®š<br>
                  â€¢ ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š<br>
                  â€¢ å–¶æ¥­æ™‚é–“è¨­å®š<br>
                  â€¢ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š<br><br>
                  èª¤ã£ã¦å‰Šé™¤ã—ãŸå ´åˆã«å¾©å…ƒã§ãã¾ã™ã€‚<br>
                  éå»7æ—¥åˆ†ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè‡ªå‹•ä¿æŒã•ã‚Œã¾ã™ã€‚
                </div>
              </div>
              
              <div style="background: #fff9e6; border-left: 4px solid #ff9800; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <div style="font-weight: bold; color: #ff9800; margin-bottom: 8px; font-size: 15px;">ã€ã„ã„ãˆã‚’é¸æŠã—ãŸå ´åˆã€‘</div>
                <div style="color: #666; font-size: 14px;">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãªã—ã§ç²¾ç®—ã‚’å®Ÿè¡Œã—ã¾ã™</div>
              </div>
              
              <div style="display: flex; gap: 12px;">
                <button id="backupNoBtn" style="
                  flex: 1; padding: 16px; font-size: 16px; font-weight: bold;
                  border: 2px solid #ddd; border-radius: 12px; cursor: pointer;
                  background: white; color: #666; transition: all 0.2s;
                " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='white'">
                  ã„ã„ãˆ
                </button>
                <button id="backupYesBtn" style="
                  flex: 1; padding: 16px; font-size: 16px; font-weight: bold;
                  border: none; border-radius: 12px; cursor: pointer;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  color: white; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
                  transition: all 0.2s;
                " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(102, 126, 234, 0.5)'" 
                   onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(102, 126, 234, 0.4)'">
                  ã¯ã„ï¼ˆæ¨å¥¨ï¼‰
                </button>
              </div>
            </div>
          </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('backupYesBtn').onclick = () => {
          modal.remove();
          resolve(true);
        };
        document.getElementById('backupNoBtn').onclick = () => {
          modal.remove();
          resolve(false);
        };
      });
      
      if (shouldBackup) {
        console.log('ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã™');
        const backupSuccess = await window.createAutoBackup();
        if (!backupSuccess) {
          const continueAnyway = confirm('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nãã‚Œã§ã‚‚ç²¾ç®—ã‚’ç¶šã‘ã¾ã™ã‹ï¼Ÿ');
          if (!continueAnyway) {
            return;
          }
        } else {
          console.log('âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆå®Œäº† - ç²¾ç®—ã‚’ç¶šè¡Œã—ã¾ã™');
        }
      } else {
        console.log('âš ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ç²¾ç®—ã‚’å®Ÿè¡Œã—ã¾ã™');
      }
      
      try {
        const settlementData = window.currentSettlementData;
        const dateStr = window.currentSettlementDate;
        
        if (!settlementData) {
          alert('ç²¾ç®—ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        console.log('ğŸ” ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆé–‹å§‹');
        console.log('ğŸ“Š settlementData:', settlementData);
        
        // ===== ç¾åœ¨æ™‚åˆ»ã‚’å–å¾— =====
        const now = new Date();
        const outputTime = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;
        
        // ===== æ‹…å½“è€…ã‚’å–å¾— =====
        const staffSelect = document.getElementById('staffSelect');
        const staffName = staffSelect.value || 'æœªé¸æŠ';
        
        // ===== dailySalesã‹ã‚‰åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— =====
        const customerCount = settlementData.customerCount || 0;
        const totalItems = settlementData.totalItems || 0;
        const totalSales = settlementData.totalSales || 0;
        const averageSpend = customerCount > 0 ? Math.round(totalSales / customerCount) : 0;
        
        // ===== å£²ä¸Šå†…è¨³ =====
        const cashSales = settlementData.cashSales || 0;
        const emoneSales = settlementData.emoneSales || 0;
        const creditSales = settlementData.creditSales || 0;
        const discountTotal = settlementData.totalDiscount || 0;
        
        // ===== ç¨é‡‘å†…è¨³ï¼ˆå†…ç¨ï¼‰ =====
        const tax8TotalWithTax = settlementData.tax8Total || 0;  // 8%å•†å“åˆè¨ˆï¼ˆç¨è¾¼ï¼‰
        const tax10TotalWithTax = settlementData.tax10Total || 0; // 10%å•†å“åˆè¨ˆï¼ˆç¨è¾¼ï¼‰
        
        // ç¨æŠœä¾¡æ ¼ã‚’è¨ˆç®—ï¼ˆå†…ç¨ãªã®ã§ç¨è¾¼ä¾¡æ ¼ã‹ã‚‰é€†ç®—ï¼‰
        const tax8Excluded = Math.floor(tax8TotalWithTax / 1.08);  // 8%å•†å“åˆè¨ˆï¼ˆç¨æŠœï¼‰
        const tax10Excluded = Math.floor(tax10TotalWithTax / 1.10); // 10%å•†å“åˆè¨ˆï¼ˆç¨æŠœï¼‰
        
        // æ¶ˆè²»ç¨é¡ã‚’è¨ˆç®—
        const tax8Amount = tax8TotalWithTax - tax8Excluded;  // 8%ã®æ¶ˆè²»ç¨
        const tax10Amount = tax10TotalWithTax - tax10Excluded; // 10%ã®æ¶ˆè²»ç¨
        
        // åˆè¨ˆ
        const totalTax = tax8Amount + tax10Amount;  // æ¶ˆè²»ç¨ã®åˆè¨ˆ
        const taxExcludedTotal = tax8Excluded + tax10Excluded;  // ç¨æŠœåˆè¨ˆ
        const taxIncludedTotal = tax8TotalWithTax + tax10TotalWithTax;  // ç¨è¾¼åˆè¨ˆï¼ˆ8%ã¨10%ã®åˆè¨ˆï¼‰
        
        // ğŸ†• å†…ç¨ãƒ»å¤–ç¨ã®å†…è¨³ã‚’æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é›†è¨ˆ
        let tax8InclusiveTotal = 0;
        let tax10InclusiveTotal = 0;
        let tax8ExclusiveTotal = 0;
        let tax10ExclusiveTotal = 0;
        let redSlipTax8Inclusive = 0;
        let redSlipTax10Inclusive = 0;
        let redSlipTax8Exclusive = 0;
        let redSlipTax10Exclusive = 0;
        
        try {
          const ordersQuery = window.query(
            window.getStoreCollection('orders'),
            window.where('paidAt', '!=', null)
          );
          const ordersSnapshot = await window.getDocs(ordersQuery);
          
          ordersSnapshot.forEach(doc => {
            const data = doc.data();
            if (!data.paidAt || !data.items) return;
            
            const orderDate = data.paidAt.toDate();
            let targetDate = new Date(orderDate);
            if (orderDate.getHours() < 3) {
              targetDate.setDate(targetDate.getDate() - 1);
            }
            
            const orderDateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-${String(targetDate.getDate()).padStart(2, '0')}`;
            
            if (orderDateStr === dateStr) {
              const isRedSlip = data.isRedSlip || false;
              
              data.items.forEach(item => {
                const taxType = item.taxType || 'inclusive';
                const taxAmount = getTaxAmount(item, item.quantity || 1);
                
                if ((item.taxRate || 10) === 8) {
                  if (taxType === 'exclusive') {
                    tax8ExclusiveTotal += taxAmount;
                    if (isRedSlip) redSlipTax8Exclusive += taxAmount;
                  } else {
                    tax8InclusiveTotal += taxAmount;
                    if (isRedSlip) redSlipTax8Inclusive += taxAmount;
                  }
                } else {
                  if (taxType === 'exclusive') {
                    tax10ExclusiveTotal += taxAmount;
                    if (isRedSlip) redSlipTax10Exclusive += taxAmount;
                  } else {
                    tax10InclusiveTotal += taxAmount;
                    if (isRedSlip) redSlipTax10Inclusive += taxAmount;
                  }
                }
              });
            }
          });
          
          console.log('ğŸ’° å†…ç¨ãƒ»å¤–ç¨ã®å†…è¨³:', {
            tax8Inclusive: tax8InclusiveTotal,
            tax8Exclusive: tax8ExclusiveTotal,
            tax10Inclusive: tax10InclusiveTotal,
            tax10Exclusive: tax10ExclusiveTotal
          });
        } catch (e) {
          console.error('å†…ç¨ãƒ»å¤–ç¨é›†è¨ˆã‚¨ãƒ©ãƒ¼:', e);
        }
        
        // ===== ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æ•° =====
        const drawerOpenCount = settlementData.drawerOpenCount || 0;
        console.log('ğŸ”“ ç²¾ç®—æ™‚ã®drawerOpenCount:', drawerOpenCount);
        console.log('ğŸ“Š settlementDataå…¨ä½“:', settlementData);
        
        // ===== ğŸ†• èµ¤ä¼ç¥¨æƒ…å ±ã‚’å–å¾— =====
        const redSlipCount = settlementData.redSlipCount || 0;
        const redSlipAmount = settlementData.redSlipAmount || 0;
        const redSlipTax8Total = settlementData.redSlipTax8Total || 0;
        const redSlipTax10Total = settlementData.redSlipTax10Total || 0;
        console.log('ğŸ”´ èµ¤ä¼ç¥¨ä»¶æ•°:', redSlipCount);
        console.log('ğŸ”´ èµ¤ä¼ç¥¨é‡‘é¡:', redSlipAmount);
        console.log('ğŸ”´ èµ¤ä¼ç¥¨8%ç¨é‡‘:', redSlipTax8Total);
        console.log('ğŸ”´ èµ¤ä¼ç¥¨10%ç¨é‡‘:', redSlipTax10Total);
        
        // ===== æ”¯å‡ºã‚’å–å¾— =====
        let expenseTotal = 0;
        try {
          const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
          if (expenseDoc.exists()) {
            expenseTotal = expenseDoc.data().total || 0;
            console.log('ğŸ’¸ æ”¯å‡º:', expenseTotal);
          }
        } catch (e) {
          console.error('æ”¯å‡ºå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        }
        
        // ===== äººä»¶è²»ã‚’å–å¾— =====
        let laborCost = 0;
        try {
          const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
          attendanceSnapshot.forEach(docData => {
            const data = docData.data();
            if (data.date === dateStr) {
              // æ—¢ã«è¨ˆç®—æ¸ˆã¿ã®ç·è³ƒé‡‘ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
              if (data.totalWage && data.totalWage > 0) {
                laborCost += data.totalWage;
              } else if (data.clockIn && data.clockOut) {
                // ç·è³ƒé‡‘ãŒãªã„å ´åˆã¯è¨ˆç®—ã™ã‚‹
                const clockIn = new Date(`${dateStr} ${data.clockIn}`);
                const clockOut = new Date(`${dateStr} ${data.clockOut}`);
                let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                
                // ä¼‘æ†©æ™‚é–“ã‚’å¼•ã
                if (data.breakStart1 && data.breakEnd1) {
                  const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                  const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                  workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                }
                if (data.breakStart2 && data.breakEnd2) {
                  const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                  const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                  workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                }
                
                const hourlyRate = data.hourlyRate || 1150;
                
                // å‰²å¢—è³ƒé‡‘ã®è¨ˆç®—
                let totalWage = 0;
                const isHoliday = data.isHoliday || false;
                
                // æ™‚é–“ã”ã¨ã«å‰²å¢—ç‡ã‚’è¨ˆç®—
                let currentTime = new Date(clockIn);
                const endTime = new Date(clockOut);
                
                while (currentTime < endTime) {
                  const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                  const segmentEnd = nextHour > endTime ? endTime : nextHour;
                  
                  // ä¼‘æ†©æ™‚é–“ã‚’é™¤å¤–
                  let isBreak = false;
                  if (data.breakStart1 && data.breakEnd1) {
                    const breakStart1 = new Date(`${dateStr} ${data.breakStart1}`);
                    const breakEnd1 = new Date(`${dateStr} ${data.breakEnd1}`);
                    if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                      isBreak = true;
                    }
                  }
                  if (data.breakStart2 && data.breakEnd2) {
                    const breakStart2 = new Date(`${dateStr} ${data.breakStart2}`);
                    const breakEnd2 = new Date(`${dateStr} ${data.breakEnd2}`);
                    if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                      isBreak = true;
                    }
                  }
                  
                  if (!isBreak) {
                    const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                    const hour = currentTime.getHours();
                    
                    let rate = 1.0;
                    if (isHoliday) {
                      // ä¼‘æ—¥å‡ºå‹¤: åŸºæœ¬35%å¢—
                      rate = 1.35;
                      // 22æ™‚ï½5æ™‚ã¯æ·±å¤œå‰²å¢—25%ã‚’è¿½åŠ ï¼ˆåˆè¨ˆ60%å¢—ï¼‰
                      if (hour >= 22 || hour < 5) {
                        rate = 1.60;
                      }
                    } else {
                      // å¹³æ—¥: 22æ™‚ï½5æ™‚ã¯æ·±å¤œå‰²å¢—25%
                      if (hour >= 22 || hour < 5) {
                        rate = 1.25;
                      }
                    }
                    
                    totalWage += segmentHours * hourlyRate * rate;
                  }
                  
                  currentTime = segmentEnd;
                }
                
                laborCost += totalWage;
              }
            }
          });
          console.log('ğŸ‘· äººä»¶è²»:', laborCost);
        } catch (e) {
          console.error('äººä»¶è²»å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        }
        
        // å€¤å¼•ããƒ»æ”¯å‡ºã‚’å¼•ã„ãŸæœ€çµ‚åˆè¨ˆå£²ä¸Š
        const finalTotalSales = taxIncludedTotal - discountTotal - expenseTotal;
        
        // ===== ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° =====
        console.log('ğŸ“… æ—¥ä»˜:', dateStr);
        console.log('ğŸ• å‡ºåŠ›æ™‚åˆ»:', outputTime);
        console.log('ğŸ‘¥ å®¢æ•°:', customerCount);
        console.log('ğŸ“¦ ç·å£²ä¸Šç‚¹æ•°:', totalItems);
        console.log('ğŸ’° å¹³å‡å®¢å˜ä¾¡:', averageSpend);
        console.log('ğŸ’µ åˆè¨ˆå£²ä¸Š:', totalSales);
        console.log('ğŸ’¸ å€¤å¼•ã:', discountTotal);
        console.log('ğŸª 8%å•†å“ï¼ˆç¨è¾¼ï¼‰:', tax8TotalWithTax);
        console.log('ğŸª 8%å•†å“ï¼ˆç¨æŠœï¼‰:', tax8Excluded);
        console.log('ğŸª 8%æ¶ˆè²»ç¨:', tax8Amount);
        console.log('ğŸª 10%å•†å“ï¼ˆç¨è¾¼ï¼‰:', tax10TotalWithTax);
        console.log('ğŸª 10%å•†å“ï¼ˆç¨æŠœï¼‰:', tax10Excluded);
        console.log('ğŸª 10%æ¶ˆè²»ç¨:', tax10Amount);
        console.log('ğŸ”“ ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æ•°:', drawerOpenCount);
        console.log('ğŸ‘¤ æ‹…å½“è€…:', staffName);
        
        // ===== ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ =====
        const journalText = `
=====================================
      ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«
=====================================
å‡ºåŠ›æ™‚åˆ»: ${outputTime}
å®¢æ•°: ${customerCount}çµ„
ç·å£²ä¸Šç‚¹æ•°: ${totalItems}ç‚¹
å¹³å‡å®¢å˜ä¾¡: Â¥${averageSpend.toLocaleString()}
åˆè¨ˆå£²ä¸Š: Â¥${totalSales.toLocaleString()}

-------------------------------------
å£²ä¸Šå†…è¨³
-------------------------------------
ç¾é‡‘: Â¥${cashSales.toLocaleString()}
é›»å­ãƒãƒãƒ¼: Â¥${emoneSales.toLocaleString()}
ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰: Â¥${creditSales.toLocaleString()}
å€¤å¼•ã: Â¥${discountTotal.toLocaleString()}

-------------------------------------
ç¨é‡‘å†…è¨³â€»èµ¤ä¼ç¥¨æ¸›ç®—å‰
-------------------------------------
8%ã®å•†å“åˆè¨ˆï¼ˆç¨æŠœï¼‰: Â¥${tax8Excluded.toLocaleString()}
8%ã®å•†å“åˆè¨ˆï¼ˆç¨è¾¼ï¼‰: Â¥${tax8TotalWithTax.toLocaleString()}
8%ã®æ¶ˆè²»ç¨: Â¥${tax8Amount.toLocaleString()}
  å†…ç¨: Â¥${tax8InclusiveTotal.toLocaleString()}
  å¤–ç¨: Â¥${tax8ExclusiveTotal.toLocaleString()}

10%ã®å•†å“åˆè¨ˆï¼ˆç¨æŠœï¼‰: Â¥${tax10Excluded.toLocaleString()}
10%ã®å•†å“åˆè¨ˆï¼ˆç¨è¾¼ï¼‰: Â¥${tax10TotalWithTax.toLocaleString()}
10%ã®æ¶ˆè²»ç¨: Â¥${tax10Amount.toLocaleString()}
  å†…ç¨: Â¥${tax10InclusiveTotal.toLocaleString()}
  å¤–ç¨: Â¥${tax10ExclusiveTotal.toLocaleString()}

æ¶ˆè²»ç¨ã®åˆè¨ˆ: Â¥${totalTax.toLocaleString()}
ç¨æŠœåˆè¨ˆ: Â¥${taxExcludedTotal.toLocaleString()}
ç¨è¾¼åˆè¨ˆ: Â¥${taxIncludedTotal.toLocaleString()}
${redSlipCount > 0 ? `
-------------------------------------
èµ¤ä¼ç¥¨ã®ç¨é‡‘å†…è¨³
-------------------------------------
8%ã®èµ¤ä¼ç¥¨ï¼ˆç¨æŠœï¼‰: -Â¥${Math.floor(redSlipTax8Total / 1.08).toLocaleString()}
8%ã®èµ¤ä¼ç¥¨ï¼ˆç¨è¾¼ï¼‰: -Â¥${redSlipTax8Total.toLocaleString()}
8%ã®èµ¤ä¼ç¥¨ã®æ¶ˆè²»ç¨: -Â¥${(redSlipTax8Total - Math.floor(redSlipTax8Total / 1.08)).toLocaleString()}
  å†…ç¨: -Â¥${redSlipTax8Inclusive.toLocaleString()}
  å¤–ç¨: -Â¥${redSlipTax8Exclusive.toLocaleString()}

10%ã®èµ¤ä¼ç¥¨ï¼ˆç¨æŠœï¼‰: -Â¥${Math.floor(redSlipTax10Total / 1.10).toLocaleString()}
10%ã®èµ¤ä¼ç¥¨ï¼ˆç¨è¾¼ï¼‰: -Â¥${redSlipTax10Total.toLocaleString()}
10%ã®èµ¤ä¼ç¥¨ã®æ¶ˆè²»ç¨: -Â¥${(redSlipTax10Total - Math.floor(redSlipTax10Total / 1.10)).toLocaleString()}
  å†…ç¨: -Â¥${redSlipTax10Inclusive.toLocaleString()}
  å¤–ç¨: -Â¥${redSlipTax10Exclusive.toLocaleString()}

èµ¤ä¼ç¥¨æ¶ˆè²»ç¨ã®åˆè¨ˆ: -Â¥${((redSlipTax8Total - Math.floor(redSlipTax8Total / 1.08)) + (redSlipTax10Total - Math.floor(redSlipTax10Total / 1.10))).toLocaleString()}
èµ¤ä¼ç¥¨ç¨æŠœåˆè¨ˆ: -Â¥${(Math.floor(redSlipTax8Total / 1.08) + Math.floor(redSlipTax10Total / 1.10)).toLocaleString()}
èµ¤ä¼ç¥¨ç¨è¾¼åˆè¨ˆ: -Â¥${(redSlipTax8Total + redSlipTax10Total).toLocaleString()}

-------------------------------------
ç¨é‡‘å†…è¨³ æ­£å¼è¨ˆç®—ï¼ˆèµ¤ä¼ç¥¨æ¸›ç®—å¾Œï¼‰
-------------------------------------
8%ã®å•†å“åˆè¨ˆï¼ˆç¨æŠœï¼‰: Â¥${Math.floor((tax8TotalWithTax - redSlipTax8Total) / 1.08).toLocaleString()}
8%ã®å•†å“åˆè¨ˆï¼ˆç¨è¾¼ï¼‰: Â¥${(tax8TotalWithTax - redSlipTax8Total).toLocaleString()}
8%ã®æ¶ˆè²»ç¨: Â¥${((tax8TotalWithTax - redSlipTax8Total) - Math.floor((tax8TotalWithTax - redSlipTax8Total) / 1.08)).toLocaleString()}
  å†…ç¨: Â¥${(tax8InclusiveTotal - redSlipTax8Inclusive).toLocaleString()}
  å¤–ç¨: Â¥${(tax8ExclusiveTotal - redSlipTax8Exclusive).toLocaleString()}

10%ã®å•†å“åˆè¨ˆï¼ˆç¨æŠœï¼‰: Â¥${Math.floor((tax10TotalWithTax - redSlipTax10Total) / 1.10).toLocaleString()}
10%ã®å•†å“åˆè¨ˆï¼ˆç¨è¾¼ï¼‰: Â¥${(tax10TotalWithTax - redSlipTax10Total).toLocaleString()}
10%ã®æ¶ˆè²»ç¨: Â¥${((tax10TotalWithTax - redSlipTax10Total) - Math.floor((tax10TotalWithTax - redSlipTax10Total) / 1.10)).toLocaleString()}
  å†…ç¨: Â¥${(tax10InclusiveTotal - redSlipTax10Inclusive).toLocaleString()}
  å¤–ç¨: Â¥${(tax10ExclusiveTotal - redSlipTax10Exclusive).toLocaleString()}

æ¶ˆè²»ç¨ã®åˆè¨ˆ: Â¥${(((tax8TotalWithTax - redSlipTax8Total) - Math.floor((tax8TotalWithTax - redSlipTax8Total) / 1.08)) + ((tax10TotalWithTax - redSlipTax10Total) - Math.floor((tax10TotalWithTax - redSlipTax10Total) / 1.10))).toLocaleString()}
ç¨æŠœåˆè¨ˆ: Â¥${(Math.floor((tax8TotalWithTax - redSlipTax8Total) / 1.08) + Math.floor((tax10TotalWithTax - redSlipTax10Total) / 1.10)).toLocaleString()}
ç¨è¾¼åˆè¨ˆ: Â¥${((tax8TotalWithTax - redSlipTax8Total) + (tax10TotalWithTax - redSlipTax10Total)).toLocaleString()}
` : ''}
æ”¯å‡º: Â¥${expenseTotal.toLocaleString()}
åˆè¨ˆå£²ä¸Š: Â¥${(redSlipCount > 0 ? ((tax8TotalWithTax - redSlipTax8Total) + (tax10TotalWithTax - redSlipTax10Total)) - expenseTotal : taxIncludedTotal - expenseTotal).toLocaleString()}

-------------------------------------
ãã®ä»–
-------------------------------------
ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æ•°: ${drawerOpenCount}å›
èµ¤ä¼ç¥¨ä»¶æ•°: ${redSlipCount}ä»¶
èµ¤ä¼ç¥¨é‡‘é¡: Â¥${redSlipAmount.toLocaleString()}
äººä»¶è²»: Â¥${Math.round(laborCost).toLocaleString()}
æ‹…å½“è€…: ${staffName}

=====================================
`;
        
        // ===== HTMLè¦ç´ ã‚’ä½œæˆã—ã¦PNGç”»åƒã¨ã—ã¦ä¿å­˜ =====
        const journalDiv = document.createElement('div');
        journalDiv.style.cssText = `
          font-family: 'Courier New', monospace;
          font-size: 14px;
          line-height: 1.6;
          padding: 30px;
          background: white;
          color: black;
          white-space: pre-wrap;
          width: 800px;
          position: absolute;
          left: -9999px;
        `;
        
        // HTMLã¨ã—ã¦ç”Ÿæˆã—ã€æ”¯å‡ºã¨åˆè¨ˆå£²ä¸Šã‚’èµ¤è‰²ã«ã™ã‚‹
        journalDiv.innerHTML = journalText
          .replace(/^(æ”¯å‡º: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>')
          .replace(/^(åˆè¨ˆå£²ä¸Š: .+)$/gm, '<span style="color: #d32f2f; font-weight: bold;">$1</span>')
          .replace(/^(ç¨é‡‘å†…è¨³ æ­£å¼è¨ˆç®—ï¼ˆèµ¤ä¼ç¥¨æ¸›ç®—å¾Œï¼‰)$/gm, '<span style="color: #1976d2; font-weight: bold;">$1</span>');
        
        document.body.appendChild(journalDiv);
        
        // html2canvasã§ç”»åƒåŒ–
        const canvas = await html2canvas(journalDiv, {
          scale: 2,
          backgroundColor: '#ffffff',
          logging: false
        });
        
        // PNGç”»åƒã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = `ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«_${dateStr}.png`;
          link.click();
          URL.revokeObjectURL(url);
          document.body.removeChild(journalDiv);
        });
        
        // ===== ç²¾ç®—è¨˜éŒ²ã‚’Firebaseã«ä¿å­˜ =====
        await window.addDoc(window.getStoreCollection('settlements'), {
          date: dateStr,
          outputTime: outputTime,
          timestamp: window.Timestamp.now(),
          customerCount: customerCount,
          totalItems: totalItems,
          averageSpend: averageSpend,
          totalSales: totalSales,
          cashSales: cashSales,
          emoneSales: emoneSales,
          creditSales: creditSales,
          discountTotal: discountTotal,
          tax8TotalWithTax: tax8TotalWithTax,
          tax8Excluded: tax8Excluded,
          tax8Amount: tax8Amount,
          tax10TotalWithTax: tax10TotalWithTax,
          tax10Excluded: tax10Excluded,
          tax10Amount: tax10Amount,
          totalTax: totalTax,
          taxExcludedTotal: taxExcludedTotal,
          taxIncludedTotal: taxIncludedTotal,
          drawerOpenCount: drawerOpenCount,
          redSlipCount: redSlipCount,  // ğŸ†• èµ¤ä¼ç¥¨ä»¶æ•°
          redSlipAmount: redSlipAmount,  // ğŸ†• èµ¤ä¼ç¥¨é‡‘é¡
          redSlipTax8Total: redSlipTax8Total,  // ğŸ†• èµ¤ä¼ç¥¨8%ç¨é‡‘
          redSlipTax10Total: redSlipTax10Total,  // ğŸ†• èµ¤ä¼ç¥¨10%ç¨é‡‘
          staffName: staffName,
          aiComment: ""
        });
        
        console.log('âœ… ç²¾ç®—ã‚¸ãƒ£ãƒ¼ãƒŠãƒ«ç”Ÿæˆå®Œäº†');
        closeSettlementModal();
        
      } catch (e) {
        console.error('âŒ ç²¾ç®—ã‚¨ãƒ©ãƒ¼:', e);
        alert('ç²¾ç®—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ç²¾ç®—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeSettlementModal = function() {
      document.getElementById('settlementModal').classList.add('hidden');
    };
    
    // ===== æ”¯å‡ºæ©Ÿèƒ½ =====
    let expenseRows = [];
    let currentExpenseDate = null;
    
    // æ”¯å‡ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.showExpenseModal = async function() {
      const now = new Date();
      const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
      
      // æœ¬æ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆåˆå‰3æ™‚åŸºæº–ï¼‰
      const todayStart = new Date(jstNow);
      todayStart.setHours(3, 0, 0, 0);
      if (jstNow.getHours() < 3) {
        todayStart.setDate(todayStart.getDate() - 1);
      }
      
      const year = todayStart.getFullYear();
      const month = String(todayStart.getMonth() + 1).padStart(2, '0');
      const day = String(todayStart.getDate()).padStart(2, '0');
      currentExpenseDate = `${year}-${month}-${day}`;
      
      // æ—¥ä»˜å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«æœ¬æ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
      document.getElementById('expenseDateInput').value = currentExpenseDate;
      
      console.log('ğŸ“… æ”¯å‡ºãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º - æœ¬æ—¥ã®æ—¥ä»˜:', currentExpenseDate);
      console.log('ğŸ“… ç¾åœ¨æ™‚åˆ»(JST):', jstNow.toLocaleString('ja-JP'));
      
      // Firebaseã‹ã‚‰æœ¬æ—¥ã®æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      await loadExpensesByDate();
      
      document.getElementById('expenseModal').classList.remove('hidden');
    };
    
    // æ—¥ä»˜å¤‰æ›´æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
    window.loadExpensesByDate = async function() {
      const selectedDate = document.getElementById('expenseDateInput').value;
      if (!selectedDate) {
        console.warn('âš ï¸ æ—¥ä»˜ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      
      currentExpenseDate = selectedDate;
      console.log('ğŸ“… æ—¥ä»˜å¤‰æ›´ - é¸æŠã•ã‚ŒãŸæ—¥ä»˜:', currentExpenseDate);
      
      try {
        const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', currentExpenseDate));
        
        if (expenseDoc.exists()) {
          const data = expenseDoc.data();
          expenseRows = data.items || [];
          console.log('âœ… æ—¢å­˜ã®æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿:', currentExpenseDate, 'ä»¶æ•°:', expenseRows.length);
          console.log('ğŸ“‹ ãƒ‡ãƒ¼ã‚¿å†…å®¹:', expenseRows);
        } else {
          // æ–°è¦ã®å ´åˆã¯åˆæœŸè¡Œã‚’è¿½åŠ 
          console.log('ğŸ“ æ–°è¦ä½œæˆ:', currentExpenseDate);
          expenseRows = [
            { storeName: '', category: '', detail: '', amount: 0 },
            { storeName: '', category: '', detail: '', amount: 0 },
            { storeName: '', category: '', detail: '', amount: 0 }
          ];
        }
      } catch (e) {
        console.error('âŒ æ”¯å‡ºãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        expenseRows = [
          { storeName: '', category: '', detail: '', amount: 0 },
          { storeName: '', category: '', detail: '', amount: 0 },
          { storeName: '', category: '', detail: '', amount: 0 }
        ];
      }
      
      renderExpenseTable();
    };
    
    // æ”¯å‡ºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeExpenseModal = function() {
      document.getElementById('expenseModal').classList.add('hidden');
    };
    
    // æ”¯å‡ºè¡Œã‚’è¿½åŠ 
    window.addExpenseRow = function() {
      expenseRows.push({
        storeName: '',
        category: '',
        detail: '',
        amount: 0
      });
      renderExpenseTable();
    };
    
    // æ”¯å‡ºè¡Œã‚’å‰Šé™¤
    window.deleteExpenseRow = function(index) {
      expenseRows.splice(index, 1);
      renderExpenseTable();
    };
    
    // æ”¯å‡ºãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æç”»
    // å‹˜å®šç§‘ç›®ã¨ç¨ç‡ã®ãƒãƒƒãƒ”ãƒ³ã‚°
    const categoryTaxRates = {
      'ææ–™è²»': 8,
      'é£Ÿè²»': 8,
      'æ¥å¾…äº¤éš›è²»': 8,
      'ç§Ÿç¨å…¬èª²': 8,
      'æ—¥ç”¨å“': 10,
      'é›‘è²»ãƒ»é›‘å“': 10,
      'æ°´å…‰ç†±è²»': 10,
      'äº¤é€šè²»10%': 10,
      'ãã®ä»–': 10
    };
    
    function renderExpenseTable() {
      const tbody = document.getElementById('expenseTableBody');
      tbody.innerHTML = '';
      
      expenseRows.forEach((row, index) => {
        const taxRate = categoryTaxRates[row.category] || 10;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding: 8px; border: 1px solid #ddd;">
            <input type="text" value="${row.storeName}" onchange="updateExpenseRow(${index}, 'storeName', this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <select onchange="updateExpenseRow(${index}, 'category', this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="ææ–™è²»" ${row.category === 'ææ–™è²»' ? 'selected' : ''}>ææ–™è²»ï¼ˆ8%ï¼‰</option>
              <option value="æ—¥ç”¨å“" ${row.category === 'æ—¥ç”¨å“' ? 'selected' : ''}>æ—¥ç”¨å“ï¼ˆ10%ï¼‰</option>
              <option value="é›‘è²»ãƒ»é›‘å“" ${row.category === 'é›‘è²»ãƒ»é›‘å“' ? 'selected' : ''}>é›‘è²»ãƒ»é›‘å“ï¼ˆ10%ï¼‰</option>
              <option value="é£Ÿè²»" ${row.category === 'é£Ÿè²»' ? 'selected' : ''}>é£Ÿè²»ï¼ˆ8%ï¼‰</option>
              <option value="æ¥å¾…äº¤éš›è²»" ${row.category === 'æ¥å¾…äº¤éš›è²»' ? 'selected' : ''}>æ¥å¾…äº¤éš›è²»ï¼ˆ8%ï¼‰</option>
              <option value="æ°´å…‰ç†±è²»" ${row.category === 'æ°´å…‰ç†±è²»' ? 'selected' : ''}>æ°´å…‰ç†±è²»ï¼ˆ10%ï¼‰</option>
              <option value="ç§Ÿç¨å…¬èª²" ${row.category === 'ç§Ÿç¨å…¬èª²' ? 'selected' : ''}>ç§Ÿç¨å…¬èª²</option>
              <option value="äº¤é€šè²»10%" ${row.category === 'äº¤é€šè²»10%' ? 'selected' : ''}>äº¤é€šè²»ï¼ˆ10%ï¼‰</option>
              <option value="ãã®ä»–" ${row.category === 'ãã®ä»–' ? 'selected' : ''}>ãã®ä»–ï¼ˆ10%ï¼‰</option>
            </select>
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <input type="text" value="${row.detail}" onchange="updateExpenseRow(${index}, 'detail', this.value)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 8px; border: 1px solid #ddd;">
            <input type="number" value="${row.amount}" onchange="updateExpenseRow(${index}, 'amount', parseFloat(this.value) || 0)" style="width: 100%; padding: 5px; border: 1px solid #ddd; border-radius: 4px;">
          </td>
          <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
            <button onclick="deleteExpenseRow(${index})" style="padding: 5px 10px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
      
      updateExpenseTotal();
    }
    
    // æ”¯å‡ºè¡Œã‚’æ›´æ–°
    window.updateExpenseRow = function(index, field, value) {
      expenseRows[index][field] = value;
      
      // ç§Ÿç¨å…¬èª²ã‚’é¸æŠã—ãŸå ´åˆã€è©³ç´°ã‚’ã€Œè»½æ²¹å¼•å–ç¨ã€ã«è¨­å®š
      if (field === 'category' && value === 'ç§Ÿç¨å…¬èª²') {
        expenseRows[index]['detail'] = 'è»½æ²¹å¼•å–ç¨';
      }
      
      updateExpenseTotal();
      renderExpenseTable(); // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å†æç”»
    };
    
    // æ”¯å‡ºåˆè¨ˆã‚’æ›´æ–°
    function updateExpenseTotal() {
      const total = expenseRows.reduce((sum, row) => sum + (parseFloat(row.amount) || 0), 0);
      document.getElementById('expenseTotal').textContent = total.toLocaleString();
    }
    
    // æ”¯å‡ºã‚’ä¿å­˜
    window.saveExpenses = async function() {
      try {
        console.log('ğŸ’¾ æ”¯å‡ºã‚’ä¿å­˜ä¸­ - æ—¥ä»˜:', currentExpenseDate);
        console.log('ğŸ’¾ ä¿å­˜ãƒ‡ãƒ¼ã‚¿:', expenseRows);
        
        // ç©ºè¡Œã‚’é™¤å¤–
        const validRows = expenseRows.filter(row => 
          row.storeName || row.category || row.detail || row.amount
        );
        
        const total = validRows.reduce((sum, row) => sum + (parseFloat(row.amount) || 0), 0);
        
        const currentStaff = document.getElementById('staffSelect')?.value || 'POSå…¥åŠ›';
        
        await window.setDoc(window.getStoreDoc('expenses', currentExpenseDate), {
          date: currentExpenseDate,
          staff: currentStaff,
          items: validRows,
          total: total,
          updatedAt: window.Timestamp.now()
        });
        
        console.log('âœ… æ”¯å‡ºä¿å­˜å®Œäº† - æ—¥ä»˜:', currentExpenseDate, 'ä»¶æ•°:', validRows.length, 'åˆè¨ˆ:', total);
        alert(`æ”¯å‡ºã‚’ä¿å­˜ã—ã¾ã—ãŸ\næ—¥ä»˜: ${currentExpenseDate}\nä»¶æ•°: ${validRows.length}ä»¶\nåˆè¨ˆ: Â¥${total.toLocaleString()}`);
        closeExpenseModal();
        
      } catch (e) {
        console.error('âŒ æ”¯å‡ºä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
        alert('æ”¯å‡ºã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // æ”¯å‡ºã‚’Excelå½¢å¼ã§å‡ºåŠ›ï¼ˆkeihi.htmlã¨åŒã˜å½¢å¼ï¼‰
    window.exportExpensesToCSV = async function() {
      try {
        console.log('ğŸ“„ æ”¯å‡ºExcelå‡ºåŠ›é–‹å§‹');
        
        if (expenseRows.length === 0) {
          alert('å‡ºåŠ›ã™ã‚‹æ”¯å‡ºãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
          return;
        }
        
        // å‹˜å®šç§‘ç›®ã¨ç¨ç‡ã®ãƒãƒƒãƒ”ãƒ³ã‚°
        const categoryTaxRates = {
          'ææ–™è²»': 8,
          'é£Ÿè²»': 8,
          'æ¥å¾…äº¤éš›è²»': 8,
          'ç§Ÿç¨å…¬èª²': 8,
          'æ—¥ç”¨å“': 10,
          'é›‘è²»ãƒ»é›‘å“': 10,
          'æ°´å…‰ç†±è²»': 10,
          'äº¤é€šè²»10%': 10,
          'ãã®ä»–': 10
        };
        
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        
        // Excelãƒ‡ãƒ¼ã‚¿ä½œæˆ
        const excelData = [];
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼
        excelData.push(['çµŒè²»æ˜ç´°æ›¸', '', '', '', '']);
        excelData.push([`${year}å¹´${month}æœˆ`, '', '', '', '']);
        excelData.push(['å‡ºåŠ›æ—¥æ™‚:', new Date().toLocaleString('ja-JP'), '', '', '']);
        excelData.push(['', '', '', '', '']);
        
        // 8%åŒºåˆ†
        excelData.push(['ã€8%åŒºåˆ†ã€‘', '', '', '', '']);
        excelData.push(['æ—¥ä»˜', 'åº—å', 'å‹˜å®šç§‘ç›®', 'è©³ç´°', 'é‡‘é¡']);
        
        const tax8Items = expenseRows.filter(e => 
          e.category === 'ææ–™è²»' || e.category === 'é£Ÿè²»' || e.category === 'æ¥å¾…äº¤éš›è²»'
        );
        let tax8Total = 0;
        
        tax8Items.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax8Total += item.amount;
        });
        
        excelData.push(['', '', '', '8%åˆè¨ˆ:', tax8Total]);
        excelData.push(['', '', '', '', '']);
        
        // 10%åŒºåˆ†
        excelData.push(['ã€10%åŒºåˆ†ã€‘', '', '', '', '']);
        excelData.push(['æ—¥ä»˜', 'åº—å', 'å‹˜å®šç§‘ç›®', 'è©³ç´°', 'é‡‘é¡']);
        
        const tax10Items = expenseRows.filter(e => 
          e.category === 'æ—¥ç”¨å“' || e.category === 'é›‘è²»ãƒ»é›‘å“' || 
          e.category === 'æ°´å…‰ç†±è²»' || e.category === 'ãã®ä»–'
        );
        let tax10Total = 0;
        
        tax10Items.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax10Total += item.amount;
        });
        
        excelData.push(['', '', '', '10%åˆè¨ˆ:', tax10Total]);
        excelData.push(['', '', '', '', '']);
        
        // ç§Ÿç¨å…¬èª²åŒºåˆ†
        excelData.push(['ã€ç§Ÿç¨å…¬èª²åŒºåˆ†ã€‘', '', '', '', '']);
        excelData.push(['æ—¥ä»˜', 'åº—å', 'å‹˜å®šç§‘ç›®', 'è©³ç´°', 'é‡‘é¡']);
        
        const sozeikokaItems = expenseRows.filter(e => e.category === 'ç§Ÿç¨å…¬èª²');
        let sozeikokaTotal = 0;
        
        sozeikokaItems.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          sozeikokaTotal += item.amount;
        });
        
        excelData.push(['', '', '', 'ç§Ÿç¨å…¬èª²åˆè¨ˆ:', sozeikokaTotal]);
        excelData.push(['', '', '', '', '']);
        
        // äº¤é€šè²»ï¼ˆ10%ï¼‰åŒºåˆ†
        excelData.push(['ã€äº¤é€šè²»ï¼ˆ10%ï¼‰åŒºåˆ†ã€‘', '', '', '', '']);
        excelData.push(['æ—¥ä»˜', 'åº—å', 'å‹˜å®šç§‘ç›®', 'è©³ç´°', 'é‡‘é¡']);
        
        const transport10Items = expenseRows.filter(e => e.category === 'äº¤é€šè²»10%');
        let transport10Total = 0;
        
        transport10Items.forEach(item => {
          excelData.push([
            currentExpenseDate,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          transport10Total += item.amount;
        });
        
        excelData.push(['', '', '', 'äº¤é€šè²»ï¼ˆ10%ï¼‰åˆè¨ˆ:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        
        // ç·åˆè¨ˆ
        const grandTotal = tax8Total + tax10Total + sozeikokaTotal + transport10Total;
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', '8%åˆè¨ˆé‡‘é¡:', tax8Total]);
        excelData.push(['', '', '', '10%åˆè¨ˆé‡‘é¡:', tax10Total]);
        excelData.push(['', '', '', 'ç§Ÿç¨å…¬èª²åˆè¨ˆé‡‘é¡:', sozeikokaTotal]);
        excelData.push(['', '', '', 'äº¤é€šè²»ï¼ˆ10%ï¼‰åˆè¨ˆé‡‘é¡:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', 'åˆè¨ˆ:', grandTotal]);
        
        // SheetJSã§Excelç”Ÿæˆ
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // åˆ—å¹…è¨­å®š
        ws['!cols'] = [
          { wch: 10 },  // æ—¥ä»˜
          { wch: 15 },  // åº—å
          { wch: 15 },  // å‹˜å®šç§‘ç›®
          { wch: 25 },  // è©³ç´°
          { wch: 12 }   // é‡‘é¡
        ];
        
        // ç½«ç·šã¨ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        for (let R = range.s.r; R <= range.e.r; R++) {
          for (let C = range.s.c; C <= range.e.c; C++) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            
            if (!ws[cellAddress]) {
              ws[cellAddress] = { t: 's', v: '' };
            }
            
            if (!ws[cellAddress].s) {
              ws[cellAddress].s = {};
            }
            
            // ç½«ç·š
            ws[cellAddress].s.border = {
              top: { style: 'thin', color: { rgb: '000000' } },
              bottom: { style: 'thin', color: { rgb: '000000' } },
              left: { style: 'thin', color: { rgb: '000000' } },
              right: { style: 'thin', color: { rgb: '000000' } }
            };
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«
            if (R === 0 || (excelData[R] && excelData[R][0] && excelData[R][0].includes('ã€'))) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'D3D3D3' }
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
            }
            
            // åˆè¨ˆè¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆ8%ã€10%ã€äº¤é€šè²»ã®å„åŒºåˆ†ï¼‰
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%åˆè¨ˆ:' || excelData[R][3] === '10%åˆè¨ˆ:' || 
                 excelData[R][3] === 'ç§Ÿç¨å…¬èª²åˆè¨ˆ:' || excelData[R][3] === 'äº¤é€šè²»ï¼ˆ10%ï¼‰åˆè¨ˆ:')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFE599' }  // è–„ã„é»„è‰²
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
              // é‡‘é¡åˆ—ã¯å³å¯„ã›
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // æœ€çµ‚åˆè¨ˆè¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆ8%åˆè¨ˆé‡‘é¡ã€10%åˆè¨ˆé‡‘é¡ã€äº¤é€šè²»åˆè¨ˆé‡‘é¡ã€åˆè¨ˆï¼‰
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%åˆè¨ˆé‡‘é¡:' || excelData[R][3] === '10%åˆè¨ˆé‡‘é¡:' || 
                 excelData[R][3] === 'ç§Ÿç¨å…¬èª²åˆè¨ˆé‡‘é¡:' || excelData[R][3] === 'äº¤é€šè²»ï¼ˆ10%ï¼‰åˆè¨ˆé‡‘é¡:' ||
                 excelData[R][3] === 'åˆè¨ˆ:')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFC7CE' }  // è–„ã„ãƒ”ãƒ³ã‚¯
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
              // é‡‘é¡åˆ—ã¯å³å¯„ã›
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // ã€Œåˆè¨ˆ:ã€è¡Œã¯ç‰¹ã«å¼·èª¿
            if (excelData[R] && excelData[R][3] === 'åˆè¨ˆ:') {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFB6C1' }  // æ¿ƒã„ãƒ”ãƒ³ã‚¯
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 14,
                color: { rgb: 'FF0000' }  // èµ¤æ–‡å­—
              };
            }
          }
        }
        
        XLSX.utils.book_append_sheet(wb, ws, 'çµŒè²»æ˜ç´°');
        
        const fileName = `çµŒè²»æ˜ç´°_${year}å¹´${month}æœˆ.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        console.log('âœ… çµŒè²»Excelå‡ºåŠ›å®Œäº†:', fileName);
        alert(`çµŒè²»ã‚’å‡ºåŠ›ã—ã¾ã—ãŸï¼\n${fileName}`);
        
      } catch (e) {
        console.error('âŒ çµŒè²»å‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', e);
        alert('çµŒè²»ã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ===== æœˆæ¬¡çµŒè²»å‡ºåŠ›æ©Ÿèƒ½ï¼ˆ1æ—¥ã‹ã‚‰ã®é›†è¨ˆï¼‰ =====
    window.exportMonthlyExpenses = async function(year = null, month = null) {
      try {
        console.log('ğŸ“Š æœˆæ¬¡çµŒè²»å‡ºåŠ›é–‹å§‹');
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®šï¼ˆå¼•æ•°ãŒãªã„å ´åˆã¯å½“æœˆï¼‰
        if (!year || !month) {
          const now = new Date();
          const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
          
          // ç¾åœ¨ã®å¹´æœˆã‚’å–å¾—ï¼ˆåˆå‰3æ™‚åŸºæº–ï¼‰
          const todayStart = new Date(jstNow);
          todayStart.setHours(3, 0, 0, 0);
          if (jstNow.getHours() < 3) {
            todayStart.setDate(todayStart.getDate() - 1);
          }
          
          year = todayStart.getFullYear();
          month = todayStart.getMonth() + 1;
        }
        
        console.log(`ğŸ“Š çµŒè²»å‡ºåŠ›: ${year}å¹´${month}æœˆ`);
        
        // æœˆã®å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const expensesSnapshot = await window.getDocs(window.getStoreCollection('expenses'));
        
        const monthlyExpenses = [];
        expensesSnapshot.forEach(doc => {
          const data = doc.data();
          const date = data.date;
          
          // ç¾åœ¨ã®æœˆã®ãƒ‡ãƒ¼ã‚¿ã®ã¿
          if (date && date.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
            if (data.items && Array.isArray(data.items)) {
              data.items.forEach(item => {
                monthlyExpenses.push({
                  date: date,
                  staff: data.staff || 'ä¸æ˜',
                  storeName: item.storeName,
                  category: item.category,
                  detail: item.detail,
                  amount: item.amount
                });
              });
            }
          }
        });
        
        // æ—¥ä»˜é †ã«ã‚½ãƒ¼ãƒˆ
        monthlyExpenses.sort((a, b) => a.date.localeCompare(b.date));
        
        console.log('å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:', monthlyExpenses.length, 'ä»¶');
        
        if (monthlyExpenses.length === 0) {
          alert('å‡ºåŠ›ã™ã‚‹çµŒè²»ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
          return;
        }
        
        // Excelãƒ‡ãƒ¼ã‚¿ä½œæˆ
        const excelData = [];
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼
        excelData.push(['çµŒè²»æ˜ç´°æ›¸', '', '', '', '', '']);
        excelData.push([`${year}å¹´${month}æœˆ`, '', '', '', '', '']);
        excelData.push(['å‡ºåŠ›æ—¥æ™‚:', new Date().toLocaleString('ja-JP'), '', '', '', '']);
        excelData.push(['', '', '', '', '', '']);
        
        // 8%åŒºåˆ†
        excelData.push(['ã€8%åŒºåˆ†ã€‘', '', '', '', '', '']);
        excelData.push(['æ—¥ä»˜', 'åº—å', 'å‹˜å®šç§‘ç›®', 'è©³ç´°', 'é‡‘é¡']);
        
        const tax8Items = monthlyExpenses.filter(e => 
          e.category === 'ææ–™è²»' || e.category === 'é£Ÿè²»' || e.category === 'æ¥å¾…äº¤éš›è²»'
        );
        let tax8Total = 0;
        
        tax8Items.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax8Total += item.amount;
        });
        
        excelData.push(['', '', '', '8%åˆè¨ˆ:', tax8Total]);
        excelData.push(['', '', '', '', '']);
        
        // 10%åŒºåˆ†
        excelData.push(['ã€10%åŒºåˆ†ã€‘', '', '', '', '', '']);
        excelData.push(['æ—¥ä»˜', 'åº—å', 'å‹˜å®šç§‘ç›®', 'è©³ç´°', 'é‡‘é¡']);
        
        const tax10Items = monthlyExpenses.filter(e => 
          e.category === 'æ—¥ç”¨å“' || e.category === 'é›‘è²»ãƒ»é›‘å“' || 
          e.category === 'æ°´å…‰ç†±è²»' || e.category === 'ãã®ä»–'
        );
        let tax10Total = 0;
        
        tax10Items.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          tax10Total += item.amount;
        });
        
        excelData.push(['', '', '', '10%åˆè¨ˆ:', tax10Total]);
        excelData.push(['', '', '', '', '']);
        
        // ç§Ÿç¨å…¬èª²åŒºåˆ†
        excelData.push(['ã€ç§Ÿç¨å…¬èª²åŒºåˆ†ã€‘', '', '', '', '', '']);
        excelData.push(['æ—¥ä»˜', 'åº—å', 'å‹˜å®šç§‘ç›®', 'è©³ç´°', 'é‡‘é¡']);
        
        const sozeikokaItems = monthlyExpenses.filter(e => e.category === 'ç§Ÿç¨å…¬èª²');
        let sozeikokaTotal = 0;
        
        sozeikokaItems.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          sozeikokaTotal += item.amount;
        });
        
        excelData.push(['', '', '', 'ç§Ÿç¨å…¬èª²åˆè¨ˆ:', sozeikokaTotal]);
        excelData.push(['', '', '', '', '']);
        
        // äº¤é€šè²»ï¼ˆ10%ï¼‰åŒºåˆ†
        excelData.push(['ã€äº¤é€šè²»ï¼ˆ10%ï¼‰åŒºåˆ†ã€‘', '', '', '', '', '']);
        excelData.push(['æ—¥ä»˜', 'åº—å', 'å‹˜å®šç§‘ç›®', 'è©³ç´°', 'é‡‘é¡']);
        
        const transport10Items = monthlyExpenses.filter(e => e.category === 'äº¤é€šè²»10%');
        let transport10Total = 0;
        
        transport10Items.forEach(item => {
          const dateStr = item.date.split('-').slice(1).join('/');
          excelData.push([
            dateStr,
            item.storeName,
            item.category,
            item.detail,
            item.amount
          ]);
          transport10Total += item.amount;
        });
        
        excelData.push(['', '', '', 'äº¤é€šè²»ï¼ˆ10%ï¼‰åˆè¨ˆ:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        
        // ç·åˆè¨ˆ
        const grandTotal = tax8Total + tax10Total + sozeikokaTotal + transport10Total;
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', '8%åˆè¨ˆé‡‘é¡:', tax8Total]);
        excelData.push(['', '', '', '10%åˆè¨ˆé‡‘é¡:', tax10Total]);
        excelData.push(['', '', '', 'ç§Ÿç¨å…¬èª²åˆè¨ˆé‡‘é¡:', sozeikokaTotal]);
        excelData.push(['', '', '', 'äº¤é€šè²»ï¼ˆ10%ï¼‰åˆè¨ˆé‡‘é¡:', transport10Total]);
        excelData.push(['', '', '', '', '']);
        excelData.push(['', '', '', 'åˆè¨ˆ:', grandTotal]);
        
        // SheetJSã§Excelç”Ÿæˆ
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // åˆ—å¹…è¨­å®š
        ws['!cols'] = [
          { wch: 10 },  // æ—¥ä»˜
          { wch: 15 },  // åº—å
          { wch: 15 },  // å‹˜å®šç§‘ç›®
          { wch: 25 },  // è©³ç´°
          { wch: 12 }   // é‡‘é¡
        ];
        
        // ç½«ç·šã¨ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        for (let R = range.s.r; R <= range.e.r; ++R) {
          for (let C = range.s.c; C <= range.e.c; ++C) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            
            if (!ws[cellAddress]) continue;
            
            // åŸºæœ¬ã®ç½«ç·š
            ws[cellAddress].s = ws[cellAddress].s || {};
            ws[cellAddress].s.border = {
              top: { style: 'thin', color: { rgb: '000000' } },
              bottom: { style: 'thin', color: { rgb: '000000' } },
              left: { style: 'thin', color: { rgb: '000000' } },
              right: { style: 'thin', color: { rgb: '000000' } }
            };
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«
            if (R === 0) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'ADD8E6' }  // è–„ã„é’
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 16
              };
            }
            
            // åŒºåˆ†ã‚¿ã‚¤ãƒˆãƒ«è¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆã€8%åŒºåˆ†ã€‘ãªã©ï¼‰
            if (excelData[R] && excelData[R][0] && excelData[R][0].startsWith('ã€')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFFF99' }  // è–„ã„é»„è‰²
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
            }
            
            // åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆæ—¥ä»˜ã€åº—åã€å‹˜å®šç§‘ç›®ã€è©³ç´°ã€é‡‘é¡ï¼‰
            if (excelData[R] && excelData[R][0] === 'æ—¥ä»˜') {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'D3D3D3' }  // ç°è‰²
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
            }
            
            // åˆè¨ˆè¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆ8%åˆè¨ˆã€10%åˆè¨ˆãªã©ï¼‰
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%åˆè¨ˆ:' || excelData[R][3] === '10%åˆè¨ˆ:' ||
                 excelData[R][3] === 'ç§Ÿç¨å…¬èª²åˆè¨ˆ:' || excelData[R][3] === 'äº¤é€šè²»ï¼ˆ10%ï¼‰åˆè¨ˆ:')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFE4B5' }  // è–„ã„ã‚ªãƒ¬ãƒ³ã‚¸
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
              // é‡‘é¡åˆ—ã¯å³å¯„ã›
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // æœ€çµ‚åˆè¨ˆè¡Œã®ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆ8%åˆè¨ˆé‡‘é¡ã€10%åˆè¨ˆé‡‘é¡ã€äº¤é€šè²»åˆè¨ˆé‡‘é¡ã€åˆè¨ˆï¼‰
            if (excelData[R] && excelData[R][3] && 
                (excelData[R][3] === '8%åˆè¨ˆé‡‘é¡:' || excelData[R][3] === '10%åˆè¨ˆé‡‘é¡:' || 
                 excelData[R][3] === 'ç§Ÿç¨å…¬èª²åˆè¨ˆé‡‘é¡:' || excelData[R][3] === 'äº¤é€šè²»ï¼ˆ10%ï¼‰åˆè¨ˆé‡‘é¡:' ||
                 excelData[R][3] === 'åˆè¨ˆ:')) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFC7CE' }  // è–„ã„ãƒ”ãƒ³ã‚¯
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 12
              };
              // é‡‘é¡åˆ—ã¯å³å¯„ã›
              if (C === 4) {
                ws[cellAddress].s.alignment = {
                  horizontal: 'right'
                };
              }
            }
            
            // ã€Œåˆè¨ˆ:ã€è¡Œã¯ç‰¹ã«å¼·èª¿
            if (excelData[R] && excelData[R][3] === 'åˆè¨ˆ:') {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFB6C1' }  // æ¿ƒã„ãƒ”ãƒ³ã‚¯
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 14,
                color: { rgb: 'FF0000' }  // èµ¤æ–‡å­—
              };
            }
          }
        }
        
        XLSX.utils.book_append_sheet(wb, ws, 'çµŒè²»æ˜ç´°');
        
        const fileName = `çµŒè²»æ˜ç´°_${year}å¹´${month}æœˆ_æœˆæ¬¡é›†è¨ˆ.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        console.log('âœ… æœˆæ¬¡çµŒè²»Excelå‡ºåŠ›å®Œäº†:', fileName);
        alert(`æœˆæ¬¡çµŒè²»ã‚’å‡ºåŠ›ã—ã¾ã—ãŸï¼\n${fileName}\n\né›†è¨ˆæœŸé–“: ${year}å¹´${month}æœˆ1æ—¥ã€œç¾åœ¨`);
        
      } catch (e) {
        console.error('âŒ æœˆæ¬¡çµŒè²»å‡ºåŠ›ã‚¨ãƒ©ãƒ¼:', e);
        alert('æœˆæ¬¡çµŒè²»ã®å‡ºåŠ›ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // çµŒè²»å‡ºåŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showExpenseExportModal = function() {
      // å¹´ã®é¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆ2020å¹´ã‹ã‚‰ç¾åœ¨ã®å¹´ã¾ã§ï¼‰
      const currentYear = new Date().getFullYear();
      const yearSelect = document.getElementById('expenseExportYear');
      yearSelect.innerHTML = '';
      
      for (let year = currentYear; year >= 2020; year--) {
        const option = document.createElement('option');
        option.value = year;
        option.textContent = year + 'å¹´';
        yearSelect.appendChild(option);
      }
      
      // ç¾åœ¨ã®æœˆã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
      const currentMonth = new Date().getMonth() + 1;
      document.getElementById('expenseExportMonth').value = currentMonth;
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      document.getElementById('expenseExportModal').style.display = 'flex';
    };
    
    // çµŒè²»å‡ºåŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeExpenseExportModal = function() {
      document.getElementById('expenseExportModal').style.display = 'none';
    };
    
    // çµŒè²»å‡ºåŠ›ã‚’å®Ÿè¡Œ
    window.confirmExpenseExport = async function() {
      const year = parseInt(document.getElementById('expenseExportYear').value);
      const month = parseInt(document.getElementById('expenseExportMonth').value);
      
      closeExpenseExportModal();
      await exportMonthlyExpenses(year, month);
    };
    
    // ===== æ—¥è¨ˆè¡¨ç”Ÿæˆæ©Ÿèƒ½ =====
    window.generateDailyReport = async function() {
      try {
        console.log('ğŸ“Š æ—¥è¨ˆè¡¨ç”Ÿæˆé–‹å§‹');
        
        // å½“æœˆã®å…¨ã¦ã®æ—¥æ¬¡å£²ä¸Šãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const now = new Date();
        const year = now.getFullYear();
        const month = now.getMonth() + 1;
        
        // æœˆã®æœ€åˆã®æ—¥ã¨æœ€å¾Œã®æ—¥ã‚’è¨ˆç®—
        const firstDay = new Date(year, month - 1, 1);
        const lastDay = new Date(year, month, 0);
        const daysInMonth = lastDay.getDate();
        
        console.log(`${year}å¹´${month}æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...`);
        
        // Firestoreã‹ã‚‰å½“æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const dailySalesSnapshot = await window.getDocs(window.getStoreCollection('dailySales'));
        
        // æ—¥ä»˜ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ•´ç†
        const salesByDate = {};
        dailySalesSnapshot.forEach(doc => {
          const data = doc.data();
          const date = data.date;
          
          // å½“æœˆã®ãƒ‡ãƒ¼ã‚¿ã®ã¿
          if (date && date.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
            salesByDate[date] = data;
          }
        });
        
        console.log('å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿:', salesByDate);
        
        // Excelãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
        const excelData = [];
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ1ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ï¼‰
        excelData.push(['', 'å£²ä¸Šæ—¥è¨ˆè¡¨', '', '', '', '', '', '', '', '', 'ç²‰ã‚‚ã‚“å±‹ å…«  ä¸‹èµ¤å¡šåº—', '', '', '']);
        excelData.push(['', '', '', '', '', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', `${year}-${String(month).padStart(2, '0')}-01`, '', '', '', '', '', '', '', '', '', '', '', '']);
        excelData.push(['', '', '', '', '', '', '', '', '', '', '', '', '', '']);
        
        // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ2ï¼ˆåˆ—åï¼‰
        excelData.push(['', 'æ—¥', 'æ›œæ—¥', 'ä¼ç¥¨æ•°', 'ç¾é‡‘', 'ã‚«ãƒ¼ãƒ‰', 'é›»å­ãƒãƒãƒ¼', 'å£²ä¸Šåˆè¨ˆ', 'äººä»¶è²»', 'äººä»¶è²»%', 'æ”¯æ‰•ã„', 'ç´”å£²ä¸Š', 'TOTALç²—åˆ©', 'å¤©æ°—']);
        
        // æ›œæ—¥é…åˆ—
        const weekDays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
        
        // ç´¯è¨ˆç²—åˆ©
        let totalGrossProfit = 0;
        
        // åˆè¨ˆç”¨ã®å¤‰æ•°
        let sumCustomerCount = 0;
        let sumCashSales = 0;
        let sumCreditSales = 0;
        let sumEmoneSales = 0;
        let sumTotalSales = 0;
        let sumLaborCost = 0;
        let sumPayment = 0;
        let sumNetSales = 0;
        
        // å„æ—¥ã®ãƒ‡ãƒ¼ã‚¿
        for (let day = 1; day <= daysInMonth; day++) {
          const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const date = new Date(year, month - 1, day);
          const weekDay = weekDays[date.getDay()];
          
          const data = salesByDate[dateStr];
          
          if (data) {
            // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
            const customerCount = data.customerCount || 0;
            const cashSales = data.cashSales || 0;
            const creditSales = data.creditSales || 0;
            const emoneSales = data.emoneSales || 0;
            const totalSales = cashSales + creditSales + emoneSales;
            
            // äººä»¶è²»ã‚’kintai_attendanceã‹ã‚‰å–å¾—
            let laborCost = 0;
            try {
              const attendanceSnapshot = await window.getDocs(window.getStoreCollection('attendance'));
              attendanceSnapshot.forEach(docData => {
                const attData = docData.data();
                if (attData.date === dateStr) {
                  // æ—¢ã«è¨ˆç®—æ¸ˆã¿ã®ç·è³ƒé‡‘ãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                  if (attData.totalWage && attData.totalWage > 0) {
                    laborCost += attData.totalWage;
                  } else if (attData.clockIn && attData.clockOut) {
                    // ç·è³ƒé‡‘ãŒãªã„å ´åˆã¯è¨ˆç®—ã™ã‚‹
                    const clockIn = new Date(`${dateStr} ${attData.clockIn}`);
                    const clockOut = new Date(`${dateStr} ${attData.clockOut}`);
                    let workHours = (clockOut - clockIn) / (1000 * 60 * 60);
                    
                    if (attData.breakStart1 && attData.breakEnd1) {
                      const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                      const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                      workHours -= (breakEnd1 - breakStart1) / (1000 * 60 * 60);
                    }
                    if (attData.breakStart2 && attData.breakEnd2) {
                      const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                      const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                      workHours -= (breakEnd2 - breakStart2) / (1000 * 60 * 60);
                    }
                    
                    const hourlyRate = attData.hourlyRate || 1150;
                    
                    // å‰²å¢—è³ƒé‡‘ã®è¨ˆç®—
                    let totalWage = 0;
                    const isHoliday = attData.isHoliday || false;
                    
                    // æ™‚é–“ã”ã¨ã«å‰²å¢—ç‡ã‚’è¨ˆç®—
                    let currentTime = new Date(clockIn);
                    const endTime = new Date(clockOut);
                    
                    while (currentTime < endTime) {
                      const nextHour = new Date(currentTime.getTime() + 60 * 60 * 1000);
                      const segmentEnd = nextHour > endTime ? endTime : nextHour;
                      
                      // ä¼‘æ†©æ™‚é–“ã‚’é™¤å¤–
                      let isBreak = false;
                      if (attData.breakStart1 && attData.breakEnd1) {
                        const breakStart1 = new Date(`${dateStr} ${attData.breakStart1}`);
                        const breakEnd1 = new Date(`${dateStr} ${attData.breakEnd1}`);
                        if (currentTime >= breakStart1 && currentTime < breakEnd1) {
                          isBreak = true;
                        }
                      }
                      if (attData.breakStart2 && attData.breakEnd2) {
                        const breakStart2 = new Date(`${dateStr} ${attData.breakStart2}`);
                        const breakEnd2 = new Date(`${dateStr} ${attData.breakEnd2}`);
                        if (currentTime >= breakStart2 && currentTime < breakEnd2) {
                          isBreak = true;
                        }
                      }
                      
                      if (!isBreak) {
                        const segmentHours = (segmentEnd - currentTime) / (1000 * 60 * 60);
                        const hour = currentTime.getHours();
                        
                        let rate = 1.0;
                        if (isHoliday) {
                          // ä¼‘æ—¥å‡ºå‹¤: åŸºæœ¬35%å¢—
                          rate = 1.35;
                          // 22æ™‚ï½5æ™‚ã¯æ·±å¤œå‰²å¢—25%ã‚’è¿½åŠ ï¼ˆåˆè¨ˆ60%å¢—ï¼‰
                          if (hour >= 22 || hour < 5) {
                            rate = 1.60;
                          }
                        } else {
                          // å¹³æ—¥: 22æ™‚ï½5æ™‚ã¯æ·±å¤œå‰²å¢—25%
                          if (hour >= 22 || hour < 5) {
                            rate = 1.25;
                          }
                        }
                        
                        totalWage += segmentHours * hourlyRate * rate;
                      }
                      
                      currentTime = segmentEnd;
                    }
                    
                    laborCost += totalWage;
                  }
                }
              });
            } catch (e) {
              console.error('äººä»¶è²»å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
            }
            
            const laborCostPercent = totalSales > 0 ? Math.round(laborCost / totalSales * 100) : 0;
            
            // æ”¯å‡ºã‚’expensesã‹ã‚‰å–å¾—
            let payment = 0;
            try {
              const expenseDoc = await window.getDoc(window.getStoreDoc('expenses', dateStr));
              if (expenseDoc.exists()) {
                payment = expenseDoc.data().total || 0;
              }
            } catch (e) {
              console.error('æ”¯å‡ºå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
            }
            
            // ç´”å£²ä¸Š
            const netSales = totalSales - laborCost - payment;
            
            // ç´¯è¨ˆç²—åˆ©
            totalGrossProfit += netSales;
            
            // åˆè¨ˆã«åŠ ç®—
            sumCustomerCount += customerCount;
            sumCashSales += cashSales;
            sumCreditSales += creditSales;
            sumEmoneSales += emoneSales;
            sumTotalSales += totalSales;
            sumLaborCost += laborCost;
            sumPayment += payment;
            sumNetSales += netSales;
            
            excelData.push([
              '',
              date,
              weekDay,
              customerCount,
              cashSales,
              creditSales,
              emoneSales,
              totalSales,
              Math.round(laborCost),
              laborCostPercent + '%',  // %è¨˜å·ã‚’ä»˜ã‘ã‚‹
              payment,
              Math.round(netSales),
              Math.round(totalGrossProfit),
              '' // å¤©æ°—ã¯æ‰‹å‹•å…¥åŠ›
            ]);
          } else {
            // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆï¼ˆç©ºè¡Œï¼‰
            excelData.push([
              '',
              date,
              weekDay,
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              '',
              ''
            ]);
          }
        }
        
        // åˆè¨ˆè¡Œã‚’è¿½åŠ 
        const avgLaborCostPercent = sumTotalSales > 0 ? Math.round(sumLaborCost / sumTotalSales * 100) : 0;
        excelData.push([
          '',
          '',
          'åˆè¨ˆ',
          sumCustomerCount,
          sumCashSales,
          sumCreditSales,
          sumEmoneSales,
          sumTotalSales,
          Math.round(sumLaborCost),
          avgLaborCostPercent + '%',
          sumPayment,
          Math.round(sumNetSales),
          '', // TOTALç²—åˆ©ã¯æœ€å¾Œã®è¡Œã®å€¤
          ''
        ]);
        
        console.log('Excelãƒ‡ãƒ¼ã‚¿ä½œæˆå®Œäº†:', excelData.length, 'è¡Œ');
        
        // SheetJSã§Excelãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(excelData);
        
        // åˆ—å¹…ã‚’è¨­å®š
        ws['!cols'] = [
          { wch: 3 },  // Aåˆ—
          { wch: 12 }, // Båˆ—ï¼ˆæ—¥ä»˜ï¼‰
          { wch: 5 },  // Cåˆ—ï¼ˆæ›œæ—¥ï¼‰
          { wch: 8 },  // Dåˆ—ï¼ˆä¼ç¥¨æ•°ï¼‰
          { wch: 10 }, // Eåˆ—ï¼ˆç¾é‡‘ï¼‰
          { wch: 10 }, // Fåˆ—ï¼ˆã‚«ãƒ¼ãƒ‰ï¼‰
          { wch: 10 }, // Gåˆ—ï¼ˆpaypayï¼‰
          { wch: 10 }, // Håˆ—ï¼ˆå£²ä¸Šåˆè¨ˆï¼‰
          { wch: 10 }, // Iåˆ—ï¼ˆäººä»¶è²»ï¼‰
          { wch: 10 }, // Jåˆ—ï¼ˆäººä»¶è²»%ï¼‰
          { wch: 10 }, // Kåˆ—ï¼ˆæ”¯æ‰•ã„ï¼‰
          { wch: 10 }, // Låˆ—ï¼ˆç´”å£²ä¸Šï¼‰
          { wch: 12 }, // Måˆ—ï¼ˆTOTALç²—åˆ©ï¼‰
          { wch: 10 }  // Nåˆ—ï¼ˆå¤©æ°—ï¼‰
        ];
        
        // ğŸ†• å…¨ã‚»ãƒ«ã«ç½«ç·šã¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        for (let R = range.s.r; R <= range.e.r; R++) {
          for (let C = range.s.c; C <= range.e.c; C++) {
            const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
            
            // ã‚»ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
            if (!ws[cellAddress]) {
              ws[cellAddress] = { t: 's', v: '' };
            }
            
            // ã‚¹ã‚¿ã‚¤ãƒ«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’åˆæœŸåŒ–
            if (!ws[cellAddress].s) {
              ws[cellAddress].s = {};
            }
            
            // ç½«ç·šã‚’è¨­å®š
            ws[cellAddress].s.border = {
              top: { style: 'thin', color: { rgb: '000000' } },
              bottom: { style: 'thin', color: { rgb: '000000' } },
              left: { style: 'thin', color: { rgb: '000000' } },
              right: { style: 'thin', color: { rgb: '000000' } }
            };
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆ5è¡Œç›® = R=4ï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ«
            if (R === 4) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'D3D3D3' }
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
              ws[cellAddress].s.alignment = {
                horizontal: 'center',
                vertical: 'center'
              };
            }
            
            // åˆè¨ˆè¡Œï¼ˆæœ€çµ‚è¡Œï¼‰ã®ã‚¹ã‚¿ã‚¤ãƒ«
            if (R === range.e.r) {
              ws[cellAddress].s.fill = {
                patternType: 'solid',
                fgColor: { rgb: 'FFFFCC' }
              };
              ws[cellAddress].s.font = {
                bold: true,
                sz: 11
              };
            }
            
            // æ•°å€¤ã‚»ãƒ«ã®å³å¯„ã›
            if (C >= 3 && C <= 12 && R >= 5) {
              if (!ws[cellAddress].s.alignment) {
                ws[cellAddress].s.alignment = {};
              }
              ws[cellAddress].s.alignment.horizontal = 'right';
            }
          }
        }
        
        XLSX.utils.book_append_sheet(wb, ws, 'å£²ä¸Šæ—¥è¨ˆè¡¨');
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        const fileName = `æ—¥è¨ˆè¡¨${year}å¹´${month}æœˆ.xlsx`;
        XLSX.writeFile(wb, fileName);
        
        console.log('âœ… æ—¥è¨ˆè¡¨å‡ºåŠ›å®Œäº†:', fileName);
        alert(`æ—¥è¨ˆè¡¨ã‚’å‡ºåŠ›ã—ã¾ã—ãŸï¼\n${fileName}`);
        
      } catch (e) {
        console.error('âŒ æ—¥è¨ˆè¡¨ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', e);
        alert('æ—¥è¨ˆè¡¨ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // æ‰‹å‹•ã‚«ãƒ¼ãƒˆã®è¡¨ç¤ºæ›´æ–°
    // iframeã‹ã‚‰å•†å“ã‚’è¿½åŠ ã™ã‚‹é–¢æ•°
    window.addItemFromIframe = function(item) {
      console.log('ğŸ›’ iframeã‹ã‚‰å•†å“è¿½åŠ :', item);
      console.log('ğŸ“Š å—ã‘å–ã£ãŸæ•°é‡:', item.quantity);
      
      // å•†å“ã®taxRateã¨foodTypeã‚’å–å¾—
      let taxRate = item.taxRate;
      let foodType = item.foodType || 'food';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯é£Ÿæ
      
      // åŒ…æã‚«ãƒ†ã‚´ãƒªã®å•†å“ã¯å¼·åˆ¶çš„ã«10%ã€é£Ÿæä»¥å¤–ã«è¨­å®š
      if (item.category === 'åŒ…æ') {
        taxRate = 10;
        foodType = 'non-food';
        console.log('ğŸ“¦ åŒ…æã‚«ãƒ†ã‚´ãƒª: ç¨ç‡ã‚’10%ã€é£Ÿæä»¥å¤–ã«å¼·åˆ¶è¨­å®š');
      }
      
      // taxRateãŒæœªè¨­å®šã®å ´åˆã€foodTypeã«åŸºã¥ã„ã¦è¨­å®š
      if (taxRate === undefined || taxRate === null) {
        // é£Ÿæä»¥å¤–ã¯10%ã€é£Ÿæã¯8%ï¼ˆãŸã ã—å³ä¼šè¨ˆã§ã¯å•†å“ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡ã‚’ä½¿ã†ã¹ãï¼‰
        // ã“ã“ã§ã¯å•†å“ãƒ‡ãƒ¼ã‚¿ã«ç¨ç‡ãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        taxRate = (foodType === 'non-food') ? 10 : 8;
        console.log(`âš ï¸ taxRateæœªè¨­å®š â†’ foodType(${foodType})ã«åŸºã¥ã${taxRate}%ã‚’è¨­å®š`);
      }
      
      // ğŸ†• taxTypeã®è‡ªå‹•åˆ¤å®š: menu.htmlã‹ã‚‰æ¸¡ã•ã‚Œãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨­å®š
      // ã‚‚ã—item.priceIncludeTaxãŒtrueãªã‚‰å†…ç¨ã€falseãªã‚‰å¤–ç¨
      let taxType = item.taxType;
      if (!taxType) {
        // taxTypeãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€priceIncludeTaxãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§åˆ¤å®š
        if (item.priceIncludeTax === false) {
          taxType = 'exclusive';  // å¤–ç¨
          console.log('ğŸ†• å¤–ç¨ã¨åˆ¤å®š: priceIncludeTax =', item.priceIncludeTax);
        } else {
          taxType = 'inclusive';  // å†…ç¨ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
          console.log('ğŸ†• å†…ç¨ã¨åˆ¤å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰');
        }
      }
      
      // manualCartã«å•†å“ã‚’è¿½åŠ 
      const cartItem = {
        id: item.id,
        name: item.name,
        price: item.price,
        category: item.category,  // ã‚«ãƒ†ã‚´ãƒªã‚’ä¿å­˜
        taxRate: taxRate,  // ç¢ºå®Ÿã«è¨­å®šæ¸ˆã¿
        foodType: foodType,  // ğŸ†• é£ŸæåŒºåˆ†ã‚’ä¿å­˜
        taxType: taxType,  // ğŸ†• å¤–ç¨/å†…ç¨ã‚¿ã‚¤ãƒ—
        toppings: item.toppings || 'æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°',
        toppingPrice: item.toppingPrice || 0,
        toppingsData: item.toppingsData || [],
        quantity: item.quantity || 1  // âœ… iframeã‹ã‚‰æ¸¡ã•ã‚ŒãŸæ•°é‡ã‚’ä½¿ç”¨
      };
      
      console.log('âœ… ã‚«ãƒ¼ãƒˆã‚¢ã‚¤ãƒ†ãƒ ä½œæˆå®Œäº†:', cartItem);
      console.log('ğŸ“Š è¨­å®šã•ã‚ŒãŸæ•°é‡:', cartItem.quantity);
      
      // åŒã˜å•†å“ãŒæ—¢ã«ã‚ã‚‹å ´åˆã¯æ•°é‡ã‚’å¢—ã‚„ã™
      const existingIndex = manualCart.findIndex(i => 
        i.id === item.id && 
        i.toppings === cartItem.toppings
      );
      
      if (existingIndex >= 0) {
        console.log('ğŸ”„ æ—¢å­˜å•†å“ã‚’ç™ºè¦‹:', manualCart[existingIndex]);
        console.log('ğŸ“Š æ—¢å­˜ã®æ•°é‡:', manualCart[existingIndex].quantity);
        console.log('ğŸ“Š è¿½åŠ ã™ã‚‹æ•°é‡:', cartItem.quantity);
        manualCart[existingIndex].quantity += cartItem.quantity;  // âœ… æ¸¡ã•ã‚ŒãŸæ•°é‡åˆ†å¢—ã‚„ã™
        console.log('âœ… æ—¢å­˜å•†å“ã®æ•°é‡ã‚’å¢—ã‚„ã—ã¾ã—ãŸ:', manualCart[existingIndex]);
        console.log('ğŸ“Š æ–°ã—ã„æ•°é‡:', manualCart[existingIndex].quantity);
      } else {
        manualCart.push(cartItem);
        console.log('âœ… æ–°è¦å•†å“ã‚’è¿½åŠ ã—ã¾ã—ãŸ:', cartItem);
        console.log('ğŸ“Š è¿½åŠ å¾Œã®ã‚«ãƒ¼ãƒˆ:', manualCart);
      }
      
      updateManualCart();
    };
    
    function updateManualCart() {
      const container = document.getElementById('selectedItems');
      const submitBtn = document.getElementById('manualSubmitBtn');
      const directPaymentBtn = document.getElementById('directPaymentBtn');  // âœ… å³ä¼šè¨ˆãƒœã‚¿ãƒ³
      const manualTable = document.getElementById('manualTable');
      
      if (manualCart.length === 0) {
        container.innerHTML = '<div class="empty-state">å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
        submitBtn.disabled = true;
        if (directPaymentBtn) directPaymentBtn.disabled = true;  // âœ…
        document.getElementById('manualTotal').textContent = 'Â¥0';
        return;
      }
      
      container.innerHTML = '';
      let total = 0;
      
      manualCart.forEach((item, index) => {
        // ğŸ†• å¤–ç¨ã®å ´åˆã¯ç¨è¾¼ä¾¡æ ¼ã‚’è¨ˆç®—
        let itemBasePrice = item.price;
        if (item.taxType === 'exclusive') {
          const taxRate = item.taxRate || 10;
          itemBasePrice = Math.floor(item.price * (1 + taxRate / 100));
        }
        
        const itemWithTopping = itemBasePrice + (item.toppingPrice || 0);
        const itemTotal = itemWithTopping * item.quantity;
        total += itemTotal;
        
        // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’æ”¹è¡Œã§è¡¨ç¤º
        let toppingsHtml = '';
        if (item.toppingDetails && item.toppingDetails.length > 0) {
          // POSç”»é¢ã‹ã‚‰ã®æ–°è¦æ³¨æ–‡
          const groupedBySet = {};
          item.toppingDetails.forEach(detail => {
            if (!groupedBySet[detail.setName]) {
              groupedBySet[detail.setName] = [];
            }
            groupedBySet[detail.setName].push(detail.optionName);
          });
          
          toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
            return `
              <div style="font-size: 12px; color: #666; font-weight: bold; margin-top: 3px; padding-left: 5px;">${setName}</div>
              ${options.map(opt => `<div style="font-size: 12px; color: #666; padding-left: 15px;">ã€€ãƒ»${opt}</div>`).join('')}
            `;
          }).join('');
        } else if (item.toppingsData && item.toppingsData.length > 0) {
          // ğŸ†• menu.htmlã‹ã‚‰ã®æ³¨æ–‡
          const groupedBySet = {};
          item.toppingsData.forEach(topping => {
            const setName = topping.setName || 'ãƒˆãƒƒãƒ”ãƒ³ã‚°';
            if (!groupedBySet[setName]) {
              groupedBySet[setName] = [];
            }
            groupedBySet[setName].push(topping.name);
          });
          
          toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
            return `
              <div style="font-size: 12px; color: #666; font-weight: bold; margin-top: 3px; padding-left: 5px;">${setName}</div>
              ${options.map(opt => `<div style="font-size: 12px; color: #666; padding-left: 15px;">ã€€ãƒ»${opt}</div>`).join('')}
            `;
          }).join('');
        } else if (item.toppings && item.toppings !== 'ãªã—' && item.toppings !== 'æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°') {
          // å¤ã„å½¢å¼
          const toppingList = item.toppings.split(', ');
          toppingsHtml = toppingList.map(t => `<div style="font-size: 12px; color: #666; padding-left: 10px;">ã€€${t}</div>`).join('');
        }
        
        const div = document.createElement('div');
        div.className = 'selected-item-detailed';
        div.innerHTML = `
          <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
            <div style="font-weight: bold;">${item.name} Ã—${item.quantity}</div>
            <div>Â¥${itemBasePrice.toLocaleString()}</div>
          </div>
          ${toppingsHtml}
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px; padding-top: 5px; border-top: 1px dashed #ddd;">
            <div style="display: flex; gap: 5px;">
              <input type="number" class="quantity-input" min="1" value="${item.quantity}" 
                     onchange="updateQuantity(${index}, this.value)">
              <button class="remove-btn" onclick="removeFromManualCart(${index})">å‰Šé™¤</button>
            </div>
            <div style="font-weight: bold; color: #667eea;">Â¥${itemWithTopping.toLocaleString()} Ã— ${item.quantity} = Â¥${itemTotal.toLocaleString()}</div>
          </div>
        `;
        container.appendChild(div);
      });
      
      document.getElementById('manualTotal').textContent = `Â¥${total.toLocaleString()}`;
      // âœ… å•†å“ãŒã‚ã‚Œã°ãƒœã‚¿ãƒ³æœ‰åŠ¹ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã¯å¾Œã§é¸æŠå¯èƒ½ï¼‰
      submitBtn.disabled = manualCart.length === 0;
      
      // âœ… å³ä¼šè¨ˆãƒœã‚¿ãƒ³ã¯ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠä¸è¦ãªã®ã§ã€ã‚«ãƒ¼ãƒˆã«å•†å“ãŒã‚ã‚Œã°æœ‰åŠ¹
      if (directPaymentBtn) {
        directPaymentBtn.disabled = manualCart.length === 0;
      }
    }
    
    // ã‚«ãƒ¼ãƒˆå†…ã‚¢ã‚¤ãƒ†ãƒ ã‚’ä¿®æ­£
    window.editCartItem = function(index) {
      const item = manualCart[index];
      
      // ç¾åœ¨ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°æƒ…å ±ã‚’ä¿æŒ
      currentSelectingItem = { ...item };
      currentSelectingItem.editIndex = index;
      
      // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’å¾©å…ƒ
      selectedToppings = [];
      if (item.toppings && item.toppings !== 'ãªã—') {
        const toppingNames = item.toppings.split(', ');
        toppingNames.forEach(name => {
          const topping = toppingsData.find(t => t.name === name);
          if (topping) {
            selectedToppings.push(topping);
          }
        });
      }
      
      // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      showToppingModalForEdit(item, index);
    };
    
    // ä¿®æ­£ç”¨ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆå…ƒã®é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ï¼‰
    function showToppingModalForEdit(item, index) {
      document.getElementById('toppingModalItemName').textContent = item.name + ' (ä¿®æ­£)';
      const list = document.getElementById('toppingsList');
      list.innerHTML = '';
      
      // toppingsIdã‹ã‚‰ãƒˆãƒƒãƒ”ãƒ³ã‚°IDã®ãƒªã‚¹ãƒˆã‚’å–å¾—
      let allowedToppingIds = [];
      if (item.toppingsId && typeof item.toppingsId === 'string' && item.toppingsId.trim() !== '') {
        allowedToppingIds = item.toppingsId.split(',').map(id => id.trim());
      }
      
      console.log('ä¿®æ­£ãƒ¢ãƒ¼ãƒ€ãƒ« - allowedToppingIds:', allowedToppingIds);
      console.log('ä¿®æ­£ãƒ¢ãƒ¼ãƒ€ãƒ« - toppingsDataä»¶æ•°:', toppingsData.length);
      
      // toppingsIdãŒç©ºã®å ´åˆã¯ã€ãƒˆãƒƒãƒ”ãƒ³ã‚°ãªã—å•†å“ã¨ã—ã¦æ‰±ã†
      if (allowedToppingIds.length === 0) {
        list.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;">ã“ã®å•†å“ã«ã¯ãƒˆãƒƒãƒ”ãƒ³ã‚°ãŒã‚ã‚Šã¾ã›ã‚“<br><small>å•†å“ç®¡ç†ç”»é¢ã§ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’è¨­å®šã—ã¦ãã ã•ã„</small></div>';
        document.getElementById('toppingModal').classList.remove('hidden');
        return;
      }
      
      // ã€Œãªã—ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³
      const noneDiv = document.createElement('div');
      noneDiv.className = 'topping-item';
      noneDiv.style.cursor = 'pointer';
      noneDiv.innerHTML = `
        <input type="checkbox" id="topping-none" style="pointer-events: none;">
        <div class="topping-item-info">
          <span class="topping-item-name">æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°</span>
          <span class="topping-item-price">Â¥0</span>
        </div>
      `;
      
      noneDiv.onclick = () => {
        const checkbox = document.getElementById('topping-none');
        checkbox.checked = !checkbox.checked;
        selectNoneTopping(checkbox);
      };
      
      list.appendChild(noneDiv);
      
      toppingsData.forEach(topping => {
        // allowedToppingIdsã«å«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿è¡¨ç¤º
        if (allowedToppingIds.includes(topping.id)) {
          const isSelected = selectedToppings.some(t => t.id === topping.id);
          const div = document.createElement('div');
          div.className = 'topping-item';
          div.style.cursor = 'pointer';
          div.innerHTML = `
            <input type="checkbox" id="topping-${topping.id}" value="${topping.id}" 
                   style="pointer-events: none;" ${isSelected ? 'checked' : ''}>
            <div class="topping-item-info">
              <span class="topping-item-name">${topping.name}</span>
              <span class="topping-item-price">+Â¥${topping.price.toLocaleString()}</span>
            </div>
          `;
          
          div.onclick = () => {
            const checkbox = document.getElementById(`topping-${topping.id}`);
            checkbox.checked = !checkbox.checked;
            selectTopping(checkbox);
          };
          
          list.appendChild(div);
        }
      });
      
      // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€Œãªã—ã€ã‚’é¸æŠ
      if (selectedToppings.length === 0) {
        document.getElementById('topping-none').checked = true;
      }
      
      document.getElementById('toppingModal').classList.remove('hidden');
    }
    
    // æ•°é‡æ›´æ–°
    window.updateQuantity = function(index, value) {
      const qty = parseInt(value) || 1;
      manualCart[index].quantity = Math.max(1, qty);
      updateManualCart();
    };
    
    // ã‚«ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤
    window.removeFromManualCart = function(index) {
      const item = manualCart[index];
      const checkbox = document.getElementById(`menu-${item.id}`);
      if (checkbox) checkbox.checked = false;
      
      manualCart.splice(index, 1);
      updateManualCart();
    };
    
    // âœ… å³ä¼šè¨ˆé–¢æ•°ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠä¸è¦ã€Firebaseã«ä¿å­˜ã—ãªã„ï¼‰
    window.directPayment = async function() {
      console.log('ğŸ”” å³ä¼šè¨ˆãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
      console.log('  ã‚«ãƒ¼ãƒˆå†…å®¹:', manualCart);
      console.log('  ã‚«ãƒ¼ãƒˆæ•°:', manualCart.length);
      
      const btn = document.getElementById('directPaymentBtn');
      console.log('  ãƒœã‚¿ãƒ³è¦ç´ :', btn);
      console.log('  ãƒœã‚¿ãƒ³disabledå±æ€§:', btn ? btn.disabled : 'ãƒœã‚¿ãƒ³ãªã—');
      console.log('  ãƒœã‚¿ãƒ³pointerEvents:', btn ? btn.style.pointerEvents : 'ãƒœã‚¿ãƒ³ãªã—');
      
      if (btn && btn.disabled) {
        console.warn('âš ï¸ å³ä¼šè¨ˆãƒœã‚¿ãƒ³ãŒç„¡åŠ¹çŠ¶æ…‹ã§ã™');
        alert('ã‚«ãƒ¼ãƒˆã«å•†å“ã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (manualCart.length === 0) {
        alert('å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      // å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–
      isDirectPaymentMode = true;
      console.log('ğŸ’³ å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰: ON');
      
      try {
        console.log('ğŸ’³ å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰èµ·å‹•');
        console.log('ã‚«ãƒ¼ãƒˆå†…å®¹:', manualCart);
        
        // ã‚«ãƒ¼ãƒˆã®åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—ï¼ˆğŸ†• å¤–ç¨å¯¾å¿œï¼‰
        let totalAmount = 0;
        manualCart.forEach(item => {
          let itemPrice = item.price;
          // ğŸ†• å¤–ç¨ã®å ´åˆã¯ç¨è¾¼ä¾¡æ ¼ã‚’è¨ˆç®—
          if (item.taxType === 'exclusive') {
            const taxRate = item.taxRate || 10;
            itemPrice = Math.floor(item.price * (1 + taxRate / 100));
            console.log(`  å¤–ç¨å•†å“: ${item.name}, æœ¬ä½“${item.price}å†† â†’ ç¨è¾¼${itemPrice}å††`);
          }
          const itemTotal = (itemPrice + (item.toppingPrice || 0)) * item.quantity;
          totalAmount += itemTotal;
        });
        
        console.log('ğŸ’° åˆè¨ˆé‡‘é¡ï¼ˆå¤–ç¨å¯¾å¿œï¼‰:', totalAmount);
        
        // æ³¨æ–‡ç•ªå·ã‚’ç”Ÿæˆ
        const now = new Date();
        const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        
        const todayStart = new Date(jstNow);
        todayStart.setHours(1, 0, 0, 0);
        if (jstNow < todayStart) {
          todayStart.setDate(todayStart.getDate() - 1);
        }
        
        const ordersSnapshot = await window.getDocs(window.getStoreCollection('orders'));
        let maxOrderNumber = 618;
        let hasActiveOrders = false;
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          
          if (!data.deleted) {
            hasActiveOrders = true;
            
            const orderDate = data.timestamp && data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp || Date.now());
            const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
            
            if (jstOrderDate >= todayStart && data.orderNumber > maxOrderNumber) {
              maxOrderNumber = data.orderNumber;
            }
          }
        });
        
        const orderNumber = hasActiveOrders ? (maxOrderNumber + 1) : 619;
        
        console.log('æ³¨æ–‡ç•ªå·ç”Ÿæˆ:', {
          hasActiveOrders,
          maxOrderNumber,
          nextOrderNumber: orderNumber
        });
        
        const deleteAt = new Date(now.getTime() + 10 * 60 * 1000);
        
        // Firebaseã«å³ä¼šè¨ˆæ³¨æ–‡ã‚’ä¿å­˜
        const orderData = {
          orderNumber: orderNumber,
          tableNumber: 'å³ä¼šè¨ˆ',
          items: manualCart.map(item => ({
            id: item.id,
            name: item.name,
            price: item.price,
            taxRate: item.taxRate,  // undefinedã®å ´åˆã‚‚ãã®ã¾ã¾ä¿å­˜
            taxType: item.taxType || 'inclusive',  // ğŸ†• taxTypeã‚’ä¿å­˜
            foodType: item.foodType || 'food',  // ğŸ†• foodTypeã‚’ä¿å­˜
            toppings: item.toppings,
            toppingsData: item.toppingsData,
            toppingPrice: item.toppingPrice || 0,
            quantity: item.quantity
          })),
          totalAmount: totalAmount,
          timestamp: window.Timestamp.now(),
          deleteAt: window.Timestamp.fromDate(deleteAt),
          status: 'pending',
          manualEntry: true,
          directPayment: true  // å³ä¼šè¨ˆãƒ•ãƒ©ã‚°
        };
        
        const docRef = await window.addDoc(window.getStoreCollection('orders'), orderData);
        console.log('âœ… å³ä¼šè¨ˆæ³¨æ–‡ã‚’Firebaseã«ä¿å­˜:', docRef.id);
        
        // currentOrdersã«è¿½åŠ 
        currentOrders = [{
          id: docRef.id,
          ...orderData
        }];
        
        console.log('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿:', currentOrders[0]);
        
        // ğŸ†• å³ä¼šè¨ˆãªã®ã§ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’ã‚¯ãƒªã‚¢
        currentTableSettings = null;
        
        // ğŸ†• åœ¨åº«ã‚’æ¸›ã‚‰ã™ï¼ˆå³ä¼šè¨ˆæ™‚ï¼‰
        console.log('ğŸ“¦ å³ä¼šè¨ˆ: åœ¨åº«æ¸›å°‘å‡¦ç†ã‚’å®Ÿè¡Œ');
        await decreaseInventoryFromMenuSettings(manualCart);
        
        // ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        document.getElementById('discountAmount').value = '0';
        buildTaxRateSelectionList();
        updatePaymentTotal();
        document.getElementById('paymentModal').classList.remove('hidden');
        selectedPaymentMethod = null;
        document.querySelectorAll('.payment-method-btn').forEach(btn => {
          btn.classList.remove('selected');
        });
        document.getElementById('cashInputSection').classList.add('hidden');
      } catch (error) {
        console.error('âŒ å³ä¼šè¨ˆã‚¨ãƒ©ãƒ¼:', error);
        alert('å³ä¼šè¨ˆã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
      document.getElementById('completePaymentBtn').disabled = true;
    };
    
    // æ‰‹å‹•æ³¨æ–‡ã‚’é€ä¿¡
    window.submitManualOrder = async function() {
      const tableNumber = document.getElementById('manualTable').value;
      
      if (!tableNumber || manualCart.length === 0) {
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã¨å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        const now = new Date();
        const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        
        const todayStart = new Date(jstNow);
        todayStart.setHours(1, 0, 0, 0);
        if (jstNow < todayStart) {
          todayStart.setDate(todayStart.getDate() - 1);
        }
        
        const ordersSnapshot = await window.getDocs(window.getStoreCollection('orders'));
        let maxOrderNumber = 618;
        let hasActiveOrders = false;
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          
          // å‰Šé™¤ã•ã‚Œã¦ã„ãªã„æ³¨æ–‡ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if (!data.deleted) {
            hasActiveOrders = true;
            
            // å‰Šé™¤ã•ã‚Œã¦ã„ãªã„æ³¨æ–‡ã®ã¿ã‹ã‚‰æœ€å¤§ç•ªå·ã‚’å–å¾—
            const orderDate = data.timestamp && data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp || Date.now());
            const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
            
            if (jstOrderDate >= todayStart && data.orderNumber > maxOrderNumber) {
              maxOrderNumber = data.orderNumber;
            }
          }
        });
        
        // å‰Šé™¤ã•ã‚Œã¦ã„ãªã„æ³¨æ–‡ãŒ0ä»¶ãªã‚‰619ç•ªã‹ã‚‰é–‹å§‹
        const orderNumber = hasActiveOrders ? (maxOrderNumber + 1) : 619;
        
        console.log('æ³¨æ–‡ç•ªå·ç”Ÿæˆ:', {
          hasActiveOrders,
          maxOrderNumber,
          nextOrderNumber: orderNumber
        });
        
        let totalAmount = 0;
        manualCart.forEach(item => {
          // ğŸ†• å¤–ç¨ã®å ´åˆã¯ç¨è¾¼ä¾¡æ ¼ã‚’è¨ˆç®—
          let itemPrice = item.price;
          if (item.taxType === 'exclusive') {
            const taxRate = item.taxRate || 10;
            itemPrice = Math.floor(item.price * (1 + taxRate / 100));
          }
          totalAmount += (itemPrice + (item.toppingPrice || 0)) * item.quantity;
        });
        
        const deleteAt = new Date(now.getTime() + 10 * 60 * 1000);
        
        const orderData = {
          orderNumber: orderNumber,
          timestamp: window.Timestamp.fromDate(now),
          tableNumber: tableNumber,
          items: manualCart.map(item => ({
            id: item.id,
            name: item.name,
            price: item.price,
            category: item.category,
            taxRate: item.taxRate,
            taxType: item.taxType || 'inclusive',  // ğŸ†• å¤–ç¨/å†…ç¨ã‚¿ã‚¤ãƒ—ã‚’æ˜ç¤ºçš„ã«ä¿å­˜
            foodType: item.foodType || 'food',  // ğŸ†• foodTypeã‚’ä¿å­˜
            toppings: item.toppings,
            toppingPrice: item.toppingPrice || 0,
            toppingsData: item.toppingsData || [],
            toppingDetails: item.toppingDetails || [],
            quantity: item.quantity
          })),
          totalAmount: totalAmount,
          status: 'pending',
          deleteAt: window.Timestamp.fromDate(deleteAt),
          cancelledAt: null,
          completedAt: null,
          paidAt: null,
          notifiedComplete: false,
          notifiedCancel: false,
          notifiedPaid: false,
          manualEntry: true
        };
        
        const docRef = await window.addDoc(window.getStoreCollection('orders'), orderData);
        
        await window.updateDoc(docRef, {
          orderId: docRef.id
        });
        
        manualCart = [];
        document.getElementById('manualTable').value = '';
        document.querySelectorAll('#menuItemsList input[type="checkbox"]').forEach(cb => cb.checked = false);
        updateManualCart();
        
      } catch (e) {
        console.error('æ³¨æ–‡ã‚¨ãƒ©ãƒ¼:', e);
        alert('æ³¨æ–‡ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // å³ä¼šè¨ˆã‚¯ã‚¤ãƒƒã‚¯ãƒœã‚¿ãƒ³ - å•†å“ãŒã‚ã‚‹å ´åˆã¯é€ä¿¡ã—ã¦ã‹ã‚‰é–‹ã
    window.quickCheckout = async function() {
      try {
        // å³ä¼šè¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®IDã‚’å–å¾—ã¾ãŸã¯ä½œæˆ
        const tablesSnapshot = await window.getDocs(window.getStoreCollection('tables'));
        let quickCheckoutTable = null;
        
        tablesSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.name === 'å³ä¼šè¨ˆ') {
            quickCheckoutTable = { id: doc.id, ...data };
          }
        });
        
        // å³ä¼šè¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
        if (!quickCheckoutTable) {
          const docRef = await window.addDoc(window.getStoreCollection('tables'), {
            name: 'å³ä¼šè¨ˆ',
            order: 999,
            createdAt: window.Timestamp.now()
          });
          quickCheckoutTable = { id: docRef.id, name: 'å³ä¼šè¨ˆ', order: 999 };
          console.log('âœ… å³ä¼šè¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ');
        }
        
        // å³ä¼šè¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã®æœªä¼šè¨ˆæ³¨æ–‡æ•°ã‚’å–å¾—
        const ordersRef = window.getStoreCollection('orders');
        const ordersSnapshot = await window.getDocs(ordersRef);
        let orderCount = 0;
        ordersSnapshot.forEach(doc => {
          const order = doc.data();
          // ğŸ”¥ ä¿®æ­£: tableId ã¾ãŸã¯ tableNumber ã§ãƒãƒƒãƒã€å‰Šé™¤æ¸ˆã¿ã®ã¿é™¤å¤–
          const matchesTable = (order.tableId === quickCheckoutTable.id) || (order.tableNumber === 'å³ä¼šè¨ˆ');
          if (matchesTable && !order.deleted) {
            orderCount++;
          }
        });
        
        // å³ä¼šè¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é–‹ãï¼ˆæ–°UIï¼‰
        currentSelectedTableId = quickCheckoutTable.id;
        currentSelectedTableName = 'å³ä¼šè¨ˆ';
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’éè¡¨ç¤ºã€è©³ç´°ã‚’è¡¨ç¤º
        document.getElementById('tablesArea').style.display = 'none';
        document.getElementById('tableDetailArea').classList.add('show');
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«åã¨æ³¨æ–‡æ•°ã‚’è¡¨ç¤º
        document.getElementById('detailTableName').textContent = 'å³ä¼šè¨ˆ';
        document.getElementById('detailOrderCount').textContent = `æ³¨æ–‡: ${orderCount}ä»¶`;
        
        // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’è¨­å®š
        document.getElementById('paymentBtn').disabled = false;
        document.getElementById('paymentBtn').style.opacity = '1';
        document.getElementById('paymentBtn').style.cursor = 'pointer';
        
        // æ³¨æ–‡ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
        await loadTableOrders(quickCheckoutTable.id);
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
        showMenuIframe();
        
      } catch (error) {
        console.error('å³ä¼šè¨ˆã‚¨ãƒ©ãƒ¼:', error);
        alert('å³ä¼šè¨ˆã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };
    
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹
    function startRealtimeUpdates() {
      TABLES.forEach(table => {
        monitorTable(table);
      });
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ³¨æ–‡ã‚’ç›£è¦–
    async function monitorTable(tableNum) {
      const q = query(
        window.getStoreCollection('orders'),
        where('tableNumber', '==', String(tableNum))
      );
      
      onSnapshot(q, (snapshot) => {
        const unpaidOrders = snapshot.docs.filter(doc => {
          const data = doc.data();
          // å‰Šé™¤æ¸ˆã¿ã€ä¼šè¨ˆæ¸ˆã¿ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿ã‚’é™¤å¤–
          return !data.deleted && !data.paidAt && !data.cancelledAt;
        });
        
        const hasActiveOrders = unpaidOrders.length > 0;
        const orderCount = unpaidOrders.length;
        
        const btn = document.getElementById(`table-${tableNum}`);
        if (btn) {
          // has-ordersã‚¯ãƒ©ã‚¹ã®æ›´æ–°
          if (hasActiveOrders) {
            btn.classList.add('has-orders');
          } else {
            btn.classList.remove('has-orders');
          }
          
          // æ—¢å­˜ã®ãƒãƒƒã‚¸ã‚’å‰Šé™¤
          const existingBadge = btn.querySelector('.order-badge');
          if (existingBadge) {
            existingBadge.remove();
          }
          
          // æ³¨æ–‡ãŒã‚ã‚‹å ´åˆã¯ãƒãƒƒã‚¸ã‚’è¿½åŠ 
          if (orderCount > 0) {
            const badge = document.createElement('span');
            badge.className = 'order-badge';
            badge.textContent = orderCount;
            btn.appendChild(badge);
          }
        }
        
        if (selectedTable === tableNum) {
          loadOrders(tableNum);
        }
        
        // å…¨ãƒ†ãƒ¼ãƒ–ãƒ«åˆè¨ˆã‚’æ›´æ–°
        updateAllTablesTotal();
      });
    }
    
    // å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®åˆè¨ˆé‡‘é¡ã‚’æ›´æ–°
    async function updateAllTablesTotal() {
      try {
        const q = query(window.getStoreCollection('orders'));
        const snapshot = await window.getDocs(q);
        
        let total = 0;
        snapshot.forEach(doc => {
          const data = doc.data();
          // å‰Šé™¤æ¸ˆã¿ã€ä¼šè¨ˆæ¸ˆã¿ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿ã‚’é™¤å¤–
          if (!data.deleted && !data.paidAt && !data.cancelledAt) {
            total += data.totalAmount || 0;
          }
        });
        
        const totalElement = document.getElementById('allTablesTotal');
        if (totalElement) {
          totalElement.textContent = `Â¥${total.toLocaleString()}`;
        }
      } catch (error) {
        console.error('å…¨ãƒ†ãƒ¼ãƒ–ãƒ«åˆè¨ˆè¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä¼šè¨ˆã‚’è¡Œã†
    window.payAllTables = async function() {
      try {
        // å…¨ã¦ã®æœªä¼šè¨ˆæ³¨æ–‡ã‚’å–å¾—
        const q = query(window.getStoreCollection('orders'));
        const snapshot = await window.getDocs(q);
        
        const allOrders = [];
        let total = 0;
        
        snapshot.forEach(doc => {
          const data = doc.data();
          // å‰Šé™¤æ¸ˆã¿ã€ä¼šè¨ˆæ¸ˆã¿ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿ã‚’é™¤å¤–
          if (!data.deleted && !data.paidAt && !data.cancelledAt) {
            allOrders.push({ id: doc.id, ...data });
            total += data.totalAmount || 0;
          }
        });
        
        if (allOrders.length === 0) {
          alert('ä¼šè¨ˆã™ã‚‹æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“');
          return;
        }
        
        // ä»®æƒ³çš„ãªãƒ†ãƒ¼ãƒ–ãƒ«ã¨ã—ã¦ã€Œå…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã€ã‚’é¸æŠ
        selectedTable = 'å…¨ãƒ†ãƒ¼ãƒ–ãƒ«';
        currentOrders = allOrders;
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’nullã«ï¼ˆå…¨ãƒ†ãƒ¼ãƒ–ãƒ«ãªã®ã§çµ±ä¸€è¨­å®šãªã—ï¼‰
        currentTableSettings = null;
        
        // ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        await showPaymentModal();
        
      } catch (error) {
        console.error('å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ä¼šè¨ˆã‚¨ãƒ©ãƒ¼:', error);
        alert('å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ä¼šè¨ˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
      }
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠ
    window.selectTable = async function(tableNum) {
      selectedTable = tableNum;
      document.getElementById('selectedTableLabel').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${tableNum}`;
      document.getElementById('orderSection').classList.remove('hidden');
      
      // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã¿
      if (tableNum && tableNum !== 'å³ä¼šè¨ˆ') {
        currentTableSettings = await getTableSettings(tableNum);
        console.log('ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šèª­ã¿è¾¼ã¿å®Œäº†:', tableNum);
        console.log('  taxRule:', currentTableSettings?.taxRule || 'ãªã—');
        console.log('  è¨­å®šå…¨ä½“:', currentTableSettings);
      } else {
        currentTableSettings = null;
        console.log('ğŸ“‹ å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰: ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãªã—');
      }
      
      await loadOrders(tableNum);
    };
    
    // æ³¨æ–‡ã‚’èª­ã¿è¾¼ã¿
    async function loadOrders(tableNum) {
      const container = document.getElementById('ordersList');
      container.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      try {
        const q = query(
          window.getStoreCollection('orders'),
          where('tableNumber', '==', String(tableNum))
        );
        
        const snapshot = await window.getDocs(q);
        
        if (snapshot.empty) {
          container.innerHTML = '<div class="empty-state">ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
          document.getElementById('totalSection').classList.add('hidden');
          return;
        }
        
        container.innerHTML = '';
        currentOrders = [];
        let totalAmount = 0;
        let hasUnpaidOrders = false;
        
        // æ³¨æ–‡ã‚’é…åˆ—ã«å¤‰æ›ã—ã¦ã‚½ãƒ¼ãƒˆ
        const orders = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          orders.push({ id: doc.id, ...data });
        });
        
        // æ³¨æ–‡ç•ªå·ã§ã‚½ãƒ¼ãƒˆï¼ˆå¤ã„é †: 619â†’620â†’621ï¼‰
        orders.sort((a, b) => {
          return a.orderNumber - b.orderNumber;
        });
        
        // å‰Šé™¤ã•ã‚Œã¦ã„ãªã„æ³¨æ–‡ã®ã¿è¡¨ç¤º
        console.log('å…¨æ³¨æ–‡æ•°:', orders.length);
        orders.forEach(order => {
          console.log(`æ³¨æ–‡#${order.orderNumber}: deleted=${order.deleted}, paidAt=${order.paidAt}, cancelledAt=${order.cancelledAt}`);
          
          // deletedãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã‚‹æ³¨æ–‡ã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå±¥æ­´ã§ã¯è¡¨ç¤ºï¼‰
          if (order.deleted) {
            console.log(`  â†’ ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå‰Šé™¤æ¸ˆã¿ï¼‰`);
            return;
          }
          
          const card = createOrderCard(order);
          container.appendChild(card);
          
          // æœªæ‰•ã„æ³¨æ–‡ã®ã¿åˆè¨ˆã«å«ã‚ã‚‹
          if (!order.cancelledAt && !order.paidAt) {
            currentOrders.push(order);
            totalAmount += order.totalAmount || 0;
            hasUnpaidOrders = true;
            
            // ğŸ” ãƒ‡ãƒãƒƒã‚°: æ³¨æ–‡å†…ã®å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
            if (order.items && order.items.length > 0) {
              console.log(`[æ³¨æ–‡ #${order.orderNumber}] å•†å“ãƒ‡ãƒ¼ã‚¿:`, order.items.map(item => ({
                name: item.name,
                foodType: item.foodType,
                taxRate: item.taxRate
              })));
            }
          }
        });
        
        console.log('è¡¨ç¤ºã•ã‚ŒãŸæ³¨æ–‡æ•°:', container.children.length);
        
        // æ³¨æ–‡ãŒ1ã¤ã‚‚è¡¨ç¤ºã•ã‚Œãªã‹ã£ãŸå ´åˆ
        if (container.children.length === 0) {
          container.innerHTML = '<div class="empty-state">ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        }
        
        if (!hasUnpaidOrders) {
          document.getElementById('totalSection').classList.add('hidden');
        } else {
          document.getElementById('totalAmount').textContent = `Â¥${totalAmount.toLocaleString()}`;
          document.getElementById('totalSection').classList.remove('hidden');
          totalAmountToPay = totalAmount;
        }
        
      } catch (e) {
        console.error('æ³¨æ–‡èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', e.message);
        container.innerHTML = '<div class="empty-state">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message + '</div>';
      }
    }
    
    // æ³¨æ–‡ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
    function createOrderCard(order) {
      const card = document.createElement('div');
      card.className = 'order-card';
      
      if (order.completedAt) card.classList.add('completed');
      if (order.cancelledAt) card.classList.add('cancelled');
      
      let timeStr = '--:--';
      try {
        if (order.timestamp && order.timestamp.toDate) {
          const timestamp = order.timestamp.toDate();
          timeStr = `${timestamp.getHours()}:${String(timestamp.getMinutes()).padStart(2, '0')}`;
        }
      } catch (e) {
        console.error('Timestampå¤‰æ›ã‚¨ãƒ©ãƒ¼:', e);
      }
      
      // è¤‡æ•°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒƒã‚¸ã‚’è¡¨ç¤º
      let statusBadges = [];
      if (order.paidAt) {
        statusBadges.push('<span class="order-status" style="background: #2196F3; color: white;">ä¼šè¨ˆæ¸ˆ</span>');
      }
      if (order.completedAt) {
        statusBadges.push('<span class="order-status completed">æä¾›æ¸ˆã¿</span>');
      }
      if (order.cancelledAt) {
        statusBadges.push('<span class="order-status cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>');
      }
      if (statusBadges.length === 0) {
        statusBadges.push('<span class="order-status pending">èª¿ç†ä¸­</span>');
      }
      const statusHtml = statusBadges.join(' ');
      
      let itemsHtml = '';
      if (order.items && Array.isArray(order.items) && order.items.length > 0) {
        order.items.forEach(item => {
          const itemBasePrice = item.price;
          const itemWithTopping = itemBasePrice + (item.toppingPrice || 0);
          const itemTotal = itemWithTopping * item.quantity;
          
          // ãƒˆãƒƒãƒ”ãƒ³ã‚°è¡¨ç¤ºï¼ˆtoppingDetailsã¾ãŸã¯toppingsDataã‚’å„ªå…ˆï¼‰
          let toppingsHtml = '';
          if (item.toppingDetails && item.toppingDetails.length > 0) {
            // æ–°ã—ã„å½¢å¼: toppingDetailsãŒã‚ã‚‹å ´åˆï¼ˆPOSç”»é¢ã‹ã‚‰ï¼‰
            const groupedBySet = {};
            item.toppingDetails.forEach(detail => {
              if (!groupedBySet[detail.setName]) {
                groupedBySet[detail.setName] = [];
              }
              groupedBySet[detail.setName].push(detail.optionName);
            });
            
            toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
              return `
                <div style="font-size: 12px; color: #666; font-weight: bold; padding-left: 10px; margin-top: 3px;">${setName}</div>
                ${options.map(opt => `<div style="font-size: 12px; color: #666; padding-left: 20px;">ã€€ãƒ»${opt}</div>`).join('')}
              `;
            }).join('');
          } else if (item.toppingsData && item.toppingsData.length > 0) {
            // ğŸ†• menu.htmlã‹ã‚‰ã®å½¢å¼: toppingsDataãŒã‚ã‚‹å ´åˆ
            const groupedBySet = {};
            item.toppingsData.forEach(topping => {
              const setName = topping.setName || 'ãƒˆãƒƒãƒ”ãƒ³ã‚°';
              if (!groupedBySet[setName]) {
                groupedBySet[setName] = [];
              }
              groupedBySet[setName].push(topping.name);
            });
            
            toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
              return `
                <div style="font-size: 12px; color: #666; font-weight: bold; padding-left: 10px; margin-top: 3px;">${setName}</div>
                ${options.map(opt => `<div style="font-size: 12px; color: #666; padding-left: 20px;">ã€€ãƒ»${opt}</div>`).join('')}
              `;
            }).join('');
          } else if (item.toppings && item.toppings !== 'ãªã—' && item.toppings !== 'æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°') {
            // å¤ã„å½¢å¼: toppingsã®ã¿ã®å ´åˆ
            const toppingList = item.toppings.split(', ');
            toppingsHtml = toppingList.map(t => `<div style="font-size: 12px; color: #666; padding-left: 10px;">ã€€${t}</div>`).join('');
          } else if (!item.toppingDetails && (!item.toppingsData || item.toppingsData.length === 0)) {
            // ãƒˆãƒƒãƒ”ãƒ³ã‚°æœªé¸æŠã®å ´åˆã¯ã€Œæ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°ã€ã¨è¡¨ç¤º
            toppingsHtml = `<div style="font-size: 12px; color: #999; padding-left: 10px;">ã€€æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°</div>`;
          }
          
          const itemIndex = order.items.indexOf(item);
          const isChecked = order.itemsChecked && order.itemsChecked[itemIndex];
          const checkboxId = `checkbox-${order.id}-${itemIndex}`;
          
          itemsHtml += `
            <div class="order-item-detailed" style="position: relative; ${isChecked ? 'opacity: 0.6; background: #e8f5e9;' : ''}">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                <input type="checkbox" 
                       id="${checkboxId}" 
                       ${isChecked ? 'checked' : ''} 
                       onchange="toggleItemCheck('${order.id}', ${itemIndex})"
                       style="width: 20px; height: 20px; cursor: pointer; flex-shrink: 0;">
                <div style="flex: 1; display: flex; justify-content: space-between; cursor: pointer;" 
                     onclick="document.getElementById('${checkboxId}').click()">
                  <div style="font-weight: bold;">${item.name} Ã—${item.quantity}</div>
                  <div>Â¥${itemBasePrice.toLocaleString()}</div>
                </div>
              </div>
              ${toppingsHtml}
              <div style="display: flex; justify-content: flex-end; margin-top: 5px; padding-top: 5px; border-top: 1px dashed #ddd;">
                <div style="font-weight: bold; color: #667eea;">Â¥${itemWithTopping.toLocaleString()} Ã— ${item.quantity} = Â¥${itemTotal.toLocaleString()}</div>
              </div>
            </div>
          `;
        });
      } else {
        // itemsãŒãªã„å ´åˆã¯è­¦å‘Šè¡¨ç¤º
        itemsHtml = `
          <div style="padding: 10px; background: #fff3cd; border-radius: 8px; color: #856404;">
            âš ï¸ å•†å“è©³ç´°ãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br>
            åˆè¨ˆé‡‘é¡: Â¥${(order.totalAmount || 0).toLocaleString()}
          </div>
        `;
      }
      
      // ãƒ¬ã‚¸è¢‹æƒ…å ±ã‚’è¿½åŠ 
      if (order.bagNeeded && order.bagQuantity > 0) {
        const bagTotal = order.bagPrice || (order.bagQuantity * 3);
        const bagUnitPrice = Math.round(bagTotal / order.bagQuantity); // å˜ä¾¡ã‚’è¨ˆç®—
        itemsHtml += `
          <div class="order-item-detailed" style="background: #fff3e0;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <div style="font-weight: bold;">ğŸ›ï¸ ãƒ¬ã‚¸è¢‹ Ã—${order.bagQuantity}</div>
              <div>Â¥${bagUnitPrice}</div>
            </div>
            <div style="display: flex; justify-content: flex-end; margin-top: 5px; padding-top: 5px; border-top: 1px dashed #ddd;">
              <div style="font-weight: bold; color: #667eea;">Â¥${bagUnitPrice} Ã— ${order.bagQuantity} = Â¥${bagTotal.toLocaleString()}</div>
            </div>
          </div>
        `;
      }
      
      // ãŠå®¢æ§˜æƒ…å ±ã‚’è¿½åŠ 
      let customerInfoHtml = '';
      
      // ãƒ¡ãƒ¢
      if (order.customerMemo && order.customerMemo.trim() !== '') {
        customerInfoHtml += `
          <div class="order-item-detailed" style="background: #e3f2fd; border-left: 4px solid #2196F3; margin-bottom: 8px;">
            <div style="font-weight: bold; color: #1976D2; margin-bottom: 5px;">ãŠå®¢æ§˜ãƒ¡ãƒ¢</div>
            <div style="color: #333;">${order.customerMemo}</div>
          </div>
        `;
      }
      
      // åå‰
      if (order.customerName && order.customerName.trim() !== '') {
        customerInfoHtml += `
          <div class="order-item-detailed" style="background: #f3e5f5; border-left: 4px solid #9C27B0; margin-bottom: 8px;">
            <div style="font-weight: bold; color: #7B1FA2; margin-bottom: 5px;">ãŠåå‰</div>
            <div style="color: #333;">${order.customerName}</div>
          </div>
        `;
      }
      
      // é›»è©±ç•ªå·
      if (order.customerPhone && order.customerPhone.trim() !== '') {
        customerInfoHtml += `
          <div class="order-item-detailed" style="background: #e0f2f1; border-left: 4px solid #009688; margin-bottom: 8px;">
            <div style="font-weight: bold; color: #00796B; margin-bottom: 5px;">ğŸ“ é›»è©±ç•ªå·</div>
            <div style="color: #333;">${order.customerPhone}</div>
          </div>
        `;
      }
      
      // ğŸ†• å¼•å–æ™‚é–“
      if (order.pickupTime && order.pickupTime.trim() !== '') {
        customerInfoHtml += `
          <div class="order-item-detailed" style="background: #fff9c4; border-left: 4px solid #FFC107; margin-bottom: 8px;">
            <div style="font-weight: bold; color: #F57F17; margin-bottom: 5px;">ğŸ• å¼•å–æ™‚é–“</div>
            <div style="color: #333; font-size: 18px; font-weight: bold;">${order.pickupTime}</div>
          </div>
        `;
      }
      
      // éƒµä¾¿ç•ªå·
      if (order.customerPostalCode && order.customerPostalCode.trim() !== '') {
        customerInfoHtml += `
          <div class="order-item-detailed" style="background: #fff3e0; border-left: 4px solid #FF9800; margin-bottom: 8px;">
            <div style="font-weight: bold; color: #F57C00; margin-bottom: 5px;">éƒµä¾¿ç•ªå·</div>
            <div style="color: #333;">${order.customerPostalCode}</div>
          </div>
        `;
      }
      
      // ä½æ‰€
      if (order.customerAddress && order.customerAddress.trim() !== '') {
        customerInfoHtml += `
          <div class="order-item-detailed" style="background: #e8f5e9; border-left: 4px solid #4CAF50; margin-bottom: 8px;">
            <div style="font-weight: bold; color: #388E3C; margin-bottom: 5px;">ä½æ‰€</div>
            <div style="color: #333;">${order.customerAddress}</div>
          </div>
        `;
      }
      
      // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
      if (order.customerEmail && order.customerEmail.trim() !== '') {
        customerInfoHtml += `
          <div class="order-item-detailed" style="background: #fce4ec; border-left: 4px solid #E91E63; margin-bottom: 8px;">
            <div style="font-weight: bold; color: #C2185B; margin-bottom: 5px;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</div>
            <div style="color: #333;">${order.customerEmail}</div>
          </div>
        `;
      }
      
      // å…¨å•†å“ãŒãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã‹ã©ã†ã‹ã‚’åˆ¤å®š
      const allItemsChecked = order.items && order.items.length > 0 && 
        order.items.every((item, idx) => order.itemsChecked && order.itemsChecked[idx]);
      
      // ğŸ†• ãƒ¡ãƒ¢è¡¨ç¤º
      let memoHtml = '';
      if (order.memo && order.memo.trim() !== '') {
        memoHtml = `
          <div class="order-item-detailed" style="background: #fff9c4; border-left: 4px solid #FBC02D; margin-bottom: 8px;">
            <div style="font-weight: bold; color: #F57F17; margin-bottom: 5px; display: flex; align-items: center; gap: 5px;">
              ğŸ“ ãƒ¡ãƒ¢
              <button onclick="editOrderMemo('${order.id}')" style="padding: 2px 8px; background: #FBC02D; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">ç·¨é›†</button>
            </div>
            <div style="color: #333; white-space: pre-wrap;">${order.memo}</div>
          </div>
        `;
      } else {
        memoHtml = `
          <div style="margin-bottom: 8px;">
            <button onclick="editOrderMemo('${order.id}')" style="padding: 6px 12px; background: #FBC02D; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: bold;">
              ğŸ“ ãƒ¡ãƒ¢ã‚’è¿½åŠ 
            </button>
          </div>
        `;
      }
      
      card.innerHTML = `
        <div class="order-header">
          <div>
            <span class="order-number">#${order.orderNumber || '---'}</span>
            ${statusHtml}
          </div>
          <div class="order-time">${timeStr}</div>
        </div>
        <div class="order-items">
          ${memoHtml}
          ${customerInfoHtml}
          ${itemsHtml}
        </div>
        <div class="order-total">
          <span class="total-label">åˆè¨ˆ:</span>
          <span class="total-amount">Â¥${(order.totalAmount || 0).toLocaleString()}</span>
        </div>
        <div class="order-actions">
          ${!order.paidAt && !order.cancelledAt ? `<button class="order-action-btn pay-btn" onclick="payOrderIndividual('${order.id}', ${order.totalAmount || 0})">ä¼šè¨ˆ</button>` : ''}
          ${!order.completedAt && !order.cancelledAt ? `<button class="order-action-btn complete-btn" onclick="completeOrder('${order.id}')">å®Œäº†</button>` : ''}
          ${!order.completedAt && !order.cancelledAt ? `<button class="order-action-btn cancel-btn" onclick="cancelOrder('${order.id}')">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>` : ''}
          ${order.completedAt || order.cancelledAt ? `<button class="order-action-btn delete-btn" onclick="deleteOrder('${order.id}')">å‰Šé™¤</button>` : ''}
        </div>
      `;
      
      return card;
    }
    
    // å€‹åˆ¥æ³¨æ–‡ã®ä¼šè¨ˆ
    window.payOrderIndividual = async function(orderId, amount) {
      const order = currentOrders.find(o => o.id === orderId);
      if (!order) {
        alert('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // å˜ä¸€æ³¨æ–‡ã‚’é¸æŠã—ã¦ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      currentOrders = [order];
      totalAmountToPay = amount;
      
      // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã¿ï¼ˆç¨ç‡è¨­å®šã®ãŸã‚ï¼‰
      if (order.tableNumber && order.tableNumber !== 'å³ä¼šè¨ˆ' && order.tableNumber !== 'å…¨ãƒ†ãƒ¼ãƒ–ãƒ«') {
        currentTableSettings = await getTableSettings(order.tableNumber);
        console.log('ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã¿:', order.tableNumber);
        console.log('  taxRule:', currentTableSettings?.taxRule || 'ãªã—');
      } else {
        currentTableSettings = null;
      }
      
      // å€¤å¼•ãé‡‘é¡ã‚’åˆæœŸåŒ–
      document.getElementById('discountAmount').value = '0';
      
      // ç¨ç‡é¸æŠãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
      buildTaxRateSelectionList();
      
      // è«‹æ±‚é¡ã‚’è¡¨ç¤º
      updatePaymentTotal();
      
      document.getElementById('paymentModal').classList.remove('hidden');
      selectedPaymentMethod = null;
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('completePaymentBtn').disabled = true;
    };
    
    // æ³¨æ–‡ã‚’å®Œäº†ã«ã™ã‚‹
    window.completeOrder = async function(orderId) {
      try {
        // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦åœ¨åº«ã‚’æ¸›ã‚‰ã™
        const orderRef = window.getStoreDoc('orders', orderId);
        const orderSnap = await window.getDoc(orderRef);
        
        if (orderSnap.exists()) {
          const orderData = orderSnap.data();
          await decreaseInventory(orderData.items || []);
        }
        
        // æ³¨æ–‡ã‚’å®Œäº†ã«ã™ã‚‹
        await window.updateDoc(window.getStoreDoc('orders', orderId), {
          completedAt: window.Timestamp.now()
        });
        
        // å¾…ã¡äººæ•°ã‚’1æ¸›ã‚‰ã™
        try {
          const waitingRef = window.getStoreDoc('settings', 'waiting');
          const waitingDoc = await window.getDoc(waitingRef);
          
          if (waitingDoc.exists()) {
            const currentCount = waitingDoc.data().manualCount || 0;
            if (currentCount > 0) {
              await window.updateDoc(waitingRef, {
                manualCount: currentCount - 1,
                updatedAt: window.Timestamp.now()
              });
              console.log('âœ… å®Œäº†: å¾…ã¡äººæ•°ã‚’æ¸›ã‚‰ã—ã¾ã—ãŸ:', currentCount, 'â†’', currentCount - 1);
            }
          }
        } catch (err) {
          console.error('å¾…ã¡äººæ•°æ›´æ–°ã‚¨ãƒ©ãƒ¼:', err);
        }
        
        await loadOrders(selectedTable);
        
        // åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯
        await checkInventoryAlerts();
      } catch (e) {
        console.error('å®Œäº†ã‚¨ãƒ©ãƒ¼:', e);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    };
    
    // å•†å“ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
    window.toggleItemCheck = async function(orderId, itemIndex) {
      try {
        const orderRef = window.getStoreDoc('orders', orderId);
        const orderSnap = await window.getDoc(orderRef);
        
        if (!orderSnap.exists()) {
          alert('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        const orderData = orderSnap.data();
        const itemsChecked = orderData.itemsChecked || [];
        
        // ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’åè»¢
        itemsChecked[itemIndex] = !itemsChecked[itemIndex];
        
        // Firestoreã«ä¿å­˜
        await window.updateDoc(orderRef, {
          itemsChecked: itemsChecked
        });
        
        console.log('âœ… å•†å“ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’æ›´æ–°:', orderId, 'item', itemIndex, '=', itemsChecked[itemIndex]);
        
        // æ³¨æ–‡ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã«ã‚ˆã‚Šè‡ªå‹•ã§åæ˜ ã•ã‚Œã‚‹ï¼‰
      } catch (e) {
        console.error('ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    };
    
    // ğŸ†• æ³¨æ–‡ãƒ¡ãƒ¢ã‚’ç·¨é›†
    window.editOrderMemo = async function(orderId) {
      try {
        const orderRef = window.getStoreDoc('orders', orderId);
        const orderSnap = await window.getDoc(orderRef);
        
        if (!orderSnap.exists()) {
          alert('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        const orderData = orderSnap.data();
        const currentMemo = orderData.memo || '';
        
        const newMemo = prompt('ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nï¼ˆãŠå®¢æ§˜ã®åå‰ã€å¼•å–æ™‚é–“ã€æ³¨æ„äº‹é …ãªã©ï¼‰', currentMemo);
        
        if (newMemo !== null) {  // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ãªã‹ã£ãŸå ´åˆ
          await window.updateDoc(orderRef, {
            memo: newMemo.trim()
          });
          
          console.log('âœ… ãƒ¡ãƒ¢ã‚’æ›´æ–°:', orderId, newMemo);
        }
      } catch (e) {
        console.error('ãƒ¡ãƒ¢æ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    };
    
    // å®Œäº†â†’å‰Šé™¤ï¼ˆä¸€æ°—ã«å‡¦ç†ï¼‰
    // æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹
    window.cancelOrder = async function(orderId) {
      try {
        await window.updateDoc(window.getStoreDoc('orders', orderId), {
          cancelledAt: window.Timestamp.now()
        });
        await loadOrders(selectedTable);
      } catch (e) {
        console.error('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¨ãƒ©ãƒ¼:', e);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
      }
    };
    
    // ğŸ†• menu_settingsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰åœ¨åº«ã‚’æ¸›ã‚‰ã™ï¼ˆkanri.htmlã¨äº’æ›æ€§ã‚ã‚Šï¼‰
    async function decreaseInventoryFromMenuSettings(items) {
      try {
        console.log('ğŸ“¦ åœ¨åº«æ¸›å°‘å‡¦ç†é–‹å§‹');
        console.log('  æ¸›ã‚‰ã™å•†å“:', items);
        
        // ğŸ†• inventory_settings ã‚’ä½¿ç”¨ï¼ˆkanri.htmlã¨çµ±ä¸€ï¼‰
        let inventorySettingsRef;
        if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
          inventorySettingsRef = window.doc(window.db, 'inventory_settings', 'default');
          console.log('  â†’ æ—§ãƒ‘ã‚¹: inventory_settings/default');
        } else {
          inventorySettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
          console.log('  â†’ æ–°ãƒ‘ã‚¹: stores/' + window.currentStoreId + '/inventory_settings/default');
        }
        
        const inventorySettingsSnap = await window.getDoc(inventorySettingsRef);
        
        if (!inventorySettingsSnap.exists()) {
          console.log('âš ï¸ åœ¨åº«è¨­å®šãŒå­˜åœ¨ã—ã¾ã›ã‚“');
          return;
        }
        
        const inventorySettingsData = inventorySettingsSnap.data();
        const inventoryItems = inventorySettingsData.items || {};
        console.log('  ç¾åœ¨ã®åœ¨åº«ãƒ‡ãƒ¼ã‚¿:', inventoryItems);
        
        let updated = false;
        
        // menusã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å•†å“IDã‚’å–å¾—ã—ã¦ãƒãƒƒãƒ”ãƒ³ã‚°
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        const nameToIdMap = {};
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.name) {
            nameToIdMap[data.name] = data.id || doc.id;
          }
        });
        
        for (const item of items) {
          const itemName = item.name;
          const itemId = item.id || nameToIdMap[itemName];
          const quantity = item.quantity || 1;
          
          console.log(`  ãƒã‚§ãƒƒã‚¯: ${itemName} (ID: ${itemId}, æ•°é‡: ${quantity})`);
          
          if (!itemId) {
            console.log(`  â­ï¸ ${itemName}: IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
            continue;
          }
          
          // åœ¨åº«ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å•†å“ã®ã¿æ¸›ã‚‰ã™
          if (inventoryItems[itemId]) {
            const currentStock = inventoryItems[itemId].stock;
            
            if (currentStock !== null && currentStock !== undefined && currentStock !== '') {
              const newStock = Math.max(0, currentStock - quantity);
              inventoryItems[itemId].stock = newStock;
              updated = true;
              
              console.log(`  âœ… åœ¨åº«æ¸›å°‘: ${itemName} ${currentStock} â†’ ${newStock}`);
              
              // åœ¨åº«ãŒ0ã«ãªã£ãŸå ´åˆã®è­¦å‘Š
              if (newStock === 0) {
                console.log(`  âš ï¸ åœ¨åº«åˆ‡ã‚Œ: ${itemName}`);
              }
            } else {
              console.log(`  â­ï¸ ${itemName}: åœ¨åº«ç®¡ç†å¯¾è±¡å¤–ï¼ˆç¾åœ¨å€¤: ${currentStock}ï¼‰`);
            }
          } else {
            console.log(`  â­ï¸ ${itemName}: åœ¨åº«è¨­å®šãªã—`);
          }
        }
        
        // åœ¨åº«ã‚’æ›´æ–°
        if (updated) {
          await window.updateDoc(inventorySettingsRef, {
            items: inventoryItems,
            updatedAt: new Date().toISOString()
          });
          console.log('âœ… åœ¨åº«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
          console.log('  æ›´æ–°å¾Œã®åœ¨åº«:', inventoryItems);
          
          // ğŸ†• ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åœ¨åº«ãƒ‘ãƒãƒ«ã‚’æ›´æ–°
          updateInventoryPanel();
        } else {
          console.log('âš ï¸ åœ¨åº«æ›´æ–°ãªã—ï¼ˆåœ¨åº«ç®¡ç†å¯¾è±¡ã®å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼‰');
        }
      } catch (error) {
        console.error('âŒ åœ¨åº«æ¸›å°‘ã‚¨ãƒ©ãƒ¼:', error);
        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error.stack);
      }
    }
    
    // ğŸ†• åœ¨åº«ã‚’æ¸›ã‚‰ã™
    async function decreaseInventory(items) {
      try {
        const inventoryRef = window.getStoreDoc('inventory_settings', 'default');
        const inventorySnap = await window.getDoc(inventoryRef);
        
        if (!inventorySnap.exists()) {
          console.log('âš ï¸ åœ¨åº«è¨­å®šãŒå­˜åœ¨ã—ã¾ã›ã‚“');
          return;
        }
        
        const inventoryData = inventorySnap.data();
        const inventorySettings = inventoryData.items || {};
        let updated = false;
        
        for (const item of items) {
          const menuItemId = item.id;
          const quantity = item.quantity || 1;
          
          if (inventorySettings[menuItemId]) {
            const currentStock = inventorySettings[menuItemId].stock;
            
            // åœ¨åº«ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿æ¸›ã‚‰ã™
            if (currentStock !== null && currentStock !== undefined) {
              const newStock = Math.max(0, currentStock - quantity);
              inventorySettings[menuItemId].stock = newStock;
              updated = true;
              
              console.log(`ğŸ“¦ åœ¨åº«æ¸›å°‘: ${item.name} ${currentStock} â†’ ${newStock} (${quantity}å€‹ä½¿ç”¨)`);
              
              // åœ¨åº«ãŒ0ã«ãªã£ãŸå ´åˆã€è‡ªå‹•çš„ã«å“åˆ‡ã‚Œã«ã™ã‚‹
              if (newStock === 0) {
                console.log(`âš ï¸ åœ¨åº«åˆ‡ã‚Œ: ${item.name}`);
                // menuå•†å“ã‚’å“åˆ‡ã‚Œã«è¨­å®š
                try {
                  const menuRef = window.getStoreDoc('menus', menuItemId);
                  await window.updateDoc(menuRef, {
                    isSoldOut: true
                  });
                  console.log(`âœ… è‡ªå‹•å“åˆ‡ã‚Œè¨­å®š: ${item.name}`);
                } catch (e) {
                  console.error('å“åˆ‡ã‚Œè¨­å®šã‚¨ãƒ©ãƒ¼:', e);
                }
              }
            }
          }
        }
        
        // åœ¨åº«ã‚’æ›´æ–°
        if (updated) {
          await window.updateDoc(inventoryRef, {
            items: inventorySettings,
            updatedAt: new Date().toISOString()
          });
          console.log('âœ… åœ¨åº«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('âŒ åœ¨åº«æ¸›å°‘ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // ğŸ†• åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯
    async function checkInventoryAlerts() {
      try {
        const inventoryRef = window.getStoreDoc('inventory_settings', 'default');
        const inventorySnap = await window.getDoc(inventoryRef);
        
        if (!inventorySnap.exists()) {
          return;
        }
        
        const inventoryData = inventorySnap.data();
        const inventorySettings = inventoryData.items || {};
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼å•†å“ã‚’å–å¾—
        const menusSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        const menuItems = {};
        menusSnapshot.forEach(doc => {
          menuItems[doc.id] = doc.data();
        });
        
        // ã‚¢ãƒ©ãƒ¼ãƒˆå¯¾è±¡ã®å•†å“ã‚’ãƒã‚§ãƒƒã‚¯
        const alerts = [];
        for (const [itemId, settings] of Object.entries(inventorySettings)) {
          const stock = settings.stock;
          const alertThreshold = settings.alertThreshold;
          
          if (stock !== null && alertThreshold !== null && stock <= alertThreshold && stock > 0) {
            const menuItem = menuItems[itemId];
            if (menuItem) {
              alerts.push({
                name: menuItem.name,
                stock: stock
              });
            }
          }
        }
        
        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
        if (alerts.length > 0) {
          showInventoryAlert(alerts);
        }
      } catch (error) {
        console.error('âŒ åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // ğŸ†• åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
    function showInventoryAlert(alerts) {
      // æ—¢å­˜ã®ã‚¢ãƒ©ãƒ¼ãƒˆãŒã‚ã‚Œã°å‰Šé™¤
      const existingAlert = document.getElementById('inventory-alert-box');
      if (existingAlert) {
        existingAlert.remove();
      }
      
      const alertBox = document.createElement('div');
      alertBox.id = 'inventory-alert-box';
      alertBox.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        background: linear-gradient(135deg, #ff6b6b 0%, #ff5252 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(255, 0, 0, 0.3);
        z-index: 10000;
        max-width: 400px;
        animation: slideIn 0.5s ease-out;
      `;
      
      let alertHTML = `
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 15px; display: flex; align-items: center; gap: 10px;">
          <span style="font-size: 24px;">âš ï¸</span>
          <span>åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆ</span>
        </div>
        <div style="font-size: 14px; line-height: 1.6; margin-bottom: 15px;">
          ä»¥ä¸‹ã®å•†å“ã®åœ¨åº«ãŒå°‘ãªããªã£ã¦ã„ã¾ã™ï¼š
        </div>
        <div style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
      `;
      
      alerts.forEach(alert => {
        alertHTML += `
          <div style="margin-bottom: 10px; padding: 10px; background: rgba(255, 255, 255, 0.15); border-radius: 6px;">
            <div style="font-weight: bold; font-size: 16px;">${alert.name}</div>
            <div style="font-size: 14px; margin-top: 5px;">æ®‹ã‚Š <span style="font-size: 20px; font-weight: bold;">${alert.stock}</span> å€‹</div>
            <div style="color: #ffeb3b; font-size: 12px; margin-top: 5px;">ğŸ’¡ è£œå……ã—ã¦ãã ã•ã„</div>
          </div>
        `;
      });
      
      alertHTML += `
        </div>
        <button onclick="this.parentElement.remove()" style="
          width: 100%;
          padding: 12px;
          background: white;
          color: #ff5252;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s;
        " onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
          é–‰ã˜ã‚‹
        </button>
      `;
      
      alertBox.innerHTML = alertHTML;
      document.body.appendChild(alertBox);
      
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
      if (!document.getElementById('inventory-alert-animation')) {
        const style = document.createElement('style');
        style.id = 'inventory-alert-animation';
        style.innerHTML = `
          @keyframes slideIn {
            from {
              transform: translateX(100%);
              opacity: 0;
            }
            to {
              transform: translateX(0);
              opacity: 1;
            }
          }
        `;
        document.head.appendChild(style);
      }
      
      // 5ç§’å¾Œã«è‡ªå‹•ã§è–„ãã™ã‚‹
      setTimeout(() => {
        if (alertBox.parentElement) {
          alertBox.style.opacity = '0.7';
        }
      }, 5000);
    }
    
    // æ³¨æ–‡ã‚’å‰Šé™¤ã™ã‚‹
    window.deleteOrder = async function(orderId) {
      console.log('å‰Šé™¤é–‹å§‹: orderId =', orderId);
      console.log('selectedTable =', selectedTable);
      
      try {
        // â˜…â˜…â˜… å‰Šé™¤å‰ã«Firestoreã‹ã‚‰æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾— â˜…â˜…â˜…
        console.log('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­...');
        const orderRef = window.getStoreDoc('orders', orderId);
        const orderSnap = await window.getDoc(orderRef);
        
        if (!orderSnap.exists()) {
          alert('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        const orderData = orderSnap.data();
        console.log('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿:', orderData);
        
        // â˜…â˜…â˜… ä¼šè¨ˆæ¸ˆã¿ã®æ³¨æ–‡ã®ã¿å•†å“ç‚¹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ â˜…â˜…â˜…
        if (orderData.paidAt && !orderData.deleted) {
          console.log('ğŸ“¦ ä¼šè¨ˆæ¸ˆã¿æ³¨æ–‡ã®å•†å“ç‚¹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆã—ã¾ã™');
          
          let itemCount = 0;
          let tax8Total = 0;
          let tax10Total = 0;
          
          // å•†å“ç‚¹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          if (orderData.items && Array.isArray(orderData.items) && orderData.items.length > 0) {
            orderData.items.forEach(item => {
              const qty = item.quantity || 0;
              itemCount += qty;
              console.log(`  â†’ ${item.name} x${qty}ç‚¹`);
              
              // å•†å“ã”ã¨ã®é‡‘é¡ã‚’è¨ˆç®—ï¼ˆãƒˆãƒƒãƒ”ãƒ³ã‚°è¾¼ã¿ï¼‰
              const basePrice = item.price || 0;
              const toppingPrice = item.toppingPrice || 0;
              const totalPrice = basePrice + toppingPrice;
              const itemTotal = totalPrice * qty;
              
              // å•†å“ã®taxRateãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä½¿ç”¨ï¼ˆå„ªå…ˆï¼‰
              const itemTaxRate = item.taxRate;
              
              if (itemTaxRate) {
                // å•†å“ã«taxRateãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
                if (itemTaxRate === 8) {
                  tax8Total += itemTotal;
                } else if (itemTaxRate === 10) {
                  tax10Total += itemTotal;
                }
                console.log(`  â†’ ${item.name} x${qty}ç‚¹ (ç¨ç‡: ${itemTaxRate}%)`);
              } else {
                // taxRateãŒãªã„å ´åˆã¯å¾“æ¥ã®åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯
                const tableNumber = orderData.tableNumber || '';
                const itemName = item.name || '';
                
                // ã€10%ã€‘åº—å†…ãƒ†ãƒ¼ãƒ–ãƒ«: c1, c2, T-M, T-H ã®ã¿
                if (tableNumber.match(/^(c1|c2|T-M|T-H)$/)) {
                  tax10Total += itemTotal;
                }
                // ã€10%ã€‘ãƒ¬ã‚¸è¢‹
                else if (itemName.includes('ãƒ¬ã‚¸è¢‹') || itemName.includes('è¢‹')) {
                  tax10Total += itemTotal;
                }
                // ã€8%ã€‘å³ä¼šè¨ˆã€ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã€äºˆç´„ãªã©
                else {
                  tax8Total += itemTotal;
                }
                console.log(`  â†’ ${item.name} x${qty}ç‚¹`);
              }
            });
          } else {
            // itemsãŒãªã„å ´åˆã¯1ç‚¹ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ
            itemCount = 1;
            console.log('  â†’ æ³¨æ–‡å…¨ä½“ã‚’1ç‚¹ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ');
          }
          
          // ãƒ¬ã‚¸è¢‹ã‚‚ã‚«ã‚¦ãƒ³ãƒˆ
          if (orderData.bagNeeded && orderData.bagQuantity > 0) {
            itemCount += orderData.bagQuantity;
            const bagTotal = orderData.bagPrice || (orderData.bagQuantity * 3);
            tax10Total += bagTotal;
            console.log(`  â†’ ãƒ¬ã‚¸è¢‹ x${orderData.bagQuantity}ç‚¹ (10%å¯¾è±¡)`);
          }
          
          console.log('ğŸ“¦ å•†å“ç‚¹æ•°:', itemCount);
          console.log('ğŸ’° ç¨ç‡åˆ¥å£²ä¸Š:', { tax8Total, tax10Total });
          
          // æ—¥æ¬¡å£²ä¸Šã‚’æ›´æ–°ï¼ˆå•†å“ç‚¹æ•°ã®ã¿ã€å£²ä¸Šé‡‘é¡ãƒ»ç¨é‡‘ãƒ»å€¤å¼•ããƒ»å®¢æ•°ã¯ä»–ã§è¨˜éŒ²æ¸ˆã¿ï¼‰
          const paymentMethod = orderData.paymentMethod || 'cash';
          
          console.log('ğŸ’¾ å•†å“ç‚¹æ•°ã®ã¿æ›´æ–°ä¸­...');
          console.log('  - itemCount:', itemCount);
          await updateDailySales(0, paymentMethod, itemCount, 0, 0, 0, 0);
          console.log('âœ… å•†å“ç‚¹æ•°æ›´æ–°å®Œäº†');
        } else {
          console.log('âš ï¸ æœªä¼šè¨ˆã¾ãŸã¯æ—¢ã«å‰Šé™¤æ¸ˆã¿ã®æ³¨æ–‡ã®ãŸã‚ã‚«ã‚¦ãƒ³ãƒˆã—ã¾ã›ã‚“');
        }
        
        // deleteDocã§ã¯ãªãdeletedãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
        console.log('updateDocå®Ÿè¡Œä¸­...');
        await window.updateDoc(orderRef, {
          deleted: true,
          deletedAt: window.Timestamp.now()
        });
        console.log('updateDocæˆåŠŸ');
        
        console.log('loadOrderså®Ÿè¡Œä¸­...');
        await loadOrders(selectedTable);
        console.log('loadOrderså®Œäº†');
      } catch (e) {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e);
        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', e.message, e.code);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // æ”¯æ‰•ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showPaymentModal = async function() {
      console.log('ğŸ”µ showPaymentModalé–‹å§‹');
      console.log('  currentOrders.length:', currentOrders.length);
      console.log('  currentOrders:', currentOrders);
      
      if (currentOrders.length === 0) {
        alert('ä¼šè¨ˆã™ã‚‹æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’å†èª­ã¿è¾¼ã¿ï¼ˆæœ€æ–°ã®ç¨ç‡è¨­å®šã‚’å–å¾—ï¼‰
      if (selectedTable && selectedTable !== 'å³ä¼šè¨ˆ' && selectedTable !== 'å…¨ãƒ†ãƒ¼ãƒ–ãƒ«') {
        currentTableSettings = await getTableSettings(selectedTable);
        console.log('ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’å†èª­ã¿è¾¼ã¿:', selectedTable);
        console.log('  taxRule:', currentTableSettings?.taxRule || 'ãªã—');
        console.log('  è¨­å®šå…¨ä½“:', currentTableSettings);
      }
      
      // å€¤å¼•ãé‡‘é¡ã‚’åˆæœŸåŒ–
      document.getElementById('discountAmount').value = '0';
      
      // ç¨ç‡é¸æŠãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
      buildTaxRateSelectionList();
      
      // è«‹æ±‚é¡ã‚’è¡¨ç¤º
      updatePaymentTotal();
      
      document.getElementById('paymentModal').classList.remove('hidden');
      selectedPaymentMethod = null;
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('completePaymentBtn').disabled = true;
    };
    
    // ç¨ç‡é¸æŠãƒªã‚¹ãƒˆã‚’æ§‹ç¯‰
    
    // ğŸ”§ æ—§ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã«åŸºã¥ã„ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡ã‚’æ±ºå®šï¼ˆå»ƒæ­¢äºˆå®šï¼‰
    // æ–°ã—ã„ãƒ­ã‚¸ãƒƒã‚¯ã§ã¯ã€getApplicableTaxRate()ã‚’ä½¿ç”¨ã—ã¦ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã¨foodTypeã‹ã‚‰ç¨ç‡ã‚’æ±ºå®š
    function determineDefaultTaxRate(tableNumber) {
      // å³ä¼šè¨ˆã€ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã€ãƒ¢ãƒã‚¤ãƒ«ã‚ªãƒ¼ãƒ€ãƒ¼ã€äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã€äºˆç´„ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã€äºˆç´„ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ2: 8%
      if (tableNumber === 'å³ä¼šè¨ˆ' || tableNumber === 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ' || tableNumber === 'ãƒ¢ãƒã‚¤ãƒ«ã‚ªãƒ¼ãƒ€ãƒ¼' || tableNumber === 'äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ«' || tableNumber === 'äºˆç´„ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ' || tableNumber === 'äºˆç´„ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ2') {
        return 8;
      }
      // c1, c2, T-M, T-H: 10%
      if (tableNumber === 'c1' || tableNumber === 'c2' || tableNumber === 'T-M' || tableNumber === 'T-H') {
        return 10;
      }
      // ãã‚Œä»¥å¤–ã®ãƒ†ãƒ¼ãƒ–ãƒ«: 10%ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
      return 10;
    }
    
    function buildTaxRateSelectionList() {
      const container = document.getElementById('taxRateItemsList');
      container.innerHTML = '';
      
      console.log('ğŸ”µ buildTaxRateSelectionListé–‹å§‹');
      console.log('currentOrders:', currentOrders);
      console.log('currentOrders.length:', currentOrders.length);
      console.log('ğŸ”§ currentTableSettings:', currentTableSettings);
      console.log('  taxRule:', currentTableSettings?.taxRule || 'ãªã—');
      
      if (!container) {
        console.error('âŒ taxRateItemsListã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      if (currentOrders.length === 0) {
        console.warn('âŒ currentOrdersãŒç©ºã§ã™');
        container.innerHTML = '<div style="padding: 15px; text-align: center; color: #666;">æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      let itemIndex = 0;
      
      currentOrders.forEach((order, orderIdx) => {
        console.log(`ğŸ“¦ æ³¨æ–‡${orderIdx}:`, order);
        if (!order.items || !Array.isArray(order.items) || order.items.length === 0) {
          // itemsãŒãªã„å ´åˆã¯æ³¨æ–‡å…¨ä½“ã¨ã—ã¦è¡¨ç¤º
          const orderTotal = order.totalAmount || 0;
          console.log(`  æ³¨æ–‡å…¨ä½“ã¨ã—ã¦è¿½åŠ : #${order.orderNumber}, é‡‘é¡:${orderTotal}`);
          
          // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã¨ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã«åŸºã¥ã„ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡ã‚’æ±ºå®š
          let defaultTaxRate = 10;
          if (currentTableSettings && currentTableSettings.taxRule && currentTableSettings.taxRule !== 'none') {
            // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãŒã‚ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
            if (currentTableSettings.taxRule === 'takeout') {
              defaultTaxRate = 8;
            } else if (currentTableSettings.taxRule === 'dine-in') {
              defaultTaxRate = 10;
            } else {
              // ä¸æ˜ãªtaxRuleã®å ´åˆã¯10%ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã™ã‚‹
              defaultTaxRate = 10;
            }
            console.log(`  ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šé©ç”¨: taxRule=${currentTableSettings.taxRule} â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡=${defaultTaxRate}%`);
          } else {
            // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãŒãªã„å ´åˆã¯æ—§ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨
            defaultTaxRate = determineDefaultTaxRate(order.tableNumber);
            console.log(`  æ—§ãƒ­ã‚¸ãƒƒã‚¯é©ç”¨: tableNumber=${order.tableNumber} â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡=${defaultTaxRate}%`);
          }
          
          addTaxRateItem(container, `æ³¨æ–‡ #${order.orderNumber}`, 1, orderTotal, itemIndex, defaultTaxRate);
          itemIndex++;
        } else {
          // å„å•†å“ã‚’è¡¨ç¤º
          order.items.forEach((item, itemIdx) => {
            // ğŸ†• å¤–ç¨ã®å ´åˆã¯æœ¬ä½“ä¾¡æ ¼ã¨ã—ã¦æ‰±ã†ï¼ˆtaxTypeãŒexclusiveã®å ´åˆã€item.priceã¯æœ¬ä½“ä¾¡æ ¼ï¼‰
            // å†…ç¨ã®å ´åˆã¯item.priceãŒç¨è¾¼ä¾¡æ ¼ãªã®ã§ã€ãã®ã¾ã¾ä½¿ç”¨
            const itemBasePrice = item.price + (item.toppingPrice || 0);
            const itemTotal = itemBasePrice * (item.quantity || 1);
            console.log(`  å•†å“è¿½åŠ : ${item.name} x${item.quantity}, æœ¬ä½“ä¾¡æ ¼:${itemTotal}, taxType:${item.taxType}`);
            
            // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã¨foodTypeã«åŸºã¥ã„ã¦ç¨ç‡ã‚’æ±ºå®š
            const defaultTaxRate = getApplicableTaxRate(item, currentTableSettings);
            console.log(`  âœ… é©ç”¨ç¨ç‡: ${defaultTaxRate}% (foodType: ${item.foodType || 'food'}, taxRule: ${currentTableSettings?.taxRule || 'none'})`);
            
            // ğŸ†• taxTypeã‚’æ¸¡ã™
            addTaxRateItem(container, item.name, item.quantity, itemTotal, itemIndex, defaultTaxRate, item.taxType || 'inclusive');
            itemIndex++;
          });
          
          // ãƒ¬ã‚¸è¢‹ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯10%ï¼‰
          if (order.bagNeeded && order.bagQuantity > 0) {
            const bagTotal = order.bagPrice || (order.bagQuantity * 3);
            console.log(`  ãƒ¬ã‚¸è¢‹è¿½åŠ : ${order.bagQuantity}æš, é‡‘é¡:${bagTotal}`);
            addTaxRateItem(container, 'ğŸ›ï¸ ãƒ¬ã‚¸è¢‹', order.bagQuantity, bagTotal, itemIndex, 10);
            itemIndex++;
          }
        }
      });
      
      console.log(`âœ… ç¨ç‡é¸æŠé …ç›®ã‚’${itemIndex}å€‹ç”Ÿæˆã—ã¾ã—ãŸ`);
      calculateTaxSummary();
    }
    
    // ç¨ç‡é¸æŠé …ç›®ã‚’è¿½åŠ 
    function addTaxRateItem(container, itemName, quantity, itemTotal, index, defaultTaxRate = 10, taxType = 'inclusive') {
      console.log(`  addTaxRateItem: ${itemName}, æ•°é‡:${quantity}, é‡‘é¡:${itemTotal}, index:${index}, ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆç¨ç‡:${defaultTaxRate}%, ç¨ã‚¿ã‚¤ãƒ—:${taxType}`);
      
      // ğŸ†• å¤–ç¨ã®å ´åˆã¯ç¨è¾¼ä¾¡æ ¼ã‚’è¨ˆç®—ï¼ˆitemTotalã¯æœ¬ä½“ä¾¡æ ¼ï¼‰
      let displayTotal = itemTotal;
      if (taxType === 'exclusive') {
        // å¤–ç¨ã®å ´åˆã€itemTotalã¯æœ¬ä½“ä¾¡æ ¼ãªã®ã§ç¨ã‚’åŠ ç®—
        displayTotal = itemTotal + Math.floor(itemTotal * (defaultTaxRate / 100));
        console.log(`  ğŸ†• å¤–ç¨è¨ˆç®—: æœ¬ä½“${itemTotal}å†† + ç¨${Math.floor(itemTotal * (defaultTaxRate / 100))}å†† â†’ ${displayTotal}å††ï¼ˆç¨ç‡${defaultTaxRate}%ï¼‰`);
      }
      
      const itemDiv = document.createElement('div');
      itemDiv.style.cssText = 'padding: 10px; margin-bottom: 8px; background: white; border-radius: 6px; border: 1px solid #ddd;';
      
      const headerDiv = document.createElement('div');
      headerDiv.style.cssText = 'display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; font-size: 14px; cursor: pointer;';
      headerDiv.innerHTML = `
        <span>${itemName} Ã—${quantity}</span>
        <span style="color: #667eea;" id="itemPrice${index}">Â¥${displayTotal.toLocaleString()}</span>
      `;
      
      // å•†å“è¡Œã‚’ã‚¯ãƒªãƒƒã‚¯ã§é‡‘é¡ç·¨é›†
      headerDiv.onclick = function() {
        // ã‚«ã‚¹ã‚¿ãƒ é‡‘é¡å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        document.getElementById('priceChangeTitle').textContent = `${itemName} Ã—${quantity}`;
        document.getElementById('priceChangeItemInfo').textContent = `ã‚½ãƒ¼ã‚¹ Ã—${quantity} ã®é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`;
        document.getElementById('priceChangeCurrentPrice').textContent = `Â¥${displayTotal.toLocaleString()}`;  // ğŸ†• displayTotalã‚’ä½¿ç”¨
        document.getElementById('priceChangeInput').value = displayTotal;  // ğŸ†• displayTotalã‚’ä½¿ç”¨
        document.getElementById('priceChangeItemId').value = index;
        document.getElementById('priceChangeModal').classList.remove('hidden');
        
        // å…¥åŠ›æ¬„ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹
        setTimeout(() => {
          const input = document.getElementById('priceChangeInput');
          input.focus();
          input.select();
        }, 100);
      };
      
      itemDiv.appendChild(headerDiv);
      
      const radioDiv = document.createElement('div');
      radioDiv.style.cssText = 'display: flex; gap: 10px; justify-content: center;';
      
      // 8%ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³
      const label8 = document.createElement('label');
      label8.style.cssText = 'flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 6px 10px; border-radius: 4px; background: #fff3e0; border: 2px solid #FF9800; font-size: 13px;';
      const radio8 = document.createElement('input');
      radio8.type = 'radio';
      radio8.name = `taxRate${index}`;
      radio8.value = '8';
      radio8.checked = (defaultTaxRate === 8);
      radio8.dataset.amount = displayTotal;  // ğŸ†• displayTotalã‚’ä½¿ç”¨
      radio8.dataset.taxType = taxType;  // ğŸ†• taxTypeã‚’ä¿å­˜
      radio8.dataset.baseAmount = itemTotal;  // ğŸ†• æœ¬ä½“ä¾¡æ ¼ã‚’ä¿å­˜
      radio8.dataset.index = index;
      radio8.style.cssText = 'margin-right: 5px; width: 18px; height: 18px;';
      radio8.onchange = function() {
        // ğŸ†• å¤–ç¨ã®å ´åˆã¯ç¨ç‡å¤‰æ›´æ™‚ã«é‡‘é¡ã‚’å†è¨ˆç®—
        if (taxType === 'exclusive') {
          const newAmount = parseInt(radio8.dataset.baseAmount) + Math.floor(parseInt(radio8.dataset.baseAmount) * 0.08);
          radio8.dataset.amount = newAmount;
          radio10.dataset.amount = newAmount;  // ä¸¡æ–¹ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®amountã‚’æ›´æ–°
          document.getElementById('itemPrice' + index).textContent = 'Â¥' + newAmount.toLocaleString();
          console.log(`  ğŸ”„ å¤–ç¨8%ã«å¤‰æ›´: ${radio8.dataset.baseAmount}å†† â†’ ${newAmount}å††`);
        }
        calculateTaxSummary();
      };
      label8.appendChild(radio8);
      label8.appendChild(document.createTextNode('8%æŒã¡å¸°ã‚Š'));
      
      // 10%ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³
      const label10 = document.createElement('label');
      label10.style.cssText = 'flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; padding: 6px 10px; border-radius: 4px; background: #e3f2fd; border: 2px solid #2196F3; font-size: 13px;';
      const radio10 = document.createElement('input');
      radio10.type = 'radio';
      radio10.name = `taxRate${index}`;
      radio10.value = '10';
      radio10.checked = (defaultTaxRate === 10);
      radio10.dataset.amount = displayTotal;  // ğŸ†• displayTotalã‚’ä½¿ç”¨
      radio10.dataset.taxType = taxType;  // ğŸ†• taxTypeã‚’ä¿å­˜
      radio10.dataset.baseAmount = itemTotal;  // ğŸ†• æœ¬ä½“ä¾¡æ ¼ã‚’ä¿å­˜
      radio10.dataset.index = index;
      radio10.style.cssText = 'margin-right: 5px; width: 18px; height: 18px;';
      radio10.onchange = function() {
        // ğŸ†• å¤–ç¨ã®å ´åˆã¯ç¨ç‡å¤‰æ›´æ™‚ã«é‡‘é¡ã‚’å†è¨ˆç®—
        if (taxType === 'exclusive') {
          const newAmount = parseInt(radio10.dataset.baseAmount) + Math.floor(parseInt(radio10.dataset.baseAmount) * 0.10);
          radio10.dataset.amount = newAmount;
          radio8.dataset.amount = newAmount;  // ä¸¡æ–¹ã®ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®amountã‚’æ›´æ–°
          document.getElementById('itemPrice' + index).textContent = 'Â¥' + newAmount.toLocaleString();
          console.log(`  ğŸ”„ å¤–ç¨10%ã«å¤‰æ›´: ${radio10.dataset.baseAmount}å†† â†’ ${newAmount}å††`);
        }
        calculateTaxSummary();
      };
      label10.appendChild(radio10);
      label10.appendChild(document.createTextNode('10%åº—å†…'));
      
      console.log(`    ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ç”Ÿæˆ: taxRate${index}, 8%=${radio8.checked}, 10%=${radio10.checked}, amount=${displayTotal}`);
      
      radioDiv.appendChild(label8);
      radioDiv.appendChild(label10);
      itemDiv.appendChild(radioDiv);
      
      container.appendChild(itemDiv);
    }
    
    // ç¨ç‡åˆ¥é›†è¨ˆã‚’è¨ˆç®—
    function calculateTaxSummary() {
      let tax8Total = 0;
      let tax10Total = 0;
      
      const radios = document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked');
      radios.forEach(radio => {
        const amount = parseFloat(radio.dataset.amount) || 0;
        if (radio.value === '8') {
          tax8Total += amount;
        } else if (radio.value === '10') {
          tax10Total += amount;
        }
      });
      
      document.getElementById('tax8Summary').textContent = 'Â¥' + tax8Total.toLocaleString();
      document.getElementById('tax10Summary').textContent = 'Â¥' + tax10Total.toLocaleString();
      
      // è«‹æ±‚é¡ã‚‚æ›´æ–°
      updatePaymentTotal();
    }
    
    // å€¤å¼•ãå¾Œã®è«‹æ±‚é¡ã‚’æ›´æ–°
    window.updatePaymentTotal = function() {
      // ç·¨é›†ã•ã‚ŒãŸé‡‘é¡ã‚’å…¨ã¦åˆè¨ˆï¼ˆãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®data-amountã‹ã‚‰å–å¾—ï¼‰
      let total = 0;
      const radios = document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked');
      radios.forEach(radio => {
        total += parseFloat(radio.dataset.amount) || 0;
      });
      
      const discount = parseInt(document.getElementById('discountAmount').value) || 0;
      const finalAmount = Math.max(0, total - discount);
      totalAmountToPay = finalAmount;
      
      document.getElementById('finalPaymentAmount').textContent = 'Â¥' + finalAmount.toLocaleString();
      
      // ç¾é‡‘ã®å ´åˆã¯ãŠã¤ã‚Šè¨ˆç®—ã‚‚æ›´æ–°
      if (selectedPaymentMethod === 'cash') {
        calculateChange();
      }
    };
    
    // æ”¯æ‰•ã„æ–¹æ³•é¸æŠ
    window.selectPaymentMethod = function(method) {
      selectedPaymentMethod = method;
      
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');
      
      if (method === 'cash') {
        document.getElementById('cashInputSection').classList.remove('hidden');
        document.getElementById('completePaymentBtn').disabled = true;
      } else {
        document.getElementById('cashInputSection').classList.add('hidden');
        document.getElementById('completePaymentBtn').disabled = false;
      }
    };
    
    // ãŠã¤ã‚Šè¨ˆç®—
    window.calculateChange = function() {
      cashReceived = parseInt(document.getElementById('cashReceived').value) || 0;
      
      // å€¤å¼•ãå¾Œã®é‡‘é¡ã‚’ä½¿ç”¨
      changeAmount = cashReceived - totalAmountToPay;
      
      document.getElementById('changeAmount').textContent = `Â¥${changeAmount.toLocaleString()}`;
      
      document.getElementById('completePaymentBtn').disabled = cashReceived < totalAmountToPay;
    };
    
    // ä¼šè¨ˆå®Œäº†
    window.completePayment = async function() {
      console.log('ğŸŸ¢ completePaymenté–‹å§‹');
      
      if (!selectedPaymentMethod) {
        alert('æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      if (selectedPaymentMethod === 'cash' && cashReceived < totalAmountToPay) {
        alert('ãŠé ã‹ã‚Šé‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
        return;
      }
      
      console.log('âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é€šéã€‚ç¨ç‡èª­ã¿å–ã‚Šé–‹å§‹');
      
      // æ‹…å½“è€…ã‚’å–å¾—ï¼ˆæœªé¸æŠã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
      const staffSelect = document.getElementById('staffSelect');
      const staffName = staffSelect.value || 'é«˜ç”°';
      
      try {
        const now = window.Timestamp.now();
        
        // æ³¨æ–‡ç•ªå·ãƒªã‚¹ãƒˆã‚’å–å¾—
        const orderNumbers = currentOrders.map(o => o.orderNumber);
        
        // âœ… å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ã‹ã©ã†ã‹ã‚’ç¢ºèªï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’ä½¿ç”¨ï¼‰
        const isDirectPayment = isDirectPaymentMode;
        console.log('ğŸ’³ å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰åˆ¤å®š:', isDirectPayment);
        
        // å…¨ã¦ã®æ³¨æ–‡ã«æ”¯æ‰•ã„æ¸ˆã¿ãƒ•ãƒ©ã‚°ã¨æ‹…å½“è€…ã‚’è¨­å®š
        for (const order of currentOrders) {
          // ğŸ“ ç·¨é›†ã•ã‚ŒãŸé‡‘é¡ã¨taxRateã‚’æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã«åæ˜ 
          let orderItemIndex = 0;
          const updatedItems = [];
          
          if (order.items && Array.isArray(order.items) && order.items.length > 0) {
            // å„å•†å“ã®ç·¨é›†ã•ã‚ŒãŸé‡‘é¡ã¨taxRateã‚’å–å¾—
            order.items.forEach(item => {
              const radio = document.querySelector(`input[name="taxRate${orderItemIndex}"]:checked`);
              const taxRate = radio ? parseInt(radio.value) : 10;
              const editedTotalPrice = radio ? parseFloat(radio.dataset.amount) : ((item.price + (item.toppingPrice || 0)) * item.quantity);
              
              // å˜ä¾¡ã‚’è¨ˆç®—ï¼ˆç·¨é›†ã•ã‚ŒãŸåˆè¨ˆé‡‘é¡ / æ•°é‡ï¼‰
              const editedUnitPrice = editedTotalPrice / item.quantity;
              
              updatedItems.push({
                ...item,
                price: editedUnitPrice - (item.toppingPrice || 0), // ãƒˆãƒƒãƒ”ãƒ³ã‚°ä¾¡æ ¼ã‚’å¼•ã„ãŸåŸºæœ¬ä¾¡æ ¼
                taxRate: taxRate,
                takeout: taxRate === 8 // 8%ãªã‚‰æŒã¡å¸°ã‚Šã€10%ãªã‚‰åº—å†…
              });
              
              orderItemIndex++;
            });
          }
          
          // ç·¨é›†ã•ã‚ŒãŸåˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
          let editedTotalAmount = 0;
          if (order.items && Array.isArray(order.items) && order.items.length > 0) {
            updatedItems.forEach((item, idx) => {
              const radio = document.querySelector(`input[name="taxRate${idx}"]:checked`);
              const editedPrice = radio ? parseFloat(radio.dataset.amount) : ((item.price + (item.toppingPrice || 0)) * item.quantity);
              editedTotalAmount += editedPrice;
            });
            
            // ãƒ¬ã‚¸è¢‹ã‚‚åŠ ç®—
            if (order.bagNeeded && order.bagQuantity > 0) {
              const bagRadio = document.querySelector(`input[name="taxRate${orderItemIndex}"]:checked`);
              const bagPrice = bagRadio ? parseFloat(bagRadio.dataset.amount) : (order.bagQuantity * 3);
              editedTotalAmount += bagPrice;
            }
          } else {
            // itemsãŒãªã„å ´åˆã¯æ³¨æ–‡å…¨ä½“ã®ç·¨é›†é¡ã‚’ä½¿ç”¨
            const radio = document.querySelector(`input[name="taxRate0"]:checked`);
            editedTotalAmount = radio ? parseFloat(radio.dataset.amount) : (order.totalAmount || 0);
          }
          
          await window.updateDoc(window.getStoreDoc('orders', order.id), {
            paidAt: now,
            notifiedPaid: true,
            paymentMethod: selectedPaymentMethod,
            staffName: staffName,  // æ‹…å½“è€…åã‚’è¿½åŠ 
            items: updatedItems.length > 0 ? updatedItems : order.items, // ç·¨é›†ã•ã‚ŒãŸå•†å“æƒ…å ±ã‚’ä¿å­˜
            totalAmount: editedTotalAmount // ç·¨é›†ã•ã‚ŒãŸåˆè¨ˆé‡‘é¡ã‚’ä¿å­˜
          });
        }
        
        console.log(isDirectPayment ? 'ğŸ’³ å³ä¼šè¨ˆ: Firebaseæ›´æ–°å®Œäº†' : 'ğŸ’° é€šå¸¸ä¼šè¨ˆ: Firebaseæ›´æ–°å®Œäº†');
        
        // å•†å“ç‚¹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ & é¸æŠã•ã‚ŒãŸç¨ç‡ã§é›†è¨ˆ
        let itemCount = 0;
        let tax8Total = 0;
        let tax10Total = 0;
        
        // é¸æŠã•ã‚ŒãŸç¨ç‡ã‹ã‚‰é›†è¨ˆ
        const radios = document.querySelectorAll('#taxRateItemsList input[type="radio"]:checked');
        console.log('ğŸ“» é¸æŠã•ã‚ŒãŸãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³æ•°:', radios.length);
        
        radios.forEach((radio, idx) => {
          const amount = parseFloat(radio.dataset.amount) || 0;
          const taxRate = radio.value;
          console.log(`ğŸ“» ãƒ©ã‚¸ã‚ª${idx}: ç¨ç‡=${taxRate}%, é‡‘é¡=${amount}`);
          
          if (taxRate === '8') {
            tax8Total += amount;
          } else if (taxRate === '10') {
            tax10Total += amount;
          }
        });
        
        console.log('ğŸ’° ç¨ç‡åˆ¥é›†è¨ˆçµæœ:', { tax8Total, tax10Total });
        
        // å•†å“ç‚¹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆï¼ˆãƒ¬ã‚¸è¢‹å«ã‚€ï¼‰
        currentOrders.forEach(order => {
          if (!order.items || !Array.isArray(order.items) || order.items.length === 0) {
            itemCount += 1;
          } else {
            order.items.forEach(item => {
              itemCount += item.quantity || 0;
            });
          }
          
          // ãƒ¬ã‚¸è¢‹ã‚‚ã‚«ã‚¦ãƒ³ãƒˆ
          if (order.bagNeeded && order.bagQuantity > 0) {
            itemCount += order.bagQuantity;
            console.log(`  ãƒ¬ã‚¸è¢‹ã‚’å•†å“ç‚¹æ•°ã«è¿½åŠ : ${order.bagQuantity}æš`);
          }
        });
        
        console.log('ğŸ“¦ ä¼šè¨ˆå•†å“ç‚¹æ•°:', itemCount);
        console.log('ğŸ’° ç¨ç‡åˆ¥å£²ä¸Š:', { tax8Total, tax10Total });
        
        // ãƒ‡ãƒãƒƒã‚°: å•†å“ç‚¹æ•°ãŒ0ã®å ´åˆã¯ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°ã®ã¿
        if (itemCount === 0) {
          console.warn('âš ï¸ å•†å“ç‚¹æ•°ãŒ0ã§ã™ï¼ currentOrders: ' + currentOrders.length + 'ä»¶');
          console.error('currentOrders:', currentOrders);
        } else {
          console.log('âœ… å•†å“ç‚¹æ•°ã‚«ã‚¦ãƒ³ãƒˆæˆåŠŸ:', itemCount + 'ç‚¹');
        }
        
        // å…ƒã®åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—ï¼ˆå€¤å¼•ãå‰ï¼‰
        let originalTotal = 0;
        currentOrders.forEach(order => {
          originalTotal += order.totalAmount || 0;
        });
        
        // å€¤å¼•ãé‡‘é¡ã‚’å–å¾—
        const discountAmount = parseInt(document.getElementById('discountAmount').value) || 0;
        console.log('ğŸ’¸ å…ƒã®é‡‘é¡:', originalTotal);
        console.log('ğŸ’¸ å€¤å¼•ãé‡‘é¡:', discountAmount);
        console.log('ğŸ’¸ å€¤å¼•ãå¾Œé‡‘é¡:', totalAmountToPay);
        
        console.log('ğŸ“Š å£²ä¸Šé‡‘é¡ãƒ»å®¢æ•°ã¯ä¼šè¨ˆæ™‚ã€å•†å“ç‚¹æ•°ã¯å‰Šé™¤æ™‚ã«ã‚«ã‚¦ãƒ³ãƒˆã—ã¾ã™');
        console.log('  - totalAmount:', totalAmountToPay);
        console.log('  - paymentMethod:', selectedPaymentMethod);
        console.log('  - itemCount: 0ï¼ˆå‰Šé™¤æ™‚ã«ã‚«ã‚¦ãƒ³ãƒˆï¼‰');
        console.log('  - customerCountIncrement: 1ï¼ˆä¼šè¨ˆæ™‚ã«ã‚«ã‚¦ãƒ³ãƒˆï¼‰');
        console.log('  - tax8Total:', tax8Total);
        console.log('  - tax10Total:', tax10Total);
        console.log('  - discountAmount:', discountAmount);
        
        // å•†å“ãƒªã‚¹ãƒˆã‚’ä½œæˆï¼ˆitemCountsä¿å­˜ç”¨ï¼‰
        const allItems = [];
        currentOrders.forEach(order => {
          if (order.items && Array.isArray(order.items)) {
            order.items.forEach(item => {
              allItems.push({
                name: item.name,
                quantity: item.quantity || 1
              });
            });
          }
          // ãƒ¬ã‚¸è¢‹ã‚‚å•†å“ã¨ã—ã¦è¿½åŠ 
          if (order.bagNeeded && order.bagQuantity > 0) {
            allItems.push({
              name: 'ãƒ¬ã‚¸è¢‹',
              quantity: order.bagQuantity
            });
          }
        });
        
        console.log('ğŸ›’ å•†å“ãƒªã‚¹ãƒˆï¼ˆitemCountsç”¨ï¼‰:', allItems);
        
        // â˜… å£²ä¸Šé‡‘é¡ãƒ»å®¢æ•°ãƒ»å€¤å¼•ãã‚’è¨˜éŒ² â˜…
        // å³ä¼šè¨ˆã®å ´åˆã¯ä¼šè¨ˆæ™‚ã«å•†å“ç‚¹æ•°ã‚‚ã‚«ã‚¦ãƒ³ãƒˆã€é€šå¸¸ä¼šè¨ˆã¯å‰Šé™¤æ™‚ã«ã‚«ã‚¦ãƒ³ãƒˆã™ã‚‹ãŸã‚0ã‚’æ¸¡ã™
        const itemCountToRecord = isDirectPayment ? itemCount : 0;
        console.log(`ğŸ“¦ å£²ä¸Šè¨˜éŒ²ã™ã‚‹å•†å“ç‚¹æ•°: ${itemCountToRecord}ç‚¹ (å³ä¼šè¨ˆ: ${isDirectPayment})`);
        await updateDailySales(totalAmountToPay, selectedPaymentMethod, itemCountToRecord, tax8Total, tax10Total, discountAmount, 1, allItems);
        
        // å•†å“ãƒªã‚¹ãƒˆã‚’ç¨ç‡æƒ…å ±ä»˜ãã§ä½œæˆ
        const itemsWithTaxRate = [];
        let itemIndex = 0;
        
        currentOrders.forEach(order => {
          if (!order.items || !Array.isArray(order.items) || order.items.length === 0) {
            // itemsãŒãªã„å ´åˆ
            const radio = document.querySelector(`input[name="taxRate${itemIndex}"]:checked`);
            const taxRate = radio ? parseInt(radio.value) : 10;
            const editedPrice = radio ? parseFloat(radio.dataset.amount) : (order.totalAmount || 0);
            itemsWithTaxRate.push({
              name: `æ³¨æ–‡ #${order.orderNumber}`,
              quantity: 1,
              price: editedPrice,
              toppings: 'ãªã—',
              taxRate: taxRate,
              taxType: 'inclusive'  // æ—§ãƒ‡ãƒ¼ã‚¿ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å†…ç¨
            });
            itemIndex++;
          } else {
            // å„å•†å“ã‚’è¿½åŠ 
            order.items.forEach(item => {
              const radio = document.querySelector(`input[name="taxRate${itemIndex}"]:checked`);
              const taxRate = radio ? parseInt(radio.value) : 10;
              const editedPrice = radio ? parseFloat(radio.dataset.amount) : ((item.price + (item.toppingPrice || 0)) * item.quantity);
              itemsWithTaxRate.push({
                name: item.name,
                quantity: item.quantity,
                price: editedPrice / item.quantity, // å˜ä¾¡ã«æˆ»ã™
                toppings: item.toppings || 'ãªã—',
                taxRate: taxRate,
                taxType: item.taxType || 'inclusive'  // ğŸ†• taxTypeã‚’ä¿å­˜
              });
              itemIndex++;
            });
            
            // ãƒ¬ã‚¸è¢‹ã‚’è¿½åŠ 
            if (order.bagNeeded && order.bagQuantity > 0) {
              const radio = document.querySelector(`input[name="taxRate${itemIndex}"]:checked`);
              const taxRate = radio ? parseInt(radio.value) : 10;
              const editedPrice = radio ? parseFloat(radio.dataset.amount) : (order.bagQuantity * 3);
              itemsWithTaxRate.push({
                name: 'ğŸ›ï¸ ãƒ¬ã‚¸è¢‹',
                quantity: order.bagQuantity,
                price: editedPrice / order.bagQuantity, // å˜ä¾¡ã«æˆ»ã™
                toppings: 'ãªã—',
                taxRate: taxRate,
                taxType: 'inclusive'  // ãƒ¬ã‚¸è¢‹ã¯å†…ç¨
              });
              itemIndex++;
            }
          }
        });
        
        // æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·ç”¨ï¼‰
        lastPaymentData = {
          tableNumber: selectedTable,
          orderNumbers: orderNumbers,
          items: itemsWithTaxRate,
          totalAmount: totalAmountToPay,
          discountAmount: discountAmount,
          paymentMethod: selectedPaymentMethod,
          cashReceived: selectedPaymentMethod === 'cash' ? cashReceived : totalAmountToPay,
          change: selectedPaymentMethod === 'cash' ? changeAmount : 0,
          timestamp: new Date(),
          staffName: staffName  // æ‹…å½“è€…åã‚’è¿½åŠ 
        };
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closePaymentModal();
        
        // âœ… å³ä¼šè¨ˆã®å ´åˆã¯manualCartã‚’ã‚¯ãƒªã‚¢ & æ³¨æ–‡ã‚’å®Œäº†â†’å‰Šé™¤
        if (isDirectPayment) {
          console.log('ğŸ’³ å³ä¼šè¨ˆå®Œäº†: ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢ & æ³¨æ–‡ã‚’å®Œäº†â†’å‰Šé™¤');
          console.log('ğŸ’³ å‰Šé™¤å¯¾è±¡ã®æ³¨æ–‡æ•°:', currentOrders.length);
          
          // ğŸ†• å³ä¼šè¨ˆã®å ´åˆã¯åœ¨åº«ã‚’æ¸›ã‚‰ã™
          console.log('ğŸ“¦ å³ä¼šè¨ˆ: åœ¨åº«ã‚’æ¸›ã‚‰ã—ã¾ã™');
          for (const order of currentOrders) {
            if (order.items && Array.isArray(order.items)) {
              await decreaseInventoryFromMenuSettings(order.items);
            }
          }
          
          manualCart = [];
          updateManualCart();
          
          // å³ä¼šè¨ˆã®æ³¨æ–‡ã‚’å®Œäº†â†’å‰Šé™¤
          for (const order of currentOrders) {
            console.log('ğŸ’³ æ³¨æ–‡ã‚’ç¢ºèª:', {
              id: order.id,
              orderNumber: order.orderNumber,
              tableNumber: order.tableNumber,
              directPayment: order.directPayment
            });
            
            if (order.id) {
              try {
                console.log('âœ… å³ä¼šè¨ˆæ³¨æ–‡ã‚’å®Œäº†ã«ã—ã¾ã™:', order.id);
                
                const orderRef = window.getStoreDoc('orders', order.id);
                
                // 1. å®Œäº†ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                await window.updateDoc(orderRef, {
                  completedAt: window.Timestamp.now()
                });
                
                console.log('âœ… å³ä¼šè¨ˆæ³¨æ–‡ã‚’å®Œäº†ã—ã¾ã—ãŸ:', order.id);
                
                // 2. å¾…ã¡äººæ•°ã‚’1æ¸›ã‚‰ã™
                try {
                  const waitingRef = window.getStoreDoc('settings', 'waiting');
                  const waitingDoc = await window.getDoc(waitingRef);
                  
                  if (waitingDoc.exists()) {
                    const currentCount = waitingDoc.data().manualCount || 0;
                    if (currentCount > 0) {
                      await window.updateDoc(waitingRef, {
                        manualCount: currentCount - 1,
                        updatedAt: window.Timestamp.now()
                      });
                      console.log('ğŸ“‰ å³ä¼šè¨ˆ: å¾…ã¡äººæ•°ã‚’æ¸›ã‚‰ã—ã¾ã—ãŸ:', currentCount, 'â†’', currentCount - 1);
                    }
                  }
                } catch (err) {
                  console.error('å¾…ã¡äººæ•°æ›´æ–°ã‚¨ãƒ©ãƒ¼:', err);
                }
                
                // 3. å‰Šé™¤ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
                await window.updateDoc(orderRef, {
                  deleted: true,
                  deletedAt: window.Timestamp.now()
                });
                
                console.log('ğŸ—‘ï¸ å³ä¼šè¨ˆæ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ:', order.id);
              } catch (err) {
                console.error('âŒ å³ä¼šè¨ˆæ³¨æ–‡å‡¦ç†ã‚¨ãƒ©ãƒ¼:', order.id, err);
                console.error('âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°:', err.message);
              }
            } else {
              console.error('âŒ æ³¨æ–‡IDãŒå­˜åœ¨ã—ã¾ã›ã‚“:', order);
            }
          }
          
          currentOrders = [];
        }
        
        // è‡ªå‹•å°åˆ·ãŒæœ‰åŠ¹ãªã‚‰å°åˆ·
        if (autoPrintEnabled) {
          await printReceipt();
        } else {
          // ãƒ¬ã‚·ãƒ¼ãƒˆå®Œäº†ç”»é¢ã‚’è¡¨ç¤º
          document.getElementById('receiptCompleteModal').classList.remove('hidden');
        }
        
        // è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢ï¼ˆå³ä¼šè¨ˆã®å ´åˆã¯ä½•ã‚‚ã—ãªã„ï¼‰
        if (!isDirectPayment) {
          await loadOrders(selectedTable);
          // æ–°UIã®ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°ã‚‚å†èª­ã¿è¾¼ã¿
          if (currentSelectedTableId) {
            await loadTableOrders(currentSelectedTableId);
          }
        }
        
        // å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
        if (isDirectPayment) {
          isDirectPaymentMode = false;
          console.log('ğŸ’³ å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰: OFF');
        }
        
      } catch (e) {
        console.error('ä¼šè¨ˆã‚¨ãƒ©ãƒ¼:', e);
        alert('ä¼šè¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
        
        // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ãƒªã‚»ãƒƒãƒˆ
        isDirectPaymentMode = false;
      }
    };
    
    // æ”¯æ‰•ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
      document.getElementById('cashReceived').value = '';
      calculateChange();
    };
    
    // ãŠä¼šè¨ˆä¼ç¥¨å°åˆ·ï¼ˆ58mmå¹…å¯¾å¿œï¼‰
    window.printBill = async function() {
      console.log('ğŸ–¨ï¸ printBillé–¢æ•°ãŒå‘¼ã°ã‚Œã¾ã—ãŸ');
      const tableNumber = document.getElementById('tableSelect').value;
      console.log('ğŸ“‹ é¸æŠã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«:', tableNumber);
      if (!tableNumber) {
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        // é¸æŠã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ã®å…¨æ³¨æ–‡ã‚’å–å¾—
        const ordersSnapshot = await window.getDocs(window.getStoreCollection('orders'));
        const tableOrders = [];
        
        ordersSnapshot.forEach(doc => {
          const order = doc.data();
          if (order.tableNumber === tableNumber && !order.paidAt && !order.deleted && !order.cancelledAt) {
            tableOrders.push({
              id: doc.id,
              ...order
            });
          }
        });
        
        if (tableOrders.length === 0) {
          alert('ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«æœªä¼šè¨ˆã®æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“');
          return;
        }
        
        // æ³¨æ–‡ç•ªå·ã§ã‚½ãƒ¼ãƒˆ
        tableOrders.sort((a, b) => (a.orderNumber || 0) - (b.orderNumber || 0));
        
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        // 58mmå¹…è¨­å®š
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        
        // ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šã‹ã‚‰åº—èˆ—åã‚’å–å¾—
        const storeName = window.receiptSettings.storeName || 'ç²‰ã‚‚ã‚“å±‹ å…«';
        builder.createTextElement({data: storeName + '\n'});
        
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        const branchName = window.receiptSettings.branchName || 'ä¸‹èµ¤å¡šåº—';
        builder.createTextElement({data: branchName + '\n'});
        
        builder.createTextElement({emphasis: true, width: 2, height: 1});
        builder.createTextElement({data: '\nãŠä¼šè¨ˆä¼ç¥¨\n\n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createAlignmentElement({position: 'left'});
        const now = new Date();
        const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        builder.createTextElement({data: `æ—¥æ™‚: ${dateStr}\n`});
        builder.createTextElement({data: `ãƒ†ãƒ¼ãƒ–ãƒ«: ${tableNumber}\n`});
        builder.createRuledLineElement({thickness: 'thin'});
        
        // å…¨æ³¨æ–‡ã®å•†å“ã‚’è¡¨ç¤º
        let grandTotal = 0;
        let itemCount = 0;
        
        tableOrders.forEach(order => {
          builder.createTextElement({data: `\n[æ³¨æ–‡ #${order.orderNumber}]\n`});
          
          order.items.forEach(item => {
            const subtotal = item.price * item.quantity;
            grandTotal += subtotal;
            itemCount += item.quantity;
            
            // å•†å“åã‚’32æ–‡å­—ä»¥å†…ã«èª¿æ•´
            const itemName = item.name.length > 16 ? item.name.substring(0, 15) + 'â€¦' : item.name;
            builder.createTextElement({data: `${itemName}\n`});
            
            // å¤–ç¨å¯¾å¿œ
            let displayPrice = item.price;
            if (item.taxType === 'exclusive') {
              const taxRate = item.taxRate || 10;
              displayPrice = Math.floor(item.price * (1 + taxRate / 100));
            }
            
            const priceInfo = `@${displayPrice} x${item.quantity}`;
            const displaySubtotal = displayPrice * item.quantity;
            const subtotalStr = `${displaySubtotal.toLocaleString()}å††`;
            const spaces = ' '.repeat(Math.max(1, 32 - priceInfo.length - subtotalStr.length));
            builder.createTextElement({data: `${priceInfo}${spaces}${subtotalStr}\n`});
            
            // ãƒˆãƒƒãƒ”ãƒ³ã‚°è¡¨ç¤º
            if (item.toppingDetails && item.toppingDetails.length > 0) {
              const groupedBySet = {};
              item.toppingDetails.forEach(detail => {
                if (!groupedBySet[detail.setName]) {
                  groupedBySet[detail.setName] = [];
                }
                groupedBySet[detail.setName].push(detail.optionName);
              });
              
              Object.entries(groupedBySet).forEach(([setName, options]) => {
                builder.createTextElement({data: ` ${setName}\n`});
                options.forEach(opt => {
                  builder.createTextElement({data: `  ãƒ»${opt}\n`});
                });
              });
            } else if (item.toppings && item.toppings !== 'ãªã—') {
              builder.createTextElement({data: ` TP:${item.toppings}\n`});
            }
          });
        });
        
        builder.createRuledLineElement({thickness: 'medium'});
        builder.createTextElement({data: `ç‚¹æ•°: ${itemCount}ç‚¹\n`});
        builder.createRuledLineElement({thickness: 'medium'});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `åˆè¨ˆ ${grandTotal.toLocaleString()}å††\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        builder.createRuledLineElement({thickness: 'medium'});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({data: '\n\nãƒ¬ã‚¸ã¾ã§ãŠæŒã¡ãã ã•ã„\n\n\n'});
        
        builder.createCutPaperElement({feed: true});
        
        // ãƒ—ãƒ­ã‚­ã‚·å¯¾å¿œã®å°åˆ·å‡¦ç†
        await sendPrintRequest(
          builder,
          (response) => {
            console.log('å°åˆ·æˆåŠŸ:', response);
            showToast('ãŠä¼šè¨ˆä¼ç¥¨ã‚’å°åˆ·ã—ã¾ã—ãŸ');
          },
          (response) => {
            console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', response);
            alert('å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (response.message || response.status));
          }
        );
        
      } catch (e) {
        console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        alert('å°åˆ·å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·ï¼ˆ58mmå¹…å¯¾å¿œï¼‰
    window.printReceipt = async function() {
      if (!lastPaymentData) {
        alert('å°åˆ·ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        // 58mmå¹…è¨­å®š
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        // ãƒ¬ã‚·ãƒ¼ãƒˆä½œæˆ
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        
        // ğŸ”§ ä¿®æ­£: ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šã‹ã‚‰åº—èˆ—åã‚’å–å¾—
        const storeName = window.receiptSettings.storeName || 'ç²‰ã‚‚ã‚“å±‹ å…«';
        builder.createTextElement({data: storeName + '\n'});
        
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        // ğŸ”§ ä¿®æ­£: ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šã‹ã‚‰æ”¯åº—åã‚’å–å¾—
        const branchName = window.receiptSettings.branchName || 'ä¸‹èµ¤å¡šåº—';
        builder.createTextElement({data: branchName + '\n'});
        
        // ğŸ”§ ä¿®æ­£: ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šã‹ã‚‰ä½æ‰€ã¨é›»è©±ç•ªå·ã‚’å–å¾—
        const address = window.receiptSettings.address || 'æ±äº¬éƒ½æ¿æ©‹åŒºèµ¤å¡šæ–°ç”º';
        const phone = window.receiptSettings.phone || '03-XXXX-XXXX';
        builder.createTextElement({data: address + '\n'});
        builder.createTextElement({data: 'TEL: ' + phone + '\n'});
        
        // ğŸ†• å°é‘‘ç”»åƒã‚’å°åˆ·ï¼ˆäº‹å‰å¤‰æ›ã—ãŸCanvasã‚’ä½¿ç”¨ï¼‰
        if (window.receiptSettings.stampCanvas) {
          try {
            console.log('ğŸ–¼ï¸ å°é‘‘ç”»åƒã‚’å°åˆ·ã—ã¾ã™');
            builder.createAlignmentElement({position: 'right'});
            builder.createBitImageElement({
              context: window.receiptSettings.stampCanvas,
              x: 0,
              y: 0,
              width: window.receiptSettings.stampCanvas.canvas.width,
              height: window.receiptSettings.stampCanvas.canvas.height
            });
            builder.createFeedElement({line: 1});
            console.log('âœ… å°é‘‘ç”»åƒã‚’è¿½åŠ ã—ã¾ã—ãŸ');
          } catch (error) {
            console.error('âŒ å°é‘‘ç”»åƒå°åˆ·ã‚¨ãƒ©ãƒ¼:', error);
          }
        }
        
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createAlignmentElement({position: 'left'});
        const now = lastPaymentData.timestamp;
        const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        builder.createTextElement({data: `æ—¥æ™‚: ${dateStr}\n`});
        builder.createTextElement({data: `æ‹…å½“: ${lastPaymentData.staffName || 'ãƒ¬ã‚¸ä¿‚'}\n`});
        builder.createTextElement({data: `ãƒ†ãƒ¼ãƒ–ãƒ«: ${lastPaymentData.tableNumber}\n`});
        builder.createTextElement({data: `æ³¨æ–‡No: ${lastPaymentData.orderNumbers.join(',')}\n`});
        builder.createRuledLineElement({thickness: 'thin'});
        
        // å•†å“æ˜ç´°
        let itemCount = 0;
        let tax8Total = 0;
        let tax10Total = 0;
        let tax8Exclusive = 0;  // ğŸ†• å¤–ç¨8%ã®ç¨æŠœé‡‘é¡
        let tax10Exclusive = 0;  // ğŸ†• å¤–ç¨10%ã®ç¨æŠœé‡‘é¡
        
        lastPaymentData.items.forEach(item => {
          const subtotal = item.price * item.quantity;
          itemCount += item.quantity;
          
          // ğŸ†• ç¨è¾¼/ç¨æŠœã®åˆ¤å®š
          const isExclusive = item.taxType === 'exclusive';
          
          // ç¨ç‡åˆ¥é›†è¨ˆ
          if (item.taxRate === 8) {
            if (isExclusive) {
              // å¤–ç¨: ç¨æŠœä¾¡æ ¼ã‚’é›†è¨ˆ
              tax8Exclusive += subtotal;
            } else {
              // å†…ç¨: ç¨è¾¼ä¾¡æ ¼ã‚’é›†è¨ˆ
              tax8Total += subtotal;
            }
          } else {
            if (isExclusive) {
              // å¤–ç¨: ç¨æŠœä¾¡æ ¼ã‚’é›†è¨ˆ
              tax10Exclusive += subtotal;
            } else {
              // å†…ç¨: ç¨è¾¼ä¾¡æ ¼ã‚’é›†è¨ˆ
              tax10Total += subtotal;
            }
          }
          
          // å•†å“åã‚’32æ–‡å­—ä»¥å†…ã«èª¿æ•´
          const itemName = item.name.length > 16 ? item.name.substring(0, 15) + 'â€¦' : item.name;
          builder.createTextElement({data: `${itemName}\n`});
          
          // ğŸ†• å¤–ç¨ã®å ´åˆã¯è¡¨ç¤ºä¾¡æ ¼ã‚’ç¨è¾¼ã«å¤‰æ›
          let displayPrice = item.price;
          if (isExclusive) {
            const taxRate = item.taxRate || 10;
            displayPrice = Math.floor(item.price * (1 + taxRate / 100));
          }
          
          // å˜ä¾¡Ã—æ•°é‡ï¼å°è¨ˆã®å½¢å¼ï¼ˆ58mmå¹…ã«æœ€é©åŒ–ï¼‰
          const priceInfo = `@${displayPrice} x${item.quantity}`;
          const displaySubtotal = displayPrice * item.quantity;
          const subtotalStr = `${displaySubtotal.toLocaleString()}å††`;
          const spaces = ' '.repeat(Math.max(1, 32 - priceInfo.length - subtotalStr.length));
          builder.createTextElement({data: `${priceInfo}${spaces}${subtotalStr}\n`});
          
          // ãƒˆãƒƒãƒ”ãƒ³ã‚°è¡¨ç¤ºï¼ˆtoppingDetailsã‚’å„ªå…ˆï¼‰
          if (item.toppingDetails && item.toppingDetails.length > 0) {
            const groupedBySet = {};
            item.toppingDetails.forEach(detail => {
              if (!groupedBySet[detail.setName]) {
                groupedBySet[detail.setName] = [];
              }
              groupedBySet[detail.setName].push(detail.optionName);
            });
            
            Object.entries(groupedBySet).forEach(([setName, options]) => {
              builder.createTextElement({data: ` ${setName}\n`});
              options.forEach(opt => {
                builder.createTextElement({data: `  ãƒ»${opt}\n`});
              });
            });
          } else if (item.toppings && item.toppings !== 'ãªã—') {
            builder.createTextElement({data: ` TP:${item.toppings}\n`});
          }
        });
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createTextElement({data: `å°è¨ˆ${' '.repeat(20)}${lastPaymentData.totalAmount.toLocaleString()}å††\n`});
        builder.createTextElement({data: `ç‚¹æ•°: ${itemCount}ç‚¹\n`});
        builder.createRuledLineElement({thickness: 'thin'});
        
        // ğŸ†• ç¨é¡è¨ˆç®—ï¼ˆå†…ç¨ã¨å¤–ç¨ã‚’åˆ†ã‘ã¦è¨ˆç®—ï¼‰
        const tax8AmountInclusive = Math.floor(tax8Total * 8 / 108);  // å†…ç¨8%ã®ç¨é¡
        const tax10AmountInclusive = Math.floor(tax10Total * 10 / 110);  // å†…ç¨10%ã®ç¨é¡
        const tax8AmountExclusive = Math.floor(tax8Exclusive * 8 / 100);  // å¤–ç¨8%ã®ç¨é¡
        const tax10AmountExclusive = Math.floor(tax10Exclusive * 10 / 100);  // å¤–ç¨10%ã®ç¨é¡
        
        // åˆè¨ˆç¨é¡
        const totalTax8 = tax8AmountInclusive + tax8AmountExclusive;
        const totalTax10 = tax10AmountInclusive + tax10AmountExclusive;
        
        // ç¨è¾¼åˆè¨ˆ
        const total8WithTax = tax8Total + tax8Exclusive + tax8AmountExclusive;
        const total10WithTax = tax10Total + tax10Exclusive + tax10AmountExclusive;
        
        if (total8WithTax > 0) {
          builder.createTextElement({data: `8%å¯¾è±¡${' '.repeat(16)}${total8WithTax.toLocaleString()}å††\n`});
          builder.createTextElement({data: `(å†…æ¶ˆè²»ç¨${' '.repeat(15)}${totalTax8.toLocaleString()}å††)\n`});
        }
        if (total10WithTax > 0) {
          builder.createTextElement({data: `10%å¯¾è±¡${' '.repeat(15)}${total10WithTax.toLocaleString()}å††\n`});
          builder.createTextElement({data: `(å†…æ¶ˆè²»ç¨${' '.repeat(15)}${totalTax10.toLocaleString()}å††)\n`});
        }
        
        builder.createRuledLineElement({thickness: 'medium'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `åˆè¨ˆ ${lastPaymentData.totalAmount.toLocaleString()}å††\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createRuledLineElement({thickness: 'medium'});
        
        // æ”¯æ‰•ã„æƒ…å ±
        let paymentMethodStr = '';
        if (lastPaymentData.paymentMethod === 'cash') {
          paymentMethodStr = 'ç¾é‡‘';
          builder.createTextElement({data: `ãŠé ã‚Š${' '.repeat(18)}${lastPaymentData.cashReceived.toLocaleString()}å††\n`});
          builder.createTextElement({data: `ãŠã¤ã‚Š${' '.repeat(18)}${lastPaymentData.change.toLocaleString()}å††\n`});
        } else if (lastPaymentData.paymentMethod === 'emoney') {
          paymentMethodStr = 'é›»å­ãƒãƒãƒ¼';
        } else if (lastPaymentData.paymentMethod === 'credit') {
          paymentMethodStr = 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰';
        }
        builder.createTextElement({data: `æ”¯æ‰•: ${paymentMethodStr}\n`});
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createAlignmentElement({position: 'center'});
        
        // ğŸ”§ ä¿®æ­£: ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
        const receiptMessage = window.receiptSettings.message || 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ\nã¾ãŸã®ã”æ¥åº—ã‚’\nãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™';
        const messageLines = receiptMessage.split('\n');
        messageLines.forEach(line => {
          if (line.trim()) {
            builder.createTextElement({data: line + '\n'});
          }
        });
        builder.createTextElement({data: '\n\n'});
        
        builder.createCutPaperElement({feed: true});
        
        // ãƒ—ãƒ­ã‚­ã‚·å¯¾å¿œã®å°åˆ·å‡¦ç†
        await sendPrintRequest(
          builder,
          (response) => {
            console.log('å°åˆ·æˆåŠŸ:', response);
            closeReceiptModal();
          },
          (response) => {
            console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', response);
            alert('å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (response.message || response.status));
          }
        );
        
      } catch (e) {
        console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        alert('å°åˆ·å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // é ˜åæ›¸å°åˆ·ï¼ˆå°é‘‘æ¬„ä»˜ããƒ»58mmå¹…å¯¾å¿œï¼‰
    window.printInvoice = async function() {
      if (!lastPaymentData) {
        alert('å°åˆ·ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        // 58mmå¹…è¨­å®š
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: 'é ˜ å æ›¸\n\n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        builder.createAlignmentElement({position: 'left'});
        const now = lastPaymentData.timestamp;
        const dateStr = `${now.getFullYear()}å¹´${String(now.getMonth()+1).padStart(2,'0')}æœˆ${String(now.getDate()).padStart(2,'0')}æ—¥`;
        builder.createTextElement({data: `${dateStr}\n\n`});
        
        builder.createTextElement({data: 'ãŠå®¢æ§˜\n\n'});
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `Â¥${lastPaymentData.totalAmount.toLocaleString()}-\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createAlignmentElement({position: 'left'});
        builder.createTextElement({data: '\nä¸Šè¨˜æ­£ã«é ˜åã„ãŸã—ã¾ã—ãŸ\n\n'});
        builder.createTextElement({data: 'ä½†ã— é£²é£Ÿä»£ã¨ã—ã¦\n\n\n'});
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createAlignmentElement({position: 'right'});
        
        // ğŸ”§ ä¿®æ­£: ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šã‹ã‚‰åº—èˆ—æƒ…å ±ã‚’å–å¾—
        const storeName = window.receiptSettings.storeName || 'ç²‰ã‚‚ã‚“å±‹ å…«';
        const branchName = window.receiptSettings.branchName || 'ä¸‹èµ¤å¡šåº—';
        const address = window.receiptSettings.address || 'æ±äº¬éƒ½æ¿æ©‹åŒºèµ¤å¡šæ–°ç”º';
        const phone = window.receiptSettings.phone || '03-XXXX-XXXX';
        
        builder.createTextElement({data: storeName + ' ' + branchName + '\n'});
        builder.createTextElement({data: address + '\n'});
        builder.createTextElement({data: 'TEL: ' + phone + '\n\n'});
        
        // ğŸ†• å°é‘‘ç”»åƒã‚’å°åˆ·ï¼ˆäº‹å‰å¤‰æ›ã—ãŸCanvasã‚’ä½¿ç”¨ï¼‰
        if (window.receiptSettings.stampCanvas) {
          try {
            console.log('ğŸ–¼ï¸ å°é‘‘ç”»åƒã‚’å°åˆ·ã—ã¾ã™ï¼ˆé ˜åæ›¸ï¼‰');
            builder.createAlignmentElement({position: 'right'});
            builder.createBitImageElement({
              context: window.receiptSettings.stampCanvas,
              x: 0,
              y: 0,
              width: window.receiptSettings.stampCanvas.canvas.width,
              height: window.receiptSettings.stampCanvas.canvas.height
            });
            builder.createFeedElement({line: 1});
            console.log('âœ… å°é‘‘ç”»åƒã‚’è¿½åŠ ã—ã¾ã—ãŸï¼ˆé ˜åæ›¸ï¼‰');
          } catch (error) {
            console.error('âŒ å°é‘‘ç”»åƒå°åˆ·ã‚¨ãƒ©ãƒ¼:', error);
          }
        } else {
          // å°é‘‘ç”»åƒãŒãªã„å ´åˆã¯å¾“æ¥ã®ãƒ†ã‚­ã‚¹ãƒˆå°é‘‘æ¬„ã‚’è¡¨ç¤º
          builder.createAlignmentElement({position: 'right'});
          builder.createTextElement({data: '        â—¯â—¯â—¯\n'});
          builder.createTextElement({data: '       â—¯   â—¯\n'});
          builder.createTextElement({data: '      â—¯  å° â—¯\n'});
          builder.createTextElement({data: '       â—¯   â—¯\n'});
          builder.createTextElement({data: '        â—¯â—¯â—¯\n\n'});
        }
        
        builder.createAlignmentElement({position: 'left'});
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createTextElement({data: `\nãƒ†ãƒ¼ãƒ–ãƒ«: ${lastPaymentData.tableNumber}\n`});
        builder.createTextElement({data: `æ³¨æ–‡No: ${lastPaymentData.orderNumbers.join(',')}\n`});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({data: '\n\n'});
        
        builder.createCutPaperElement({feed: true});
        
        // ãƒ—ãƒ­ã‚­ã‚·å¯¾å¿œã®å°åˆ·å‡¦ç†
        await sendPrintRequest(
          builder,
          (response) => {
            console.log('å°åˆ·æˆåŠŸ:', response);
            closeReceiptModal();
          },
          (response) => {
            console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', response);
            alert('å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + (response.message || response.status));
          }
        );
        
      } catch (e) {
        console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        alert('å°åˆ·å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ãƒ¬ã‚·ãƒ¼ãƒˆå®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeReceiptModal = function() {
      document.getElementById('receiptCompleteModal').classList.add('hidden');
      
      // å³ä¼šè¨ˆãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
      isDirectPaymentMode = false;
      
      clearSelection();
    };
    
    // é¸æŠã‚’ã‚¯ãƒªã‚¢
    window.clearSelection = function() {
      selectedTable = null;
      currentTableSettings = null;  // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚‚ã‚¯ãƒªã‚¢
      currentOrders = [];
      document.getElementById('orderSection').classList.add('hidden');
    };
    
    // æ—¥æ¬¡å£²ä¸Šæ›´æ–°é–¢æ•°
    window.updateDailySales = async function(totalAmount, paymentMethod, itemCount, tax8Total, tax10Total, discountAmount = 0, customerCountIncrement = 0, items = []) {
      try {
        // ğŸ†• é¸æŠã•ã‚ŒãŸå–¶æ¥­æ—¥ã‚’ä½¿ç”¨ï¼ˆé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯æœ¬æ—¥ï¼‰
        const dateStr = window.getBusinessDateString();
        
        console.log('ğŸ“Š æ—¥æ¬¡å£²ä¸Šæ›´æ–°é–‹å§‹:', { 
          å–¶æ¥­æ—¥: dateStr,
          totalAmount, 
          paymentMethod, 
          itemCount, 
          tax8Total, 
          tax10Total, 
          discountAmount, 
          customerCountIncrement 
        });
        
        // ãƒ‡ãƒãƒƒã‚°: itemCountãŒ0ã®å ´åˆã¯è­¦å‘Šï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®ã¿ï¼‰
        if (itemCount === 0) {
          console.error('âŒ updateDailySalesã«æ¸¡ã•ã‚ŒãŸitemCountãŒ0ã§ã™ï¼');
        }
        
        const salesRef = window.getStoreDoc('dailySales', dateStr);
        const salesDoc = await getDoc(salesRef);
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          console.log('æ—¢å­˜ãƒ‡ãƒ¼ã‚¿:', data);
          
          // å•†å“åˆ¥ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨ˆç®—
          const currentItemCounts = data.itemCounts || {};
          items.forEach(item => {
            const itemName = item.name;
            currentItemCounts[itemName] = (currentItemCounts[itemName] || 0) + item.quantity;
          });
          
          const updates = {
            totalSales: (data.totalSales || 0) + totalAmount,
            customerCount: (data.customerCount || 0) + customerCountIncrement,
            totalItems: (data.totalItems || 0) + itemCount,
            tax8Total: (data.tax8Total || 0) + tax8Total,
            tax10Total: (data.tax10Total || 0) + tax10Total,
            totalDiscount: (data.totalDiscount || 0) + discountAmount,
            itemCounts: currentItemCounts,
            drawerOpenCount: data.drawerOpenCount || 0,  // ç¾åœ¨ã®å€¤ã‚’ä¿æŒ
            cashSales: (data.cashSales || 0),  // æ—¢å­˜å€¤ã‚’ä¿æŒ
            emoneSales: (data.emoneSales || 0),  // æ—¢å­˜å€¤ã‚’ä¿æŒ
            creditSales: (data.creditSales || 0),  // æ—¢å­˜å€¤ã‚’ä¿æŒ
            updatedAt: Timestamp.now()
          };
          
          console.log('ğŸ’¡ æ›´æ–°å‰ - totalItems:', data.totalItems || 0, 'tax8Total:', data.tax8Total || 0, 'tax10Total:', data.tax10Total || 0, 'totalDiscount:', data.totalDiscount || 0);
          console.log('ğŸ’¡ è¿½åŠ åˆ† - itemCount:', itemCount, 'tax8Total:', tax8Total, 'tax10Total:', tax10Total, 'discountAmount:', discountAmount);
          console.log('ğŸ’¡ æ›´æ–°å¾Œ - totalItems:', updates.totalItems, 'tax8Total:', updates.tax8Total, 'tax10Total:', updates.tax10Total, 'totalDiscount:', updates.totalDiscount);
          
          // æ”¯æ‰•ã„æ–¹æ³•åˆ¥ã®å£²ä¸Šã‚’åŠ ç®—
          if (paymentMethod === 'cash') {
            updates.cashSales += totalAmount;
            // ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³ã‚«ã‚¦ãƒ³ãƒˆã¯æ‰‹å‹•ãƒœã‚¿ãƒ³ã®ã¿
          } else if (paymentMethod === 'emoney') {
            updates.emoneSales += totalAmount;
          } else if (paymentMethod === 'credit') {
            updates.creditSales += totalAmount;
          }
          
          await updateDoc(salesRef, updates);
          console.log('âœ… æ—¢å­˜å£²ä¸Šãƒ‡ãƒ¼ã‚¿æ›´æ–°:', updates);
          
        } else {
          // å•†å“åˆ¥ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨ˆç®—
          const newItemCounts = {};
          items.forEach(item => {
            const itemName = item.name;
            newItemCounts[itemName] = (newItemCounts[itemName] || 0) + item.quantity;
          });
          
          const newData = {
            date: dateStr,
            totalSales: totalAmount,
            customerCount: customerCountIncrement,
            totalItems: itemCount,
            tax8Total: tax8Total,
            tax10Total: tax10Total,
            totalDiscount: discountAmount,
            itemCounts: newItemCounts,
            cashSales: paymentMethod === 'cash' ? totalAmount : 0,
            emoneSales: paymentMethod === 'emoney' ? totalAmount : 0,
            creditSales: paymentMethod === 'credit' ? totalAmount : 0,
            drawerOpenCount: 0,  // ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸæ•°ã®ã¿ã‚«ã‚¦ãƒ³ãƒˆ
            createdAt: Timestamp.now(),
            updatedAt: Timestamp.now()
          };
          
          await setDoc(salesRef, newData);
          console.log('âœ… æ–°è¦å£²ä¸Šãƒ‡ãƒ¼ã‚¿ä½œæˆ:', newData);
        }
        
        // æ›´æ–°å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ç¢ºèª
        const updatedDoc = await getDoc(salesRef);
        console.log('æ›´æ–°å¾Œã®ãƒ‡ãƒ¼ã‚¿:', updatedDoc.data());
        
      } catch (error) {
        console.error('âŒ æ—¥æ¬¡å£²ä¸Šæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
      }
    };
    
    // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆé–¢æ•°
    function showCustomAlert(message, title = 'é€šçŸ¥', icon = '') {
      document.getElementById('customAlertIcon').textContent = icon;
      document.getElementById('customAlertTitle').textContent = title;
      document.getElementById('customAlertMessage').textContent = message;
      document.getElementById('customAlert').classList.add('show');
      
      // ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¼·åˆ¶çš„ã«è¨­å®š
      const button = document.querySelector('.custom-alert-button');
      if (button) {
        button.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
        button.style.color = 'white';
        button.style.border = 'none';
        button.style.padding = '15px 50px';
        button.style.fontSize = '18px';
        button.style.fontWeight = 'bold';
        button.style.borderRadius = '25px';
        button.style.cursor = 'pointer';
        button.style.boxShadow = '0 4px 15px rgba(76, 175, 80, 0.4)';
      }
    }
    
    function closeCustomAlert() {
      document.getElementById('customAlert').classList.remove('show');
    }
    
    // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    function showCustomConfirm({ icon = 'â“', title = 'ç¢ºèª', message = '', confirmText = 'OK', confirmColor = '#4CAF50' }) {
      return new Promise((resolve) => {
        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’ä½œæˆ
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.6);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          animation: fadeIn 0.2s ease-out;
        `;
        
        // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãƒœãƒƒã‚¯ã‚¹ã‚’ä½œæˆ
        const dialog = document.createElement('div');
        dialog.style.cssText = `
          background: white;
          border-radius: 20px;
          padding: 0;
          max-width: 85%;
          width: 400px;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          animation: slideUp 0.3s ease-out;
          overflow: hidden;
        `;
        
        // ã‚¢ã‚¤ã‚³ãƒ³
        const iconDiv = document.createElement('div');
        iconDiv.textContent = icon;
        iconDiv.style.cssText = `
          font-size: 64px;
          text-align: center;
          padding: 30px 20px 20px 20px;
        `;
        
        // ã‚¿ã‚¤ãƒˆãƒ«
        const titleDiv = document.createElement('div');
        titleDiv.textContent = title;
        titleDiv.style.cssText = `
          font-size: 24px;
          font-weight: bold;
          color: #333;
          text-align: center;
          padding: 0 30px;
          margin-bottom: 15px;
        `;
        
        // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        const messageDiv = document.createElement('div');
        messageDiv.textContent = message;
        messageDiv.style.cssText = `
          font-size: 16px;
          color: #666;
          text-align: center;
          padding: 0 30px 30px 30px;
          line-height: 1.6;
          white-space: pre-line;
        `;
        
        // ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = `
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 0;
          border-top: 1px solid #e0e0e0;
        `;
        
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³
        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
        cancelButton.style.cssText = `
          padding: 18px;
          background: white;
          color: #666;
          border: none;
          border-right: 1px solid #e0e0e0;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.2s;
        `;
        cancelButton.onmouseover = () => {
          cancelButton.style.background = '#f5f5f5';
        };
        cancelButton.onmouseout = () => {
          cancelButton.style.background = 'white';
        };
        cancelButton.onclick = () => {
          overlay.style.animation = 'fadeOut 0.2s ease-out';
          setTimeout(() => {
            overlay.remove();
            resolve(false);
          }, 200);
        };
        
        // ç¢ºèªãƒœã‚¿ãƒ³
        const confirmButton = document.createElement('button');
        confirmButton.textContent = confirmText;
        confirmButton.style.cssText = `
          padding: 18px;
          background: white;
          color: ${confirmColor};
          border: none;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.2s;
        `;
        confirmButton.onmouseover = () => {
          confirmButton.style.background = '#f5f5f5';
        };
        confirmButton.onmouseout = () => {
          confirmButton.style.background = 'white';
        };
        confirmButton.onclick = () => {
          overlay.style.animation = 'fadeOut 0.2s ease-out';
          setTimeout(() => {
            overlay.remove();
            resolve(true);
          }, 200);
        };
        
        // çµ„ã¿ç«‹ã¦
        buttonContainer.appendChild(cancelButton);
        buttonContainer.appendChild(confirmButton);
        dialog.appendChild(iconDiv);
        dialog.appendChild(titleDiv);
        dialog.appendChild(messageDiv);
        dialog.appendChild(buttonContainer);
        overlay.appendChild(dialog);
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ ï¼ˆã¾ã ãªã‘ã‚Œã°ï¼‰
        if (!document.getElementById('custom-confirm-styles')) {
          const style = document.createElement('style');
          style.id = 'custom-confirm-styles';
          style.textContent = `
            @keyframes fadeIn {
              from { opacity: 0; }
              to { opacity: 1; }
            }
            @keyframes fadeOut {
              from { opacity: 1; }
              to { opacity: 0; }
            }
            @keyframes slideUp {
              from {
                transform: translateY(50px);
                opacity: 0;
              }
              to {
                transform: translateY(0);
                opacity: 1;
              }
            }
          `;
          document.head.appendChild(style);
        }
        
        document.body.appendChild(overlay);
      });
    }
    
    // å…¨ã¦ã®alertã‚’showCustomAlertã«ç½®ãæ›ãˆ
    window.alert = function(message) {
      let title = 'é€šçŸ¥';
      let icon = 'ğŸ“¢';
      
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å¿œã˜ã¦ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰æ›´
      if (message.includes('æˆåŠŸ') || message.includes('å®Œäº†') || message.includes('âœ“') || message.includes('âœ…')) {
        icon = '';
        title = 'å®Œäº†';
      } else if (message.includes('ã‚¨ãƒ©ãƒ¼') || message.includes('å¤±æ•—')) {
        icon = '';
        title = 'ã‚¨ãƒ©ãƒ¼';
      } else if (message.includes('è­¦å‘Š')) {
        icon = '';
        title = 'è­¦å‘Š';
      } else if (message.includes('å‰Šé™¤')) {
        icon = '';
        title = 'å‰Šé™¤';
      } else if (message.includes('è¿½åŠ ') || message.includes('æ³¨æ–‡')) {
        icon = '';
        title = 'å®Œäº†';
      }
      
      showCustomAlert(message, title, icon);
    };
    
    // ========== ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼æ©Ÿèƒ½ ==========
    
    // å¾…ã¡äººæ•°+1
    window.increaseWaiting = async function() {
      try {
        const ref = window.getStoreDoc('settings', 'waiting');
        const snapshot = await window.getDocs(window.getStoreCollection('settings'));
        let count = 0;
        snapshot.forEach(d => { if (d.id === 'waiting') count = d.data().manualCount || 0; });
        await window.setDoc(ref, { manualCount: count + 1 });
        showToast('å¾…ã¡+1');
      } catch (e) {
        console.error(e);
        alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    };
    
    // å¾…ã¡äººæ•°ãƒªã‚»ãƒƒãƒˆ
    window.resetWaiting = async function() {
      try {
        await window.setDoc(window.getStoreDoc('settings', 'waiting'), { manualCount: 0 });
        showToast('ãƒªã‚»ãƒƒãƒˆ');
      } catch (e) {
        console.error(e);
        alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    };
    
    // å¾…ã¡äººæ•°ã‚’ç›£è¦–
    function watchWaiting() {
      const unsubscribe = window.onSnapshot(
        window.getStoreDoc('settings', 'waiting'),
        (doc) => {
          if (doc.exists()) {
            const count = doc.data().manualCount || 0;
            document.getElementById('manual-count').textContent = count;
          }
        }
      );
      return unsubscribe;
    }
    
    // å“åˆ‡ã‚Œãƒšãƒ¼ã‚¸è¡¨ç¤º
    window.showSoldOutPage = async function() {
      try {
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        allMenuItems = [];
        const categories = new Set();
        
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          allMenuItems.push({
            id: data.id,
            name: data.name,
            price: data.price,
            category: data.category
          });
          if (data.category) categories.add(data.category);
        });
        
        const select = document.getElementById('soldout-category-select');
        select.innerHTML = '<option value="">å…¨ã¦ã®å•†å“</option>';
        Array.from(categories).sort().forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          select.appendChild(opt);
        });
        
        select.onchange = () => {
          const filtered = select.value === '' ? allMenuItems : allMenuItems.filter(i => i.category === select.value);
          displaySoldOutItems(filtered);
        };
        
        // ğŸ†• ä¸€æ‹¬å“åˆ‡ã‚Œãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
        const bulkBtn = document.getElementById('bulk-soldout-btn');
        if (bulkBtn && !bulkBtn.hasAttribute('data-listener-added')) {
          bulkBtn.removeAttribute('onclick'); // æ—¢å­˜ã®onclickå±æ€§ã‚’å‰Šé™¤
          bulkBtn.addEventListener('click', window.toggleBulkSoldOut);
          bulkBtn.setAttribute('data-listener-added', 'true'); // é‡è¤‡é˜²æ­¢
        }
        
        await displaySoldOutItems(allMenuItems);
        document.getElementById('page-soldout').style.display = 'block';
      } catch (e) {
        console.error(e);
        alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    };
    
    // å“åˆ‡ã‚Œãƒšãƒ¼ã‚¸ã‹ã‚‰æˆ»ã‚‹
    window.backFromSoldOut = function() {
      document.getElementById('page-soldout').style.display = 'none';
    };
    
    // å“åˆ‡ã‚Œå•†å“ãƒªã‚¹ãƒˆè¡¨ç¤º
    async function displaySoldOutItems(items) {
      const list = document.getElementById('soldout-menu-list');
      list.innerHTML = '';
      
      // controller.htmlã¨åŒã˜å½¢å¼ã§sold_outã‚’å–å¾—
      const soldOutSnapshot = await window.getDocs(window.collection(window.db, 'sold_out'));
      const soldOutIds = new Set();
      soldOutSnapshot.forEach(doc => soldOutIds.add(doc.data().menuId));
      
      items.sort((a, b) => {
        const numA = a.id ? parseInt(a.id.replace(/\D/g, '') || '0') : 0;
        const numB = b.id ? parseInt(b.id.replace(/\D/g, '') || '0') : 0;
        return numA - numB;
      });
      
      items.forEach(item => {
        const isSoldOut = soldOutIds.has(item.id);
        const div = document.createElement('div');
        div.className = 'soldout-item' + (isSoldOut ? ' sold-out' : '');
        
        div.innerHTML = `
          <div>
            <div class="soldout-item-name">${item.name}</div>
            <div style="font-size:14px;color:#666;">Â¥${item.price.toLocaleString()}</div>
            ${isSoldOut ? '<span class="soldout-badge">å“åˆ‡ã‚Œä¸­</span>' : ''}
          </div>
          <button class="soldout-toggle-btn ${isSoldOut ? 'set-available' : 'set-soldout'}" 
                  data-menu-id="${item.id}" 
                  data-set-soldout="${!isSoldOut}">
            ${isSoldOut ? 'è²©å£²å†é–‹' : 'å“åˆ‡ã‚Œ'}
          </button>
        `;
        
        // ğŸ†• ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç›´æ¥è¿½åŠ 
        const button = div.querySelector('.soldout-toggle-btn');
        button.addEventListener('click', async function() {
          const menuId = this.getAttribute('data-menu-id');
          const setSoldOut = this.getAttribute('data-set-soldout') === 'true';
          await window.toggleSoldOut(menuId, setSoldOut);
        });
        
        list.appendChild(div);
      });
    }
    
    // å€‹åˆ¥å“åˆ‡ã‚Œåˆ‡ã‚Šæ›¿ãˆ
    window.toggleSoldOut = async function(menuId, setSoldOut) {
      try {
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('ğŸ“ toggleSoldOut å‘¼ã³å‡ºã—');
        console.log('   menuId:', menuId);
        console.log('   setSoldOut:', setSoldOut);
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        
        if (setSoldOut) {
          // å“åˆ‡ã‚Œã«è¨­å®šï¼ˆcontroller.htmlã¨åŒã˜å½¢å¼ï¼‰
          console.log('   â†’ å“åˆ‡ã‚Œã«è¨­å®š');
          await window.setDoc(window.doc(window.db, 'sold_out', menuId), {
            menuId: menuId,
            timestamp: window.Timestamp.now()
          });
          showToast('å“åˆ‡ã‚Œã«è¨­å®š');
          console.log('   âœ… å“åˆ‡ã‚Œè¨­å®šå®Œäº†');
        } else {
          // å†è²©ï¼šmenuIdã«ä¸€è‡´ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢ã—ã¦å‰Šé™¤
          console.log('   â†’ è²©å£²å†é–‹');
          const soldOutSnapshot = await window.getDocs(window.collection(window.db, 'sold_out'));
          const deletePromises = [];
          let foundCount = 0;
          
          soldOutSnapshot.forEach(docSnap => {
            const data = docSnap.data();
            console.log('  sold_out doc:', docSnap.id, data);
            
            // menuIdãŒä¸€è‡´ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ï¼ˆ.refã‚’ä½¿ç”¨ï¼‰
            if (data.menuId === menuId || docSnap.id === menuId) {
              console.log('    â†’ å‰Šé™¤:', docSnap.id);
              deletePromises.push(window.deleteDoc(docSnap.ref));
              foundCount++;
            }
          });
          
          if (deletePromises.length > 0) {
            await Promise.all(deletePromises);
            showToast(`è²©å£²å†é–‹ (${foundCount}ä»¶)`);
            console.log('   âœ… è²©å£²å†é–‹å®Œäº†:', foundCount, 'ä»¶');
          } else {
            console.warn('å‰Šé™¤ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚menuId:', menuId);
            showToast('âš ï¸ å‰Šé™¤å¯¾è±¡ãªã—');
          }
        }
        
        console.log('   ğŸ”„ ãƒªã‚¹ãƒˆæ›´æ–°ä¸­...');
        const sel = document.getElementById('soldout-category-select');
        const filtered = sel.value === '' ? allMenuItems : allMenuItems.filter(i => i.category === sel.value);
        await displaySoldOutItems(filtered);
        console.log('   âœ… ãƒªã‚¹ãƒˆæ›´æ–°å®Œäº†');
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      } catch (e) {
        console.error('âŒ toggleSoldOut error:', e);
        console.error('   ã‚¨ãƒ©ãƒ¼è©³ç´°:', e.message);
        console.error('   ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:', e.stack);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    };
    
    // ä¸€æ‹¬å“åˆ‡ã‚Œåˆ‡ã‚Šæ›¿ãˆ
    window.toggleBulkSoldOut = async function() {
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log('ğŸ“ toggleBulkSoldOut å‘¼ã³å‡ºã—');
      console.log('   currentStoreId:', window.currentStoreId);
      console.log('   isBulkSoldOut:', isBulkSoldOut);
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      
      const btn = document.getElementById('bulk-soldout-btn');
      
      if (!isBulkSoldOut) {
        console.log('   â†’ ä¸€æ‹¬å“åˆ‡ã‚Œè¨­å®šãƒ¢ãƒ¼ãƒ‰');
        const confirmed = await showCustomConfirm({
          icon: 'ğŸš«',
          title: 'ä¸€æ‹¬å“åˆ‡ã‚Œè¨­å®š',
          message: 'å…¨ã¦ã®å•†å“ã‚’å“åˆ‡ã‚Œã«è¨­å®šã—ã¾ã™ã‹ï¼Ÿ\nãŠå®¢æ§˜ã¯æ³¨æ–‡ã§ããªããªã‚Šã¾ã™ã€‚',
          btnText: 'å“åˆ‡ã‚Œã«ã™ã‚‹',
          btnClass: 'modal-btn-danger'
        });
        
        if (!confirmed) {
          console.log('   âœ–ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
          return;
        }
        
        try {
          console.log('   ğŸ”„ ãƒ¡ãƒ‹ãƒ¥ãƒ¼å–å¾—ä¸­...');
          const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
          const promises = [];
          
          menuSnapshot.forEach(docSnap => {
            const data = docSnap.data();
            if (data.id) {
              console.log('     å“åˆ‡ã‚Œè¨­å®š:', data.id, data.name);
              // controller.htmlã¨åŒã˜å½¢å¼
              promises.push(window.setDoc(window.doc(window.db, 'sold_out', data.id), {
                menuId: data.id,
                timestamp: window.Timestamp.now()
              }));
            }
          });
          
          console.log('   â³ ä¸€æ‹¬è¨­å®šå®Ÿè¡Œä¸­...', promises.length, 'ä»¶');
          await Promise.all(promises);
          isBulkSoldOut = true;
          btn.textContent = 'å†è²©';
          btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
          showToast('å…¨å•†å“ã‚’å“åˆ‡ã‚Œã«è¨­å®šã—ã¾ã—ãŸ');
          console.log('   âœ… ä¸€æ‹¬å“åˆ‡ã‚Œè¨­å®šå®Œäº†');
        } catch (e) {
          console.error('âŒ ä¸€æ‹¬å“åˆ‡ã‚Œã‚¨ãƒ©ãƒ¼:', e);
          alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
        }
      } else {
        console.log('   â†’ ä¸€æ‹¬è²©å£²å†é–‹ãƒ¢ãƒ¼ãƒ‰');
        const confirmed = await showCustomConfirm({
          icon: 'âœ…',
          title: 'è²©å£²å†é–‹',
          message: 'å…¨ã¦ã®å•†å“ã‚’è²©å£²å†é–‹ã—ã¾ã™ã‹ï¼Ÿ\nãŠå®¢æ§˜ãŒæ³¨æ–‡ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚',
          btnText: 'è²©å£²å†é–‹ã™ã‚‹',
          btnClass: 'modal-btn-success'
        });
        
        if (!confirmed) {
          console.log('   âœ–ï¸ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
          return;
        }
        
        try {
          console.log('   ğŸ”„ å“åˆ‡ã‚Œä¸€è¦§å–å¾—ä¸­...');
          // controller.htmlã¨åŒã˜å½¢å¼
          const soldOutSnapshot = await window.getDocs(window.collection(window.db, 'sold_out'));
          const promises = [];
          soldOutSnapshot.forEach(docSnap => {
            console.log('     å‰Šé™¤:', docSnap.id);
            promises.push(window.deleteDoc(docSnap.ref));
          });
          
          console.log('   â³ ä¸€æ‹¬å‰Šé™¤å®Ÿè¡Œä¸­...', promises.length, 'ä»¶');
          await Promise.all(promises);
          isBulkSoldOut = false;
          btn.textContent = 'ä¸€æ‹¬';
          btn.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
          showToast('å…¨å•†å“ã®è²©å£²ã‚’å†é–‹ã—ã¾ã—ãŸ');
          console.log('   âœ… ä¸€æ‹¬è²©å£²å†é–‹å®Œäº†');
        } catch (e) {
          console.error('âŒ ä¸€æ‹¬è²©å£²å†é–‹ã‚¨ãƒ©ãƒ¼:', e);
          alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
        }
      }
      
      console.log('   ğŸ”„ ãƒªã‚¹ãƒˆæ›´æ–°ä¸­...');
      await displaySoldOutItems(allMenuItems);
      console.log('   âœ… ãƒªã‚¹ãƒˆæ›´æ–°å®Œäº†');
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    };
    
    // æ™‚é–“å¤–è¨­å®šåˆ‡ã‚Šæ›¿ãˆ
    window.toggleTimeOverride = async function() {
      const btn = document.getElementById('time-override-btn');
      const btnNew = document.getElementById('time-override-btn-new');
      
      try {
        const settingsRef = window.getStoreDoc('settings', 'timeOverride');
        const settingsSnap = await window.getDoc(settingsRef);
        const currentOverride = settingsSnap.exists() ? settingsSnap.data().enabled : false;
        
        const newOverride = !currentOverride;
        
        await window.setDoc(settingsRef, {
          enabled: newOverride,
          timestamp: window.Timestamp.now()
        });
        
        if (newOverride) {
          if (btn) {
            btn.textContent = 'å–¶æ¥­';
            btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
          }
          if (btnNew) {
            btnNew.textContent = 'å–¶æ¥­';
            btnNew.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
          }
          showToast('å–¶æ¥­æ™‚é–“å¤–ã§ã‚‚æ³¨æ–‡å¯èƒ½ã«ã—ã¾ã—ãŸ');
        } else {
          if (btn) {
            btn.textContent = 'æ™‚é–“å¤–å–¶æ¥­è§£é™¤';
            btn.style.background = 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)';
          }
          if (btnNew) {
            btnNew.textContent = 'æ™‚é–“å¤–å–¶æ¥­è§£é™¤';
            btnNew.style.background = 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)';
          }
          showToast('å–¶æ¥­æ™‚é–“å¤–ãƒã‚§ãƒƒã‚¯ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸ');
        }
      } catch (e) {
        console.error(e);
        alert('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    };
    
    // æ™‚é–“å¤–è¨­å®šã‚’èª­ã¿è¾¼ã¿
    async function loadTimeOverrideStatus() {
      try {
        const settingsRef = window.getStoreDoc('settings', 'timeOverride');
        const settingsSnap = await window.getDoc(settingsRef);
        const overrideEnabled = settingsSnap.exists() ? settingsSnap.data().enabled : false;
        
        const btn = document.getElementById('time-override-btn');
        const btnNew = document.getElementById('time-override-btn-new');
        
        if (overrideEnabled) {
          if (btn) {
            btn.textContent = 'å–¶æ¥­';
            btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
          }
          if (btnNew) {
            btnNew.textContent = 'å–¶æ¥­';
            btnNew.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
          }
        } else {
          if (btn) {
            btn.textContent = 'æ™‚é–“å¤–å–¶æ¥­è§£é™¤';
            btn.style.background = 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)';
          }
          if (btnNew) {
            btnNew.textContent = 'æ™‚é–“å¤–å–¶æ¥­è§£é™¤';
            btnNew.style.background = 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)';
          }
        }
      } catch (e) {
        console.error('æ™‚é–“ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
    function showToast(msg) {
      const toast = document.createElement('div');
      toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);color:white;padding:30px 50px;border-radius:15px;font-size:24px;font-weight:bold;z-index:10001;';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }
    
    // åˆæœŸåŒ–æ™‚ã«ç›£è¦–ã‚’é–‹å§‹
    if (window.firebaseReady) {
      watchWaiting();
      loadTimeOverrideStatus();
    } else {
      window.addEventListener('firebaseReady', () => {
        watchWaiting();
        loadTimeOverrideStatus();
      });
    }
    
    // ========== éŸ³å£°é€šçŸ¥æ©Ÿèƒ½ ==========
    
    function showAudioEnablePopup() {
      // ã‚µã‚¤ãƒ¬ãƒ³ãƒˆåŒ–ï¼šè‡ªå‹•çš„ã«éŸ³å£°ã‚’æœ‰åŠ¹åŒ–
      audioEnabled = true;
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGi77eifTRAMUKjj8LZjHAY4ktfyzXksBS');
      audio.volume = 0.01;
      audio.play().catch(e => console.log('Audio init'));
    }
    
    // playOrderSoundé–¢æ•°ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ
    
    function playCallSound() {
      console.log('ğŸ”Š å‘¼ã³å‡ºã—éŸ³å£°å†ç”Ÿè©¦è¡Œ - audioEnabled:', audioEnabled);
      if (!audioEnabled) {
        console.log('âš ï¸ éŸ³å£°ãŒç„¡åŠ¹ã§ã™');
        return;
      }
      try {
        const audio = new Audio('./call.wav');
        audio.volume = 1.0;
        audio.addEventListener('loadeddata', () => console.log('âœ… call.wav ãƒ­ãƒ¼ãƒ‰æˆåŠŸ'));
        audio.addEventListener('error', (e) => console.error('âŒ call.wav ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', e));
        audio.play()
          .then(() => console.log('âœ… call.wav å†ç”ŸæˆåŠŸ'))
          .catch(e => console.error('âŒ call.wav å†ç”Ÿå¤±æ•—:', e));
      } catch (e) {
        console.error('âŒ call.wav ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    function playBillSound() {
      console.log('ğŸ”Š ãŠä¼šè¨ˆéŸ³å£°å†ç”Ÿè©¦è¡Œ - audioEnabled:', audioEnabled);
      if (!audioEnabled) {
        console.log('âš ï¸ éŸ³å£°ãŒç„¡åŠ¹ã§ã™');
        return;
      }
      try {
        const audio = new Audio('./okaikei.wav');
        audio.volume = 1.0;
        audio.addEventListener('loadeddata', () => console.log('âœ… okaikei.wav ãƒ­ãƒ¼ãƒ‰æˆåŠŸ'));
        audio.addEventListener('error', (e) => console.error('âŒ okaikei.wav ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', e));
        audio.play()
          .then(() => console.log('âœ… okaikei.wav å†ç”ŸæˆåŠŸ'))
          .catch(e => console.error('âŒ okaikei.wav å†ç”Ÿå¤±æ•—:', e));
      } catch (e) {
        console.error('âŒ okaikei.wav ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    function watchOrders() {
      console.log('ğŸ‘€ æ³¨æ–‡ç›£è¦–é–‹å§‹');
      const unsubscribe = window.onSnapshot(
        window.getStoreCollection('orders'), 
        (snapshot) => {
          const currentCount = snapshot.size;
          console.log('ğŸ“Š æ³¨æ–‡æ•°å¤‰åŒ–:', {
            å‰å›: lastOrderCount,
            ä»Šå›: currentCount,
            åˆå›: isFirstOrderLoad
          });
          
          // éŸ³å£°å†ç”Ÿæ©Ÿèƒ½ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸ
          
          lastOrderCount = currentCount;
          isFirstOrderLoad = false;
        }
      );
      
      return unsubscribe;
    }
    
    function watchStaffCalls() {
      console.log('ğŸ‘€ ã‚¹ã‚¿ãƒƒãƒ•ã‚³ãƒ¼ãƒ«ç›£è¦–é–‹å§‹');
      let isFirstLoad = true;
      let lastCallsSnapshot = [];
      
      const unsubscribe = window.onSnapshot(
        window.getStoreCollection('staff_calls'),
        (snapshot) => {
          const calls = [];
          snapshot.forEach(doc => calls.push({ id: doc.id, ...doc.data() }));
          calls.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
          
          console.log('ğŸ“ ã‚¹ã‚¿ãƒƒãƒ•ã‚³ãƒ¼ãƒ«å¤‰åŒ–:', {
            ã‚³ãƒ¼ãƒ«æ•°: calls.length,
            åˆå›: isFirstLoad
          });
          
          // æ–°ã—ã„å‘¼ã³å‡ºã—ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if (!isFirstLoad && calls.length > 0) {
            const isBill = calls[0].type === 'bill';
            console.log('ğŸ†• æ–°ã—ã„å‘¼ã³å‡ºã—æ¤œå‡ºï¼', isBill ? 'ãŠä¼šè¨ˆ' : 'å‘¼ã³å‡ºã—');
            
            // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã‚’è¡¨ç¤º
            showStaffCallPopup(calls[0], isBill);
            
            // éŸ³å£°ã‚’å†ç”Ÿ
            if (isBill) playBillSound();
            else playCallSound();
          }
          isFirstLoad = false;
          lastCallsSnapshot = calls;
        }
      );
      
      return unsubscribe;
    }
    
    function showStaffCallPopup(call, isBill) {
      // æ—¢å­˜ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒã‚ã‚Œã°å‰Šé™¤
      const existing = document.getElementById('staff-call-popup');
      if (existing) existing.remove();
      
      const overlay = document.createElement('div');
      overlay.id = 'staff-call-popup';
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:20000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.3s;';
      
      const popup = document.createElement('div');
      popup.style.cssText = `
        background:${isBill ? 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)' : 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)'};
        padding:60px;
        border-radius:30px;
        text-align:center;
        box-shadow:0 20px 60px rgba(0,0,0,0.5);
        color:white;
        animation:bounceIn 0.5s;
      `;
      
      const orderNumberHtml = call.orderNumber 
        ? `<div style="font-size:36px;margin-top:20px;font-weight:bold;">æ³¨æ–‡ç•ªå·: #${call.orderNumber}</div>` 
        : '';
      
      popup.innerHTML = `
        <div style="font-size:80px;margin-bottom:20px;">${isBill ? 'ğŸ’³' : 'ğŸ“'}</div>
        <div style="font-size:48px;font-weight:bold;margin-bottom:20px;">
          ${isBill ? 'ãŠä¼šè¨ˆã§ã™' : 'å‘¼ã³å‡ºã—'}
        </div>
        <div style="font-size:64px;font-weight:bold;background:rgba(255,255,255,0.3);padding:20px;border-radius:15px;margin-bottom:20px;">
          ${call.tableNumber || 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ'}
        </div>
        ${orderNumberHtml}
        <button onclick="dismissStaffCallPopup('${call.id}')" style="
          margin-top:30px;
          padding:20px 60px;
          font-size:24px;
          background:white;
          color:${isBill ? '#2196F3' : '#FF9800'};
          border:none;
          border-radius:15px;
          cursor:pointer;
          font-weight:bold;
          box-shadow:0 4px 15px rgba(0,0,0,0.3);
        ">å¯¾å¿œå®Œäº†</button>
      `;
      
      overlay.appendChild(popup);
      document.body.appendChild(overlay);
    }
    
    window.dismissStaffCallPopup = async function(callId) {
      await window.deleteDoc(window.getStoreDoc('staff_calls', callId));
      const popup = document.getElementById('staff-call-popup');
      if (popup) popup.remove();
      showToast('âœ“ å¯¾å¿œå®Œäº†');
    };
    
  </script>
  
  <style>
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes bounceIn {
      0% { transform: scale(0.3); opacity: 0; }
      50% { transform: scale(1.05); }
      70% { transform: scale(0.9); }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
  <div id="customAlert" class="custom-alert-overlay">
    <div class="custom-alert-box">
      <div class="custom-alert-icon" id="customAlertIcon"></div>
      <div class="custom-alert-title" id="customAlertTitle">é€šçŸ¥</div>
      <div class="custom-alert-message" id="customAlertMessage"></div>
      <button class="custom-alert-button" onclick="closeCustomAlert()">OK</button>
    </div>
  </div>
  <div id="productRegistrationModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h3>å•†å“ç™»éŒ²</h3>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å•†å“å</label>
        <input type="text" id="productName" placeholder="ä¾‹: ãŸã“ç„¼ã 6å€‹å…¥ã‚Š" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ä¾¡æ ¼</label>
        <input type="number" id="productPrice" placeholder="ä¾‹: 500" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚«ãƒ†ã‚´ãƒª</label>
        <select id="productCategory" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
          <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          <option value="ãŸã“ç„¼ã">ãŸã“ç„¼ã</option>
          <option value="ãŠå¥½ã¿ç„¼ã">ãŠå¥½ã¿ç„¼ã</option>
          <option value="ç„¼ããã°">ç„¼ããã°</option>
          <option value="é£²ã¿ç‰©">é£²ã¿ç‰©</option>
          <option value="ã‚µã‚¤ãƒ‰">ã‚µã‚¤ãƒ‰</option>
          <option value="ãã®ä»–">ãã®ä»–</option>
        </select>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ†ã‚´ãƒªï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«ãªã„å ´åˆï¼‰</label>
        <input type="text" id="productCustomCategory" placeholder="æ–°ã—ã„ã‚«ãƒ†ã‚´ãƒªå" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">Noteï¼ˆè¡¨ç¤ºåˆ¶é™ï¼‰</label>
        <input type="text" id="productNote" placeholder="ä¾‹: åº—å†…ã®ã¿, ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã®ã¿" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
        <small style="color: #666;">ã€Œåº—å†…ã®ã¿ã€ã¨å…¥åŠ›ã™ã‚‹ã¨ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã§ã¯éè¡¨ç¤ºã€ã€Œãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã®ã¿ã€ã¨å…¥åŠ›ã™ã‚‹ã¨åº—å†…ã§ã¯éè¡¨ç¤ºã«ãªã‚Šã¾ã™</small>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 10px; font-weight: bold;">æ¶ˆè²»ç¨ç‡</label>
        <div style="display: flex; gap: 15px;">
          <label style="display: flex; align-items: center; padding: 12px 20px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; flex: 1; background: white;">
            <input type="radio" name="productTaxRate" value="8" style="margin-right: 8px; width: 20px; height: 20px; cursor: pointer;">
            <span style="font-size: 16px; font-weight: bold;">8%ï¼ˆæŒã¡å¸°ã‚Šï¼‰</span>
          </label>
          <label style="display: flex; align-items: center; padding: 12px 20px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; flex: 1; background: white;">
            <input type="radio" name="productTaxRate" value="10" checked style="margin-right: 8px; width: 20px; height: 20px; cursor: pointer;">
            <span style="font-size: 16px; font-weight: bold;">10%ï¼ˆåº—å†…ãƒ»åŒ…æï¼‰</span>
          </label>
        </div>
        <small style="color: #666; margin-top: 5px; display: block;">ãƒ¬ã‚¸è¢‹ãªã©ã®åŒ…æã¯10%ã‚’é¸æŠã—ã¦ãã ã•ã„</small>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">å•†å“ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
        <input type="file" id="productImageFile" accept="image/*" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
        <button type="button" onclick="uploadProductImage()" style="margin-top: 10px; padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        <div id="upload-progress" style="margin-top: 10px; font-weight: bold;"></div>
        <div id="image-preview" style="margin-top: 10px;"></div>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã¾ãŸã¯ç”»åƒURLã‚’ç›´æ¥å…¥åŠ›</label>
        <input type="text" id="productImage" placeholder="ä¾‹: https://... ã¾ãŸã¯ takoyaki1.jpg" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
        <small style="color: #666;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸç”»åƒã®URLãŒè‡ªå‹•çš„ã«å…¥åŠ›ã•ã‚Œã¾ã™</small>
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
        <h4 style="margin-bottom: 15px;">ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆ</h4>
        <div id="toppingSetsList">
          <!-- ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
        </div>
        <button onclick="addToppingSetToProduct()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px;">+ ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’è¿½åŠ </button>
      </div>
      
      <div style="display: flex; gap: 10px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="registerProduct()">ç™»éŒ²</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeProductRegistrationModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>
  <div id="productDeleteModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h3>å•†å“å‰Šé™¤</h3>
      
      <div style="margin: 20px 0;">
        <input type="text" id="productSearchInput" placeholder="å•†å“åã§æ¤œç´¢..." style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; margin-bottom: 15px;" oninput="filterProductList()">
      </div>
      
      <div id="productDeleteList" style="max-height: 500px; overflow-y: auto;">
        
      </div>
      
      <button class="btn btn-secondary" style="width: 100%; margin-top: 20px;" onclick="closeProductDeleteModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  
  <!-- ãƒˆãƒƒãƒ”ãƒ³ã‚°é †åºå¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="toppingOrderModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
      <h3>ãƒˆãƒƒãƒ”ãƒ³ã‚°é †åºå¤‰æ›´</h3>
      
      <div style="margin: 20px 0;">
        <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
          ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯â†‘â†“ãƒœã‚¿ãƒ³ã§ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã®è¡¨ç¤ºé †åºã‚’å¤‰æ›´ã§ãã¾ã™
        </p>
        
        <div id="toppingOrderList" style="display: flex; flex-direction: column; gap: 10px;">
          <!-- ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã®ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveToppingOrder()">ä¿å­˜</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeToppingOrderModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>
  
  <!-- ä¸¦ã³é †å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="sortOrderModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <h3>ä¸¦ã³é †å¤‰æ›´</h3>
      
      <div style="margin: 20px 0;">
        <label style="display: block; font-weight: bold; margin-bottom: 10px;">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</label>
        <select id="sortCategorySelect" onchange="loadSortProducts()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
          <option value="">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ...</option>
        </select>
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196F3;">
        <div style="font-weight: bold; margin-bottom: 5px;">ğŸ“Œ ä½¿ã„æ–¹</div>
        <div style="font-size: 14px; color: #666;">
          â€¢ å•†å“ã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ä¸¦ã³æ›¿ãˆ<br>
          â€¢ ã€Œä¿å­˜ã€ãƒœã‚¿ãƒ³ã§ç¢ºå®š
        </div>
      </div>
      
      <div id="sortProductsList" style="min-height: 200px; margin: 20px 0;">
        <div style="text-align: center; color: #999; padding: 40px;">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveSortOrder()">ä¿å­˜</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeSortOrderModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="tableManagementModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
      <h3>ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†</h3>
      
      <div style="margin: 20px 0; padding: 15px; background: #e1f5fe; border-radius: 8px; border-left: 4px solid #00BCD4;">
        <div style="font-weight: bold; margin-bottom: 5px;">ğŸ“Œ ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¤ã„ã¦</div>
        <div style="font-size: 14px; color: #666;">
          â€¢ ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã«QRã‚³ãƒ¼ãƒ‰ã‚’ç™ºè¡Œã§ãã¾ã™<br>
          â€¢ ãŠå®¢æ§˜ãŒQRã‚³ãƒ¼ãƒ‰ã‹ã‚‰æ³¨æ–‡ã™ã‚‹ã¨ã€ãã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ³¨æ–‡ãŒå±Šãã¾ã™<br>
          â€¢ ãƒ†ãƒ¼ãƒ–ãƒ«åã¯è‹±æ•°å­—ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™ï¼ˆä¾‹: table1, A01ï¼‰
        </div>
      </div>
      
      <div style="margin: 20px 0;">
        <button onclick="showAddTableModal()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #00BCD4 0%, #0097A7 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold;">â• æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ </button>
      </div>
      
      <div style="margin: 20px 0;">
        <h4 style="margin-bottom: 10px;">ç™»éŒ²æ¸ˆã¿ãƒ†ãƒ¼ãƒ–ãƒ«</h4>
        <div id="tablesList" style="max-height: 400px; overflow-y: auto;">
          <div style="text-align: center; color: #999; padding: 20px;">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
      
      <button class="btn btn-secondary" style="width: 100%;" onclick="closeTableManagementModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="addTableModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 600px;">
      <h3>ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ </h3>
      
      <div style="margin: 20px 0;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">ãƒ†ãƒ¼ãƒ–ãƒ«å *</label>
        <input type="text" id="newTableName" placeholder="ä¾‹: table1, A01, äºˆç´„1" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
        <small style="color: #666;">è‹±æ•°å­—ã®ã¿ä½¿ç”¨å¯èƒ½ï¼ˆæ—¥æœ¬èªä¸å¯ï¼‰</small>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">ã‚¹ã‚¿ãƒƒãƒ•ãƒ¡ãƒ¢</label>
        <textarea id="newTableStaffMemo" placeholder="äºˆç´„ã®è©³ç´°ã€ãŠå®¢æ§˜æƒ…å ±ãªã©ï¼ˆã‚¹ã‚¿ãƒƒãƒ•å°‚ç”¨ï¼‰" rows="3" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
        <small style="color: #666;">ã“ã®ãƒ¡ãƒ¢ã¯ã‚¹ã‚¿ãƒƒãƒ•ã®ã¿ç¢ºèªã§ãã¾ã™ï¼ˆãŠå®¢æ§˜ã«ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ï¼‰</small>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; font-weight: bold; margin-bottom: 10px;">ãŠå®¢æ§˜ãƒ¡ãƒ¢æ©Ÿèƒ½</label>
        <div style="display: flex; gap: 20px;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="radio" name="tableMemo" value="true" style="margin-right: 8px;">
            <span>å¿…è¦</span>
          </label>
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="radio" name="tableMemo" value="false" checked style="margin-right: 8px;">
            <span>ä¸è¦</span>
          </label>
        </div>
        <small style="color: #666;">ãŠå®¢æ§˜ãŒæ³¨æ–‡æ™‚ã«ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™</small>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="addTable()">è¿½åŠ </button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeAddTableModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="editTableModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 600px;">
      <h3>ãƒ†ãƒ¼ãƒ–ãƒ«ç·¨é›†</h3>
      
      <input type="hidden" id="editTableId">
      
      <div style="margin: 20px 0;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">ãƒ†ãƒ¼ãƒ–ãƒ«å *</label>
        <input type="text" id="editTableName" placeholder="ä¾‹: table1, A01, äºˆç´„1" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
        <small style="color: #666;">è‹±æ•°å­—ã®ã¿ä½¿ç”¨å¯èƒ½ï¼ˆæ—¥æœ¬èªä¸å¯ï¼‰</small>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">ã‚¹ã‚¿ãƒƒãƒ•ãƒ¡ãƒ¢</label>
        <textarea id="editTableStaffMemo" placeholder="äºˆç´„ã®è©³ç´°ã€ãŠå®¢æ§˜æƒ…å ±ãªã©ï¼ˆã‚¹ã‚¿ãƒƒãƒ•å°‚ç”¨ï¼‰" rows="3" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
        <small style="color: #666;">ã“ã®ãƒ¡ãƒ¢ã¯ã‚¹ã‚¿ãƒƒãƒ•ã®ã¿ç¢ºèªã§ãã¾ã™ï¼ˆãŠå®¢æ§˜ã«ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ï¼‰</small>
      </div>
      
      <div style="margin: 20px 0;">
        <label style="display: block; font-weight: bold; margin-bottom: 10px;">ãŠå®¢æ§˜ãƒ¡ãƒ¢æ©Ÿèƒ½</label>
        <div style="display: flex; gap: 20px;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="radio" name="editTableMemo" value="true" style="margin-right: 8px;">
            <span>å¿…è¦</span>
          </label>
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="radio" name="editTableMemo" value="false" style="margin-right: 8px;">
            <span>ä¸è¦</span>
          </label>
        </div>
        <small style="color: #666;">ãŠå®¢æ§˜ãŒæ³¨æ–‡æ™‚ã«ãƒ¡ãƒ¢ã‚’å…¥åŠ›ã§ãã‚‹ã‚ˆã†ã«ã—ã¾ã™</small>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveTableEdit()">ä¿å­˜</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditTableModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>

  <!-- QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="qrCodeModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 500px; text-align: center;">
      <h3 id="qrTableName">ãƒ†ãƒ¼ãƒ–ãƒ«</h3>
      
      <div style="margin: 30px 0;">
        <div id="qrCodeContainer" style="display: flex; justify-content: center;"></div>
      </div>
      
      <div style="margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 8px;">
        <div style="font-weight: bold; margin-bottom: 5px;">æ³¨æ–‡URL</div>
        <div id="qrTableUrl" style="word-break: break-all; color: #666; font-size: 14px;"></div>
      </div>
      
      <button class="btn btn-secondary" style="width: 100%;" onclick="closeQrCodeModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="tableMemoModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 600px;">
      <h3>ğŸ“ ã‚¹ã‚¿ãƒƒãƒ•ãƒ¡ãƒ¢ - <span id="memoTableName"></span></h3>
      
      <input type="hidden" id="memoTableId">
      
      <div style="margin: 20px 0;">
        <textarea id="memoTableStaffMemo" placeholder="äºˆç´„ã®è©³ç´°ã€ãŠå®¢æ§˜æƒ…å ±ãªã©ï¼ˆã‚¹ã‚¿ãƒƒãƒ•å°‚ç”¨ï¼‰" rows="5" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; resize: vertical;"></textarea>
        <small style="color: #666;">ã“ã®ãƒ¡ãƒ¢ã¯ã‚¹ã‚¿ãƒƒãƒ•ã®ã¿ç¢ºèªã§ãã¾ã™ï¼ˆãŠå®¢æ§˜ã«ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“ï¼‰</small>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="saveTableMemo()">ä¿å­˜</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeTableMemoModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>
  
  <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="deleteConfirmModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 500px;">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 60px; margin-bottom: 10px;">âš ï¸</div>
        <h3 style="margin: 0; font-size: 24px; color: #f44336;">ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h3>
      </div>
      
      <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; margin: 20px 0;">
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px; color: #333;">
          <span id="deleteTableName"></span>
        </div>
        <div style="color: #666; line-height: 1.8;">
          âš ï¸ ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®QRã‚³ãƒ¼ãƒ‰ã¯ä½¿ç”¨ã§ããªããªã‚Šã¾ã™<br>
          âš ï¸ ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“
        </div>
      </div>
      
      <input type="hidden" id="deleteTableId">
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeDeleteConfirmModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white;" onclick="confirmDeleteTable()">ğŸ—‘ï¸ å‰Šé™¤ã™ã‚‹</button>
      </div>
    </div>
  </div>

  <!-- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="logoutConfirmModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 500px;">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 60px; margin-bottom: 10px;"></div>
        <h3 style="margin: 0; font-size: 24px; color: #667eea;">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ</h3>
      </div>
      
      <div style="background: #e3f2fd; border: 2px solid #2196F3; border-radius: 10px; padding: 20px; margin: 20px 0;">
        <div style="color: #666; line-height: 1.8; text-align: center;">
          ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã™ã‚‹ã¨ã€å†åº¦ãƒ­ã‚°ã‚¤ãƒ³ãŒå¿…è¦ã«ãªã‚Šã¾ã™
        </div>
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeLogoutConfirmModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;" onclick="confirmLogout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
      </div>
    </div>
  </div>

  <!-- é‡‘é¡å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="priceChangeModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 500px;">
      <div style="text-align: center; margin-bottom: 20px;">
        <div style="font-size: 50px; margin-bottom: 10px;"></div>
        <h3 style="margin: 0; font-size: 20px; color: #333;" id="priceChangeTitle">é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</h3>
      </div>
      
      <div style="background: #f5f5f5; border-radius: 10px; padding: 15px; margin: 20px 0; text-align: center;">
        <div style="color: #666; margin-bottom: 10px;" id="priceChangeItemInfo"></div>
        <div style="font-size: 18px; font-weight: bold; color: #333;">
          ç¾åœ¨: <span id="priceChangeCurrentPrice"></span>
        </div>
      </div>
      
      <div style="margin: 20px 0;">
        <input type="number" id="priceChangeInput" placeholder="æ–°ã—ã„é‡‘é¡ã‚’å…¥åŠ›" style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 8px; font-size: 24px; text-align: center;">
      </div>
      
      <input type="hidden" id="priceChangeItemId">
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn btn-secondary" style="flex: 1;" onclick="closePriceChangeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white;" onclick="confirmPriceChange()">âœ“ å¤‰æ›´</button>
      </div>
    </div>
  </div>

  <!-- å•†å“ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="productEditModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
      <h3>å•†å“ç·¨é›†</h3>
      
      <input type="hidden" id="editProductId">
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">å•†å“å *</label>
        <input type="text" id="editProductName" placeholder="å•†å“åã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">ä¾¡æ ¼ *</label>
        <input type="number" id="editProductPrice" placeholder="ä¾¡æ ¼ã‚’å…¥åŠ›" min="0" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">ã‚«ãƒ†ã‚´ãƒª *</label>
        <input type="text" id="editProductCategory" placeholder="ã‚«ãƒ†ã‚´ãƒªã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆ</label>
        <div id="editToppingDiagnostic"></div>
        <div id="editToppingSetsContainer"></div>
        <button type="button" onclick="addEditToppingSet()" style="padding: 8px 15px; background: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; margin-top: 10px;">+ ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆè¿½åŠ </button>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">å‚™è€ƒ</label>
        <textarea id="editProductNote" placeholder="å‚™è€ƒã‚’å…¥åŠ›" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; min-height: 80px;"></textarea>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; margin-bottom: 10px; font-weight: bold;">æ¶ˆè²»ç¨ç‡</label>
        <div style="display: flex; gap: 15px;">
          <label style="display: flex; align-items: center; padding: 12px 20px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; flex: 1; background: white;">
            <input type="radio" name="editProductTaxRate" value="8" style="margin-right: 8px; width: 20px; height: 20px; cursor: pointer;">
            <span style="font-size: 16px; font-weight: bold;">8%ï¼ˆæŒã¡å¸°ã‚Šï¼‰</span>
          </label>
          <label style="display: flex; align-items: center; padding: 12px 20px; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; flex: 1; background: white;">
            <input type="radio" name="editProductTaxRate" value="10" style="margin-right: 8px; width: 20px; height: 20px; cursor: pointer;">
            <span style="font-size: 16px; font-weight: bold;">10%ï¼ˆåº—å†…ãƒ»åŒ…æï¼‰</span>
          </label>
        </div>
        <small style="color: #666; margin-top: 5px; display: block;">ãƒ¬ã‚¸è¢‹ãªã©ã®åŒ…æã¯10%ã‚’é¸æŠã—ã¦ãã ã•ã„</small>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">å•†å“ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
        <input type="file" id="editProductImageFile" accept="image/*" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 14px;">
        <button type="button" onclick="uploadEditProductImage()" style="margin-top: 10px; padding: 10px 20px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;">ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
        <div id="edit-upload-progress" style="margin-top: 10px; font-weight: bold;"></div>
        <div id="edit-image-preview" style="margin-top: 10px;"></div>
      </div>
      
      <div style="margin-bottom: 15px;">
        <label style="display: block; font-weight: bold; margin-bottom: 5px;">ã¾ãŸã¯ç”»åƒURLã‚’ç›´æ¥å…¥åŠ›</label>
        <input type="text" id="editProductImage" placeholder="ä¾‹: https://... ã¾ãŸã¯ takoyaki1.jpg" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px;">
      </div>
      
      <div style="display: flex; gap: 10px; margin-top: 20px;">
        <button class="btn" style="flex: 1; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white;" onclick="saveEditedProduct()">âœï¸ æ›´æ–°</button>
        <button class="btn btn-secondary" style="flex: 1;" onclick="closeEditProductModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>
  
  <div id="page-soldout" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 10000; padding: 20px; overflow-y: auto;">
    <div style="max-width: 1200px; margin: 0 auto;">
      <button onclick="backFromSoldOut()" style="padding: 15px 30px; font-size: 18px; background: #FFFF00; color: #333; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">â† æˆ»ã‚‹</button>
      
      <div style="background: white; color: #667eea; padding: 15px 20px; border-radius: 15px; margin-bottom: 15px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.2);">
        <h1 style="font-size: 20px; font-weight: bold; margin: 0;">å“åˆ‡ã‚Œè¨­å®š</h1>
      </div>
      
      <div style="background: white; padding: 15px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
        <label style="display: block; font-size: 16px; font-weight: bold; margin-bottom: 10px;">ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„</label>
        <select id="soldout-category-select" style="width: 100%; padding: 15px; font-size: 18px; border: 3px solid #9C27B0; border-radius: 12px;">
          <option value="">å…¨ã¦ã®å•†å“</option>
        </select>
      </div>
      
      <div id="soldout-menu-list"></div>
    </div>
  </div>
  
  </div> 
  
  <script>
    // ========== å•†å“ç™»éŒ²ãƒ»å‰Šé™¤æ©Ÿèƒ½ ==========
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã®ç®¡ç†ç”¨é…åˆ—
    let productToppingSets = [];
    
    // å•†å“ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showProductRegistrationModal = function() {
      document.getElementById('productRegistrationModal').classList.remove('hidden');
      
      // âœ… ãƒ•ã‚©ãƒ¼ãƒ ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('productName').value = '';
      document.getElementById('productPrice').value = '';
      document.getElementById('productCategory').value = 'ãƒ¡ã‚¤ãƒ³';
      document.getElementById('productCustomCategory').value = '';
      document.getElementById('productNote').value = '';
      document.getElementById('productImage').value = '';
      
      // âœ… ç¨ç‡ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆ10%ï¼‰ã«è¨­å®š
      const taxRateRadios = document.querySelectorAll('input[name="productTaxRate"]');
      taxRateRadios.forEach(radio => {
        radio.checked = (radio.value === '10');
      });
      
      // âœ… ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
      productToppingSets = [];
      const toppingSetsList = document.getElementById('toppingSetsList');
      if (toppingSetsList) {
        toppingSetsList.innerHTML = '';
      }
      
      console.log('âœ… å•†å“ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¾ã—ãŸï¼ˆã™ã¹ã¦ã‚¯ãƒªã‚¢æ¸ˆã¿ï¼‰');
    };
    
    // å•†å“ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeProductRegistrationModal = function() {
      document.getElementById('productRegistrationModal').classList.add('hidden');
      
      // âœ… å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('productName').value = '';
      document.getElementById('productPrice').value = '';
      document.getElementById('productCategory').value = 'ãƒ¡ã‚¤ãƒ³';
      document.getElementById('productCustomCategory').value = '';
      document.getElementById('productNote').value = '';
      document.getElementById('productImage').value = '';
      
      // âœ… ç¨ç‡ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«æˆ»ã™
      const taxRateRadios = document.querySelectorAll('input[name="productTaxRate"]');
      taxRateRadios.forEach(radio => {
        radio.checked = (radio.value === '10');
      });
      
      // âœ… ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
      const toppingSetsList = document.getElementById('toppingSetsList');
      if (toppingSetsList) {
        toppingSetsList.innerHTML = '';
      }
      productToppingSets = [];
      
      console.log('âœ… å•†å“ç™»éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’è¿½åŠ 
    window.addToppingSetToProduct = function() {
      const setDiv = document.createElement('div');
      setDiv.style.cssText = 'margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #ddd;';
      const setIndex = productToppingSets.length;
      
      setDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <h5 style="margin: 0;">ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆ ${setIndex + 1}</h5>
          <button onclick="removeToppingSet(${setIndex})" style="padding: 5px 10px; background: #F44336; color: white; border: none; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
        </div>
        
        <div style="margin-bottom: 10px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚»ãƒƒãƒˆå</label>
          <input type="text" class="topping-set-name" placeholder="ä¾‹: ãŸã“ç„¼ãã®å‘³" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
        </div>
        
        <div style="margin-bottom: 10px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">é¸æŠã‚¿ã‚¤ãƒ—</label>
          <select class="topping-set-type" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
            <option value="single">å˜ä¸€é¸æŠï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰</option>
            <option value="multiple">è¤‡æ•°é¸æŠï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰</option>
          </select>
        </div>
        
        <div style="margin-bottom: 10px;">
          <label style="display: block; margin-bottom: 5px; font-weight: bold;">ãƒˆãƒƒãƒ”ãƒ³ã‚°é …ç›®</label>
          <div class="topping-options-list" style="margin-bottom: 10px;">
            <!-- ãƒˆãƒƒãƒ”ãƒ³ã‚°é …ç›®ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
          </div>
          <button onclick="addToppingOption(${setIndex})" style="padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">+ é …ç›®ã‚’è¿½åŠ </button>
        </div>
      `;
      
      document.getElementById('toppingSetsList').appendChild(setDiv);
      productToppingSets.push({ options: [] });
      
      // åˆæœŸé …ç›®ã‚’1ã¤è¿½åŠ 
      addToppingOption(setIndex);
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’å‰Šé™¤
    window.removeToppingSet = function(index) {
      productToppingSets.splice(index, 1);
      renderToppingSets();
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°é …ç›®ã‚’è¿½åŠ 
    window.addToppingOption = function(setIndex) {
      const optionsList = document.getElementById('toppingSetsList').children[setIndex].querySelector('.topping-options-list');
      const optionDiv = document.createElement('div');
      optionDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 8px; align-items: center;';
      optionDiv.innerHTML = `
        <input type="text" class="topping-option-name" placeholder="ä¾‹: ã‚½ãƒ¼ã‚¹" style="flex: 2; padding: 6px; border: 2px solid #ddd; border-radius: 4px;">
        <input type="number" class="topping-option-price" placeholder="ä¾¡æ ¼" value="0" style="flex: 1; padding: 6px; border: 2px solid #ddd; border-radius: 4px;">
        <button onclick="this.parentElement.remove()" style="padding: 6px 10px; background: #F44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Ã—</button>
      `;
      optionsList.appendChild(optionDiv);
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’å†æç”»ï¼ˆå…¥åŠ›å†…å®¹ã‚’ä¿æŒï¼‰
    function renderToppingSets() {
      const container = document.getElementById('toppingSetsList');
      
      // ç¾åœ¨ã®å…¥åŠ›å†…å®¹ã‚’ä¿å­˜
      const currentData = [];
      const setDivs = container.children;
      
      for (let i = 0; i < setDivs.length; i++) {
        const setDiv = setDivs[i];
        const setData = {
          name: setDiv.querySelector('.topping-set-name')?.value || '',
          type: setDiv.querySelector('.topping-set-type')?.value || 'single',
          options: []
        };
        
        const optionDivs = setDiv.querySelectorAll('.topping-options-list > div');
        optionDivs.forEach(optionDiv => {
          setData.options.push({
            name: optionDiv.querySelector('.topping-option-name')?.value || '',
            price: optionDiv.querySelector('.topping-option-price')?.value || '0'
          });
        });
        
        currentData.push(setData);
      }
      
      // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
      container.innerHTML = '';
      
      // ä¿å­˜ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦å†æ§‹ç¯‰
      currentData.forEach((setData, setIndex) => {
        const setDiv = document.createElement('div');
        setDiv.style.cssText = 'margin-bottom: 15px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #ddd;';
        
        setDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h5 style="margin: 0;">ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆ ${setIndex + 1}</h5>
            <button onclick="removeToppingSet(${setIndex})" style="padding: 5px 10px; background: #F44336; color: white; border: none; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
          </div>
          
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ã‚»ãƒƒãƒˆå</label>
            <input type="text" class="topping-set-name" placeholder="ä¾‹: ãŸã“ç„¼ãã®å‘³" value="${setData.name}" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
          </div>
          
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">é¸æŠã‚¿ã‚¤ãƒ—</label>
            <select class="topping-set-type" style="width: 100%; padding: 8px; border: 2px solid #ddd; border-radius: 6px;">
              <option value="single" ${setData.type === 'single' ? 'selected' : ''}>å˜ä¸€é¸æŠï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰</option>
              <option value="multiple" ${setData.type === 'multiple' ? 'selected' : ''}>è¤‡æ•°é¸æŠï¼ˆãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ï¼‰</option>
            </select>
          </div>
          
          <div style="margin-bottom: 10px;">
            <label style="display: block; margin-bottom: 5px; font-weight: bold;">ãƒˆãƒƒãƒ”ãƒ³ã‚°é …ç›®</label>
            <div class="topping-options-list" style="margin-bottom: 10px;">
              <!-- ãƒˆãƒƒãƒ”ãƒ³ã‚°é …ç›®ãŒã“ã“ã«è¿½åŠ ã•ã‚Œã¾ã™ -->
            </div>
            <button onclick="addToppingOption(${setIndex})" style="padding: 6px 12px; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">+ é …ç›®ã‚’è¿½åŠ </button>
          </div>
        `;
        
        container.appendChild(setDiv);
        
        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
        const optionsList = setDiv.querySelector('.topping-options-list');
        setData.options.forEach(option => {
          const optionDiv = document.createElement('div');
          optionDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 8px; align-items: center;';
          optionDiv.innerHTML = `
            <input type="text" class="topping-option-name" placeholder="ä¾‹: ã‚½ãƒ¼ã‚¹" value="${option.name}" style="flex: 2; padding: 6px; border: 2px solid #ddd; border-radius: 4px;">
            <input type="number" class="topping-option-price" placeholder="ä¾¡æ ¼" value="${option.price}" style="flex: 1; padding: 6px; border: 2px solid #ddd; border-radius: 4px;">
            <button onclick="this.parentElement.remove()" style="padding: 6px 10px; background: #F44336; color: white; border: none; border-radius: 4px; cursor: pointer;">Ã—</button>
          `;
          optionsList.appendChild(optionDiv);
        });
      });
    }
    
    // ========== ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ ==========
    
    // å•†å“ç™»éŒ²ç”¨ã®ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    window.uploadProductImage = async function() {
      const fileInput = document.getElementById('productImageFile');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      const progressDiv = document.getElementById('upload-progress');
      const previewDiv = document.getElementById('image-preview');
      progressDiv.textContent = 'â³ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
      progressDiv.style.color = '#2196F3';
      
      try {
        // Firebase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        const timestamp = Date.now();
        const fileName = `${timestamp}_${file.name}`;
        const storageReference = window.storageRef(window.storage, `products/${fileName}`);
        
        await window.uploadBytes(storageReference, file);
        
        // URLã‚’å–å¾—
        const imageUrl = await window.getDownloadURL(storageReference);
        
        // å•†å“ç”»åƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è‡ªå‹•å…¥åŠ›
        document.getElementById('productImage').value = imageUrl;
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        previewDiv.innerHTML = `<img src="${imageUrl}" style="max-width: 200px; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">`;
        
        progressDiv.textContent = 'âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†';
        progressDiv.style.color = '#4CAF50';
        
        setTimeout(() => {
          progressDiv.textContent = '';
        }, 3000);
      } catch (error) {
        console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        progressDiv.textContent = 'âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ' + error.message;
        progressDiv.style.color = '#f44336';
      }
    };
    
    // å•†å“ç·¨é›†ç”¨ã®ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    window.uploadEditProductImage = async function() {
      const fileInput = document.getElementById('editProductImageFile');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      const progressDiv = document.getElementById('edit-upload-progress');
      const previewDiv = document.getElementById('edit-image-preview');
      progressDiv.textContent = 'â³ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
      progressDiv.style.color = '#2196F3';
      
      try {
        // Firebase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        const timestamp = Date.now();
        const fileName = `${timestamp}_${file.name}`;
        const storageReference = window.storageRef(window.storage, `products/${fileName}`);
        
        await window.uploadBytes(storageReference, file);
        
        // URLã‚’å–å¾—
        const imageUrl = await window.getDownloadURL(storageReference);
        
        // å•†å“ç”»åƒãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«è‡ªå‹•å…¥åŠ›
        document.getElementById('editProductImage').value = imageUrl;
        
        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        previewDiv.innerHTML = `<img src="${imageUrl}" style="max-width: 200px; max-height: 200px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">`;
        
        progressDiv.textContent = 'âœ… ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†';
        progressDiv.style.color = '#4CAF50';
        
        setTimeout(() => {
          progressDiv.textContent = '';
        }, 3000);
      } catch (error) {
        console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
        progressDiv.textContent = 'âŒ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¤±æ•—: ' + error.message;
        progressDiv.style.color = '#f44336';
      }
    };
    
    // å•†å“ã‚’ç™»éŒ²
    window.registerProduct = async function() {
      const name = document.getElementById('productName').value.trim();
      const price = parseInt(document.getElementById('productPrice').value);
      const category = document.getElementById('productCategory').value;
      const customCategory = document.getElementById('productCustomCategory').value.trim();
      const note = document.getElementById('productNote').value.trim();
      const image = document.getElementById('productImage').value.trim();
      
      // ç¨ç‡ã‚’å–å¾—
      const taxRateRadio = document.querySelector('input[name="productTaxRate"]:checked');
      const taxRate = taxRateRadio ? parseInt(taxRateRadio.value) : 10;
      
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!name) {
        alert('å•†å“åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!price || price < 0) {
        alert('æ­£ã—ã„ä¾¡æ ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      const finalCategory = customCategory || category;
      if (!finalCategory) {
        alert('ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã™ã‚‹ã‹ã€ã‚«ã‚¹ã‚¿ãƒ ã‚«ãƒ†ã‚´ãƒªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’åé›†
      const toppingSets = [];
      const setDivs = document.getElementById('toppingSetsList').children;
      
      for (let i = 0; i < setDivs.length; i++) {
        const setDiv = setDivs[i];
        const setName = setDiv.querySelector('.topping-set-name').value.trim();
        const setType = setDiv.querySelector('.topping-set-type').value;
        
        if (!setName) continue; // åå‰ãŒãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
        
        const options = [];
        const optionDivs = setDiv.querySelectorAll('.topping-options-list > div');
        
        optionDivs.forEach(optionDiv => {
          const optionName = optionDiv.querySelector('.topping-option-name').value.trim();
          const optionPrice = parseInt(optionDiv.querySelector('.topping-option-price').value) || 0;
          
          if (optionName) {
            options.push({ name: optionName, price: optionPrice });
          }
        });
        
        if (options.length > 0) {
          toppingSets.push({
            name: setName,
            type: setType,
            options: options
          });
        }
      }
      
      try {
        console.log('ğŸ”§ å•†å“ç™»éŒ²é–‹å§‹');
        console.log('  toppingSets:', toppingSets);
        
        // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’toppingsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ç™»éŒ²ã—ã¦IDã‚’å–å¾—
        const toppingIds = [];
        
        if (toppingSets.length > 0) {
          console.log('âœ… ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚ã‚Šã€toppingsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ç™»éŒ²é–‹å§‹');
          
          // æœ€æ–°ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°IDã‚’å–å¾—
          const toppingsSnapshot = await window.getDocs(window.getStoreCollection('toppings'));
          let maxNum = 15; // T0016ã‹ã‚‰é–‹å§‹
          
          toppingsSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.id && data.id.startsWith('T')) {
              const num = parseInt(data.id.substring(1));
              if (num > maxNum) maxNum = num;
            }
          });
          
          console.log('  ç¾åœ¨ã®æœ€å¤§ãƒˆãƒƒãƒ”ãƒ³ã‚°ç•ªå·:', maxNum);
          
          // å„ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’toppingsã«ç™»éŒ²
          for (const set of toppingSets) {
            console.log('  ã‚»ãƒƒãƒˆ:', set.name);
            for (const option of set.options) {
              maxNum++;
              const toppingId = 'T' + String(maxNum).padStart(4, '0');
              
              console.log('    ç™»éŒ²:', toppingId, option.name, option.price);
              
              await window.addDoc(window.getStoreCollection('toppings'), {
                id: toppingId,
                name: option.name,
                price: option.price,
                order: maxNum
              });
              
              toppingIds.push(toppingId);
            }
          }
          
          console.log('  ç™»éŒ²å®Œäº†ã€‚toppingIds:', toppingIds);
        } else {
          console.log('âš ï¸ ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆãªã—');
        }
        
        // ğŸ†• æ—¢å­˜ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æœ€å¤§IDã‚’å–å¾—
        const menusSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        let maxMenuNum = 0;
        let maxOrder = 0;
        
        menusSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.id) {
            // æ—¢å­˜ã®IDãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¿œã˜ã¦å‡¦ç†
            const match = data.id.match(/\d+$/);
            if (match) {
              const num = parseInt(match[0]);
              if (num > maxMenuNum) maxMenuNum = num;
            }
          }
          // orderãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æœ€å¤§å€¤ã‚‚å–å¾—
          if (data.order && data.order > maxOrder) {
            maxOrder = data.order;
          }
        });
        
        // æ–°ã—ã„IDã‚’ç”Ÿæˆï¼ˆM0001å½¢å¼ï¼‰
        maxMenuNum++;
        const productId = 'M' + String(maxMenuNum).padStart(4, '0');
        
        // æ–°ã—ã„orderå€¤ã‚’ç”Ÿæˆ
        maxOrder++;
        
        // Firebaseã«å•†å“ã‚’è¿½åŠ 
        const productData = {
          id: productId,  // ğŸ†• IDãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
          name: name,
          price: price,
          category: finalCategory,
          toppingSets: toppingSets,
          toppingsId: toppingIds.join(','), // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§ä¿å­˜
          note: note,
          image: image || '',
          taxRate: taxRate,  // é¸æŠã—ãŸç¨ç‡ã‚’ä¿å­˜
          order: maxOrder,  // ğŸ†• è¡¨ç¤ºé †ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
          createdAt: window.Timestamp.now()
        };
        
        console.log('ğŸ“ å•†å“ãƒ‡ãƒ¼ã‚¿:', productData);
        console.log('  toppingsId:', productData.toppingsId);
        
        await window.addDoc(window.getStoreCollection('menus'), productData);
        
        await showCustomAlert('âœ… å•†å“ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
        
        // âœ… ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’ç¢ºå®Ÿã«ã‚¯ãƒªã‚¢
        const toppingSetsList = document.getElementById('toppingSetsList');
        if (toppingSetsList) {
          toppingSetsList.innerHTML = '';
        }
        productToppingSets = [];
        console.log('âœ… ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        
        closeProductRegistrationModal();
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å†èª­ã¿è¾¼ã¿
        await initializeSystem();
        
      } catch (error) {
        console.error('å•†å“ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert('âŒ å•†å“ã®ç™»éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error.message);
      }
    };
    
    // å•†å“å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showProductDeleteModal = async function() {
      document.getElementById('productDeleteModal').classList.remove('hidden');
      await loadProductDeleteList();
    };
    
    // å•†å“å‰Šé™¤ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeProductDeleteModal = function() {
      document.getElementById('productDeleteModal').classList.add('hidden');
    };
    
    // å‰Šé™¤ç”¨ã®å•†å“ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
    let allProductsForDelete = [];
    async function loadProductDeleteList() {
      try {
        const container = document.getElementById('productDeleteList');
        container.innerHTML = '<div style="text-align: center; padding: 20px;">èª­ã¿è¾¼ã¿ä¸­...</div>';
        
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        allProductsForDelete = [];
        
        menuSnapshot.forEach(doc => {
          allProductsForDelete.push({
            docId: doc.id,  // Firebaseã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆID
            ...doc.data()
          });
        });
        
        // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«ã‚½ãƒ¼ãƒˆ
        allProductsForDelete.sort((a, b) => {
          if (a.category !== b.category) {
            return a.category.localeCompare(b.category);
          }
          return a.name.localeCompare(b.name);
        });
        
        displayProductDeleteList(allProductsForDelete);
        
      } catch (error) {
        console.error('å•†å“ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('productDeleteList').innerHTML = '<div style="text-align: center; padding: 20px; color: red;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    }
    
    // å•†å“å‰Šé™¤ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
    function displayProductDeleteList(products) {
      const container = document.getElementById('productDeleteList');
      
      if (products.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = '';
      
      products.forEach(product => {
        const productDiv = document.createElement('div');
        productDiv.style.cssText = 'padding: 15px; margin-bottom: 10px; background: white; border-radius: 8px; border: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;';
        
        const infoDiv = document.createElement('div');
        infoDiv.innerHTML = `
          <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${product.name}</div>
          <div style="color: #666; font-size: 14px;">
            <span style="background: #E3F2FD; padding: 2px 8px; border-radius: 4px; margin-right: 10px;">${product.category}</span>
            <span style="color: #4CAF50; font-weight: bold;">Â¥${product.price.toLocaleString()}</span>
          </div>
        `;
        
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = 'ğŸ—‘ï¸ å‰Šé™¤';
        deleteBtn.style.cssText = 'padding: 8px 20px; background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; margin-left: 10px;';
        deleteBtn.onclick = () => deleteProduct(product.docId, product.name);
        
        const editBtn = document.createElement('button');
        editBtn.textContent = 'âœï¸ ç·¨é›†';
        editBtn.style.cssText = 'padding: 8px 20px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;';
        editBtn.onclick = () => openEditProductModal(product);
        
        const orderBtn = document.createElement('button');
        orderBtn.textContent = 'ğŸ”¢ é †åº';
        orderBtn.style.cssText = 'padding: 8px 20px; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;';
        orderBtn.onclick = () => openToppingOrderForProduct(product);
        
        const btnContainer = document.createElement('div');
        btnContainer.style.cssText = 'display: flex; gap: 10px;';
        btnContainer.appendChild(orderBtn);
        btnContainer.appendChild(editBtn);
        btnContainer.appendChild(deleteBtn);
        
        productDiv.appendChild(infoDiv);
        productDiv.appendChild(btnContainer);
        container.appendChild(productDiv);
      });
    }
    
    // ========== ä¸¦ã³é †å¤‰æ›´æ©Ÿèƒ½ ==========
    
    let sortProducts = [];
    let draggedElement = null;
    
    // ä¸¦ã³é †å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showSortOrderModal = async function() {
      document.getElementById('sortOrderModal').classList.remove('hidden');
      await loadSortCategories();
    };
    
    // ä¸¦ã³é †å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeSortOrderModal = function() {
      document.getElementById('sortOrderModal').classList.add('hidden');
      sortProducts = [];
      document.getElementById('sortProductsList').innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
    };
    
    // ========== ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†æ©Ÿèƒ½ ==========
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.showTableManagementModal = async function() {
      document.getElementById('tableManagementModal').classList.remove('hidden');
      await loadTablesList();
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeTableManagementModal = function() {
      document.getElementById('tableManagementModal').classList.add('hidden');
    };
    
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆé–¢æ•°
    window.logout = function() {
      // ã‚«ã‚¹ã‚¿ãƒ ãƒ­ã‚°ã‚¢ã‚¦ãƒˆç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      document.getElementById('logoutConfirmModal').classList.remove('hidden');
    };
    
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeLogoutConfirmModal = function() {
      document.getElementById('logoutConfirmModal').classList.add('hidden');
    };
    
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚’ç¢ºå®š
    window.confirmLogout = async function() {
      closeLogoutConfirmModal();
      
      try {
        await window.signOut(window.auth);
        // ãƒ­ã‚°ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        window.location.href = 'index.html';
      } catch (error) {
        console.error('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        showErrorMessage('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };
    
    // é‡‘é¡å¤‰æ›´ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closePriceChangeModal = function() {
      document.getElementById('priceChangeModal').classList.add('hidden');
    };
    
    // é‡‘é¡å¤‰æ›´ã‚’ç¢ºå®š
    window.confirmPriceChange = function() {
      const index = document.getElementById('priceChangeItemId').value;
      const newPrice = document.getElementById('priceChangeInput').value;
      
      if (!newPrice || newPrice === '') {
        showErrorMessage('é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      const numPrice = parseInt(newPrice);
      if (isNaN(numPrice) || numPrice < 0) {
        showErrorMessage('æ­£ã—ã„é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      // é‡‘é¡è¡¨ç¤ºã‚’æ›´æ–°
      document.getElementById(`itemPrice${index}`).textContent = `Â¥${numPrice.toLocaleString()}`;
      
      // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®data-amountã‚’æ›´æ–°
      document.querySelectorAll(`input[name="taxRate${index}"]`).forEach(radio => {
        radio.dataset.amount = numPrice;
      });
      
      // ç¨ç‡åˆ¥é›†è¨ˆã¨è«‹æ±‚é¡ã‚’å†è¨ˆç®—
      calculateTaxSummary();
      
      console.log(`âœ… å•†å“${index}ã®é‡‘é¡ã‚’å¤‰æ›´: Â¥${numPrice}`);
      
      closePriceChangeModal();
      showSuccessMessage('é‡‘é¡ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadTablesList() {
      try {
        const container = document.getElementById('tablesList');
        container.innerHTML = '<div style="text-align: center; padding: 20px;">èª­ã¿è¾¼ã¿ä¸­...</div>';
        
        const tablesSnapshot = await window.getDocs(window.getStoreCollection('tables'));
        const tables = [];
        
        tablesSnapshot.forEach(doc => {
          tables.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // orderãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã‚½ãƒ¼ãƒˆï¼ˆorderãŒãªã„å ´åˆã¯åå‰ã§ã‚½ãƒ¼ãƒˆï¼‰
        tables.sort((a, b) => {
          const orderA = a.order || 0;
          const orderB = b.order || 0;
          if (orderA !== orderB) {
            return orderA - orderB;
          }
          return a.name.localeCompare(b.name);
        });
        
        if (tables.length === 0) {
          container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
          return;
        }
        
        container.innerHTML = '';
        
        tables.forEach(table => {
          const tableDiv = document.createElement('div');
          tableDiv.style.cssText = 'padding: 15px; margin-bottom: 10px; background: white; border-radius: 8px; border: 2px solid #00BCD4; display: flex; justify-content: space-between; align-items: center;';
          
          const infoDiv = document.createElement('div');
          infoDiv.innerHTML = `
            <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${table.name}</div>
            <div style="color: #666; font-size: 14px;">
              <span style="background: ${table.memoEnabled ? '#E8F5E9' : '#FFEBEE'}; padding: 2px 8px; border-radius: 4px; margin-right: 10px;">
                ${table.memoEnabled ? 'âœ“ ãƒ¡ãƒ¢æ©Ÿèƒ½: ON' : 'âœ— ãƒ¡ãƒ¢æ©Ÿèƒ½: OFF'}
              </span>
            </div>
          `;
          
          const buttonContainer = document.createElement('div');
          buttonContainer.style.cssText = 'display: flex; gap: 10px;';
          
          // QRã‚³ãƒ¼ãƒ‰è¡¨ç¤ºãƒœã‚¿ãƒ³
          const qrBtn = document.createElement('button');
          qrBtn.textContent = 'QR';
          qrBtn.style.cssText = 'padding: 8px 20px; background: linear-gradient(135deg, #00BCD4 0%, #0097A7 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;';
          qrBtn.onclick = () => showQrCode(table.name);
          
          // ç·¨é›†ãƒœã‚¿ãƒ³
          const editBtn = document.createElement('button');
          editBtn.textContent = 'ç·¨é›†';
          editBtn.style.cssText = 'padding: 8px 20px; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;';
          editBtn.onclick = () => showEditTableModal(table);
          
          // å‰Šé™¤ãƒœã‚¿ãƒ³
          const deleteBtn = document.createElement('button');
          deleteBtn.textContent = 'å‰Šé™¤';
          deleteBtn.style.cssText = 'padding: 8px 20px; background: linear-gradient(135deg, #F44336 0%, #D32F2F 100%); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold;';
          deleteBtn.onclick = () => deleteTable(table.id, table.name);
          
          buttonContainer.appendChild(qrBtn);
          buttonContainer.appendChild(editBtn);
          buttonContainer.appendChild(deleteBtn);
          
          tableDiv.appendChild(infoDiv);
          tableDiv.appendChild(buttonContainer);
          container.appendChild(tableDiv);
        });
        
      } catch (error) {
        console.error('ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('tablesList').innerHTML = '<div style="text-align: center; color: red; padding: 20px;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.showAddTableModal = function() {
      document.getElementById('newTableName').value = '';
      document.getElementById('newTableStaffMemo').value = '';
      document.querySelector('input[name="tableMemo"][value="false"]').checked = true;
      document.getElementById('addTableModal').classList.remove('hidden');
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeAddTableModal = function() {
      document.getElementById('addTableModal').classList.add('hidden');
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ 
    window.addTable = async function() {
      const name = document.getElementById('newTableName').value.trim();
      const staffMemo = document.getElementById('newTableStaffMemo').value.trim();
      const memoEnabled = document.querySelector('input[name="tableMemo"]:checked').value === 'true';
      
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!name) {
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      // è‹±æ•°å­—ã®ã¿ãƒã‚§ãƒƒã‚¯
      if (!/^[a-zA-Z0-9]+$/.test(name)) {
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«åã¯è‹±æ•°å­—ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™ï¼ˆæ—¥æœ¬èªä¸å¯ï¼‰');
        return;
      }
      
      try {
        // åŒã˜åå‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        const tablesSnapshot = await window.getDocs(window.getStoreCollection('tables'));
        let exists = false;
        tablesSnapshot.forEach(doc => {
          if (doc.data().name === name) {
            exists = true;
          }
        });
        
        if (exists) {
          alert('åŒã˜åå‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™');
          return;
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ 
        await window.addDoc(window.getStoreCollection('tables'), {
          name: name,
          staffMemo: staffMemo,
          memoEnabled: memoEnabled,
          createdAt: window.Timestamp.now()
        });
        
        alert(`ãƒ†ãƒ¼ãƒ–ãƒ«ã€Œ${name}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸ`);
        closeAddTableModal();
        await loadTablesList();
        await loadTableButtons(); // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚’å†èª­ã¿è¾¼ã¿
        
      } catch (error) {
        console.error('ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.showEditTableModal = function(table) {
      document.getElementById('editTableId').value = table.id;
      document.getElementById('editTableName').value = table.name;
      document.getElementById('editTableStaffMemo').value = table.staffMemo || '';
      
      const memoRadios = document.querySelectorAll('input[name="editTableMemo"]');
      memoRadios.forEach(radio => {
        if (radio.value === String(table.memoEnabled)) {
          radio.checked = true;
        }
      });
      
      document.getElementById('editTableModal').classList.remove('hidden');
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeEditTableModal = function() {
      document.getElementById('editTableModal').classList.add('hidden');
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ç·¨é›†ã‚’ä¿å­˜
    window.saveTableEdit = async function() {
      const id = document.getElementById('editTableId').value;
      const name = document.getElementById('editTableName').value.trim();
      const staffMemo = document.getElementById('editTableStaffMemo').value.trim();
      const memoEnabled = document.querySelector('input[name="editTableMemo"]:checked').value === 'true';
      
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!name) {
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      // è‹±æ•°å­—ã®ã¿ãƒã‚§ãƒƒã‚¯
      if (!/^[a-zA-Z0-9]+$/.test(name)) {
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«åã¯è‹±æ•°å­—ã®ã¿ä½¿ç”¨å¯èƒ½ã§ã™ï¼ˆæ—¥æœ¬èªä¸å¯ï¼‰');
        return;
      }
      
      try {
        // åŒã˜åå‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆè‡ªåˆ†ä»¥å¤–ï¼‰
        const tablesSnapshot = await window.getDocs(window.getStoreCollection('tables'));
        let exists = false;
        tablesSnapshot.forEach(doc => {
          if (doc.id !== id && doc.data().name === name) {
            exists = true;
          }
        });
        
        if (exists) {
          alert('åŒã˜åå‰ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™');
          return;
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ›´æ–°
        await window.updateDoc(window.getStoreDoc('tables', id), {
          name: name,
          staffMemo: staffMemo,
          memoEnabled: memoEnabled,
          updatedAt: window.Timestamp.now()
        });
        
        alert(`ãƒ†ãƒ¼ãƒ–ãƒ«ã€Œ${name}ã€ã‚’æ›´æ–°ã—ã¾ã—ãŸ`);
        closeEditTableModal();
        await loadTablesList();
        await loadTableButtons(); // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚’å†èª­ã¿è¾¼ã¿
        
      } catch (error) {
        console.error('ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤
    async function deleteTable(id, name) {
      // ã‚«ã‚¹ã‚¿ãƒ å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      document.getElementById('deleteTableId').value = id;
      document.getElementById('deleteTableName').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ«ã€Œ${name}ã€`;
      document.getElementById('deleteConfirmModal').classList.remove('hidden');
    }
    
    // å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeDeleteConfirmModal = function() {
      document.getElementById('deleteConfirmModal').classList.add('hidden');
    };
    
    // å‰Šé™¤ã‚’ç¢ºå®š
    window.confirmDeleteTable = async function() {
      const id = document.getElementById('deleteTableId').value;
      const name = document.getElementById('deleteTableName').textContent.replace('ãƒ†ãƒ¼ãƒ–ãƒ«ã€Œ', '').replace('ã€', '');
      
      closeDeleteConfirmModal();
      
      try {
        await window.deleteDoc(window.getStoreDoc('tables', id));
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚ªã‚·ãƒ£ãƒ¬ã«è¡¨ç¤º
        showSuccessMessage(`ãƒ†ãƒ¼ãƒ–ãƒ«ã€Œ${name}ã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        
        await loadTablesList();
        await loadTableButtons(); // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚’å†èª­ã¿è¾¼ã¿
        
      } catch (error) {
        console.error('ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        showErrorMessage('ãƒ†ãƒ¼ãƒ–ãƒ«ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };
    
    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    function showSuccessMessage(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        z-index: 10000;
        font-size: 16px;
        font-weight: bold;
        animation: slideIn 0.3s ease-out;
      `;
      toast.innerHTML = `âœ… ${message}`;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    function showErrorMessage(message) {
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
        color: white;
        padding: 20px 30px;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        z-index: 10000;
        font-size: 16px;
        font-weight: bold;
        animation: slideIn 0.3s ease-out;
      `;
      toast.innerHTML = `âŒ ${message}`;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    // QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
    window.showQrCode = function(tableName) {
      const baseUrl = 'https://gymnastmasaki-lang.github.io/takoyaki-/menu.html';
      
      // åº—èˆ—IDã‚’URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã«è¿½åŠ 
      let storeParam = '';
      if (window.currentStoreId) {
        // æ–°ã—ã„åº—èˆ—ã®å ´åˆ
        storeParam = `store=${window.currentStoreId}&`;
      } else {
        // ä¸‹èµ¤å¡šåº—ã®å ´åˆ
        storeParam = 'store=shimoakatsuka&';
      }
      
      const tableUrl = `${baseUrl}?${storeParam}table=${encodeURIComponent(tableName)}`;
      
      document.getElementById('qrTableName').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ«: ${tableName}`;
      document.getElementById('qrTableUrl').textContent = tableUrl;
      
      // QRã‚³ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
      const qrContainer = document.getElementById('qrCodeContainer');
      qrContainer.innerHTML = '';
      
      // QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ï¼ˆCDNçµŒç”±ï¼‰
      // ç°¡æ˜“ç‰ˆ: ãƒ†ã‚­ã‚¹ãƒˆã¨ã—ã¦è¡¨ç¤º
      qrContainer.innerHTML = `
        <div style="padding: 20px; background: white; border: 2px solid #ddd; border-radius: 8px;">
          <div style="font-size: 14px; color: #666; margin-bottom: 10px;">QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆç”¨URL:</div>
          <div style="font-weight: bold; word-break: break-all;">${tableUrl}</div>
          <div style="margin-top: 15px; padding: 10px; background: #fff3cd; border-radius: 4px; font-size: 12px; color: #856404;">
            âš ï¸ ã“ã®URLã‚’QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚µã‚¤ãƒˆï¼ˆä¾‹: qr-code-generator.comï¼‰ã«å…¥åŠ›ã—ã¦QRã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ãã ã•ã„
          </div>
        </div>
      `;
      
      document.getElementById('qrCodeModal').classList.remove('hidden');
    };
    
    // QRã‚³ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeQrCodeModal = function() {
      document.getElementById('qrCodeModal').classList.add('hidden');
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showTableMemoModal = function(tableId, tableName, staffMemo) {
      document.getElementById('memoTableId').value = tableId;
      document.getElementById('memoTableName').textContent = tableName;
      document.getElementById('memoTableStaffMemo').value = staffMemo || '';
      document.getElementById('tableMemoModal').classList.remove('hidden');
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeTableMemoModal = function() {
      document.getElementById('tableMemoModal').classList.add('hidden');
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¡ãƒ¢ã‚’ä¿å­˜
    window.saveTableMemo = async function() {
      const tableId = document.getElementById('memoTableId').value;
      const staffMemo = document.getElementById('memoTableStaffMemo').value.trim();
      
      try {
        await window.updateDoc(window.getStoreDoc('tables', tableId), {
          staffMemo: staffMemo,
          updatedAt: window.Timestamp.now()
        });
        
        alert('ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        closeTableMemoModal();
        await loadTableButtons(); // ãƒœã‚¿ãƒ³ã®è‰²ã‚’æ›´æ–°
        
      } catch (error) {
        console.error('ãƒ¡ãƒ¢ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ãƒ¡ãƒ¢ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };
    
    // ========== ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³å‹•çš„ç”Ÿæˆ ==========
    
    // æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå³ä¼šè¨ˆã€ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆï¼‰ã‚’è‡ªå‹•ç™»éŒ²
    async function ensureDefaultTables() {
      try {
        const defaultTables = [
          { name: 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ', memoEnabled: true }  // ãƒ¡ãƒ¢æ©Ÿèƒ½ON
        ];
        
        // æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’å–å¾—
        const tablesSnapshot = await window.getDocs(window.getStoreCollection('tables'));
        const existingTables = new Map(); // name -> [docIds]ã®é…åˆ—
        
        tablesSnapshot.forEach(doc => {
          const data = doc.data();
          if (!existingTables.has(data.name)) {
            existingTables.set(data.name, []);
          }
          existingTables.get(data.name).push(doc.id);
        });
        
        console.log('ğŸ“Š æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§:', Array.from(existingTables.keys()));
        
        // âœ… å³ä¼šè¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å…¨ã¦å‰Šé™¤
        if (existingTables.has('å³ä¼šè¨ˆ')) {
          const docIds = existingTables.get('å³ä¼šè¨ˆ');
          for (const docId of docIds) {
            await window.deleteDoc(window.getStoreDoc('tables', docId));
          }
          console.log(`ğŸ—‘ï¸ å³ä¼šè¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’${docIds.length}ä»¶å‰Šé™¤ã—ã¾ã—ãŸ`);
        }
        
        // âœ… ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã®é‡è¤‡ã‚’å‰Šé™¤
        if (existingTables.has('ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ')) {
          const docIds = existingTables.get('ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ');
          if (docIds.length > 1) {
            // é‡è¤‡ãŒã‚ã‚‹å ´åˆã¯å…¨ã¦å‰Šé™¤ã—ã¦å†ä½œæˆ
            console.log(`âš ï¸ ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ãŒ${docIds.length}ä»¶é‡è¤‡ã—ã¦ã„ã¾ã™ã€‚å…¨ã¦å‰Šé™¤ã—ã¦å†ä½œæˆã—ã¾ã™ã€‚`);
            for (const docId of docIds) {
              await window.deleteDoc(window.getStoreDoc('tables', docId));
            }
            existingTables.delete('ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ');
            console.log('ğŸ—‘ï¸ é‡è¤‡ã—ãŸãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
          }
        }
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ ã¾ãŸã¯æ›´æ–°
        for (const table of defaultTables) {
          const docIds = existingTables.get(table.name) || [];
          
          if (docIds.length === 0) {
            // å­˜åœ¨ã—ãªã„å ´åˆã¯è¿½åŠ 
            await window.addDoc(window.getStoreCollection('tables'), {
              name: table.name,
              memoEnabled: table.memoEnabled,
              isDefault: true, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã™ãƒ•ãƒ©ã‚°
              createdAt: window.Timestamp.now()
            });
            console.log(`âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã€Œ${table.name}ã€ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼ˆãƒ¡ãƒ¢æ©Ÿèƒ½: ${table.memoEnabled ? 'ON' : 'OFF'}ï¼‰`);
          } else if (docIds.length === 1) {
            // 1ã¤ã ã‘å­˜åœ¨ã™ã‚‹å ´åˆã¯memoEnabledã‚’æ›´æ–°
            const docId = docIds[0];
            await window.updateDoc(window.getStoreDoc('tables', docId), {
              memoEnabled: table.memoEnabled,
              isDefault: true,
              updatedAt: window.Timestamp.now()
            });
            console.log(`âœ… ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ã€Œ${table.name}ã€ã®ãƒ¡ãƒ¢æ©Ÿèƒ½ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ˆãƒ¡ãƒ¢æ©Ÿèƒ½: ${table.memoEnabled ? 'ON' : 'OFF'}ï¼‰`);
          }
        }
      } catch (error) {
        console.error('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ†ãƒ¼ãƒ–ãƒ«ç™»éŒ²ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
    async function loadTableButtons() {
      try {
        const grid = document.getElementById('tableButtonsGrid');
        const fixedGrid = grid.previousElementSibling; // å›ºå®šãƒœã‚¿ãƒ³ã‚°ãƒªãƒƒãƒ‰
        
        // æ—¢å­˜ã®å‹•çš„ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚’å‰Šé™¤
        const existingButtons = grid.querySelectorAll('.dynamic-table-btn');
        existingButtons.forEach(btn => btn.remove());
        
        // å›ºå®šã‚°ãƒªãƒƒãƒ‰ã‹ã‚‰ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’å‰Šé™¤ï¼ˆå†ä½œæˆã®ãŸã‚ï¼‰
        const existingTakeout = fixedGrid.querySelector('.takeout-btn');
        if (existingTakeout) existingTakeout.remove();
        
        // Firebaseã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’å–å¾—
        const tablesSnapshot = await window.getDocs(window.getStoreCollection('tables'));
        const tables = [];
        
        tablesSnapshot.forEach(doc => {
          const data = doc.data();
          // å³ä¼šè¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã¯é™¤å¤–
          if (data.name !== 'å³ä¼šè¨ˆ') {
            tables.push({
              id: doc.id,
              ...data
            });
          }
        });
        
        // ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã¨ä»–ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’åˆ†é›¢
        const takeoutTable = tables.find(t => t.name === 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ');
        const otherTables = tables.filter(t => t.name !== 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ');
        otherTables.sort((a, b) => a.name.localeCompare(b.name));
        
        // ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆãƒœã‚¿ãƒ³ã‚’1è¡Œç›®ï¼ˆå›ºå®šã‚°ãƒªãƒƒãƒ‰ï¼‰ã«è¿½åŠ 
        if (takeoutTable) {
          const btn = document.createElement('button');
          btn.className = 'table-btn takeout-btn';
          btn.id = `table-${takeoutTable.name}`;
          btn.onclick = () => selectTable(takeoutTable.name);
          
          const hasStaffMemo = takeoutTable.staffMemo && takeoutTable.staffMemo.trim() !== '';
          const bgColor = hasStaffMemo 
            ? 'linear-gradient(135deg, #FF9800 0%, #FF5722 100%)' 
            : 'linear-gradient(135deg, #00BCD4 0%, #0097A7 100%)';
          
          btn.style.cssText = `background: ${bgColor}; color: white; font-size: 13px; font-weight: bold; padding: 10px 15px; border-radius: 12px; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 3px;`;
          
          // ãƒ¡ãƒ¢ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
          const memoIcon = document.createElement('span');
          memoIcon.textContent = 'ğŸ“';
          memoIcon.style.cssText = 'position: absolute; top: 3px; right: 3px; font-size: 14px; cursor: pointer; z-index: 10;';
          memoIcon.onclick = (e) => {
            e.stopPropagation();
            showTableMemoModal(takeoutTable.id, takeoutTable.name, takeoutTable.staffMemo || '');
          };
          
          const textSpan = document.createElement('span');
          textSpan.textContent = takeoutTable.name;
          
          btn.appendChild(memoIcon);
          btn.appendChild(textSpan);
          fixedGrid.appendChild(btn);
        }
        
        // ä»–ã®ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚’2è¡Œç›®ä»¥é™ï¼ˆé€šå¸¸ã‚°ãƒªãƒƒãƒ‰ï¼‰ã«ç”Ÿæˆ
        otherTables.forEach(table => {
          const btn = document.createElement('button');
          btn.className = 'table-btn dynamic-table-btn';
          btn.id = `table-${table.name}`;
          btn.onclick = () => selectTable(table.name);
          
          // ã‚¹ã‚¿ãƒƒãƒ•ãƒ¡ãƒ¢ãŒã‚ã‚‹å ´åˆã¯è‰²ã‚’å¤‰æ›´
          const hasStaffMemo = table.staffMemo && table.staffMemo.trim() !== '';
          const bgColor = hasStaffMemo 
            ? 'linear-gradient(135deg, #FF9800 0%, #FF5722 100%)' 
            : 'linear-gradient(135deg, #00BCD4 0%, #0097A7 100%)';
          
          btn.style.cssText = `background: ${bgColor}; color: white; font-size: 16px; font-weight: bold; padding: 15px; border-radius: 12px; border: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.2); position: relative;`;
          
          // ãƒ¡ãƒ¢ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
          const memoIcon = document.createElement('span');
          memoIcon.textContent = 'ğŸ“';
          memoIcon.style.cssText = 'position: absolute; top: 3px; right: 3px; font-size: 14px; cursor: pointer; z-index: 10;';
          memoIcon.onclick = (e) => {
            e.stopPropagation();
            showTableMemoModal(table.id, table.name, table.staffMemo || '');
          };
          
          const textSpan = document.createElement('span');
          textSpan.textContent = table.name;
          
          btn.appendChild(memoIcon);
          btn.appendChild(textSpan);
          
          grid.appendChild(btn);
        });
        
        // TABLESã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚‚æ›´æ–°ï¼ˆæ‰‹å‹•å…¥åŠ›ç”¨ã€ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆå«ã‚€å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
        const allTables = [];
        if (takeoutTable) allTables.push(takeoutTable.name);
        allTables.push(...otherTables.map(t => t.name));
        window.TABLES = allTables;
        
        // æ‰‹å‹•å…¥åŠ›ã®ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚‚æ›´æ–°
        updateManualTableSelect();
        
        // æ–°ã—ã„ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚’é–‹å§‹
        if (takeoutTable) monitorTable(takeoutTable.name);
        otherTables.forEach(table => {
          monitorTable(table.name);
        });
        
        // å…¨ãƒ†ãƒ¼ãƒ–ãƒ«åˆè¨ˆã‚’åˆæœŸè¡¨ç¤º
        await updateAllTablesTotal();
        
      } catch (error) {
        console.error('ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // æ‰‹å‹•å…¥åŠ›ç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠè‚¢ã‚’æ›´æ–°
    function updateManualTableSelect() {
      const manualTable = document.getElementById('manualTable');
      if (!manualTable) return;
      
      // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆæœ€åˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’é™¤ãï¼‰
      while (manualTable.options.length > 1) {
        manualTable.remove(1);
      }
      
      // TABLESã‹ã‚‰é¸æŠè‚¢ã‚’ç”Ÿæˆ
      window.TABLES.forEach(table => {
        const option = document.createElement('option');
        option.value = table;
        option.textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${table}`;
        manualTable.appendChild(option);
      });
    }
    
    // ã‚«ãƒ†ã‚´ãƒªä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadSortCategories() {
      try {
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        const categoryInfo = new Map();
        
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.category && data.id) {
            const cat = data.category;
            const itemId = data.id;
            
            if (!categoryInfo.has(cat)) {
              categoryInfo.set(cat, { minId: itemId });
            } else {
              const info = categoryInfo.get(cat);
              if (itemId < info.minId) {
                info.minId = itemId;
              }
            }
          }
        });
        
        const select = document.getElementById('sortCategorySelect');
        select.innerHTML = '<option value="">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ...</option>';
        
        // menu.htmlã¨åŒã˜ã‚½ãƒ¼ãƒˆæ–¹æ³•ï¼šå„ã‚«ãƒ†ã‚´ãƒªã®æœ€å°IDã§ã‚½ãƒ¼ãƒˆ
        const sortedCategories = Array.from(categoryInfo.entries())
          .sort((a, b) => a[1].minId.localeCompare(b[1].minId))
          .map(entry => entry[0]);
        
        sortedCategories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          select.appendChild(option);
        });
        
      } catch (error) {
        console.error('ã‚«ãƒ†ã‚´ãƒªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // é¸æŠã—ãŸã‚«ãƒ†ã‚´ãƒªã®å•†å“ã‚’èª­ã¿è¾¼ã¿
    window.loadSortProducts = async function() {
      const category = document.getElementById('sortCategorySelect').value;
      
      if (!category) {
        document.getElementById('sortProductsList').innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
        return;
      }
      
      try {
        const container = document.getElementById('sortProductsList');
        container.innerHTML = '<div style="text-align: center; padding: 20px;">èª­ã¿è¾¼ã¿ä¸­...</div>';
        
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        sortProducts = [];
        
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.category === category) {
            sortProducts.push({
              id: doc.id,
              docId: doc.id,
              name: data.name || data.id,
              price: data.price,
              order: data.order || 999
            });
          }
        });
        
        // ç¾åœ¨ã®ä¸¦ã³é †ã§ã‚½ãƒ¼ãƒˆ
        sortProducts.sort((a, b) => {
          if (a.order !== b.order) {
            return a.order - b.order;
          }
          return a.name.localeCompare(b.name, 'ja');
        });
        
        displaySortProducts();
        
      } catch (error) {
        console.error('å•†å“èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('sortProductsList').innerHTML = '<div style="text-align: center; padding: 20px; color: red;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    };
    
    // ãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ãªå•†å“ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
    function displaySortProducts() {
      const container = document.getElementById('sortProductsList');
      
      if (sortProducts.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">ã“ã®ã‚«ãƒ†ã‚´ãƒªã«ã¯å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = '';
      
      sortProducts.forEach((product, index) => {
        const productDiv = document.createElement('div');
        productDiv.draggable = true;
        productDiv.dataset.index = index;
        productDiv.style.cssText = `
          padding: 15px;
          margin-bottom: 10px;
          background: white;
          border-radius: 8px;
          border: 2px solid #ddd;
          display: flex;
          justify-content: space-between;
          align-items: center;
          cursor: move;
          transition: all 0.2s;
        `;
        
        productDiv.innerHTML = `
          <div style="display: flex; align-items: center; gap: 15px;">
            <div style="font-size: 20px; color: #999;">â˜°</div>
            <div style="font-weight: bold; font-size: 18px; color: #333; min-width: 30px;">${index + 1}</div>
            <div>
              <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${product.name}</div>
              <div style="color: #4CAF50; font-weight: bold;">Â¥${product.price.toLocaleString()}</div>
            </div>
          </div>
        `;
        
        // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆ
        productDiv.addEventListener('dragstart', handleDragStart);
        productDiv.addEventListener('dragover', handleDragOver);
        productDiv.addEventListener('drop', handleDrop);
        productDiv.addEventListener('dragend', handleDragEnd);
        
        container.appendChild(productDiv);
      });
    }
    
    // ãƒ‰ãƒ©ãƒƒã‚°é–‹å§‹
    function handleDragStart(e) {
      draggedElement = this;
      this.style.opacity = '0.5';
      e.dataTransfer.effectAllowed = 'move';
    }
    
    // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
    function handleDragOver(e) {
      if (e.preventDefault) {
        e.preventDefault();
      }
      e.dataTransfer.dropEffect = 'move';
      
      const target = e.currentTarget;
      if (target !== draggedElement) {
        target.style.borderColor = '#2196F3';
        target.style.background = '#E3F2FD';
      }
      
      return false;
    }
    
    // ãƒ‰ãƒ­ãƒƒãƒ—
    function handleDrop(e) {
      if (e.stopPropagation) {
        e.stopPropagation();
      }
      
      const target = e.currentTarget;
      target.style.borderColor = '#ddd';
      target.style.background = 'white';
      
      if (draggedElement !== target) {
        const draggedIndex = parseInt(draggedElement.dataset.index);
        const targetIndex = parseInt(target.dataset.index);
        
        // é…åˆ—ã‚’ä¸¦ã³æ›¿ãˆ
        const [draggedItem] = sortProducts.splice(draggedIndex, 1);
        sortProducts.splice(targetIndex, 0, draggedItem);
        
        // å†æç”»
        displaySortProducts();
      }
      
      return false;
    }
    
    // ãƒ‰ãƒ©ãƒƒã‚°çµ‚äº†
    function handleDragEnd(e) {
      this.style.opacity = '1';
      
      // ã™ã¹ã¦ã®è¦ç´ ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
      const items = document.querySelectorAll('#sortProductsList > div');
      items.forEach(item => {
        item.style.borderColor = '#ddd';
        item.style.background = 'white';
      });
    }
    
    // ä¸¦ã³é †ã‚’ä¿å­˜
    window.saveSortOrder = async function() {
      const category = document.getElementById('sortCategorySelect').value;
      
      if (!category || sortProducts.length === 0) {
        alert('ä¿å­˜ã™ã‚‹å•†å“ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      const confirmed = await showCustomConfirm({
        icon: 'ğŸ’¾',
        title: 'ä¸¦ã³é †ã‚’ä¿å­˜',
        message: 'ä¸¦ã³é †ã‚’ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ',
        confirmText: 'ä¿å­˜ã™ã‚‹',
        confirmColor: '#4CAF50'
      });
      
      if (!confirmed) {
        return;
      }
      
      try {
        // å„å•†å“ã«orderå€¤ã‚’è¨­å®šã—ã¦ä¿å­˜
        const promises = sortProducts.map((product, index) => {
          return window.updateDoc(window.getStoreDoc('menus', product.docId), {
            order: index
          });
        });
        
        await Promise.all(promises);
        
        showCustomAlert('ä¸¦ã³é †ã‚’ä¿å­˜ã—ã¾ã—ãŸ', 'âœ… å®Œäº†', 'ğŸ’¾');
        closeSortOrderModal();
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å†èª­ã¿è¾¼ã¿
        if (typeof loadMenu === 'function') {
          loadMenu();
        }
        
      } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };
    
    // ========== å•†å“ç·¨é›†æ©Ÿèƒ½ ==========
    let editToppingSets = [];
    
    // å•†å“ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    window.openEditProductModal = function(product) {
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      console.log('ğŸ“ å•†å“ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ãã¾ã™');
      console.log('å•†å“å:', product.name);
      console.log('å•†å“ID:', product.id);
      console.log('ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆæ•°:', product.toppingSets ? product.toppingSets.length : 0);
      console.log('ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆè©³ç´°:', product.toppingSets);
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      
      document.getElementById('productEditModal').classList.remove('hidden');
      document.getElementById('editProductId').value = product.id;
      document.getElementById('editProductName').value = product.name;
      document.getElementById('editProductPrice').value = product.price;
      document.getElementById('editProductCategory').value = product.category;
      document.getElementById('editProductNote').value = product.note || '';
      document.getElementById('editProductImage').value = product.image || '';
      
      // ç¨ç‡ã‚’è¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯10%ï¼‰
      const taxRate = product.taxRate || 10;
      const taxRateRadios = document.querySelectorAll('input[name="editProductTaxRate"]');
      taxRateRadios.forEach(radio => {
        radio.checked = (parseInt(radio.value) === taxRate);
      });
      
      // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’èª­ã¿è¾¼ã¿
      editToppingSets = product.toppingSets ? JSON.parse(JSON.stringify(product.toppingSets)) : [];
      
      // âœ… è¨ºæ–­æƒ…å ±ã‚’ç”»é¢ã«è¡¨ç¤º
      const diagnosticDiv = document.getElementById('editToppingDiagnostic');
      if (diagnosticDiv) {
        const count = editToppingSets.length;
        diagnosticDiv.innerHTML = `
          <div style="padding: 10px; background: ${count > 5 ? '#ffebee' : '#e8f5e9'}; border-radius: 6px; margin-bottom: 15px;">
            <div style="font-weight: bold; margin-bottom: 5px;">
              ${count > 5 ? 'âš ï¸ è­¦å‘Š' : 'âœ… æ­£å¸¸'}
            </div>
            <div style="font-size: 14px; margin-bottom: 10px;">
              ã“ã®å•†å“ã«ã¯ç¾åœ¨ <strong>${count}å€‹</strong> ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã™
            </div>
            ${count > 5 ? `
              <div style="font-size: 13px; color: #d32f2f; margin-bottom: 10px;">
                é€šå¸¸ã€1ã¤ã®å•†å“ã«ã¯1ã€œ3å€‹ç¨‹åº¦ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆãŒé©åˆ‡ã§ã™ã€‚<br>
                ä¸è¦ãªãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã¯ä¸‹ã®ã€Œå‰Šé™¤ã€ãƒœã‚¿ãƒ³ã§å‰Šé™¤ã™ã‚‹ã‹ã€<br>
                ä¸€æ‹¬å‰Šé™¤ãƒœã‚¿ãƒ³ã§ã™ã¹ã¦ã‚¯ãƒªã‚¢ã§ãã¾ã™ã€‚
              </div>
              <button onclick="clearAllEditToppingSets()" style="padding: 8px 16px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                ã™ã¹ã¦ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’å‰Šé™¤
              </button>
            ` : ''}
          </div>
        `;
      }
      
      renderEditToppingSets();
    };
    
    // å•†å“ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeEditProductModal = function() {
      document.getElementById('productEditModal').classList.add('hidden');
      editToppingSets = [];
    };
    
    // âœ… ã™ã¹ã¦ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’å‰Šé™¤
    window.clearAllEditToppingSets = function() {
      if (confirm('ã™ã¹ã¦ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯ã€Œâœï¸ æ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¾ã§ç¢ºå®šã—ã¾ã›ã‚“ã€‚')) {
        editToppingSets = [];
        renderEditToppingSets();
        
        // è¨ºæ–­æƒ…å ±ã‚’æ›´æ–°
        const diagnosticDiv = document.getElementById('editToppingDiagnostic');
        if (diagnosticDiv) {
          diagnosticDiv.innerHTML = `
            <div style="padding: 10px; background: #e8f5e9; border-radius: 6px; margin-bottom: 15px;">
              <div style="font-weight: bold; margin-bottom: 5px;">âœ… ã‚¯ãƒªã‚¢å®Œäº†</div>
              <div style="font-size: 14px;">
                ã™ã¹ã¦ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚<br>
                ã€Œâœï¸ æ›´æ–°ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦å¤‰æ›´ã‚’ä¿å­˜ã—ã¦ãã ã•ã„ã€‚
              </div>
            </div>
          `;
        }
        
        console.log('âœ… ã™ã¹ã¦ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      }
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’æç”»
    function renderEditToppingSets() {
      const container = document.getElementById('editToppingSetsContainer');
      container.innerHTML = '';
      
      editToppingSets.forEach((set, setIndex) => {
        const setDiv = document.createElement('div');
        setDiv.style.cssText = 'border: 2px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #f9f9f9;';
        
        setDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <input type="text" class="edit-topping-set-name" value="${set.name}" placeholder="ã‚»ãƒƒãƒˆåï¼ˆä¾‹: ã‚½ãƒ¼ã‚¹ç¨®é¡ï¼‰" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
            <select class="edit-topping-set-type" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
              <option value="single" ${set.type === 'single' ? 'selected' : ''}>å˜ä¸€é¸æŠ</option>
              <option value="multiple" ${set.type === 'multiple' ? 'selected' : ''}>è¤‡æ•°é¸æŠ</option>
            </select>
            <button onclick="removeEditToppingSet(${setIndex})" style="padding: 6px 12px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer;">å‰Šé™¤</button>
          </div>
          <div class="edit-topping-options-list"></div>
          <button onclick="addEditToppingOption(${setIndex})" style="padding: 6px 12px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px;">+ ã‚ªãƒ—ã‚·ãƒ§ãƒ³è¿½åŠ </button>
        `;
        
        const optionsList = setDiv.querySelector('.edit-topping-options-list');
        set.options.forEach((option, optionIndex) => {
          const optionDiv = document.createElement('div');
          optionDiv.style.cssText = 'display: flex; gap: 10px; margin-bottom: 8px; align-items: center;';
          optionDiv.innerHTML = `
            <input type="text" class="edit-option-name" value="${option.name}" placeholder="ã‚ªãƒ—ã‚·ãƒ§ãƒ³å" style="flex: 2; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            <input type="number" class="edit-option-price" value="${option.price}" placeholder="è¿½åŠ æ–™é‡‘" min="0" style="flex: 1; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
            <button onclick="removeEditToppingOption(${setIndex}, ${optionIndex})" style="padding: 4px 8px; background: #f44336; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">Ã—</button>
          `;
          optionsList.appendChild(optionDiv);
        });
        
        container.appendChild(setDiv);
      });
    }
    

    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
    window.addEditToppingOption = function(setIndex) {
      // ç¾åœ¨ã®å…¥åŠ›å†…å®¹ã‚’ä¿å­˜
      saveCurrentEditToppingData();
      
      // æ–°ã—ã„ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
      editToppingSets[setIndex].options.push({
        name: '',
        price: 0
      });
      renderEditToppingSets();
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
    window.removeEditToppingOption = function(setIndex, optionIndex) {
      // ç¾åœ¨ã®å…¥åŠ›å†…å®¹ã‚’ä¿å­˜
      saveCurrentEditToppingData();
      
      editToppingSets[setIndex].options.splice(optionIndex, 1);
      renderEditToppingSets();
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’è¿½åŠ 
    window.addEditToppingSet = function() {
      // ç¾åœ¨ã®å…¥åŠ›å†…å®¹ã‚’ä¿å­˜
      saveCurrentEditToppingData();
      
      editToppingSets.push({
        name: '',
        type: 'single',
        options: []
      });
      renderEditToppingSets();
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’å‰Šé™¤
    window.removeEditToppingSet = function(setIndex) {
      // ç¾åœ¨ã®å…¥åŠ›å†…å®¹ã‚’ä¿å­˜
      saveCurrentEditToppingData();
      
      editToppingSets.splice(setIndex, 1);
      renderEditToppingSets();
    };
    
    // ç¾åœ¨ã®å…¥åŠ›å†…å®¹ã‚’editToppingSetsã«ä¿å­˜
    function saveCurrentEditToppingData() {
      const container = document.getElementById('editToppingSetsContainer');
      const setDivs = container.children;
      
      for (let i = 0; i < setDivs.length && i < editToppingSets.length; i++) {
        const setDiv = setDivs[i];
        
        // ã‚»ãƒƒãƒˆåã¨ã‚¿ã‚¤ãƒ—ã‚’ä¿å­˜
        const nameInput = setDiv.querySelector('.edit-topping-set-name');
        const typeSelect = setDiv.querySelector('.edit-topping-set-type');
        
        if (nameInput) editToppingSets[i].name = nameInput.value;
        if (typeSelect) editToppingSets[i].type = typeSelect.value;
        
        // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
        const optionDivs = setDiv.querySelectorAll('.edit-topping-options-list > div');
        optionDivs.forEach((optionDiv, optIdx) => {
          if (editToppingSets[i].options[optIdx]) {
            const nameInput = optionDiv.querySelector('.edit-option-name');
            const priceInput = optionDiv.querySelector('.edit-option-price');
            
            if (nameInput) editToppingSets[i].options[optIdx].name = nameInput.value;
            if (priceInput) editToppingSets[i].options[optIdx].price = parseInt(priceInput.value) || 0;
          }
        });
      }
    }
    
    // å•†å“ã‚’æ›´æ–°
    window.saveEditedProduct = async function() {
      const productId = document.getElementById('editProductId').value;
      const name = document.getElementById('editProductName').value.trim();
      const price = parseInt(document.getElementById('editProductPrice').value);
      const category = document.getElementById('editProductCategory').value.trim();
      const note = document.getElementById('editProductNote').value.trim();
      const image = document.getElementById('editProductImage').value.trim();
      
      // ç¨ç‡ã‚’å–å¾—
      const taxRateRadio = document.querySelector('input[name="editProductTaxRate"]:checked');
      const taxRate = taxRateRadio ? parseInt(taxRateRadio.value) : 10;
      
      if (!name || !price || !category) {
        alert('å•†å“åã€ä¾¡æ ¼ã€ã‚«ãƒ†ã‚´ãƒªã¯å¿…é ˆã§ã™');
        return;
      }
      
      // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã®æƒ…å ±ã‚’åé›†
      const setDivs = document.querySelectorAll('#editToppingSetsContainer > div');
      const toppingSets = [];
      
      setDivs.forEach((setDiv, setIndex) => {
        const setName = setDiv.querySelector('.edit-topping-set-name').value.trim();
        const setType = setDiv.querySelector('.edit-topping-set-type').value;
        
        if (!setName) return;
        
        const options = [];
        const optionDivs = setDiv.querySelectorAll('.edit-topping-options-list > div');
        
        optionDivs.forEach(optionDiv => {
          const optionName = optionDiv.querySelector('.edit-option-name').value.trim();
          const optionPrice = parseInt(optionDiv.querySelector('.edit-option-price').value) || 0;
          
          if (optionName) {
            options.push({ name: optionName, price: optionPrice });
          }
        });
        
        if (options.length > 0) {
          toppingSets.push({
            name: setName,
            type: setType,
            options: options
          });
        }
      });
      
      try {
        // æ—¢å­˜å•†å“ã‚’å–å¾—ã—ã¦docIdã‚’ç¢ºèª
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        let docId = null;
        let existingToppingsId = '';
        
        menuSnapshot.forEach(doc => {
          if (doc.data().id === productId || doc.id === productId) {
            docId = doc.id;
            existingToppingsId = doc.data().toppingsId || '';
          }
        });
        
        if (!docId) {
          throw new Error('å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        }
        
        // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’toppingsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«ç™»éŒ²ã—ã¦IDã‚’å–å¾—
        const toppingIds = [];
        
        if (toppingSets.length > 0) {
          // æœ€æ–°ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°IDã‚’å–å¾—
          const toppingsSnapshot = await window.getDocs(window.getStoreCollection('toppings'));
          let maxNum = 15; // T0016ã‹ã‚‰é–‹å§‹
          
          toppingsSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.id && data.id.startsWith('T')) {
              const num = parseInt(data.id.substring(1));
              if (num > maxNum) maxNum = num;
            }
          });
          
          // å„ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’toppingsã«ç™»éŒ²
          for (const set of toppingSets) {
            for (const option of set.options) {
              maxNum++;
              const toppingId = 'T' + String(maxNum).padStart(4, '0');
              
              await window.addDoc(window.getStoreCollection('toppings'), {
                id: toppingId,
                name: option.name,
                price: option.price,
                order: maxNum
              });
              
              toppingIds.push(toppingId);
            }
          }
        }
        
        const productData = {
          id: productId,
          name: name,
          price: price,
          category: category,
          toppingSets: toppingSets,
          toppingsId: toppingIds.length > 0 ? toppingIds.join(',') : existingToppingsId,
          note: note,
          image: image || '',
          taxRate: taxRate  // é¸æŠã—ãŸç¨ç‡ã‚’ä¿å­˜
        };
        
        // ğŸ†• æ—¢å­˜ã®orderãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ä¿æŒï¼ˆæ—¢ã«å–å¾—æ¸ˆã¿ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‹ã‚‰ï¼‰
        menuSnapshot.forEach(doc => {
          if (doc.id === docId && doc.data().order) {
            productData.order = doc.data().order;
          }
        });
        
        // docIdã‚’ä½¿ç”¨ã—ã¦æ›´æ–°ï¼ˆidã§ã¯ãªãï¼‰
        await window.setDoc(window.getStoreDoc('menus', docId), productData);
        
        await showCustomAlert('âœ… å•†å“ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        closeEditProductModal();
        
        // ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
        await loadProductDeleteList();
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å†èª­ã¿è¾¼ã¿
        await initializeSystem();
        
      } catch (error) {
        console.error('å•†å“æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert('âŒ å•†å“ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error.message);
      }
    };
    
    // å•†å“ã‚’æ¤œç´¢ã—ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    window.filterProductList = function() {
      const searchText = document.getElementById('productSearchInput').value.toLowerCase();
      
      if (!searchText) {
        displayProductDeleteList(allProductsForDelete);
        return;
      }
      
      const filtered = allProductsForDelete.filter(product => 
        product.name.toLowerCase().includes(searchText) ||
        product.category.toLowerCase().includes(searchText)
      );
      
      displayProductDeleteList(filtered);
    };
    
    // å•†å“ã‚’å‰Šé™¤
    async function deleteProduct(productId, productName) {
      const confirmed = await showCustomConfirm({
        icon: 'ğŸ—‘ï¸',
        title: 'å•†å“å‰Šé™¤',
        message: `ã€Œ${productName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚`,
        btnClass: 'modal-btn-danger',
        confirmText: 'å‰Šé™¤ã™ã‚‹',
        cancelText: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«'
      });
      
      if (!confirmed) return;
      
      try {
        await window.deleteDoc(window.getStoreDoc('menus', productId));
        
        await showCustomAlert('âœ… å•†å“ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        
        // ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
        await loadProductDeleteList();
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å†èª­ã¿è¾¼ã¿
        
        
      } catch (error) {
        console.error('å•†å“å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert('âŒ å•†å“ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error.message);
      }
    }
    
    // ========================================
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°é †åºå¤‰æ›´æ©Ÿèƒ½
    // ========================================
    
    let toppingOrderData = [];
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°é †åºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showToppingOrderModal = async function() {
      document.getElementById('toppingOrderModal').classList.remove('hidden');
      await loadToppingOrderList();
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°é †åºãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeToppingOrderModal = function() {
      document.getElementById('toppingOrderModal').classList.add('hidden');
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…ƒã«æˆ»ã™
      const modalTitle = document.querySelector('#toppingOrderModal h3');
      modalTitle.textContent = 'ãƒˆãƒƒãƒ”ãƒ³ã‚°é †åºå¤‰æ›´';
      
      // ç·¨é›†ä¸­ã®å•†å“æƒ…å ±ã‚’ã‚¯ãƒªã‚¢
      window.currentEditingProduct = null;
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã¿
    async function loadToppingOrderList() {
      try {
        const container = document.getElementById('toppingOrderList');
        container.innerHTML = '<div style="text-align: center; padding: 20px;">èª­ã¿è¾¼ã¿ä¸­...</div>';
        
        const toppingsSnapshot = await window.getDocs(window.getStoreCollection('toppings'));
        toppingOrderData = [];
        
        toppingsSnapshot.forEach(doc => {
          const data = doc.data();
          toppingOrderData.push({
            id: doc.id,
            name: data.name,
            order: data.order || 999,
            ...data
          });
        });
        
        // ç¾åœ¨ã®é †åºã§ã‚½ãƒ¼ãƒˆ
        toppingOrderData.sort((a, b) => a.order - b.order);
        
        displayToppingOrderList();
        
      } catch (error) {
        console.error('ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒªã‚¹ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('toppingOrderList').innerHTML = '<div style="text-align: center; padding: 20px; color: red;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
      }
    }
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
    function displayToppingOrderList() {
      const container = document.getElementById('toppingOrderList');
      
      if (toppingOrderData.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">ãƒˆãƒƒãƒ”ãƒ³ã‚°ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = '';
      
      toppingOrderData.forEach((topping, index) => {
        const toppingDiv = document.createElement('div');
        toppingDiv.className = 'topping-order-item';
        toppingDiv.draggable = true;
        toppingDiv.dataset.index = index;
        toppingDiv.style.cssText = `
          background: white;
          border: 2px solid #e0e0e0;
          border-radius: 10px;
          padding: 15px;
          display: flex;
          align-items: center;
          gap: 15px;
          cursor: move;
          transition: all 0.2s;
        `;
        
        toppingDiv.innerHTML = `
          <div style="font-size: 24px; color: #999;">â˜°</div>
          <div style="flex: 1;">
            <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px;">${topping.name}</div>
            <div style="font-size: 12px; color: #999;">é †åº: ${index + 1}</div>
          </div>
          <div style="display: flex; gap: 10px;">
            <button onclick="moveToppingUp(${index})" style="padding: 8px 12px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" ${index === 0 ? 'disabled' : ''}>â†‘</button>
            <button onclick="moveToppingDown(${index})" style="padding: 8px 12px; background: #2196F3; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 14px;" ${index === toppingOrderData.length - 1 ? 'disabled' : ''}>â†“</button>
          </div>
        `;
        
        // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚¤ãƒ™ãƒ³ãƒˆ
        toppingDiv.addEventListener('dragstart', handleToppingDragStart);
        toppingDiv.addEventListener('dragover', handleToppingDragOver);
        toppingDiv.addEventListener('drop', handleToppingDrop);
        toppingDiv.addEventListener('dragenter', handleToppingDragEnter);
        toppingDiv.addEventListener('dragleave', handleToppingDragLeave);
        toppingDiv.addEventListener('dragend', handleToppingDragEnd);
        
        container.appendChild(toppingDiv);
      });
    }
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’ä¸Šã«ç§»å‹•
    window.moveToppingUp = function(index) {
      if (index === 0) return;
      
      const temp = toppingOrderData[index];
      toppingOrderData[index] = toppingOrderData[index - 1];
      toppingOrderData[index - 1] = temp;
      
      displayToppingOrderList();
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’ä¸‹ã«ç§»å‹•
    window.moveToppingDown = function(index) {
      if (index === toppingOrderData.length - 1) return;
      
      const temp = toppingOrderData[index];
      toppingOrderData[index] = toppingOrderData[index + 1];
      toppingOrderData[index + 1] = temp;
      
      displayToppingOrderList();
    };
    
    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—å‡¦ç†
    let draggedToppingElement = null;
    let draggedToppingIndex = null;
    
    function handleToppingDragStart(e) {
      draggedToppingElement = e.currentTarget;
      draggedToppingIndex = parseInt(e.currentTarget.dataset.index);
      e.currentTarget.style.opacity = '0.5';
    }
    
    function handleToppingDragOver(e) {
      e.preventDefault();
      return false;
    }
    
    function handleToppingDragEnter(e) {
      if (e.currentTarget.className === 'topping-order-item') {
        e.currentTarget.style.borderColor = '#4CAF50';
        e.currentTarget.style.backgroundColor = '#e8f5e9';
      }
    }
    
    function handleToppingDragLeave(e) {
      if (e.currentTarget.className === 'topping-order-item') {
        e.currentTarget.style.borderColor = '#e0e0e0';
        e.currentTarget.style.backgroundColor = 'white';
      }
    }
    
    function handleToppingDrop(e) {
      e.preventDefault();
      
      if (e.currentTarget.className === 'topping-order-item') {
        const dropIndex = parseInt(e.currentTarget.dataset.index);
        
        if (draggedToppingIndex !== dropIndex) {
          // é…åˆ—ã®è¦ç´ ã‚’å…¥ã‚Œæ›¿ãˆ
          const temp = toppingOrderData[draggedToppingIndex];
          toppingOrderData.splice(draggedToppingIndex, 1);
          toppingOrderData.splice(dropIndex, 0, temp);
          
          displayToppingOrderList();
        }
        
        e.currentTarget.style.borderColor = '#e0e0e0';
        e.currentTarget.style.backgroundColor = 'white';
      }
      
      return false;
    }
    
    function handleToppingDragEnd(e) {
      e.currentTarget.style.opacity = '1';
    }
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°é †åºã‚’ä¿å­˜
    window.saveToppingOrder = async function() {
      try {
        // å•†å“ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆé †åºã‚’ä¿å­˜ã™ã‚‹å ´åˆ
        if (window.currentEditingProduct) {
          const product = window.currentEditingProduct;
          
          // toppingOrderDataã‚’æ–°ã—ã„é †åºã§æ›´æ–°
          const updatedToppingSets = toppingOrderData.map((set, index) => ({
            name: set.name,
            type: set.type,
            options: set.options,
            order: index
          }));
          
          // å•†å“ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ï¼ˆdocIdã‚’ä½¿ç”¨ï¼‰
          await window.updateDoc(window.getStoreDoc('menus', product.docId), {
            toppingSets: updatedToppingSets
          });
          
          await showCustomAlert('âœ… ãƒˆãƒƒãƒ”ãƒ³ã‚°é †åºã‚’ä¿å­˜ã—ã¾ã—ãŸ');
          closeToppingOrderModal();
          
          // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…ƒã«æˆ»ã™
          const modalTitle = document.querySelector('#toppingOrderModal h3');
          modalTitle.textContent = 'ãƒˆãƒƒãƒ”ãƒ³ã‚°é †åºå¤‰æ›´';
          
          // å•†å“ãƒªã‚¹ãƒˆã‚’å†èª­ã¿è¾¼ã¿
          await loadProductDeleteList();
          
          // ç·¨é›†ä¸­ã®å•†å“æƒ…å ±ã‚’ã‚¯ãƒªã‚¢
          window.currentEditingProduct = null;
          
        } else {
          // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªãƒˆãƒƒãƒ”ãƒ³ã‚°é †åºã‚’ä¿å­˜ã™ã‚‹å ´åˆï¼ˆå°†æ¥ã®æ‹¡å¼µç”¨ï¼‰
          const updatePromises = toppingOrderData.map((topping, index) => {
            return window.updateDoc(window.getStoreDoc('toppings', topping.id), {
              order: index
            });
          });
          
          await Promise.all(updatePromises);
          
          await showCustomAlert('âœ… ãƒˆãƒƒãƒ”ãƒ³ã‚°é †åºã‚’ä¿å­˜ã—ã¾ã—ãŸ');
          closeToppingOrderModal();
        }
        
      } catch (error) {
        console.error('ãƒˆãƒƒãƒ”ãƒ³ã‚°é †åºä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        await showCustomAlert('âŒ ãƒˆãƒƒãƒ”ãƒ³ã‚°é †åºã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ\n\n' + error.message);
      }
    };
    
    // å•†å“ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°é †åºã‚’å¤‰æ›´
    window.openToppingOrderForProduct = async function(product) {
      // å•†å“ã«ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆãŒãªã„å ´åˆ
      if (!product.toppingSets || product.toppingSets.length === 0) {
        await showCustomAlert('ã“ã®å•†å“ã«ã¯ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      
      // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
      toppingOrderData = product.toppingSets.map((set, index) => ({
        ...set,
        originalIndex: index,
        order: index
      }));
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’å¤‰æ›´
      const modalTitle = document.querySelector('#toppingOrderModal h3');
      modalTitle.textContent = `ãƒˆãƒƒãƒ”ãƒ³ã‚°é †åºå¤‰æ›´ - ${product.name}`;
      
      // ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
      displayToppingOrderList();
      
      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
      document.getElementById('toppingOrderModal').classList.remove('hidden');
      
      // ä¿å­˜æ™‚ã«å•†å“ã‚‚ä¸€ç·’ã«æ›´æ–°ã™ã‚‹ãŸã‚ã€å•†å“æƒ…å ±ã‚’ä¿æŒ
      window.currentEditingProduct = product;
    };
    
    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼å‡¦ç†ï¼ˆåº—èˆ—åˆ¥èªè¨¼ + æ—§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å¯¾å¿œï¼‰
    let currentStoreId = null;
    let currentStoreName = null;
    
    async function handlePOSLogin(event) {
      event.preventDefault();
      
      console.log('=== POSãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œé–‹å§‹ ===');
      
      const storeNameInput = document.getElementById('posStoreNameInput').value.trim();
      const passwordInput = document.getElementById('posPasswordInput').value;
      const loginError = document.getElementById('loginError');
      
      console.log('å…¥åŠ›ã•ã‚ŒãŸåº—èˆ—å:', storeNameInput);
      console.log('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰é•·:', passwordInput.length);
      
      if (!storeNameInput || !passwordInput) {
        loginError.textContent = 'åº—èˆ—åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        loginError.style.display = 'block';
        return;
      }

      try {
        // Firebaseã®åˆæœŸåŒ–ã‚’å¾…ã¤
        console.log('FirebaseåˆæœŸåŒ–çŠ¶æ…‹:', window.firebaseReady);
        if (!window.firebaseReady) {
          loginError.textContent = 'ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ä¸­ã§ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚';
          loginError.style.display = 'block';
          return;
        }

        // ========== ä¸‹èµ¤å¡šåº—ã®ç‰¹åˆ¥å‡¦ç†ï¼ˆæœ€å„ªå…ˆï¼‰ ==========
        if (storeNameInput === 'ä¸‹èµ¤å¡š' && passwordInput === 'K12290619T') {
          console.log('âœ… ä¸‹èµ¤å¡šåº—ã¨ã—ã¦èªè¨¼ï¼ˆæ—§ã‚·ã‚¹ãƒ†ãƒ ï¼‰');
          // æ—§ã‚·ã‚¹ãƒ†ãƒ ç”¨ã®èªè¨¼
          currentStoreId = null; // æ—§ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã‚’ä½¿ç”¨
          currentStoreName = 'ä¸‹èµ¤å¡š';
          
          window.currentStoreId = null; // nullã®å ´åˆã¯æ—§ãƒ‘ã‚¹ã‚’ä½¿ã†
          window.currentStoreName = currentStoreName;
          
          sessionStorage.setItem('posStoreId', '');
          sessionStorage.setItem('posStoreName', currentStoreName);
          sessionStorage.setItem('posAuthenticated', 'true');
          
          const headerTitle = document.querySelector('.header-title');
          if (headerTitle) {
            headerTitle.textContent = currentStoreName + ' - ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ ';
          }
          
          console.log('âœ… ä¸‹èµ¤å¡šåº—ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ˆæ—§ã‚·ã‚¹ãƒ†ãƒ ï¼‰');
          console.log('   åº—èˆ—ID:', window.currentStoreId);
          console.log('   åº—èˆ—å:', window.currentStoreName);
          
          // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’éè¡¨ç¤ºã«ã—ã¦æ—¥ä»˜é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          document.getElementById('loginScreen').style.display = 'none';
          showDateSelectionModal();
          
          return;
        }

        console.log('åº—èˆ—ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¤œç´¢ä¸­...');
        // ã¾ãšæ–°ã—ã„åº—èˆ—åˆ¥èªè¨¼ã‚’è©¦ã¿ã‚‹
        const storesRef = window.collection(window.db, 'stores');
        const q = window.query(storesRef, window.where('storeName', '==', storeNameInput));
        const querySnapshot = await window.getDocs(q);
        
        console.log('æ¤œç´¢çµæœ:', querySnapshot.empty ? 'åº—èˆ—ãªã—' : 'åº—èˆ—ã‚ã‚Š');

        // æ–°ã—ã„åº—èˆ—åˆ¥èªè¨¼
        if (!querySnapshot.empty) {
          let authenticated = false;
          let storeData = null;
          let storeDocId = null;

          querySnapshot.forEach((doc) => {
            const data = doc.data();
            if (data.storePassword === passwordInput) {
              if (!data.isActive) {
                loginError.textContent = 'ã“ã®åº—èˆ—ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™';
                loginError.style.display = 'block';
                return;
              }
              authenticated = true;
              storeData = data;
              storeDocId = doc.id;
            }
          });

          if (authenticated && storeData) {
            // ğŸ”§ ä¸‹èµ¤å¡šåº—ã®ç‰¹åˆ¥å‡¦ç†: IDãŒ shimoarekasuka ã¾ãŸã¯ shimoakatsuka ã®å ´åˆã¯ null ã«å¤‰æ›
            if (storeDocId === 'shimoarekasuka' || storeDocId === 'shimoakatsuka') {
              console.log('ğŸ”§ ä¸‹èµ¤å¡šåº—ã®IDã‚’æ¤œå‡º: ' + storeDocId + ' â†’ null (æ—§ãƒ‘ã‚¹ä½¿ç”¨)');
              currentStoreId = null;
            } else {
              currentStoreId = storeDocId;
            }
            
            currentStoreName = storeData.storeName;
            
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨­å®š
            window.currentStoreId = currentStoreId;
            window.currentStoreName = currentStoreName;
            
            sessionStorage.setItem('posStoreId', currentStoreId || '');
            sessionStorage.setItem('posStoreName', currentStoreName);
            sessionStorage.setItem('posAuthenticated', 'true');
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã«åº—èˆ—åã‚’è¡¨ç¤º
            const headerTitle = document.querySelector('.header-title');
            if (headerTitle) {
              headerTitle.textContent = currentStoreName + ' - ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ ';
            }
            
            console.log('âœ… åº—èˆ—åˆ¥ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', currentStoreName, 'ID:', currentStoreId);
            
            // ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’éè¡¨ç¤ºã«ã—ã¦æ—¥ä»˜é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            document.getElementById('loginScreen').style.display = 'none';
            showDateSelectionModal();
            
            return;
          }
        }
        
        // åº—èˆ—ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€æ—§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã‚’è©¦ã™ï¼ˆä¸‹èµ¤å¡šåº—ç”¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        console.log('æ—§ã‚·ã‚¹ãƒ†ãƒ èªè¨¼ãƒã‚§ãƒƒã‚¯:', storeNameInput, '===', 'ä¸‹èµ¤å¡š', '?');
        if (storeNameInput === 'ä¸‹èµ¤å¡š' && passwordInput === 'K12290619T') {
          console.log('âœ… æ—§ã‚·ã‚¹ãƒ†ãƒ èªè¨¼æ¡ä»¶ã«ä¸€è‡´');
          // æ—§ã‚·ã‚¹ãƒ†ãƒ ç”¨ã®èªè¨¼
          currentStoreId = null; // æ—§ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã‚’ä½¿ç”¨
          currentStoreName = 'ä¸‹èµ¤å¡š';
          
          window.currentStoreId = null; // nullã®å ´åˆã¯æ—§ãƒ‘ã‚¹ã‚’ä½¿ã†
          window.currentStoreName = currentStoreName;
          
          sessionStorage.setItem('posStoreId', '');
          sessionStorage.setItem('posStoreName', currentStoreName);
          sessionStorage.setItem('posAuthenticated', 'true');
          
          console.log('ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä¿å­˜å®Œäº†');
          
          // ğŸ†• ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸå¾Œã€æ—¥ä»˜é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          document.getElementById('loginScreen').style.display = 'none';
          showDateSelectionModal();
          
          // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¯æ—¥ä»˜é¸æŠå¾Œã«è¡¨ç¤º
          
          const headerTitle = document.querySelector('.header-title');
          if (headerTitle) {
            headerTitle.textContent = currentStoreName + ' - ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ ';
          }
          
          console.log('âœ… æ—§ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ˆç§»è¡Œå‰ï¼‰:', currentStoreName);
          
          return;
        } else {
          console.log('âŒ æ—§ã‚·ã‚¹ãƒ†ãƒ èªè¨¼æ¡ä»¶ã«ä¸ä¸€è‡´');
        }

        // ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—
        loginError.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
        loginError.style.display = 'block';
        document.getElementById('posPasswordInput').value = '';
        
        setTimeout(() => {
          loginError.style.display = 'none';
        }, 3000);
      } catch (error) {
        console.error('âŒ ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
        loginError.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼: ' + error.message;
        loginError.style.display = 'block';
      }
    }
    
    // ğŸ”Š ãƒ¬ã‚¸éŸ³ã‚’å†ç”Ÿã™ã‚‹é–¢æ•°
    function playBeepSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // AudioContextã‚’å†é–‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•å†ç”Ÿãƒãƒªã‚·ãƒ¼å¯¾ç­–ï¼‰
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }
        
        // 2å›ã®ãƒ“ãƒ¼ãƒ—éŸ³ï¼ˆãƒ”ãƒƒãƒ”ãƒƒï¼‰
        const beep = (frequency, startTime, duration) => {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.value = frequency;
          oscillator.type = 'sine';
          
          gainNode.gain.setValueAtTime(0.2, startTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
          
          oscillator.start(startTime);
          oscillator.stop(startTime + duration);
        };
        
        const now = audioContext.currentTime;
        beep(2000, now + 0.05, 0.08);
        beep(2000, now + 0.20, 0.08);
        
        console.log('ğŸ”Š ãƒ¬ã‚¸éŸ³å†ç”Ÿå®Œäº†');
      } catch (e) {
        console.error('ğŸ”‡ éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
    window.addEventListener('DOMContentLoaded', () => {
      // ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
      const loginForm = document.getElementById('posLoginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', handlePOSLogin);
        console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç™»éŒ²å®Œäº†');
      }
      
      // iframeã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡
      window.addEventListener('message', (event) => {
        // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: åŒä¸€ã‚ªãƒªã‚¸ãƒ³ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã¿å—ã‘ä»˜ã‘ã‚‹
        if (event.origin !== window.location.origin) {
          return;
        }
        
        console.log('ğŸ“¨ iframeã‹ã‚‰ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡:', event.data);
        
        if (event.data.type === 'addToCart') {
          // menu.htmlã‹ã‚‰å•†å“è¿½åŠ ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡
          const item = event.data.item;
          console.log('ğŸ›’ å•†å“ã‚’ã‚«ãƒ¼ãƒˆã«è¿½åŠ :', item);
          
          // å•†å“è¿½åŠ é–¢æ•°ã‚’å‘¼ã³å‡ºã—
          if (window.addItemFromIframe) {
            window.addItemFromIframe(item);
          } else {
            console.error('âŒ addItemFromIframeé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }
        } else if (event.data.type === 'playBeep') {
          // ğŸ”Š menu.htmlã‹ã‚‰éŸ³å†ç”Ÿã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡
          console.log('ğŸ”Š ãƒ¬ã‚¸éŸ³å†ç”Ÿãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡');
          playBeepSound();
        }
      });
      
      const isAuthenticated = sessionStorage.getItem('posAuthenticated');
      const savedStoreId = sessionStorage.getItem('posStoreId');
      const savedStoreName = sessionStorage.getItem('posStoreName');
      
      if (isAuthenticated === 'true' && savedStoreName) {
        // ğŸ”§ ä¸‹èµ¤å¡šåº—ã®ç‰¹åˆ¥å‡¦ç†: IDãŒ shimoarekasuka ã¾ãŸã¯ shimoakatsuka ã®å ´åˆã¯ null ã«å¤‰æ›
        let actualStoreId = (savedStoreId && savedStoreId !== '') ? savedStoreId : null;
        if (actualStoreId === 'shimoarekasuka' || actualStoreId === 'shimoakatsuka') {
          console.log('ğŸ”§ ä¸‹èµ¤å¡šåº—ã®IDã‚’æ¤œå‡º: ' + actualStoreId + ' â†’ null (æ—§ãƒ‘ã‚¹ä½¿ç”¨)');
          actualStoreId = null;
        }
        
        // æ—¢ã«ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ï¼ˆç©ºæ–‡å­—åˆ—ã®storeIdã‚‚OK - æ—§ã‚·ã‚¹ãƒ†ãƒ ç”¨ï¼‰
        currentStoreId = actualStoreId;
        currentStoreName = savedStoreName;
        window.currentStoreId = currentStoreId;
        window.currentStoreName = currentStoreName;
        
        // ğŸ†• å–¶æ¥­æ—¥ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å¾©å…ƒ
        const savedBusinessDate = sessionStorage.getItem('businessDate');
        if (savedBusinessDate) {
          window.selectedBusinessDate = savedBusinessDate;
          console.log('ğŸ“… å–¶æ¥­æ—¥å¾©å…ƒ:', window.selectedBusinessDate);
          
          // å–¶æ¥­æ—¥ãŒä¿å­˜ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('mainContent').style.display = 'block';
          
          // ğŸ†• å–¶æ¥­æ—¥è¡¨ç¤ºã‚’æ›´æ–°
          updateBusinessDateDisplay();
          
          // ãƒ˜ãƒƒãƒ€ãƒ¼ã«åº—èˆ—åã‚’è¡¨ç¤º
          const headerTitle = document.querySelector('.header-title');
          if (headerTitle) {
            headerTitle.textContent = currentStoreName + ' - ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ ';
          }
          
          console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰å¾©å…ƒ:', currentStoreName, 'StoreID:', currentStoreId || '(æ—§ã‚·ã‚¹ãƒ†ãƒ )');
          
          // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºã‚’å¾…ã£ã¦ã‹ã‚‰åˆæœŸåŒ–ï¼ˆsetTimeoutã‚’ä½¿ç”¨ï¼‰
          setTimeout(() => {
            console.log('ğŸš€ ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒå¾Œã®åˆæœŸåŒ–å‡¦ç†é–‹å§‹');
            
            // ã¾ãšiframeã‚’åˆæœŸåŒ–
            console.log('ğŸ–¼ï¸ iframeåˆæœŸåŒ–ã‚’æœ€å„ªå…ˆã§å®Ÿè¡Œ');
            updateMenuIframe();
            
            // ãã®å¾Œã€ä»–ã®åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
            setTimeout(() => {
              if (window.firebaseReady) {
                // iframeä»¥å¤–ã®åˆæœŸåŒ–å‡¦ç†
                loadStaffList();
                loadReceiptSettings();
                updateInventoryPanel();
                watchInventoryChanges();
              }
            }, 500);
          }, 300);
        } else {
          // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ãªã„å ´åˆã¯å–¶æ¥­æ—¥é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          console.log('ğŸ“… å–¶æ¥­æ—¥æœªè¨­å®š - å–¶æ¥­æ—¥é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º');
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('dateSelectionModal').style.display = 'flex';
        }
      }
    });
    
    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–å‡¦ç†
    function initializeApp() {
      // æ—¢å­˜ã®åˆæœŸåŒ–å‡¦ç†ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€ã“ã“ã§ã¯ä½•ã‚‚ã—ãªã„
      console.log('âœ… POSã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
      console.log('   åº—èˆ—å:', window.currentStoreName);
      console.log('   åº—èˆ—ID:', window.currentStoreId);
      console.log('   ãƒ‘ã‚¹:', window.currentStoreId ? 'stores/' + window.currentStoreId : 'æ—§ãƒ‘ã‚¹(ç›´æ¥)');
      
      // æ‹…å½“è€…ãƒªã‚¹ãƒˆã‚’èª­ã¿è¾¼ã‚€
      loadStaffList();
      
      // ğŸ†• ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã‚€
      loadReceiptSettings();
      
      // ğŸ†• menu.htmlã®iframeã«åº—èˆ—IDã‚’è¨­å®š
      updateMenuIframe();
      
      // ğŸ†• åœ¨åº«ãƒ‘ãƒãƒ«ã‚’åˆæœŸåŒ–
      updateInventoryPanel();
      watchInventoryChanges();
    }
    
    // ğŸ†• åœ¨åº«æ›´æ–°å¾Œã«ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã¨ã¯åˆ¥ï¼‰
    async function checkInventoryAlertsAfterUpdate() {
      try {
        console.log('ğŸ”” åœ¨åº«æ›´æ–°å¾Œã®ã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯');
        
        // ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã‚’å–å¾—
        let alertSettingsRef;
        if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
          alertSettingsRef = window.doc(window.db, 'alert_settings', 'default');
        } else {
          alertSettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'alert_settings', 'default');
        }
        
        const alertSettingsDoc = await window.getDoc(alertSettingsRef);
        
        if (!alertSettingsDoc.exists()) {
          return;
        }
        
        const alertSettings = alertSettingsDoc.data();
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šã‚’å–å¾—
        let menuSettingsRef;
        if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
          menuSettingsRef = window.doc(window.db, 'menu_settings', 'shimoakatsuka');
        } else {
          menuSettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'menu_settings', 'default');
        }
        
        const menuSettingsDoc = await window.getDoc(menuSettingsRef);
        
        if (!menuSettingsDoc.exists()) {
          return;
        }
        
        const menuSettings = menuSettingsDoc.data();
        const inventoryData = menuSettings.inventory || {};
        
        // åœ¨åº«ãŒå°‘ãªã„å•†å“ã‚’ãƒã‚§ãƒƒã‚¯
        const lowStockItems = [];
        
        for (const [itemName, settings] of Object.entries(alertSettings)) {
          if (typeof settings === 'object' && settings !== null && settings.enabled === true) {
            const threshold = settings.threshold || 0;
            const currentStock = inventoryData[itemName] || 0;
            
            if (currentStock <= threshold) {
              lowStockItems.push({
                name: itemName,
                current: currentStock,
                threshold: threshold
              });
            }
          }
        }
        
        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºï¼ˆå‰Šé™¤ - åœ¨åº«è¨­å®šã«é–¢ã‚ã‚‰ãšã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ãªã„ï¼‰
        if (lowStockItems.length > 0) {
          console.log('ğŸ“¦ åœ¨åº«ãŒå°‘ãªããªã£ã¦ã„ã¾ã™ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆã¯éè¡¨ç¤ºï¼‰:', lowStockItems);
          // ã‚¢ãƒ©ãƒ¼ãƒˆã¯è¡¨ç¤ºã—ãªã„
        }
        
      } catch (error) {
        console.error('âŒ åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼ï¼ˆæ›´æ–°å¾Œï¼‰:', error);
      }
    }
    
    // ğŸ†• åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°ï¼ˆãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ï¼‰
    async function checkInventoryAlerts() {
      try {
        console.log('ğŸ””ğŸ””ğŸ”” åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆã‚’ãƒã‚§ãƒƒã‚¯é–‹å§‹ ğŸ””ğŸ””ğŸ””');
        console.log('ç¾åœ¨ã®StoreID:', window.currentStoreId);
        
        // åœ¨åº«è¨­å®šã‚’å–å¾—ï¼ˆkanri.htmlã¨åŒã˜ãƒ‘ã‚¹ï¼‰
        let inventorySettingsRef;
        if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
          inventorySettingsRef = window.doc(window.db, 'inventory_settings', 'default');
          console.log('  â†’ æ—§ãƒ‘ã‚¹ä½¿ç”¨: inventory_settings/default');
        } else {
          inventorySettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
          console.log('  â†’ æ–°ãƒ‘ã‚¹ä½¿ç”¨: stores/' + window.currentStoreId + '/inventory_settings/default');
        }
        
        const inventorySettingsDoc = await window.getDoc(inventorySettingsRef);
        
        if (!inventorySettingsDoc.exists()) {
          console.log('ğŸ“¦ åœ¨åº«è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆåœ¨åº«ç„¡é™ãƒ¢ãƒ¼ãƒ‰ï¼‰');
          // åœ¨åº«ç„¡é™ã®å ´åˆã¯ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã›ãšã«çµ‚äº†
          return;
        }
        
        const inventorySettingsData = inventorySettingsDoc.data();
        const alertSettings = inventorySettingsData.items || {};
        console.log('ğŸ“‹ åœ¨åº«è¨­å®šï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ï¼‰:', JSON.stringify(alertSettings, null, 2));
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šã‚’å–å¾—
        let menuSettingsRef;
        if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
          menuSettingsRef = window.doc(window.db, 'menu_settings', 'shimoakatsuka');
          console.log('  â†’ æ—§ãƒ‘ã‚¹ä½¿ç”¨: menu_settings/shimoakatsuka');
        } else {
          menuSettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'menu_settings', 'default');
          console.log('  â†’ æ–°ãƒ‘ã‚¹ä½¿ç”¨: stores/' + window.currentStoreId + '/menu_settings/default');
        }
        
        const menuSettingsDoc = await window.getDoc(menuSettingsRef);
        
        if (!menuSettingsDoc.exists()) {
          console.error('âŒâŒâŒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ âŒâŒâŒ');
          alert('ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
          return;
        }
        
        const menuSettings = menuSettingsDoc.data();
        const inventoryData = menuSettings.inventory || {};
        console.log('ğŸ“¦ åœ¨åº«ãƒ‡ãƒ¼ã‚¿ï¼ˆå…¨ãƒ‡ãƒ¼ã‚¿ï¼‰:', JSON.stringify(inventoryData, null, 2));
        
        // åœ¨åº«ãŒå°‘ãªã„å•†å“ã‚’ãƒã‚§ãƒƒã‚¯
        const lowStockItems = [];
        let checkedCount = 0;
        
        // inventory_settingsã®å„å•†å“IDã‚’ãƒã‚§ãƒƒã‚¯
        for (const [itemId, settings] of Object.entries(alertSettings)) {
          console.log(`\n--- ãƒã‚§ãƒƒã‚¯ ${checkedCount + 1} ---`);
          console.log('å•†å“ID:', itemId);
          console.log('è¨­å®š:', settings);
          console.log('è¨­å®šã®ã‚¿ã‚¤ãƒ—:', typeof settings);
          
          if (typeof settings === 'object' && settings !== null) {
            const stock = settings.stock;
            const alertThreshold = settings.alertThreshold;
            
            console.log('  stock:', stock);
            console.log('  alertThreshold:', alertThreshold);
            
            // stockã¨alertThresholdã®ä¸¡æ–¹ãŒnullã§ãªã„å ´åˆã®ã¿ãƒã‚§ãƒƒã‚¯
            if (stock !== null && stock !== undefined && alertThreshold !== null && alertThreshold !== undefined) {
              checkedCount++;
              
              console.log(`  âœ… å•†å“ID ${itemId}: ç¾åœ¨åº«=${stock}, é–¾å€¤=${alertThreshold}`);
              console.log(`  æ¯”è¼ƒ: ${stock} <= ${alertThreshold} = ${stock <= alertThreshold}`);
              
              if (stock <= alertThreshold) {
                console.log(`  ğŸš¨ åœ¨åº«ä¸è¶³æ¤œå‡ºï¼`);
                
                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼åã‚’å–å¾—ï¼ˆmenusã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰ï¼‰
                try {
                  const menuRef = window.getStoreDoc('menus', itemId);
                  const menuDoc = await window.getDoc(menuRef);
                  const itemName = menuDoc.exists() ? menuDoc.data().name : itemId;
                  
                  lowStockItems.push({
                    name: itemName,
                    current: stock,
                    threshold: alertThreshold
                  });
                } catch (e) {
                  console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼åå–å¾—ã‚¨ãƒ©ãƒ¼:', e);
                  lowStockItems.push({
                    name: itemId,
                    current: stock,
                    threshold: alertThreshold
                  });
                }
              }
            } else {
              console.log(`  â­ï¸ å•†å“ID ${itemId}: ã‚¢ãƒ©ãƒ¼ãƒˆç„¡åŠ¹ï¼ˆstock=${stock}, alertThreshold=${alertThreshold}ï¼‰`);
            }
          } else {
            console.log(`  â­ï¸ å•†å“ID ${itemId}: ç„¡åŠ¹ãªè¨­å®šå½¢å¼`);
          }
        }
        
        console.log('\n=== ãƒã‚§ãƒƒã‚¯çµæœ ===');
        console.log('ãƒã‚§ãƒƒã‚¯ã—ãŸå•†å“æ•°:', checkedCount);
        console.log('åœ¨åº«ä¸è¶³å•†å“æ•°:', lowStockItems.length);
        console.log('åœ¨åº«ä¸è¶³å•†å“:', lowStockItems);
        
        // ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºï¼ˆå‰Šé™¤ - åœ¨åº«è¨­å®šã«é–¢ã‚ã‚‰ãšã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã—ãªã„ï¼‰
        if (lowStockItems.length > 0) {
          console.log('ğŸ“¦ åœ¨åº«ãŒå°‘ãªããªã£ã¦ã„ã¾ã™ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆã¯éè¡¨ç¤ºï¼‰:', lowStockItems);
          // ã‚¢ãƒ©ãƒ¼ãƒˆã¯è¡¨ç¤ºã—ãªã„
        } else {
          console.log('âœ… åœ¨åº«ã¯ååˆ†ã§ã™ï¼ˆã¾ãŸã¯æœ‰åŠ¹ãªã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šãªã—ï¼‰');
        }
        
      } catch (error) {
        console.error('âŒâŒâŒ åœ¨åº«ã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼ âŒâŒâŒ');
        console.error('ã‚¨ãƒ©ãƒ¼è©³ç´°:', error);
        console.error('ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:', error.stack);
        // ã‚¨ãƒ©ãƒ¼ã‚¢ãƒ©ãƒ¼ãƒˆã‚‚éè¡¨ç¤º
      }
    }
    
    // ğŸ†• ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ä¿æŒ
    window.receiptSettings = {
      storeName: 'ç²‰ã‚‚ã‚“å±‹ å…«',
      branchName: 'ä¸‹èµ¤å¡šåº—',
      address: 'æ±äº¬éƒ½æ¿æ©‹åŒºèµ¤å¡šæ–°ç”º',
      phone: '03-XXXX-XXXX'
    };
    
    // ğŸ†• ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã‚€é–¢æ•°
    async function loadReceiptSettings() {
      try {
        console.log('ğŸ“„ ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­...');
        
        // ä¸‹èµ¤å¡šåº—ï¼ˆcurrentStoreId = nullï¼‰ã®å ´åˆã¯æ—§ãƒ‘ã‚¹ã€ãã‚Œä»¥å¤–ã¯æ–°ãƒ‘ã‚¹
        let receiptSettingsRef;
        if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
          receiptSettingsRef = window.doc(window.db, 'receipt_settings', 'shimoakatsuka');
          console.log('  â†’ æ—§ãƒ‘ã‚¹: receipt_settings/shimoakatsuka');
        } else {
          receiptSettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'receipt_settings', 'default');
          console.log('  â†’ æ–°ãƒ‘ã‚¹: stores/' + window.currentStoreId + '/receipt_settings/default');
        }
        
        const receiptSettingsDoc = await window.getDoc(receiptSettingsRef);
        
        if (receiptSettingsDoc.exists()) {
          const settings = receiptSettingsDoc.data();
          window.receiptSettings = {
            storeName: settings.storeName || 'ç²‰ã‚‚ã‚“å±‹ å…«',
            branchName: settings.branchName || 'ä¸‹èµ¤å¡šåº—',
            address: settings.address || 'æ±äº¬éƒ½æ¿æ©‹åŒºèµ¤å¡šæ–°ç”º',
            phone: settings.phone || '03-XXXX-XXXX',
            postalCode: settings.postalCode || '',
            message: settings.message || '',
            stampImage: settings.stampImage || '',  // Base64ç”»åƒãƒ‡ãƒ¼ã‚¿
            stampCanvas: null  // ğŸ†• Canvas contextï¼ˆå°åˆ·ç”¨ï¼‰
          };
          console.log('âœ… ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', window.receiptSettings);
          
          // ğŸ†• å°é‘‘ç”»åƒã‚’Canvasã«å¤‰æ›
          if (settings.stampImage) {
            console.log('   å°é‘‘ç”»åƒ: ã‚ã‚Š - Canvasã«å¤‰æ›ä¸­...');
            try {
              const img = new Image();
              img.src = settings.stampImage;
              
              await new Promise((resolve, reject) => {
                img.onload = () => {
                  const canvas = document.createElement('canvas');
                  canvas.width = img.width;
                  canvas.height = img.height;
                  const ctx = canvas.getContext('2d');
                  ctx.drawImage(img, 0, 0);
                  
                  window.receiptSettings.stampCanvas = ctx;
                  console.log('   âœ… å°é‘‘ç”»åƒã‚’Canvasã«å¤‰æ›ã—ã¾ã—ãŸ (', img.width, 'x', img.height, ')');
                  resolve();
                };
                img.onerror = (error) => {
                  console.error('   âŒ å°é‘‘ç”»åƒã®å¤‰æ›ã«å¤±æ•—:', error);
                  resolve();  // ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶šè¡Œ
                };
              });
            } catch (error) {
              console.error('   âŒ å°é‘‘ç”»åƒã®å¤‰æ›ã‚¨ãƒ©ãƒ¼:', error);
            }
          }
        } else {
          console.log('âš ï¸ ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
        }
      } catch (error) {
        console.error('âŒ ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // menu.htmlã®iframeã®srcã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    function updateMenuIframe() {
      console.log('ğŸ–¼ï¸ updateMenuIframeå‘¼ã³å‡ºã—');
      const iframe = document.getElementById('menuIframe');
      
      if (!iframe) {
        console.error('âŒ menuIframeãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ - 1ç§’å¾Œã«å†è©¦è¡Œ');
        setTimeout(() => {
          updateMenuIframe();
        }, 1000);
        return;
      }
      
      console.log('âœ… menuIframeè¦ç´ ã‚’ç™ºè¦‹');
      console.log('   iframe.style.display:', iframe.style.display);
      console.log('   iframeè¦ªè¦ç´ ã®è¡¨ç¤ºçŠ¶æ…‹:', iframe.parentElement ? iframe.parentElement.style.display : 'N/A');
      
      let iframeSrc;
      if (window.currentStoreId) {
        iframeSrc = `menu.html?mode=pos&hideHeader=true&store=${window.currentStoreId}&t=${Date.now()}`;
        console.log('ğŸ–¼ï¸ menu.htmlã®iframeã‚’æ›´æ–° (åº—èˆ—IDæœ‰):', iframeSrc);
      } else {
        // æ—§ã‚·ã‚¹ãƒ†ãƒ ï¼ˆåº—èˆ—IDãªã—ï¼‰ã®å ´åˆ
        iframeSrc = `menu.html?mode=pos&hideHeader=true&t=${Date.now()}`;
        console.log('ğŸ–¼ï¸ menu.htmlã®iframeã‚’æ›´æ–° (åº—èˆ—IDãªã—):', iframeSrc);
      }
      
      // iframe srcã‚’è¨­å®š
      console.log('ğŸ”„ iframe srcã‚’è¨­å®šä¸­...');
      iframe.src = iframeSrc;
      
      // èª­ã¿è¾¼ã¿ç›£è¦–
      iframe.onload = function() {
        console.log('âœ…âœ…âœ… menu.html iframeèª­ã¿è¾¼ã¿å®Œäº†ï¼');
      };
      
      iframe.onerror = function(e) {
        console.error('âŒ menu.html iframeèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      };
      
      // 5ç§’å¾Œã«èª­ã¿è¾¼ã¿çŠ¶æ…‹ã‚’ç¢ºèª
      setTimeout(() => {
        if (iframe.src === iframeSrc) {
          console.log('ğŸ” 5ç§’å¾Œã®ç¢ºèª: iframe srcã¯æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã¾ã™');
          console.log('   ç¾åœ¨ã®src:', iframe.src);
        } else {
          console.warn('âš ï¸ 5ç§’å¾Œã®ç¢ºèª: iframe srcãŒå¤‰æ›´ã•ã‚Œã¦ã„ã¾ã™');
        }
      }, 5000);
    }
    
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†ï¼ˆã‚ªã‚·ãƒ£ãƒ¬ãªãƒ¢ãƒ¼ãƒ€ãƒ«ä½¿ç”¨ï¼‰
    async function handleLogout() {
      const confirmed = await showCustomConfirm({
        icon: 'ğŸšª',
        title: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
        message: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ\nä¿å­˜ã•ã‚Œã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã¾ã™ã€‚',
        btnClass: 'modal-btn-danger',
        btnText: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ'
      });
      
      if (confirmed) {
        sessionStorage.removeItem('posAuthenticated');
        sessionStorage.removeItem('posStoreId');
        sessionStorage.removeItem('posStoreName');
        sessionStorage.removeItem('businessDate');  // ğŸ†• å–¶æ¥­æ—¥ã‚‚ã‚¯ãƒªã‚¢
        window.currentStoreId = null;
        window.currentStoreName = null;
        window.selectedBusinessDate = null;  // ğŸ†•
        
        // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        await showCustomConfirm({
          icon: '',
          title: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†',
          message: 'ã¾ãŸã®ã”åˆ©ç”¨ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™',
          btnClass: 'modal-btn-success',
          btnText: 'OK'
        });
        
        location.reload();
      }
    }
  </script>
  
  <!-- ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="customConfirmModal" class="custom-modal-overlay">
    <div class="custom-modal-box">
      <div class="modal-icon" id="modalIcon">âš ï¸</div>
      <div class="modal-title" id="modalTitle">ç¢ºèª</div>
      <div class="modal-message" id="modalMessage">æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ</div>
      <div class="modal-buttons">
        <button class="modal-btn modal-btn-cancel" onclick="closeCustomModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="modal-btn modal-btn-danger" id="modalConfirmBtn" onclick="confirmCustomModal()">å®Ÿè¡Œ</button>
      </div>
    </div>
  </div>
  
  <script>
    // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«
    let customModalResolve = null;
    
    function showCustomConfirm(options) {
      return new Promise((resolve) => {
        customModalResolve = resolve;
        
        const modal = document.getElementById('customConfirmModal');
        const icon = document.getElementById('modalIcon');
        const title = document.getElementById('modalTitle');
        const message = document.getElementById('modalMessage');
        const confirmBtn = document.getElementById('modalConfirmBtn');
        
        icon.textContent = options.icon || 'âš ï¸';
        title.textContent = options.title || 'ç¢ºèª';
        message.textContent = options.message || 'æœ¬å½“ã«å®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ';
        
        confirmBtn.className = 'modal-btn ' + (options.btnClass || 'modal-btn-danger');
        confirmBtn.textContent = options.btnText || 'å®Ÿè¡Œ';
        
        modal.style.display = 'flex';
      });
    }
    
    function closeCustomModal() {
      document.getElementById('customConfirmModal').style.display = 'none';
      if (customModalResolve) {
        customModalResolve(false);
        customModalResolve = null;
      }
    }
    
    function confirmCustomModal() {
      document.getElementById('customConfirmModal').style.display = 'none';
      if (customModalResolve) {
        customModalResolve(true);
        customModalResolve = null;
      }
    }
    
    // ========== ğŸ“¦ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åœ¨åº«ãƒ‘ãƒãƒ« ==========
    
    // åœ¨åº«ãƒ‘ãƒãƒ«ã‚’æ›´æ–°
    async function updateInventoryPanel() {
      try {
        console.log('ğŸ“¦ åœ¨åº«ãƒ‘ãƒãƒ«ã‚’æ›´æ–°ä¸­...');
        
        // inventory_settings ã‚’å–å¾—
        let inventorySettingsRef;
        if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
          inventorySettingsRef = window.doc(window.db, 'inventory_settings', 'default');
        } else {
          inventorySettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
        }
        
        const inventorySettingsSnap = await window.getDoc(inventorySettingsRef);
        
        if (!inventorySettingsSnap.exists()) {
          console.log('âš ï¸ åœ¨åº«è¨­å®šãŒå­˜åœ¨ã—ã¾ã›ã‚“');
          document.getElementById('inventoryPanelContent').innerHTML = '<div style="padding: 10px; text-align: center; color: #999;">åœ¨åº«è¨­å®šãªã—</div>';
          // ãƒãƒ¼ã®è‰²ã‚’é€šå¸¸ã«æˆ»ã™
          document.getElementById('inventoryPanelBar').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          return;
        }
        
        const inventorySettingsData = inventorySettingsSnap.data();
        const inventoryItems = inventorySettingsData.items || {};
        
        // menusã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰å•†å“åã‚’å–å¾—
        const menuSnapshot = await window.getDocs(window.getStoreCollection('menus'));
        const idToNameMap = {};
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          const itemId = data.id || doc.id;
          if (data.name) {
            idToNameMap[itemId] = data.name;
          }
        });
        
        // åœ¨åº«ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å•†å“ã®ã¿è¡¨ç¤ºï¼ˆåœ¨åº«å°‘ãƒ»å“åˆ‡ã‚Œã‚’å„ªå…ˆï¼‰
        const lowStockItems = [];
        const outOfStockItems = [];
        const normalStockItems = [];
        
        for (const [itemId, settings] of Object.entries(inventoryItems)) {
          const stock = settings.stock;
          const alertThreshold = settings.alertThreshold;
          const itemName = idToNameMap[itemId] || itemId;
          
          // stockãŒnullã§ãªã„ï¼ˆåœ¨åº«ç®¡ç†å¯¾è±¡ï¼‰å ´åˆã®ã¿è¡¨ç¤º
          if (stock !== null && stock !== undefined) {
            const item = { id: itemId, name: itemName, stock, alertThreshold };
            
            if (stock === 0) {
              outOfStockItems.push(item);
            } else if (alertThreshold !== null && alertThreshold !== undefined && stock <= alertThreshold) {
              lowStockItems.push(item);
            } else {
              normalStockItems.push(item);
            }
          }
        }
        
        // ğŸ†• ãƒãƒ¼ã®è‰²ã‚’åœ¨åº«çŠ¶æ…‹ã«å¿œã˜ã¦å¤‰æ›´
        const panelBar = document.getElementById('inventoryPanelBar');
        if (outOfStockItems.length > 0) {
          // åœ¨åº«åˆ‡ã‚ŒãŒã‚ã‚‹å ´åˆã¯èµ¤
          panelBar.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
        } else if (lowStockItems.length > 0) {
          // åœ¨åº«å°‘ãŒã‚ã‚‹å ´åˆã¯é»„è‰²
          panelBar.style.background = 'linear-gradient(135deg, #FF9800 0%, #F57C00 100%)';
        } else {
          // å•é¡Œãªã—ã®å ´åˆã¯ç´«ï¼ˆé€šå¸¸ï¼‰
          panelBar.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        }
        
        // è¡¨ç¤ºç”¨HTMLç”Ÿæˆ
        let html = '';
        
        // å“åˆ‡ã‚Œï¼ˆèµ¤ï¼‰
        outOfStockItems.forEach(item => {
          html += `
            <div style="padding: 8px 12px; background: #ffebee; border-left: 4px solid #f44336; margin-bottom: 6px; border-radius: 4px;">
              <div style="font-weight: bold; color: #f44336; font-size: 14px;">${item.name}</div>
              <div style="color: #f44336; font-size: 13px; font-weight: bold;">å“åˆ‡</div>
            </div>
          `;
        });
        
        // åœ¨åº«å°‘ï¼ˆé»„ï¼‰
        lowStockItems.forEach(item => {
          html += `
            <div style="padding: 8px 12px; background: #fff9e6; border-left: 4px solid #ff9800; margin-bottom: 6px; border-radius: 4px;">
              <div style="font-weight: bold; color: #ff9800; font-size: 14px;">${item.name}</div>
              <div style="color: #ff9800; font-size: 13px;">æ®‹ ${item.stock}</div>
            </div>
          `;
        });
        
        // é€šå¸¸åœ¨åº«ï¼ˆè¡¨ç¤ºã—ãªã„ã€ã¾ãŸã¯æŠ˜ã‚ŠãŸãŸã¿ï¼‰
        // ã“ã“ã§ã¯åœ¨åº«ãŒå°‘ãªã„ã‚‚ã®ã®ã¿è¡¨ç¤º
        
        if (html === '') {
          html = '<div style="padding: 10px; text-align: center; color: #4caf50; font-weight: bold;">åœ¨åº«å……åˆ†âœ“</div>';
        }
        
        document.getElementById('inventoryPanelContent').innerHTML = html;
        console.log('âœ… åœ¨åº«ãƒ‘ãƒãƒ«æ›´æ–°å®Œäº†');
        
      } catch (error) {
        console.error('âŒ åœ¨åº«ãƒ‘ãƒãƒ«æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // åœ¨åº«ãƒ‘ãƒãƒ«ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
    function toggleInventoryPanel() {
      const panel = document.getElementById('inventoryPanel');
      const arrow = document.getElementById('inventoryPanelArrow');
      const isCollapsed = panel.classList.contains('collapsed');
      
      if (isCollapsed) {
        panel.classList.remove('collapsed');
        panel.style.maxHeight = '400px';
        arrow.textContent = 'â–¼';
      } else {
        panel.classList.add('collapsed');
        panel.style.maxHeight = '45px';
        arrow.textContent = 'â–²';
      }
    }
    
    // ğŸ–¨ï¸ ãƒ—ãƒªãƒ³ã‚¿è¨­å®šé–¢æ•°ç¾¤
    
    // æ¥ç¶šæ–¹å¼ã‚’é¸æŠ
    window.selectConnectionType = function(type) {
      PRINTER_CONNECTION_TYPE = type;
      
      const ethernetBtn = document.getElementById('connectionTypeEthernet');
      const bluetoothBtn = document.getElementById('connectionTypeBluetooth');
      const ethernetSettings = document.getElementById('ethernetSettings');
      const bluetoothSettings = document.getElementById('bluetoothSettings');
      
      if (type === 'ethernet') {
        ethernetBtn.style.background = '#667eea';
        ethernetBtn.style.color = 'white';
        bluetoothBtn.style.background = 'white';
        bluetoothBtn.style.color = '#666';
        ethernetSettings.style.display = 'block';
        bluetoothSettings.style.display = 'none';
      } else {
        ethernetBtn.style.background = 'white';
        ethernetBtn.style.color = '#666';
        bluetoothBtn.style.background = '#667eea';
        bluetoothBtn.style.color = 'white';
        ethernetSettings.style.display = 'none';
        bluetoothSettings.style.display = 'block';
      }
    };
    
    // Bluetoothæ¤œç´¢ã®æ¡ˆå†…ã‚’è¡¨ç¤º
    window.showBluetoothSearchGuide = function() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;';
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
          <div style="text-align: center; margin-bottom: 25px;">
            <div style="width: 80px; height: 80px; margin: 0 auto 20px; border-radius: 50%; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; display: flex; align-items: center; justify-content: center; font-size: 40px; font-weight: bold;">
              BT
            </div>
            <h3 style="font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #333;">Bluetoothãƒ—ãƒªãƒ³ã‚¿ã®æ¤œç´¢</h3>
          </div>
          
          <div style="background: #f5f5f5; padding: 20px; border-radius: 12px; margin-bottom: 25px;">
            <p style="font-size: 15px; color: #555; margin-bottom: 12px; line-height: 1.6;">
              ã“ã®å¾Œã€ãƒ–ãƒ©ã‚¦ã‚¶ã®ãƒšã‚¢è¨­å®šç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            </p>
            <p style="font-size: 14px; color: #666; line-height: 1.6;">
              <strong style="color: #333;">ç¢ºèªäº‹é …ï¼š</strong><br>
              â€¢ ãƒ—ãƒªãƒ³ã‚¿ã®é›»æºãŒå…¥ã£ã¦ã„ã‚‹<br>
              â€¢ BluetoothãŒONã«ãªã£ã¦ã„ã‚‹<br>
              â€¢ ãƒšã‚¢ãƒªãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰ã«ãªã£ã¦ã„ã‚‹
            </p>
          </div>
          
          <div style="display: flex; gap: 12px;">
            <button onclick="this.closest('.modal-overlay').remove()" style="flex: 1; padding: 15px; font-size: 16px; font-weight: bold; border: 2px solid #ddd; background: white; color: #666; border-radius: 10px; cursor: pointer;">
              ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            </button>
            <button onclick="this.closest('.modal-overlay').remove(); window.startBluetoothSearch();" style="flex: 1; padding: 15px; font-size: 16px; font-weight: bold; border: none; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 15px rgba(33,150,243,0.3);">
              æ¤œç´¢é–‹å§‹
            </button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
    };
    
    // Bluetoothãƒ—ãƒªãƒ³ã‚¿ã‚’æ¤œç´¢ï¼ˆå®Ÿéš›ã®æ¤œç´¢å‡¦ç†ï¼‰
    window.startBluetoothSearch = async function() {
      try {
        console.log('Bluetoothãƒ—ãƒªãƒ³ã‚¿ã‚’æ¤œç´¢ä¸­...');
        
        // Web Bluetooth APIã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒã‚¤ã‚¹ã‚’æ¤œç´¢
        const device = await navigator.bluetooth.requestDevice({
          filters: [
            { services: ['000018f0-0000-1000-8000-00805f9b34fb'] }, // ESC/POS Service
          ],
          optionalServices: ['000018f0-0000-1000-8000-00805f9b34fb']
        });
        
        console.log('ãƒ‡ãƒã‚¤ã‚¹ç™ºè¦‹:', device.name);
        
        // ãƒ‡ãƒã‚¤ã‚¹ã«æ¥ç¶š
        const server = await device.gatt.connect();
        console.log('GATTæ¥ç¶šæˆåŠŸ');
        
        // ãƒ—ãƒªãƒ³ã‚¿ã‚µãƒ¼ãƒ“ã‚¹ã‚’å–å¾—
        const service = await server.getPrimaryService('000018f0-0000-1000-8000-00805f9b34fb');
        console.log('ã‚µãƒ¼ãƒ“ã‚¹å–å¾—æˆåŠŸ');
        
        // æ›¸ãè¾¼ã¿ç”¨Characteristicã‚’å–å¾—
        const characteristic = await service.getCharacteristic('00002af1-0000-1000-8000-00805f9b34fb');
        console.log('Characteristicå–å¾—æˆåŠŸ');
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
        BLUETOOTH_DEVICE = device;
        BLUETOOTH_CHARACTERISTIC = characteristic;
        
        // ãƒ‡ãƒã‚¤ã‚¹åã‚’è¡¨ç¤º
        document.getElementById('bluetoothDeviceInfo').style.display = 'block';
        document.getElementById('bluetoothDeviceName').textContent = device.name || 'ä¸æ˜ãªãƒ‡ãƒã‚¤ã‚¹';
        
        // localStorageã«ä¿å­˜
        localStorage.setItem('bluetoothDeviceName', device.name || '');
        
        // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        showCustomAlert('æ¥ç¶šæˆåŠŸ', 'Bluetoothãƒ—ãƒªãƒ³ã‚¿ã«æ¥ç¶šã—ã¾ã—ãŸ\n' + (device.name || 'ä¸æ˜ãªãƒ‡ãƒã‚¤ã‚¹'), 'success');
        
      } catch (error) {
        console.error('Bluetoothæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
        
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if (error.name === 'NotFoundError') {
          showCustomAlert('ãƒ‡ãƒã‚¤ã‚¹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'Bluetoothãƒ—ãƒªãƒ³ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\nãƒ—ãƒªãƒ³ã‚¿ã®é›»æºãŒå…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'error');
        } else if (error.name === 'SecurityError' || error.name === 'NotAllowedError') {
          // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
          console.log('æ¤œç´¢ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ');
        } else {
          showCustomAlert('æ¥ç¶šã‚¨ãƒ©ãƒ¼', 'Bluetoothãƒ—ãƒªãƒ³ã‚¿ã®æ¤œç´¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n\nãƒ–ãƒ©ã‚¦ã‚¶ãŒBluetoothå¯¾å¿œã‹ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆChromeã€Edgeæ¨å¥¨ï¼‰', 'error');
        }
      }
    };
    
    // Bluetoothãƒ—ãƒªãƒ³ã‚¿ã‚’æ¤œç´¢ï¼ˆã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆï¼‰
    window.searchBluetoothPrinter = function() {
      showBluetoothSearchGuide();
    };
    
    // ã‚«ã‚¹ã‚¿ãƒ ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤ºé–¢æ•°
    function showCustomAlert(title, message, type = 'info') {
      const iconMap = {
        success: 'âœ“',
        error: 'âœ•',
        info: 'i'
      };
      
      const colorMap = {
        success: '#4CAF50',
        error: '#f44336',
        info: '#2196F3'
      };
      
      // typeãŒcolorMapã«å­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ç”¨
      const color = colorMap[type] || '#4CAF50';
      const icon = iconMap[type] || type;
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.style.cssText = 'display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;';
      
      modal.innerHTML = `
        <div style="background: white; border-radius: 20px; padding: 40px; max-width: 400px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); text-align: center;">
          <h3 style="font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #333;">${title}</h3>
          <p style="font-size: 16px; color: #666; margin-bottom: 30px; white-space: pre-line;">${message}</p>
          <button onclick="this.closest('.modal-overlay').remove()" style="padding: 15px 40px; font-size: 16px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: ${color}; color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.2);">
            OK
          </button>
        </div>
      `;
      
      document.body.appendChild(modal);
    }
    
    // ESC/POSã‚³ãƒãƒ³ãƒ‰ã‚’ç”Ÿæˆã™ã‚‹ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
    function createESCPOSCommand(text) {
      const encoder = new TextEncoder();
      const commands = [];
      
      // åˆæœŸåŒ–
      commands.push(new Uint8Array([0x1B, 0x40]));
      
      // ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ 
      commands.push(encoder.encode(text));
      
      // æ”¹è¡Œ + ã‚«ãƒƒãƒˆ
      commands.push(new Uint8Array([0x0A, 0x0A, 0x0A]));
      commands.push(new Uint8Array([0x1D, 0x56, 0x00])); // ã‚«ãƒƒãƒˆ
      
      // ã™ã¹ã¦ã®ã‚³ãƒãƒ³ãƒ‰ã‚’çµåˆ
      const totalLength = commands.reduce((sum, cmd) => sum + cmd.length, 0);
      const result = new Uint8Array(totalLength);
      let offset = 0;
      for (const cmd of commands) {
        result.set(cmd, offset);
        offset += cmd.length;
      }
      
      return result;
    }
    
    // Bluetoothå°åˆ·é–¢æ•°
    async function printViaBluetooth(text) {
      if (!BLUETOOTH_CHARACTERISTIC) {
        throw new Error('Bluetoothãƒ—ãƒªãƒ³ã‚¿ãŒæ¥ç¶šã•ã‚Œã¦ã„ã¾ã›ã‚“');
      }
      
      try {
        const command = createESCPOSCommand(text);
        
        // 512ãƒã‚¤ãƒˆãšã¤é€ä¿¡ï¼ˆBluetoothã®åˆ¶é™ï¼‰
        const chunkSize = 512;
        for (let i = 0; i < command.length; i += chunkSize) {
          const chunk = command.slice(i, Math.min(i + chunkSize, command.length));
          await BLUETOOTH_CHARACTERISTIC.writeValue(chunk);
          await new Promise(resolve => setTimeout(resolve, 100)); // å°‘ã—å¾…ã¤
        }
        
        console.log('âœ… Bluetoothå°åˆ·å®Œäº†');
      } catch (error) {
        console.error('âŒ Bluetoothå°åˆ·ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
      }
    }
    
    // ãƒ—ãƒªãƒ³ã‚¿è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showPrinterSettings = function() {
      document.getElementById('printerIPInput').value = PRINTER_IP;
      selectConnectionType(PRINTER_CONNECTION_TYPE);
      
      // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹Bluetoothãƒ‡ãƒã‚¤ã‚¹åã‚’è¡¨ç¤º
      const savedDeviceName = localStorage.getItem('bluetoothDeviceName');
      if (savedDeviceName && PRINTER_CONNECTION_TYPE === 'bluetooth') {
        document.getElementById('bluetoothDeviceInfo').style.display = 'block';
        document.getElementById('bluetoothDeviceName').textContent = savedDeviceName + ' (å†æ¥ç¶šãŒå¿…è¦)';
      }
      
      document.getElementById('printerSettingsModal').style.display = 'flex';
      document.getElementById('printerTestResult').style.display = 'none';
    };
    
    // ãƒ—ãƒªãƒ³ã‚¿è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closePrinterSettings = function() {
      document.getElementById('printerSettingsModal').style.display = 'none';
    };
    
    // ãƒ—ãƒªãƒ³ã‚¿è¨­å®šã‚’ä¿å­˜
    window.savePrinterSettings = function() {
      if (PRINTER_CONNECTION_TYPE === 'ethernet') {
        const newIP = document.getElementById('printerIPInput').value.trim();
        
        // IPã‚¢ãƒ‰ãƒ¬ã‚¹ã®ç°¡æ˜“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        const ipPattern = /^(\d{1,3}\.){3}\d{1,3}$/;
        if (!ipPattern.test(newIP)) {
          alert('æ­£ã—ã„IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„\nä¾‹: 192.168.1.100');
          return;
        }
        
        PRINTER_IP = newIP;
        localStorage.setItem('printerIP', newIP);
        localStorage.setItem('printerConnectionType', 'ethernet');
        
        alert('ãƒ—ãƒªãƒ³ã‚¿è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ\næ¥ç¶šæ–¹å¼: WiFi/LAN\nIP: ' + newIP);
      } else {
        if (!BLUETOOTH_DEVICE) {
          alert('Bluetoothãƒ—ãƒªãƒ³ã‚¿ã‚’æ¤œç´¢ã—ã¦æ¥ç¶šã—ã¦ãã ã•ã„');
          return;
        }
        
        localStorage.setItem('printerConnectionType', 'bluetooth');
        alert('ãƒ—ãƒªãƒ³ã‚¿è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ\næ¥ç¶šæ–¹å¼: Bluetooth\nãƒ‡ãƒã‚¤ã‚¹: ' + (BLUETOOTH_DEVICE.name || 'ä¸æ˜'));
      }
      
      closePrinterSettings();
    };
    
    // ãƒ—ãƒªãƒ³ã‚¿æ¥ç¶šãƒ†ã‚¹ãƒˆ
    window.testPrinterConnection = async function() {
      const resultDiv = document.getElementById('printerTestResult');
      
      resultDiv.style.display = 'block';
      resultDiv.style.background = '#FFF9C4';
      resultDiv.style.color = '#F57F17';
      resultDiv.textContent = 'æ¥ç¶šãƒ†ã‚¹ãƒˆä¸­...';
      
      try {
        if (PRINTER_CONNECTION_TYPE === 'bluetooth') {
          // Bluetoothæ¥ç¶šãƒ†ã‚¹ãƒˆ
          if (!BLUETOOTH_CHARACTERISTIC) {
            resultDiv.style.background = '#FFCDD2';
            resultDiv.style.color = '#C62828';
            resultDiv.innerHTML = 'âŒ Bluetoothãƒ—ãƒªãƒ³ã‚¿ãŒæœªæ¥ç¶š<br>å…ˆã«ãƒ—ãƒªãƒ³ã‚¿ã‚’æ¤œç´¢ã—ã¦ãã ã•ã„';
            return;
          }
          
          await printViaBluetooth('=== æ¥ç¶šãƒ†ã‚¹ãƒˆ ===\nå°åˆ·æˆåŠŸï¼\n\n');
          
          resultDiv.style.background = '#C8E6C9';
          resultDiv.style.color = '#2E7D32';
          resultDiv.innerHTML = 'âœ… æ¥ç¶šæˆåŠŸï¼<br>Bluetoothãƒ—ãƒªãƒ³ã‚¿ã¨é€šä¿¡ã§ãã¾ã—ãŸ';
          
        } else {
          // Ethernetæ¥ç¶šãƒ†ã‚¹ãƒˆ
          const testIP = document.getElementById('printerIPInput').value.trim();
          
          const builder = new StarWebPrintBuilder();
          builder.createInitializationElement();
          builder.createTextElement({data: '=== æ¥ç¶šãƒ†ã‚¹ãƒˆ ===\n'});
          builder.createTextElement({data: 'å°åˆ·æˆåŠŸï¼\n\n'});
          builder.createCutPaperElement({feed: true});
          
          const url = `http://${testIP}/StarWebPRNT/SendMessage`;
          const request = builder.toString();
          
          const trader = new StarWebPrintTrader({url: url});
          
          trader.onReceive = function(response) {
            console.log('âœ… æ¥ç¶šãƒ†ã‚¹ãƒˆæˆåŠŸ:', response);
            resultDiv.style.background = '#C8E6C9';
            resultDiv.style.color = '#2E7D32';
            resultDiv.innerHTML = 'âœ… æ¥ç¶šæˆåŠŸï¼<br>ãƒ—ãƒªãƒ³ã‚¿ã¨é€šä¿¡ã§ãã¾ã—ãŸ';
          };
          
          trader.onError = function(response) {
            console.error('âŒ æ¥ç¶šãƒ†ã‚¹ãƒˆå¤±æ•—:', response);
            resultDiv.style.background = '#FFCDD2';
            resultDiv.style.color = '#C62828';
            resultDiv.innerHTML = `âŒ æ¥ç¶šå¤±æ•—<br>${response.status || 'ãƒ—ãƒªãƒ³ã‚¿ã«æ¥ç¶šã§ãã¾ã›ã‚“'}<br><small>IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„</small>`;
          };
          
          trader.sendMessage({request: request});
        }
        
      } catch (error) {
        console.error('âŒ æ¥ç¶šãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        resultDiv.style.background = '#FFCDD2';
        resultDiv.style.color = '#C62828';
        resultDiv.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼<br>${error.message}`;
      }
    };
    
    // åˆå›èª­ã¿è¾¼ã¿æ™‚ã«è¨­å®šã‚’å¾©å…ƒ
    document.addEventListener('DOMContentLoaded', () => {
      // å³ä¼šè¨ˆãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ï¼ˆğŸ”§ disabledçŠ¶æ…‹ã§ã‚‚ã‚¯ãƒªãƒƒã‚¯æ¤œçŸ¥ã§ãã‚‹ã‚ˆã†ã«æ”¹å–„ï¼‰
      const directPaymentBtn = document.getElementById('directPaymentBtn');
      if (directPaymentBtn) {
        // æ—¢å­˜ã®onclickå±æ€§ã‚’å‰Šé™¤ã—ã¦ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®ã¿ä½¿ç”¨
        directPaymentBtn.removeAttribute('onclick');
        
        directPaymentBtn.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          console.log('ğŸ”” å³ä¼šè¨ˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼çµŒç”±ï¼‰');
          console.log('  disabled:', this.disabled);
          console.log('  pointerEvents:', this.style.pointerEvents);
          console.log('  ã‚«ãƒ¼ãƒˆ:', manualCart.length);
          
          // ğŸ”§ ä¿®æ­£: disabledçŠ¶æ…‹ã§ã‚‚é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã€é–¢æ•°å†…ã§ãƒã‚§ãƒƒã‚¯
          window.directPayment();
        }, true);  // ã‚­ãƒ£ãƒ—ãƒãƒ£ãƒ•ã‚§ãƒ¼ã‚ºã§ç¢ºå®Ÿã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ‹¾ã†
        
        console.log('âœ… å³ä¼šè¨ˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
      }
      
      // è‡ªå‹•å°åˆ·è¨­å®šã‚’å¾©å…ƒ
      const savedAutoPrint = localStorage.getItem('autoPrintEnabled') === 'true';
      autoPrintEnabled = savedAutoPrint;
      if (document.getElementById('autoPrintToggle')) {
        document.getElementById('autoPrintToggle').checked = savedAutoPrint;
        toggleAutoPrint();
      }
      
      // ãƒ—ãƒªãƒ³ã‚¿æ¥ç¶šæ–¹å¼ã‚’å¾©å…ƒ
      const savedConnectionType = localStorage.getItem('printerConnectionType') || 'ethernet';
      PRINTER_CONNECTION_TYPE = savedConnectionType;
      console.log('ğŸ“± ãƒ—ãƒªãƒ³ã‚¿æ¥ç¶šæ–¹å¼:', PRINTER_CONNECTION_TYPE);
      
      // Bluetoothã®å ´åˆã€è‡ªå‹•å†æ¥ç¶šã¯è¡Œã‚ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§æ¥ç¶šã™ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰
      if (PRINTER_CONNECTION_TYPE === 'bluetooth') {
        console.log('â„¹ï¸ Bluetoothæ¥ç¶šãƒ¢ãƒ¼ãƒ‰ã§ã™ã€‚ãƒ—ãƒªãƒ³ã‚¿è¨­å®šã‹ã‚‰æ¥ç¶šã—ã¦ãã ã•ã„ã€‚');
      }
    });
    
    // inventory_settingsã®å¤‰æ›´ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
    function watchInventoryChanges() {
      let inventorySettingsRef;
      if (!window.currentStoreId || window.currentStoreId === null || window.currentStoreId === '') {
        inventorySettingsRef = window.doc(window.db, 'inventory_settings', 'default');
      } else {
        inventorySettingsRef = window.doc(window.db, 'stores', window.currentStoreId, 'inventory_settings', 'default');
      }
      
      const unsubscribe = window.onSnapshot(inventorySettingsRef, (doc) => {
        if (doc.exists()) {
          console.log('ğŸ“¦ åœ¨åº«ãƒ‡ãƒ¼ã‚¿ãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸ');
          updateInventoryPanel();
        }
      });
      
      return unsubscribe;
    }
    
    // ========================================
    // æ–°UIåˆ¶å¾¡é–¢æ•°
    // ========================================
    
    let currentSelectedTableId = null;
    let currentSelectedTableName = null;
    let newUICart = [];
    
    // æ–°UIãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadNewTablesList() {
      try {
        const container = document.getElementById('newTablesGrid');
        if (!container) return;
        
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">èª­ã¿è¾¼ã¿ä¸­...</div>';
        
        const tablesSnapshot = await window.getDocs(window.getStoreCollection('tables'));
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const tables = [];
        tablesSnapshot.forEach(doc => {
          tables.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        // orderãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã‚½ãƒ¼ãƒˆ
        tables.sort((a, b) => {
          const orderA = a.order || 0;
          const orderB = b.order || 0;
          if (orderA !== orderB) {
            return orderA - orderB;
          }
          return a.name.localeCompare(b.name);
        });
        
        if (tables.length === 0) {
          container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">ãƒ†ãƒ¼ãƒ–ãƒ«ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“<br>è¨­å®šãƒ»ç®¡ç†ç”»é¢ã‹ã‚‰ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ ã—ã¦ãã ã•ã„</div>';
          return;
        }
        
        container.innerHTML = '';
        
        // å³ä¼šè¨ˆã‚«ãƒ¼ãƒ‰ã‚’æœ€åˆã«è¿½åŠ 
        const quickCheckoutCard = document.createElement('div');
        quickCheckoutCard.className = 'table-card';
        quickCheckoutCard.setAttribute('data-table-name', 'å³ä¼šè¨ˆ');
        quickCheckoutCard.setAttribute('data-table-id', 'quick-checkout');
        quickCheckoutCard.style.cssText = 'background: white; cursor: pointer; border: 2px solid #00BCD4;';
        quickCheckoutCard.onclick = () => {
          window.quickCheckout();
        };
        quickCheckoutCard.innerHTML = `
          <div class="table-name" style="color: #00BCD4; font-size: 18px;">å³ä¼šè¨ˆ</div>
          <div class="table-order-count">ç©ºå¸­</div>
        `;
        container.appendChild(quickCheckoutCard);
        
        tables.forEach(table => {
          // å³ä¼šè¨ˆãƒ†ãƒ¼ãƒ–ãƒ«ã¯ã‚¹ã‚­ãƒƒãƒ—
          if (table.name === 'å³ä¼šè¨ˆ') {
            return;
          }
          
          const card = document.createElement('div');
          card.className = 'table-card';
          card.setAttribute('data-table-name', table.name);
          card.setAttribute('data-table-id', table.id);
          card.onclick = () => selectNewTable(table.id, table.name, 0);
          
          card.innerHTML = `
            <div class="table-name">${table.name.length > 10 ? table.name.substring(0, 10) : table.name}</div>
            <div class="table-order-count">ç©ºå¸­</div>
          `;
          
          container.appendChild(card);
        });
        
        // æ³¨æ–‡çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆåˆå›ï¼‰
        updateNewTableStatus();
        
      } catch (error) {
        console.error('ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        const container = document.getElementById('newTablesGrid');
        if (container) {
          container.innerHTML = '<div style="text-align: center; color: red; padding: 40px;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ<br><small>' + error.message + '</small></div>';
        }
      }
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ³¨æ–‡çŠ¶æ…‹ã‚’æ›´æ–°ï¼ˆhandyã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    async function updateNewTableStatus() {
      try {
        const ordersSnapshot = await window.getDocs(window.getStoreCollection('orders'));
        
        const unpaidTables = new Set();  // æ³¨æ–‡ã‚ã‚Šï¼ˆæœªä¼šè¨ˆï¼‰
        const hasIncompleteOrders = new Set();  // æœªå®Œäº†ã®æ³¨æ–‡ãŒã‚ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«
        const tableOrderCounts = {};  // ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã®æ³¨æ–‡æ•°
        
        console.log('ğŸ”„ ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°é–‹å§‹');
        
        ordersSnapshot.forEach(doc => {
          const order = doc.data();
          console.log('ğŸ“‹ æ³¨æ–‡ãƒã‚§ãƒƒã‚¯:', {
            id: doc.id,
            tableId: order.tableId,
            tableNumber: order.tableNumber,
            deleted: order.deleted,
            cancelled: !!order.cancelledAt,
            paid: !!order.paidAt,
            completed: !!order.completedAt
          });
          
          if (order.tableNumber && !order.deleted && !order.cancelledAt) {
            // ä¼šè¨ˆæ¸ˆã¿ã§ãªã„æ³¨æ–‡
            if (!order.paidAt) {
              unpaidTables.add(order.tableNumber);
              tableOrderCounts[order.tableNumber] = (tableOrderCounts[order.tableNumber] || 0) + 1;
              
              // æœªå®Œäº†ã®æ³¨æ–‡ãŒã‚ã‚‹
              if (!order.completedAt) {
                hasIncompleteOrders.add(order.tableNumber);
                console.log('ğŸ“ æœªå®Œäº†æ³¨æ–‡ã‚ã‚Š:', order.tableNumber);
              }
            }
          }
        });
        
        console.log('ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é›†è¨ˆ:', {
          æ³¨æ–‡ã‚ã‚Šãƒ†ãƒ¼ãƒ–ãƒ«: Array.from(unpaidTables),
          æœªå®Œäº†æ³¨æ–‡ã‚ã‚Š: Array.from(hasIncompleteOrders),
          æ³¨æ–‡æ•°: tableOrderCounts
        });
        
        // ã™ã¹ã¦ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚«ãƒ¼ãƒ‰ã‚’æ›´æ–°
        document.querySelectorAll('.table-card').forEach(card => {
          const tableName = card.getAttribute('data-table-name');
          
          if (!tableName || tableName === 'å³ä¼šè¨ˆ') return;
          
          // æ—¢å­˜ã®ãƒãƒƒã‚¸ã‚’ã™ã¹ã¦å‰Šé™¤
          card.querySelectorAll('.pending-badge, .status-badge, .unpaid-badge').forEach(badge => badge.remove());
          
          const orderCount = tableOrderCounts[tableName] || 0;
          const orderCountElement = card.querySelector('.table-order-count');
          
          if (unpaidTables.has(tableName)) {
            // æ³¨æ–‡ã‚ã‚Š â†’ èƒŒæ™¯ã‚’ã‚ªãƒ¬ãƒ³ã‚¸ã«ã€ã‚¯ãƒ©ã‚¹è¿½åŠ 
            card.classList.add('has-pending-orders');
            
            // æ³¨æ–‡æ•°ã‚’è¡¨ç¤º
            if (orderCountElement) {
              orderCountElement.textContent = `æ³¨æ–‡ ${orderCount}ä»¶`;
            }
            
            // ã€Œæ³¨æ–‡ã‚ã‚Šã€ãƒãƒƒã‚¸ã‚’è¿½åŠ ï¼ˆæœªå®Œäº†ã®æ³¨æ–‡ãŒã‚ã‚‹å ´åˆã®ã¿ï¼‰
            if (hasIncompleteOrders.has(tableName)) {
              const orderBadge = document.createElement('div');
              orderBadge.className = 'pending-badge';
              orderBadge.textContent = 'æ³¨æ–‡ã‚ã‚Š';
              orderBadge.style.cssText = 'position: absolute; top: 10px; right: 10px; background: #ff9800; color: white; font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: bold;';
              card.appendChild(orderBadge);
              console.log('âœ… æ³¨æ–‡ã‚ã‚Šãƒãƒƒã‚¸è¿½åŠ :', tableName);
            }
            
            // ã€Œæœªä¼šè¨ˆã€ãƒãƒƒã‚¸ã‚’è¿½åŠ ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
            const unpaidBadge = document.createElement('div');
            unpaidBadge.className = 'unpaid-badge';
            unpaidBadge.textContent = 'æœªä¼šè¨ˆ';
            unpaidBadge.style.cssText = 'position: absolute; top: 10px; left: 10px; background: #f57c00; color: white; font-size: 10px; padding: 4px 8px; border-radius: 12px; font-weight: bold; animation: pulse 2s infinite;';
            card.appendChild(unpaidBadge);
            console.log('âœ… æœªä¼šè¨ˆãƒãƒƒã‚¸è¿½åŠ :', tableName);
          } else {
            // ç©ºå¸­ â†’ ãƒãƒƒã‚¸ãªã—ã€ã‚¯ãƒ©ã‚¹å‰Šé™¤
            card.classList.remove('has-pending-orders');
            if (orderCountElement) {
              orderCountElement.textContent = 'ç©ºå¸­';
            }
            console.log('â„¹ï¸ ç©ºå¸­:', tableName);
          }
        });
        
      } catch (error) {
        console.error('âŒ ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // æ³¨æ–‡ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚’é–‹å§‹
    let newOrdersListener = null;
    function startNewOrdersListener() {
      if (newOrdersListener) {
        newOrdersListener();  // æ—¢å­˜ã®ãƒªã‚¹ãƒŠãƒ¼ã‚’è§£é™¤
      }
      const ordersRef = window.getStoreCollection('orders');
      newOrdersListener = window.onSnapshot(ordersRef, (snapshot) => {
        console.log('ğŸ”” æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ');
        updateNewTableStatus();
      });
    }

    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠ
    async function selectNewTable(tableId, tableName, orderCount) {
      currentSelectedTableId = tableId;
      currentSelectedTableName = tableName;
      
      // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã‚€ï¼ˆtableNameã§å–å¾—ï¼‰
      currentTableSettings = await getTableSettings(tableName);
      console.log('ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠ - ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šèª­ã¿è¾¼ã¿å®Œäº†:', tableName);
      console.log('  taxRule:', currentTableSettings?.taxRule || 'ãªã—');
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’éè¡¨ç¤ºã€è©³ç´°ã‚’è¡¨ç¤º
      document.getElementById('tablesArea').style.display = 'none';
      document.getElementById('tableDetailArea').classList.add('show');
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«åã¨æ³¨æ–‡æ•°ã‚’è¡¨ç¤º
      document.getElementById('detailTableName').textContent = tableName;
      document.getElementById('detailOrderCount').textContent = `æ³¨æ–‡: ${orderCount}ä»¶`;
      
      // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’è¨­å®š
      const hasOrders = orderCount > 0;
      // disabledå±æ€§ã¯å‰Šé™¤ã—ã€ã‚¹ã‚¿ã‚¤ãƒ«ã®ã¿å¤‰æ›´
      if (!hasOrders) {
        document.getElementById('paymentBtn').style.opacity = '0.5';
        document.getElementById('paymentBtn').style.cursor = 'not-allowed';
      } else {
        document.getElementById('paymentBtn').style.opacity = '1';
        document.getElementById('paymentBtn').style.cursor = 'pointer';
      }
      
      // æ³¨æ–‡ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
      loadTableOrders(tableId);
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ³¨æ–‡ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
    async function loadTableOrders(tableId) {
      try {
        const container = document.getElementById('detailOrdersList');
        container.innerHTML = '<div class="loading">æ³¨æ–‡ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>';
        
        const ordersRef = window.getStoreCollection('orders');
        const snapshot = await window.getDocs(ordersRef);
        
        const orders = [];
        snapshot.forEach(doc => {
          const order = doc.data();
          // ğŸ”¥ ä¿®æ­£: tableId ã¾ãŸã¯ tableNumber ã§ãƒãƒƒãƒï¼ˆmenu.htmlã‹ã‚‰ã®æ³¨æ–‡ã«å¯¾å¿œï¼‰
          const matchesTable = (order.tableId === tableId) || (order.tableNumber === currentSelectedTableName);
          // ğŸ”¥ ä¿®æ­£: å‰Šé™¤æ¸ˆã¿ã®ã¿é™¤å¤–ã€ä¼šè¨ˆæ¸ˆã¿ã¯è¡¨ç¤ºã™ã‚‹
          if (matchesTable && !order.deleted) {
            orders.push({
              id: doc.id,
              ...order
            });
          }
        });
        
        if (orders.length === 0) {
          container.innerHTML = '<div style="text-align: center; color: #999; padding: 40px;">ã¾ã æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }
        
        // æ³¨æ–‡æ—¥æ™‚ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
        orders.sort((a, b) => {
          const timeA = (a.orderedAt || a.timestamp) ? (a.orderedAt || a.timestamp).toDate().getTime() : 0;
          const timeB = (b.orderedAt || b.timestamp) ? (b.orderedAt || b.timestamp).toDate().getTime() : 0;
          return timeB - timeA;
        });
        
        container.innerHTML = '';
        
        orders.forEach((order, index) => {
          const orderCard = document.createElement('div');
          orderCard.className = 'order-card';
          // æœ€å¾Œã®ã‚«ãƒ¼ãƒ‰ã¯åœ¨åº«ãƒ‘ãƒãƒ«ã«è¢«ã‚‰ãªã„ã‚ˆã†å¤§ããªãƒãƒ¼ã‚¸ãƒ³ã‚’è¿½åŠ 
          const isLastCard = index === orders.length - 1;
          const marginBottom = isLastCard ? '180px' : '15px';
          orderCard.style.cssText = `background: white; border-radius: 12px; padding: 15px; margin-bottom: ${marginBottom}; box-shadow: 0 2px 10px rgba(0,0,0,0.1); border-left: 5px solid #667eea;`;
          
          const items = order.items || [];
          const itemsHTML = items.map(item => {
            const basePrice = item.price * (item.quantity || 1);
            const toppingPrice = (item.toppingPrice || 0) * (item.quantity || 1);
            const itemTotal = basePrice + toppingPrice;
            
            let html = `
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; flex-direction: column;">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <span style="flex: 1; font-weight: 500;">${item.name}</span>
                <span style="width: 60px; text-align: center;">Ã—${item.quantity || 1}</span>
                <span style="width: 100px; text-align: right; font-weight: bold;">Â¥${basePrice.toLocaleString()}</span>
              </div>`;
            
            // ãƒˆãƒƒãƒ”ãƒ³ã‚°æƒ…å ±ã‚’è¡¨ç¤º
            let toppingsHtml = '';
            if (item.toppingDetails && Array.isArray(item.toppingDetails) && item.toppingDetails.length > 0) {
              // æ–°å½¢å¼: toppingDetailsãŒã‚ã‚‹å ´åˆï¼ˆã‚»ãƒƒãƒˆåã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼‰
              const groupedBySet = {};
              item.toppingDetails.forEach(detail => {
                const setName = detail.setName || 'ãƒˆãƒƒãƒ”ãƒ³ã‚°';
                if (!groupedBySet[setName]) {
                  groupedBySet[setName] = [];
                }
                groupedBySet[setName].push(detail.optionName);
              });
              
              toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
                return `
                  <div style="font-size: 11px; color: #666; font-weight: bold; padding-left: 10px; margin-top: 3px;">${setName}</div>
                  ${options.map(opt => `<div style="font-size: 11px; color: #666; padding-left: 20px;">ã€€ãƒ»${opt}</div>`).join('')}
                `;
              }).join('');
            } else if (item.toppingsData && Array.isArray(item.toppingsData) && item.toppingsData.length > 0) {
              // menu.htmlã‹ã‚‰ã®å½¢å¼: toppingsDataãŒã‚ã‚‹å ´åˆ
              const groupedBySet = {};
              item.toppingsData.forEach(topping => {
                const setName = topping.setName || 'ãƒˆãƒƒãƒ”ãƒ³ã‚°';
                if (!groupedBySet[setName]) {
                  groupedBySet[setName] = [];
                }
                groupedBySet[setName].push({
                  name: topping.name,
                  price: topping.price || 0
                });
              });
              
              toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
                return `
                  <div style="font-size: 11px; color: #666; font-weight: bold; padding-left: 10px; margin-top: 3px;">${setName}</div>
                  ${options.map(opt => `<div style="display: flex; justify-content: space-between; font-size: 11px; color: #666; padding-left: 20px;"><span>ã€€ãƒ»${opt.name}</span>${opt.price > 0 ? `<span>+Â¥${opt.price}</span>` : ''}</div>`).join('')}
                `;
              }).join('');
            } else if (item.toppingName && item.toppingPrice) {
              // å¤ã„å½¢å¼: toppingNameã®ã¿ã®å ´åˆ
              toppingsHtml = `
              <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 4px; padding-left: 10px; font-size: 13px; color: #666;">
                <span style="flex: 1;">â”” ${item.toppingName}</span>
                <span style="width: 160px; text-align: right;">+Â¥${toppingPrice.toLocaleString()}</span>
              </div>`;
            }
            
            html += toppingsHtml;
            
            // ãƒˆãƒƒãƒ”ãƒ³ã‚°ä¾¡æ ¼ãŒã‚ã‚‹å ´åˆã¯åˆè¨ˆè¡Œã‚’è¡¨ç¤º
            if (toppingPrice > 0) {
              html += `
              <div style="display: flex; justify-content: space-between; margin-top: 4px; padding: 5px 10px; background: #f0f8ff; border-radius: 4px;">
                <span style="font-size: 12px; color: #2196F3; font-weight: bold;">ãƒˆãƒƒãƒ”ãƒ³ã‚°å°è¨ˆ</span>
                <span style="font-size: 12px; color: #2196F3; font-weight: bold;">+Â¥${toppingPrice.toLocaleString()}</span>
              </div>
              <div style="display: flex; justify-content: flex-end; margin-top: 8px; padding-top: 8px; border-top: 1px dashed #ddd;">
                <span style="font-weight: bold; color: #667eea;">å°è¨ˆ: Â¥${itemTotal.toLocaleString()}</span>
              </div>`;
            }
            
            html += '</div>';
            return html;
          }).join('');

          // ğŸ†• ãƒ¬ã‚¸è¢‹æƒ…å ±ã‚’è¿½åŠ 
          let bagHTML = '';
          if (order.bagNeeded && order.bagQuantity > 0) {
            const bagTotal = order.bagPrice || (order.bagQuantity * 3);
            bagHTML = `
            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; background: #fff8e1;">
              <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 0 5px;">
                <span style="flex: 1; font-weight: 500;">ğŸ›ï¸ ãƒ¬ã‚¸è¢‹</span>
                <span style="width: 60px; text-align: center;">Ã—${order.bagQuantity}</span>
                <span style="width: 100px; text-align: right; font-weight: bold;">Â¥${bagTotal.toLocaleString()}</span>
              </div>
            </div>`;
          }
          
          const total = items.reduce((sum, item) => sum + (item.price + (item.toppingPrice || 0)) * (item.quantity || 1), 0) + (order.bagNeeded && order.bagQuantity > 0 ? (order.bagPrice || (order.bagQuantity * 3)) : 0);
          
          // æ³¨æ–‡æ™‚åˆ»ã‚’å–å¾—ï¼ˆorderedAtã¾ãŸã¯timestampãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‹ã‚‰ï¼‰
          const orderTime = (order.orderedAt || order.timestamp) ? 
            (order.orderedAt || order.timestamp).toDate().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }) : 
            '';
          
          // ğŸ†• é¡§å®¢æƒ…å ±ã‚’æ•´å½¢
          let customerInfoHTML = '';
          const hasCustomerInfo = order.customerName || order.customerPhone || order.customerMemo || order.pickupTime || order.customerAddress || order.customerEmail;
          
          if (hasCustomerInfo) {
            const infoItems = [];
            if (order.customerName) infoItems.push(`<div><strong>ãŠåå‰:</strong> ${order.customerName}</div>`);
            if (order.customerPhone) infoItems.push(`<div><strong>é›»è©±ç•ªå·:</strong> ${order.customerPhone}</div>`);
            if (order.customerEmail) infoItems.push(`<div><strong>ãƒ¡ãƒ¼ãƒ«:</strong> ${order.customerEmail}</div>`);
            if (order.pickupTime) infoItems.push(`<div><strong>å¼•å–æ™‚é–“:</strong> ${order.pickupTime}</div>`);
            if (order.customerPostalCode) infoItems.push(`<div><strong>éƒµä¾¿ç•ªå·:</strong> ${order.customerPostalCode}</div>`);
            if (order.customerAddress) infoItems.push(`<div><strong>ä½æ‰€:</strong> ${order.customerAddress}</div>`);
            if (order.customerMemo) infoItems.push(`<div><strong>ãƒ¡ãƒ¢:</strong> ${order.customerMemo}</div>`);
            
            customerInfoHTML = `
            <div style="background: #f0f8ff; padding: 12px; border-radius: 8px; margin-bottom: 15px; font-size: 13px; line-height: 1.6;">
              <div style="font-weight: bold; margin-bottom: 8px; color: #667eea;">ğŸ‘¤ ãŠå®¢æ§˜æƒ…å ±</div>
              ${infoItems.join('')}
            </div>`;
          }
          
          orderCard.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #667eea;">
              <span style="font-weight: bold; font-size: 16px;">æ³¨æ–‡ #${order.orderNumber || 'æœªè¨­å®š'} ${orderTime}</span>
              <div style="display: flex; gap: 8px; align-items: center;">
                ${order.paidAt ? '<span style="background: #2196F3; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">ä¼šè¨ˆæ¸ˆ</span>' : ''}
                <span style="background: ${order.status === 'completed' ? '#4CAF50' : '#FF9800'}; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: bold;">
                  ${order.status === 'completed' ? 'å®Œäº†' : 'æº–å‚™ä¸­'}
                </span>
              </div>
            </div>
            ${customerInfoHTML}
            ${itemsHTML}
            ${bagHTML}
            <div style="margin-top: 15px; padding-top: 15px; border-top: 2px solid #667eea; padding-bottom: 10px;">
              <div style="text-align: right; font-size: 18px; font-weight: bold; color: #667eea; margin-bottom: 10px;">
                åˆè¨ˆ: Â¥${total.toLocaleString()}
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <button onclick="payForSingleOrder('${order.id}', ${total})" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); color: white; border: none; padding: 16px; border-radius: 10px; font-size: 15px; font-weight: bold; cursor: pointer; ${order.paidAt ? 'opacity: 0.5; pointer-events: none;' : ''}">
                  ã“ã®æ³¨æ–‡ã‚’ä¼šè¨ˆ
                </button>
                <button onclick="completeOrderFromNewUI('${order.id}')" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; border: none; padding: 16px; border-radius: 10px; font-size: 15px; font-weight: bold; cursor: pointer;">
                  å®Œäº†
                </button>
                <button onclick="cancelOrderFromNewUI('${order.id}')" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white; border: none; padding: 16px; border-radius: 10px; font-size: 15px; font-weight: bold; cursor: pointer;">
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
                <button onclick="deleteOrderFromNewUI('${order.id}')" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); color: white; border: none; padding: 16px; border-radius: 10px; font-size: 15px; font-weight: bold; cursor: pointer;">
                  å‰Šé™¤
                </button>
              </div>
            </div>
          `;
          
          container.appendChild(orderCard);
        });
        
        // ğŸ”§ ä¿®æ­£: æ³¨æ–‡ã‚«ã‚¦ãƒ³ãƒˆã‚’æ›´æ–°ï¼ˆä¼šè¨ˆæ¸ˆã¿ã‚’é™¤ãï¼‰
        const unpaidCount = orders.filter(order => !order.paidAt).length;
        document.getElementById('detailOrderCount').textContent = `æ³¨æ–‡: ${unpaidCount}ä»¶`;
        console.log('ğŸ“Š æ³¨æ–‡ã‚«ã‚¦ãƒ³ãƒˆæ›´æ–°:', unpaidCount);
        
      } catch (error) {
        console.error('æ³¨æ–‡ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById('detailOrdersList').innerHTML = '<div style="text-align: center; color: red; padding: 40px;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ<br><small>' + error.message + '</small></div>';
      }
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã«æˆ»ã‚‹
    function backToTablesList() {
      document.getElementById('tablesArea').style.display = 'block';
      document.getElementById('tableDetailArea').classList.remove('show');
      currentSelectedTableId = null;
      currentSelectedTableName = null;
      loadNewTablesList(); // å†èª­ã¿è¾¼ã¿
    }
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼iframeã‚’è¡¨ç¤º
    function showMenuIframe() {
      if (!currentSelectedTableId) return;
      
      const container = document.getElementById('menuIframeContainer');
      const iframe = document.getElementById('newMenuIframe');
      
      // iframeã®URLã‚’è¨­å®šï¼ˆæ—¢å­˜ã®menuIframeã¨åŒã˜URLï¼‰
      const oldIframe = document.getElementById('menuIframe');
      if (oldIframe && oldIframe.src) {
        iframe.src = oldIframe.src;
      }
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«åã‚’è¡¨ç¤º
      document.getElementById('iframeTableName').textContent = `${currentSelectedTableName} - ãƒ¡ãƒ‹ãƒ¥ãƒ¼é¸æŠ`;
      
      // ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
      newUICart = [];
      updateIframeCart();
      
      // ã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
      container.classList.add('show');
    }
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼iframeã‚’é–‰ã˜ã‚‹
    function closeMenuIframe() {
      document.getElementById('menuIframeContainer').classList.remove('show');
      newUICart = [];
    }
    
    // iframeå†…ã®ã‚«ãƒ¼ãƒˆè¡¨ç¤ºã‚’æ›´æ–°
    function updateIframeCart() {
      const container = document.getElementById('iframeSelectedItems');
      const submitBtn = document.getElementById('iframeSubmitBtn');
      
      if (newUICart.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.5';
        submitBtn.style.cursor = 'not-allowed';
        document.getElementById('iframeTotal').textContent = 'Â¥0';
        return;
      }
      
      submitBtn.disabled = false;
      submitBtn.style.opacity = '1';
      submitBtn.style.cursor = 'pointer';
      
      let total = 0;
      let html = '';
      
      newUICart.forEach((item, index) => {
        const basePrice = item.price * (item.quantity || 1);
        const itemTotal = (item.price + (item.toppingPrice || 0)) * (item.quantity || 1);
        total += itemTotal;
        
        // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’ç¸¦ã«è¡¨ç¤º
        let toppingsHtml = '';
        if (item.toppingsData && item.toppingsData.length > 0) {
          toppingsHtml = item.toppingsData.map(topping => {
            const toppingSubtotal = (topping.price || 0) * (item.quantity || 1);
            return `
              <div style="font-size: 13px; color: #4CAF50; display: flex; justify-content: space-between; margin-top: 3px;">
                <span>${topping.name}</span>
                <span>Â¥${toppingSubtotal.toLocaleString()}</span>
              </div>
            `;
          }).join('');
        } else if (item.toppingName && item.toppingName !== 'æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°') {
          const toppingSubtotal = (item.toppingPrice || 0) * (item.quantity || 1);
          toppingsHtml = `
            <div style="font-size: 13px; color: #4CAF50; display: flex; justify-content: space-between; margin-top: 3px;">
              <span>${item.toppingName}</span>
              <span>Â¥${toppingSubtotal.toLocaleString()}</span>
            </div>
          `;
        }
        
        html += `
          <div style="background: #f5f5f5; border-radius: 8px; padding: 12px; margin-bottom: 10px;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
              <span style="font-weight: bold; flex: 1;">${item.name}</span>
              <button onclick="removeFromNewCart(${index})" style="background: #f44336; color: white; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 12px;">å‰Šé™¤</button>
            </div>
            <div style="font-size: 13px; color: #666; display: flex; justify-content: space-between; margin-bottom: 4px;">
              <span>${item.name} Ã— ${item.quantity || 1}</span>
              <span>Â¥${basePrice.toLocaleString()}</span>
            </div>
            ${toppingsHtml}
            <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 8px;">
                <button onclick="decreaseNewCartQuantity(${index})" style="background: #ddd; border: none; border-radius: 4px; width: 28px; height: 28px; cursor: pointer; font-weight: bold;">-</button>
                <span style="font-weight: bold; min-width: 30px; text-align: center;">${item.quantity || 1}</span>
                <button onclick="increaseNewCartQuantity(${index})" style="background: #ddd; border: none; border-radius: 4px; width: 28px; height: 28px; cursor: pointer; font-weight: bold;">+</button>
              </div>
              <span style="font-weight: bold; color: #667eea;">åˆè¨ˆ: Â¥${itemTotal.toLocaleString()}</span>
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
      document.getElementById('iframeTotal').textContent = `Â¥${total.toLocaleString()}`;
    }
    
    // ã‚«ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤
    window.removeFromNewCart = function(index) {
      newUICart.splice(index, 1);
      updateIframeCart();
    };
    
    // æ•°é‡ã‚’å¢—ã‚„ã™
    window.increaseNewCartQuantity = function(index) {
      newUICart[index].quantity = (newUICart[index].quantity || 1) + 1;
      updateIframeCart();
    };
    
    // æ•°é‡ã‚’æ¸›ã‚‰ã™
    window.decreaseNewCartQuantity = function(index) {
      if ((newUICart[index].quantity || 1) > 1) {
        newUICart[index].quantity -= 1;
        updateIframeCart();
      }
    };
    
    // iframeæ³¨æ–‡ã‚’é€ä¿¡
    async function submitIframeOrder() {
      if (newUICart.length === 0) {
        alert('å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      // ğŸ”¥ ãƒ†ãƒ¼ãƒ–ãƒ«æœªé¸æŠã®å ´åˆã¯ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠã‚’ä¿ƒã™
      if (!currentSelectedTableId) {
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„');
        closeMenuIframe();
        return;
      }
      
      try {
        const submitBtn = document.getElementById('iframeSubmitBtn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'æ³¨æ–‡ç¢ºå®š';
        
        // ğŸ†• æ³¨æ–‡ç•ªå·ã‚’ç”Ÿæˆ
        const now = new Date();
        const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        
        const todayStart = new Date(jstNow);
        todayStart.setHours(1, 0, 0, 0);
        if (jstNow < todayStart) {
          todayStart.setDate(todayStart.getDate() - 1);
        }
        
        const ordersSnapshot = await window.getDocs(window.getStoreCollection('orders'));
        let maxOrderNumber = 618;
        let hasActiveOrders = false;
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          
          if (!data.deleted) {
            hasActiveOrders = true;
            
            const orderDate = data.timestamp && data.timestamp.toDate ? data.timestamp.toDate() : new Date(data.timestamp || Date.now());
            const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
            
            if (jstOrderDate >= todayStart && data.orderNumber > maxOrderNumber) {
              maxOrderNumber = data.orderNumber;
            }
          }
        });
        
        const orderNumber = hasActiveOrders ? (maxOrderNumber + 1) : 619;
        
        console.log('ğŸ†• æ–°UIæ³¨æ–‡ç•ªå·ç”Ÿæˆ:', {
          hasActiveOrders,
          maxOrderNumber,
          nextOrderNumber: orderNumber
        });
        
        // ğŸ†• åˆè¨ˆé‡‘é¡ã‚’è¨ˆç®—
        let totalAmount = 0;
        newUICart.forEach(item => {
          let itemPrice = item.price || 0;
          // å¤–ç¨ã®å ´åˆã¯ç¨è¾¼ä¾¡æ ¼ã‚’è¨ˆç®—
          if (item.taxType === 'exclusive') {
            const taxRate = item.taxRate || 10;
            itemPrice = Math.floor(itemPrice * (1 + taxRate / 100));
          }
          totalAmount += (itemPrice + (item.toppingPrice || 0)) * (item.quantity || 1);
        });
        
        const deleteAt = new Date(now.getTime() + 10 * 60 * 1000);
        
        // Firestoreã«æ³¨æ–‡ã‚’è¿½åŠ 
        await window.addDoc(window.getStoreCollection('orders'), {
          orderNumber: orderNumber,  // ğŸ†• æ³¨æ–‡ç•ªå·ã‚’è¿½åŠ 
          tableNumber: currentSelectedTableName,  // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã‚’è¿½åŠ 
          tableId: currentSelectedTableId,
          tableName: currentSelectedTableName,
          items: newUICart,
          totalAmount: totalAmount,  // ğŸ†• åˆè¨ˆé‡‘é¡ã‚’è¿½åŠ 
          timestamp: window.Timestamp.now(),  // ğŸ†• ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã‚’è¿½åŠ 
          deleteAt: window.Timestamp.fromDate(deleteAt),  // ğŸ†• å‰Šé™¤äºˆå®šæ™‚åˆ»ã‚’è¿½åŠ 
          orderedAt: window.Timestamp.now(),
          status: 'pending',
          deleted: false,
          cancelledAt: null,  // ğŸ†• ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚åˆ»ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
          completedAt: null,  // ğŸ†• å®Œäº†æ™‚åˆ»ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
          paidAt: null,  // ğŸ†• ä¼šè¨ˆæ™‚åˆ»ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
          staff: document.getElementById('sidebarStaffSelect').value || 'æœªè¨­å®š',
          manualEntry: true  // ğŸ†• æ‰‹å‹•å…¥åŠ›ãƒ•ãƒ©ã‚°ã‚’è¿½åŠ 
        });
        
        console.log('âœ… æ–°UIæ³¨æ–‡ä½œæˆå®Œäº†:', {
          orderNumber,
          tableNumber: currentSelectedTableName,
          tableId: currentSelectedTableId,
          totalAmount,
          itemCount: newUICart.length
        });
        
        // ã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
        newUICart = [];
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼iframeã‚’é–‰ã˜ã‚‹
        closeMenuIframe();
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°ã‚’å†èª­ã¿è¾¼ã¿
        const ordersSnapshot2 = await window.getDocs(
          window.query(
            window.getStoreCollection('orders'),
            window.where('tableId', '==', currentSelectedTableId),
            window.where('deleted', '==', false)
          )
        );
        
        let orderCount = 0;
        ordersSnapshot2.forEach(doc => {
          if (!doc.data().paidAt) orderCount++;
        });
        
        document.getElementById('detailOrderCount').textContent = `æ³¨æ–‡: ${orderCount}ä»¶`;
        document.getElementById('paymentBtn').disabled = false;
        document.getElementById('paymentBtn').style.opacity = '1';
        document.getElementById('paymentBtn').style.cursor = 'pointer';
        
        loadTableOrders(currentSelectedTableId);
        
        alert('æ³¨æ–‡ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        
      } catch (error) {
        console.error('æ³¨æ–‡è¿½åŠ ã‚¨ãƒ©ãƒ¼:', error);
        alert('æ³¨æ–‡ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        const submitBtn = document.getElementById('iframeSubmitBtn');
        submitBtn.disabled = false;
        submitBtn.textContent = 'æ³¨æ–‡ã‚’è¿½åŠ ';
      }
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ä¼šè¨ˆç”»é¢ã‚’è¡¨ç¤º
    async function showPaymentFromTable() {
      console.log('ğŸ”” showPaymentFromTableå‘¼ã³å‡ºã— - currentSelectedTableId:', currentSelectedTableId);
      if (!currentSelectedTableId) {
        console.error('âŒ currentSelectedTableIdãŒæœªè¨­å®š');
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      
      try {
        // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã‚€ï¼ˆtableNameã§å–å¾—ï¼‰
        currentTableSettings = await getTableSettings(currentSelectedTableName);
        console.log('ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«å…¨æ³¨æ–‡ä¼šè¨ˆ - ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šèª­ã¿è¾¼ã¿:', currentSelectedTableName);
        console.log('  taxRule:', currentTableSettings?.taxRule || 'ãªã—');
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«IDã§æ³¨æ–‡ã‚’æ¤œç´¢
        const ordersRef = window.getStoreCollection('orders');
        const snapshot = await window.getDocs(ordersRef);
        
        const orders = [];
        let totalAmount = 0;
        
        snapshot.forEach(doc => {
          const order = doc.data();
          // ğŸ”¥ ä¿®æ­£: tableId ã¾ãŸã¯ tableNumber ã§ãƒãƒƒãƒ
          const matchesTable = (order.tableId === currentSelectedTableId) || (order.tableNumber === currentSelectedTableName);
          // ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã®æœªæ‰•ã„ãƒ»æœªå‰Šé™¤ã®æ³¨æ–‡ã®ã¿ã‚’é›†è¨ˆ
          if (matchesTable && !order.deleted && !order.paidAt && !order.cancelledAt) {
            orders.push({
              id: doc.id,
              ...order
            });
            totalAmount += order.totalAmount || 0;
          }
        });
        
        if (orders.length === 0) {
          alert('ä¼šè¨ˆã™ã‚‹æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“');
          return;
        }
        
        // å…¨æ³¨æ–‡ã‚’é¸æŠã—ã¦ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        currentOrders = orders;
        selectedTable = currentSelectedTableId;
        totalAmountToPay = totalAmount;
        
        // å€¤å¼•ãé‡‘é¡ã‚’åˆæœŸåŒ–
        document.getElementById('discountAmount').value = '0';
        
        // ç¨ç‡é¸æŠãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
        buildTaxRateSelectionList();
        
        // è«‹æ±‚é¡ã‚’è¡¨ç¤º
        updatePaymentTotal();
        
        document.getElementById('paymentModal').classList.remove('hidden');
        selectedPaymentMethod = null;
        document.querySelectorAll('.payment-method-btn').forEach(btn => {
          btn.classList.remove('selected');
        });
        document.getElementById('cashInputSection').classList.add('hidden');
        document.getElementById('completePaymentBtn').disabled = true;
        
      } catch (error) {
        console.error('ä¼šè¨ˆå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¼šè¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }
    
    // å˜ä¸€æ³¨æ–‡ã®ä¼šè¨ˆï¼ˆæ–°UIç”¨ï¼‰
    window.payForSingleOrder = async function(orderId, amount) {
      try {
        // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const orderRef = window.getStoreDoc('orders', orderId);
        const orderSnap = await window.getDoc(orderRef);
        
        if (!orderSnap.exists()) {
          alert('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        const orderData = orderSnap.data();
        const order = {
          id: orderId,
          ...orderData
        };
        
        // å˜ä¸€æ³¨æ–‡ã‚’é¸æŠã—ã¦ä¼šè¨ˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        currentOrders = [order];
        selectedTable = orderData.tableId || currentSelectedTableId;
        totalAmountToPay = amount;
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã‚€ï¼ˆtableNumberã¾ãŸã¯tableNameã§å–å¾—ï¼‰
        const tableNameForSettings = orderData.tableNumber || currentSelectedTableName;
        currentTableSettings = await getTableSettings(tableNameForSettings);
        console.log('ğŸ“‹ å˜ä¸€æ³¨æ–‡ä¼šè¨ˆ - ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š:', tableNameForSettings, currentTableSettings);
        
        // å€¤å¼•ãé‡‘é¡ã‚’åˆæœŸåŒ–
        document.getElementById('discountAmount').value = '0';
        
        // ç¨ç‡é¸æŠãƒªã‚¹ãƒˆã‚’ç”Ÿæˆ
        buildTaxRateSelectionList();
        
        // è«‹æ±‚é¡ã‚’è¡¨ç¤º
        updatePaymentTotal();
        
        document.getElementById('paymentModal').classList.remove('hidden');
        selectedPaymentMethod = null;
        document.querySelectorAll('.payment-method-btn').forEach(btn => {
          btn.classList.remove('selected');
        });
        document.getElementById('cashInputSection').classList.add('hidden');
        document.getElementById('completePaymentBtn').disabled = true;
      } catch (error) {
        console.error('ä¼šè¨ˆå‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¼šè¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };
    
    // æ³¨æ–‡ã‚’å®Œäº†ã«ã™ã‚‹ï¼ˆæ–°UIç”¨ï¼‰
    window.completeOrderFromNewUI = async function(orderId) {
      try {
        await window.updateDoc(window.getStoreDoc('orders', orderId), {
          status: 'completed',
          completedAt: window.Timestamp.now()
        });
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°ã‚’å†èª­ã¿è¾¼ã¿
        await loadTableOrders(currentSelectedTableId);
        loadNewTablesList();
      } catch (error) {
        console.error('å®Œäº†ã‚¨ãƒ©ãƒ¼:', error);
        alert('å®Œäº†å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };
    
    // æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹ï¼ˆæ–°UIç”¨ï¼‰
    window.cancelOrderFromNewUI = async function(orderId) {
      try {
        await window.updateDoc(window.getStoreDoc('orders', orderId), {
          cancelledAt: window.Timestamp.now()
        });
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°ã‚’å†èª­ã¿è¾¼ã¿
        await loadTableOrders(currentSelectedTableId);
        loadNewTablesList();
      } catch (error) {
        console.error('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚¨ãƒ©ãƒ¼:', error);
        alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };
    
    // æ³¨æ–‡ã‚’å‰Šé™¤ã™ã‚‹ï¼ˆæ–°UIç”¨ï¼‰
    window.deleteOrderFromNewUI = async function(orderId) {
      try {
        await window.updateDoc(window.getStoreDoc('orders', orderId), {
          deleted: true,
          deletedAt: window.Timestamp.now()
        });
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«è©³ç´°ã‚’å†èª­ã¿è¾¼ã¿
        await loadTableOrders(currentSelectedTableId);
        loadNewTablesList();
      } catch (error) {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        alert('å‰Šé™¤å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    };
    
    // å£²ä¸Šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é–‹é–‰
    function toggleSalesMenu() {
      const menu = document.getElementById('salesSubMenu');
      const btn = document.getElementById('salesMenuBtn');
      if (menu.style.display === 'none') {
        menu.style.display = 'block';
        btn.style.background = 'linear-gradient(135deg, #5a67d8 0%, #6b5b95 100%)';
      } else {
        menu.style.display = 'none';
        btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      }
    }
    
    // è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®é–‹é–‰
    function toggleSettingsMenu() {
      const menu = document.getElementById('settingsSubMenu');
      const btn = document.getElementById('settingsMenuBtn');
      if (menu.style.display === 'none') {
        menu.style.display = 'block';
        btn.style.background = 'linear-gradient(135deg, #5a67d8 0%, #6b5b95 100%)';
      } else {
        menu.style.display = 'none';
        btn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
      }
    }
    
    // æ–°UIã®åˆæœŸåŒ–
    function initNewUI() {
      console.log('ğŸ†• æ–°UIåˆæœŸåŒ–é–‹å§‹');
      
      // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®æ‹…å½“è€…é¸æŠã‚’æ—¢å­˜ã®staffSelectã¨åŒæœŸ
      const syncStaffSelects = () => {
        const oldStaffSelect = document.getElementById('staffSelect');
        const newStaffSelect = document.getElementById('sidebarStaffSelect');
        
        if (oldStaffSelect && newStaffSelect) {
          // æ—¢å­˜ã®é¸æŠè‚¢ã‚’ã‚³ãƒ”ãƒ¼
          newStaffSelect.innerHTML = oldStaffSelect.innerHTML;
          
          // å¤‰æ›´ã‚’åŒæœŸ
          newStaffSelect.addEventListener('change', function() {
            oldStaffSelect.value = this.value;
          });
          oldStaffSelect.addEventListener('change', function() {
            newStaffSelect.value = this.value;
          });
          
          console.log('âœ… æ‹…å½“è€…é¸æŠã‚’åŒæœŸã—ã¾ã—ãŸ');
        }
      };
      
      // å°‘ã—å¾…ã£ã¦ã‹ã‚‰åŒæœŸï¼ˆloadStaffListã®å®Œäº†ã‚’å¾…ã¤ï¼‰
      setTimeout(syncStaffSelects, 500);
      setTimeout(syncStaffSelects, 1500);
      setTimeout(syncStaffSelects, 3000);
      
      // å–¶æ¥­æ—¥è¡¨ç¤ºã‚’åŒæœŸ
      const oldDateText = document.getElementById('businessDateText');
      const newDateText = document.getElementById('sidebarBusinessDateText');
      
      if (oldDateText && newDateText) {
        const observer = new MutationObserver(() => {
          newDateText.innerHTML = oldDateText.innerHTML;
        });
        observer.observe(oldDateText, { childList: true, subtree: true });
        newDateText.innerHTML = oldDateText.innerHTML;
      }
      
      // è‡ªå‹•å°åˆ·ãƒˆã‚°ãƒ«ã‚’åŒæœŸ
      const oldToggle = document.getElementById('autoPrintToggle');
      const newToggle = document.getElementById('newAutoPrintToggle');
      
      if (oldToggle && newToggle) {
        newToggle.checked = oldToggle.checked;
        newToggle.addEventListener('change', function() {
          oldToggle.checked = this.checked;
          oldToggle.dispatchEvent(new Event('change'));
        });
      }
      
      // å¾…ã¡äººæ•°ã‚’åŒæœŸ
      const oldCount = document.getElementById('manual-count');
      const newCount = document.getElementById('newManualCount');
      
      if (oldCount && newCount) {
        const countObserver = new MutationObserver(() => {
          newCount.textContent = oldCount.textContent;
        });
        countObserver.observe(oldCount, { childList: true, subtree: true });
        newCount.textContent = oldCount.textContent;
      }
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿
      loadNewTablesList();
      
      // æ³¨æ–‡ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚’é–‹å§‹
      startNewOrdersListener();
      
      // å®šæœŸçš„ã«ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§ã‚’æ›´æ–°ï¼ˆ30ç§’ã”ã¨ï¼‰
      setInterval(() => {
        if (!document.getElementById('menuIframeContainer').classList.contains('show')) {
          loadNewTablesList();
        }
      }, 30000);
    }
    
    // iframeå†…ã‹ã‚‰ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å—ä¿¡ï¼ˆå•†å“è¿½åŠ ï¼‰- ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¸€åº¦ã ã‘ç™»éŒ²
    let messageListenerRegistered = false;
    if (!messageListenerRegistered) {
      window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'addToCart') {
          const item = event.data.item;
          console.log('ğŸ“¨ æ–°UI: iframeã‹ã‚‰å•†å“è¿½åŠ :', item);
          console.log('ğŸ“Š å—ã‘å–ã£ãŸæ•°é‡:', item.quantity);
          
          // åŒã˜å•†å“ãŒã‚ã‚Œã°æ•°é‡ã‚’å¢—ã‚„ã™ã€ãªã‘ã‚Œã°æ–°è¦è¿½åŠ 
          const existingIndex = newUICart.findIndex(cartItem => 
            cartItem.name === item.name && 
            (cartItem.toppingName || '') === (item.toppingName || '')
          );
          
          if (existingIndex >= 0) {
            console.log('ğŸ”„ æ—¢å­˜å•†å“ã‚’ç™ºè¦‹');
            console.log('ğŸ“Š æ—¢å­˜ã®æ•°é‡:', newUICart[existingIndex].quantity);
            newUICart[existingIndex].quantity = (newUICart[existingIndex].quantity || 0) + (item.quantity || 1);
            console.log('ğŸ“Š æ–°ã—ã„æ•°é‡:', newUICart[existingIndex].quantity);
          } else {
            console.log('ğŸ†• æ–°è¦å•†å“ã‚’è¿½åŠ ');
            newUICart.push({
              ...item,
              quantity: item.quantity || 1
            });
            console.log('ğŸ“Š è¿½åŠ ã—ãŸæ•°é‡:', item.quantity || 1);
          }
          
          updateIframeCart();
        }
      });
      messageListenerRegistered = true;
      console.log('âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²ã—ã¾ã—ãŸ');
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ–°UIã‚’åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(initNewUI, 1000);
    });
    
  </script>
  
  <!-- çµŒè²»å‡ºåŠ›ã®å¹´æœˆé¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="expenseExportModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="background: white; border-radius: 20px; padding: 40px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <div style="font-size: 64px; text-align: center; margin-bottom: 20px;">ğŸ“Š</div>
      <h3 style="font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 15px; color: #333;">çµŒè²»å‡ºåŠ›</h3>
      <p style="text-align: center; font-size: 16px; color: #666; margin-bottom: 20px;">å‡ºåŠ›ã™ã‚‹å¹´æœˆã‚’é¸æŠã—ã¦ãã ã•ã„</p>
      <div style="margin: 20px 0;">
        <div style="display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;">
          <select id="expenseExportYear" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 16px;">
            <!-- å¹´ã®é¸æŠè‚¢ -->
          </select>
          <select id="expenseExportMonth" style="padding: 10px; border-radius: 8px; border: 2px solid #667eea; font-size: 16px;">
            <option value="1">1æœˆ</option>
            <option value="2">2æœˆ</option>
            <option value="3">3æœˆ</option>
            <option value="4">4æœˆ</option>
            <option value="5">5æœˆ</option>
            <option value="6">6æœˆ</option>
            <option value="7">7æœˆ</option>
            <option value="8">8æœˆ</option>
            <option value="9">9æœˆ</option>
            <option value="10">10æœˆ</option>
            <option value="11">11æœˆ</option>
            <option value="12">12æœˆ</option>
          </select>
        </div>
      </div>
      <div style="display: flex; gap: 15px; margin-top: 30px;">
        <button onclick="closeExpenseExportModal()" style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: #e0e0e0; color: #666;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button onclick="confirmExpenseExport()" style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); color: white;">å‡ºåŠ›</button>
      </div>
    </div>
  </div>
  
  <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åœ¨åº«ãƒ‘ãƒãƒ« -->
  <div id="inventoryPanel" style="position: fixed; bottom: 80px; right: 20px; width: 300px; max-height: 350px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.15); z-index: 9999; overflow: hidden; transition: all 0.3s ease;">
    <div id="inventoryPanelBar" onclick="toggleInventoryPanel()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 12px 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.3s ease;">
      <div style="font-weight: bold; color: white; font-size: 15px;">ğŸ“¦ åœ¨åº«çŠ¶æ³</div>
      <div id="inventoryPanelArrow" style="color: white; font-size: 18px;">â–¼</div>
    </div>
    <div id="inventoryPanelContent" style="max-height: 300px; overflow-y: auto; padding: 10px;">
      <div style="padding: 10px; text-align: center; color: #999;">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
  </div>
  
  <!-- ãƒ—ãƒªãƒ³ã‚¿è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="printerSettingsModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
      <h3 style="font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 15px; color: #333;">ãƒ—ãƒªãƒ³ã‚¿è¨­å®š</h3>
      <p style="text-align: center; font-size: 16px; color: #666; margin-bottom: 30px;">TSP650II / mC-Print3 / Bluetoothå¯¾å¿œ</p>
      
      <!-- æ¥ç¶šæ–¹å¼é¸æŠ -->
      <div style="margin-bottom: 25px;">
        <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">æ¥ç¶šæ–¹å¼</label>
        <div style="display: flex; gap: 10px;">
          <button id="connectionTypeEthernet" onclick="selectConnectionType('ethernet')" 
                  style="flex: 1; padding: 15px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
            WiFi / LAN
          </button>
          <button id="connectionTypeBluetooth" onclick="selectConnectionType('bluetooth')" 
                  style="flex: 1; padding: 15px; border: 2px solid #ddd; background: white; color: #666; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">
            Bluetooth
          </button>
        </div>
      </div>
      
      <!-- Ethernetè¨­å®š -->
      <div id="ethernetSettings" style="display: block;">
        <div style="margin-bottom: 25px;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">ãƒ—ãƒªãƒ³ã‚¿IPã‚¢ãƒ‰ãƒ¬ã‚¹</label>
          <input type="text" id="printerIPInput" placeholder="ä¾‹: 192.168.1.100" 
                 style="width: 100%; padding: 15px; border: 2px solid #667eea; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
          <div style="margin-top: 8px; font-size: 14px; color: #666;">
            ãƒ—ãƒªãƒ³ã‚¿ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„<br>
            <small style="color: #999;">â€»ãƒ—ãƒªãƒ³ã‚¿ã®è¨­å®šå°åˆ·ã§ç¢ºèªã§ãã¾ã™</small>
          </div>
        </div>
      </div>
      
      <!-- Bluetoothè¨­å®š -->
      <div id="bluetoothSettings" style="display: none;">
        <div style="margin-bottom: 25px;">
          <label style="display: block; font-weight: bold; margin-bottom: 10px; color: #333;">Bluetoothãƒ—ãƒªãƒ³ã‚¿</label>
          <button onclick="searchBluetoothPrinter()" 
                  style="width: 100%; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); color: white; box-shadow: 0 4px 15px rgba(33,150,243,0.3);">
            ãƒ—ãƒªãƒ³ã‚¿ã‚’æ¤œç´¢
          </button>
          <div id="bluetoothDeviceInfo" style="margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 8px; display: none;">
            <div style="font-weight: bold; color: #333;">æ¥ç¶šæ¸ˆã¿ãƒ—ãƒªãƒ³ã‚¿:</div>
            <div id="bluetoothDeviceName" style="color: #666; margin-top: 5px;">ãªã—</div>
          </div>
          <div style="margin-top: 8px; font-size: 14px; color: #666;">
            ESC/POSå¯¾å¿œã®Bluetoothãƒ—ãƒªãƒ³ã‚¿ã‚’æ¤œç´¢ã—ã¾ã™<br>
            <small style="color: #999;">â€»Chromeã€Edgeã§åˆ©ç”¨å¯èƒ½</small>
          </div>
        </div>
      </div>
      
      <div style="margin-bottom: 25px;">
        <button onclick="testPrinterConnection()" id="testConnectionBtn"
                style="width: 100%; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; box-shadow: 0 4px 15px rgba(76,175,80,0.3);">
          æ¥ç¶šãƒ†ã‚¹ãƒˆ
        </button>
        <div id="printerTestResult" style="margin-top: 10px; padding: 10px; border-radius: 8px; display: none;"></div>
      </div>
      
      <div style="display: flex; gap: 15px; margin-top: 30px;">
        <button onclick="closePrinterSettings()" 
                style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: #e0e0e0; color: #666;">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button onclick="savePrinterSettings()" 
                style="flex: 1; padding: 18px; font-size: 18px; font-weight: bold; border: none; border-radius: 12px; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
          ä¿å­˜
        </button>
      </div>
    </div>
  </div>
  
</body>
</html>
