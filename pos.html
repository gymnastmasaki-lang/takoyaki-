<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç²‰ã‚‚ã‚“å±‹ å…« - ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒªãƒ¢ã‚³ãƒ³æ–¹å¼ï¼‰</title>
  
  <!-- Star mC-Print3 SDK -->
  <script src="https://www.star-m.jp/products/s_print/sdk/starwebprinttracer/v1.1.0/StarWebPrintTrader.js"></script>
  <script src="https://www.star-m.jp/products/s_print/sdk/starwebprintbuilder/v1.2.0/StarWebPrintBuilder.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc, doc, Timestamp, onSnapshot, addDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyCkL0NFOvB40TG2Ssmwp61kIcsADUxkuro",
      authDomain: "hachi-akatsuka.firebaseapp.com",
      projectId: "hachi-akatsuka",
      storageBucket: "hachi-akatsuka.firebasestorage.app",
      messagingSenderId: "441792715943",
      appId: "1:441792715943:web:3dc2a4c7d36e4bb2ad72ea"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.updateDoc = updateDoc;
    window.doc = doc;
    window.Timestamp = Timestamp;
    window.onSnapshot = onSnapshot;
    window.addDoc = addDoc;
    window.orderBy = orderBy;
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1800px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .header h1 {
      font-size: 32px;
      color: #333;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .sales-summary {
      background: #f8f9fa;
      padding: 15px 20px;
      border-radius: 12px;
      display: flex;
      gap: 30px;
    }
    
    .sales-item {
      text-align: center;
    }
    
    .sales-label {
      font-size: 12px;
      color: #666;
    }
    
    .sales-value {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .btn-settlement {
      padding: 12px 30px;
      font-size: 16px;
      font-weight: bold;
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1.5fr 1fr 1fr;
      gap: 25px;
    }
    
    @media (max-width: 1400px) {
      .main-content {
        grid-template-columns: 1fr 1fr;
      }
      
      .main-content .section:first-child {
        grid-column: 1 / -1;
      }
    }
    
    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }
    
    .section {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }
    
    .section h2 {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #667eea;
    }
    
    /* æ³¨æ–‡ãƒªã‚¹ãƒˆ */
    .orders-list {
      max-height: 600px;
      overflow-y: auto;
    }
    
    .order-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 5px solid #667eea;
      position: relative;
    }
    
    .order-card.assigned {
      border-left-color: #4CAF50;
      background: #e8f5e9;
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .order-number {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    
    .order-table-label {
      background: #4CAF50;
      color: white;
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
    }
    
    .order-source {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .order-items {
      margin: 10px 0;
    }
    
    .order-item {
      padding: 8px 0;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #ddd;
    }
    
    .item-name {
      font-weight: 500;
    }
    
    .item-price {
      font-weight: bold;
      color: #667eea;
    }
    
    .order-total {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 2px solid #667eea;
      font-size: 20px;
      font-weight: bold;
    }
    
    .order-actions {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }
    
    .btn {
      padding: 12px;
      font-size: 14px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #4CAF50;
      color: white;
    }
    
    .btn-warning {
      background: #FF9800;
      color: white;
    }
    
    .btn-info {
      background: #2196F3;
      color: white;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚°ãƒªãƒƒãƒ‰ */
    .table-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }
    
    .table-btn {
      padding: 20px;
      font-size: 18px;
      font-weight: bold;
      border: 3px solid #ddd;
      border-radius: 15px;
      cursor: pointer;
      background: white;
      transition: all 0.3s;
      position: relative;
    }
    
    .table-btn:hover {
      border-color: #667eea;
      background: #f8f9fa;
    }
    
    .table-btn.selected {
      border-color: #4CAF50;
      background: #e8f5e9;
    }
    
    .table-order-count {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #f44336;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    
    .memo-icon {
      position: absolute;
      top: 5px;
      left: 5px;
      font-size: 16px;
      cursor: pointer;
      opacity: 0.3;
    }
    
    .memo-icon:hover {
      opacity: 1;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«æ³¨æ–‡ä¸€è¦§ */
    .table-orders-section {
      margin-top: 20px;
    }
    
    .table-order-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 5px solid #4CAF50;
    }
    
    .table-actions {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }
    
    .btn-danger {
      background: #f44336;
      color: white;
    }
    
    .btn-large {
      padding: 18px;
      font-size: 18px;
      border-radius: 12px;
      margin-top: 15px;
    }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal h3 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    
    .payment-methods {
      display: grid;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .payment-method-btn {
      padding: 20px;
      font-size: 20px;
      font-weight: bold;
      border: 3px solid #ddd;
      border-radius: 12px;
      cursor: pointer;
      background: white;
    }
    
    .payment-method-btn.selected {
      border-color: #667eea;
      background: #e8eaf6;
    }
    
    .cash-input-section {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    
    .cash-input-section input {
      width: 100%;
      padding: 15px;
      font-size: 24px;
      border: 2px solid #ddd;
      border-radius: 8px;
      text-align: right;
    }
    
    .change-display {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    
    .change-amount {
      color: #4CAF50;
      font-size: 28px;
    }
    
    .hidden {
      display: none !important;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 18px;
    }
    
    .menu-item-checkbox {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .menu-item-checkbox:hover {
      background: #f0f0f0;
    }
    
    .menu-item-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      cursor: pointer;
    }
    
    .menu-item-info {
      flex: 1;
    }
    
    .menu-item-name-small {
      font-weight: 500;
      color: #333;
    }
    
    .menu-item-price-small {
      color: #667eea;
      font-weight: bold;
      font-size: 14px;
    }
    
    .selected-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      background: white;
      border-radius: 8px;
    }
    
    .quantity-input {
      width: 60px;
      padding: 5px;
      text-align: center;
      border: 2px solid #ddd;
      border-radius: 5px;
      margin: 0 10px;
    }
    
    .remove-btn {
      padding: 5px 12px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .discount-input-section input {
      width: 100%;
      padding: 15px;
      font-size: 24px;
      border: 2px solid #ddd;
      border-radius: 8px;
      text-align: right;
    }
    
    .discount-preview {
      margin-top: 15px;
      padding: 15px;
      background: #fff3cd;
      border-radius: 8px;
    }
    
    .discount-preview-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 18px;
    }
    
    .discount-preview-item.total {
      font-weight: bold;
      font-size: 20px;
      padding-top: 10px;
      border-top: 2px solid #ddd;
      color: #FF9800;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
      <div>
        <h1>ğŸ§¾ ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒªãƒ¢ã‚³ãƒ³æ–¹å¼ï¼‰</h1>
        <div style="color: #666;">ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—</div>
      </div>
      <div class="header-right">
        <div class="sales-summary">
          <div class="sales-item">
            <div class="sales-label">å®¢æ•°</div>
            <div class="sales-value" id="customerCount">0</div>
          </div>
          <div class="sales-item">
            <div class="sales-label">æœ¬æ—¥å£²ä¸Š</div>
            <div class="sales-value" id="todaySales">Â¥0</div>
          </div>
        </div>
        <button class="btn-settlement" onclick="showSettlementModal()">ğŸ“Š ç²¾ç®—</button>
      </div>
    </div>
    
    <div class="main-content">
      <!-- å·¦å´: å…¨æ³¨æ–‡ä¸€è¦§ï¼ˆãƒªãƒ¢ã‚³ãƒ³æ–¹å¼ï¼‰ -->
      <div class="section">
        <h2>ğŸ“‹ æ³¨æ–‡ä¸€è¦§ï¼ˆæœªæŒ¯ã‚Šåˆ†ã‘ï¼‰</h2>
        <div id="ordersList" class="orders-list">
          <div class="empty-state">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
      
      <!-- ä¸­å¤®: æ‰‹å‹•ãƒ¬ã‚¸å…¥åŠ› -->
      <div class="section">
        <h2>âœï¸ æ‰‹å‹•ãƒ¬ã‚¸å…¥åŠ›</h2>
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 8px;">æŒ¯ã‚Šåˆ†ã‘å…ˆãƒ†ãƒ¼ãƒ–ãƒ«</label>
          <select id="manualTable" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px;">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 8px;">å•†å“ã‚’é¸æŠ</label>
          <div style="max-height: 300px; overflow-y: auto; border: 2px solid #ddd; border-radius: 8px; padding: 10px; background: white;">
            <div id="menuItemsList">
              <div class="empty-state">ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
          </div>
        </div>
        
        <div id="selectedItems" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; min-height: 100px;">
          <div class="empty-state" style="padding: 20px;">å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        </div>
        
        <div style="font-size: 20px; font-weight: bold; text-align: right; margin-bottom: 15px;">
          åˆè¨ˆ: <span id="manualTotal" style="color: #4CAF50;">Â¥0</span>
        </div>
        
        <button class="btn btn-primary btn-large" onclick="submitManualOrder()" id="manualSubmitBtn" disabled>æ³¨æ–‡ã‚’è¿½åŠ </button>
      </div>
      
      <!-- å³å´: ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç† -->
      <div class="section">
        <h2>ğŸ  ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†</h2>
        <div class="table-grid" id="tableGrid">
          <!-- JavaScriptã§ç”Ÿæˆ -->
        </div>
        
        <div id="tableOrdersSection" class="table-orders-section hidden">
          <h3 style="margin: 20px 0 10px 0;">ğŸ“ <span id="selectedTableLabel"></span> ã®æ³¨æ–‡</h3>
          <div id="tableOrdersList">
            <!-- JavaScriptã§ç”Ÿæˆ -->
          </div>
          <div id="tableActions" class="hidden">
            <button class="btn btn-warning btn-large" onclick="showDiscountModal()">ğŸ’° å€¤å¼•ã</button>
            <button class="btn btn-primary btn-large" onclick="showPaymentModal()">ğŸ’³ ä¼šè¨ˆå‡¦ç†</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="assignModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ“ ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¯ã‚Šåˆ†ã‘</h3>
      <div style="margin-bottom: 20px;">
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">æ³¨æ–‡ #<span id="assignOrderNumber"></span></div>
      </div>
      <div class="table-grid" id="assignTableGrid">
        <!-- JavaScriptã§ç”Ÿæˆ -->
      </div>
      <button class="btn btn-danger btn-large" onclick="closeAssignModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  
  <!-- æ”¯æ‰•ã„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ’³ æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠ</h3>
      <div class="payment-methods">
        <button class="payment-method-btn" onclick="selectPaymentMethod('cash')">ğŸ’µ ç¾é‡‘</button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('emoney')">ğŸ“± é›»å­ãƒãƒãƒ¼</button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('credit')">ğŸ’³ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</button>
      </div>
      
      <div id="cashInputSection" class="cash-input-section hidden">
        <label>ãŠé ã‹ã‚Šé‡‘é¡</label>
        <input type="number" id="cashReceived" placeholder="0" oninput="calculateChange()">
        <div class="change-display">
          ãŠã¤ã‚Š: <span class="change-amount" id="changeAmount">Â¥0</span>
        </div>
      </div>
      
      <button class="btn btn-primary btn-large" onclick="completePayment()" id="completePaymentBtn" disabled>ä¼šè¨ˆå®Œäº†</button>
      <button class="btn btn-danger" style="margin-top: 10px;" onclick="closePaymentModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  
  <!-- å€¤å¼•ããƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="discountModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ’° å€¤å¼•ãè¨­å®š</h3>
      <div class="discount-input-section">
        <label>å€¤å¼•ãé‡‘é¡ã‚’å…¥åŠ›</label>
        <input type="number" id="discountAmount" placeholder="0" oninput="updateDiscountPreview()">
      </div>
      
      <div class="discount-preview">
        <div class="discount-preview-item">
          <span>å…ƒã®é‡‘é¡:</span>
          <span id="originalAmount">Â¥0</span>
        </div>
        <div class="discount-preview-item">
          <span>å€¤å¼•ãé¡:</span>
          <span id="discountValue">-Â¥0</span>
        </div>
        <div class="discount-preview-item total">
          <span>å€¤å¼•ãå¾Œ:</span>
          <span id="discountedAmount">Â¥0</span>
        </div>
      </div>
      
      <button class="btn btn-warning btn-large" onclick="applyDiscount()">å€¤å¼•ãé©ç”¨</button>
      <button class="btn btn-danger" style="margin-top: 10px;" onclick="closeDiscountModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  
  <!-- ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="memoModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ“ ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¡ãƒ¢ - <span id="memoTableName"></span></h3>
      <textarea id="memoTextarea" 
                style="width: 100%; min-height: 150px; padding: 15px; font-size: 16px; 
                       border: 2px solid #ddd; border-radius: 8px; resize: vertical;"
                placeholder="äºˆç´„è€…åã€äººæ•°ã€ç‰¹è¨˜äº‹é …ãªã©..."></textarea>
      <button class="btn btn-primary btn-large" onclick="saveMemo()">ğŸ’¾ ä¿å­˜</button>
      <button class="btn btn-danger" style="margin-top: 10px;" onclick="closeMemoModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  
  <script>
    // ãƒ—ãƒªãƒ³ã‚¿ãƒ¼IPã‚¢ãƒ‰ãƒ¬ã‚¹
    const PRINTER_IP = '192.168.244.41';
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©
    const TABLES = [
      'ãƒ†ãƒ¼ãƒ–ãƒ«H', 'ãƒ†ãƒ¼ãƒ–ãƒ«M', 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼1', 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼2',
      'äºˆç´„1', 'äºˆç´„2', 'äºˆç´„3', 'äºˆç´„4', 'äºˆç´„5'
    ];
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿
    const MENU_DATA = [
      {id: 1, name: 'ãŠå¥½ã¿ç„¼ã(è±šç‰)', price: 600, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 10},
      {id: 2, name: 'ãŠå¥½ã¿ç„¼ã(ã‚¤ã‚«ç‰)', price: 600, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 10},
      {id: 3, name: 'ãŠå¥½ã¿ç„¼ã(ã‚¨ãƒ“ç‰)', price: 700, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 10},
      {id: 4, name: 'ãŠå¥½ã¿ç„¼ã(ç‰›ã™ã˜)', price: 700, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 10},
      {id: 5, name: 'ãŠå¥½ã¿ç„¼ã(ãƒŸãƒƒã‚¯ã‚¹)', price: 700, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 10},
      {id: 6, name: 'ãŠå¥½ã¿ç„¼ã(æ˜å¤ªå­)', price: 700, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 10},
      {id: 7, name: 'ãŠå¥½ã¿ç„¼ã(ãƒãƒ¼ã‚º)', price: 700, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 10},
      {id: 8, name: 'ãŠå¥½ã¿ç„¼ã(ãƒ¢ãƒ€ãƒ³)', price: 700, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 10},
      {id: 9, name: 'ãŠå¥½ã¿ç„¼ã(ãƒ‡ãƒ©ãƒƒã‚¯ã‚¹)', price: 800, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 10},
      {id: 10, name: 'ãŠå¥½ã¿ç„¼ã(ã‚¹ãƒšã‚·ãƒ£ãƒ«)', price: 900, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 10},
      {id: 11, name: 'ç„¼ããã°(ã‚½ãƒ¼ã‚¹)', price: 500, category: 'ç„¼ããã°', taxRate: 10},
      {id: 12, name: 'ç„¼ããã°(å¡©)', price: 500, category: 'ç„¼ããã°', taxRate: 10},
      {id: 13, name: 'ã¨ã‚“å¹³ç„¼ã', price: 500, category: 'ä¸€å“æ–™ç†', taxRate: 10},
      {id: 14, name: 'ã­ãç„¼ã', price: 500, category: 'ä¸€å“æ–™ç†', taxRate: 10},
      {id: 15, name: 'ãŸã“ç„¼ã(8å€‹)', price: 400, category: 'ãŸã“ç„¼ã', taxRate: 8},
      {id: 16, name: 'ãŸã“ç„¼ã(12å€‹)', price: 550, category: 'ãŸã“ç„¼ã', taxRate: 8},
      {id: 17, name: 'æè±†', price: 300, category: 'ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼', taxRate: 10},
      {id: 18, name: 'ã‚­ãƒ£ãƒ™ãƒ„ç„¼ã', price: 300, category: 'ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼', taxRate: 10},
      {id: 19, name: 'ç”Ÿãƒ“ãƒ¼ãƒ«(ä¸­)', price: 500, category: 'ãƒ‰ãƒªãƒ³ã‚¯', taxRate: 10},
      {id: 20, name: 'ãƒã‚¤ãƒœãƒ¼ãƒ«', price: 400, category: 'ãƒ‰ãƒªãƒ³ã‚¯', taxRate: 10},
      {id: 21, name: 'ã‚¦ãƒ¼ãƒ­ãƒ³èŒ¶', price: 200, category: 'ãƒ‰ãƒªãƒ³ã‚¯', taxRate: 10},
      {id: 22, name: 'ã‚³ãƒ¼ãƒ©', price: 200, category: 'ãƒ‰ãƒªãƒ³ã‚¯', taxRate: 10},
      {id: 23, name: 'åŒ…æ', price: 50, category: 'åŒ…æ', taxRate: 10}
    ];
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let allOrders = [];
    let tableOrders = {}; // ãƒ†ãƒ¼ãƒ–ãƒ«ã”ã¨ã®æ³¨æ–‡ã‚’ç®¡ç†
    let selectedTable = null;
    let tableMemos = {};
    let currentAssignOrder = null;
    let selectedPaymentMethod = null;
    let totalAmountToPay = 0;
    let cashReceived = 0;
    let changeAmount = 0;
    let discountAmount = 0;
    let manualCart = []; // æ‰‹å‹•å…¥åŠ›ç”¨ã‚«ãƒ¼ãƒˆ
    let todaySalesData = {
      customerCount: 0,
      totalSales: 0,
      tax8Total: 0,
      tax10Total: 0,
      cashTotal: 0,
      emoneyTotal: 0,
      creditTotal: 0
    };
    
    // åˆæœŸåŒ–
    window.addEventListener('load', async () => {
      await initializeSystem();
    });
    
    async function initializeSystem() {
      // localStorageã‹ã‚‰ãƒ¡ãƒ¢ã¨ãƒ†ãƒ¼ãƒ–ãƒ«æŒ¯ã‚Šåˆ†ã‘ã‚’èª­ã¿è¾¼ã¿
      const savedMemos = localStorage.getItem('tableMemos');
      if (savedMemos) {
        tableMemos = JSON.parse(savedMemos);
      }
      
      const savedTableOrders = localStorage.getItem('tableOrders');
      if (savedTableOrders) {
        tableOrders = JSON.parse(savedTableOrders);
      }
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
      generateTableButtons();
      generateAssignTableButtons();
      
      // æ‰‹å‹•å…¥åŠ›ç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠè‚¢
      const manualTable = document.getElementById('manualTable');
      TABLES.forEach(table => {
        const option = document.createElement('option');
        option.value = table;
        option.textContent = table;
        manualTable.appendChild(option);
      });
      
      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’è¡¨ç¤º
      displayMenuItems();
      
      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹
      startRealtimeMonitoring();
      
      // å£²ä¸Šè¨ˆç®—
      await calculateTodaySales();
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ç”Ÿæˆ
    function generateTableButtons() {
      const grid = document.getElementById('tableGrid');
      grid.innerHTML = '';
      
      TABLES.forEach(table => {
        const btn = document.createElement('button');
        btn.className = 'table-btn';
        btn.id = `table-${table}`;
        
        // äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã«ãƒ¡ãƒ¢ã‚¢ã‚¤ã‚³ãƒ³
        if (table.startsWith('äºˆç´„')) {
          const memoIcon = document.createElement('span');
          memoIcon.className = 'memo-icon';
          memoIcon.innerHTML = 'ğŸ“';
          memoIcon.onclick = (e) => {
            e.stopPropagation();
            showMemoModal(table);
          };
          btn.appendChild(memoIcon);
        }
        
        const label = document.createElement('span');
        label.textContent = table;
        btn.appendChild(label);
        
        // æ³¨æ–‡æ•°ã‚«ã‚¦ãƒ³ãƒˆ
        const orderCount = tableOrders[table] ? tableOrders[table].length : 0;
        if (orderCount > 0) {
          const badge = document.createElement('span');
          badge.className = 'table-order-count';
          badge.textContent = orderCount;
          btn.appendChild(badge);
        }
        
        btn.onclick = () => selectTable(table);
        grid.appendChild(btn);
      });
    }
    
    // æŒ¯ã‚Šåˆ†ã‘ç”¨ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ç”Ÿæˆ
    function generateAssignTableButtons() {
      const grid = document.getElementById('assignTableGrid');
      grid.innerHTML = '';
      
      TABLES.forEach(table => {
        const btn = document.createElement('button');
        btn.className = 'table-btn';
        btn.textContent = table;
        btn.onclick = () => assignOrderToTable(table);
        grid.appendChild(btn);
      });
    }
    
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–é–‹å§‹
    function startRealtimeMonitoring() {
      const q = query(
        collection(db, 'orders'),
        orderBy('timestamp', 'desc')
      );
      
      onSnapshot(q, (snapshot) => {
        allOrders = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          if (!data.paidAt && !data.cancelledAt) {
            allOrders.push({ id: doc.id, ...data });
          }
        });
        
        displayAllOrders();
        updateTableButtons();
        
        if (selectedTable) {
          displayTableOrders(selectedTable);
        }
      });
    }
    
    // å…¨æ³¨æ–‡ã‚’è¡¨ç¤º
    function displayAllOrders() {
      const container = document.getElementById('ordersList');
      
      // æœªæŒ¯ã‚Šåˆ†ã‘ã®æ³¨æ–‡ã®ã¿
      const unassignedOrders = allOrders.filter(order => {
        return !isOrderAssignedToAnyTable(order.orderNumber);
      });
      
      if (unassignedOrders.length === 0) {
        container.innerHTML = '<div class="empty-state">æœªæŒ¯ã‚Šåˆ†ã‘ã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = '';
      
      unassignedOrders.forEach(order => {
        const card = createOrderCard(order);
        container.appendChild(card);
      });
    }
    
    // æ³¨æ–‡ãŒã©ã“ã‹ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¯ã‚Šåˆ†ã‘ã‚‰ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    function isOrderAssignedToAnyTable(orderNumber) {
      for (let table in tableOrders) {
        if (tableOrders[table].includes(orderNumber)) {
          return true;
        }
      }
      return false;
    }
    
    // æ³¨æ–‡ã‚«ãƒ¼ãƒ‰ä½œæˆ
    function createOrderCard(order) {
      const card = document.createElement('div');
      card.className = 'order-card';
      
      let itemsHtml = '';
      order.items.forEach(item => {
        const subtotal = item.price * item.quantity;
        itemsHtml += `
          <div class="order-item">
            <div>
              <div class="item-name">${item.name} Ã— ${item.quantity}</div>
            </div>
            <div class="item-price">Â¥${subtotal.toLocaleString()}</div>
          </div>
        `;
      });
      
      card.innerHTML = `
        <div class="order-header">
          <div class="order-number">#${order.orderNumber}</div>
        </div>
        <div class="order-source">ã”åˆ©ç”¨ã‚¹ã‚¿ã‚¤ãƒ«: ${order.tableNumber}</div>
        <div class="order-items">${itemsHtml}</div>
        <div class="order-total">
          <span>åˆè¨ˆ</span>
          <span>Â¥${order.totalAmount.toLocaleString()}</span>
        </div>
        <div class="order-actions">
          <button class="btn btn-info" onclick="assignOrder(${order.orderNumber})">ğŸ“ æŒ¯ã‚Šåˆ†ã‘</button>
          <button class="btn btn-primary" onclick="quickCheckout(${order.orderNumber})">ğŸ’³ å³ä¼šè¨ˆ</button>
          <button class="btn btn-warning" onclick="quickCheckoutWithDiscount(${order.orderNumber})">ğŸ’° å€¤å¼•ãä¼šè¨ˆ</button>
        </div>
      `;
      
      return card;
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠ
    window.selectTable = function(table) {
      selectedTable = table;
      
      // å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã®é¸æŠè§£é™¤
      document.querySelectorAll('.table-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      // é¸æŠã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚’å¼·èª¿
      const btn = document.getElementById(`table-${table}`);
      if (btn) {
        btn.classList.add('selected');
      }
      
      document.getElementById('selectedTableLabel').textContent = table;
      document.getElementById('tableOrdersSection').classList.remove('hidden');
      
      displayTableOrders(table);
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ³¨æ–‡ã‚’è¡¨ç¤º
    function displayTableOrders(table) {
      const container = document.getElementById('tableOrdersList');
      const actionsDiv = document.getElementById('tableActions');
      
      if (!tableOrders[table] || tableOrders[table].length === 0) {
        container.innerHTML = '<div class="empty-state">ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        actionsDiv.classList.add('hidden');
        return;
      }
      
      container.innerHTML = '';
      let total = 0;
      
      tableOrders[table].forEach(orderNumber => {
        const order = allOrders.find(o => o.orderNumber === orderNumber);
        if (!order) return;
        
        total += order.totalAmount;
        
        const card = document.createElement('div');
        card.className = 'table-order-card';
        
        let itemsHtml = '';
        order.items.forEach(item => {
          const subtotal = item.price * item.quantity;
          itemsHtml += `
            <div class="order-item">
              <div class="item-name">${item.name} Ã— ${item.quantity}</div>
              <div class="item-price">Â¥${subtotal.toLocaleString()}</div>
            </div>
          `;
        });
        
        card.innerHTML = `
          <div class="order-header">
            <div class="order-number">#${order.orderNumber}</div>
          </div>
          <div class="order-items">${itemsHtml}</div>
          <div class="order-total">
            <span>å°è¨ˆ</span>
            <span>Â¥${order.totalAmount.toLocaleString()}</span>
          </div>
          <div class="table-actions">
            <button class="btn btn-danger" onclick="removeOrderFromTable('${table}', ${orderNumber})">âŒ å‰Šé™¤</button>
            <button class="btn btn-primary" onclick="quickCheckoutSingle(${orderNumber})">ğŸ’³ å€‹åˆ¥ä¼šè¨ˆ</button>
          </div>
        `;
        
        container.appendChild(card);
      });
      
      // åˆè¨ˆè¡¨ç¤º
      const totalCard = document.createElement('div');
      totalCard.style.cssText = 'font-size: 24px; font-weight: bold; text-align: right; margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 12px;';
      totalCard.innerHTML = `åˆè¨ˆ: Â¥${total.toLocaleString()}`;
      container.appendChild(totalCard);
      
      actionsDiv.classList.remove('hidden');
      totalAmountToPay = total;
    }
    
    // æ³¨æ–‡ã‚’ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¯ã‚Šåˆ†ã‘
    window.assignOrder = function(orderNumber) {
      currentAssignOrder = orderNumber;
      document.getElementById('assignOrderNumber').textContent = orderNumber;
      document.getElementById('assignModal').classList.remove('hidden');
    };
    
    window.assignOrderToTable = function(table) {
      if (!tableOrders[table]) {
        tableOrders[table] = [];
      }
      
      if (!tableOrders[table].includes(currentAssignOrder)) {
        tableOrders[table].push(currentAssignOrder);
      }
      
      // localStorageã«ä¿å­˜
      localStorage.setItem('tableOrders', JSON.stringify(tableOrders));
      
      closeAssignModal();
      displayAllOrders();
      updateTableButtons();
      
      if (selectedTable === table) {
        displayTableOrders(table);
      }
    };
    
    window.closeAssignModal = function() {
      document.getElementById('assignModal').classList.add('hidden');
      currentAssignOrder = null;
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰æ³¨æ–‡ã‚’å‰Šé™¤
    window.removeOrderFromTable = function(table, orderNumber) {
      if (tableOrders[table]) {
        tableOrders[table] = tableOrders[table].filter(n => n !== orderNumber);
        localStorage.setItem('tableOrders', JSON.stringify(tableOrders));
      }
      
      displayTableOrders(table);
      displayAllOrders();
      updateTableButtons();
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚’æ›´æ–°
    function updateTableButtons() {
      generateTableButtons();
      
      // ãƒ¡ãƒ¢ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ›´æ–°
      TABLES.forEach(table => {
        if (table.startsWith('äºˆç´„')) {
          const btn = document.getElementById(`table-${table}`);
          const memoIcon = btn ? btn.querySelector('.memo-icon') : null;
          if (memoIcon) {
            if (tableMemos[table] && tableMemos[table].trim()) {
              memoIcon.style.opacity = '1';
            } else {
              memoIcon.style.opacity = '0.3';
            }
          }
        }
      });
      
      // é¸æŠçŠ¶æ…‹ã‚’å¾©å…ƒ
      if (selectedTable) {
        const btn = document.getElementById(`table-${selectedTable}`);
        if (btn) {
          btn.classList.add('selected');
        }
      }
    }
    
    // å³ä¼šè¨ˆ
    window.quickCheckout = function(orderNumber) {
      const order = allOrders.find(o => o.orderNumber === orderNumber);
      if (!order) return;
      
      // ä¸€æ™‚çš„ã«ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¯ã‚Šåˆ†ã‘
      const tempTable = 'å³ä¼šè¨ˆ';
      tableOrders[tempTable] = [orderNumber];
      selectedTable = tempTable;
      totalAmountToPay = order.totalAmount;
      discountAmount = 0;
      
      showPaymentModal();
    };
    
    // å³ä¼šè¨ˆï¼ˆå€¤å¼•ãã‚ã‚Šï¼‰
    window.quickCheckoutWithDiscount = function(orderNumber) {
      const order = allOrders.find(o => o.orderNumber === orderNumber);
      if (!order) return;
      
      const tempTable = 'å³ä¼šè¨ˆ';
      tableOrders[tempTable] = [orderNumber];
      selectedTable = tempTable;
      totalAmountToPay = order.totalAmount;
      
      showDiscountModal();
    };
    
    // å€‹åˆ¥ä¼šè¨ˆ
    window.quickCheckoutSingle = function(orderNumber) {
      const order = allOrders.find(o => o.orderNumber === orderNumber);
      if (!order) return;
      
      // ç¾åœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ä¸€æ™‚çš„ã«åˆ†å‰²
      const tempTable = `${selectedTable}_å€‹åˆ¥`;
      tableOrders[tempTable] = [orderNumber];
      const originalTable = selectedTable;
      selectedTable = tempTable;
      totalAmountToPay = order.totalAmount;
      discountAmount = 0;
      
      showPaymentModal();
      
      // ä¼šè¨ˆå¾Œã«å…ƒã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«æˆ»ã™å‡¦ç†
      window.afterPaymentCallback = () => {
        // å…ƒã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰å‰Šé™¤
        if (tableOrders[originalTable]) {
          tableOrders[originalTable] = tableOrders[originalTable].filter(n => n !== orderNumber);
          localStorage.setItem('tableOrders', JSON.stringify(tableOrders));
        }
        delete tableOrders[tempTable];
        selectedTable = originalTable;
        displayTableOrders(originalTable);
      };
    };
    
    // æ”¯æ‰•ã„ãƒ¢ãƒ¼ãƒ€ãƒ«
    window.showPaymentModal = function() {
      document.getElementById('paymentModal').classList.remove('hidden');
      selectedPaymentMethod = null;
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('completePaymentBtn').disabled = true;
    };
    
    window.selectPaymentMethod = function(method) {
      selectedPaymentMethod = method;
      
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');
      
      if (method === 'cash') {
        document.getElementById('cashInputSection').classList.remove('hidden');
        document.getElementById('completePaymentBtn').disabled = true;
      } else {
        document.getElementById('cashInputSection').classList.add('hidden');
        document.getElementById('completePaymentBtn').disabled = false;
      }
    };
    
    window.calculateChange = function() {
      cashReceived = parseInt(document.getElementById('cashReceived').value) || 0;
      changeAmount = cashReceived - totalAmountToPay;
      
      document.getElementById('changeAmount').textContent = `Â¥${changeAmount.toLocaleString()}`;
      document.getElementById('completePaymentBtn').disabled = cashReceived < totalAmountToPay;
    };
    
    // ä¼šè¨ˆå®Œäº†
    window.completePayment = async function() {
      if (!selectedPaymentMethod) return;
      if (selectedPaymentMethod === 'cash' && cashReceived < totalAmountToPay) return;
      
      try {
        const now = Timestamp.now();
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã®å…¨æ³¨æ–‡ã‚’ä¼šè¨ˆæ¸ˆã¿ã«ã™ã‚‹
        const orderNumbers = tableOrders[selectedTable] || [];
        
        for (const orderNumber of orderNumbers) {
          const order = allOrders.find(o => o.orderNumber === orderNumber);
          if (!order) continue;
          
          await updateDoc(doc(db, 'orders', order.id), {
            paidAt: now,
            notifiedPaid: true,
            paymentMethod: selectedPaymentMethod,
            discountAmount: discountAmount,
            discountedAmount: totalAmountToPay
          });
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰æ³¨æ–‡ã‚’å‰Šé™¤
        delete tableOrders[selectedTable];
        localStorage.setItem('tableOrders', JSON.stringify(tableOrders));
        
        // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè¡Œ
        if (window.afterPaymentCallback) {
          window.afterPaymentCallback();
          window.afterPaymentCallback = null;
        }
        
        alert('ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        
        closePaymentModal();
        await calculateTodaySales();
        displayAllOrders();
        updateTableButtons();
        
        if (selectedTable && !selectedTable.includes('å€‹åˆ¥') && selectedTable !== 'å³ä¼šè¨ˆ') {
          displayTableOrders(selectedTable);
        } else {
          document.getElementById('tableOrdersSection').classList.add('hidden');
          selectedTable = null;
        }
        
      } catch (e) {
        console.error('ä¼šè¨ˆã‚¨ãƒ©ãƒ¼:', e);
        alert('ä¼šè¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    window.closePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
      document.getElementById('cashReceived').value = '';
      calculateChange();
    };
    
    // å€¤å¼•ããƒ¢ãƒ¼ãƒ€ãƒ«
    window.showDiscountModal = function() {
      document.getElementById('discountModal').classList.remove('hidden');
      document.getElementById('discountAmount').value = '';
      updateDiscountPreview();
    };
    
    window.updateDiscountPreview = function() {
      const discount = parseInt(document.getElementById('discountAmount').value) || 0;
      const original = totalAmountToPay + discountAmount;
      const discounted = Math.max(0, original - discount);
      
      document.getElementById('originalAmount').textContent = `Â¥${original.toLocaleString()}`;
      document.getElementById('discountValue').textContent = `-Â¥${discount.toLocaleString()}`;
      document.getElementById('discountedAmount').textContent = `Â¥${discounted.toLocaleString()}`;
    };
    
    window.applyDiscount = function() {
      const discount = parseInt(document.getElementById('discountAmount').value) || 0;
      if (discount <= 0) return alert('å€¤å¼•ãé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      
      const original = totalAmountToPay + discountAmount;
      if (discount >= original) return alert('å€¤å¼•ãé‡‘é¡ãŒåˆè¨ˆé‡‘é¡ä»¥ä¸Šã§ã™');
      
      discountAmount = discount;
      totalAmountToPay = original - discount;
      
      closeDiscountModal();
      showPaymentModal();
    };
    
    window.closeDiscountModal = function() {
      document.getElementById('discountModal').classList.add('hidden');
    };
    
    // ãƒ¡ãƒ¢æ©Ÿèƒ½
    let currentMemoTable = null;
    
    window.showMemoModal = function(table) {
      currentMemoTable = table;
      document.getElementById('memoModal').classList.remove('hidden');
      document.getElementById('memoTableName').textContent = table;
      document.getElementById('memoTextarea').value = tableMemos[table] || '';
    };
    
    window.saveMemo = function() {
      if (!currentMemoTable) return;
      
      const memo = document.getElementById('memoTextarea').value;
      tableMemos[currentMemoTable] = memo;
      localStorage.setItem('tableMemos', JSON.stringify(tableMemos));
      
      updateTableButtons();
      alert(`${currentMemoTable}ã®ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
      closeMemoModal();
    };
    
    window.closeMemoModal = function() {
      document.getElementById('memoModal').classList.add('hidden');
      currentMemoTable = null;
    };
    
    // å£²ä¸Šè¨ˆç®—
    async function calculateTodaySales() {
      try {
        const now = new Date();
        const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        
        const todayStart = new Date(jstNow);
        todayStart.setHours(1, 0, 0, 0);
        if (jstNow < todayStart) {
          todayStart.setDate(todayStart.getDate() - 1);
        }
        
        const ordersSnapshot = await getDocs(collection(db, 'orders'));
        
        todaySalesData = {
          customerCount: 0,
          totalSales: 0,
          tax8Total: 0,
          tax10Total: 0,
          cashTotal: 0,
          emoneyTotal: 0,
          creditTotal: 0
        };
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          const orderDate = data.timestamp.toDate();
          const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
          
          if (jstOrderDate >= todayStart && data.paidAt && !data.cancelledAt) {
            todaySalesData.customerCount++;
            
            const amount = data.discountedAmount || data.totalAmount;
            todaySalesData.totalSales += amount;
            
            if (data.paymentMethod === 'cash') {
              todaySalesData.cashTotal += amount;
            } else if (data.paymentMethod === 'emoney') {
              todaySalesData.emoneyTotal += amount;
            } else if (data.paymentMethod === 'credit') {
              todaySalesData.creditTotal += amount;
            }
          }
        });
        
        document.getElementById('customerCount').textContent = todaySalesData.customerCount;
        document.getElementById('todaySales').textContent = `Â¥${todaySalesData.totalSales.toLocaleString()}`;
        
      } catch (e) {
        console.error('å£²ä¸Šè¨ˆç®—ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    // ç²¾ç®—ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆç°¡æ˜“ç‰ˆï¼‰
    window.showSettlementModal = function() {
      alert(`æœ¬æ—¥ã®å£²ä¸Š\n\nå®¢æ•°: ${todaySalesData.customerCount}å\nå£²ä¸Š: Â¥${todaySalesData.totalSales.toLocaleString()}\n\nç¾é‡‘: Â¥${todaySalesData.cashTotal.toLocaleString()}\né›»å­ãƒãƒãƒ¼: Â¥${todaySalesData.emoneyTotal.toLocaleString()}\nã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ: Â¥${todaySalesData.creditTotal.toLocaleString()}`);
    };
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’è¡¨ç¤º
    function displayMenuItems() {
      const container = document.getElementById('menuItemsList');
      container.innerHTML = '';
      
      MENU_DATA.forEach(item => {
        const div = document.createElement('div');
        div.className = 'menu-item-checkbox';
        div.innerHTML = `
          <input type="checkbox" id="menu-${item.id}" value="${item.id}" onchange="toggleMenuItem(${item.id})">
          <div class="menu-item-info">
            <div class="menu-item-name-small">${item.name}</div>
            <div class="menu-item-price-small">Â¥${item.price.toLocaleString()}</div>
          </div>
        `;
        container.appendChild(div);
      });
    }
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®é¸æŠåˆ‡ã‚Šæ›¿ãˆ
    window.toggleMenuItem = function(itemId) {
      const checkbox = document.getElementById(`menu-${itemId}`);
      const item = MENU_DATA.find(m => m.id === itemId);
      
      if (checkbox.checked) {
        manualCart.push({
          ...item,
          quantity: 1,
          toppings: 'ãªã—',
          toppingPrice: 0
        });
      } else {
        manualCart = manualCart.filter(i => i.id !== itemId);
      }
      
      updateManualCart();
    };
    
    // æ‰‹å‹•ã‚«ãƒ¼ãƒˆã®è¡¨ç¤ºæ›´æ–°
    function updateManualCart() {
      const container = document.getElementById('selectedItems');
      const submitBtn = document.getElementById('manualSubmitBtn');
      const manualTable = document.getElementById('manualTable');
      
      if (manualCart.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding: 20px;">å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
        submitBtn.disabled = true;
        document.getElementById('manualTotal').textContent = 'Â¥0';
        return;
      }
      
      container.innerHTML = '';
      let total = 0;
      
      manualCart.forEach((item, index) => {
        const subtotal = item.price * item.quantity;
        total += subtotal;
        
        const div = document.createElement('div');
        div.className = 'selected-item';
        div.innerHTML = `
          <span>${item.name}</span>
          <div style="display: flex; align-items: center;">
            <input type="number" class="quantity-input" min="1" value="${item.quantity}" 
                   onchange="updateQuantity(${index}, this.value)">
            <span style="min-width: 80px; text-align: right; font-weight: bold;">Â¥${subtotal.toLocaleString()}</span>
            <button class="remove-btn" onclick="removeFromManualCart(${index})">å‰Šé™¤</button>
          </div>
        `;
        container.appendChild(div);
      });
      
      document.getElementById('manualTotal').textContent = `Â¥${total.toLocaleString()}`;
      submitBtn.disabled = manualCart.length === 0 || !manualTable.value;
    }
    
    // æ•°é‡æ›´æ–°
    window.updateQuantity = function(index, value) {
      const qty = parseInt(value) || 1;
      manualCart[index].quantity = Math.max(1, qty);
      updateManualCart();
    };
    
    // ã‚«ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤
    window.removeFromManualCart = function(index) {
      const item = manualCart[index];
      const checkbox = document.getElementById(`menu-${item.id}`);
      if (checkbox) checkbox.checked = false;
      
      manualCart.splice(index, 1);
      updateManualCart();
    };
    
    // æ‰‹å‹•æ³¨æ–‡ã‚’é€ä¿¡
    window.submitManualOrder = async function() {
      const tableNumber = document.getElementById('manualTable').value;
      
      if (!tableNumber || manualCart.length === 0) {
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã¨å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        const now = new Date();
        const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        
        const todayStart = new Date(jstNow);
        todayStart.setHours(1, 0, 0, 0);
        if (jstNow < todayStart) {
          todayStart.setDate(todayStart.getDate() - 1);
        }
        
        const ordersSnapshot = await getDocs(collection(db, 'orders'));
        let maxOrderNumber = 618;
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          const orderDate = data.timestamp.toDate();
          const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
          
          if (jstOrderDate >= todayStart && data.orderNumber > maxOrderNumber) {
            maxOrderNumber = data.orderNumber;
          }
        });
        
        const orderNumber = maxOrderNumber + 1;
        
        let totalAmount = 0;
        manualCart.forEach(item => {
          totalAmount += item.price * item.quantity;
        });
        
        const deleteAt = new Date(now.getTime() + 10 * 60 * 1000);
        
        const orderData = {
          orderNumber: orderNumber,
          timestamp: Timestamp.fromDate(now),
          tableNumber: `æ‰‹å‹•å…¥åŠ›_${tableNumber}`,
          items: manualCart,
          totalAmount: totalAmount,
          status: 'pending',
          deleteAt: Timestamp.fromDate(deleteAt),
          cancelledAt: null,
          completedAt: null,
          paidAt: null,
          notifiedComplete: false,
          notifiedCancel: false,
          notifiedPaid: false,
          manualEntry: true
        };
        
        const docRef = await addDoc(collection(db, 'orders'), orderData);
        
        await updateDoc(docRef, {
          orderId: docRef.id
        });
        
        // è‡ªå‹•çš„ã«ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¯ã‚Šåˆ†ã‘
        if (!tableOrders[tableNumber]) {
          tableOrders[tableNumber] = [];
        }
        tableOrders[tableNumber].push(orderNumber);
        localStorage.setItem('tableOrders', JSON.stringify(tableOrders));
        
        alert(`æ³¨æ–‡ #${orderNumber} ã‚’è¿½åŠ ã—ã€${tableNumber}ã«æŒ¯ã‚Šåˆ†ã‘ã¾ã—ãŸï¼`);
        
        // ãƒªã‚»ãƒƒãƒˆ
        manualCart = [];
        document.getElementById('manualTable').value = '';
        document.querySelectorAll('#menuItemsList input[type="checkbox"]').forEach(cb => cb.checked = false);
        updateManualCart();
        updateTableButtons();
        
      } catch (e) {
        console.error('æ³¨æ–‡ã‚¨ãƒ©ãƒ¼:', e);
        alert('æ³¨æ–‡ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
  </script>
</body>
</html>
