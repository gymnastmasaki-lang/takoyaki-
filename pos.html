<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº— - ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ </title>
  
  <!-- Star mC-Print3 SDK -->
  <script src="https://www.star-m.jp/products/s_print/sdk/starwebprinttracer/v1.1.0/StarWebPrintTrader.js"></script>
  <script src="https://www.star-m.jp/products/s_print/sdk/starwebprintbuilder/v1.2.0/StarWebPrintBuilder.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc, doc, Timestamp, onSnapshot, addDoc, orderBy, getDoc, setDoc, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.updateDoc = updateDoc;
    window.doc = doc;
    window.Timestamp = Timestamp;
    window.onSnapshot = onSnapshot;
    window.addDoc = addDoc;
    window.orderBy = orderBy;
    window.getDoc = getDoc;
    window.setDoc = setDoc;
    window.limit = limit;
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .header-left h1 {
      font-size: 32px;
      color: #333;
      margin-bottom: 5px;
    }
    
    .header-left .status {
      font-size: 18px;
      color: #666;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .auto-print-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f8f9fa;
      padding: 12px 20px;
      border-radius: 12px;
    }
    
    .auto-print-toggle label {
      font-weight: bold;
      color: #333;
    }
    
    .toggle-switch {
      position: relative;
      width: 60px;
      height: 30px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 30px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: #4CAF50;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(30px);
    }
    
    .toggle-status {
      font-weight: bold;
      min-width: 50px;
    }
    
    .toggle-status.on {
      color: #4CAF50;
    }
    
    .toggle-status.off {
      color: #999;
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 25px;
    }
    
    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .header {
        flex-direction: column;
        gap: 15px;
      }
    }
    
    .section {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }
    
    .section h2 {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #667eea;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚°ãƒªãƒƒãƒ‰ */
    .table-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }
    
    @media (max-width: 768px) {
      .table-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    .table-btn {
      padding: 20px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      position: relative;
    }
    
    .table-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    .table-btn:active {
      transform: translateY(0);
    }
    
    .table-btn.has-orders {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .order-badge {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #ff4444;
      color: white;
      font-size: 12px;
      font-weight: bold;
      min-width: 24px;
      height: 24px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
      animation: pulse 1.5s infinite;
      box-shadow: 0 2px 8px rgba(255, 68, 68, 0.5);
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15); }
    }
    
    /* æ³¨æ–‡è©³ç´° */
    .order-details {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .order-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-left: 5px solid #667eea;
    }
    
    .order-card.completed {
      border-left-color: #4CAF50;
      opacity: 0.7;
    }
    
    .order-card.cancelled {
      border-left-color: #f44336;
      opacity: 0.7;
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .order-number {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    
    .order-time {
      font-size: 14px;
      color: #999;
    }
    
    .order-status {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      margin-left: 10px;
    }
    
    .order-status.pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .order-status.completed {
      background: #d4edda;
      color: #155724;
    }
    
    .order-status.cancelled {
      background: #f8d7da;
      color: #721c24;
    }
    
    .order-items {
      margin: 15px 0;
    }
    
    .order-item {
      padding: 10px 0;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .order-item:last-child {
      border-bottom: none;
    }
    
    .item-name {
      font-weight: 500;
      color: #333;
    }
    
    .item-details {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    
    .item-price {
      font-weight: bold;
      color: #667eea;
    }
    
    .order-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 3px solid #667eea;
      font-size: 24px;
      font-weight: bold;
    }
    
    .total-label {
      color: #333;
    }
    
    .total-amount {
      color: #667eea;
      font-size: 28px;
    }
    
    /* ãƒœã‚¿ãƒ³ */
    .btn {
      width: 100%;
      padding: 18px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      margin: 8px 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
      color: white;
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* æ‰‹å‹•å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .manual-input {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-group label {
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }
    
    .input-group input,
    .input-group select {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      transition: border-color 0.3s;
    }
    
    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .menu-items-list {
      max-height: 300px;
      overflow-y: auto;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      background: white;
    }
    
    .menu-item-checkbox {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .menu-item-checkbox:hover {
      background: #f0f0f0;
    }
    
    .menu-item-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      cursor: pointer;
    }
    
    .menu-item-info {
      flex: 1;
    }
    
    .menu-item-name-small {
      font-weight: 500;
      color: #333;
    }
    
    .menu-item-price-small {
      color: #667eea;
      font-weight: bold;
    }
    
    .selected-items {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .selected-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .quantity-input {
      width: 60px;
      padding: 5px;
      text-align: center;
      border: 2px solid #ddd;
      border-radius: 5px;
    }
    
    .remove-btn {
      padding: 5px 12px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 18px;
    }
    
    /* æ”¯æ‰•ã„æ–¹æ³•é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    }
    
    .modal h3 {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .payment-methods {
      display: grid;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .payment-method-btn {
      padding: 20px;
      font-size: 20px;
      font-weight: bold;
      border: 3px solid #ddd;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .payment-method-btn:hover {
      border-color: #667eea;
      background: #f8f9fa;
    }
    
    .payment-method-btn.selected {
      border-color: #667eea;
      background: #e8eaf6;
    }
    
    .cash-input-section {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    
    .cash-input-section label {
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
      font-size: 18px;
    }
    
    .cash-input-section input {
      width: 100%;
      padding: 15px;
      font-size: 24px;
      border: 2px solid #ddd;
      border-radius: 8px;
      text-align: right;
    }
    
    .change-display {
      margin-top: 15px;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    
    .change-amount {
      color: #4CAF50;
      font-size: 28px;
    }
    
    /* ãƒ¬ã‚·ãƒ¼ãƒˆå®Œäº†ç”»é¢ */
    .receipt-actions {
      display: grid;
      gap: 15px;
      margin-top: 20px;
    }
    
    .receipt-btn {
      padding: 20px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .receipt-btn.print {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
    }
    
    .receipt-btn.invoice {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
    }
    
    .receipt-btn.back {
      background: #e0e0e0;
      color: #333;
    }
    
    /* ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠ */
    .topping-item {
      display: flex;
      align-items: center;
      padding: 15px;
      background: white;
      border: 2px solid #ddd;
      border-radius: 12px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .topping-item:hover {
      border-color: #667eea;
      transform: translateX(5px);
    }
    
    .topping-item input[type="checkbox"] {
      width: 24px;
      height: 24px;
      margin-right: 15px;
      cursor: pointer;
    }
    
    .topping-item-info {
      flex: 1;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .topping-item-name {
      font-size: 16px;
      font-weight: bold;
      color: #333;
    }
    
    .topping-item-price {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
    }
    
    .hidden {
      display: none !important;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
      <div class="header-left">
        <h1>ğŸ§¾ ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ </h1>
        <div class="status">ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—</div>
      </div>
      <div class="header-right">
        <button onclick="showHistoryModal()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; margin-right: 10px;">ğŸ“œ å±¥æ­´</button>
        <button onclick="showMonthlyReportModal()" style="padding: 12px 24px; font-size: 16px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; margin-right: 10px;">ğŸ“Š æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ</button>
        <div class="auto-print-toggle">
          <label>ãƒ¬ã‚·ãƒ¼ãƒˆè‡ªå‹•ç™ºè¡Œ</label>
          <label class="toggle-switch">
            <input type="checkbox" id="autoPrintToggle" checked onchange="toggleAutoPrint()">
            <span class="toggle-slider"></span>
          </label>
          <span class="toggle-status on" id="autoPrintStatus">ON</span>
        </div>
      </div>
    </div>
    
    <div class="main-content">
      <!-- å·¦å´: ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠã¨æ³¨æ–‡è©³ç´° -->
      <div class="section">
        <h2>ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠ</h2>
        <div class="table-grid" id="tableGrid">
          <!-- JavaScriptã§ç”Ÿæˆ -->
        </div>
        
        <div id="orderSection" class="hidden">
          <h2>ğŸ“ æ³¨æ–‡è©³ç´° - <span id="selectedTableLabel"></span></h2>
          <div id="ordersList">
            <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
          
          <div id="totalSection" class="hidden">
            <div class="order-total">
              <span class="total-label">åˆè¨ˆé‡‘é¡:</span>
              <span class="total-amount" id="totalAmount">Â¥0</span>
            </div>
            <button class="btn btn-primary" onclick="showPaymentModal()">ğŸ’° ä¼šè¨ˆå‡¦ç†</button>
            <button class="btn btn-secondary" onclick="clearSelection()">â† ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠã«æˆ»ã‚‹</button>
          </div>
        </div>
      </div>
      
      <!-- å³å´: æ‰‹å‹•å…¥åŠ› -->
      <div class="section">
        <h2>âœï¸ æ‰‹å‹•ãƒ¬ã‚¸å…¥åŠ›</h2>
        <div class="manual-input">
          <div class="input-group">
            <label>ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·</label>
            <select id="manualTable">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          
          <div class="input-group">
            <label>å•†å“ã‚’é¸æŠ</label>
            <div class="menu-items-list" id="menuItemsList">
              <div class="loading">ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
          </div>
          
          <div class="selected-items" id="selectedItems"></div>
          
          <div class="input-group">
            <label>åˆè¨ˆé‡‘é¡: <span id="manualTotal" style="color: #667eea; font-size: 20px;">Â¥0</span></label>
          </div>
          
          <button class="btn btn-primary" onclick="submitManualOrder()" id="manualSubmitBtn" disabled>æ³¨æ–‡ã‚’è¿½åŠ </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- æ”¯æ‰•ã„æ–¹æ³•é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ’³ æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠ</h3>
      <div class="payment-methods">
        <button class="payment-method-btn" onclick="selectPaymentMethod('cash')">
          ğŸ’µ ç¾é‡‘
        </button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('emoney')">
          ğŸ“± é›»å­ãƒãƒãƒ¼
        </button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('credit')">
          ğŸ’³ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰
        </button>
      </div>
      
      <div id="cashInputSection" class="cash-input-section hidden">
        <label>ãŠé ã‹ã‚Šé‡‘é¡</label>
        <input type="number" id="cashReceived" placeholder="0" oninput="calculateChange()">
        <div class="change-display" id="changeDisplay">
          ãŠã¤ã‚Š: <span class="change-amount" id="changeAmount">Â¥0</span>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="completePayment()" id="completePaymentBtn" disabled>ä¼šè¨ˆå®Œäº†</button>
      <button class="btn btn-secondary" onclick="closePaymentModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  
  <!-- ãƒ¬ã‚·ãƒ¼ãƒˆå®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="receiptCompleteModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>âœ… ä¼šè¨ˆå®Œäº†</h3>
      <div style="text-align: center; margin: 20px 0; font-size: 18px; color: #4CAF50;">
        ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸ
      </div>
      <div class="receipt-actions">
        <button class="receipt-btn print" onclick="printReceipt()">ğŸ–¨ï¸ ãƒ¬ã‚·ãƒ¼ãƒˆç™ºè¡Œ</button>
        <button class="receipt-btn invoice" onclick="printInvoice()">ğŸ“„ é ˜åæ›¸ç™ºè¡Œ</button>
        <button class="receipt-btn back" onclick="closeReceiptModal()">â† æˆ»ã‚‹</button>
      </div>
    </div>
  </div>
  
  <!-- ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="toppingModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ´ ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’é¸æŠ</h3>
      <div id="toppingModalItemName" style="font-size: 18px; font-weight: bold; margin-bottom: 20px; color: #667eea;"></div>
      <div id="toppingsList" style="max-height: 400px; overflow-y: auto;">
        <!-- ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒªã‚¹ãƒˆ -->
      </div>
      <button class="btn btn-primary" onclick="confirmTopping()">æ±ºå®š</button>
      <button class="btn btn-secondary" onclick="closeToppingModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  
  <script>
    let selectedTable = null;
    let currentOrders = [];
    let menuItems = [];
    let manualCart = [];
    let autoPrintEnabled = true;
    let selectedPaymentMethod = null;
    let totalAmountToPay = 0;
    let cashReceived = 0;
    let changeAmount = 0;
    let lastPaymentData = null;
    
    // ãƒ—ãƒªãƒ³ã‚¿ãƒ¼IPã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆç”»åƒã‹ã‚‰ï¼‰
    const PRINTER_IP = '192.168.244.41';
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆFirebaseã‹ã‚‰å–å¾—ï¼‰
    let menuData = [];
    let toppingsData = [];
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©
    const TABLES = [
      'å³ä¼šè¨ˆ', 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ', 'c1', 'c2', 'T-H', 'T-M', 
      'äºˆç´„1', 'äºˆç´„2', 'äºˆç´„3', 'äºˆç´„4', 'äºˆç´„5'
    ];
    
    // åˆæœŸåŒ–
    window.addEventListener('load', async () => {
      await initializeSystem();
    });
    
    async function initializeSystem() {
      // Firebaseã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’å–å¾—
      try {
        const menuSnapshot = await getDocs(collection(db, 'menu'));
        menuData = [];
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          menuData.push({
            id: doc.id,
            name: data.name || '',
            price: data.price || 0,
            category: data.category || 'ãã®ä»–',
            taxRate: data.taxRate || 10
          });
        });
        console.log('âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', menuData.length, 'ä»¶');
      } catch (e) {
        console.error('âŒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
      }
      
      // Firebaseã‹ã‚‰ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’å–å¾—
      try {
        const toppingsSnapshot = await getDocs(collection(db, 'toppings'));
        toppingsData = [];
        toppingsSnapshot.forEach(doc => {
          const data = doc.data();
          toppingsData.push({
            id: doc.id,
            name: data.name || '',
            price: data.price || 0
          });
        });
        console.log('âœ… ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', toppingsData.length, 'ä»¶');
      } catch (e) {
        console.error('âŒ ãƒˆãƒƒãƒ”ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:', e);
      }
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
      const tableGrid = document.getElementById('tableGrid');
      tableGrid.innerHTML = '';
      TABLES.forEach(table => {
        const btn = document.createElement('button');
        btn.className = 'table-btn';
        
        // äºˆç´„ãƒ†ãƒ¼ãƒ–ãƒ«ã®å ´åˆã¯ãƒ¡ãƒ¢ã‚¢ã‚¤ã‚³ãƒ³ã‚’è¿½åŠ 
        if (table.startsWith('äºˆç´„')) {
          btn.style.position = 'relative';
          const memoIcon = document.createElement('span');
          memoIcon.innerHTML = 'ğŸ“';
          memoIcon.style.position = 'absolute';
          memoIcon.style.top = '5px';
          memoIcon.style.left = '5px';
          memoIcon.style.fontSize = '16px';
          memoIcon.style.cursor = 'pointer';
          btn.appendChild(memoIcon);
        }
        
        const tableLabel = document.createElement('span');
        tableLabel.textContent = table;
        btn.appendChild(tableLabel);
        
        btn.onclick = () => selectTable(table);
        btn.id = `table-${table}`;
        tableGrid.appendChild(btn);
      });
      
      // æ‰‹å‹•å…¥åŠ›ç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠè‚¢ã‚’ç”Ÿæˆ
      const manualTable = document.getElementById('manualTable');
      TABLES.forEach(table => {
        const option = document.createElement('option');
        option.value = table;
        option.textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${table}`;
        manualTable.appendChild(option);
      });
      
      // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’è¡¨ç¤º
      displayMenuItems();
      
      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹
      startRealtimeUpdates();
    }
    
    // è‡ªå‹•å°åˆ·ãƒˆã‚°ãƒ«
    window.toggleAutoPrint = function() {
      autoPrintEnabled = document.getElementById('autoPrintToggle').checked;
      const status = document.getElementById('autoPrintStatus');
      status.textContent = autoPrintEnabled ? 'ON' : 'OFF';
      status.className = autoPrintEnabled ? 'toggle-status on' : 'toggle-status off';
    };
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’è¡¨ç¤º
    function displayMenuItems() {
      const container = document.getElementById('menuItemsList');
      container.innerHTML = '';
      
      menuData.forEach(item => {
        const div = document.createElement('div');
        div.className = 'menu-item-checkbox';
        div.innerHTML = `
          <input type="checkbox" id="menu-${item.id}" value="${item.id}" onchange="toggleMenuItem('${item.id}')">
          <div class="menu-item-info">
            <div class="menu-item-name-small">${item.name}</div>
            <div class="menu-item-price-small">Â¥${item.price.toLocaleString()}</div>
          </div>
        `;
        container.appendChild(div);
      });
    }
    
    // ä¸€æ™‚çš„ãªé¸æŠä¸­ã®ã‚¢ã‚¤ãƒ†ãƒ 
    let currentSelectingItem = null;
    let selectedToppings = [];
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã®é¸æŠåˆ‡ã‚Šæ›¿ãˆ
    window.toggleMenuItem = function(itemId) {
      const checkbox = document.getElementById(`menu-${itemId}`);
      const item = menuData.find(m => m.id === itemId);
      
      if (checkbox.checked) {
        // ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        currentSelectingItem = { ...item };
        selectedToppings = [];
        showToppingModal(item);
      } else {
        manualCart = manualCart.filter(i => i.id !== itemId);
        updateManualCart();
      }
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showToppingModal(item) {
      document.getElementById('toppingModalItemName').textContent = item.name;
      const list = document.getElementById('toppingsList');
      list.innerHTML = '';
      
      // ã€Œãªã—ã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³
      const noneDiv = document.createElement('div');
      noneDiv.className = 'topping-item';
      noneDiv.innerHTML = `
        <input type="checkbox" id="topping-none" onchange="selectNoneTopping(this)">
        <div class="topping-item-info">
          <span class="topping-item-name">ãƒˆãƒƒãƒ”ãƒ³ã‚°ãªã—</span>
          <span class="topping-item-price">Â¥0</span>
        </div>
      `;
      list.appendChild(noneDiv);
      
      // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒªã‚¹ãƒˆ
      toppingsData.forEach(topping => {
        const div = document.createElement('div');
        div.className = 'topping-item';
        div.innerHTML = `
          <input type="checkbox" id="topping-${topping.id}" value="${topping.id}" onchange="selectTopping(this)">
          <div class="topping-item-info">
            <span class="topping-item-name">${topping.name}</span>
            <span class="topping-item-price">+Â¥${topping.price.toLocaleString()}</span>
          </div>
        `;
        list.appendChild(div);
      });
      
      // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œãªã—ã€ã‚’é¸æŠ
      document.getElementById('topping-none').checked = true;
      
      document.getElementById('toppingModal').classList.remove('hidden');
    }
    
    // ã€Œãªã—ã€ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’é¸æŠ
    window.selectNoneTopping = function(checkbox) {
      if (checkbox.checked) {
        // ä»–ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’ã™ã¹ã¦ã‚¯ãƒªã‚¢
        selectedToppings = [];
        toppingsData.forEach(t => {
          const cb = document.getElementById(`topping-${t.id}`);
          if (cb) cb.checked = false;
        });
      }
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’é¸æŠ
    window.selectTopping = function(checkbox) {
      const noneCheckbox = document.getElementById('topping-none');
      
      if (checkbox.checked) {
        // ã€Œãªã—ã€ã®ãƒã‚§ãƒƒã‚¯ã‚’å¤–ã™
        noneCheckbox.checked = false;
        
        // é¸æŠã•ã‚ŒãŸãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’è¿½åŠ 
        const toppingId = checkbox.value;
        const topping = toppingsData.find(t => t.id === toppingId);
        if (topping && !selectedToppings.find(t => t.id === toppingId)) {
          selectedToppings.push(topping);
        }
      } else {
        // é¸æŠè§£é™¤
        selectedToppings = selectedToppings.filter(t => t.id !== checkbox.value);
        
        // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãŒä½•ã‚‚é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€Œãªã—ã€ã‚’é¸æŠ
        if (selectedToppings.length === 0) {
          noneCheckbox.checked = true;
        }
      }
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠã‚’ç¢ºå®š
    window.confirmTopping = function() {
      if (!currentSelectingItem) return;
      
      let toppingNames = 'ãªã—';
      let toppingPrice = 0;
      
      if (selectedToppings.length > 0) {
        toppingNames = selectedToppings.map(t => t.name).join(', ');
        toppingPrice = selectedToppings.reduce((sum, t) => sum + t.price, 0);
      }
      
      manualCart.push({
        ...currentSelectingItem,
        quantity: 1,
        toppings: toppingNames,
        toppingPrice: toppingPrice
      });
      
      closeToppingModal();
      updateManualCart();
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeToppingModal = function() {
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã‚’ã‚¯ãƒªã‚¢
      if (currentSelectingItem) {
        const checkbox = document.getElementById(`menu-${currentSelectingItem.id}`);
        if (checkbox && manualCart.filter(i => i.id === currentSelectingItem.id).length === 0) {
          checkbox.checked = false;
        }
      }
      
      document.getElementById('toppingModal').classList.add('hidden');
      currentSelectingItem = null;
      selectedToppings = [];
    };
    
    // æ‰‹å‹•ã‚«ãƒ¼ãƒˆã®è¡¨ç¤ºæ›´æ–°
    function updateManualCart() {
      const container = document.getElementById('selectedItems');
      const submitBtn = document.getElementById('manualSubmitBtn');
      const manualTable = document.getElementById('manualTable');
      
      if (manualCart.length === 0) {
        container.innerHTML = '<div class="empty-state">å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
        submitBtn.disabled = true;
        document.getElementById('manualTotal').textContent = 'Â¥0';
        return;
      }
      
      container.innerHTML = '';
      let total = 0;
      
      manualCart.forEach((item, index) => {
        const subtotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
        total += subtotal;
        
        const div = document.createElement('div');
        div.className = 'selected-item';
        div.innerHTML = `
          <div style="flex: 1;">
            <div style="font-weight: bold; margin-bottom: 5px;">${item.name}</div>
            <div style="font-size: 12px; color: #666;">ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${item.toppings || 'ãªã—'}</div>
          </div>
          <div>
            <input type="number" class="quantity-input" min="1" value="${item.quantity}" 
                   onchange="updateQuantity(${index}, this.value)">
            <button class="remove-btn" onclick="removeFromManualCart(${index})">å‰Šé™¤</button>
          </div>
          <span>Â¥${subtotal.toLocaleString()}</span>
        `;
        container.appendChild(div);
      });
      
      document.getElementById('manualTotal').textContent = `Â¥${total.toLocaleString()}`;
      submitBtn.disabled = manualCart.length === 0 || !manualTable.value;
    }
    
    // æ•°é‡æ›´æ–°
    window.updateQuantity = function(index, value) {
      const qty = parseInt(value) || 1;
      manualCart[index].quantity = Math.max(1, qty);
      updateManualCart();
    };
    
    // ã‚«ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤
    window.removeFromManualCart = function(index) {
      const item = manualCart[index];
      const checkbox = document.getElementById(`menu-${item.id}`);
      if (checkbox) checkbox.checked = false;
      
      manualCart.splice(index, 1);
      updateManualCart();
    };
    
    // æ‰‹å‹•æ³¨æ–‡ã‚’é€ä¿¡
    window.submitManualOrder = async function() {
      const tableNumber = document.getElementById('manualTable').value;
      
      if (!tableNumber || manualCart.length === 0) {
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã¨å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        const now = new Date();
        const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        
        const todayStart = new Date(jstNow);
        todayStart.setHours(1, 0, 0, 0);
        if (jstNow < todayStart) {
          todayStart.setDate(todayStart.getDate() - 1);
        }
        
        const ordersSnapshot = await getDocs(collection(db, 'orders'));
        let maxOrderNumber = 618;
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          const orderDate = data.timestamp.toDate();
          const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
          
          if (jstOrderDate >= todayStart && data.orderNumber > maxOrderNumber) {
            maxOrderNumber = data.orderNumber;
          }
        });
        
        const orderNumber = maxOrderNumber + 1;
        
        let totalAmount = 0;
        manualCart.forEach(item => {
          totalAmount += item.price * item.quantity;
        });
        
        const deleteAt = new Date(now.getTime() + 10 * 60 * 1000);
        
        const orderData = {
          orderNumber: orderNumber,
          timestamp: Timestamp.fromDate(now),
          tableNumber: tableNumber,
          items: manualCart,
          totalAmount: totalAmount,
          status: 'pending',
          deleteAt: Timestamp.fromDate(deleteAt),
          cancelledAt: null,
          completedAt: null,
          paidAt: null,
          notifiedComplete: false,
          notifiedCancel: false,
          notifiedPaid: false,
          manualEntry: true
        };
        
        const docRef = await addDoc(collection(db, 'orders'), orderData);
        
        await updateDoc(docRef, {
          orderId: docRef.id
        });
        
        alert(`æ³¨æ–‡ #${orderNumber} ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼\nãƒ†ãƒ¼ãƒ–ãƒ«: ${tableNumber}\nåˆè¨ˆ: Â¥${totalAmount.toLocaleString()}`);
        
        manualCart = [];
        document.getElementById('manualTable').value = '';
        document.querySelectorAll('#menuItemsList input[type="checkbox"]').forEach(cb => cb.checked = false);
        updateManualCart();
        
      } catch (e) {
        console.error('æ³¨æ–‡ã‚¨ãƒ©ãƒ¼:', e);
        alert('æ³¨æ–‡ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹
    function startRealtimeUpdates() {
      TABLES.forEach(table => {
        monitorTable(table);
      });
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ³¨æ–‡ã‚’ç›£è¦–
    async function monitorTable(tableNum) {
      const q = query(
        collection(db, 'orders'),
        where('tableNumber', '==', String(tableNum))
      );
      
      onSnapshot(q, (snapshot) => {
        const unpaidOrders = snapshot.docs.filter(doc => {
          const data = doc.data();
          return !data.paidAt && !data.cancelledAt;
        });
        
        const hasActiveOrders = unpaidOrders.length > 0;
        const orderCount = unpaidOrders.length;
        
        const btn = document.getElementById(`table-${tableNum}`);
        if (btn) {
          // has-ordersã‚¯ãƒ©ã‚¹ã®æ›´æ–°
          if (hasActiveOrders) {
            btn.classList.add('has-orders');
          } else {
            btn.classList.remove('has-orders');
          }
          
          // æ—¢å­˜ã®ãƒãƒƒã‚¸ã‚’å‰Šé™¤
          const existingBadge = btn.querySelector('.order-badge');
          if (existingBadge) {
            existingBadge.remove();
          }
          
          // æ³¨æ–‡ãŒã‚ã‚‹å ´åˆã¯ãƒãƒƒã‚¸ã‚’è¿½åŠ 
          if (orderCount > 0) {
            const badge = document.createElement('span');
            badge.className = 'order-badge';
            badge.textContent = orderCount;
            btn.appendChild(badge);
          }
        }
        
        if (selectedTable === tableNum) {
          loadOrders(tableNum);
        }
      });
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠ
    window.selectTable = async function(tableNum) {
      selectedTable = tableNum;
      document.getElementById('selectedTableLabel').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${tableNum}`;
      document.getElementById('orderSection').classList.remove('hidden');
      
      await loadOrders(tableNum);
    };
    
    // æ³¨æ–‡ã‚’èª­ã¿è¾¼ã¿
    async function loadOrders(tableNum) {
      const container = document.getElementById('ordersList');
      container.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      try {
        const q = query(
          collection(db, 'orders'),
          where('tableNumber', '==', String(tableNum)),
          orderBy('timestamp', 'desc')
        );
        
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
          container.innerHTML = '<div class="empty-state">ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
          document.getElementById('totalSection').classList.add('hidden');
          return;
        }
        
        container.innerHTML = '';
        currentOrders = [];
        let totalAmount = 0;
        let hasUnpaidOrders = false;
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const order = { id: doc.id, ...data };
          
          if (!data.cancelledAt && !data.paidAt) {
            currentOrders.push(order);
            totalAmount += data.totalAmount;
            hasUnpaidOrders = true;
            
            const card = createOrderCard(order);
            container.appendChild(card);
          }
        });
        
        if (!hasUnpaidOrders) {
          container.innerHTML = '<div class="empty-state">æœªä¼šè¨ˆã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
          document.getElementById('totalSection').classList.add('hidden');
        } else {
          document.getElementById('totalAmount').textContent = `Â¥${totalAmount.toLocaleString()}`;
          document.getElementById('totalSection').classList.remove('hidden');
          totalAmountToPay = totalAmount;
        }
        
      } catch (e) {
        console.error('æ³¨æ–‡èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        container.innerHTML = '<div class="empty-state">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    }
    
    // æ³¨æ–‡ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
    function createOrderCard(order) {
      const card = document.createElement('div');
      card.className = 'order-card';
      
      if (order.completedAt) card.classList.add('completed');
      if (order.cancelledAt) card.classList.add('cancelled');
      
      let timeStr = '--:--';
      try {
        if (order.timestamp && order.timestamp.toDate) {
          const timestamp = order.timestamp.toDate();
          timeStr = `${timestamp.getHours()}:${String(timestamp.getMinutes()).padStart(2, '0')}`;
        }
      } catch (e) {
        console.error('Timestampå¤‰æ›ã‚¨ãƒ©ãƒ¼:', e);
      }
      
      let statusHtml = '';
      if (order.cancelledAt) {
        statusHtml = '<span class="order-status cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>';
      } else if (order.completedAt) {
        statusHtml = '<span class="order-status completed">æä¾›æ¸ˆã¿</span>';
      } else {
        statusHtml = '<span class="order-status pending">èª¿ç†ä¸­</span>';
      }
      
      let itemsHtml = '';
      if (order.items && Array.isArray(order.items)) {
        order.items.forEach(item => {
          const subtotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
          itemsHtml += `
            <div class="order-item">
              <div>
                <div class="item-name">${item.name}</div>
                <div class="item-details">æ•°é‡: ${item.quantity}å€‹ | ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${item.toppings || 'ãªã—'}</div>
              </div>
              <div class="item-price">Â¥${subtotal.toLocaleString()}</div>
            </div>
          `;
        });
      }
      
      card.innerHTML = `
        <div class="order-header">
          <div>
            <span class="order-number">#${order.orderNumber || '---'}</span>
            ${statusHtml}
          </div>
          <div class="order-time">${timeStr}</div>
        </div>
        <div class="order-items">
          ${itemsHtml}
        </div>
        <div class="order-total">
          <span class="total-label">å°è¨ˆ:</span>
          <span class="total-amount">Â¥${(order.totalAmount || 0).toLocaleString()}</span>
        </div>
      `;
      
      return card;
    }
    
    // æ”¯æ‰•ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showPaymentModal = function() {
      if (currentOrders.length === 0) {
        alert('ä¼šè¨ˆã™ã‚‹æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      document.getElementById('paymentModal').classList.remove('hidden');
      selectedPaymentMethod = null;
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('completePaymentBtn').disabled = true;
    };
    
    // æ”¯æ‰•ã„æ–¹æ³•é¸æŠ
    window.selectPaymentMethod = function(method) {
      selectedPaymentMethod = method;
      
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');
      
      if (method === 'cash') {
        document.getElementById('cashInputSection').classList.remove('hidden');
        document.getElementById('completePaymentBtn').disabled = true;
      } else {
        document.getElementById('cashInputSection').classList.add('hidden');
        document.getElementById('completePaymentBtn').disabled = false;
      }
    };
    
    // ãŠã¤ã‚Šè¨ˆç®—
    window.calculateChange = function() {
      cashReceived = parseInt(document.getElementById('cashReceived').value) || 0;
      changeAmount = cashReceived - totalAmountToPay;
      
      document.getElementById('changeAmount').textContent = `Â¥${changeAmount.toLocaleString()}`;
      
      document.getElementById('completePaymentBtn').disabled = cashReceived < totalAmountToPay;
    };
    
    // ä¼šè¨ˆå®Œäº†
    window.completePayment = async function() {
      if (!selectedPaymentMethod) {
        alert('æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      if (selectedPaymentMethod === 'cash' && cashReceived < totalAmountToPay) {
        alert('ãŠé ã‹ã‚Šé‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
        return;
      }
      
      try {
        const now = Timestamp.now();
        
        // æ³¨æ–‡ç•ªå·ãƒªã‚¹ãƒˆã‚’å–å¾—
        const orderNumbers = currentOrders.map(o => o.orderNumber);
        
        // å…¨ã¦ã®æ³¨æ–‡ã«æ”¯æ‰•ã„æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
        for (const order of currentOrders) {
          await updateDoc(doc(db, 'orders', order.id), {
            paidAt: now,
            notifiedPaid: true,
            paymentMethod: selectedPaymentMethod
          });
        }
        
        // æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·ç”¨ï¼‰
        lastPaymentData = {
          tableNumber: selectedTable,
          orderNumbers: orderNumbers,
          items: currentOrders.flatMap(o => o.items),
          totalAmount: totalAmountToPay,
          paymentMethod: selectedPaymentMethod,
          cashReceived: selectedPaymentMethod === 'cash' ? cashReceived : totalAmountToPay,
          change: selectedPaymentMethod === 'cash' ? changeAmount : 0,
          timestamp: new Date()
        };
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closePaymentModal();
        
        // è‡ªå‹•å°åˆ·ãŒæœ‰åŠ¹ãªã‚‰å°åˆ·
        if (autoPrintEnabled) {
          await printReceipt();
        } else {
          // ãƒ¬ã‚·ãƒ¼ãƒˆå®Œäº†ç”»é¢ã‚’è¡¨ç¤º
          document.getElementById('receiptCompleteModal').classList.remove('hidden');
        }
        
        // è¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
        await loadOrders(selectedTable);
        
      } catch (e) {
        console.error('ä¼šè¨ˆã‚¨ãƒ©ãƒ¼:', e);
        alert('ä¼šè¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // æ”¯æ‰•ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
      document.getElementById('cashReceived').value = '';
      calculateChange();
    };
    
    // ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·ï¼ˆ58mmå¹…å¯¾å¿œï¼‰
    window.printReceipt = async function() {
      if (!lastPaymentData) {
        alert('å°åˆ·ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        // 58mmå¹…è¨­å®š
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        // ãƒ¬ã‚·ãƒ¼ãƒˆä½œæˆ
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: 'ç²‰ã‚‚ã‚“å±‹ å…«\n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createTextElement({data: 'ä¸‹èµ¤å¡šåº—\n'});
        builder.createTextElement({data: 'æ±äº¬éƒ½æ¿æ©‹åŒºèµ¤å¡šæ–°ç”º\n'});
        builder.createTextElement({data: 'TEL: 03-XXXX-XXXX\n'});
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createAlignmentElement({position: 'left'});
        const now = lastPaymentData.timestamp;
        const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        builder.createTextElement({data: `æ—¥æ™‚: ${dateStr}\n`});
        builder.createTextElement({data: `æ‹…å½“: ãƒ¬ã‚¸ä¿‚\n`});
        builder.createTextElement({data: `ãƒ†ãƒ¼ãƒ–ãƒ«: ${lastPaymentData.tableNumber}\n`});
        builder.createTextElement({data: `æ³¨æ–‡No: ${lastPaymentData.orderNumbers.join(',')}\n`});
        builder.createRuledLineElement({thickness: 'thin'});
        
        // å•†å“æ˜ç´°
        let itemCount = 0;
        let tax8Total = 0;
        let tax10Total = 0;
        
        lastPaymentData.items.forEach(item => {
          const subtotal = item.price * item.quantity;
          itemCount += item.quantity;
          
          // ç¨ç‡åˆ¥é›†è¨ˆ
          if (item.taxRate === 8) {
            tax8Total += subtotal;
          } else {
            tax10Total += subtotal;
          }
          
          // å•†å“åã‚’32æ–‡å­—ä»¥å†…ã«èª¿æ•´
          const itemName = item.name.length > 16 ? item.name.substring(0, 15) + 'â€¦' : item.name;
          builder.createTextElement({data: `${itemName}\n`});
          
          // å˜ä¾¡Ã—æ•°é‡ï¼å°è¨ˆã®å½¢å¼ï¼ˆ58mmå¹…ã«æœ€é©åŒ–ï¼‰
          const priceInfo = `@${item.price} x${item.quantity}`;
          const subtotalStr = `${subtotal.toLocaleString()}å††`;
          const spaces = ' '.repeat(Math.max(1, 32 - priceInfo.length - subtotalStr.length));
          builder.createTextElement({data: `${priceInfo}${spaces}${subtotalStr}\n`});
          
          if (item.toppings && item.toppings !== 'ãªã—') {
            builder.createTextElement({data: ` TP:${item.toppings}\n`});
          }
        });
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createTextElement({data: `å°è¨ˆ${' '.repeat(20)}${lastPaymentData.totalAmount.toLocaleString()}å††\n`});
        builder.createTextElement({data: `ç‚¹æ•°: ${itemCount}ç‚¹\n`});
        builder.createRuledLineElement({thickness: 'thin'});
        
        // ç¨é¡è¨ˆç®—
        const tax8Amount = Math.floor(tax8Total * 8 / 108);
        const tax10Amount = Math.floor(tax10Total * 10 / 110);
        
        if (tax8Total > 0) {
          builder.createTextElement({data: `8%å¯¾è±¡${' '.repeat(16)}${tax8Total.toLocaleString()}å††\n`});
          builder.createTextElement({data: `(å†…æ¶ˆè²»ç¨${' '.repeat(15)}${tax8Amount.toLocaleString()}å††)\n`});
        }
        if (tax10Total > 0) {
          builder.createTextElement({data: `10%å¯¾è±¡${' '.repeat(15)}${tax10Total.toLocaleString()}å††\n`});
          builder.createTextElement({data: `(å†…æ¶ˆè²»ç¨${' '.repeat(15)}${tax10Amount.toLocaleString()}å††)\n`});
        }
        
        builder.createRuledLineElement({thickness: 'medium'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `åˆè¨ˆ ${lastPaymentData.totalAmount.toLocaleString()}å††\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createRuledLineElement({thickness: 'medium'});
        
        // æ”¯æ‰•ã„æƒ…å ±
        let paymentMethodStr = '';
        if (lastPaymentData.paymentMethod === 'cash') {
          paymentMethodStr = 'ç¾é‡‘';
          builder.createTextElement({data: `ãŠé ã‚Š${' '.repeat(18)}${lastPaymentData.cashReceived.toLocaleString()}å††\n`});
          builder.createTextElement({data: `ãŠã¤ã‚Š${' '.repeat(18)}${lastPaymentData.change.toLocaleString()}å††\n`});
        } else if (lastPaymentData.paymentMethod === 'emoney') {
          paymentMethodStr = 'é›»å­ãƒãƒãƒ¼';
        } else if (lastPaymentData.paymentMethod === 'credit') {
          paymentMethodStr = 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰';
        }
        builder.createTextElement({data: `æ”¯æ‰•: ${paymentMethodStr}\n`});
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({data: '\nã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ\n'});
        builder.createTextElement({data: 'ã¾ãŸã®ã”æ¥åº—ã‚’\n'});
        builder.createTextElement({data: 'ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™\n\n\n'});
        
        builder.createCutPaperElement({feed: true});
        
        const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
        
        const trader = new StarWebPrintTrader({url: url});
        trader.onReceive = function(response) {
          console.log('å°åˆ·æˆåŠŸ:', response);
          alert('ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å°åˆ·ã—ã¾ã—ãŸ');
          closeReceiptModal();
        };
        trader.onError = function(response) {
          console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', response);
          alert('å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.status);
        };
        
        trader.sendMessage({request: request});
        
      } catch (e) {
        console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        alert('å°åˆ·å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // é ˜åæ›¸å°åˆ·ï¼ˆå°é‘‘æ¬„ä»˜ããƒ»58mmå¹…å¯¾å¿œï¼‰
    window.printInvoice = async function() {
      if (!lastPaymentData) {
        alert('å°åˆ·ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        // 58mmå¹…è¨­å®š
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: 'é ˜ å æ›¸\n\n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        builder.createAlignmentElement({position: 'left'});
        const now = lastPaymentData.timestamp;
        const dateStr = `${now.getFullYear()}å¹´${String(now.getMonth()+1).padStart(2,'0')}æœˆ${String(now.getDate()).padStart(2,'0')}æ—¥`;
        builder.createTextElement({data: `${dateStr}\n\n`});
        
        builder.createTextElement({data: 'ãŠå®¢æ§˜\n\n'});
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `Â¥${lastPaymentData.totalAmount.toLocaleString()}-\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createAlignmentElement({position: 'left'});
        builder.createTextElement({data: '\nä¸Šè¨˜æ­£ã«é ˜åã„ãŸã—ã¾ã—ãŸ\n\n'});
        builder.createTextElement({data: 'ä½†ã— é£²é£Ÿä»£ã¨ã—ã¦\n\n\n'});
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createAlignmentElement({position: 'right'});
        builder.createTextElement({data: 'ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—\n'});
        builder.createTextElement({data: 'æ±äº¬éƒ½æ¿æ©‹åŒºèµ¤å¡šæ–°ç”º\n'});
        builder.createTextElement({data: 'TEL: 03-XXXX-XXXX\n\n'});
        
        // å°é‘‘æ¬„ã‚’ä½œæˆï¼ˆãƒ†ã‚­ã‚¹ãƒˆã§â—¯ã‚’æç”»ï¼‰
        builder.createAlignmentElement({position: 'right'});
        builder.createTextElement({data: '        â—¯â—¯â—¯\n'});
        builder.createTextElement({data: '       â—¯   â—¯\n'});
        builder.createTextElement({data: '      â—¯  å° â—¯\n'});
        builder.createTextElement({data: '       â—¯   â—¯\n'});
        builder.createTextElement({data: '        â—¯â—¯â—¯\n\n'});
        
        builder.createAlignmentElement({position: 'left'});
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createTextElement({data: `\nãƒ†ãƒ¼ãƒ–ãƒ«: ${lastPaymentData.tableNumber}\n`});
        builder.createTextElement({data: `æ³¨æ–‡No: ${lastPaymentData.orderNumbers.join(',')}\n`});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({data: '\n\n'});
        
        builder.createCutPaperElement({feed: true});
        
        const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
        
        const trader = new StarWebPrintTrader({url: url});
        trader.onReceive = function(response) {
          console.log('å°åˆ·æˆåŠŸ:', response);
          alert('é ˜åæ›¸ã‚’å°åˆ·ã—ã¾ã—ãŸ');
          closeReceiptModal();
        };
        trader.onError = function(response) {
          console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', response);
          alert('å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.status);
        };
        
        trader.sendMessage({request: request});
        
      } catch (e) {
        console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        alert('å°åˆ·å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ãƒ¬ã‚·ãƒ¼ãƒˆå®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeReceiptModal = function() {
      document.getElementById('receiptCompleteModal').classList.add('hidden');
      clearSelection();
    };
    
    // é¸æŠã‚’ã‚¯ãƒªã‚¢
    window.clearSelection = function() {
      selectedTable = null;
      currentOrders = [];
      document.getElementById('orderSection').classList.add('hidden');
    };
  </script>
</body>
</html>
