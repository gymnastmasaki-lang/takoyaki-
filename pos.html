<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç²‰ã‚‚ã‚“å±‹ å…« - ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ </title>
  
  <!-- Star mC-Print3 SDK -->
  <script src="https://www.star-m.jp/products/s_print/sdk/starwebprinttracer/v1.1.0/StarWebPrintTrader.js"></script>
  <script src="https://www.star-m.jp/products/s_print/sdk/starwebprintbuilder/v1.2.0/StarWebPrintBuilder.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc, doc, Timestamp, onSnapshot, addDoc, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    
    // Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆ
    console.log('ğŸ”¥ FirebaseåˆæœŸåŒ–å®Œäº†');
    console.log('ğŸ“¦ Project ID:', firebaseConfig.projectId);
    console.log('ğŸŒ Auth Domain:', firebaseConfig.authDomain);
    
    // åŒ¿åèªè¨¼
    async function authenticateUser() {
      try {
        console.log('ğŸ” åŒ¿åèªè¨¼ã‚’é–‹å§‹...');
        const userCredential = await signInAnonymously(auth);
        console.log('âœ… åŒ¿åèªè¨¼æˆåŠŸ:', userCredential.user.uid);
        isAuthenticated = true;
        return true;
      } catch (error) {
        console.error('âŒ èªè¨¼ã‚¨ãƒ©ãƒ¼:', error);
        console.error('ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:', error.code);
        console.error('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', error.message);
        return false;
      }
    }
    
    // èªè¨¼çŠ¶æ…‹ã®ç›£è¦–
    onAuthStateChanged(auth, (user) => {
      if (user) {
        console.log('ğŸ‘¤ èªè¨¼æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼:', user.uid);
        isAuthenticated = true;
      } else {
        console.log('âŒ æœªèªè¨¼');
        isAuthenticated = false;
      }
    });
    
    // æ¥ç¶šãƒ†ã‚¹ãƒˆç”¨ã®ç°¡å˜ãªã‚¯ã‚¨ãƒª
    async function testFirebaseConnection() {
      try {
        console.log('ğŸ” Firebaseæ¥ç¶šãƒ†ã‚¹ãƒˆé–‹å§‹...');
        const testQuery = query(collection(db, 'menu'), limit(1));
        const testSnapshot = await getDocs(testQuery);
        console.log('âœ… Firebaseæ¥ç¶šæˆåŠŸï¼', 'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå–å¾—:', testSnapshot.size);
        return true;
      } catch (e) {
        console.error('âŒ Firebaseæ¥ç¶šå¤±æ•—:', e);
        console.error('ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:', e.code);
        console.error('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', e.message);
        return false;
      }
    }
    
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.updateDoc = updateDoc;
    window.doc = doc;
    window.Timestamp = Timestamp;
    window.onSnapshot = onSnapshot;
    window.addDoc = addDoc;
    window.orderBy = orderBy;
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1600px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .header-left h1 {
      font-size: 32px;
      color: #333;
      margin-bottom: 5px;
    }
    
    .header-left .status {
      font-size: 18px;
      color: #666;
    }
    
    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .auto-print-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #f8f9fa;
      padding: 12px 20px;
      border-radius: 12px;
    }
    
    .auto-print-toggle label {
      font-weight: bold;
      color: #333;
    }
    
    .toggle-switch {
      position: relative;
      width: 60px;
      height: 30px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 30px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 4px;
      bottom: 4px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: #4CAF50;
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(30px);
    }
    
    .toggle-status {
      font-weight: bold;
      min-width: 50px;
    }
    
    .toggle-status.on {
      color: #4CAF50;
    }
    
    .toggle-status.off {
      color: #999;
    }
    
    .sales-summary {
      background: #f8f9fa;
      padding: 15px 20px;
      border-radius: 12px;
      display: flex;
      gap: 30px;
      align-items: center;
    }
    
    .sales-item {
      text-align: center;
    }
    
    .sales-label {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .sales-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }
    
    .sales-value.highlight {
      color: #4CAF50;
    }
    
    .btn-settlement {
      padding: 12px 30px;
      font-size: 16px;
      font-weight: bold;
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
      transition: all 0.3s;
    }
    
    .btn-settlement:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(255, 152, 0, 0.6);
    }
    
    .btn-monthly {
      padding: 12px 30px;
      font-size: 16px;
      font-weight: bold;
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
      transition: all 0.3s;
    }
    
    .btn-monthly:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
    }
    
    .btn-drawer {
      padding: 12px 30px;
      font-size: 16px;
      font-weight: bold;
      background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
      color: white;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(156, 39, 176, 0.4);
      transition: all 0.3s;
    }
    
    .btn-drawer:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(156, 39, 176, 0.6);
    }
    
    .btn-drawer:active {
      transform: translateY(0);
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 25px;
    }
    
    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
      }
      
      .header {
        flex-direction: column;
      }
    }
    
    .section {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }
    
    .section h2 {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #667eea;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚°ãƒªãƒƒãƒ‰ */
    .table-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }
    
    @media (max-width: 768px) {
      .table-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    .table-btn {
      padding: 20px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      position: relative;
    }
    
    .table-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    .table-btn:active {
      transform: translateY(0);
    }
    
    .table-btn.has-orders::after {
      content: '';
      position: absolute;
      top: 8px;
      right: 8px;
      width: 12px;
      height: 12px;
      background: #ff4444;
      border-radius: 50%;
      border: 2px solid white;
      animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    
    /* æ³¨æ–‡è©³ç´° */
    .order-details {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .order-card {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      border-left: 5px solid #667eea;
      position: relative;
    }
    
    .order-card.completed {
      border-left-color: #4CAF50;
      opacity: 0.7;
    }
    
    .order-card.cancelled {
      border-left-color: #f44336;
      opacity: 0.7;
    }
    
    .order-card.discounted {
      border-left-color: #FF9800;
    }
    
    .discount-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #FF9800;
      color: white;
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .order-number {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    
    .order-time {
      font-size: 14px;
      color: #999;
    }
    
    .order-status {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      margin-left: 10px;
    }
    
    .order-status.pending {
      background: #fff3cd;
      color: #856404;
    }
    
    .order-status.completed {
      background: #d4edda;
      color: #155724;
    }
    
    .order-status.cancelled {
      background: #f8d7da;
      color: #721c24;
    }
    
    .order-items {
      margin: 15px 0;
    }
    
    .order-item {
      padding: 10px 0;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .order-item:last-child {
      border-bottom: none;
    }
    
    .item-name {
      font-weight: 500;
      color: #333;
    }
    
    .item-details {
      font-size: 14px;
      color: #666;
      margin-top: 5px;
    }
    
    .item-price {
      font-weight: bold;
      color: #667eea;
    }
    
    .order-total {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 3px solid #667eea;
      font-size: 24px;
      font-weight: bold;
    }
    
    .total-label {
      color: #333;
    }
    
    .total-amount {
      color: #667eea;
      font-size: 28px;
    }
    
    .discount-info {
      color: #FF9800;
      font-size: 16px;
      margin-top: 5px;
      text-decoration: line-through;
    }
    
    /* ãƒœã‚¿ãƒ³ */
    .btn {
      width: 100%;
      padding: 18px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      margin: 8px 0;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #f44336 0%, #da190b 100%);
      color: white;
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .button-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    
    /* æ‰‹å‹•å…¥åŠ›ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
    .manual-input {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-group label {
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
    }
    
    .input-group input,
    .input-group select {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      transition: border-color 0.3s;
    }
    
    .input-group input:focus,
    .input-group select:focus {
      outline: none;
      border-color: #667eea;
    }
    
    .menu-items-list {
      max-height: 400px;
      overflow-y: auto;
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 10px;
      background: white;
    }
    
    .menu-item-card {
      background: white;
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .menu-item-card:hover {
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
      transform: translateY(-2px);
    }
    
    .menu-item-card:active {
      transform: scale(0.98);
    }
    
    .menu-item-card.sold-out {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f5f5f5;
    }
    
    .menu-item-card.sold-out::after {
      content: 'å“åˆ‡ã‚Œ';
      position: absolute;
      top: 8px;
      right: 8px;
      background: #f44336;
      color: white;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .menu-item-image-small {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 8px;
      flex-shrink: 0;
    }
    
    .menu-item-content {
      flex: 1;
    }
    
    .menu-item-name {
      font-weight: bold;
      font-size: 16px;
      color: #333;
      margin-bottom: 5px;
    }
    
    .menu-item-price {
      font-size: 18px;
      font-weight: bold;
      color: #667eea;
    }
    
    .menu-item-note {
      font-size: 12px;
      color: #999;
      margin-top: 3px;
    }
    
    /* ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒªã‚¹ãƒˆ */
    .topping-list {
      display: grid;
      gap: 12px;
      margin: 20px 0;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .topping-item {
      padding: 15px;
      border: 3px solid #e0e0e0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      font-size: 16px;
    }
    
    .topping-item.selected {
      background: #e8f5e9;
      border-color: #4CAF50;
      font-weight: bold;
    }
    
    .topping-item:active {
      transform: scale(0.98);
    }
    
    .topping-price {
      color: #667eea;
      font-weight: bold;
    }
    
    .selected-items {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .selected-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    
    .quantity-input {
      width: 60px;
      padding: 5px;
      text-align: center;
      border: 2px solid #ddd;
      border-radius: 5px;
    }
    
    .remove-btn {
      padding: 5px 12px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 14px;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 18px;
    }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal h3 {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .payment-methods {
      display: grid;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .payment-method-btn {
      padding: 20px;
      font-size: 20px;
      font-weight: bold;
      border: 3px solid #ddd;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .payment-method-btn:hover {
      border-color: #667eea;
      background: #f8f9fa;
    }
    
    .payment-method-btn.selected {
      border-color: #667eea;
      background: #e8eaf6;
    }
    
    .cash-input-section {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    
    .cash-input-section label {
      display: block;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
      font-size: 18px;
    }
    
    .cash-input-section input {
      width: 100%;
      padding: 15px;
      font-size: 24px;
      border: 2px solid #ddd;
      border-radius: 8px;
      text-align: right;
    }
    
    .change-display {
      margin-top: 15px;
      padding: 15px;
      background: #fff;
      border-radius: 8px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    
    .change-amount {
      color: #4CAF50;
      font-size: 28px;
    }
    
    /* å€¤å¼•ããƒ¢ãƒ¼ãƒ€ãƒ« */
    .discount-input-section {
      margin: 20px 0;
    }
    
    .discount-input-section input {
      width: 100%;
      padding: 15px;
      font-size: 24px;
      border: 2px solid #ddd;
      border-radius: 8px;
      text-align: right;
    }
    
    .discount-preview {
      margin-top: 15px;
      padding: 15px;
      background: #fff3cd;
      border-radius: 8px;
    }
    
    .discount-preview-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-size: 18px;
    }
    
    .discount-preview-item.total {
      font-weight: bold;
      font-size: 20px;
      padding-top: 10px;
      border-top: 2px solid #ddd;
      color: #FF9800;
    }
    
    /* ç²¾ç®—ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .settlement-details {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .settlement-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #ddd;
    }
    
    .settlement-row:last-child {
      border-bottom: none;
    }
    
    .settlement-row.highlight {
      font-weight: bold;
      font-size: 20px;
      color: #4CAF50;
      padding-top: 15px;
      border-top: 3px solid #4CAF50;
    }
    
    .settlement-label {
      color: #666;
    }
    
    .settlement-value {
      color: #333;
      font-weight: bold;
    }
    
    /* æ—¥ä»˜é¸æŠ */
    .date-selector {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .date-selector label {
      font-weight: bold;
      color: #333;
    }
    
    .date-selector select {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
    }
    
    /* æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆ */
    .month-selector {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 12px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .month-selector label {
      font-weight: bold;
      color: #333;
    }
    
    .month-selector select {
      flex: 1;
      padding: 10px;
      font-size: 16px;
      border: 2px solid #ddd;
      border-radius: 8px;
      background: white;
    }
    
    .monthly-details {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .monthly-section {
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 2px solid #ddd;
    }
    
    .monthly-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    
    .monthly-section-title {
      font-size: 18px;
      font-weight: bold;
      color: #4CAF50;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px solid #4CAF50;
    }
    
    .monthly-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
    }
    
    .monthly-row.highlight {
      font-weight: bold;
      font-size: 20px;
      color: #4CAF50;
      padding-top: 15px;
      border-top: 3px solid #4CAF50;
      margin-top: 10px;
    }
    
    .monthly-label {
      color: #666;
    }
    
    .monthly-value {
      color: #333;
      font-weight: bold;
    }
    
    .daily-breakdown {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }
    
    .daily-item {
      background: white;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
    }
    
    .daily-date {
      font-size: 12px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .daily-amount {
      font-size: 16px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    /* ãƒ¬ã‚·ãƒ¼ãƒˆå®Œäº†ç”»é¢ */
    .receipt-actions {
      display: grid;
      gap: 15px;
      margin-top: 20px;
    }
    
    .receipt-btn {
      padding: 20px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .receipt-btn.print {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
    }
    
    .receipt-btn.invoice {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
    }
    
    .receipt-btn.back {
      background: #e0e0e0;
      color: #333;
    }
    
    /* æ³¨æ–‡ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    .order-action-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .btn-info {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
    }
    
    /* é¸æŠãƒ¢ãƒ¼ãƒ‰ */
    .order-card.selection-mode {
      cursor: pointer;
      position: relative;
    }
    
    .order-card.selection-mode:hover {
      background: #f0f8ff;
    }
    
    .order-item-checkbox {
      position: absolute;
      top: 15px;
      right: 15px;
      width: 24px;
      height: 24px;
      cursor: pointer;
    }
    
    .order-item.selectable {
      cursor: pointer;
      position: relative;
      padding-right: 40px;
    }
    
    .order-item.selectable:hover {
      background: #f0f8ff;
      border-radius: 8px;
    }
    
    .order-item.selected {
      background: #e3f2fd;
      border-radius: 8px;
    }
    
    .item-checkbox {
      position: absolute;
      top: 50%;
      right: 10px;
      transform: translateY(-50%);
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .selected-items-info {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 16px;
      font-weight: bold;
      color: #1976D2;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«çµåˆãƒªã‚¹ãƒˆ */
    .table-merge-list {
      max-height: 400px;
      overflow-y: auto;
      margin: 20px 0;
    }
    
    .table-merge-item {
      padding: 15px;
      margin-bottom: 12px;
      border: 3px solid #e0e0e0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      background: white;
    }
    
    .table-merge-item:hover {
      border-color: #2196F3;
      background: #f0f8ff;
    }
    
    .table-merge-item.selected {
      border-color: #2196F3;
      background: #e3f2fd;
    }
    
    .table-merge-item.current {
      border-color: #4CAF50;
      background: #e8f5e9;
    }
    
    .merge-table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      font-weight: bold;
      font-size: 18px;
    }
    
    .merge-table-name {
      color: #333;
    }
    
    .merge-table-amount {
      color: #2196F3;
      font-size: 20px;
    }
    
    .merge-order-count {
      font-size: 14px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .merge-order-numbers {
      font-size: 13px;
      color: #999;
    }
    
    .hidden {
      display: none !important;
    }
    
    .loading {
      text-align: center;
      padding: 20px;
      color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
      <div class="header-left">
        <h1>ğŸ§¾ ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ </h1>
        <div class="status">ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—</div>
      </div>
      <div class="header-right">
        <div class="sales-summary">
          <div class="sales-item">
            <div class="sales-label">å®¢æ•°</div>
            <div class="sales-value" id="customerCount">0</div>
          </div>
          <div class="sales-item">
            <div class="sales-label">æœ¬æ—¥å£²ä¸Š</div>
            <div class="sales-value highlight" id="todaySales">Â¥0</div>
          </div>
        </div>
        <button class="btn-drawer" onclick="openDrawer()">ğŸ’° ãƒ‰ãƒ­ã‚¢é–‹</button>
        <button class="btn-settlement" onclick="showHistory()">ğŸ“œ å±¥æ­´</button>
        <button class="btn-settlement" onclick="showSettlementModal()">ğŸ“Š ç²¾ç®—</button>
        <button class="btn-monthly" onclick="showMonthlyReportModal()">ğŸ“… æœˆæ¬¡</button>
        <div class="auto-print-toggle">
          <label>ãƒ¬ã‚·ãƒ¼ãƒˆè‡ªå‹•ç™ºè¡Œ</label>
          <label class="toggle-switch">
            <input type="checkbox" id="autoPrintToggle" checked onchange="toggleAutoPrint()">
            <span class="toggle-slider"></span>
          </label>
          <span class="toggle-status on" id="autoPrintStatus">ON</span>
        </div>
      </div>
    </div>
    
    <div class="main-content">
      <!-- å·¦å´: ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠã¨æ³¨æ–‡è©³ç´° -->
      <div class="section">
        <h2>ğŸ“‹ ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠ</h2>
        <div class="table-grid" id="tableGrid">
          <!-- JavaScriptã§ç”Ÿæˆ -->
        </div>
        
        <div id="orderSection" class="hidden">
          <h2>ğŸ“ æ³¨æ–‡è©³ç´° - <span id="selectedTableLabel"></span></h2>
          
          <div class="order-action-buttons">
            <button class="btn btn-info" onclick="showTableMergeModal()">ğŸ”— ãƒ†ãƒ¼ãƒ–ãƒ«çµåˆ</button>
            <button class="btn btn-info" onclick="toggleSelectionMode()" id="selectionModeBtn">âœ… é¸æŠä¼šè¨ˆ</button>
          </div>
          
          <div id="ordersList">
            <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
          </div>
          
          <div id="totalSection" class="hidden">
            <div class="order-total">
              <span class="total-label">åˆè¨ˆé‡‘é¡:</span>
              <span class="total-amount" id="totalAmount">Â¥0</span>
            </div>
            <div id="selectedItemsInfo" class="selected-items-info hidden">
              <div>é¸æŠä¸­: <span id="selectedItemsCount">0</span>å€‹ / <span id="totalItemsCount">0</span>å€‹</div>
              <div>é¸æŠé‡‘é¡: <span id="selectedItemsAmount">Â¥0</span></div>
            </div>
            <div class="button-row">
              <button class="btn btn-warning" onclick="showDiscountModal()">ğŸ’° å€¤å¼•ã</button>
              <button class="btn btn-primary" onclick="showPaymentModal()" id="paymentBtn">ğŸ’³ ä¼šè¨ˆå‡¦ç†</button>
            </div>
            <button class="btn btn-secondary" onclick="clearSelection()">â† ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠã«æˆ»ã‚‹</button>
          </div>
        </div>
      </div>
      
      <!-- å³å´: æ‰‹å‹•å…¥åŠ› -->
      <div class="section">
        <h2>âœï¸ æ‰‹å‹•ãƒ¬ã‚¸å…¥åŠ›</h2>
        <div class="manual-input">
          <div class="input-group">
            <label>ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·</label>
            <select id="manualTable" onchange="updateManualTableSelection()">
              <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
            </select>
          </div>
          
          <div class="input-group">
            <label>ã‚«ãƒ†ã‚´ãƒªé¸æŠ</label>
            <select id="manualCategorySelect" onchange="filterManualMenu()">
              <option value="all">å…¨ã¦ã®å•†å“</option>
            </select>
          </div>
          
          <div class="input-group">
            <label>å•†å“ã‚’é¸æŠ</label>
            <div class="menu-items-list" id="menuItemsList">
              <div class="loading">ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
          </div>
          
          <div class="selected-items" id="selectedItems">
            <div class="empty-state">å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
          </div>
          
          <div class="input-group">
            <label>åˆè¨ˆé‡‘é¡: <span id="manualTotal" style="color: #667eea; font-size: 20px;">Â¥0</span></label>
          </div>
          
          <button class="btn btn-primary" onclick="submitManualOrder()" id="manualSubmitBtn" disabled>æ³¨æ–‡ã‚’è¿½åŠ </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="toppingModal" class="modal-overlay hidden">
    <div class="modal">
      <h3 id="toppingModalTitle">ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’é¸æŠ</h3>
      <div id="toppingList" class="topping-list">
        <!-- JavaScriptã§ç”Ÿæˆ -->
      </div>
      <button class="btn btn-primary" onclick="confirmToppingSelection()">ã‚«ãƒ¼ãƒˆã«è¿½åŠ </button>
      <button class="btn btn-secondary" onclick="closeToppingModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  
  <!-- æ”¯æ‰•ã„æ–¹æ³•é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ’³ æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠ</h3>
      <div class="payment-methods">
        <button class="payment-method-btn" onclick="selectPaymentMethod('cash')">
          ğŸ’µ ç¾é‡‘
        </button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('emoney')">
          ğŸ“± é›»å­ãƒãƒãƒ¼
        </button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('credit')">
          ğŸ’³ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰
        </button>
      </div>
      
      <div id="cashInputSection" class="cash-input-section hidden">
        <label>ãŠé ã‹ã‚Šé‡‘é¡</label>
        <input type="number" id="cashReceived" placeholder="0" oninput="calculateChange()">
        <div class="change-display" id="changeDisplay">
          ãŠã¤ã‚Š: <span class="change-amount" id="changeAmount">Â¥0</span>
        </div>
      </div>
      
      <button class="btn btn-primary" onclick="completePayment()" id="completePaymentBtn" disabled>ä¼šè¨ˆå®Œäº†</button>
      <button class="btn btn-secondary" onclick="closePaymentModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  
  <!-- å€¤å¼•ããƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="discountModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ’° å€¤å¼•ãè¨­å®š</h3>
      <div class="discount-input-section">
        <label>å€¤å¼•ãé‡‘é¡ã‚’å…¥åŠ›</label>
        <input type="number" id="discountAmount" placeholder="0" oninput="updateDiscountPreview()">
      </div>
      
      <div class="discount-preview" id="discountPreview">
        <div class="discount-preview-item">
          <span>å…ƒã®é‡‘é¡:</span>
          <span id="originalAmount">Â¥0</span>
        </div>
        <div class="discount-preview-item">
          <span>å€¤å¼•ãé¡:</span>
          <span id="discountValue">-Â¥0</span>
        </div>
        <div class="discount-preview-item total">
          <span>å€¤å¼•ãå¾Œ:</span>
          <span id="discountedAmount">Â¥0</span>
        </div>
      </div>
      
      <button class="btn btn-warning" onclick="applyDiscount()">å€¤å¼•ãé©ç”¨</button>
      <button class="btn btn-secondary" onclick="closeDiscountModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  
  <!-- ç²¾ç®—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="settlementModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ“Š ç²¾ç®—</h3>
      
      <div class="date-selector">
        <label>ç²¾ç®—æ—¥ã‚’é¸æŠ:</label>
        <select id="settlementDateSelect" onchange="loadSettlementData()">
          <!-- JavaScriptã§ç”Ÿæˆ -->
        </select>
      </div>
      
      <div class="settlement-details" id="settlementDetails">
        <div class="loading">è¨ˆç®—ä¸­...</div>
      </div>
      <button class="btn btn-primary" onclick="printSettlement()">ğŸ–¨ï¸ ç²¾ç®—ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·</button>
      <button class="btn btn-secondary" onclick="closeSettlementModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  
  <!-- æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="monthlyReportModal" class="modal-overlay hidden">
    <div class="modal" style="max-width: 800px;">
      <h3>ğŸ“… æœˆæ¬¡å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ</h3>
      
      <div class="month-selector">
        <label>è¡¨ç¤ºæœˆã‚’é¸æŠ:</label>
        <select id="monthSelect" onchange="loadMonthlyReport()">
          <!-- JavaScriptã§ç”Ÿæˆ -->
        </select>
      </div>
      
      <div class="monthly-details" id="monthlyDetails">
        <div class="loading">è¨ˆç®—ä¸­...</div>
      </div>
      
      <button class="btn btn-primary" onclick="printMonthlyReport()">ğŸ–¨ï¸ æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆå°åˆ·</button>
      <button class="btn btn-secondary" onclick="closeMonthlyReportModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  
  <!-- ãƒ¬ã‚·ãƒ¼ãƒˆå®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="receiptCompleteModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>âœ… ä¼šè¨ˆå®Œäº†</h3>
      <div style="text-align: center; margin: 20px 0; font-size: 18px; color: #4CAF50;">
        ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸ
      </div>
      <div class="receipt-actions">
        <button class="receipt-btn print" onclick="printReceipt()">ğŸ–¨ï¸ ãƒ¬ã‚·ãƒ¼ãƒˆç™ºè¡Œ</button>
        <button class="receipt-btn invoice" onclick="printInvoice()">ğŸ“„ é ˜åæ›¸ç™ºè¡Œ</button>
        <button class="receipt-btn back" onclick="closeReceiptModal()">â† æˆ»ã‚‹</button>
      </div>
    </div>
  </div>
  
  <!-- ãƒ†ãƒ¼ãƒ–ãƒ«çµåˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="tableMergeModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ”— ãƒ†ãƒ¼ãƒ–ãƒ«çµåˆ</h3>
      <p style="text-align: center; margin-bottom: 20px; color: #666;">
        çµåˆã—ãŸã„ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„
      </p>
      <div class="table-merge-list" id="tableMergeList">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <button class="btn btn-primary" onclick="confirmTableMerge()" id="confirmMergeBtn" disabled>çµåˆã—ã¦ä¼šè¨ˆ</button>
      <button class="btn btn-secondary" onclick="closeTableMergeModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  
  <script>
    let selectedTable = null;
    let currentOrders = [];
    let menuItems = [];
    let allMenuItems = [];
    let allToppings = new Map();
    let currentToppingSelection = null;
    let selectedToppings = [];
    let manualCart = [];
    let autoPrintEnabled = true;
    let selectedPaymentMethod = null;
    let totalAmountToPay = 0;
    let cashReceived = 0;
    let changeAmount = 0;
    let lastPaymentData = null;
    let discountAmount = 0;
    let todaySalesData = {
      customerCount: 0,
      totalSales: 0,
      tax8Total: 0,
      tax10Total: 0,
      cashTotal: 0,
      emoneyTotal: 0,
      creditTotal: 0
    };
    
    // é¸æŠãƒ¢ãƒ¼ãƒ‰é–¢é€£
    let selectionMode = false;
    let selectedItems = new Set(); // é¸æŠã•ã‚ŒãŸå•†å“ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆorder-itemå˜ä½ï¼‰
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«çµåˆé–¢é€£
    let selectedTablesForMerge = new Set();
    let mergeMode = false;
    
    // èªè¨¼çŠ¶æ…‹
    let isAuthenticated = false;
    
    // ãƒ—ãƒªãƒ³ã‚¿ãƒ¼IPã‚¢ãƒ‰ãƒ¬ã‚¹
    const PRINTER_IP = '192.168.244.41';
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆç¨ç‡ä¿®æ­£ç‰ˆï¼‰
    // ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆï¼ˆ619-628ï¼‰: åŒ…æä»¥å¤–ã¯8%
    // åº—å†…ï¼ˆT-H, T-M, c1, c2ï¼‰: å…¨ã¦10%
    const MENU_DATA = [
      {id: 1, name: 'ãŠå¥½ã¿ç„¼ã(è±šç‰)', price: 600, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 8},
      {id: 2, name: 'ãŠå¥½ã¿ç„¼ã(ã‚¤ã‚«ç‰)', price: 600, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 8},
      {id: 3, name: 'ãŠå¥½ã¿ç„¼ã(ã‚¨ãƒ“ç‰)', price: 700, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 8},
      {id: 4, name: 'ãŠå¥½ã¿ç„¼ã(ç‰›ã™ã˜)', price: 700, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 8},
      {id: 5, name: 'ãŠå¥½ã¿ç„¼ã(ãƒŸãƒƒã‚¯ã‚¹)', price: 700, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 8},
      {id: 6, name: 'ãŠå¥½ã¿ç„¼ã(æ˜å¤ªå­)', price: 700, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 8},
      {id: 7, name: 'ãŠå¥½ã¿ç„¼ã(ãƒãƒ¼ã‚º)', price: 700, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 8},
      {id: 8, name: 'ãŠå¥½ã¿ç„¼ã(ãƒ¢ãƒ€ãƒ³)', price: 700, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 8},
      {id: 9, name: 'ãŠå¥½ã¿ç„¼ã(ãƒ‡ãƒ©ãƒƒã‚¯ã‚¹)', price: 800, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 8},
      {id: 10, name: 'ãŠå¥½ã¿ç„¼ã(ã‚¹ãƒšã‚·ãƒ£ãƒ«)', price: 900, category: 'ãŠå¥½ã¿ç„¼ã', taxRate: 8},
      {id: 11, name: 'ç„¼ããã°(ã‚½ãƒ¼ã‚¹)', price: 500, category: 'ç„¼ããã°', taxRate: 8},
      {id: 12, name: 'ç„¼ããã°(å¡©)', price: 500, category: 'ç„¼ããã°', taxRate: 8},
      {id: 13, name: 'ã¨ã‚“å¹³ç„¼ã', price: 500, category: 'ä¸€å“æ–™ç†', taxRate: 8},
      {id: 14, name: 'ã­ãç„¼ã', price: 500, category: 'ä¸€å“æ–™ç†', taxRate: 8},
      {id: 15, name: 'ãŸã“ç„¼ã(8å€‹)', price: 400, category: 'ãŸã“ç„¼ã', taxRate: 8},
      {id: 16, name: 'ãŸã“ç„¼ã(12å€‹)', price: 550, category: 'ãŸã“ç„¼ã', taxRate: 8},
      {id: 17, name: 'æè±†', price: 300, category: 'ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼', taxRate: 8},
      {id: 18, name: 'ã‚­ãƒ£ãƒ™ãƒ„ç„¼ã', price: 300, category: 'ã‚µã‚¤ãƒ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼', taxRate: 8},
      {id: 19, name: 'ç”Ÿãƒ“ãƒ¼ãƒ«(ä¸­)', price: 500, category: 'ãƒ‰ãƒªãƒ³ã‚¯', taxRate: 8},
      {id: 20, name: 'ãƒã‚¤ãƒœãƒ¼ãƒ«', price: 400, category: 'ãƒ‰ãƒªãƒ³ã‚¯', taxRate: 8},
      {id: 21, name: 'ã‚¦ãƒ¼ãƒ­ãƒ³èŒ¶', price: 200, category: 'ãƒ‰ãƒªãƒ³ã‚¯', taxRate: 8},
      {id: 22, name: 'ã‚³ãƒ¼ãƒ©', price: 200, category: 'ãƒ‰ãƒªãƒ³ã‚¯', taxRate: 8},
      {id: 23, name: 'åŒ…æ', price: 50, category: 'åŒ…æ', taxRate: 10}, // åŒ…æã¯å¸¸ã«10%
    ];
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©
    // ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆï¼ˆ619-628ï¼‰: åŒ…æä»¥å¤–8%ã€åŒ…æ10%
    // åº—å†…ï¼ˆT-H, T-M, c1, c2ï¼‰: å…¨ã¦10%
    const TABLES = [
      'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ',
      'c1', 'c2', 'T-H', 'T-M',
      'äºˆç´„1', 'äºˆç´„2', 'äºˆç´„3', 'äºˆç´„4', 'äºˆç´„5'
    ];
    
    // åˆæœŸåŒ–
    window.addEventListener('load', async () => {
      await initializeSystem();
    });
    
    async function initializeSystem() {
      console.log('ğŸš€ ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹...');
      
      // åŒ¿åèªè¨¼ã‚’è©¦è¡Œï¼ˆå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œï¼‰
      try {
        const authenticated = await authenticateUser();
        if (authenticated) {
          console.log('âœ… èªè¨¼æˆåŠŸ');
        } else {
          console.warn('âš ï¸ èªè¨¼å¤±æ•— - åŒ¿åãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œ');
        }
      } catch (e) {
        console.warn('âš ï¸ èªè¨¼ã‚¨ãƒ©ãƒ¼ - åŒ¿åãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œ:', e);
      }
      
      console.log('âœ… ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•');
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ã‚’ç”Ÿæˆ
      const tableGrid = document.getElementById('tableGrid');
      tableGrid.innerHTML = '';
      TABLES.forEach(table => {
        const btn = document.createElement('button');
        btn.className = 'table-btn';
        btn.textContent = table;
        btn.onclick = () => selectTable(table);
        btn.id = `table-${table}`;
        tableGrid.appendChild(btn);
      });
      
      // æ‰‹å‹•å…¥åŠ›ç”¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠè‚¢ã‚’ç”Ÿæˆ
      const manualTable = document.getElementById('manualTable');
      TABLES.forEach(table => {
        const option = document.createElement('option');
        option.value = table;
        option.textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${table}`;
        manualTable.appendChild(option);
      });
      
      // Firebaseã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿
      await loadMenuFromFirebase();
      
      // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹
      startRealtimeUpdates();
      
      // æœ¬æ—¥ã®å£²ä¸Šã‚’è¨ˆç®—
      await calculateTodaySales();
    }
    
    // Firebaseã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿
    async function loadMenuFromFirebase() {
      const container = document.getElementById('menuItemsList');
      
      try {
        console.log('ğŸ“‹ ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿é–‹å§‹');
        container.innerHTML = '<div class="loading">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>';
        
        // ãƒˆãƒƒãƒ”ãƒ³ã‚°èª­ã¿è¾¼ã¿
        const toppingsSnapshot = await getDocs(collection(db, 'toppings'));
        allToppings.clear();
        
        toppingsSnapshot.forEach(doc => {
          const data = doc.data();
          allToppings.set(doc.id, {
            id: doc.id,
            name: data.name,
            options: data.options || []
          });
        });
        
        console.log('âœ… ãƒˆãƒƒãƒ”ãƒ³ã‚°:', allToppings.size, 'ä»¶');
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿
        const menuSnapshot = await getDocs(collection(db, 'menu'));
        
        if (menuSnapshot.empty) {
          console.error('âŒ menuã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãŒç©ºã§ã™');
          container.innerHTML = '<div class="empty-state">âŒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }
        
        const items = [];
        const categories = new Set();
        
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          items.push({
            id: data.id,
            category: data.category,
            name: data.name,
            price: data.price,
            toppingsId: data.toppingsId,
            image: data.image || '',
            note: data.note || ''
          });
          categories.add(data.category);
        });
        
        items.sort((a, b) => {
          if (a.id < b.id) return -1;
          if (a.id > b.id) return 1;
          return 0;
        });
        
        allMenuItems = items;
        console.log('âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼:', items.length, 'ä»¶');
        console.log('ğŸ“‹ allToppings ã®å†…å®¹:');
        allToppings.forEach((value, key) => {
          console.log(`   ${key}:`, value);
        });
        console.log('ğŸ“‹ æœ€åˆã®5ã¤ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ :');
        items.slice(0, 5).forEach(item => {
          console.log(`   ${item.name} â†’ toppingsId: ${item.toppingsId || 'ãªã—'}`);
        });
        
        // ã‚«ãƒ†ã‚´ãƒªé¸æŠè‚¢ã‚’ç”Ÿæˆ
        const categorySelect = document.getElementById('manualCategorySelect');
        if (categorySelect) {
          categorySelect.innerHTML = '<option value="all">å…¨ã¦ã®å•†å“</option>';
          
          const sortedCategories = Array.from(categories).sort();
          sortedCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            categorySelect.appendChild(option);
          });
        }
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤º
        displayManualMenuItems(items);
        console.log('âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºå®Œäº†');
        
      } catch (e) {
        console.error('âŒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e.message);
        container.innerHTML = `
          <div class="empty-state" style="color: #f44336;">
            âŒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—<br><br>
            ${e.message}
          </div>
        `;
      }
    }
    
    // ã‚«ãƒ†ã‚´ãƒªã§ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
    window.filterManualMenu = function() {
      const category = document.getElementById('manualCategorySelect').value;
      
      if (category === 'all') {
        displayManualMenuItems(allMenuItems);
      } else {
        const filtered = allMenuItems.filter(item => item.category === category);
        displayManualMenuItems(filtered);
      }
    };
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼é …ç›®ã‚’è¡¨ç¤ºï¼ˆmenu.htmlé¢¨ï¼‰
    function displayManualMenuItems(items) {
      const container = document.getElementById('menuItemsList');
      
      if (!container) {
        console.error('âŒ menuItemsListè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      container.innerHTML = '';
      
      if (!items || items.length === 0) {
        container.innerHTML = '<div class="empty-state">å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
        return;
      }
      
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'menu-item-card';
        div.dataset.menuId = item.id;
        
        let imageHtml = '';
        if (item.image) {
          const imageSrc = item.image.includes('http') ? item.image : `images/${item.image}`;
          imageHtml = `<img src="${imageSrc}" class="menu-item-image-small" onerror="this.style.display='none'" alt="${item.name}">`;
        }
        
        let noteHtml = '';
        if (item.note) {
          noteHtml = `<div class="menu-item-note">${item.note}</div>`;
        }
        
        div.innerHTML = `
          ${imageHtml}
          <div class="menu-item-content">
            <div class="menu-item-name">${item.name}</div>
            <div class="menu-item-price">Â¥${item.price.toLocaleString()}</div>
            ${noteHtml}
          </div>
        `;
        
        div.onclick = () => selectManualItem(item);
        container.appendChild(div);
      });
    }
    
    // å•†å“é¸æŠï¼ˆãƒˆãƒƒãƒ”ãƒ³ã‚°ãŒã‚ã‚‹å ´åˆã¯ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºï¼‰
    window.selectManualItem = function(item) {
      console.log('ğŸ¯ å•†å“é¸æŠ:', item.name);
      console.log('   toppingsId:', item.toppingsId);
      
      // ãƒˆãƒƒãƒ”ãƒ³ã‚°IDãŒã‚ã‚Šã€ã‹ã¤allToppingsã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
      if (item.toppingsId) {
        console.log('   allToppings size:', allToppings.size);
        console.log('   allToppings has:', allToppings.has(item.toppingsId));
        
        if (allToppings.size > 0 && allToppings.has(item.toppingsId)) {
          console.log('âœ… ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚ã‚Š - ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º');
          currentToppingSelection = item;
          selectedToppings = [];
          showToppingModal(item);
          return;
        } else {
          console.log('âš ï¸ toppingsIdã¯ã‚ã‚‹ãŒã€allToppingsã«ãƒ‡ãƒ¼ã‚¿ãªã—');
        }
      }
      
      console.log('â¡ï¸ ãƒˆãƒƒãƒ”ãƒ³ã‚°ãªã— - ã‚«ãƒ¼ãƒˆã«ç›´æ¥è¿½åŠ ');
      // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãªã—ã®å ´åˆã¯ç›´æ¥è¿½åŠ 
      addToManualCart(item, 'ãªã—', 0);
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    function showToppingModal(item) {
      console.log('ğŸ´ ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºé–‹å§‹');
      
      const modal = document.getElementById('toppingModal');
      const title = document.getElementById('toppingModalTitle');
      const list = document.getElementById('toppingList');
      
      if (!modal || !title || !list) {
        console.error('âŒ ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', {modal: !!modal, title: !!title, list: !!list});
        return;
      }
      
      title.textContent = `${item.name} - ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠ`;
      list.innerHTML = '';
      
      const toppingData = allToppings.get(item.toppingsId);
      console.log('   ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿:', toppingData);
      
      if (!toppingData || !toppingData.options) {
        console.log('âš ï¸ ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ãªã— - ã‚«ãƒ¼ãƒˆã«ç›´æ¥è¿½åŠ ');
        addToManualCart(item, 'ãªã—', 0);
        return;
      }
      
      console.log('   ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠè‚¢æ•°:', toppingData.options.length);
      
      toppingData.options.forEach((option, index) => {
        const div = document.createElement('div');
        div.className = 'topping-item';
        div.dataset.index = index;
        
        const priceText = option.price > 0 ? `+Â¥${option.price}` : 'ç„¡æ–™';
        
        div.innerHTML = `
          <span>${option.name}</span>
          <span class="topping-price">${priceText}</span>
        `;
        
        div.onclick = () => toggleTopping(index, option, div);
        list.appendChild(div);
      });
      
      console.log('âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º');
      modal.classList.remove('hidden');
    }
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠåˆ‡ã‚Šæ›¿ãˆ
    function toggleTopping(index, option, element) {
      const existingIndex = selectedToppings.findIndex(t => t.name === option.name);
      
      if (existingIndex >= 0) {
        selectedToppings.splice(existingIndex, 1);
        element.classList.remove('selected');
      } else {
        selectedToppings.push(option);
        element.classList.add('selected');
      }
    }
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠç¢ºå®š
    window.confirmToppingSelection = function() {
      if (!currentToppingSelection) return;
      
      let toppingsText = 'ãªã—';
      let toppingPrice = 0;
      
      if (selectedToppings.length > 0) {
        toppingsText = selectedToppings.map(t => t.name).join(', ');
        toppingPrice = selectedToppings.reduce((sum, t) => sum + (t.price || 0), 0);
      }
      
      addToManualCart(currentToppingSelection, toppingsText, toppingPrice);
      closeToppingModal();
    };
    
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeToppingModal = function() {
      document.getElementById('toppingModal').classList.add('hidden');
      currentToppingSelection = null;
      selectedToppings = [];
    };
    
    // æ‰‹å‹•ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
    function addToManualCart(item, toppings, toppingPrice) {
      // æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’æ¢ã™
      const existingIndex = manualCart.findIndex(
        i => i.id === item.id && i.toppings === toppings
      );
      
      if (existingIndex >= 0) {
        // æ—¢ã«åŒã˜å•†å“ãƒ»ãƒˆãƒƒãƒ”ãƒ³ã‚°ãŒã‚ã‚‹å ´åˆã¯æ•°é‡ã‚’å¢—ã‚„ã™
        manualCart[existingIndex].quantity++;
      } else {
        // æ–°è¦è¿½åŠ 
        manualCart.push({
          ...item,
          quantity: 1,
          toppings: toppings,
          toppingPrice: toppingPrice
        });
      }
      
      updateManualCart();
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠæ™‚
    window.updateManualTableSelection = function() {
      updateManualCart();
    };
    
    // æœ¬æ—¥ã®å£²ä¸Šã‚’è¨ˆç®—ï¼ˆJST 1:00åŸºæº–ï¼‰
    async function calculateTodaySales() {
      try {
        const now = new Date();
        const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        
        // æœ¬æ—¥ã®é–‹å§‹æ™‚åˆ» (JST 1:00)
        const todayStart = new Date(jstNow);
        todayStart.setHours(1, 0, 0, 0);
        if (jstNow < todayStart) {
          todayStart.setDate(todayStart.getDate() - 1);
        }
        
        const ordersSnapshot = await getDocs(collection(db, 'orders'));
        
        todaySalesData = {
          customerCount: 0,
          totalSales: 0,
          tax8Total: 0,
          tax10Total: 0,
          cashTotal: 0,
          emoneyTotal: 0,
          creditTotal: 0
        };
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          const orderDate = data.timestamp.toDate();
          const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
          
          if (jstOrderDate >= todayStart && data.paidAt && !data.cancelledAt) {
            todaySalesData.customerCount++;
            
            const amount = data.discountedAmount || data.totalAmount;
            todaySalesData.totalSales += amount;
            
            // ç¨ç‡åˆ¥é›†è¨ˆ
            data.items.forEach(item => {
              const itemTotal = item.price * item.quantity;
              const taxRate = getTaxRateForItem(item, data.tableNumber);
              
              if (taxRate === 8) {
                todaySalesData.tax8Total += itemTotal;
              } else {
                todaySalesData.tax10Total += itemTotal;
              }
            });
            
            // æ”¯æ‰•æ–¹æ³•åˆ¥é›†è¨ˆ
            if (data.paymentMethod === 'cash') {
              todaySalesData.cashTotal += amount;
            } else if (data.paymentMethod === 'emoney') {
              todaySalesData.emoneyTotal += amount;
            } else if (data.paymentMethod === 'credit') {
              todaySalesData.creditTotal += amount;
            }
          }
        });
        
        document.getElementById('customerCount').textContent = todaySalesData.customerCount;
        document.getElementById('todaySales').textContent = `Â¥${todaySalesData.totalSales.toLocaleString()}`;
        
      } catch (e) {
        console.error('å£²ä¸Šè¨ˆç®—ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    // æœˆæ¬¡å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showMonthlyReportModal = function() {
      const modal = document.getElementById('monthlyReportModal');
      const monthSelect = document.getElementById('monthSelect');
      
      // éå»6ãƒ¶æœˆåˆ†ã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
      monthSelect.innerHTML = '';
      const now = new Date();
      
      for (let i = 0; i < 6; i++) {
        const targetDate = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const year = targetDate.getFullYear();
        const month = targetDate.getMonth() + 1;
        
        const option = document.createElement('option');
        option.value = `${year}-${String(month).padStart(2, '0')}`;
        option.textContent = `${year}å¹´${month}æœˆ`;
        
        if (i === 0) option.selected = true;
        
        monthSelect.appendChild(option);
      }
      
      modal.classList.remove('hidden');
      loadMonthlyReport();
    };
    
    // æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
    window.loadMonthlyReport = async function() {
      const container = document.getElementById('monthlyDetails');
      container.innerHTML = '<div class="loading">è¨ˆç®—ä¸­...</div>';
      
      const monthValue = document.getElementById('monthSelect').value;
      const [year, month] = monthValue.split('-').map(Number);
      
      try {
        // å¯¾è±¡æœˆã®é–‹å§‹æ—¥ã¨çµ‚äº†æ—¥ã‚’è¨ˆç®—ï¼ˆJST 1:00åŸºæº–ï¼‰
        const monthStart = new Date(year, month - 1, 1, 1, 0, 0, 0);
        const monthEnd = new Date(year, month, 1, 1, 0, 0, 0);
        
        // UTCæ™‚åˆ»ã«å¤‰æ›ï¼ˆJST - 9æ™‚é–“ï¼‰
        const monthStartUTC = new Date(monthStart.getTime() - (9 * 60 * 60 * 1000));
        const monthEndUTC = new Date(monthEnd.getTime() - (9 * 60 * 60 * 1000));
        
        const ordersSnapshot = await getDocs(collection(db, 'orders'));
        
        let customerCount = 0;
        let totalSales = 0;
        let tax8Total = 0;
        let tax10Total = 0;
        let cashTotal = 0;
        let emoneyTotal = 0;
        let creditTotal = 0;
        
        const dailySales = new Map();
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          const orderDate = data.timestamp.toDate();
          
          if (orderDate >= monthStartUTC && orderDate < monthEndUTC && data.paidAt && !data.cancelledAt) {
            customerCount++;
            
            const amount = data.discountedAmount || data.totalAmount;
            totalSales += amount;
            
            // ç¨ç‡åˆ¥é›†è¨ˆ
            data.items.forEach(item => {
              const itemTotal = item.price * item.quantity;
              const taxRate = getTaxRateForItem(item, data.tableNumber);
              
              if (taxRate === 8) {
                tax8Total += itemTotal;
              } else {
                tax10Total += itemTotal;
              }
            });
            
            // æ”¯æ‰•æ–¹æ³•åˆ¥é›†è¨ˆ
            if (data.paymentMethod === 'cash') {
              cashTotal += amount;
            } else if (data.paymentMethod === 'emoney') {
              emoneyTotal += amount;
            } else if (data.paymentMethod === 'credit') {
              creditTotal += amount;
            }
            
            // æ—¥åˆ¥å£²ä¸Š
            const jstDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
            const dateKey = `${jstDate.getMonth() + 1}/${jstDate.getDate()}`;
            dailySales.set(dateKey, (dailySales.get(dateKey) || 0) + amount);
          }
        });
        
        // ç¨é¡è¨ˆç®—
        const tax8Amount = Math.floor(tax8Total * 8 / 108);
        const tax10Amount = Math.floor(tax10Total * 10 / 110);
        const totalTax = tax8Amount + tax10Amount;
        const taxExcludedTotal = totalSales - totalTax;
        
        // æ—¥åˆ¥å£²ä¸Šã®è¡¨ç¤º
        let dailyBreakdownHtml = '';
        const sortedDays = Array.from(dailySales.entries()).sort((a, b) => {
          const [aMonth, aDay] = a[0].split('/').map(Number);
          const [bMonth, bDay] = b[0].split('/').map(Number);
          return (aMonth * 100 + aDay) - (bMonth * 100 + bDay);
        });
        
        sortedDays.forEach(([date, amount]) => {
          dailyBreakdownHtml += `
            <div class="daily-item">
              <div class="daily-date">${date}</div>
              <div class="daily-amount">Â¥${amount.toLocaleString()}</div>
            </div>
          `;
        });
        
        container.innerHTML = `
          <div class="monthly-section">
            <div class="monthly-section-title">ğŸ“Š åŸºæœ¬æƒ…å ±</div>
            <div class="monthly-row">
              <span class="monthly-label">å¯¾è±¡æœˆ</span>
              <span class="monthly-value">${year}å¹´${month}æœˆ</span>
            </div>
            <div class="monthly-row">
              <span class="monthly-label">å®¢æ•°</span>
              <span class="monthly-value">${customerCount}å</span>
            </div>
          </div>
          
          <div class="monthly-section">
            <div class="monthly-section-title">ğŸ’° å£²ä¸Šé‡‘é¡</div>
            <div class="monthly-row">
              <span class="monthly-label">ç¨æŠœåˆè¨ˆå£²ä¸Š</span>
              <span class="monthly-value">Â¥${taxExcludedTotal.toLocaleString()}</span>
            </div>
            <div class="monthly-row">
              <span class="monthly-label">8%å•†å“ã®åˆè¨ˆå£²ä¸Š</span>
              <span class="monthly-value">Â¥${tax8Total.toLocaleString()}</span>
            </div>
            <div class="monthly-row">
              <span class="monthly-label">10%å•†å“ã®åˆè¨ˆå£²ä¸Š</span>
              <span class="monthly-value">Â¥${tax10Total.toLocaleString()}</span>
            </div>
            <div class="monthly-row">
              <span class="monthly-label">æ¶ˆè²»ç¨ã®åˆè¨ˆ</span>
              <span class="monthly-value">Â¥${totalTax.toLocaleString()}</span>
            </div>
            <div class="monthly-row highlight">
              <span class="monthly-label">ç¨è¾¼åˆè¨ˆé‡‘é¡</span>
              <span class="monthly-value">Â¥${totalSales.toLocaleString()}</span>
            </div>
          </div>
          
          <div class="monthly-section">
            <div class="monthly-section-title">ğŸ’³ æ”¯æ‰•æ–¹æ³•åˆ¥</div>
            <div class="monthly-row">
              <span class="monthly-label">ç¾é‡‘</span>
              <span class="monthly-value">Â¥${cashTotal.toLocaleString()}</span>
            </div>
            <div class="monthly-row">
              <span class="monthly-label">é›»å­ãƒãƒãƒ¼</span>
              <span class="monthly-value">Â¥${emoneyTotal.toLocaleString()}</span>
            </div>
            <div class="monthly-row">
              <span class="monthly-label">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</span>
              <span class="monthly-value">Â¥${creditTotal.toLocaleString()}</span>
            </div>
          </div>
          
          <div class="monthly-section">
            <div class="monthly-section-title">ğŸ“… æ—¥åˆ¥å£²ä¸Š</div>
            <div class="daily-breakdown">
              ${dailyBreakdownHtml || '<div style="grid-column: 1/-1; text-align: center; color: #999;">å£²ä¸Šãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>'}
            </div>
          </div>
        `;
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ï¼ˆå°åˆ·ç”¨ï¼‰
        window.currentMonthlyData = {
          year, month, customerCount, taxExcludedTotal,
          tax8Total, tax10Total, totalTax, totalSales,
          cashTotal, emoneyTotal, creditTotal,
          dailySales: sortedDays
        };
        
      } catch (e) {
        console.error('æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆè¨ˆç®—ã‚¨ãƒ©ãƒ¼:', e);
        container.innerHTML = '<div class="empty-state">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    };
    
    // æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆå°åˆ·
    window.printMonthlyReport = async function() {
      if (!window.currentMonthlyData) {
        alert('æœˆæ¬¡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      const data = window.currentMonthlyData;
      
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: 'æœˆæ¬¡å£²ä¸Šãƒ¬ãƒãƒ¼ãƒˆ\n\n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        builder.createAlignmentElement({position: 'left'});
        builder.createTextElement({data: 'ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—\n'});
        
        const now = new Date();
        const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        builder.createTextElement({data: `å°åˆ·æ—¥æ™‚: ${dateStr}\n`});
        
        builder.createRuledLineElement({thickness: 'medium'});
        
        builder.createTextElement({emphasis: true});
        builder.createTextElement({data: `å¯¾è±¡æœˆ: ${data.year}å¹´${data.month}æœˆ\n`});
        builder.createTextElement({emphasis: false});
        
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createTextElement({data: `å®¢æ•°${' '.repeat(20)}${data.customerCount}å\n`});
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createTextElement({data: `ç¨æŠœåˆè¨ˆå£²ä¸Š${' '.repeat(10)}${data.taxExcludedTotal.toLocaleString()}å††\n`});
        builder.createTextElement({data: `8%å•†å“å£²ä¸Š${' '.repeat(12)}${data.tax8Total.toLocaleString()}å††\n`});
        builder.createTextElement({data: `10%å•†å“å£²ä¸Š${' '.repeat(11)}${data.tax10Total.toLocaleString()}å††\n`});
        builder.createTextElement({data: `æ¶ˆè²»ç¨åˆè¨ˆ${' '.repeat(14)}${data.totalTax.toLocaleString()}å††\n`});
        
        builder.createRuledLineElement({thickness: 'medium'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `ç¨è¾¼åˆè¨ˆ ${data.totalSales.toLocaleString()}å††\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createRuledLineElement({thickness: 'medium'});
        
        builder.createTextElement({data: `ç¾é‡‘${' '.repeat(18)}${data.cashTotal.toLocaleString()}å††\n`});
        builder.createTextElement({data: `é›»å­ãƒãƒãƒ¼${' '.repeat(12)}${data.emoneyTotal.toLocaleString()}å††\n`});
        builder.createTextElement({data: `ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰${' '.repeat(8)}${data.creditTotal.toLocaleString()}å††\n`});
        
        if (data.dailySales && data.dailySales.length > 0) {
          builder.createRuledLineElement({thickness: 'thin'});
          builder.createTextElement({data: '\nã€æ—¥åˆ¥å£²ä¸Šã€‘\n'});
          
          data.dailySales.forEach(([date, amount]) => {
            const dateFormatted = date.padEnd(8, ' ');
            const amountStr = `${amount.toLocaleString()}å††`;
            const spaces = ' '.repeat(Math.max(1, 24 - dateFormatted.length - amountStr.length));
            builder.createTextElement({data: `${dateFormatted}${spaces}${amountStr}\n`});
          });
        }
        
        builder.createTextElement({data: '\n\n\n'});
        builder.createCutPaperElement({feed: true});
        
        const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
        
        const trader = new StarWebPrintTrader({url: url});
        trader.onReceive = function(response) {
          console.log('å°åˆ·æˆåŠŸ:', response);
          alert('æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆã‚’å°åˆ·ã—ã¾ã—ãŸ');
        };
        trader.onError = function(response) {
          console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', response);
          alert('å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.status);
        };
        
        trader.sendMessage({request: request});
        
      } catch (e) {
        console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        alert('å°åˆ·å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // æœˆæ¬¡ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeMonthlyReportModal = function() {
      document.getElementById('monthlyReportModal').classList.add('hidden');
    };
    
    // å•†å“ã®ç¨ç‡ã‚’å–å¾—ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã¨ã‚«ãƒ†ã‚´ãƒªã«åŸºã¥ãï¼‰
    function getTaxRateForItem(item, tableNumber) {
      // ã€åº—å†…ã€‘T-H, T-M, c1, c2 â†’ å…¨ã¦10%
      if (tableNumber && !tableNumber.match(/^\d+$/)) {
        return 10;
      }
      
      // ã€ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã€‘619-628ç­‰ã®æ•°å­—ã®ã¿ã®ãƒ†ãƒ¼ãƒ–ãƒ«
      // åŒ…æã‚«ãƒ†ã‚´ãƒªã¯10%ã€ãã‚Œä»¥å¤–ã®å•†å“ã¯8%
      if (item.category === 'åŒ…æ') {
        return 10;
      }
      
      return 8;  // ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã®é€šå¸¸å•†å“ã¯8%
    }
    
    // ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³
    window.openDrawer = async function() {
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        // ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³ã‚³ãƒãƒ³ãƒ‰ï¼ˆãƒ‘ãƒ«ã‚¹é€ä¿¡ï¼‰
        builder.createPeripheralElement({
          channel: 1,  // ãƒãƒ£ãƒ³ãƒãƒ«1ï¼ˆDKãƒãƒ¼ãƒˆï¼‰
          on: 100,     // ONæ™‚é–“ 100ms
          off: 100     // OFFæ™‚é–“ 100ms
        });
        
        const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
        
        const trader = new StarWebPrintTrader({url: url});
        trader.onReceive = function(response) {
          console.log('ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æˆåŠŸ:', response);
          // æˆåŠŸæ™‚ã¯ç‰¹ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãªã„ï¼ˆã‚¹ãƒ ãƒ¼ã‚ºãªæ“ä½œã®ãŸã‚ï¼‰
        };
        trader.onError = function(response) {
          console.error('ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³ã‚¨ãƒ©ãƒ¼:', response);
          alert('ãƒ‰ãƒ­ã‚¢ã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚\nãƒ—ãƒªãƒ³ã‚¿ãƒ¼ã¨ãƒ‰ãƒ­ã‚¢ã®æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
        };
        
        trader.sendMessage({request: request});
        
      } catch (e) {
        console.error('ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³ã‚¨ãƒ©ãƒ¼:', e);
        alert('ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // æ‰‹å‹•ã‚«ãƒ¼ãƒˆã®è¡¨ç¤ºæ›´æ–°
    function updateManualCart() {
      const container = document.getElementById('selectedItems');
      const submitBtn = document.getElementById('manualSubmitBtn');
      const manualTable = document.getElementById('manualTable');
      
      if (manualCart.length === 0) {
        container.innerHTML = '<div class="empty-state">å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
        submitBtn.disabled = true;
        document.getElementById('manualTotal').textContent = 'Â¥0';
        return;
      }
      
      container.innerHTML = '';
      let total = 0;
      
      manualCart.forEach((item, index) => {
        const unitPrice = item.price + item.toppingPrice;
        const subtotal = unitPrice * item.quantity;
        total += subtotal;
        
        // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’1ã¤ãšã¤æ”¹è¡Œã§è¡¨ç¤º
        let toppingsHtml = '';
        if (item.toppings && item.toppings !== 'ãªã—') {
          toppingsHtml = '<div style="font-size:13px;color:#666;margin-top:5px;">ãƒˆãƒƒãƒ”ãƒ³ã‚°</div>';
          const toppingLines = item.toppings.split('ã€');
          toppingLines.forEach(t => {
            toppingsHtml += `<div style="font-size:13px;color:#666;margin-left:10px;margin-top:2px;">${t.trim()}</div>`;
          });
        } else {
          toppingsHtml = '<div style="font-size:13px;color:#888;margin-top:5px;">ãƒˆãƒƒãƒ”ãƒ³ã‚°ãªã—</div>';
        }
        
        const div = document.createElement('div');
        div.className = 'selected-item';
        div.innerHTML = `
          <div style="flex: 1; min-width: 0;">
            <div style="font-weight: bold; font-size: 16px; margin-bottom: 5px; word-wrap: break-word;">${item.name} Ã— ${item.quantity}</div>
            ${toppingsHtml}
            <div style="font-size: 14px; color: #4CAF50; font-weight: bold; margin-top: 5px;">Â¥${unitPrice.toLocaleString()} Ã— ${item.quantity} = Â¥${subtotal.toLocaleString()}</div>
          </div>
          <div style="display: flex; align-items: center; gap: 10px; flex-shrink: 0;">
            <input type="number" class="quantity-input" min="1" value="${item.quantity}" 
                   onchange="updateQuantity(${index}, this.value)">
            <button class="remove-btn" onclick="removeFromManualCart(${index})">å‰Šé™¤</button>
          </div>
        `;
        container.appendChild(div);
      });
      
      document.getElementById('manualTotal').textContent = `Â¥${total.toLocaleString()}`;
      submitBtn.disabled = manualCart.length === 0 || !manualTable.value;
    }
    
    // æ•°é‡æ›´æ–°
    window.updateQuantity = function(index, value) {
      const qty = parseInt(value) || 1;
      manualCart[index].quantity = Math.max(1, qty);
      updateManualCart();
    };
    
    // ã‚«ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤
    window.removeFromManualCart = function(index) {
      manualCart.splice(index, 1);
      updateManualCart();
    };
    
    // è‡ªå‹•å°åˆ·ãƒˆã‚°ãƒ«
    window.toggleAutoPrint = function() {
      autoPrintEnabled = document.getElementById('autoPrintToggle').checked;
      const status = document.getElementById('autoPrintStatus');
      status.textContent = autoPrintEnabled ? 'ON' : 'OFF';
      status.className = autoPrintEnabled ? 'toggle-status on' : 'toggle-status off';
    };
    
    // æ‰‹å‹•æ³¨æ–‡ã‚’é€ä¿¡
    window.submitManualOrder = async function() {
      const tableNumber = document.getElementById('manualTable').value;
      
      if (!tableNumber || manualCart.length === 0) {
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã¨å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        const now = new Date();
        const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        
        const todayStart = new Date(jstNow);
        todayStart.setHours(1, 0, 0, 0);
        if (jstNow < todayStart) {
          todayStart.setDate(todayStart.getDate() - 1);
        }
        
        const ordersSnapshot = await getDocs(collection(db, 'orders'));
        let maxOrderNumber = 618;
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          const orderDate = data.timestamp.toDate();
          const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
          
          if (jstOrderDate >= todayStart && data.orderNumber > maxOrderNumber) {
            maxOrderNumber = data.orderNumber;
          }
        });
        
        const orderNumber = maxOrderNumber + 1;
        
        let totalAmount = 0;
        manualCart.forEach(item => {
          totalAmount += (item.price + item.toppingPrice) * item.quantity;
        });
        
        const deleteAt = new Date(now.getTime() + 10 * 60 * 1000);
        
        const orderData = {
          orderNumber: orderNumber,
          timestamp: Timestamp.fromDate(now),
          tableNumber: tableNumber,
          items: manualCart.map(item => ({
            id: item.id,
            name: item.name,
            price: item.price,
            quantity: item.quantity,
            toppings: item.toppings,
            toppingPrice: item.toppingPrice,
            category: item.category
          })),
          totalAmount: totalAmount,
          status: 'pending',
          deleteAt: Timestamp.fromDate(deleteAt),
          cancelledAt: null,
          completedAt: null,
          paidAt: null,
          notifiedComplete: false,
          notifiedCancel: false,
          notifiedPaid: false,
          manualEntry: true
        };
        
        const docRef = await addDoc(collection(db, 'orders'), orderData);
        
        await updateDoc(docRef, {
          orderId: docRef.id
        });
        
        alert(`æ³¨æ–‡ #${orderNumber} ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼\nãƒ†ãƒ¼ãƒ–ãƒ«: ${tableNumber}\nåˆè¨ˆ: Â¥${totalAmount.toLocaleString()}`);
        
        manualCart = [];
        document.getElementById('manualTable').value = '';
        updateManualCart();
        
      } catch (e) {
        console.error('æ³¨æ–‡ã‚¨ãƒ©ãƒ¼:', e);
        alert('æ³¨æ–‡ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°ã‚’é–‹å§‹
    function startRealtimeUpdates() {
      TABLES.forEach(table => {
        monitorTable(table);
      });
      
      // 5ç§’ã”ã¨ã«å£²ä¸Šã‚’æ›´æ–°
      setInterval(calculateTodaySales, 5000);
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ³¨æ–‡ã‚’ç›£è¦–
    async function monitorTable(tableNum) {
      const q = query(
        collection(db, 'orders'),
        where('tableNumber', '==', String(tableNum))
      );
      
      onSnapshot(q, (snapshot) => {
        const hasActiveOrders = snapshot.docs.some(doc => {
          const data = doc.data();
          return !data.paidAt && !data.cancelledAt;
        });
        
        const btn = document.getElementById(`table-${tableNum}`);
        if (btn) {
          if (hasActiveOrders) {
            btn.classList.add('has-orders');
          } else {
            btn.classList.remove('has-orders');
          }
        }
        
        if (selectedTable === tableNum) {
          loadOrders(tableNum);
        }
      });
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’é¸æŠ
    window.selectTable = async function(tableNum) {
      selectedTable = tableNum;
      document.getElementById('selectedTableLabel').textContent = `ãƒ†ãƒ¼ãƒ–ãƒ« ${tableNum}`;
      document.getElementById('orderSection').classList.remove('hidden');
      discountAmount = 0;
      
      await loadOrders(tableNum);
    };
    
    // æ³¨æ–‡ã‚’èª­ã¿è¾¼ã¿
    async function loadOrders(tableNum) {
      const container = document.getElementById('ordersList');
      container.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      try {
        const q = query(
          collection(db, 'orders'),
          where('tableNumber', '==', String(tableNum))
        );
        
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
          container.innerHTML = '<div class="empty-state">ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
          document.getElementById('totalSection').classList.add('hidden');
          return;
        }
        
        container.innerHTML = '';
        currentOrders = [];
        let totalAmount = 0;
        let hasUnpaidOrders = false;
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’é…åˆ—ã«å¤‰æ›ã—ã¦ã‚½ãƒ¼ãƒˆ
        const orders = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          orders.push({ id: doc.id, ...data });
        });
        
        // timestampã§é™é †ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
        orders.sort((a, b) => {
          const timeA = a.timestamp?.toDate?.() || new Date(0);
          const timeB = b.timestamp?.toDate?.() || new Date(0);
          return timeB - timeA;
        });
        
        // æœªæ‰•ã„ã®æ³¨æ–‡ã®ã¿è¡¨ç¤º
        orders.forEach(order => {
          if (!order.cancelledAt && !order.paidAt) {
            currentOrders.push(order);
            totalAmount += order.totalAmount;
            hasUnpaidOrders = true;
            
            const card = createOrderCard(order);
            container.appendChild(card);
          }
        });
        
        if (!hasUnpaidOrders) {
          container.innerHTML = '<div class="empty-state">æœªä¼šè¨ˆã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
          document.getElementById('totalSection').classList.add('hidden');
        } else {
          document.getElementById('totalAmount').textContent = `Â¥${totalAmount.toLocaleString()}`;
          document.getElementById('totalSection').classList.remove('hidden');
          totalAmountToPay = totalAmount;
        }
        
      } catch (e) {
        console.error('âŒ æ³¨æ–‡èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        console.error('ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰:', e.code);
        console.error('ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:', e.message);
        container.innerHTML = `<div class="empty-state">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ<br><small>${e.message}</small></div>`;
      }
    }
    
    // æ³¨æ–‡ã‚«ãƒ¼ãƒ‰ã‚’ä½œæˆ
    function createOrderCard(order) {
      const card = document.createElement('div');
      card.className = 'order-card';
      card.dataset.orderId = order.id;
      
      if (selectionMode) {
        card.classList.add('selection-mode');
      }
      
      if (order.completedAt) card.classList.add('completed');
      if (order.cancelledAt) card.classList.add('cancelled');
      if (order.discountAmount) card.classList.add('discounted');
      
      const timestamp = order.timestamp.toDate();
      const timeStr = `${timestamp.getHours()}:${String(timestamp.getMinutes()).padStart(2, '0')}`;
      
      let statusHtml = '';
      if (order.cancelledAt) {
        statusHtml = '<span class="order-status cancelled">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>';
      } else if (order.completedAt) {
        statusHtml = '<span class="order-status completed">æä¾›æ¸ˆã¿</span>';
      } else {
        statusHtml = '<span class="order-status pending">èª¿ç†ä¸­</span>';
      }
      
      let itemsHtml = '';
      order.items.forEach((item, itemIndex) => {
        const unitPrice = item.price + (item.toppingPrice || 0);
        const subtotal = unitPrice * item.quantity;
        const itemKey = `${order.id}-${itemIndex}`;
        const isSelected = selectedItems.has(itemKey);
        
        // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’1ã¤ãšã¤æ”¹è¡Œã§è¡¨ç¤º
        let toppingsHtml = '';
        if (item.toppings && item.toppings !== 'ãªã—') {
          toppingsHtml = '<div style="font-size:14px;color:#666;margin-top:5px;">ãƒˆãƒƒãƒ”ãƒ³ã‚°</div>';
          const toppingLines = item.toppings.split('ã€');
          toppingLines.forEach(t => {
            toppingsHtml += `<div style="font-size:14px;color:#666;margin-left:10px;margin-top:2px;">${t.trim()}</div>`;
          });
        } else {
          toppingsHtml = '<div style="font-size:14px;color:#888;margin-top:5px;">ãƒˆãƒƒãƒ”ãƒ³ã‚°ãªã—</div>';
        }
        
        itemsHtml += `
          <div class="order-item ${selectionMode ? 'selectable' : ''} ${isSelected ? 'selected' : ''}" 
               data-item-key="${itemKey}"
               ${selectionMode ? `onclick="toggleItemSelection('${itemKey}', ${subtotal})"` : ''}
               style="margin-bottom:15px;padding-bottom:15px;border-bottom:1px solid #eee;">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
              <div style="flex:1;">
                <div class="item-name" style="font-size:18px;font-weight:bold;margin-bottom:5px;">${item.name} Ã— ${item.quantity}</div>
                ${toppingsHtml}
                <div style="font-size:16px;color:#4CAF50;font-weight:bold;margin-top:8px;">Â¥${unitPrice.toLocaleString()} Ã— ${item.quantity} = Â¥${subtotal.toLocaleString()}</div>
              </div>
              ${selectionMode ? `<input type="checkbox" class="item-checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation()" style="margin-left:10px;">` : ''}
            </div>
          </div>
        `;
      });
      
      let discountBadge = '';
      if (order.discountAmount) {
        discountBadge = `<div class="discount-badge">å€¤å¼•ã -Â¥${order.discountAmount.toLocaleString()}</div>`;
      }
      
      card.innerHTML = `
        ${discountBadge}
        <div class="order-header">
          <div>
            <span class="order-number">#${order.orderNumber}</span>
            ${statusHtml}
          </div>
          <div class="order-time">${timeStr}</div>
        </div>
        <div class="order-items">
          ${itemsHtml}
        </div>
        <div class="order-total" style="margin-top:15px;padding-top:15px;border-top:3px solid #667eea;">
          <span class="total-label" style="font-size:20px;">åˆè¨ˆé‡‘é¡</span>
          <span class="total-amount" style="font-size:24px;font-weight:bold;">Â¥${order.totalAmount.toLocaleString()}</span>
        </div>
      `;
      
      return card;
    }
    
    // é¸æŠãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
    window.toggleSelectionMode = function() {
      selectionMode = !selectionMode;
      selectedItems.clear();
      
      const btn = document.getElementById('selectionModeBtn');
      const paymentBtn = document.getElementById('paymentBtn');
      const selectedInfo = document.getElementById('selectedItemsInfo');
      
      if (selectionMode) {
        btn.textContent = 'âŒ é¸æŠè§£é™¤';
        btn.classList.remove('btn-info');
        btn.classList.add('btn-danger');
        selectedInfo.classList.remove('hidden');
        paymentBtn.textContent = 'ğŸ’³ é¸æŠå•†å“ã‚’ä¼šè¨ˆ';
      } else {
        btn.textContent = 'âœ… é¸æŠä¼šè¨ˆ';
        btn.classList.remove('btn-danger');
        btn.classList.add('btn-info');
        selectedInfo.classList.add('hidden');
        paymentBtn.textContent = 'ğŸ’³ ä¼šè¨ˆå‡¦ç†';
      }
      
      // æ³¨æ–‡ã‚«ãƒ¼ãƒ‰ã‚’å†æç”»
      loadOrders(selectedTable);
    };
    
    // ã‚¢ã‚¤ãƒ†ãƒ é¸æŠåˆ‡ã‚Šæ›¿ãˆ
    window.toggleItemSelection = function(itemKey, amount) {
      if (selectedItems.has(itemKey)) {
        selectedItems.delete(itemKey);
      } else {
        selectedItems.add(itemKey);
      }
      
      updateSelectionInfo();
      
      // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®è¡¨ç¤ºã‚’æ›´æ–°
      const itemElement = document.querySelector(`[data-item-key="${itemKey}"]`);
      if (itemElement) {
        const checkbox = itemElement.querySelector('.item-checkbox');
        if (checkbox) {
          checkbox.checked = selectedItems.has(itemKey);
        }
        
        if (selectedItems.has(itemKey)) {
          itemElement.classList.add('selected');
        } else {
          itemElement.classList.remove('selected');
        }
      }
    };
    
    // é¸æŠæƒ…å ±ã‚’æ›´æ–°
    function updateSelectionInfo() {
      let totalItems = 0;
      let selectedAmount = 0;
      
      currentOrders.forEach(order => {
        order.items.forEach((item, itemIndex) => {
          totalItems++;
          const itemKey = `${order.id}-${itemIndex}`;
          if (selectedItems.has(itemKey)) {
            selectedAmount += (item.price + (item.toppingPrice || 0)) * item.quantity;
          }
        });
      });
      
      document.getElementById('selectedItemsCount').textContent = selectedItems.size;
      document.getElementById('totalItemsCount').textContent = totalItems;
      document.getElementById('selectedItemsAmount').textContent = `Â¥${selectedAmount.toLocaleString()}`;
      
      // é¸æŠãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯é¸æŠé‡‘é¡ã‚’ä¼šè¨ˆé‡‘é¡ã¨ã™ã‚‹
      if (selectionMode && selectedItems.size > 0) {
        totalAmountToPay = selectedAmount;
        document.getElementById('totalAmount').textContent = `Â¥${selectedAmount.toLocaleString()}`;
      }
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«çµåˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showTableMergeModal = async function() {
      const modal = document.getElementById('tableMergeModal');
      const list = document.getElementById('tableMergeList');
      
      list.innerHTML = '<div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>';
      modal.classList.remove('hidden');
      
      selectedTablesForMerge.clear();
      selectedTablesForMerge.add(selectedTable); // ç¾åœ¨ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è‡ªå‹•é¸æŠ
      
      try {
        // å…¨ãƒ†ãƒ¼ãƒ–ãƒ«ã®æœªä¼šè¨ˆæ³¨æ–‡ã‚’å–å¾—
        const tableOrders = new Map();
        
        for (const table of TABLES) {
          const q = query(
            collection(db, 'orders'),
            where('tableNumber', '==', String(table))
          );
          
          const snapshot = await getDocs(q);
          const orders = [];
          let totalAmount = 0;
          
          snapshot.forEach(doc => {
            const data = doc.data();
            if (!data.cancelledAt && !data.paidAt) {
              orders.push({ id: doc.id, ...data });
              totalAmount += data.totalAmount;
            }
          });
          
          if (orders.length > 0) {
            tableOrders.set(table, { orders, totalAmount });
          }
        }
        
        // ãƒªã‚¹ãƒˆè¡¨ç¤º
        list.innerHTML = '';
        
        if (tableOrders.size === 0) {
          list.innerHTML = '<div class="empty-state">æœªä¼šè¨ˆã®æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }
        
        tableOrders.forEach((data, table) => {
          const div = document.createElement('div');
          div.className = 'table-merge-item';
          if (table === selectedTable) {
            div.classList.add('current', 'selected');
          }
          
          const orderNumbers = data.orders.map(o => `#${o.orderNumber}`).join(', ');
          
          div.innerHTML = `
            <div class="merge-table-header">
              <span class="merge-table-name">ãƒ†ãƒ¼ãƒ–ãƒ« ${table}</span>
              <span class="merge-table-amount">Â¥${data.totalAmount.toLocaleString()}</span>
            </div>
            <div class="merge-order-count">${data.orders.length}ä»¶ã®æ³¨æ–‡</div>
            <div class="merge-order-numbers">${orderNumbers}</div>
          `;
          
          if (table !== selectedTable) {
            div.onclick = () => toggleTableForMerge(table, div);
          }
          
          list.appendChild(div);
        });
        
        updateMergeButton();
        
      } catch (e) {
        console.error('ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        list.innerHTML = '<div class="empty-state">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«çµåˆé¸æŠåˆ‡ã‚Šæ›¿ãˆ
    function toggleTableForMerge(table, element) {
      if (selectedTablesForMerge.has(table)) {
        selectedTablesForMerge.delete(table);
        element.classList.remove('selected');
      } else {
        selectedTablesForMerge.add(table);
        element.classList.add('selected');
      }
      
      updateMergeButton();
    }
    
    // çµåˆãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’æ›´æ–°
    function updateMergeButton() {
      const btn = document.getElementById('confirmMergeBtn');
      btn.disabled = selectedTablesForMerge.size < 2;
      
      if (selectedTablesForMerge.size >= 2) {
        btn.textContent = `${selectedTablesForMerge.size}ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’çµåˆã—ã¦ä¼šè¨ˆ`;
      } else {
        btn.textContent = 'çµåˆã—ã¦ä¼šè¨ˆ';
      }
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«çµåˆç¢ºå®š
    window.confirmTableMerge = async function() {
      if (selectedTablesForMerge.size < 2) {
        alert('çµåˆã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’2ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        // é¸æŠã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«ã®å…¨æ³¨æ–‡ã‚’å–å¾—
        currentOrders = [];
        let totalAmount = 0;
        
        for (const table of selectedTablesForMerge) {
          const q = query(
            collection(db, 'orders'),
            where('tableNumber', '==', String(table))
          );
          
          const snapshot = await getDocs(q);
          
          snapshot.forEach(doc => {
            const data = doc.data();
            if (!data.cancelledAt && !data.paidAt) {
              const order = { id: doc.id, ...data };
              currentOrders.push(order);
              totalAmount += data.totalAmount;
            }
          });
        }
        
        totalAmountToPay = totalAmount;
        mergeMode = true;
        
        closeTableMergeModal();
        
        // çµåˆã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«åã‚’è¡¨ç¤º
        const tableNames = Array.from(selectedTablesForMerge).join(', ');
        document.getElementById('selectedTableLabel').textContent = `${tableNames} (çµåˆ)`;
        
        // æ³¨æ–‡ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
        const container = document.getElementById('ordersList');
        container.innerHTML = '';
        
        currentOrders.forEach(order => {
          const card = createOrderCard(order);
          container.appendChild(card);
        });
        
        document.getElementById('totalAmount').textContent = `Â¥${totalAmount.toLocaleString()}`;
        document.getElementById('totalSection').classList.remove('hidden');
        
        alert(`${selectedTablesForMerge.size}ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’çµåˆã—ã¾ã—ãŸ\nåˆè¨ˆ: Â¥${totalAmount.toLocaleString()}`);
        
      } catch (e) {
        console.error('ãƒ†ãƒ¼ãƒ–ãƒ«çµåˆã‚¨ãƒ©ãƒ¼:', e);
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«çµåˆã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«çµåˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeTableMergeModal = function() {
      document.getElementById('tableMergeModal').classList.add('hidden');
    };
    
    // å€¤å¼•ããƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showDiscountModal = function() {
      if (currentOrders.length === 0) {
        alert('å€¤å¼•ãã™ã‚‹æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      document.getElementById('discountModal').classList.remove('hidden');
      document.getElementById('discountAmount').value = '';
      updateDiscountPreview();
    };
    
    // å€¤å¼•ããƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°
    window.updateDiscountPreview = function() {
      const discount = parseInt(document.getElementById('discountAmount').value) || 0;
      const originalAmount = totalAmountToPay;
      const discountedAmount = Math.max(0, originalAmount - discount);
      
      document.getElementById('originalAmount').textContent = `Â¥${originalAmount.toLocaleString()}`;
      document.getElementById('discountValue').textContent = `-Â¥${discount.toLocaleString()}`;
      document.getElementById('discountedAmount').textContent = `Â¥${discountedAmount.toLocaleString()}`;
    };
    
    // å€¤å¼•ãã‚’é©ç”¨
    window.applyDiscount = function() {
      const discount = parseInt(document.getElementById('discountAmount').value) || 0;
      
      if (discount <= 0) {
        alert('å€¤å¼•ãé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      if (discount >= totalAmountToPay) {
        alert('å€¤å¼•ãé‡‘é¡ãŒåˆè¨ˆé‡‘é¡ä»¥ä¸Šã§ã™');
        return;
      }
      
      discountAmount = discount;
      totalAmountToPay = totalAmountToPay - discount;
      
      document.getElementById('totalAmount').textContent = `Â¥${totalAmountToPay.toLocaleString()}`;
      
      closeDiscountModal();
      alert(`å€¤å¼•ãã‚’é©ç”¨ã—ã¾ã—ãŸ\nå€¤å¼•ãé¡: Â¥${discount.toLocaleString()}`);
    };
    
    // å€¤å¼•ããƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeDiscountModal = function() {
      document.getElementById('discountModal').classList.add('hidden');
    };
    
    // æ”¯æ‰•ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showPaymentModal = function() {
      if (currentOrders.length === 0) {
        alert('ä¼šè¨ˆã™ã‚‹æ³¨æ–‡ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      document.getElementById('paymentModal').classList.remove('hidden');
      selectedPaymentMethod = null;
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('completePaymentBtn').disabled = true;
    };
    
    // æ”¯æ‰•ã„æ–¹æ³•é¸æŠ
    window.selectPaymentMethod = function(method) {
      selectedPaymentMethod = method;
      
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');
      
      if (method === 'cash') {
        document.getElementById('cashInputSection').classList.remove('hidden');
        document.getElementById('completePaymentBtn').disabled = true;
      } else {
        document.getElementById('cashInputSection').classList.add('hidden');
        document.getElementById('completePaymentBtn').disabled = false;
      }
    };
    
    // ãŠã¤ã‚Šè¨ˆç®—
    window.calculateChange = function() {
      cashReceived = parseInt(document.getElementById('cashReceived').value) || 0;
      changeAmount = cashReceived - totalAmountToPay;
      
      document.getElementById('changeAmount').textContent = `Â¥${changeAmount.toLocaleString()}`;
      
      document.getElementById('completePaymentBtn').disabled = cashReceived < totalAmountToPay;
    };
    
    // ä¼šè¨ˆå®Œäº†
    window.completePayment = async function() {
      if (!selectedPaymentMethod) {
        alert('æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      if (selectedPaymentMethod === 'cash' && cashReceived < totalAmountToPay) {
        alert('ãŠé ã‹ã‚Šé‡‘é¡ãŒä¸è¶³ã—ã¦ã„ã¾ã™');
        return;
      }
      
      try {
        const now = Timestamp.now();
        
        let ordersToProcess = [];
        let itemsForReceipt = [];
        
        // é¸æŠãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
        if (selectionMode && selectedItems.size > 0) {
          // é¸æŠã•ã‚ŒãŸå•†å“ã®ã¿ã‚’å‡¦ç†
          const itemsByOrder = new Map();
          
          selectedItems.forEach(itemKey => {
            const [orderId, itemIndex] = itemKey.split('-');
            if (!itemsByOrder.has(orderId)) {
              itemsByOrder.set(orderId, []);
            }
            itemsByOrder.get(orderId).push(parseInt(itemIndex));
          });
          
          // å„æ³¨æ–‡ã®é¸æŠã•ã‚ŒãŸå•†å“ã‚’å‡¦ç†
          for (const [orderId, itemIndices] of itemsByOrder) {
            const order = currentOrders.find(o => o.id === orderId);
            if (!order) continue;
            
            const selectedOrderItems = itemIndices.map(idx => order.items[idx]);
            itemsForReceipt.push(...selectedOrderItems);
            
            // æ®‹ã‚Šã®å•†å“
            const remainingItems = order.items.filter((item, idx) => !itemIndices.includes(idx));
            
            if (remainingItems.length === 0) {
              // å…¨å•†å“ãŒé¸æŠã•ã‚ŒãŸå ´åˆã¯æ³¨æ–‡å…¨ä½“ã‚’å®Œäº†
              await updateDoc(doc(db, 'orders', orderId), {
                paidAt: now,
                notifiedPaid: true,
                paymentMethod: selectedPaymentMethod,
                discountAmount: discountAmount,
                discountedAmount: totalAmountToPay
              });
              ordersToProcess.push(order.orderNumber);
            } else {
              // ä¸€éƒ¨ã®å•†å“ã®ã¿é¸æŠã•ã‚ŒãŸå ´åˆã¯ã€é¸æŠå•†å“ã‚’å‰Šé™¤ã—ã¦æ®‹ã‚Šã‚’ä¿æŒ
              const remainingTotal = remainingItems.reduce((sum, item) => 
                sum + (item.price + (item.toppingPrice || 0)) * item.quantity, 0);
              
              await updateDoc(doc(db, 'orders', orderId), {
                items: remainingItems,
                totalAmount: remainingTotal
              });
              
              ordersToProcess.push(`${order.orderNumber}(ä¸€éƒ¨)`);
            }
          }
        } 
        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼ˆå…¨ä½“ä¼šè¨ˆï¼‰ã¾ãŸã¯ãƒ†ãƒ¼ãƒ–ãƒ«çµåˆ
        else {
          ordersToProcess = currentOrders.map(o => o.orderNumber);
          itemsForReceipt = currentOrders.flatMap(o => o.items);
          
          // å…¨ã¦ã®æ³¨æ–‡ã«æ”¯æ‰•ã„æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
          for (const order of currentOrders) {
            await updateDoc(doc(db, 'orders', order.id), {
              paidAt: now,
              notifiedPaid: true,
              paymentMethod: selectedPaymentMethod,
              discountAmount: discountAmount,
              discountedAmount: totalAmountToPay
            });
          }
        }
        
        // æ”¯æ‰•ã„ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        const tableLabel = mergeMode ? 
          Array.from(selectedTablesForMerge).join(', ') : 
          selectedTable;
        
        lastPaymentData = {
          tableNumber: tableLabel,
          orderNumbers: ordersToProcess,
          items: itemsForReceipt,
          originalAmount: totalAmountToPay + discountAmount,
          discountAmount: discountAmount,
          totalAmount: totalAmountToPay,
          paymentMethod: selectedPaymentMethod,
          cashReceived: selectedPaymentMethod === 'cash' ? cashReceived : totalAmountToPay,
          change: selectedPaymentMethod === 'cash' ? changeAmount : 0,
          timestamp: new Date(),
          splitPayment: selectionMode && selectedItems.size > 0
        };
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
        closePaymentModal();
        
        // å£²ä¸Šã‚’å†è¨ˆç®—
        await calculateTodaySales();
        
        // ãƒ‰ãƒ­ã‚¢ã‚’è‡ªå‹•ã§é–‹ãï¼ˆç¾é‡‘æ‰•ã„ã®å ´åˆã®ã¿ï¼‰
        if (selectedPaymentMethod === 'cash') {
          await openDrawer();
        }
        
        // è‡ªå‹•å°åˆ·ãŒæœ‰åŠ¹ãªã‚‰å°åˆ·
        if (autoPrintEnabled) {
          await printReceipt();
        } else {
          document.getElementById('receiptCompleteModal').classList.remove('hidden');
        }
        
        // é¸æŠãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
        if (selectionMode) {
          toggleSelectionMode();
        }
        
        // ãƒ†ãƒ¼ãƒ–ãƒ«çµåˆãƒ¢ãƒ¼ãƒ‰ã‚’ãƒªã‚»ãƒƒãƒˆ
        mergeMode = false;
        selectedTablesForMerge.clear();
        
        await loadOrders(selectedTable);
        
      } catch (e) {
        console.error('ä¼šè¨ˆã‚¨ãƒ©ãƒ¼:', e);
        alert('ä¼šè¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // æ”¯æ‰•ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
      document.getElementById('cashReceived').value = '';
      calculateChange();
    };
    
    // ç²¾ç®—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
    window.showSettlementModal = async function() {
      const modal = document.getElementById('settlementModal');
      const dateSelect = document.getElementById('settlementDateSelect');
      
      // éå»30æ—¥åˆ†ã®é¸æŠè‚¢ã‚’ç”Ÿæˆ
      dateSelect.innerHTML = '';
      const now = new Date();
      const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
      
      for (let i = 0; i < 30; i++) {
        const targetDate = new Date(jstNow);
        targetDate.setDate(targetDate.getDate() - i);
        
        const year = targetDate.getFullYear();
        const month = targetDate.getMonth() + 1;
        const day = targetDate.getDate();
        
        const option = document.createElement('option');
        option.value = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        if (i === 0) {
          option.textContent = `ä»Šæ—¥ (${year}/${month}/${day})`;
          option.selected = true;
        } else if (i === 1) {
          option.textContent = `æ˜¨æ—¥ (${year}/${month}/${day})`;
        } else {
          option.textContent = `${year}å¹´${month}æœˆ${day}æ—¥`;
        }
        
        dateSelect.appendChild(option);
      }
      
      modal.classList.remove('hidden');
      await loadSettlementData();
    };
    
    // ç²¾ç®—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    window.loadSettlementData = async function() {
      const container = document.getElementById('settlementDetails');
      container.innerHTML = '<div class="loading">è¨ˆç®—ä¸­...</div>';
      
      const dateValue = document.getElementById('settlementDateSelect').value;
      const [year, month, day] = dateValue.split('-').map(Number);
      
      try {
        // é¸æŠã•ã‚ŒãŸæ—¥ã®é–‹å§‹æ™‚åˆ»ã¨çµ‚äº†æ™‚åˆ»ã‚’è¨ˆç®—ï¼ˆJST 1:00åŸºæº–ï¼‰
        const dayStart = new Date(year, month - 1, day, 1, 0, 0, 0);
        const dayEnd = new Date(year, month - 1, day + 1, 1, 0, 0, 0);
        
        // UTCæ™‚åˆ»ã«å¤‰æ›ï¼ˆJST - 9æ™‚é–“ï¼‰
        const dayStartUTC = new Date(dayStart.getTime() - (9 * 60 * 60 * 1000));
        const dayEndUTC = new Date(dayEnd.getTime() - (9 * 60 * 60 * 1000));
        
        const ordersSnapshot = await getDocs(collection(db, 'orders'));
        
        let customerCount = 0;
        let totalSales = 0;
        let tax8Total = 0;
        let tax10Total = 0;
        let cashTotal = 0;
        let emoneyTotal = 0;
        let creditTotal = 0;
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          const orderDate = data.timestamp.toDate();
          
          if (orderDate >= dayStartUTC && orderDate < dayEndUTC && data.paidAt && !data.cancelledAt) {
            customerCount++;
            
            const amount = data.discountedAmount || data.totalAmount;
            totalSales += amount;
            
            // ç¨ç‡åˆ¥é›†è¨ˆ
            data.items.forEach(item => {
              const itemTotal = item.price * item.quantity;
              const taxRate = getTaxRateForItem(item, data.tableNumber);
              
              if (taxRate === 8) {
                tax8Total += itemTotal;
              } else {
                tax10Total += itemTotal;
              }
            });
            
            // æ”¯æ‰•æ–¹æ³•åˆ¥é›†è¨ˆ
            if (data.paymentMethod === 'cash') {
              cashTotal += amount;
            } else if (data.paymentMethod === 'emoney') {
              emoneyTotal += amount;
            } else if (data.paymentMethod === 'credit') {
              creditTotal += amount;
            }
          }
        });
        
        // ç¨æŠœé‡‘é¡ã‚’è¨ˆç®—
        const tax8Amount = Math.floor(tax8Total * 8 / 108);
        const tax10Amount = Math.floor(tax10Total * 10 / 110);
        const totalTax = tax8Amount + tax10Amount;
        const taxExcludedTotal = totalSales - totalTax;
        
        const dateStr = `${year}å¹´${String(month).padStart(2,'0')}æœˆ${String(day).padStart(2,'0')}æ—¥`;
        
        container.innerHTML = `
          <div class="settlement-row">
            <span class="settlement-label">ç²¾ç®—æ—¥</span>
            <span class="settlement-value">${dateStr}</span>
          </div>
          <div class="settlement-row">
            <span class="settlement-label">åº—å</span>
            <span class="settlement-value">ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—</span>
          </div>
          <div class="settlement-row">
            <span class="settlement-label">å®¢æ•°</span>
            <span class="settlement-value">${customerCount}å</span>
          </div>
          <div class="settlement-row">
            <span class="settlement-label">ç¨æŠœåˆè¨ˆ</span>
            <span class="settlement-value">Â¥${taxExcludedTotal.toLocaleString()}</span>
          </div>
          <div class="settlement-row">
            <span class="settlement-label">8%å•†å“åˆè¨ˆ</span>
            <span class="settlement-value">Â¥${tax8Total.toLocaleString()}</span>
          </div>
          <div class="settlement-row">
            <span class="settlement-label">10%å•†å“åˆè¨ˆ</span>
            <span class="settlement-value">Â¥${tax10Total.toLocaleString()}</span>
          </div>
          <div class="settlement-row">
            <span class="settlement-label">æ¶ˆè²»ç¨åˆè¨ˆ</span>
            <span class="settlement-value">Â¥${totalTax.toLocaleString()}</span>
          </div>
          <div class="settlement-row highlight">
            <span class="settlement-label">ç¨è¾¼åˆè¨ˆ</span>
            <span class="settlement-value">Â¥${totalSales.toLocaleString()}</span>
          </div>
          <div class="settlement-row">
            <span class="settlement-label">ç¾é‡‘</span>
            <span class="settlement-value">Â¥${cashTotal.toLocaleString()}</span>
          </div>
          <div class="settlement-row">
            <span class="settlement-label">é›»å­ãƒãƒãƒ¼</span>
            <span class="settlement-value">Â¥${emoneyTotal.toLocaleString()}</span>
          </div>
          <div class="settlement-row">
            <span class="settlement-label">ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</span>
            <span class="settlement-value">Â¥${creditTotal.toLocaleString()}</span>
          </div>
        `;
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜ï¼ˆå°åˆ·ç”¨ï¼‰
        window.currentSettlementData = {
          year, month, day, dateStr, customerCount, taxExcludedTotal,
          tax8Total, tax10Total, totalTax, totalSales,
          cashTotal, emoneyTotal, creditTotal
        };
        
      } catch (e) {
        console.error('ç²¾ç®—ãƒ‡ãƒ¼ã‚¿è¨ˆç®—ã‚¨ãƒ©ãƒ¼:', e);
        container.innerHTML = '<div class="empty-state">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    };
    
    // ç²¾ç®—ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·
    window.printSettlement = async function() {
      if (!window.currentSettlementData) {
        alert('ç²¾ç®—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      const data = window.currentSettlementData;
      
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: 'ç²¾ç®—ãƒ¬ã‚·ãƒ¼ãƒˆ\n\n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        builder.createAlignmentElement({position: 'left'});
        builder.createTextElement({data: 'ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—\n'});
        
        const now = new Date();
        const printDateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        builder.createTextElement({data: `å°åˆ·æ—¥æ™‚: ${printDateStr}\n`});
        
        builder.createRuledLineElement({thickness: 'medium'});
        
        builder.createTextElement({emphasis: true});
        builder.createTextElement({data: `ç²¾ç®—æ—¥: ${data.dateStr}\n`});
        builder.createTextElement({emphasis: false});
        
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createTextElement({data: `å®¢æ•°${' '.repeat(20)}${data.customerCount}å\n`});
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createTextElement({data: `ç¨æŠœåˆè¨ˆ${' '.repeat(12)}${data.taxExcludedTotal.toLocaleString()}å††\n`});
        builder.createTextElement({data: `8%å•†å“åˆè¨ˆ${' '.repeat(10)}${data.tax8Total.toLocaleString()}å††\n`});
        builder.createTextElement({data: `10%å•†å“åˆè¨ˆ${' '.repeat(9)}${data.tax10Total.toLocaleString()}å††\n`});
        builder.createTextElement({data: `æ¶ˆè²»ç¨åˆè¨ˆ${' '.repeat(12)}${data.totalTax.toLocaleString()}å††\n`});
        builder.createRuledLineElement({thickness: 'medium'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `ç¨è¾¼åˆè¨ˆ ${data.totalSales.toLocaleString()}å††\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createRuledLineElement({thickness: 'medium'});
        
        builder.createTextElement({data: `ç¾é‡‘${' '.repeat(18)}${data.cashTotal.toLocaleString()}å††\n`});
        builder.createTextElement({data: `é›»å­ãƒãƒãƒ¼${' '.repeat(12)}${data.emoneyTotal.toLocaleString()}å††\n`});
        builder.createTextElement({data: `ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰${' '.repeat(8)}${data.creditTotal.toLocaleString()}å††\n`});
        
        builder.createTextElement({data: '\n\n\n'});
        builder.createCutPaperElement({feed: true});
        
        const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
        
        const trader = new StarWebPrintTrader({url: url});
        trader.onReceive = function(response) {
          console.log('å°åˆ·æˆåŠŸ:', response);
          alert('ç²¾ç®—ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å°åˆ·ã—ã¾ã—ãŸ');
        };
        trader.onError = function(response) {
          console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', response);
          alert('å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.status);
        };
        
        trader.sendMessage({request: request});
        
      } catch (e) {
        console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        alert('å°åˆ·å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ç²¾ç®—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeSettlementModal = function() {
      document.getElementById('settlementModal').classList.add('hidden');
    };
    
    // ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·ï¼ˆ58mmå¹…å¯¾å¿œï¼‰
    window.printReceipt = async function() {
      if (!lastPaymentData) {
        alert('å°åˆ·ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: 'ç²‰ã‚‚ã‚“å±‹ å…«\n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createTextElement({data: 'ä¸‹èµ¤å¡šåº—\n'});
        builder.createTextElement({data: 'æ±äº¬éƒ½æ¿æ©‹åŒºèµ¤å¡šæ–°ç”º\n'});
        builder.createTextElement({data: 'TEL: 03-XXXX-XXXX\n'});
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createAlignmentElement({position: 'left'});
        const now = lastPaymentData.timestamp;
        const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2, '0')}`;
        builder.createTextElement({data: `æ—¥æ™‚: ${dateStr}\n`});
        builder.createTextElement({data: `æ‹…å½“: ãƒ¬ã‚¸ä¿‚\n`});
        builder.createTextElement({data: `ãƒ†ãƒ¼ãƒ–ãƒ«: ${lastPaymentData.tableNumber}\n`});
        builder.createTextElement({data: `æ³¨æ–‡No: ${lastPaymentData.orderNumbers.join(',')}\n`});
        builder.createRuledLineElement({thickness: 'thin'});
        
        // å•†å“æ˜ç´°
        let itemCount = 0;
        let tax8Total = 0;
        let tax10Total = 0;
        
        lastPaymentData.items.forEach(item => {
          const subtotal = item.price * item.quantity;
          itemCount += item.quantity;
          
          const taxRate = getTaxRateForItem(item, lastPaymentData.tableNumber);
          if (taxRate === 8) {
            tax8Total += subtotal;
          } else {
            tax10Total += subtotal;
          }
          
          const itemName = item.name.length > 16 ? item.name.substring(0, 15) + 'â€¦' : item.name;
          builder.createTextElement({data: `${itemName}\n`});
          
          const priceInfo = `@${item.price} x${item.quantity}`;
          const subtotalStr = `${subtotal.toLocaleString()}å††`;
          const spaces = ' '.repeat(Math.max(1, 32 - priceInfo.length - subtotalStr.length));
          builder.createTextElement({data: `${priceInfo}${spaces}${subtotalStr}\n`});
          
          if (item.toppings && item.toppings !== 'ãªã—') {
            builder.createTextElement({data: ` TP:${item.toppings}\n`});
          }
        });
        
        builder.createRuledLineElement({thickness: 'thin'});
        
        if (lastPaymentData.discountAmount > 0) {
          builder.createTextElement({data: `å…ƒã®é‡‘é¡${' '.repeat(16)}${lastPaymentData.originalAmount.toLocaleString()}å††\n`});
          builder.createTextElement({data: `å€¤å¼•ã${' '.repeat(18)}-${lastPaymentData.discountAmount.toLocaleString()}å††\n`});
        }
        
        builder.createTextElement({data: `å°è¨ˆ${' '.repeat(20)}${lastPaymentData.totalAmount.toLocaleString()}å††\n`});
        builder.createTextElement({data: `ç‚¹æ•°: ${itemCount}ç‚¹\n`});
        builder.createRuledLineElement({thickness: 'thin'});
        
        // ç¨é¡è¨ˆç®—
        const tax8Amount = Math.floor(tax8Total * 8 / 108);
        const tax10Amount = Math.floor(tax10Total * 10 / 110);
        
        if (tax8Total > 0) {
          builder.createTextElement({data: `8%å¯¾è±¡${' '.repeat(16)}${tax8Total.toLocaleString()}å††\n`});
          builder.createTextElement({data: `(å†…æ¶ˆè²»ç¨${' '.repeat(15)}${tax8Amount.toLocaleString()}å††)\n`});
        }
        if (tax10Total > 0) {
          builder.createTextElement({data: `10%å¯¾è±¡${' '.repeat(15)}${tax10Total.toLocaleString()}å††\n`});
          builder.createTextElement({data: `(å†…æ¶ˆè²»ç¨${' '.repeat(15)}${tax10Amount.toLocaleString()}å††)\n`});
        }
        
        builder.createRuledLineElement({thickness: 'medium'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `åˆè¨ˆ ${lastPaymentData.totalAmount.toLocaleString()}å††\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createRuledLineElement({thickness: 'medium'});
        
        // æ”¯æ‰•ã„æƒ…å ±
        let paymentMethodStr = '';
        if (lastPaymentData.paymentMethod === 'cash') {
          paymentMethodStr = 'ç¾é‡‘';
          builder.createTextElement({data: `ãŠé ã‚Š${' '.repeat(18)}${lastPaymentData.cashReceived.toLocaleString()}å††\n`});
          builder.createTextElement({data: `ãŠã¤ã‚Š${' '.repeat(18)}${lastPaymentData.change.toLocaleString()}å††\n`});
        } else if (lastPaymentData.paymentMethod === 'emoney') {
          paymentMethodStr = 'é›»å­ãƒãƒãƒ¼';
        } else if (lastPaymentData.paymentMethod === 'credit') {
          paymentMethodStr = 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰';
        }
        builder.createTextElement({data: `æ”¯æ‰•: ${paymentMethodStr}\n`});
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({data: '\nã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ\n'});
        builder.createTextElement({data: 'ã¾ãŸã®ã”æ¥åº—ã‚’\n'});
        builder.createTextElement({data: 'ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™\n\n\n'});
        
        builder.createCutPaperElement({feed: true});
        
        const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
        
        const trader = new StarWebPrintTrader({url: url});
        trader.onReceive = function(response) {
          console.log('å°åˆ·æˆåŠŸ:', response);
          alert('ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å°åˆ·ã—ã¾ã—ãŸ');
          closeReceiptModal();
        };
        trader.onError = function(response) {
          console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', response);
          alert('å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.status);
        };
        
        trader.sendMessage({request: request});
        
      } catch (e) {
        console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        alert('å°åˆ·å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // é ˜åæ›¸å°åˆ·ï¼ˆå°é‘‘æ¬„ä»˜ããƒ»58mmå¹…å¯¾å¿œï¼‰
    window.printInvoice = async function() {
      if (!lastPaymentData) {
        alert('å°åˆ·ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: 'é ˜ å æ›¸\n\n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        builder.createAlignmentElement({position: 'left'});
        const now = lastPaymentData.timestamp;
        const dateStr = `${now.getFullYear()}å¹´${String(now.getMonth()+1).padStart(2,'0')}æœˆ${String(now.getDate()).padStart(2,'0')}æ—¥`;
        builder.createTextElement({data: `${dateStr}\n\n`});
        
        builder.createTextElement({data: 'ãŠå®¢æ§˜\n\n'});
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `Â¥${lastPaymentData.totalAmount.toLocaleString()}-\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createAlignmentElement({position: 'left'});
        builder.createTextElement({data: '\nä¸Šè¨˜æ­£ã«é ˜åã„ãŸã—ã¾ã—ãŸ\n\n'});
        builder.createTextElement({data: 'ä½†ã— é£²é£Ÿä»£ã¨ã—ã¦\n\n\n'});
        
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createAlignmentElement({position: 'right'});
        builder.createTextElement({data: 'ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—\n'});
        builder.createTextElement({data: 'æ±äº¬éƒ½æ¿æ©‹åŒºèµ¤å¡šæ–°ç”º\n'});
        builder.createTextElement({data: 'TEL: 03-XXXX-XXXX\n\n'});
        
        // å°é‘‘æ¬„ã‚’ä½œæˆ
        builder.createAlignmentElement({position: 'right'});
        builder.createTextElement({data: '        â—¯â—¯â—¯\n'});
        builder.createTextElement({data: '       â—¯   â—¯\n'});
        builder.createTextElement({data: '      â—¯  å° â—¯\n'});
        builder.createTextElement({data: '       â—¯   â—¯\n'});
        builder.createTextElement({data: '        â—¯â—¯â—¯\n\n'});
        
        builder.createAlignmentElement({position: 'left'});
        builder.createRuledLineElement({thickness: 'thin'});
        
        builder.createTextElement({data: `\nãƒ†ãƒ¼ãƒ–ãƒ«: ${lastPaymentData.tableNumber}\n`});
        builder.createTextElement({data: `æ³¨æ–‡No: ${lastPaymentData.orderNumbers.join(',')}\n`});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({data: '\n\n'});
        
        builder.createCutPaperElement({feed: true});
        
        const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
        
        const trader = new StarWebPrintTrader({url: url});
        trader.onReceive = function(response) {
          console.log('å°åˆ·æˆåŠŸ:', response);
          alert('é ˜åæ›¸ã‚’å°åˆ·ã—ã¾ã—ãŸ');
          closeReceiptModal();
        };
        trader.onError = function(response) {
          console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', response);
          alert('å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + response.status);
        };
        
        trader.sendMessage({request: request});
        
      } catch (e) {
        console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        alert('å°åˆ·å‡¦ç†ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ãƒ¬ã‚·ãƒ¼ãƒˆå®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    window.closeReceiptModal = function() {
      document.getElementById('receiptCompleteModal').classList.add('hidden');
      clearSelection();
    };
    
    // é¸æŠã‚’ã‚¯ãƒªã‚¢
    window.clearSelection = function() {
      selectedTable = null;
      currentOrders = [];
      discountAmount = 0;
      document.getElementById('orderSection').classList.add('hidden');
    };
    
    // å±¥æ­´è¡¨ç¤º
    window.showHistory = async function() {
      const modal = document.createElement('div');
      modal.id = 'historyModal';
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      
      const content = document.createElement('div');
      content.style.cssText = `
        background: white;
        border-radius: 16px;
        padding: 30px;
        max-width: 90%;
        max-height: 90%;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      `;
      
      content.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <h2 style="margin:0;">ğŸ“œ ä¼šè¨ˆå±¥æ­´</h2>
          <button onclick="closeHistory()" style="background:#f44336;color:white;border:none;border-radius:8px;padding:10px 20px;font-size:16px;cursor:pointer;">âœ• é–‰ã˜ã‚‹</button>
        </div>
        <div id="historyList" style="min-height:200px;">èª­ã¿è¾¼ã¿ä¸­...</div>
      `;
      
      modal.appendChild(content);
      document.body.appendChild(modal);
      
      // å±¥æ­´ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
      try {
        const now = new Date();
        const todayStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
        
        const q = query(
          collection(db, 'orders'),
          where('paidAt', '>=', Timestamp.fromDate(todayStart)),
          orderBy('paidAt', 'desc')
        );
        
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
          document.getElementById('historyList').innerHTML = '<div style="text-align:center;padding:40px;color:#999;">æœ¬æ—¥ã®å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }
        
        let historyHtml = '';
        snapshot.forEach(doc => {
          const order = doc.data();
          const paidTime = order.paidAt.toDate();
          const timeStr = `${paidTime.getHours()}:${String(paidTime.getMinutes()).padStart(2, '0')}`;
          
          let itemsHtml = '';
          order.items.forEach(item => {
            const unitPrice = item.price + (item.toppingPrice || 0);
            const subtotal = unitPrice * item.quantity;
            itemsHtml += `
              <div style="margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid #eee;">
                <div style="font-weight:bold;">${item.name} Ã— ${item.quantity}</div>
                <div style="font-size:14px;color:#666;margin-top:3px;">Â¥${unitPrice.toLocaleString()} Ã— ${item.quantity} = Â¥${subtotal.toLocaleString()}</div>
              </div>
            `;
          });
          
          historyHtml += `
            <div style="background:#f8f9fa;padding:20px;border-radius:12px;margin-bottom:15px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;">
                <div>
                  <span style="font-size:20px;font-weight:bold;color:#667eea;">#${order.orderNumber}</span>
                  <span style="margin-left:10px;color:#666;">${order.tableNumber}</span>
                  <span style="margin-left:10px;color:#999;">${timeStr}</span>
                </div>
                <div>
                  <select id="payment-${doc.id}" style="padding:8px;border:2px solid #667eea;border-radius:8px;margin-right:10px;">
                    <option value="cash" ${order.paymentMethod === 'cash' ? 'selected' : ''}>ç¾é‡‘</option>
                    <option value="credit" ${order.paymentMethod === 'credit' ? 'selected' : ''}>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ</option>
                    <option value="emoney" ${order.paymentMethod === 'emoney' ? 'selected' : ''}>é›»å­ãƒãƒãƒ¼</option>
                  </select>
                  <button onclick="changePaymentMethod('${doc.id}')" style="background:#4CAF50;color:white;border:none;border-radius:8px;padding:8px 15px;cursor:pointer;margin-right:5px;">ğŸ’¾ å¤‰æ›´</button>
                  <button onclick="reprintReceipt('${doc.id}')" style="background:#2196F3;color:white;border:none;border-radius:8px;padding:8px 15px;cursor:pointer;">ğŸ–¨ï¸ å†å°åˆ·</button>
                </div>
              </div>
              <div style="margin-bottom:10px;">
                ${itemsHtml}
              </div>
              <div style="text-align:right;font-size:20px;font-weight:bold;color:#4CAF50;">
                åˆè¨ˆ: Â¥${order.totalAmount.toLocaleString()}
              </div>
            </div>
          `;
        });
        
        document.getElementById('historyList').innerHTML = historyHtml;
      } catch (e) {
        console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        document.getElementById('historyList').innerHTML = `<div style="color:#f44336;padding:20px;">ã‚¨ãƒ©ãƒ¼: ${e.message}</div>`;
      }
    };
    
    // å±¥æ­´ã‚’é–‰ã˜ã‚‹
    window.closeHistory = function() {
      const modal = document.getElementById('historyModal');
      if (modal) {
        modal.remove();
      }
    };
    
    // ãŠæ”¯æ‰•ã„æ–¹æ³•å¤‰æ›´
    window.changePaymentMethod = async function(orderId) {
      const select = document.getElementById(`payment-${orderId}`);
      const newMethod = select.value;
      
      try {
        await updateDoc(doc(db, 'orders', orderId), {
          paymentMethod: newMethod
        });
        
        alert('âœ… ãŠæ”¯æ‰•ã„æ–¹æ³•ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
      } catch (e) {
        console.error('æ”¯æ‰•ã„æ–¹æ³•å¤‰æ›´ã‚¨ãƒ©ãƒ¼:', e);
        alert('âŒ å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ãƒ¬ã‚·ãƒ¼ãƒˆå†å°åˆ·
    window.reprintReceipt = async function(orderId) {
      try {
        const docSnap = await getDoc(doc(db, 'orders', orderId));
        if (!docSnap.exists()) {
          alert('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        const order = docSnap.data();
        
        // ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·
        await printReceipt({
          orderNumber: order.orderNumber,
          tableNumber: order.tableNumber,
          items: order.items,
          totalAmount: order.totalAmount,
          paymentMethod: order.paymentMethod || 'cash'
        });
        
        alert('âœ… ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å†å°åˆ·ã—ã¾ã—ãŸ');
      } catch (e) {
        console.error('å†å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        alert('âŒ å†å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
  </script>
</body>
</html>
