<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç²‰ã‚‚ã‚“å±‹ å…« - ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ å®Œå…¨ç‰ˆ</title>
  
  <!-- Star mC-Print3 SDK -->
  <script src="https://www.star-m.jp/products/s_print/sdk/starwebprinttracer/v1.1.0/StarWebPrintTrader.js"></script>
  <script src="https://www.star-m.jp/products/s_print/sdk/starwebprintbuilder/v1.2.0/StarWebPrintBuilder.js"></script>
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, query, where, getDocs, updateDoc, doc, Timestamp, onSnapshot, addDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    
    const firebaseConfig = {
      apiKey: "AIzaSyCkL0NFOvB40TG2Ssmwp61kIcsADUxkuro",
      authDomain: "hachi-akatsuka.firebaseapp.com",
      projectId: "hachi-akatsuka",
      storageBucket: "hachi-akatsuka.firebasestorage.app",
      messagingSenderId: "441792715943",
      appId: "1:441792715943:web:3dc2a4c7d36e4bb2ad72ea"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    window.db = db;
    window.collection = collection;
    window.query = query;
    window.where = where;
    window.getDocs = getDocs;
    window.updateDoc = updateDoc;
    window.doc = doc;
    window.Timestamp = Timestamp;
    window.onSnapshot = onSnapshot;
    window.addDoc = addDoc;
    window.orderBy = orderBy;
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1800px;
      margin: 0 auto;
    }
    
    .header {
      background: white;
      padding: 25px;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      margin-bottom: 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .header h1 {
      font-size: 32px;
      color: #333;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .header-btn {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .header-btn.drawer {
      background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);
      color: white;
    }
    
    .header-btn.history {
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
    }
    
    .header-btn.settlement {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
    }
    
    .header-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .sales-summary {
      background: #f8f9fa;
      padding: 15px 20px;
      border-radius: 12px;
      display: flex;
      gap: 30px;
    }
    
    .sales-item {
      text-align: center;
    }
    
    .sales-label {
      font-size: 12px;
      color: #666;
    }
    
    .sales-value {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .main-content {
      display: grid;
      grid-template-columns: 1.2fr 1fr 1fr;
      gap: 25px;
    }
    
    @media (max-width: 1400px) {
      .main-content {
        grid-template-columns: 1fr;
      }
    }
    
    .section {
      background: white;
      border-radius: 20px;
      padding: 25px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
    }
    
    .section h2 {
      font-size: 24px;
      color: #333;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 3px solid #667eea;
    }
    
    /* æ³¨æ–‡ãƒªã‚¹ãƒˆ */
    .orders-list {
      max-height: 600px;
      overflow-y: auto;
    }
    
    .order-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 5px solid #667eea;
    }
    
    .order-card.assigned {
      border-left-color: #4CAF50;
      background: #e8f5e9;
    }
    
    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .order-number {
      font-size: 24px;
      font-weight: bold;
      color: #667eea;
    }
    
    .order-source {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
    }
    
    .order-items {
      margin: 10px 0;
    }
    
    .order-item {
      padding: 8px 0;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #ddd;
    }
    
    .item-name {
      font-weight: 500;
    }
    
    .item-price {
      font-weight: bold;
      color: #667eea;
    }
    
    .order-total {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 2px solid #667eea;
      font-size: 20px;
      font-weight: bold;
    }
    
    .order-actions {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 15px;
    }
    
    .btn {
      padding: 12px;
      font-size: 14px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: #4CAF50;
      color: white;
    }
    
    .btn-warning {
      background: #FF9800;
      color: white;
    }
    
    .btn-info {
      background: #2196F3;
      color: white;
    }
    
    .btn-danger {
      background: #f44336;
      color: white;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }
    
    .btn-large {
      padding: 18px;
      font-size: 18px;
      border-radius: 12px;
      margin-top: 15px;
    }
    
    /* ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœã‚¿ãƒ³ */
    .table-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
    }
    
    .table-btn {
      padding: 20px;
      font-size: 18px;
      font-weight: bold;
      border: 3px solid #ddd;
      border-radius: 15px;
      cursor: pointer;
      background: white;
      transition: all 0.3s;
      position: relative;
    }
    
    .table-btn:hover {
      border-color: #667eea;
      background: #f8f9fa;
    }
    
    .table-btn.selected {
      border-color: #4CAF50;
      background: #e8f5e9;
    }
    
    .table-order-count {
      position: absolute;
      top: 5px;
      right: 5px;
      background: #f44336;
      color: white;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: bold;
    }
    
    .memo-icon {
      position: absolute;
      top: 5px;
      left: 5px;
      font-size: 16px;
      cursor: pointer;
      opacity: 0.3;
    }
    
    .memo-icon:hover {
      opacity: 1;
    }
    
    /* æ‰‹å‹•å…¥åŠ› */
    .menu-item-checkbox {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }
    
    .menu-item-checkbox:hover {
      background: #f0f0f0;
    }
    
    .menu-item-checkbox input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
      cursor: pointer;
    }
    
    .menu-item-info {
      flex: 1;
    }
    
    .menu-item-name-small {
      font-weight: 500;
      color: #333;
    }
    
    .menu-item-price-small {
      color: #667eea;
      font-weight: bold;
      font-size: 14px;
    }
    
    .selected-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      background: white;
      border-radius: 8px;
    }
    
    .quantity-input {
      width: 60px;
      padding: 5px;
      text-align: center;
      border: 2px solid #ddd;
      border-radius: 5px;
      margin: 0 10px;
    }
    
    .remove-btn {
      padding: 5px 12px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    
    .topping-btn {
      padding: 5px 12px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 5px;
    }
    
    /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 600px;
      width: 90%;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal h3 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    
    .topping-options {
      display: grid;
      gap: 10px;
      margin: 20px 0;
    }
    
    .topping-option {
      display: flex;
      align-items: center;
      padding: 15px;
      border: 2px solid #ddd;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .topping-option:hover {
      border-color: #4CAF50;
      background: #f0f0f0;
    }
    
    .topping-option.selected {
      border-color: #4CAF50;
      background: #e8f5e9;
    }
    
    .topping-option input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin-right: 10px;
    }
    
    .payment-methods {
      display: grid;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .payment-method-btn {
      padding: 20px;
      font-size: 20px;
      font-weight: bold;
      border: 3px solid #ddd;
      border-radius: 12px;
      cursor: pointer;
      background: white;
    }
    
    .payment-method-btn.selected {
      border-color: #667eea;
      background: #e8eaf6;
    }
    
    .cash-input-section {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 12px;
    }
    
    .cash-input-section input {
      width: 100%;
      padding: 15px;
      font-size: 24px;
      border: 2px solid #ddd;
      border-radius: 8px;
      text-align: right;
    }
    
    .change-display {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border-radius: 8px;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
    }
    
    .change-amount {
      color: #4CAF50;
      font-size: 28px;
    }
    
    .hidden {
      display: none !important;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
      font-size: 18px;
    }
    
    /* å±¥æ­´ */
    .history-list {
      max-height: 500px;
      overflow-y: auto;
    }
    
    .history-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
      border-left: 5px solid #4CAF50;
    }
    
    /* ç²¾ç®—è©³ç´° */
    .settlement-details {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 12px;
      margin-bottom: 20px;
    }
    
    .settlement-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #ddd;
    }
    
    .settlement-row:last-child {
      border-bottom: none;
    }
    
    .settlement-row.highlight {
      font-weight: bold;
      font-size: 20px;
      color: #4CAF50;
      padding-top: 15px;
      border-top: 3px solid #4CAF50;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="header">
      <div>
        <h1>ğŸ§¾ ãƒ¬ã‚¸ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå®Œå…¨ç‰ˆï¼‰</h1>
        <div style="color: #666;">ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—</div>
      </div>
      <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
        <div class="sales-summary">
          <div class="sales-item">
            <div class="sales-label">å®¢æ•°</div>
            <div class="sales-value" id="customerCount">0</div>
          </div>
          <div class="sales-item">
            <div class="sales-label">æœ¬æ—¥å£²ä¸Š</div>
            <div class="sales-value" id="todaySales">Â¥0</div>
          </div>
        </div>
        <div class="header-actions">
          <button class="header-btn drawer" onclick="openDrawer()">ğŸ’µ ãƒ‰ãƒ­ã‚¢</button>
          <button class="header-btn history" onclick="showHistoryModal()">ğŸ“œ å±¥æ­´</button>
          <button class="header-btn settlement" onclick="showSettlementModal()">ğŸ“Š ç²¾ç®—</button>
        </div>
      </div>
    </div>
    
    <div class="main-content">
      <!-- å·¦å´: æœªæŒ¯ã‚Šåˆ†ã‘æ³¨æ–‡ -->
      <div class="section">
        <h2>ğŸ“‹ æ³¨æ–‡ä¸€è¦§ï¼ˆæœªæŒ¯ã‚Šåˆ†ã‘ï¼‰</h2>
        <div id="ordersList" class="orders-list">
          <div class="empty-state">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
      
      <!-- ä¸­å¤®: æ‰‹å‹•å…¥åŠ› -->
      <div class="section">
        <h2>âœï¸ æ‰‹å‹•ãƒ¬ã‚¸å…¥åŠ›</h2>
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 8px;">æŒ¯ã‚Šåˆ†ã‘å…ˆãƒ†ãƒ¼ãƒ–ãƒ«</label>
          <select id="manualTable" style="width: 100%; padding: 12px; font-size: 16px; border: 2px solid #ddd; border-radius: 8px;">
            <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
          </select>
        </div>
        
        <div style="margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 8px;">å•†å“ã‚’é¸æŠ</label>
          <div style="max-height: 250px; overflow-y: auto; border: 2px solid #ddd; border-radius: 8px; padding: 10px; background: white;">
            <div id="menuItemsList"></div>
          </div>
        </div>
        
        <div id="selectedItems" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; min-height: 100px;">
          <div class="empty-state" style="padding: 20px;">å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>
        </div>
        
        <div style="font-size: 20px; font-weight: bold; text-align: right; margin-bottom: 15px;">
          åˆè¨ˆ: <span id="manualTotal" style="color: #4CAF50;">Â¥0</span>
        </div>
        
        <button class="btn btn-primary btn-large" style="width: 100%;" onclick="submitManualOrder()" id="manualSubmitBtn" disabled>æ³¨æ–‡ã‚’è¿½åŠ </button>
      </div>
      
      <!-- å³å´: ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç† -->
      <div class="section">
        <h2>ğŸ  ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†</h2>
        <div class="table-grid" id="tableGrid"></div>
        
        <div id="tableOrdersSection" style="margin-top: 20px;" class="hidden">
          <h3 style="margin: 20px 0 10px 0;">ğŸ“ <span id="selectedTableLabel"></span> ã®æ³¨æ–‡</h3>
          <div id="tableOrdersList"></div>
          <div id="tableActions" class="hidden">
            <button class="btn btn-warning btn-large" style="width: 100%;" onclick="showDiscountModal()">ğŸ’° å€¤å¼•ã</button>
            <button class="btn btn-primary btn-large" style="width: 100%;" onclick="showPaymentModal()">ğŸ’³ ä¼šè¨ˆå‡¦ç†</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ç¾¤ -->
  
  <!-- ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="assignModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ“ ãƒ†ãƒ¼ãƒ–ãƒ«ã«æŒ¯ã‚Šåˆ†ã‘</h3>
      <div style="margin-bottom: 20px;">
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">æ³¨æ–‡ #<span id="assignOrderNumber"></span></div>
      </div>
      <div class="table-grid" id="assignTableGrid"></div>
      <button class="btn btn-danger btn-large" style="width: 100%;" onclick="closeAssignModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  
  <!-- ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="toppingModal" class="modal-overlay hidden">
    <div class="modal">
      <h3 id="toppingModalTitle">ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’é¸æŠ</h3>
      <div id="toppingOptions" class="topping-options"></div>
      <button class="btn btn-primary btn-large" style="width: 100%;" onclick="applyTopping()">ãƒˆãƒƒãƒ”ãƒ³ã‚°ç¢ºå®š</button>
      <button class="btn btn-danger" style="width: 100%; margin-top: 10px;" onclick="closeToppingModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  
  <!-- æ”¯æ‰•ã„ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="paymentModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ’³ æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠ</h3>
      <div class="payment-methods">
        <button class="payment-method-btn" onclick="selectPaymentMethod('cash')">ğŸ’µ ç¾é‡‘</button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('emoney')">ğŸ“± é›»å­ãƒãƒãƒ¼</button>
        <button class="payment-method-btn" onclick="selectPaymentMethod('credit')">ğŸ’³ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</button>
      </div>
      
      <div id="cashInputSection" class="cash-input-section hidden">
        <label>ãŠé ã‹ã‚Šé‡‘é¡</label>
        <input type="number" id="cashReceived" placeholder="0" oninput="calculateChange()">
        <div class="change-display">
          ãŠã¤ã‚Š: <span class="change-amount" id="changeAmount">Â¥0</span>
        </div>
      </div>
      
      <button class="btn btn-primary btn-large" style="width: 100%;" onclick="completePayment()" id="completePaymentBtn" disabled>ä¼šè¨ˆå®Œäº†</button>
      <button class="btn btn-danger" style="width: 100%; margin-top: 10px;" onclick="closePaymentModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  
  <!-- å€¤å¼•ããƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="discountModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ’° å€¤å¼•ãè¨­å®š</h3>
      <div style="margin: 20px 0;">
        <label style="display: block; font-weight: bold; margin-bottom: 10px;">å€¤å¼•ãé‡‘é¡ã‚’å…¥åŠ›</label>
        <input type="number" id="discountAmount" placeholder="0" oninput="updateDiscountPreview()" 
               style="width: 100%; padding: 15px; font-size: 24px; border: 2px solid #ddd; border-radius: 8px; text-align: right;">
      </div>
      
      <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 20px 0;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 18px;">
          <span>å…ƒã®é‡‘é¡:</span>
          <span id="originalAmount">Â¥0</span>
        </div>
        <div style="display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 18px;">
          <span>å€¤å¼•ãé¡:</span>
          <span id="discountValue">-Â¥0</span>
        </div>
        <div style="display: flex; justify-content: space-between; font-weight: bold; font-size: 20px; padding-top: 10px; border-top: 2px solid #ddd; color: #FF9800;">
          <span>å€¤å¼•ãå¾Œ:</span>
          <span id="discountedAmount">Â¥0</span>
        </div>
      </div>
      
      <button class="btn btn-warning btn-large" style="width: 100%;" onclick="applyDiscount()">å€¤å¼•ãé©ç”¨</button>
      <button class="btn btn-danger" style="width: 100%; margin-top: 10px;" onclick="closeDiscountModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  
  <!-- ãƒ¡ãƒ¢ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="memoModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ“ ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¡ãƒ¢ - <span id="memoTableName"></span></h3>
      <textarea id="memoTextarea" 
                style="width: 100%; min-height: 150px; padding: 15px; font-size: 16px; 
                       border: 2px solid #ddd; border-radius: 8px; resize: vertical;"
                placeholder="äºˆç´„è€…åã€äººæ•°ã€ç‰¹è¨˜äº‹é …ãªã©..."></textarea>
      <button class="btn btn-primary btn-large" style="width: 100%; margin-top: 15px;" onclick="saveMemo()">ğŸ’¾ ä¿å­˜</button>
      <button class="btn btn-danger" style="width: 100%; margin-top: 10px;" onclick="closeMemoModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
  
  <!-- å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="historyModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ“œ ä¼šè¨ˆå±¥æ­´</h3>
      <div id="historyList" class="history-list">
        <div class="empty-state">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
      <button class="btn btn-danger btn-large" style="width: 100%;" onclick="closeHistoryModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>
  
  <!-- ç²¾ç®—ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="settlementModal" class="modal-overlay hidden">
    <div class="modal">
      <h3>ğŸ“Š æœ¬æ—¥ã®ç²¾ç®—</h3>
      <div class="settlement-details" id="settlementDetails">
        <div class="empty-state">è¨ˆç®—ä¸­...</div>
      </div>
      <button class="btn btn-primary btn-large" style="width: 100%;" onclick="printSettlement()">ğŸ–¨ï¸ ç²¾ç®—ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·</button>
      <button class="btn btn-danger" style="width: 100%; margin-top: 10px;" onclick="closeSettlementModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

  <script>
    // ============================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    // ============================================
    
    const PRINTER_IP = '192.168.244.41';
    
    const TABLES = [
      'ãƒ†ãƒ¼ãƒ–ãƒ«H', 'ãƒ†ãƒ¼ãƒ–ãƒ«M', 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼1', 'ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼2',
      'äºˆç´„1', 'äºˆç´„2', 'äºˆç´„3', 'äºˆç´„4', 'äºˆç´„5'
    ];
    
    // Firebaseã‹ã‚‰èª­ã¿è¾¼ã‚€ãŸã‚å›ºå®šãƒ‡ãƒ¼ã‚¿ã¯å‰Šé™¤
    let allMenuItems = [];
    let allToppingsMap = new Map(); // toppingId -> topping data
    
    let allOrders = [];
    let tableOrders = {};
    let selectedTable = null;
    let tableMemos = {};
    let currentAssignOrder = null;
    let selectedPaymentMethod = null;
    let totalAmountToPay = 0;
    let cashReceived = 0;
    let changeAmount = 0;
    let discountAmount = 0;
    let manualCart = [];
    let currentToppingItem = null;
    let selectedToppings = [];
    let lastPaymentData = null;
    let todaySalesData = {
      customerCount: 0,
      totalSales: 0,
      tax8Total: 0,
      tax10Total: 0,
      cashTotal: 0,
      emoneyTotal: 0,
      creditTotal: 0
    };
    
    // ============================================
    // åˆæœŸåŒ–
    // ============================================
    
    window.addEventListener('load', async () => {
      await initializeSystem();
    });
    
    async function initializeSystem() {
      const savedMemos = localStorage.getItem('tableMemos');
      if (savedMemos) {
        tableMemos = JSON.parse(savedMemos);
      }
      
      const savedTableOrders = localStorage.getItem('tableOrders');
      if (savedTableOrders) {
        tableOrders = JSON.parse(savedTableOrders);
      }
      
      // Firebaseã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿
      await loadMenuAndToppingsFromFirebase();
      
      generateTableButtons();
      generateAssignTableButtons();
      
      const manualTable = document.getElementById('manualTable');
      TABLES.forEach(table => {
        const option = document.createElement('option');
        option.value = table;
        option.textContent = table;
        manualTable.appendChild(option);
      });
      
      displayMenuItems();
      startRealtimeMonitoring();
      await calculateTodaySales();
      
      TABLES.forEach(table => {
        if (table.startsWith('äºˆç´„')) {
          updateMemoIndicator(table);
        }
      });
    }
    
    // ============================================
    // Firebaseã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿
    // ============================================
    
    async function loadMenuAndToppingsFromFirebase() {
      try {
        console.log('ğŸ“‹ Firebaseã‹ã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¨ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­...');
        
        // ãƒˆãƒƒãƒ”ãƒ³ã‚°èª­ã¿è¾¼ã¿
        const toppingsSnapshot = await getDocs(collection(db, 'toppings'));
        allToppingsMap.clear();
        
        toppingsSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.id) {
            allToppingsMap.set(data.id, {
              id: data.id,
              name: data.name,
              price: data.price || 0,
              order: data.order || 99
            });
          }
        });
        
        console.log('âœ… ãƒˆãƒƒãƒ”ãƒ³ã‚°èª­ã¿è¾¼ã¿å®Œäº†:', allToppingsMap.size, 'ä»¶');
        
        // ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿
        const menuSnapshot = await getDocs(collection(db, 'menu'));
        allMenuItems = [];
        
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.id) {
            allMenuItems.push({
              id: data.id,
              name: data.name,
              price: data.price || 0,
              category: data.category || 'ãã®ä»–',
              toppingsId: data.toppingsId || '',
              note: data.note || '',
              image: data.image || ''
            });
          }
        });
        
        // IDé †ã«ã‚½ãƒ¼ãƒˆ
        allMenuItems.sort((a, b) => {
          if (a.id < b.id) return -1;
          if (a.id > b.id) return 1;
          return 0;
        });
        
        console.log('âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿å®Œäº†:', allMenuItems.length, 'ä»¶');
        
      } catch (e) {
        console.error('âŒ Firebaseèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        alert('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    }
    
    // ============================================
    // ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†
    // ============================================
    
    function generateTableButtons() {
      const grid = document.getElementById('tableGrid');
      grid.innerHTML = '';
      
      TABLES.forEach(table => {
        const btn = document.createElement('button');
        btn.className = 'table-btn';
        btn.id = `table-${table}`;
        
        if (table.startsWith('äºˆç´„')) {
          const memoIcon = document.createElement('span');
          memoIcon.className = 'memo-icon';
          memoIcon.innerHTML = 'ğŸ“';
          memoIcon.onclick = (e) => {
            e.stopPropagation();
            showMemoModal(table);
          };
          btn.appendChild(memoIcon);
        }
        
        const label = document.createElement('span');
        label.textContent = table;
        btn.appendChild(label);
        
        const orderCount = tableOrders[table] ? tableOrders[table].length : 0;
        if (orderCount > 0) {
          const badge = document.createElement('span');
          badge.className = 'table-order-count';
          badge.textContent = orderCount;
          btn.appendChild(badge);
        }
        
        btn.onclick = () => selectTable(table);
        grid.appendChild(btn);
      });
    }
    
    function generateAssignTableButtons() {
      const grid = document.getElementById('assignTableGrid');
      grid.innerHTML = '';
      
      TABLES.forEach(table => {
        const btn = document.createElement('button');
        btn.className = 'table-btn';
        btn.textContent = table;
        btn.onclick = () => assignOrderToTable(table);
        grid.appendChild(btn);
      });
    }
    
    function updateMemoIndicator(table) {
      const btn = document.getElementById(`table-${table}`);
      if (!btn) return;
      
      const memoIcon = btn.querySelector('.memo-icon');
      if (memoIcon) {
        if (tableMemos[table] && tableMemos[table].trim()) {
          memoIcon.style.opacity = '1';
        } else {
          memoIcon.style.opacity = '0.3';
        }
      }
    }
    
    window.selectTable = function(table) {
      selectedTable = table;
      
      document.querySelectorAll('.table-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      
      const btn = document.getElementById(`table-${table}`);
      if (btn) {
        btn.classList.add('selected');
      }
      
      document.getElementById('selectedTableLabel').textContent = table;
      document.getElementById('tableOrdersSection').classList.remove('hidden');
      
      displayTableOrders(table);
    };
    
    function displayTableOrders(table) {
      const container = document.getElementById('tableOrdersList');
      const actionsDiv = document.getElementById('tableActions');
      
      if (!tableOrders[table] || tableOrders[table].length === 0) {
        container.innerHTML = '<div class="empty-state">ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã«æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        actionsDiv.classList.add('hidden');
        return;
      }
      
      container.innerHTML = '';
      let total = 0;
      
      tableOrders[table].forEach(orderNumber => {
        const order = allOrders.find(o => o.orderNumber === orderNumber);
        if (!order) return;
        
        total += order.totalAmount;
        
        const card = document.createElement('div');
        card.style.cssText = 'background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 5px solid #4CAF50;';
        
        let itemsHtml = '';
        order.items.forEach(item => {
          const subtotal = item.price * item.quantity;
          itemsHtml += `
            <div style="padding: 8px 0; display: flex; justify-content: space-between; border-bottom: 1px solid #ddd;">
              <div>
                <div style="font-weight: 500;">${item.name} Ã— ${item.quantity}</div>
                ${item.toppings && item.toppings !== 'ãªã—' ? `<div style="font-size: 12px; color: #666;">TP: ${item.toppings}</div>` : ''}
              </div>
              <div style="font-weight: bold; color: #667eea;">Â¥${subtotal.toLocaleString()}</div>
            </div>
          `;
        });
        
        card.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div style="font-size: 24px; font-weight: bold; color: #667eea;">#${order.orderNumber}</div>
          </div>
          <div style="margin: 10px 0;">${itemsHtml}</div>
          <div style="display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 2px solid #667eea; font-size: 20px; font-weight: bold;">
            <span>å°è¨ˆ</span>
            <span>Â¥${order.totalAmount.toLocaleString()}</span>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
            <button class="btn btn-danger" onclick="removeOrderFromTable('${table}', ${orderNumber})">âŒ å‰Šé™¤</button>
            <button class="btn btn-primary" onclick="quickCheckoutSingle(${orderNumber})">ğŸ’³ å€‹åˆ¥ä¼šè¨ˆ</button>
          </div>
        `;
        
        container.appendChild(card);
      });
      
      const totalCard = document.createElement('div');
      totalCard.style.cssText = 'font-size: 24px; font-weight: bold; text-align: right; margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 12px;';
      totalCard.innerHTML = `åˆè¨ˆ: Â¥${total.toLocaleString()}`;
      container.appendChild(totalCard);
      
      actionsDiv.classList.remove('hidden');
      totalAmountToPay = total;
    }
    
    // ============================================
    // Firebaseãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–
    // ============================================
    
    function startRealtimeMonitoring() {
      const q = query(
        collection(db, 'orders'),
        orderBy('timestamp', 'desc')
      );
      
      onSnapshot(q, (snapshot) => {
        allOrders = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          if (!data.paidAt && !data.cancelledAt) {
            allOrders.push({ id: doc.id, ...data });
          }
        });
        
        displayAllOrders();
        updateTableButtons();
        
        if (selectedTable) {
          displayTableOrders(selectedTable);
        }
      });
    }
    
    function displayAllOrders() {
      const container = document.getElementById('ordersList');
      
      const unassignedOrders = allOrders.filter(order => {
        return !isOrderAssignedToAnyTable(order.orderNumber);
      });
      
      if (unassignedOrders.length === 0) {
        container.innerHTML = '<div class="empty-state">æœªæŒ¯ã‚Šåˆ†ã‘ã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = '';
      
      unassignedOrders.forEach(order => {
        const card = createOrderCard(order);
        container.appendChild(card);
      });
    }
    
    function isOrderAssignedToAnyTable(orderNumber) {
      for (let table in tableOrders) {
        if (tableOrders[table].includes(orderNumber)) {
          return true;
        }
      }
      return false;
    }
    
    function createOrderCard(order) {
      const card = document.createElement('div');
      card.className = 'order-card';
      
      let itemsHtml = '';
      order.items.forEach(item => {
        const subtotal = item.price * item.quantity;
        itemsHtml += `
          <div class="order-item">
            <div>
              <div class="item-name">${item.name} Ã— ${item.quantity}</div>
              ${item.toppings && item.toppings !== 'ãªã—' ? `<div style="font-size: 12px; color: #666;">TP: ${item.toppings}</div>` : ''}
            </div>
            <div class="item-price">Â¥${subtotal.toLocaleString()}</div>
          </div>
        `;
      });
      
      card.innerHTML = `
        <div class="order-header">
          <div class="order-number">#${order.orderNumber}</div>
        </div>
        <div class="order-source">ã”åˆ©ç”¨: ${order.tableNumber}</div>
        <div class="order-items">${itemsHtml}</div>
        <div class="order-total">
          <span>åˆè¨ˆ</span>
          <span>Â¥${order.totalAmount.toLocaleString()}</span>
        </div>
        <div class="order-actions">
          <button class="btn btn-info" onclick="assignOrder(${order.orderNumber})">ğŸ“ æŒ¯ã‚Šåˆ†ã‘</button>
          <button class="btn btn-primary" onclick="quickCheckout(${order.orderNumber})">ğŸ’³ å³ä¼šè¨ˆ</button>
          <button class="btn btn-warning" onclick="quickCheckoutWithDiscount(${order.orderNumber})">ğŸ’° å€¤å¼•ãä¼šè¨ˆ</button>
        </div>
      `;
      
      return card;
    }
    
    // ============================================
    // æ³¨æ–‡æŒ¯ã‚Šåˆ†ã‘
    // ============================================
    
    window.assignOrder = function(orderNumber) {
      currentAssignOrder = orderNumber;
      document.getElementById('assignOrderNumber').textContent = orderNumber;
      document.getElementById('assignModal').classList.remove('hidden');
    };
    
    window.assignOrderToTable = function(table) {
      if (!tableOrders[table]) {
        tableOrders[table] = [];
      }
      
      if (!tableOrders[table].includes(currentAssignOrder)) {
        tableOrders[table].push(currentAssignOrder);
      }
      
      localStorage.setItem('tableOrders', JSON.stringify(tableOrders));
      
      closeAssignModal();
      displayAllOrders();
      updateTableButtons();
      
      if (selectedTable === table) {
        displayTableOrders(table);
      }
    };
    
    window.closeAssignModal = function() {
      document.getElementById('assignModal').classList.add('hidden');
      currentAssignOrder = null;
    };
    
    window.removeOrderFromTable = function(table, orderNumber) {
      if (tableOrders[table]) {
        tableOrders[table] = tableOrders[table].filter(n => n !== orderNumber);
        localStorage.setItem('tableOrders', JSON.stringify(tableOrders));
      }
      
      displayTableOrders(table);
      displayAllOrders();
      updateTableButtons();
    };
    
    function updateTableButtons() {
      generateTableButtons();
      
      TABLES.forEach(table => {
        if (table.startsWith('äºˆç´„')) {
          const btn = document.getElementById(`table-${table}`);
          const memoIcon = btn ? btn.querySelector('.memo-icon') : null;
          if (memoIcon) {
            if (tableMemos[table] && tableMemos[table].trim()) {
              memoIcon.style.opacity = '1';
            } else {
              memoIcon.style.opacity = '0.3';
            }
          }
        }
      });
      
      if (selectedTable) {
        const btn = document.getElementById(`table-${selectedTable}`);
        if (btn) {
          btn.classList.add('selected');
        }
      }
    }
    
    // ============================================
    // ç¶šã...
    // ============================================
  </script>
</body>
</html>
    
    // ============================================
    // æ‰‹å‹•ãƒ¬ã‚¸å…¥åŠ›
    // ============================================
    
    function displayMenuItems() {
      const container = document.getElementById('menuItemsList');
      container.innerHTML = '';
      
      if (allMenuItems.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>';
        return;
      }
      
      allMenuItems.forEach(item => {
        const div = document.createElement('div');
        div.className = 'menu-item-checkbox';
        div.innerHTML = `
          <input type="checkbox" id="menu-${item.id}" value="${item.id}" onchange="toggleMenuItem('${item.id}')">
          <div class="menu-item-info">
            <div class="menu-item-name-small">${item.name}</div>
            <div class="menu-item-price-small">Â¥${item.price.toLocaleString()}</div>
          </div>
        `;
        container.appendChild(div);
      });
    }
    
    window.toggleMenuItem = function(itemId) {
      const checkbox = document.getElementById(`menu-${itemId}`);
      const item = allMenuItems.find(m => m.id === itemId);
      
      if (!item) return;
      
      if (checkbox.checked) {
        // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãŒã‚ã‚‹å•†å“ã‹ãƒã‚§ãƒƒã‚¯
        if (item.toppingsId && item.toppingsId.trim()) {
          currentToppingItem = item;
          selectedToppings = [];
          showToppingModal(item);
        } else {
          manualCart.push({
            ...item,
            quantity: 1,
            toppings: 'ãªã—',
            toppingPrice: 0
          });
          updateManualCart();
        }
      } else {
        manualCart = manualCart.filter(i => i.id !== itemId);
        updateManualCart();
      }
    };
    
    function updateManualCart() {
      const container = document.getElementById('selectedItems');
      const submitBtn = document.getElementById('manualSubmitBtn');
      const manualTable = document.getElementById('manualTable');
      
      if (manualCart.length === 0) {
        container.innerHTML = '<div class="empty-state" style="padding: 20px;">å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„</div>';
        submitBtn.disabled = true;
        document.getElementById('manualTotal').textContent = 'Â¥0';
        return;
      }
      
      container.innerHTML = '';
      let total = 0;
      
      manualCart.forEach((item, index) => {
        const subtotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
        total += subtotal;
        
        const div = document.createElement('div');
        div.className = 'selected-item';
        
        const hasToppings = item.toppingsId && item.toppingsId.trim();
        
        div.innerHTML = `
          <div>
            <div>${item.name}</div>
            ${item.toppings && item.toppings !== 'ãªã—' ? `<div style="font-size: 12px; color: #666;">TP: ${item.toppings}</div>` : ''}
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <input type="number" class="quantity-input" min="1" value="${item.quantity}" 
                   onchange="updateQuantity(${index}, this.value)">
            <span style="min-width: 80px; text-align: right; font-weight: bold;">Â¥${subtotal.toLocaleString()}</span>
            ${hasToppings ? `<button class="topping-btn" onclick="editTopping(${index})">ğŸ´</button>` : ''}
            <button class="remove-btn" onclick="removeFromManualCart(${index})">å‰Šé™¤</button>
          </div>
        `;
        container.appendChild(div);
      });
      
      document.getElementById('manualTotal').textContent = `Â¥${total.toLocaleString()}`;
      submitBtn.disabled = manualCart.length === 0 || !manualTable.value;
    }
    
    window.updateQuantity = function(index, value) {
      const qty = parseInt(value) || 1;
      manualCart[index].quantity = Math.max(1, qty);
      updateManualCart();
    };
    
    window.removeFromManualCart = function(index) {
      const item = manualCart[index];
      const checkbox = document.getElementById(`menu-${item.id}`);
      if (checkbox) checkbox.checked = false;
      
      manualCart.splice(index, 1);
      updateManualCart();
    };
    
    window.editTopping = function(index) {
      const item = manualCart[index];
      currentToppingItem = item;
      
      // æ—¢å­˜ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’å¾©å…ƒ
      selectedToppings = [];
      if (item.toppings && item.toppings !== 'ãªã—') {
        const toppingNames = item.toppings.split(', ');
        
        // toppingsIdã‹ã‚‰åˆ©ç”¨å¯èƒ½ãªãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’å–å¾—
        if (item.toppingsId) {
          const toppingIds = item.toppingsId.split(',').map(id => id.trim());
          toppingIds.forEach(toppingId => {
            const topping = allToppingsMap.get(toppingId);
            if (topping && toppingNames.includes(topping.name)) {
              selectedToppings.push(topping);
            }
          });
        }
      }
      
      showToppingModal(item, index);
    };
    
    window.submitManualOrder = async function() {
      const tableNumber = document.getElementById('manualTable').value;
      
      if (!tableNumber || manualCart.length === 0) {
        alert('ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã¨å•†å“ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      try {
        const now = new Date();
        const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        
        const todayStart = new Date(jstNow);
        todayStart.setHours(1, 0, 0, 0);
        if (jstNow < todayStart) {
          todayStart.setDate(todayStart.getDate() - 1);
        }
        
        const ordersSnapshot = await getDocs(collection(db, 'orders'));
        let maxOrderNumber = 618;
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          const orderDate = data.timestamp.toDate();
          const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
          
          if (jstOrderDate >= todayStart && data.orderNumber > maxOrderNumber) {
            maxOrderNumber = data.orderNumber;
          }
        });
        
        const orderNumber = maxOrderNumber + 1;
        
        let totalAmount = 0;
        manualCart.forEach(item => {
          totalAmount += (item.price + (item.toppingPrice || 0)) * item.quantity;
        });
        
        const deleteAt = new Date(now.getTime() + 10 * 60 * 1000);
        
        const orderData = {
          orderNumber: orderNumber,
          timestamp: Timestamp.fromDate(now),
          tableNumber: `æ‰‹å‹•å…¥åŠ›_${tableNumber}`,
          items: manualCart,
          totalAmount: totalAmount,
          status: 'pending',
          deleteAt: Timestamp.fromDate(deleteAt),
          cancelledAt: null,
          completedAt: null,
          paidAt: null,
          notifiedComplete: false,
          notifiedCancel: false,
          notifiedPaid: false,
          manualEntry: true
        };
        
        const docRef = await addDoc(collection(db, 'orders'), orderData);
        
        await updateDoc(docRef, {
          orderId: docRef.id
        });
        
        if (!tableOrders[tableNumber]) {
          tableOrders[tableNumber] = [];
        }
        tableOrders[tableNumber].push(orderNumber);
        localStorage.setItem('tableOrders', JSON.stringify(tableOrders));
        
        alert(`æ³¨æ–‡ #${orderNumber} ã‚’è¿½åŠ ã—ã€${tableNumber}ã«æŒ¯ã‚Šåˆ†ã‘ã¾ã—ãŸï¼`);
        
        manualCart = [];
        document.getElementById('manualTable').value = '';
        document.querySelectorAll('#menuItemsList input[type="checkbox"]').forEach(cb => cb.checked = false);
        updateManualCart();
        updateTableButtons();
        
      } catch (e) {
        console.error('æ³¨æ–‡ã‚¨ãƒ©ãƒ¼:', e);
        alert('æ³¨æ–‡ã®è¿½åŠ ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    // ============================================
    // ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠ
    // ============================================
    
    function showToppingModal(item, editIndex = null) {
      const modal = document.getElementById('toppingModal');
      const title = document.getElementById('toppingModalTitle');
      const container = document.getElementById('toppingOptions');
      
      title.textContent = `${item.name} - ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’é¸æŠ`;
      container.innerHTML = '';
      
      if (!item.toppingsId || !item.toppingsId.trim()) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">ã“ã®ã‚¢ã‚¤ãƒ†ãƒ ã«ãƒˆãƒƒãƒ”ãƒ³ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        modal.classList.remove('hidden');
        return;
      }
      
      // toppingsIdã‚’ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã§åˆ†å‰²
      const toppingIds = item.toppingsId.split(',').map(id => id.trim());
      const toppings = [];
      
      // è©²å½“ã™ã‚‹ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’å–å¾—
      toppingIds.forEach(toppingId => {
        if (allToppingsMap.has(toppingId)) {
          toppings.push(allToppingsMap.get(toppingId));
        }
      });
      
      // orderã§ã‚½ãƒ¼ãƒˆ
      toppings.sort((a, b) => a.order - b.order);
      
      if (toppings.length === 0) {
        container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">ãƒˆãƒƒãƒ”ãƒ³ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
      } else {
        toppings.forEach(topping => {
          const isSelected = selectedToppings.some(t => t.id === topping.id);
          
          const div = document.createElement('div');
          div.className = 'topping-option' + (isSelected ? ' selected' : '');
          div.onclick = () => toggleTopping(topping, div);
          
          const priceText = topping.price > 0 ? ` (+Â¥${topping.price})` : ' (ç„¡æ–™)';
          
          div.innerHTML = `
            <input type="checkbox" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation()">
            <div style="flex: 1;">
              <div>${topping.name}</div>
              <div style="font-size: 14px; color: #666;">${priceText}</div>
            </div>
          `;
          
          container.appendChild(div);
        });
      }
      
      window.currentToppingEditIndex = editIndex;
      modal.classList.remove('hidden');
    }
    
    function toggleTopping(topping, element) {
      const checkbox = element.querySelector('input[type="checkbox"]');
      const index = selectedToppings.findIndex(t => t.id === topping.id);
      
      if (index >= 0) {
        selectedToppings.splice(index, 1);
        element.classList.remove('selected');
        checkbox.checked = false;
      } else {
        selectedToppings.push(topping);
        element.classList.add('selected');
        checkbox.checked = true;
      }
    }
    
    window.applyTopping = function() {
      let toppingsText = 'ãªã—';
      let toppingPrice = 0;
      
      if (selectedToppings.length > 0) {
        toppingsText = selectedToppings.map(t => t.name).join(', ');
        toppingPrice = selectedToppings.reduce((sum, t) => sum + (t.price || 0), 0);
      }
      
      if (window.currentToppingEditIndex !== null && window.currentToppingEditIndex !== undefined) {
        // æ—¢å­˜ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’ç·¨é›†
        manualCart[window.currentToppingEditIndex].toppings = toppingsText;
        manualCart[window.currentToppingEditIndex].toppingPrice = toppingPrice;
      } else {
        // æ–°ã—ã„ã‚¢ã‚¤ãƒ†ãƒ ã‚’è¿½åŠ 
        manualCart.push({
          ...currentToppingItem,
          quantity: 1,
          toppings: toppingsText,
          toppingPrice: toppingPrice
        });
      }
      
      updateManualCart();
      closeToppingModal();
    };
    
    window.closeToppingModal = function() {
      document.getElementById('toppingModal').classList.add('hidden');
      currentToppingItem = null;
      selectedToppings = [];
      window.currentToppingEditIndex = null;
    };
    
    // ============================================
    // ä¼šè¨ˆå‡¦ç†
    // ============================================
    
    window.quickCheckout = function(orderNumber) {
      const order = allOrders.find(o => o.orderNumber === orderNumber);
      if (!order) return;
      
      const tempTable = 'å³ä¼šè¨ˆ';
      tableOrders[tempTable] = [orderNumber];
      selectedTable = tempTable;
      totalAmountToPay = order.totalAmount;
      discountAmount = 0;
      
      showPaymentModal();
    };
    
    window.quickCheckoutWithDiscount = function(orderNumber) {
      const order = allOrders.find(o => o.orderNumber === orderNumber);
      if (!order) return;
      
      const tempTable = 'å³ä¼šè¨ˆ';
      tableOrders[tempTable] = [orderNumber];
      selectedTable = tempTable;
      totalAmountToPay = order.totalAmount;
      
      showDiscountModal();
    };
    
    window.quickCheckoutSingle = function(orderNumber) {
      const order = allOrders.find(o => o.orderNumber === orderNumber);
      if (!order) return;
      
      const tempTable = `${selectedTable}_å€‹åˆ¥`;
      tableOrders[tempTable] = [orderNumber];
      const originalTable = selectedTable;
      selectedTable = tempTable;
      totalAmountToPay = order.totalAmount;
      discountAmount = 0;
      
      showPaymentModal();
      
      window.afterPaymentCallback = () => {
        if (tableOrders[originalTable]) {
          tableOrders[originalTable] = tableOrders[originalTable].filter(n => n !== orderNumber);
          localStorage.setItem('tableOrders', JSON.stringify(tableOrders));
        }
        delete tableOrders[tempTable];
        selectedTable = originalTable;
        displayTableOrders(originalTable);
      };
    };
    
    window.showPaymentModal = function() {
      document.getElementById('paymentModal').classList.remove('hidden');
      selectedPaymentMethod = null;
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      document.getElementById('cashInputSection').classList.add('hidden');
      document.getElementById('completePaymentBtn').disabled = true;
    };
    
    window.selectPaymentMethod = function(method) {
      selectedPaymentMethod = method;
      
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      event.target.classList.add('selected');
      
      if (method === 'cash') {
        document.getElementById('cashInputSection').classList.remove('hidden');
        document.getElementById('completePaymentBtn').disabled = true;
      } else {
        document.getElementById('cashInputSection').classList.add('hidden');
        document.getElementById('completePaymentBtn').disabled = false;
      }
    };
    
    window.calculateChange = function() {
      cashReceived = parseInt(document.getElementById('cashReceived').value) || 0;
      changeAmount = cashReceived - totalAmountToPay;
      
      document.getElementById('changeAmount').textContent = `Â¥${changeAmount.toLocaleString()}`;
      document.getElementById('completePaymentBtn').disabled = cashReceived < totalAmountToPay;
    };
    
    window.completePayment = async function() {
      if (!selectedPaymentMethod) return;
      if (selectedPaymentMethod === 'cash' && cashReceived < totalAmountToPay) return;
      
      try {
        const now = Timestamp.now();
        const orderNumbers = tableOrders[selectedTable] || [];
        
        for (const orderNumber of orderNumbers) {
          const order = allOrders.find(o => o.orderNumber === orderNumber);
          if (!order) continue;
          
          await updateDoc(doc(db, 'orders', order.id), {
            paidAt: now,
            notifiedPaid: true,
            paymentMethod: selectedPaymentMethod,
            discountAmount: discountAmount,
            discountedAmount: totalAmountToPay
          });
        }
        
        lastPaymentData = {
          tableNumber: selectedTable,
          orderNumbers: orderNumbers,
          items: [],
          originalAmount: totalAmountToPay + discountAmount,
          discountAmount: discountAmount,
          totalAmount: totalAmountToPay,
          paymentMethod: selectedPaymentMethod,
          cashReceived: selectedPaymentMethod === 'cash' ? cashReceived : totalAmountToPay,
          change: selectedPaymentMethod === 'cash' ? changeAmount : 0,
          timestamp: new Date()
        };
        
        orderNumbers.forEach(orderNumber => {
          const order = allOrders.find(o => o.orderNumber === orderNumber);
          if (order) {
            lastPaymentData.items.push(...order.items);
          }
        });
        
        delete tableOrders[selectedTable];
        localStorage.setItem('tableOrders', JSON.stringify(tableOrders));
        
        if (window.afterPaymentCallback) {
          window.afterPaymentCallback();
          window.afterPaymentCallback = null;
        }
        
        alert('ä¼šè¨ˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');
        
        closePaymentModal();
        await calculateTodaySales();
        displayAllOrders();
        updateTableButtons();
        
        if (selectedTable && !selectedTable.includes('å€‹åˆ¥') && selectedTable !== 'å³ä¼šè¨ˆ') {
          displayTableOrders(selectedTable);
        } else {
          document.getElementById('tableOrdersSection').classList.add('hidden');
          selectedTable = null;
        }
        
      } catch (e) {
        console.error('ä¼šè¨ˆã‚¨ãƒ©ãƒ¼:', e);
        alert('ä¼šè¨ˆå‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };
    
    window.closePaymentModal = function() {
      document.getElementById('paymentModal').classList.add('hidden');
      document.getElementById('cashReceived').value = '';
      calculateChange();
    };
    
    // ============================================
    // å€¤å¼•ã
    // ============================================
    
    window.showDiscountModal = function() {
      document.getElementById('discountModal').classList.remove('hidden');
      document.getElementById('discountAmount').value = '';
      updateDiscountPreview();
    };
    
    window.updateDiscountPreview = function() {
      const discount = parseInt(document.getElementById('discountAmount').value) || 0;
      const original = totalAmountToPay + discountAmount;
      const discounted = Math.max(0, original - discount);
      
      document.getElementById('originalAmount').textContent = `Â¥${original.toLocaleString()}`;
      document.getElementById('discountValue').textContent = `-Â¥${discount.toLocaleString()}`;
      document.getElementById('discountedAmount').textContent = `Â¥${discounted.toLocaleString()}`;
    };
    
    window.applyDiscount = function() {
      const discount = parseInt(document.getElementById('discountAmount').value) || 0;
      if (discount <= 0) return alert('å€¤å¼•ãé‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
      
      const original = totalAmountToPay + discountAmount;
      if (discount >= original) return alert('å€¤å¼•ãé‡‘é¡ãŒåˆè¨ˆé‡‘é¡ä»¥ä¸Šã§ã™');
      
      discountAmount = discount;
      totalAmountToPay = original - discount;
      
      closeDiscountModal();
      showPaymentModal();
    };
    
    window.closeDiscountModal = function() {
      document.getElementById('discountModal').classList.add('hidden');
    };
    
    // ============================================
    // ãƒ¡ãƒ¢æ©Ÿèƒ½
    // ============================================
    
    window.showMemoModal = function(table) {
      document.getElementById('memoModal').classList.remove('hidden');
      document.getElementById('memoTableName').textContent = table;
      document.getElementById('memoTextarea').value = tableMemos[table] || '';
      window.currentMemoTable = table;
    };
    
    window.saveMemo = function() {
      const table = window.currentMemoTable;
      if (!table) return;
      
      const memo = document.getElementById('memoTextarea').value;
      tableMemos[table] = memo;
      localStorage.setItem('tableMemos', JSON.stringify(tableMemos));
      
      updateTableButtons();
      alert(`${table}ã®ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ`);
      closeMemoModal();
    };
    
    window.closeMemoModal = function() {
      document.getElementById('memoModal').classList.add('hidden');
      window.currentMemoTable = null;
    };
    
    // ============================================
    // ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³
    // ============================================
    
    window.openDrawer = async function() {
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        builder.createPeripheralElement({channel: 1, on: 500, off: 500});
        
        const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
        
        const trader = new StarWebPrintTrader({url: url});
        trader.onReceive = function(response) {
          console.log('ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³æˆåŠŸ');
        };
        trader.onError = function(response) {
          alert('ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ');
        };
        
        trader.sendMessage({request: request});
        
      } catch (e) {
        console.error('ãƒ‰ãƒ­ã‚¢ã‚¨ãƒ©ãƒ¼:', e);
        alert('ãƒ‰ãƒ­ã‚¢ã‚ªãƒ¼ãƒ—ãƒ³ã‚¨ãƒ©ãƒ¼');
      }
    };
    
    // ============================================
    // å±¥æ­´è¡¨ç¤º
    // ============================================
    
    window.showHistoryModal = async function() {
      document.getElementById('historyModal').classList.remove('hidden');
      const container = document.getElementById('historyList');
      container.innerHTML = '<div class="empty-state">èª­ã¿è¾¼ã¿ä¸­...</div>';
      
      try {
        const now = new Date();
        const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        
        const todayStart = new Date(jstNow);
        todayStart.setHours(1, 0, 0, 0);
        if (jstNow < todayStart) {
          todayStart.setDate(todayStart.getDate() - 1);
        }
        
        const ordersSnapshot = await getDocs(collection(db, 'orders'));
        const paidOrders = [];
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          const orderDate = data.timestamp.toDate();
          const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
          
          if (jstOrderDate >= todayStart && data.paidAt && !data.cancelledAt) {
            paidOrders.push({ id: doc.id, ...data });
          }
        });
        
        paidOrders.sort((a, b) => b.paidAt.seconds - a.paidAt.seconds);
        
        if (paidOrders.length === 0) {
          container.innerHTML = '<div class="empty-state">æœ¬æ—¥ã®ä¼šè¨ˆå±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
          return;
        }
        
        container.innerHTML = '';
        
        paidOrders.forEach(order => {
          const paidTime = order.paidAt.toDate();
          const timeStr = `${paidTime.getHours()}:${String(paidTime.getMinutes()).padStart(2, '0')}`;
          
          let itemsHtml = '';
          order.items.forEach(item => {
            itemsHtml += `<div>${item.name} Ã— ${item.quantity}</div>`;
          });
          
          const card = document.createElement('div');
          card.className = 'history-card';
          card.innerHTML = `
            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
              <div style="font-size: 20px; font-weight: bold; color: #4CAF50;">#${order.orderNumber}</div>
              <div style="color: #666;">${timeStr}</div>
            </div>
            <div style="font-size: 14px; color: #666; margin-bottom: 10px;">
              ${order.tableNumber} | ${order.paymentMethod === 'cash' ? 'ç¾é‡‘' : order.paymentMethod === 'emoney' ? 'é›»å­ãƒãƒãƒ¼' : 'ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ'}
            </div>
            <div style="font-size: 14px; margin-bottom: 10px;">${itemsHtml}</div>
            <div style="font-size: 18px; font-weight: bold; text-align: right;">Â¥${(order.discountedAmount || order.totalAmount).toLocaleString()}</div>
          `;
          container.appendChild(card);
        });
        
      } catch (e) {
        console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        container.innerHTML = '<div class="empty-state">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>';
      }
    };
    
    window.closeHistoryModal = function() {
      document.getElementById('historyModal').classList.add('hidden');
    };
    
    // ============================================
    // å£²ä¸Šè¨ˆç®—
    // ============================================
    
    async function calculateTodaySales() {
      try {
        const now = new Date();
        const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        
        const todayStart = new Date(jstNow);
        todayStart.setHours(1, 0, 0, 0);
        if (jstNow < todayStart) {
          todayStart.setDate(todayStart.getDate() - 1);
        }
        
        const ordersSnapshot = await getDocs(collection(db, 'orders'));
        
        todaySalesData = {
          customerCount: 0,
          totalSales: 0,
          tax8Total: 0,
          tax10Total: 0,
          cashTotal: 0,
          emoneyTotal: 0,
          creditTotal: 0
        };
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          const orderDate = data.timestamp.toDate();
          const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
          
          if (jstOrderDate >= todayStart && data.paidAt && !data.cancelledAt) {
            todaySalesData.customerCount++;
            
            const amount = data.discountedAmount || data.totalAmount;
            todaySalesData.totalSales += amount;
            
            data.items.forEach(item => {
              const itemTotal = (item.price + (item.toppingPrice || 0)) * item.quantity;
              if (item.taxRate === 8 || item.category === 'ãŸã“ç„¼ã') {
                todaySalesData.tax8Total += itemTotal;
              } else {
                todaySalesData.tax10Total += itemTotal;
              }
            });
            
            if (data.paymentMethod === 'cash') {
              todaySalesData.cashTotal += amount;
            } else if (data.paymentMethod === 'emoney') {
              todaySalesData.emoneyTotal += amount;
            } else if (data.paymentMethod === 'credit') {
              todaySalesData.creditTotal += amount;
            }
          }
        });
        
        document.getElementById('customerCount').textContent = todaySalesData.customerCount;
        document.getElementById('todaySales').textContent = `Â¥${todaySalesData.totalSales.toLocaleString()}`;
        
      } catch (e) {
        console.error('å£²ä¸Šè¨ˆç®—ã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    // ============================================
    // ç²¾ç®—
    // ============================================
    
    window.showSettlementModal = async function() {
      document.getElementById('settlementModal').classList.remove('hidden');
      
      const container = document.getElementById('settlementDetails');
      container.innerHTML = '<div class="empty-state">è¨ˆç®—ä¸­...</div>';
      
      await calculateTodaySales();
      
      const tax8Amount = Math.floor(todaySalesData.tax8Total * 8 / 108);
      const tax10Amount = Math.floor(todaySalesData.tax10Total * 10 / 110);
      const totalTax = tax8Amount + tax10Amount;
      const taxExcludedTotal = todaySalesData.totalSales - totalTax;
      
      const now = new Date();
      const dateStr = `${now.getFullYear()}å¹´${String(now.getMonth()+1).padStart(2,'0')}æœˆ${String(now.getDate()).padStart(2,'0')}æ—¥ ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
      
      container.innerHTML = `
        <div class="settlement-row">
          <span>åº—å</span>
          <span>ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—</span>
        </div>
        <div class="settlement-row">
          <span>æ—¥æ™‚</span>
          <span>${dateStr}</span>
        </div>
        <div class="settlement-row">
          <span>å®¢æ•°</span>
          <span>${todaySalesData.customerCount}å</span>
        </div>
        <div class="settlement-row">
          <span>ç¨æŠœåˆè¨ˆ</span>
          <span>Â¥${taxExcludedTotal.toLocaleString()}</span>
        </div>
        <div class="settlement-row">
          <span>8%å•†å“åˆè¨ˆ</span>
          <span>Â¥${todaySalesData.tax8Total.toLocaleString()}</span>
        </div>
        <div class="settlement-row">
          <span>10%å•†å“åˆè¨ˆ</span>
          <span>Â¥${todaySalesData.tax10Total.toLocaleString()}</span>
        </div>
        <div class="settlement-row">
          <span>æ¶ˆè²»ç¨åˆè¨ˆ</span>
          <span>Â¥${totalTax.toLocaleString()}</span>
        </div>
        <div class="settlement-row highlight">
          <span>ç¨è¾¼åˆè¨ˆ</span>
          <span>Â¥${todaySalesData.totalSales.toLocaleString()}</span>
        </div>
        <div class="settlement-row">
          <span>ç¾é‡‘</span>
          <span>Â¥${todaySalesData.cashTotal.toLocaleString()}</span>
        </div>
        <div class="settlement-row">
          <span>é›»å­ãƒãƒãƒ¼</span>
          <span>Â¥${todaySalesData.emoneyTotal.toLocaleString()}</span>
        </div>
        <div class="settlement-row">
          <span>ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</span>
          <span>Â¥${todaySalesData.creditTotal.toLocaleString()}</span>
        </div>
      `;
    };
    
    window.printSettlement = async function() {
      try {
        const builder = new StarWebPrintBuilder();
        const request = builder.createInitializationElement();
        
        builder.createPeripheralElement({channel: 1, on: 100, off: 100});
        
        builder.createAlignmentElement({position: 'center'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: 'ç²¾ç®—ãƒ¬ã‚·ãƒ¼ãƒˆ\n\n'});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        
        builder.createAlignmentElement({position: 'left'});
        builder.createTextElement({data: 'ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—\n'});
        
        const now = new Date();
        const dateStr = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        builder.createTextElement({data: `${dateStr}\n`});
        
        builder.createRuledLineElement({thickness: 'thin'});
        
        const tax8Amount = Math.floor(todaySalesData.tax8Total * 8 / 108);
        const tax10Amount = Math.floor(todaySalesData.tax10Total * 10 / 110);
        const totalTax = tax8Amount + tax10Amount;
        const taxExcludedTotal = todaySalesData.totalSales - totalTax;
        
        builder.createTextElement({data: `å®¢æ•°${' '.repeat(20)}${todaySalesData.customerCount}å\n`});
        builder.createRuledLineElement({thickness: 'thin'});
        builder.createTextElement({data: `ç¨æŠœåˆè¨ˆ${' '.repeat(12)}${taxExcludedTotal.toLocaleString()}å††\n`});
        builder.createTextElement({data: `8%å•†å“åˆè¨ˆ${' '.repeat(10)}${todaySalesData.tax8Total.toLocaleString()}å††\n`});
        builder.createTextElement({data: `10%å•†å“åˆè¨ˆ${' '.repeat(9)}${todaySalesData.tax10Total.toLocaleString()}å††\n`});
        builder.createTextElement({data: `æ¶ˆè²»ç¨åˆè¨ˆ${' '.repeat(12)}${totalTax.toLocaleString()}å††\n`});
        builder.createRuledLineElement({thickness: 'medium'});
        builder.createTextElement({emphasis: true, width: 2, height: 2});
        builder.createTextElement({data: `ç¨è¾¼åˆè¨ˆ ${todaySalesData.totalSales.toLocaleString()}å††\n`});
        builder.createTextElement({emphasis: false, width: 1, height: 1});
        builder.createRuledLineElement({thickness: 'medium'});
        
        builder.createTextElement({data: `ç¾é‡‘${' '.repeat(18)}${todaySalesData.cashTotal.toLocaleString()}å††\n`});
        builder.createTextElement({data: `é›»å­ãƒãƒãƒ¼${' '.repeat(12)}${todaySalesData.emoneyTotal.toLocaleString()}å††\n`});
        builder.createTextElement({data: `ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰${' '.repeat(8)}${todaySalesData.creditTotal.toLocaleString()}å††\n`});
        
        builder.createTextElement({data: '\n\n\n'});
        builder.createCutPaperElement({feed: true});
        
        const url = `http://${PRINTER_IP}/StarWebPRNT/SendMessage`;
        
        const trader = new StarWebPrintTrader({url: url});
        trader.onReceive = function(response) {
          alert('ç²¾ç®—ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å°åˆ·ã—ã¾ã—ãŸ');
        };
        trader.onError = function(response) {
          alert('å°åˆ·ã«å¤±æ•—ã—ã¾ã—ãŸ');
        };
        
        trader.sendMessage({request: request});
        
      } catch (e) {
        console.error('å°åˆ·ã‚¨ãƒ©ãƒ¼:', e);
        alert('å°åˆ·ã‚¨ãƒ©ãƒ¼');
      }
    };
    
    window.closeSettlementModal = function() {
      document.getElementById('settlementModal').classList.add('hidden');
    };
  </script>
</body>
</html>
