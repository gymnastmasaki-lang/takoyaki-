<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>セットメニュー追加</title>
</head>
<body>
  <h1>セットメニュー追加スクリプト</h1>
  <button onclick="addSetMenus()" style="padding: 20px; font-size: 18px; background: #4CAF50; color: white; border: none; border-radius: 8px; cursor: pointer;">セットメニューを追加</button>
  <div id="result" style="margin-top: 20px; padding: 20px; background: #f5f5f5; border-radius: 8px;"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDihde65cnLva8l9tvi4u0oUM0gQ49bWNk",
      authDomain: "takoyaki-pos.firebaseapp.com",
      projectId: "takoyaki-pos",
      storageBucket: "takoyaki-pos.firebasestorage.app",
      messagingSenderId: "868693716352",
      appId: "1:868693716352:web:51d8c09ac51a7c8bc2a17c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    window.db = db;
    window.collection = collection;
    window.addDoc = addDoc;
    window.getDocs = getDocs;
    window.query = query;
    window.where = where;
    window.deleteDoc = deleteDoc;
  </script>

  <script>
    async function addSetMenus() {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '処理中...';
      
      try {
        // 1. たこ焼き味トッピング（既存のT001を使用する想定）
        // 既存のトッピングIDを確認
        resultDiv.innerHTML += '<br>既存トッピング確認中...';
        const toppingsSnapshot = await window.getDocs(window.collection(window.db, 'toppings'));
        const existingToppings = [];
        toppingsSnapshot.forEach(doc => {
          existingToppings.push(doc.data());
        });
        resultDiv.innerHTML += '<br>既存トッピング数: ' + existingToppings.length;
        
        // たこ焼き味トッピングのIDを探す
        let tasteTopping = '';
        for (const t of existingToppings) {
          if (t.name && (t.name.includes('ソース') || t.name.includes('しょうゆ') || t.name.includes('塩'))) {
            tasteTopping = t.id;
            break;
          }
        }
        
        if (!tasteTopping) {
          // たこ焼き味トッピングが存在しない場合は作成
          resultDiv.innerHTML += '<br>たこ焼き味トッピング作成中...';
          const tasteToppings = [
            { id: 'TASTE01', name: 'ソース', price: 0, order: 1 },
            { id: 'TASTE02', name: 'しょうゆ', price: 0, order: 2 },
            { id: 'TASTE03', name: '塩', price: 0, order: 3 },
            { id: 'TASTE04', name: 'ポン酢', price: 30, order: 4 },
            { id: 'TASTE05', name: 'みそだれ', price: 30, order: 5 }
          ];
          
          for (const topping of tasteToppings) {
            await window.addDoc(window.collection(window.db, 'toppings'), topping);
          }
          tasteTopping = 'TASTE01';
          resultDiv.innerHTML += '<br>✅ たこ焼き味トッピング作成完了';
        }
        
        // 2. おつまみセット用の全トッピングを作成
        resultDiv.innerHTML += '<br>おつまみセット用トッピング追加中...';
        
        const otumamisetToppings = [
          // ドリンク
          { id: 'OTUMAMI_DRINK01', name: '【ドリンク】生ビール', price: 0, order: 101 },
          { id: 'OTUMAMI_DRINK02', name: '【ドリンク】チューハイプレーン', price: 0, order: 102 },
          { id: 'OTUMAMI_DRINK03', name: '【ドリンク】チューハイゆず', price: 0, order: 103 },
          { id: 'OTUMAMI_DRINK04', name: '【ドリンク】チューハイグレープフルーツ', price: 0, order: 104 },
          { id: 'OTUMAMI_DRINK05', name: '【ドリンク】チューハイ青りんご', price: 0, order: 105 },
          { id: 'OTUMAMI_DRINK06', name: '【ドリンク】チューハイ梅', price: 0, order: 106 },
          { id: 'OTUMAMI_DRINK07', name: '【ドリンク】チューハイカルピス', price: 0, order: 107 },
          { id: 'OTUMAMI_DRINK08', name: '【ドリンク】角ハイ', price: 0, order: 108 },
          { id: 'OTUMAMI_DRINK09', name: '【ドリンク】ジムビーム', price: 0, order: 109 },
          { id: 'OTUMAMI_DRINK10', name: '【ドリンク】ウーロンハイ', price: 0, order: 110 },
          // たこ焼き味
          { id: 'OTUMAMI_TASTE01', name: '【たこ焼き味】ソース', price: 0, order: 201 },
          { id: 'OTUMAMI_TASTE02', name: '【たこ焼き味】しょうゆ', price: 0, order: 202 },
          { id: 'OTUMAMI_TASTE03', name: '【たこ焼き味】塩', price: 0, order: 203 },
          { id: 'OTUMAMI_TASTE04', name: '【たこ焼き味】ポン酢', price: 30, order: 204 },
          { id: 'OTUMAMI_TASTE05', name: '【たこ焼き味】みそだれ', price: 30, order: 205 },
          // 一品
          { id: 'OTUMAMI_SIDE01', name: '【一品】枝豆', price: 0, order: 301 },
          { id: 'OTUMAMI_SIDE02', name: '【一品】揚げにんにく', price: 0, order: 302 },
          { id: 'OTUMAMI_SIDE03', name: '【一品】ごま油キムチ', price: 0, order: 303 },
          { id: 'OTUMAMI_SIDE04', name: '【一品】冷奴', price: 0, order: 304 },
          { id: 'OTUMAMI_SIDE05', name: '【一品】ポテトフライ', price: 0, order: 305 },
          { id: 'OTUMAMI_SIDE06', name: '【一品】唐揚げ2個', price: 0, order: 306 },
          // オプション
          { id: 'OTUMAMI_OPT01', name: '【オプション】生ビールお得ジョッキに変更', price: 150, order: 401 },
          { id: 'OTUMAMI_OPT02', name: '【オプション】その他メガに変更', price: 300, order: 402 }
        ];
        
        for (const topping of otumamisetToppings) {
          await window.addDoc(window.collection(window.db, 'toppings'), topping);
        }
        
        resultDiv.innerHTML += '<br>✅ トッピング追加完了';
        
        // 3. おつまみセット用のトッピングIDリストを作成
        const otumamisetToppingIds = otumamisetToppings.map(t => t.id).join(',');
        
        // 4. セットメニューを作成
        const setMenus = [
          {
            id: 'SET001',
            category: 'セット',
            name: 'Aセット',
            price: 1000,
            toppingsId: tasteTopping, // たこ焼き味トッピング
            image: '',
            note: '店内のみ'
          },
          {
            id: 'SET002',
            category: 'セット',
            name: 'Bセット',
            price: 1250,
            toppingsId: tasteTopping, // たこ焼き味トッピング
            image: '',
            note: '店内のみ'
          },
          {
            id: 'SET003',
            category: 'セット',
            name: 'おつまみセット',
            price: 1000,
            toppingsId: otumamisetToppingIds, // 全トッピング
            image: '',
            note: '店内のみ'
          }
        ];
        
        resultDiv.innerHTML += '<br>メニュー追加中...';
        
        for (const menu of setMenus) {
          await window.addDoc(window.collection(window.db, 'menu'), menu);
        }
        
        resultDiv.innerHTML += '<br>✅ メニュー追加完了';
        resultDiv.innerHTML += '<br><br><strong>全ての処理が完了しました！</strong>';
        resultDiv.innerHTML += '<br><br>追加されたメニュー:';
        resultDiv.innerHTML += '<br>- Aセット (1000円) - たこ焼き味を選択';
        resultDiv.innerHTML += '<br>- Bセット (1250円) - たこ焼き味を選択';
        resultDiv.innerHTML += '<br>- おつまみセット (1000円) - ドリンク・たこ焼き味・一品・オプションを選択';
        resultDiv.innerHTML += '<br><br>注意: ';
        resultDiv.innerHTML += '<br>- menu.htmlからの注文では非表示';
        resultDiv.innerHTML += '<br>- ?table=からの注文では表示（店内のみ設定）';
        resultDiv.innerHTML += '<br>- おつまみセットは全てのトッピングが表示されます';
        resultDiv.innerHTML += '<br>- 【ドリンク】【たこ焼き味】【一品】【オプション】のラベルで区別できます';
        
      } catch (error) {
        resultDiv.innerHTML += '<br>❌ エラー: ' + error.message;
        console.error('エラー:', error);
      }
    }
    
    window.addSetMenus = addSetMenus;
  </script>
</body>
</html>
