<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸ç®¡ç†</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-area { display: block !important; }
        }
        
        .receipt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .receipt-card {
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .receipt-card:hover {
            transform: scale(1.05);
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .modal-content {
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
        }
        
        /* ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }
        
        .toast.success {
            border-left: 4px solid #10b981;
        }
        
        .toast.error {
            border-left: 4px solid #ef4444;
        }
        
        .toast.info {
            border-left: 4px solid #3b82f6;
        }
        
        .toast-icon {
            font-size: 24px;
        }
        
        .toast-content {
            flex: 1;
        }
        
        .toast-title {
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .toast-message {
            font-size: 14px;
            color: #666;
        }
        
        .toast-close {
            cursor: pointer;
            color: #999;
            font-size: 20px;
            line-height: 1;
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="toastContainer" class="toast-container"></div>
    
    <div id="app"></div>
    
    <!-- ç”»åƒæ‹¡å¤§ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="imageModal" class="modal-overlay hidden" onclick="closeImageModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <img id="modalImage" src="" alt="ãƒ¬ã‚·ãƒ¼ãƒˆç”»åƒ" class="max-w-full max-h-full">
        </div>
    </div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, addDoc, deleteDoc, doc, query, where, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
            authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
            projectId: "takoyaki-order-system-bacd7",
            storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
            messagingSenderId: "104494752890",
            appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);
        
        window.db = db;
        window.storage = storage;
        window.firebaseModules = { collection, getDocs, addDoc, deleteDoc, doc, query, where, orderBy, Timestamp, ref, uploadBytes, getDownloadURL, deleteObject };
        window.FirebaseReady = true;
    </script>

    <script>
        const appDiv = document.getElementById('app');
        
        // ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥ã‚’è¡¨ç¤º
        function showToast(type, title, message, duration = 3000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                info: 'â„¹ï¸'
            };
            
            toast.innerHTML = `
                <div class="toast-icon">${icons[type]}</div>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
                <div class="toast-close" onclick="this.parentElement.remove()">Ã—</div>
            `;
            
            container.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }
        
        // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼ˆã‚ªã‚·ãƒ£ãƒ¬ç‰ˆï¼‰
        function showConfirm(title, message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl" onclick="event.stopPropagation()">
                    <h3 class="text-xl font-bold mb-3">${title}</h3>
                    <p class="text-gray-600 mb-6">${message}</p>
                    <div class="flex gap-3">
                        <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button onclick="confirmAction()" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                            å‰Šé™¤
                        </button>
                    </div>
                </div>
            `;
            
            modal.onclick = function() { modal.remove(); };
            
            window.confirmAction = function() {
                modal.remove();
                onConfirm();
            };
            
            document.body.appendChild(modal);
        }
        
        let storeName = '';
        let storeId = '';
        let receipts = [];
        let filteredReceipts = [];
        let filterYear = new Date().getFullYear();
        let filterMonth = 0; // 0 = ã™ã¹ã¦
        let filterCategory = '';

        async function init() {
            if (!window.FirebaseReady) {
                setTimeout(init, 100);
                return;
            }

            const storedStoreId = localStorage.getItem('receiptStoreId');
            const storedStoreName = localStorage.getItem('receiptStoreName');
            
            if (storedStoreId && storedStoreName) {
                storeId = storedStoreId;
                storeName = storedStoreName;
                await loadReceipts();
                render();
            } else {
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            appDiv.innerHTML = `
                <div class="min-h-screen flex items-center justify-center">
                    <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
                        <h1 class="text-2xl font-bold mb-6 text-center">ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸ç®¡ç†</h1>
                        <p class="text-sm text-gray-600 mb-4">7å¹´é–“ãƒ‡ã‚¸ã‚¿ãƒ«ä¿å­˜ãƒ»ã„ã¤ã§ã‚‚å°åˆ·</p>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">åº—èˆ—å</label>
                            <input type="text" id="storeNameInput" class="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" id="passwordInput" class="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <button onclick="handleLogin()" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                            ãƒ­ã‚°ã‚¤ãƒ³
                        </button>
                    </div>
                </div>
            `;
        }

        window.handleLogin = async function() {
            const storeNameValue = document.getElementById('storeNameInput').value.trim();
            const passwordValue = document.getElementById('passwordInput').value;
            
            if (!storeNameValue || !passwordValue) {
                showToast('error', 'ã‚¨ãƒ©ãƒ¼', 'åº—èˆ—åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                const { collection, query, where, getDocs } = window.firebaseModules;
                
                const storesRef = collection(window.db, 'stores');
                const q = query(storesRef, where('storeName', '==', storeNameValue));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    showToast('error', 'ã‚¨ãƒ©ãƒ¼', 'åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                let authenticated = false;
                let storeData = null;
                let storeDocId = null;

                querySnapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    if (data.storePassword === passwordValue) {
                        if (data.isActive === false) {
                            showToast('error', 'ã‚¨ãƒ©ãƒ¼', 'ã“ã®åº—èˆ—ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™');
                            return;
                        }
                        authenticated = true;
                        storeData = data;
                        storeDocId = docSnap.id;
                    }
                });

                if (authenticated && storeData) {
                    storeId = storeDocId;
                    storeName = storeData.storeName;
                    
                    localStorage.setItem('receiptStoreId', storeDocId);
                    localStorage.setItem('receiptStoreName', storeData.storeName);
                    
                    await loadReceipts();
                    render();
                } else {
                    showToast('error', 'ã‚¨ãƒ©ãƒ¼', 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                }
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                showToast('error', 'ã‚¨ãƒ©ãƒ¼', 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        };

        window.handleLogout = function() {
            localStorage.removeItem('receiptStoreId');
            localStorage.removeItem('receiptStoreName');
            storeId = '';
            storeName = '';
            location.reload();
        };

        async function loadReceipts() {
            const { collection, getDocs, query, orderBy } = window.firebaseModules;
            
            const receiptsRef = collection(window.db, 'stores', storeId, 'receipts');
            const q = query(receiptsRef, orderBy('date', 'desc'));
            const snapshot = await getDocs(q);
            
            receipts = [];
            snapshot.forEach(docSnap => {
                receipts.push({
                    id: docSnap.id,
                    ...docSnap.data()
                });
            });
            
            applyFilters();
        }

        function applyFilters() {
            filteredReceipts = receipts.filter(r => {
                const date = new Date(r.date);
                const year = date.getFullYear();
                const month = date.getMonth() + 1;
                
                if (year !== filterYear) return false;
                if (filterMonth !== 0 && month !== filterMonth) return false;
                if (filterCategory && r.category !== filterCategory) return false;
                
                return true;
            });
        }

        function render() {
            const categories = [...new Set(receipts.map(r => r.category))].filter(Boolean);
            
            // æœˆåˆ¥é›†è¨ˆ
            const monthlyTotals = {};
            for (let i = 1; i <= 12; i++) {
                monthlyTotals[i] = filteredReceipts
                    .filter(r => new Date(r.date).getMonth() + 1 === i)
                    .reduce((sum, r) => sum + (r.amount || 0), 0);
            }
            
            appDiv.innerHTML = `
                <div class="container mx-auto px-4 py-8 no-print">
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold">ğŸ“¸ ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸ç®¡ç†</h1>
                            <button onclick="handleLogout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                            </button>
                        </div>

                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <p class="text-gray-700">
                                ğŸ’¡ æ„Ÿç†±ç´™ã®åŠ£åŒ–å¯¾ç­–ï¼šãƒ¬ã‚·ãƒ¼ãƒˆã‚’ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜<br>
                                ğŸ“± ã‚¹ãƒãƒ›ã‚«ãƒ¡ãƒ©ã§æ’®å½± â†’ è‡ªå‹•ä¿å­˜ â†’ 7å¹´é–“ä¿ç®¡ â†’ ã„ã¤ã§ã‚‚å°åˆ·
                            </p>
                        </div>

                        <!-- æ’®å½±ãƒœã‚¿ãƒ³ -->
                        <div class="mb-6">
                            <button onclick="openCameraModal()" class="w-full px-6 py-4 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 font-bold text-lg shadow-lg">
                                ğŸ“· ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸ã‚’æ’®å½±
                            </button>
                        </div>

                        <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                            <h3 class="font-bold mb-3">çµã‚Šè¾¼ã¿</h3>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="text-sm">å¹´åº¦</label>
                                    <select id="filterYear" onchange="handleFilterChange()" class="w-full px-3 py-2 border rounded">
                                        ${[0,1,2,3,4,5,6].map(i => {
                                            const y = new Date().getFullYear() - i;
                                            return `<option value="${y}" ${y === filterYear ? 'selected' : ''}>${y}å¹´</option>`;
                                        }).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm">æœˆ</label>
                                    <select id="filterMonth" onchange="handleFilterChange()" class="w-full px-3 py-2 border rounded">
                                        <option value="0">ã™ã¹ã¦</option>
                                        ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => 
                                            `<option value="${m}" ${m === filterMonth ? 'selected' : ''}>${m}æœˆ</option>`
                                        ).join('')}
                                    </select>
                                </div>
                                <div>
                                    <label class="text-sm">ã‚«ãƒ†ã‚´ãƒª</label>
                                    <select id="filterCategory" onchange="handleFilterChange()" class="w-full px-3 py-2 border rounded">
                                        <option value="">ã™ã¹ã¦</option>
                                        ${categories.map(c => 
                                            `<option value="${c}" ${c === filterCategory ? 'selected' : ''}>${c}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- çµ±è¨ˆ -->
                        <div class="mb-6 p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg">
                            <h3 class="font-bold mb-3">ğŸ“Š ${filterYear}å¹´ ${filterMonth ? filterMonth + 'æœˆ' : 'å¹´é–“'}çµ±è¨ˆ</h3>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-3 bg-white rounded shadow">
                                    <div class="text-sm text-gray-600">ä¿å­˜ä»¶æ•°</div>
                                    <div class="text-2xl font-bold text-blue-600">${filteredReceipts.length}æš</div>
                                </div>
                                <div class="p-3 bg-white rounded shadow">
                                    <div class="text-sm text-gray-600">åˆè¨ˆé‡‘é¡</div>
                                    <div class="text-2xl font-bold text-green-600">Â¥${filteredReceipts.reduce((sum, r) => sum + (r.amount || 0), 0).toLocaleString()}</div>
                                </div>
                            </div>
                            
                            ${filterMonth === 0 ? `
                                <div class="mt-4">
                                    <h4 class="text-sm font-bold mb-2">æœˆåˆ¥é‡‘é¡</h4>
                                    <div class="grid grid-cols-6 gap-2 text-xs">
                                        ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m => `
                                            <div class="p-2 bg-white rounded text-center">
                                                <div class="text-gray-600">${m}æœˆ</div>
                                                <div class="font-bold">Â¥${monthlyTotals[m].toLocaleString()}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <!-- ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§ -->
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-3">
                                <h3 class="font-bold">ãƒ¬ã‚·ãƒ¼ãƒˆä¸€è¦§</h3>
                                <button onclick="printAllReceipts()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">
                                    ğŸ–¨ï¸ ä¸€æ‹¬å°åˆ·
                                </button>
                            </div>
                            
                            ${filteredReceipts.length === 0 ? `
                                <div class="text-center py-12 text-gray-500">
                                    <p class="text-lg mb-2">ãƒ¬ã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“</p>
                                    <p class="text-sm">ã€Œãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸ã‚’æ’®å½±ã€ãƒœã‚¿ãƒ³ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„</p>
                                </div>
                            ` : `
                                <div class="receipt-grid">
                                    ${filteredReceipts.map(receipt => `
                                        <div class="receipt-card bg-white rounded-lg shadow-lg overflow-hidden">
                                            <img src="${receipt.imageUrl}" alt="${receipt.description}" 
                                                 class="w-full h-48 object-cover" 
                                                 onclick="showImageModal('${receipt.imageUrl}')" />
                                            <div class="p-3">
                                                <div class="text-sm font-bold text-gray-800">${receipt.date}</div>
                                                <div class="text-xs text-gray-600">${receipt.category || 'æœªåˆ†é¡'}</div>
                                                <div class="text-lg font-bold text-green-600">Â¥${(receipt.amount || 0).toLocaleString()}</div>
                                                <div class="text-xs text-gray-500 mt-1">${receipt.description || ''}</div>
                                                <div class="flex gap-2 mt-3">
                                                    <button onclick="printReceipt('${receipt.id}')" class="flex-1 px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600">
                                                        å°åˆ·
                                                    </button>
                                                    <button onclick="deleteReceipt('${receipt.id}')" class="flex-1 px-2 py-1 bg-red-500 text-white text-xs rounded hover:bg-red-600">
                                                        å‰Šé™¤
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                </div>
            `;
        }

        window.handleFilterChange = function() {
            filterYear = parseInt(document.getElementById('filterYear').value);
            filterMonth = parseInt(document.getElementById('filterMonth').value);
            filterCategory = document.getElementById('filterCategory').value;
            applyFilters();
            render();
        };

        window.openCameraModal = function() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4" onclick="event.stopPropagation()">
                    <h3 class="text-xl font-bold mb-4">ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸ã‚’æ’®å½±</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">æ—¥ä»˜</label>
                        <input type="date" id="receiptDate" value="${new Date().toISOString().split('T')[0]}" class="w-full px-3 py-2 border rounded" />
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">ã‚«ãƒ†ã‚´ãƒª</label>
                        <select id="receiptCategory" class="w-full px-3 py-2 border rounded">
                            <option value="ææ–™è²»">ææ–™è²»</option>
                            <option value="æ°´å…‰ç†±è²»">æ°´å…‰ç†±è²»</option>
                            <option value="äº¤é€šè²»">äº¤é€šè²»</option>
                            <option value="æ¥å¾…äº¤éš›è²»">æ¥å¾…äº¤éš›è²»</option>
                            <option value="æ¶ˆè€—å“">æ¶ˆè€—å“</option>
                            <option value="é›‘è²»">é›‘è²»</option>
                            <option value="ãã®ä»–">ãã®ä»–</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">é‡‘é¡</label>
                        <input type="number" id="receiptAmount" placeholder="1000" class="w-full px-3 py-2 border rounded" />
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">ãƒ¡ãƒ¢</label>
                        <input type="text" id="receiptDescription" placeholder="ä¾‹: â—‹â—‹ã‚¹ãƒ¼ãƒ‘ãƒ¼ã€é£Ÿæè³¼å…¥" class="w-full px-3 py-2 border rounded" />
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">ç”»åƒã‚’é¸æŠ</label>
                        <input type="file" id="receiptImage" accept="image/*" capture="environment" class="w-full px-3 py-2 border rounded" />
                        <p class="text-xs text-gray-500 mt-1">ğŸ“± ã‚¹ãƒãƒ›ã®å ´åˆã€ã‚«ãƒ¡ãƒ©ãŒè‡ªå‹•èµ·å‹•ã—ã¾ã™</p>
                    </div>
                    
                    <div class="flex gap-3">
                        <button onclick="this.closest('.modal-overlay').remove()" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">
                            ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                        </button>
                        <button onclick="uploadReceipt()" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                            ä¿å­˜
                        </button>
                    </div>
                </div>
            `;
            
            modal.onclick = function(e) {
                if (e.target === modal) modal.remove();
            };
            
            document.body.appendChild(modal);
        };

        window.uploadReceipt = async function() {
            const date = document.getElementById('receiptDate').value;
            const category = document.getElementById('receiptCategory').value;
            const amount = parseInt(document.getElementById('receiptAmount').value) || 0;
            const description = document.getElementById('receiptDescription').value;
            const fileInput = document.getElementById('receiptImage');
            
            if (!date) {
                showToast('error', 'ã‚¨ãƒ©ãƒ¼', 'æ—¥ä»˜ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            if (!fileInput.files[0]) {
                showToast('error', 'ã‚¨ãƒ©ãƒ¼', 'ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                const file = fileInput.files[0];
                const timestamp = Date.now();
                const fileName = `receipts/${storeId}/${date}_${timestamp}.jpg`;
                
                // Firebase Storageã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                const { ref, uploadBytes, getDownloadURL } = window.firebaseModules;
                const storageRef = ref(window.storage, fileName);
                
                await uploadBytes(storageRef, file);
                const downloadURL = await getDownloadURL(storageRef);
                
                // Firestoreã«ä¿å­˜
                const { collection, addDoc, Timestamp } = window.firebaseModules;
                const receiptsRef = collection(window.db, 'stores', storeId, 'receipts');
                
                await addDoc(receiptsRef, {
                    date: date,
                    category: category,
                    amount: amount,
                    description: description,
                    imageUrl: downloadURL,
                    storagePath: fileName,
                    createdAt: Timestamp.now()
                });
                
                showToast('success', 'ä¿å­˜å®Œäº†', 'ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
                document.querySelector('.modal-overlay').remove();
                
                await loadReceipts();
                render();
                
            } catch (error) {
                console.error('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼:', error);
                
                // Firebase Storageã®ãƒ‘ãƒ¼ãƒŸãƒƒã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®å ´åˆ
                if (error.code === 'storage/unauthorized') {
                    const modal = document.createElement('div');
                    modal.className = 'modal-overlay';
                    modal.innerHTML = `
                        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 shadow-2xl" onclick="event.stopPropagation()">
                            <h3 class="text-xl font-bold mb-3 text-red-600">âš ï¸ Firebase Storage è¨­å®šãŒå¿…è¦ã§ã™</h3>
                            <p class="text-gray-600 mb-4">ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ä¿å­˜ã™ã‚‹ã«ã¯ã€Firebase Storageã®è¨­å®šãŒå¿…è¦ã§ã™ã€‚</p>
                            
                            <div class="bg-blue-50 p-4 rounded-lg mb-4">
                                <p class="text-sm font-bold mb-2">è¨­å®šæ–¹æ³•:</p>
                                <ol class="text-sm space-y-2">
                                    <li>1. ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                                    <li>2. ã‚³ãƒ¼ãƒ‰ã‚’ã‚³ãƒ”ãƒš</li>
                                    <li>3. ã€Œå…¬é–‹ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                                </ol>
                            </div>
                            
                            <a href="https://console.firebase.google.com/project/takoyaki-order-system-bacd7/storage/takoyaki-order-system-bacd7.firebasestorage.app/rules" 
                               target="_blank"
                               class="block w-full px-4 py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 text-center font-bold mb-3">
                                ğŸ”¥ Firebase Console ã§è¨­å®šã™ã‚‹
                            </a>
                            
                            <div class="bg-gray-100 p-3 rounded text-xs mb-3 overflow-x-auto">
                                <pre>rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /{allPaths=**} {
      allow read, write: if true;
    }
  }
}</pre>
                            </div>
                            
                            <button onclick="this.closest('.modal-overlay').remove()" class="w-full px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                é–‰ã˜ã‚‹
                            </button>
                        </div>
                    `;
                    modal.onclick = function() { modal.remove(); };
                    document.body.appendChild(modal);
                } else {
                    showToast('error', 'ä¿å­˜å¤±æ•—', 'ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 5000);
                }
            }
        };

        window.showImageModal = function(imageUrl) {
            const modal = document.getElementById('imageModal');
            const img = document.getElementById('modalImage');
            img.src = imageUrl;
            modal.classList.remove('hidden');
        };

        window.closeImageModal = function() {
            document.getElementById('imageModal').classList.add('hidden');
        };

        window.deleteReceipt = async function(receiptId) {
            showConfirm('ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤', 'ã“ã®ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ', async function() {
                try {
                    const receipt = receipts.find(r => r.id === receiptId);
                    
                    // Storageã‹ã‚‰å‰Šé™¤
                    const { ref, deleteObject } = window.firebaseModules;
                    const storageRef = ref(window.storage, receipt.storagePath);
                    await deleteObject(storageRef);
                    
                    // Firestoreã‹ã‚‰å‰Šé™¤
                    const { doc, deleteDoc } = window.firebaseModules;
                    const receiptDoc = doc(window.db, 'stores', storeId, 'receipts', receiptId);
                    await deleteDoc(receiptDoc);
                    
                    showToast('success', 'å‰Šé™¤å®Œäº†', 'ãƒ¬ã‚·ãƒ¼ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
                    await loadReceipts();
                    render();
                    
                } catch (error) {
                    console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
                    showToast('error', 'å‰Šé™¤å¤±æ•—', 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                }
            });
        };

        window.printReceipt = function(receiptId) {
            const receipt = receipts.find(r => r.id === receiptId);
            const printWindow = window.open('', '_blank');
            printWindow.document.write(
                '<html>' +
                '<head>' +
                    '<title>ãƒ¬ã‚·ãƒ¼ãƒˆå°åˆ·</title>' +
                    '<style>' +
                        'body { margin: 20px; font-family: sans-serif; }' +
                        'img { max-width: 100%; }' +
                        '.info { margin-bottom: 10px; }' +
                    '</style>' +
                '</head>' +
                '<body>' +
                    '<div class="info">' +
                        '<strong>æ—¥ä»˜:</strong> ' + receipt.date + '<br>' +
                        '<strong>ã‚«ãƒ†ã‚´ãƒª:</strong> ' + receipt.category + '<br>' +
                        '<strong>é‡‘é¡:</strong> Â¥' + receipt.amount.toLocaleString() + '<br>' +
                        '<strong>ãƒ¡ãƒ¢:</strong> ' + receipt.description +
                    '</div>' +
                    '<img src="' + receipt.imageUrl + '" />' +
                    '<script>window.onload = function() { window.print(); }</' + 'script>' +
                '</body>' +
                '</html>'
            );
        };

        window.printAllReceipts = function() {
            if (filteredReceipts.length === 0) {
                showToast('info', 'å°åˆ·ãªã—', 'å°åˆ·ã™ã‚‹ãƒ¬ã‚·ãƒ¼ãƒˆãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            
            const receiptsHtml = filteredReceipts.map(function(receipt) {
                return '<div style="page-break-after: always; margin-bottom: 20px;">' +
                    '<div style="margin-bottom: 10px;">' +
                        '<strong>æ—¥ä»˜:</strong> ' + receipt.date + '<br>' +
                        '<strong>ã‚«ãƒ†ã‚´ãƒª:</strong> ' + receipt.category + '<br>' +
                        '<strong>é‡‘é¡:</strong> Â¥' + receipt.amount.toLocaleString() + '<br>' +
                        '<strong>ãƒ¡ãƒ¢:</strong> ' + receipt.description +
                    '</div>' +
                    '<img src="' + receipt.imageUrl + '" style="max-width: 100%;" />' +
                '</div>';
            }).join('');
            
            const totalAmount = filteredReceipts.reduce(function(sum, r) { return sum + (r.amount || 0); }, 0);
            const monthText = filterMonth ? filterMonth + 'æœˆ' : '';
            
            printWindow.document.write(
                '<html>' +
                '<head>' +
                    '<title>ãƒ¬ã‚·ãƒ¼ãƒˆä¸€æ‹¬å°åˆ· ' + filterYear + 'å¹´' + monthText + '</title>' +
                    '<style>' +
                        'body { margin: 20px; font-family: sans-serif; }' +
                        '@media print { @page { margin: 10mm; } }' +
                    '</style>' +
                '</head>' +
                '<body>' +
                    '<h1>' + filterYear + 'å¹´' + monthText + ' ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸</h1>' +
                    '<p>åˆè¨ˆ: ' + filteredReceipts.length + 'æš / Â¥' + totalAmount.toLocaleString() + '</p>' +
                    receiptsHtml +
                    '<script>window.onload = function() { window.print(); }</' + 'script>' +
                '</body>' +
                '</html>'
            );
        };

        init();
    </script>
</body>
</html>
