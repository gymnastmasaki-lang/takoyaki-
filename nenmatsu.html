<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¹´æœ«èª¿æ•´ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            @page { size: A4; margin: 15mm; }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app"></div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, getDoc, addDoc, updateDoc, deleteDoc, doc, setDoc, query, where, Timestamp, orderBy } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
            authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
            projectId: "takoyaki-order-system-bacd7",
            storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
            messagingSenderId: "104494752890",
            appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.firebaseModules = { collection, getDocs, getDoc, addDoc, updateDoc, deleteDoc, doc, setDoc, query, where, Timestamp, orderBy };
        window.FirebaseReady = true;
    </script>

    <script type="module">
        // å¹´æœ«èª¿æ•´è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯
        class NenmatsuCalculator {
            constructor(yearData) {
                this.yearData = yearData;
                this.year = yearData.year || new Date().getFullYear();
            }

            // çµ¦ä¸åå…¥åˆè¨ˆ
            getTotalIncome() {
                return this.yearData.totalIncome || 0;
            }

            // çµ¦ä¸æ‰€å¾—æ§é™¤
            getIncomeDeduction() {
                const income = this.getTotalIncome();
                if (income <= 1625000) return 550000;
                if (income <= 1800000) return income * 0.4 - 100000;
                if (income <= 3600000) return income * 0.3 + 80000;
                if (income <= 6600000) return income * 0.2 + 440000;
                if (income <= 8500000) return income * 0.1 + 1100000;
                return 1950000;
            }

            // çµ¦ä¸æ‰€å¾—
            getTaxableIncome() {
                return this.getTotalIncome() - this.getIncomeDeduction();
            }

            // åŸºç¤æ§é™¤ï¼ˆ2020å¹´æ”¹æ­£å¾Œï¼‰
            getBasicDeduction() {
                const income = this.getTaxableIncome();
                if (income <= 24000000) return 480000;
                if (income <= 24500000) return 320000;
                if (income <= 25000000) return 160000;
                return 0;
            }

            // é…å¶è€…æ§é™¤
            getSpouseDeduction(spouseIncome = 0) {
                const income = this.getTaxableIncome();
                if (spouseIncome > 1330000 || income > 10000000) return 0;
                
                if (spouseIncome <= 950000) {
                    if (income <= 9000000) return 380000;
                    if (income <= 9500000) return 260000;
                    if (income <= 10000000) return 130000;
                }
                return 0;
            }

            // é…å¶è€…ç‰¹åˆ¥æ§é™¤
            getSpouseSpecialDeduction(spouseIncome = 0) {
                const income = this.getTaxableIncome();
                if (spouseIncome <= 950000 || spouseIncome > 2015999 || income > 10000000) return 0;
                
                // æ‰€å¾—é‡‘é¡ã«å¿œã˜ãŸæ§é™¤é¡ï¼ˆç°¡ç•¥ç‰ˆï¼‰
                if (income <= 9000000) {
                    if (spouseIncome <= 1000000) return 380000;
                    if (spouseIncome <= 1050000) return 360000;
                    if (spouseIncome <= 1100000) return 310000;
                    if (spouseIncome <= 1150000) return 260000;
                    if (spouseIncome <= 1200000) return 210000;
                    if (spouseIncome <= 1250000) return 160000;
                    if (spouseIncome <= 1300000) return 110000;
                    if (spouseIncome <= 1350000) return 60000;
                    if (spouseIncome <= 1400000) return 30000;
                    return 0;
                }
                return 0;
            }

            // æ‰¶é¤Šæ§é™¤
            getDependentDeduction(dependents = []) {
                let total = 0;
                dependents.forEach(d => {
                    if (d.age >= 16 && d.age < 19) total += 380000; // ä¸€èˆ¬
                    else if (d.age >= 19 && d.age < 23) total += 630000; // ç‰¹å®š
                    else if (d.age >= 23 && d.age < 70) total += 380000; // ä¸€èˆ¬
                    else if (d.age >= 70) total += 480000; // è€äºº
                });
                return total;
            }

            // ç”Ÿå‘½ä¿é™ºæ–™æ§é™¤
            getLifeInsuranceDeduction(data = {}) {
                const calc = (amount) => {
                    if (amount <= 20000) return amount;
                    if (amount <= 40000) return amount * 0.5 + 10000;
                    if (amount <= 80000) return amount * 0.25 + 20000;
                    return 40000;
                };
                
                const lifeIns = calc(data.lifeInsurance || 0);
                const medicalIns = calc(data.medicalInsurance || 0);
                const pensionIns = calc(data.pensionInsurance || 0);
                
                return Math.min(lifeIns + medicalIns + pensionIns, 120000);
            }

            // åœ°éœ‡ä¿é™ºæ–™æ§é™¤
            getEarthquakeInsuranceDeduction(amount = 0) {
                return Math.min(amount, 50000);
            }

            // ç¤¾ä¼šä¿é™ºæ–™æ§é™¤
            getSocialInsuranceDeduction() {
                return this.yearData.totalSocialInsurance || 0;
            }

            // å°è¦æ¨¡ä¼æ¥­å…±æ¸ˆç­‰æ›é‡‘æ§é™¤
            getSmallBusinessDeduction(amount = 0) {
                return amount;
            }

            // æ‰€å¾—æ§é™¤åˆè¨ˆ
            getTotalDeductions(deductions = {}) {
                return this.getBasicDeduction() +
                       this.getSpouseDeduction(deductions.spouseIncome) +
                       this.getSpouseSpecialDeduction(deductions.spouseIncome) +
                       this.getDependentDeduction(deductions.dependents) +
                       this.getLifeInsuranceDeduction(deductions.lifeInsurance) +
                       this.getEarthquakeInsuranceDeduction(deductions.earthquakeInsurance) +
                       this.getSocialInsuranceDeduction() +
                       this.getSmallBusinessDeduction(deductions.smallBusiness);
            }

            // èª²ç¨æ‰€å¾—
            getTaxableIncomeAfterDeductions(deductions = {}) {
                return Math.max(0, this.getTaxableIncome() - this.getTotalDeductions(deductions));
            }

            // æ‰€å¾—ç¨é¡
            getIncomeTax(deductions = {}) {
                const taxable = this.getTaxableIncomeAfterDeductions(deductions);
                if (taxable <= 1950000) return taxable * 0.05;
                if (taxable <= 3300000) return taxable * 0.1 - 97500;
                if (taxable <= 6950000) return taxable * 0.2 - 427500;
                if (taxable <= 9000000) return taxable * 0.23 - 636000;
                if (taxable <= 18000000) return taxable * 0.33 - 1536000;
                if (taxable <= 40000000) return taxable * 0.40 - 2796000;
                return taxable * 0.45 - 4796000;
            }

            // å¾©èˆˆç‰¹åˆ¥æ‰€å¾—ç¨
            getReconstructionTax(deductions = {}) {
                return Math.floor(this.getIncomeTax(deductions) * 0.021);
            }

            // å¹´èª¿æ‰€å¾—ç¨é¡
            getTotalTax(deductions = {}) {
                return this.getIncomeTax(deductions) + this.getReconstructionTax(deductions);
            }

            // å¹´æœ«èª¿æ•´é‚„ä»˜ãƒ»å¾´åé¡
            getAdjustmentAmount(deductions = {}) {
                const totalTax = this.getTotalTax(deductions);
                const withheld = this.yearData.totalWithholdingTax || 0;
                return withheld - totalTax; // æ­£: é‚„ä»˜ã€è² : è¿½åŠ å¾´å
            }
        }

        // ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒª
        const app = document.getElementById('app');
        
        let employees = [];
        let selectedEmployee = null;
        let yearData = {};
        let deductions = {};
        let storeName = '';
        let targetYear = new Date().getFullYear();

        async function init() {
            if (!window.FirebaseReady) {
                setTimeout(init, 100);
                return;
            }

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰èªè¨¼æƒ…å ±ã‚’ç¢ºèª
            const storedStoreId = localStorage.getItem('nenmatsuStoreId');
            const storedStoreName = localStorage.getItem('nenmatsuStoreName');
            
            if (storedStoreId && storedStoreName) {
                window.currentStoreId = storedStoreId;
                window.currentStoreName = storedStoreName;
                storeName = storedStoreName;
                
                try {
                    await loadEmployees();
                    render();
                } catch (error) {
                    console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                    showLoginScreen();
                }
            } else {
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center">
                    <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
                        <h1 class="text-2xl font-bold mb-6">å¹´æœ«èª¿æ•´ã‚·ã‚¹ãƒ†ãƒ </h1>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">åº—èˆ—å</label>
                            <input type="text" id="storeNameInput" class="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" id="passwordInput" class="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <button onclick="handleLogin()" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                            ãƒ­ã‚°ã‚¤ãƒ³
                        </button>
                    </div>
                </div>
            `;
        }

        window.handleLogin = async function() {
            const storeNameValue = document.getElementById('storeNameInput').value.trim();
            const passwordValue = document.getElementById('passwordInput').value;
            
            if (!storeNameValue || !passwordValue) {
                alert('åº—èˆ—åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                const { collection, query, where, getDocs } = window.firebaseModules;
                
                // ğŸ”§ ä¸‹èµ¤å¡šåº—ã®å ´åˆã¯ç‰¹åˆ¥å‡¦ç†ï¼ˆstoreIdã‚’ç©ºã«ã™ã‚‹ï¼‰
                if (storeNameValue === 'ä¸‹èµ¤å¡š' || storeNameValue === 'shimoakatsuka') {
                    const shimoarekasukaPassword = 'K12290619T';  // ğŸ”§ æ­£ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                    
                    if (passwordValue === shimoarekasukaPassword) {
                        // ğŸ”§ å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                        localStorage.removeItem('nenmatsuStoreId');
                        localStorage.removeItem('nenmatsuStoreName');
                        
                        window.currentStoreId = '';  // ğŸ”§ ç©ºæ–‡å­—åˆ—ã«ã—ã¦ãƒ«ãƒ¼ãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
                        window.currentStoreName = 'ä¸‹èµ¤å¡š';
                        
                        localStorage.setItem('nenmatsuStoreId', '');
                        localStorage.setItem('nenmatsuStoreName', 'ä¸‹èµ¤å¡š');
                        
                        storeName = 'ä¸‹èµ¤å¡š';
                        console.log('âœ… ä¸‹èµ¤å¡šåº—ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼ˆãƒ«ãƒ¼ãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä½¿ç”¨ï¼‰');
                        console.log('ğŸ“ currentStoreId:', window.currentStoreId, '(ç©ºæ–‡å­—åˆ—)');
                        await loadEmployees();
                        render();
                        return;
                    } else {
                        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                        return;
                    }
                }
                
                // é€šå¸¸ã®åº—èˆ—ã®ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
                const storesRef = collection(window.db, 'stores');
                const q = query(storesRef, where('storeName', '==', storeNameValue));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    alert('åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                let authenticated = false;
                let storeData = null;
                let storeDocId = null;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.storePassword === passwordValue) {
                        if (data.isActive === false) {
                            alert('ã“ã®åº—èˆ—ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™');
                            return;
                        }
                        authenticated = true;
                        storeData = data;
                        storeDocId = doc.id;
                    }
                });

                if (authenticated && storeData) {
                    window.currentStoreId = storeDocId;
                    window.currentStoreName = storeData.storeName;
                    
                    localStorage.setItem('nenmatsuStoreId', storeDocId);
                    localStorage.setItem('nenmatsuStoreName', storeData.storeName);
                    
                    storeName = storeData.storeName;
                    await loadEmployees();
                    render();
                } else {
                    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                }
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        };

        async function loadEmployees() {
            const { collection, getDocs } = window.firebaseModules;
            
            console.log('ğŸ” ç¾åœ¨ã®currentStoreId:', window.currentStoreId, '(å‹:', typeof window.currentStoreId, ')');
            console.log('ğŸ” currentStoreName:', window.currentStoreName);
            
            // ğŸ”§ ä¸‹èµ¤å¡šåº—ã®å ´åˆã¯ãƒ«ãƒ¼ãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰èª­ã¿è¾¼ã¿
            let empRef;
            if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreName === 'ä¸‹èµ¤å¡š') {
                console.log('âœ… ä¸‹èµ¤å¡šåº—ï¼ˆIDãªã—ï¼‰: ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ã§å¾“æ¥­å“¡ã‚’å–å¾— (kintai_employees/)');
                empRef = collection(window.db, 'kintai_employees');
            } else {
                console.log('âš ï¸ åº—èˆ—IDä½¿ç”¨: stores/' + window.currentStoreId + '/employees');
                empRef = collection(window.db, 'stores', window.currentStoreId, 'employees');
            }
            
            const snapshot = await getDocs(empRef);
            
            employees = [];
            snapshot.forEach(doc => {
                employees.push({ id: doc.id, ...doc.data() });
            });
            
            // sortOrderã§ã‚½ãƒ¼ãƒˆï¼ˆsortOrderãŒãªã„å ´åˆã¯åå‰é †ï¼‰
            employees.sort((a, b) => {
                if (a.sortOrder !== undefined && b.sortOrder !== undefined) {
                    return a.sortOrder - b.sortOrder;
                }
                if (a.sortOrder !== undefined) return -1;
                if (b.sortOrder !== undefined) return 1;
                return (a.name || '').localeCompare(b.name || '');
            });
            
            console.log('å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', employees.length + 'å');
        }

        async function loadYearData(employeeId, year) {
            // å¹´é–“çµ¦ä¸ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
            const { collection, getDocs } = window.firebaseModules;
            
            const employee = employees.find(e => e.id === employeeId);
            if (!employee) return null;

            // å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            let totalIncome = 0;
            let totalSocialInsurance = 0;
            let totalWithholdingTax = 0;
            const monthlyData = [];

            // ğŸ”§ ä¸‹èµ¤å¡šåº—ã®å ´åˆã¯ãƒ«ãƒ¼ãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‹ã‚‰èª­ã¿è¾¼ã¿
            let attRef;
            if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreName === 'ä¸‹èµ¤å¡š') {
                console.log('âœ… ä¸‹èµ¤å¡šåº—ï¼ˆIDãªã—ï¼‰: ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ã§å‹¤æ€ ã‚’å–å¾— (kintai_attendance/)');
                attRef = collection(window.db, 'kintai_attendance');
            } else {
                console.log('âš ï¸ åº—èˆ—IDä½¿ç”¨: stores/' + window.currentStoreId + '/attendance');
                attRef = collection(window.db, 'stores', window.currentStoreId, 'attendance');
            }
            
            const snapshot = await getDocs(attRef);
            
            // æœˆåˆ¥ã«é›†è¨ˆ
            for (let month = 0; month < 12; month++) {
                const yearMonth = `${year}-${String(month + 1).padStart(2, '0')}`;
                
                let monthlyHours = 0;
                
                snapshot.forEach(doc => {
                    const date = doc.id; // ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDãŒæ—¥ä»˜ï¼ˆyyyy-MM-ddå½¢å¼ï¼‰
                    
                    // å¯¾è±¡å¹´æœˆã®ãƒ‡ãƒ¼ã‚¿ã‹ç¢ºèª
                    if (date.startsWith(yearMonth)) {
                        const data = doc.data();
                        
                        // å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª
                        if (data.employees && data.employees[employeeId]) {
                            const empData = data.employees[employeeId];
                            
                            // å‹¤å‹™æ™‚é–“ã‚’è¨ˆç®—
                            if (empData.clockIn && empData.clockOut) {
                                const parseTime = (timeStr) => {
                                    const [hours, minutes] = timeStr.split(':').map(Number);
                                    return hours + minutes / 60;
                                };
                                
                                let workHours = parseTime(empData.clockOut) - parseTime(empData.clockIn);
                                
                                // ä¼‘æ†©æ™‚é–“ã‚’å¼•ã
                                if (empData.breakStart1 && empData.breakEnd1) {
                                    const breakHours = parseTime(empData.breakEnd1) - parseTime(empData.breakStart1);
                                    workHours -= breakHours;
                                }
                                if (empData.breakStart2 && empData.breakEnd2) {
                                    const breakHours = parseTime(empData.breakEnd2) - parseTime(empData.breakStart2);
                                    workHours -= breakHours;
                                }
                                
                                monthlyHours += Math.max(0, workHours);
                            }
                        }
                    }
                });
                
                // çµ¦ä¸è¨ˆç®—
                const hourlyWage = employee.hourlyWage || employee.defaultHourlyWage || 1000;
                const monthlyIncome = Math.floor(monthlyHours * hourlyWage);
                
                // ç¤¾ä¼šä¿é™ºæ–™ï¼ˆç°¡æ˜“è¨ˆç®—ï¼šçµ¦ä¸ã®15%ï¼‰
                const monthlyInsurance = Math.floor(monthlyIncome * 0.15);
                
                // æºæ³‰å¾´åç¨ï¼ˆç°¡æ˜“è¨ˆç®—ï¼šèª²ç¨å¯¾è±¡é¡ã®5%ï¼‰
                const taxableIncome = monthlyIncome - monthlyInsurance;
                const monthlyTax = Math.floor(taxableIncome * 0.05);
                
                totalIncome += monthlyIncome;
                totalSocialInsurance += monthlyInsurance;
                totalWithholdingTax += monthlyTax;
                
                monthlyData.push({
                    month: month + 1,
                    income: monthlyIncome,
                    hours: Math.round(monthlyHours * 10) / 10,
                    insurance: monthlyInsurance,
                    tax: monthlyTax
                });
            }
            
            console.log('å¹´é–“ãƒ‡ãƒ¼ã‚¿é›†è¨ˆå®Œäº†:', {
                year: year,
                employeeId: employeeId,
                totalIncome: totalIncome,
                totalSocialInsurance: totalSocialInsurance,
                totalWithholdingTax: totalWithholdingTax
            });
            
            return {
                year: year,
                totalIncome: totalIncome,
                totalSocialInsurance: totalSocialInsurance,
                totalWithholdingTax: totalWithholdingTax,
                monthlyData: monthlyData
            };
        }

        function render() {
            if (!selectedEmployee) {
                renderEmployeeList();
            } else {
                renderAdjustmentForm();
            }
        }

        function renderEmployeeList() {
            console.log('å¾“æ¥­å“¡ä¸€è¦§ã‚’è¡¨ç¤º:', employees.length + 'å');
            
            app.innerHTML = `
                <div class="container mx-auto px-4 py-8">
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold">å¹´æœ«èª¿æ•´ã‚·ã‚¹ãƒ†ãƒ </h1>
                            <div class="flex gap-4">
                                <select id="targetYear" class="px-4 py-2 border rounded-lg" onchange="handleYearChange(this.value)">
                                    ${[0, 1, 2, 3].map(i => {
                                        const y = new Date().getFullYear() - i;
                                        return `<option value="${y}" ${y === targetYear ? 'selected' : ''}>${y}å¹´</option>`;
                                    }).join('')}
                                </select>
                                <button onclick="handleLogout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                                </button>
                            </div>
                        </div>
                        
                        <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                            <p class="text-gray-600">åº—èˆ—: ${storeName}</p>
                            <p class="text-gray-600">åº—èˆ—ID: ${window.currentStoreId}</p>
                            <p class="text-gray-600">å¯¾è±¡å¹´: ${targetYear}å¹´</p>
                            <p class="text-gray-600">å¾“æ¥­å“¡æ•°: ${employees.length}å</p>
                        </div>

                        <h2 class="text-xl font-bold mb-4">å¾“æ¥­å“¡ä¸€è¦§</h2>
                        <div class="space-y-3">
                            ${employees.map(emp => `
                                <div class="border rounded-lg p-4 flex justify-between items-center hover:bg-gray-50">
                                    <div>
                                        <div class="font-bold">${emp.name || 'åå‰æœªè¨­å®š'}</div>
                                        <div class="text-sm text-gray-600">${emp.furigana || ''}</div>
                                        <div class="text-sm text-gray-500">æ™‚çµ¦: Â¥${(emp.hourlyWage || emp.defaultHourlyWage || 1000).toLocaleString()}</div>
                                    </div>
                                    <button 
                                        onclick="selectEmployee('${emp.id}')" 
                                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
                                    >
                                        å¹´æœ«èª¿æ•´ã‚’é–‹å§‹
                                    </button>
                                </div>
                            `).join('')}
                        </div>
                        
                        ${employees.length === 0 ? `
                            <div class="text-center py-8">
                                <p class="text-gray-500 mb-4">å¾“æ¥­å“¡ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p>
                                <p class="text-sm text-gray-400">kanri.htmlã§å¾“æ¥­å“¡ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„</p>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderAdjustmentForm() {
            const emp = employees.find(e => e.id === selectedEmployee);
            const calculator = new NenmatsuCalculator(yearData);
            
            app.innerHTML = `
                <div class="container mx-auto px-4 py-8">
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-2xl font-bold">${targetYear}å¹´ å¹´æœ«èª¿æ•´</h1>
                            <button onclick="backToList()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                â† ä¸€è¦§ã«æˆ»ã‚‹
                            </button>
                        </div>

                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <div class="font-bold text-lg">${emp.name || 'åå‰æœªè¨­å®š'}</div>
                            <div class="text-sm text-gray-600">${emp.furigana || ''}</div>
                        </div>

                        <!-- åå…¥æƒ…å ± -->
                        <div class="mb-6">
                            <h3 class="text-lg font-bold mb-3">åå…¥æƒ…å ±</h3>
                            <div class="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg mb-4">
                                <div>
                                    <div class="text-sm text-gray-600">å¹´é–“çµ¦ä¸ç·é¡</div>
                                    <div class="text-xl font-bold">Â¥${calculator.getTotalIncome().toLocaleString()}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-600">çµ¦ä¸æ‰€å¾—æ§é™¤</div>
                                    <div class="text-xl font-bold">Â¥${calculator.getIncomeDeduction().toLocaleString()}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-600">çµ¦ä¸æ‰€å¾—</div>
                                    <div class="text-xl font-bold">Â¥${calculator.getTaxableIncome().toLocaleString()}</div>
                                </div>
                                <div>
                                    <div class="text-sm text-gray-600">ç¤¾ä¼šä¿é™ºæ–™</div>
                                    <div class="text-xl font-bold">Â¥${calculator.getSocialInsuranceDeduction().toLocaleString()}</div>
                                </div>
                            </div>
                            
                            ${yearData.monthlyData && yearData.monthlyData.length > 0 ? `
                                <details class="mt-4">
                                    <summary class="cursor-pointer font-bold text-blue-600 hover:text-blue-800">æœˆåˆ¥ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º</summary>
                                    <div class="mt-3 overflow-x-auto">
                                        <table class="w-full text-sm">
                                            <thead class="bg-gray-100">
                                                <tr>
                                                    <th class="px-3 py-2 text-left">æœˆ</th>
                                                    <th class="px-3 py-2 text-right">å‹¤å‹™æ™‚é–“</th>
                                                    <th class="px-3 py-2 text-right">çµ¦ä¸</th>
                                                    <th class="px-3 py-2 text-right">ç¤¾ä¼šä¿é™º</th>
                                                    <th class="px-3 py-2 text-right">æºæ³‰å¾´å</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${yearData.monthlyData.map(m => `
                                                    <tr class="border-b">
                                                        <td class="px-3 py-2">${m.month}æœˆ</td>
                                                        <td class="px-3 py-2 text-right">${m.hours.toFixed(1)}h</td>
                                                        <td class="px-3 py-2 text-right">Â¥${m.income.toLocaleString()}</td>
                                                        <td class="px-3 py-2 text-right">Â¥${m.insurance.toLocaleString()}</td>
                                                        <td class="px-3 py-2 text-right">Â¥${m.tax.toLocaleString()}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </details>
                            ` : '<p class="text-sm text-gray-500 mt-3">â€» çµ¦ä¸ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å‹¤æ€ ãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>'}
                        </div>

                        <!-- æ§é™¤å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
                        <div class="mb-6">
                            <h3 class="text-lg font-bold mb-3">æ§é™¤æƒ…å ±ã®å…¥åŠ›</h3>
                            <div id="deductionForm" class="space-y-4">
                                <!-- é…å¶è€…æƒ…å ± -->
                                <div class="p-4 border rounded-lg">
                                    <h4 class="font-bold mb-2">é…å¶è€…æƒ…å ±</h4>
                                    <div class="flex items-center gap-4">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="hasSpouse" onchange="toggleSpouse(this.checked)" class="mr-2" />
                                            é…å¶è€…ã‚ã‚Š
                                        </label>
                                        <div id="spouseIncome" class="hidden flex items-center gap-2">
                                            <label class="text-sm">é…å¶è€…ã®æ‰€å¾—:</label>
                                            <input type="number" id="spouseIncomeAmount" value="0" class="px-3 py-1 border rounded" />
                                            <span class="text-sm">å††</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- æ‰¶é¤Šå®¶æ— -->
                                <div class="p-4 border rounded-lg">
                                    <h4 class="font-bold mb-2">æ‰¶é¤Šè¦ªæ—</h4>
                                    <button onclick="addDependent()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 mb-3">
                                        + æ‰¶é¤Šè¦ªæ—ã‚’è¿½åŠ 
                                    </button>
                                    <div id="dependentsList"></div>
                                </div>

                                <!-- ç”Ÿå‘½ä¿é™ºæ–™æ§é™¤ -->
                                <div class="p-4 border rounded-lg">
                                    <h4 class="font-bold mb-2">ç”Ÿå‘½ä¿é™ºæ–™æ§é™¤</h4>
                                    <div class="grid grid-cols-3 gap-4">
                                        <div>
                                            <label class="text-sm">ä¸€èˆ¬ç”Ÿå‘½ä¿é™ºæ–™</label>
                                            <input type="number" id="lifeInsurance" value="0" class="w-full px-3 py-2 border rounded" />
                                        </div>
                                        <div>
                                            <label class="text-sm">ä»‹è­·åŒ»ç™‚ä¿é™ºæ–™</label>
                                            <input type="number" id="medicalInsurance" value="0" class="w-full px-3 py-2 border rounded" />
                                        </div>
                                        <div>
                                            <label class="text-sm">å€‹äººå¹´é‡‘ä¿é™ºæ–™</label>
                                            <input type="number" id="pensionInsurance" value="0" class="w-full px-3 py-2 border rounded" />
                                        </div>
                                    </div>
                                </div>

                                <!-- åœ°éœ‡ä¿é™ºæ–™æ§é™¤ -->
                                <div class="p-4 border rounded-lg">
                                    <h4 class="font-bold mb-2">åœ°éœ‡ä¿é™ºæ–™æ§é™¤</h4>
                                    <input type="number" id="earthquakeInsurance" value="0" class="px-3 py-2 border rounded" />
                                    <span class="text-sm ml-2">å††</span>
                                </div>

                                <!-- å°è¦æ¨¡ä¼æ¥­å…±æ¸ˆç­‰æ›é‡‘æ§é™¤ -->
                                <div class="p-4 border rounded-lg">
                                    <h4 class="font-bold mb-2">å°è¦æ¨¡ä¼æ¥­å…±æ¸ˆç­‰æ›é‡‘æ§é™¤</h4>
                                    <input type="number" id="smallBusiness" value="0" class="px-3 py-2 border rounded" />
                                    <span class="text-sm ml-2">å††</span>
                                </div>
                            </div>
                        </div>

                        <!-- è¨ˆç®—ãƒœã‚¿ãƒ³ -->
                        <div class="flex gap-4">
                            <button onclick="calculate()" class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-bold">
                                è¨ˆç®—ã™ã‚‹
                            </button>
                        </div>

                        <!-- è¨ˆç®—çµæœ -->
                        <div id="result" class="hidden mt-6"></div>
                    </div>
                </div>
            `;
        }

        window.handleYearChange = function(year) {
            targetYear = parseInt(year);
            render();
        };

        window.handleLogout = function() {
            localStorage.removeItem('nenmatsuStoreId');
            localStorage.removeItem('nenmatsuStoreName');
            window.currentStoreId = null;
            window.currentStoreName = null;
            storeName = '';
            employees = [];
            selectedEmployee = null;
            location.reload();
        };

        window.selectEmployee = async function(employeeId) {
            selectedEmployee = employeeId;
            
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            app.innerHTML = `
                <div class="min-h-screen flex items-center justify-center">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-500 border-t-transparent mx-auto mb-4"></div>
                        <p class="text-gray-700">å¹´é–“ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
                    </div>
                </div>
            `;
            
            try {
                yearData = await loadYearData(employeeId, targetYear);
                deductions = {};
                render();
            } catch (error) {
                console.error('å¹´ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                backToList();
            }
        };

        window.backToList = function() {
            selectedEmployee = null;
            render();
        };

        window.toggleSpouse = function(checked) {
            document.getElementById('spouseIncome').classList.toggle('hidden', !checked);
        };

        let dependents = [];
        window.addDependent = function() {
            dependents.push({ age: 16 });
            renderDependents();
        };

        window.removeDependent = function(index) {
            dependents.splice(index, 1);
            renderDependents();
        };

        function renderDependents() {
            const list = document.getElementById('dependentsList');
            list.innerHTML = dependents.map((d, i) => `
                <div class="flex items-center gap-4 mb-2">
                    <label class="text-sm">å¹´é½¢:</label>
                    <input type="number" value="${d.age}" onchange="dependents[${i}].age = parseInt(this.value)" class="px-3 py-1 border rounded w-20" />
                    <button onclick="removeDependent(${i})" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">å‰Šé™¤</button>
                </div>
            `).join('');
        }

        window.calculate = function() {
            const emp = employees.find(e => e.id === selectedEmployee);
            
            // æ§é™¤æƒ…å ±ã‚’åé›†
            deductions = {
                spouseIncome: document.getElementById('hasSpouse').checked ? 
                    parseInt(document.getElementById('spouseIncomeAmount').value) || 0 : 0,
                dependents: dependents,
                lifeInsurance: {
                    lifeInsurance: parseInt(document.getElementById('lifeInsurance').value) || 0,
                    medicalInsurance: parseInt(document.getElementById('medicalInsurance').value) || 0,
                    pensionInsurance: parseInt(document.getElementById('pensionInsurance').value) || 0
                },
                earthquakeInsurance: parseInt(document.getElementById('earthquakeInsurance').value) || 0,
                smallBusiness: parseInt(document.getElementById('smallBusiness').value) || 0
            };

            const calculator = new NenmatsuCalculator(yearData);
            
            const totalDeductions = calculator.getTotalDeductions(deductions);
            const taxableIncome = calculator.getTaxableIncomeAfterDeductions(deductions);
            const incomeTax = calculator.getIncomeTax(deductions);
            const reconstructionTax = calculator.getReconstructionTax(deductions);
            const totalTax = calculator.getTotalTax(deductions);
            const adjustment = calculator.getAdjustmentAmount(deductions);

            const resultDiv = document.getElementById('result');
            resultDiv.classList.remove('hidden');
            resultDiv.innerHTML = `
                <div class="p-6 bg-gradient-to-r from-blue-50 to-green-50 rounded-lg">
                    <h3 class="text-2xl font-bold mb-6 text-center">è¨ˆç®—çµæœ</h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-sm text-gray-600">åŸºç¤æ§é™¤</div>
                            <div class="text-xl font-bold">Â¥${calculator.getBasicDeduction().toLocaleString()}</div>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-sm text-gray-600">é…å¶è€…(ç‰¹åˆ¥)æ§é™¤</div>
                            <div class="text-xl font-bold">Â¥${(calculator.getSpouseDeduction(deductions.spouseIncome) + calculator.getSpouseSpecialDeduction(deductions.spouseIncome)).toLocaleString()}</div>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-sm text-gray-600">æ‰¶é¤Šæ§é™¤</div>
                            <div class="text-xl font-bold">Â¥${calculator.getDependentDeduction(deductions.dependents).toLocaleString()}</div>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-sm text-gray-600">ç”Ÿå‘½ä¿é™ºæ–™æ§é™¤</div>
                            <div class="text-xl font-bold">Â¥${calculator.getLifeInsuranceDeduction(deductions.lifeInsurance).toLocaleString()}</div>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-sm text-gray-600">åœ°éœ‡ä¿é™ºæ–™æ§é™¤</div>
                            <div class="text-xl font-bold">Â¥${calculator.getEarthquakeInsuranceDeduction(deductions.earthquakeInsurance).toLocaleString()}</div>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-sm text-gray-600">ç¤¾ä¼šä¿é™ºæ–™æ§é™¤</div>
                            <div class="text-xl font-bold">Â¥${calculator.getSocialInsuranceDeduction().toLocaleString()}</div>
                        </div>
                    </div>

                    <div class="p-4 bg-white rounded-lg shadow mb-6">
                        <div class="text-sm text-gray-600">æ‰€å¾—æ§é™¤åˆè¨ˆ</div>
                        <div class="text-2xl font-bold text-blue-600">Â¥${totalDeductions.toLocaleString()}</div>
                    </div>

                    <div class="grid grid-cols-3 gap-4 mb-6">
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-sm text-gray-600">èª²ç¨æ‰€å¾—</div>
                            <div class="text-xl font-bold">Â¥${taxableIncome.toLocaleString()}</div>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-sm text-gray-600">æ‰€å¾—ç¨é¡</div>
                            <div class="text-xl font-bold">Â¥${Math.floor(incomeTax).toLocaleString()}</div>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-sm text-gray-600">å¾©èˆˆç‰¹åˆ¥æ‰€å¾—ç¨</div>
                            <div class="text-xl font-bold">Â¥${reconstructionTax.toLocaleString()}</div>
                        </div>
                    </div>

                    <div class="p-6 bg-white rounded-lg shadow-lg">
                        <div class="text-center mb-2">
                            <div class="text-lg text-gray-600">å¹´æœ«èª¿æ•´${adjustment >= 0 ? 'é‚„ä»˜' : 'è¿½åŠ å¾´å'}é¡</div>
                            <div class="text-4xl font-bold ${adjustment >= 0 ? 'text-green-600' : 'text-red-600'}">
                                ${adjustment >= 0 ? '+' : ''}Â¥${Math.floor(adjustment).toLocaleString()}
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 flex gap-4">
                        <button onclick="downloadPDF()" class="flex-1 px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 font-bold">
                            æºæ³‰å¾´åç¥¨ã‚’PDFå‡ºåŠ›
                        </button>
                        <button onclick="downloadCSV()" class="flex-1 px-6 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 font-bold">
                            e-Taxç”¨CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                        </button>
                    </div>
                </div>
            `;
        };

        window.downloadPDF = function() {
            alert('æºæ³‰å¾´åç¥¨PDFæ©Ÿèƒ½ã¯æº–å‚™ä¸­ã§ã™ã€‚\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®å°åˆ·æ©Ÿèƒ½ã§ä»£ç”¨ã§ãã¾ã™ã€‚');
            window.print();
        };

        window.downloadCSV = function() {
            const emp = employees.find(e => e.id === selectedEmployee);
            const calculator = new NenmatsuCalculator(yearData);
            
            const csv = [
                ['å¹´åº¦', 'æ°å', 'ãƒ•ãƒªã‚¬ãƒŠ', 'çµ¦ä¸åå…¥', 'çµ¦ä¸æ‰€å¾—', 'æ‰€å¾—æ§é™¤åˆè¨ˆ', 'èª²ç¨æ‰€å¾—', 'æ‰€å¾—ç¨é¡', 'é‚„ä»˜ãƒ»å¾´åé¡'],
                [
                    targetYear,
                    emp.name,
                    emp.furigana,
                    calculator.getTotalIncome(),
                    calculator.getTaxableIncome(),
                    calculator.getTotalDeductions(deductions),
                    calculator.getTaxableIncomeAfterDeductions(deductions),
                    Math.floor(calculator.getTotalTax(deductions)),
                    Math.floor(calculator.getAdjustmentAmount(deductions))
                ]
            ].map(row => row.join(',')).join('\n');
            
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `å¹´æœ«èª¿æ•´_${emp.name}_${targetYear}.csv`;
            a.click();
        };

        init();
    </script>
</body>
</html>
