<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="robots" content="noindex, nofollow">
  <title>ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—</title>
  
  <script>
    // ã‚¿ãƒƒãƒ—éŸ³ã‚’å†ç”Ÿã™ã‚‹é–¢æ•°ï¼ˆPOSã¨åŒã˜è¨­å®šï¼‰
    function playBeep() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800; // 800Hzã®ãƒ“ãƒ¼ãƒ—éŸ³
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.1);
    }
    
    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã«ãƒ“ãƒ¼ãƒ—éŸ³ã‚’è¿½åŠ 
    document.addEventListener('DOMContentLoaded', function() {
      document.addEventListener('click', function(e) {
        // ãƒœã‚¿ãƒ³ã€ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã€å•†å“ã€ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰ãƒ“ãƒ¼ãƒ—éŸ³
        if (e.target.closest('button') || 
            e.target.closest('.table-btn') || 
            e.target.closest('.menu-item-checkbox') || 
            e.target.closest('.topping-item') ||
            e.target.closest('.menu-item') ||
            e.target.type === 'checkbox') {
          playBeep();
        }
      });
    });
    
    // ğŸ”§ ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰è¨­å®šï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯falseã«ï¼‰
    const DEBUG_MODE = false; // â† ãŠå®¢æ§˜å‘ã‘ã¯falseã€é–‹ç™ºæ™‚ã¯true
    
    // console.logã‚’ä¸Šæ›¸ãã—ã¦ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ã«å¯¾å¿œ
    if (!DEBUG_MODE) {
      const noop = function() {};
      const originalError = console.error;
      console.log = noop;
      console.warn = noop;
      console.info = noop;
      // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã¯å¸¸ã«è¡¨ç¤º
      console.error = originalError;
    }
    
    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†
    (function() {
      const urlParams = new URLSearchParams(window.location.search);
      const tableNumber = urlParams.get('table');
      const storeId = urlParams.get('store');
      const orderId = urlParams.get('orderId');
      const fromIndex = urlParams.get('fromIndex');
      const mode = urlParams.get('mode'); // POSãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
      
      // POSãƒ¢ãƒ¼ãƒ‰ãƒ•ãƒ©ã‚°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«è¨­å®š
      window.isPOSMode = mode === 'pos';
      
      console.log('=== ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯ ===');
      console.log('tableNumber:', tableNumber);
      console.log('storeId:', storeId);
      console.log('orderId:', orderId);
      console.log('fromIndex:', fromIndex);
      console.log('POSãƒ¢ãƒ¼ãƒ‰:', window.isPOSMode);
      
      if (fromIndex) {
        const newUrl = new URL(window.location);
        newUrl.searchParams.delete('fromIndex');
        window.history.replaceState({}, '', newUrl);
        console.log('â†’ fromIndexãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
      }
      
      if (tableNumber && !orderId && !fromIndex) {
        // ğŸ”§ storeãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ä¿æŒã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        let redirectUrl = 'index.html?table=' + tableNumber;
        if (storeId) {
          redirectUrl += '&store=' + storeId;
        }
        console.log('â†’ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆ:', redirectUrl);
        window.location.href = redirectUrl;
      } else {
        console.log('â†’ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ãªã„(ã“ã®ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º)');
      }
    })();
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèƒŒæ™¯ï¼ˆç”»åƒãŒãªã„å ´åˆï¼‰ */
      min-height: 100vh;
      padding: 0;
      margin: 0;
      max-width: 100vw;
      overflow-x: hidden;
    }
    
    .header {
      background: #FFFF80;
      color: #000;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 0;
      font-weight: bold;
      color: #000;
    }
    
    .container {
      max-width: 100%;
      margin: 0;
      padding: 10px;
      min-height: calc(100vh - 80px);
    }
    
    @media (min-width: 420px) {
      .container {
        max-width: 420px;
        margin: 0 auto;
        padding: 15px;
      }
    }
    
    .category-filter {
      background: white;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .category-filter label {
      display: block;
      font-size: 14px;
      font-weight: normal;
      color: #666;
      margin-bottom: 5px;
    }
    
    select {
      width: 100%;
      padding: 12px;
      font-size: 16px;
      border: 2px solid #4CAF50;
      border-radius: 8px;
      background: white;
      color: #333;
      font-weight: 400;
    }
    
    .menu-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 100px;
    }
    
    @media (min-width: 420px) {
      .menu-grid {
        gap: 12px;
      }
    }
    
    .menu-item {
      background: white;
      border-radius: 15px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s ease-out;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 10px;
      position: relative;
      -webkit-tap-highlight-color: rgba(76, 175, 80, 0.2);
      touch-action: manipulation;
    }
    
    .menu-item.sold-out {
      opacity: 0.5;
      cursor: not-allowed;
      background: #f5f5f5;
    }
    
    .menu-item.sold-out::after {
      content: 'å“åˆ‡ã‚Œ';
      position: absolute;
      top: 10px;
      right: 10px;
      background: #f44336;
      color: white;
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(244, 67, 54, 0.4);
    }
    
    .menu-item:active {
      transform: scale(0.95);
    }
    
    .menu-item:hover {
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
      transform: translateY(-3px);
    }
    
    .menu-item-image {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 10px;
      flex-shrink: 0;
    }
    
    .menu-item-content {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .menu-item-name {
      font-size: 14px;
      font-weight: bold;
      color: #333;
      margin-bottom: 5px;
      line-height: 1.3;
      width: 100%;
    }
    
    @media (min-width: 420px) {
      .menu-item-name {
        font-size: 15px;
      }
    }
    
    .menu-item-price {
      font-size: 25px;
      color: #4CAF50;
      font-weight: bold;
    }
    
    .menu-item-note {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }
    
    button {
      width: 100%;
      padding: 18px;
      font-size: 20px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s ease-out; /* ğŸš€ 0.3sâ†’0.2sã«é«˜é€ŸåŒ– */
      margin: 8px 0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      -webkit-tap-highlight-color: rgba(76, 175, 80, 0.3); /* ğŸš€ ã‚¿ãƒƒãƒ—ãƒã‚¤ãƒ©ã‚¤ãƒˆè¿½åŠ  */
      touch-action: manipulation; /* ğŸš€ ãƒ€ãƒ–ãƒ«ã‚¿ãƒƒãƒ—ã‚ºãƒ¼ãƒ é˜²æ­¢ */
    }
    
    button:active {
      transform: scale(0.95); /* ğŸš€ 0.98â†’0.95ã«ã‚ˆã‚Šæ˜ç¢ºã« */
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .topping-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 20px 0;
    }
    
    .topping-set-header {
      font-weight: bold;
      font-size: 18px;
      margin: 15px 0 10px 0;
      padding: 12px;
      background: #f5f5f5;
      border-radius: 8px;
      color: #333;
      text-align: center;
    }
    
    .topping-set-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .topping-item {
      padding: 12px;
      border: 3px solid #e0e0e0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      background: white;
      font-size: 14px;
      gap: 5px;
    }
    
    .topping-item.selected {
      background: #e8f5e9;
      border-color: #4CAF50;
      font-weight: bold;
    }
    
    .topping-item:active {
      transform: scale(0.98);
    }
    
    .quantity-control {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin: 25px 0;
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .quantity-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #4CAF50;
      color: white;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
    }
    
    .quantity-btn:active {
      transform: scale(0.9);
    }
    
    .quantity-display {
      font-size: 40px;
      font-weight: bold;
      min-width: 80px;
      text-align: center;
      color: #333;
    }
    
    .price-display {
      background: white;
      padding: 20px;
      border-radius: 15px;
      text-align: center;
      margin: 20px 0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .price-label {
      font-size: 18px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .price-amount {
      font-size: 36px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .cart-item {
      background: white;
      border-radius: 15px;
      padding: 18px;
      margin-bottom: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    
    .cart-item-delete-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #f44336;
      color: white;
      border: none;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      font-size: 18px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(244, 67, 54, 0.4);
    }
    
    .cart-item-delete-btn:active {
      transform: scale(0.9);
    }
    
    .cart-item.sold-out {
      background: #ffebee;
      border: 2px solid #f44336;
    }
    
    .cart-item.sold-out::after {
      content: 'âš ï¸ å“åˆ‡ã‚Œ';
      position: absolute;
      top: 10px;
      right: 10px;
      background: #f44336;
      color: white;
      padding: 5px 10px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: bold;
    }
    
    .cart-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .cart-item-name {
      font-weight: bold;
      font-size: 18px;
      color: #333;
    }
    
    .cart-item-price {
      font-size: 20px;
      color: #4CAF50;
      font-weight: bold;
    }
    
    .cart-item-details {
      font-size: 16px;
      color: #666;
      margin-top: 5px;
    }
    
    .order-complete {
      text-align: center;
      padding: 30px 20px;
    }
    
    .order-number-display {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      font-size: 80px;
      font-weight: bold;
      padding: 40px;
      border-radius: 20px;
      margin: 30px 0;
      box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
      text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
    }
    
    .waiting-info {
      font-size: 22px;
      color: #000;
      margin: 25px 0;
      font-weight: bold;
    }
    
    .waiting-info span {
      font-size: 66px;
      display: inline-block;
      color: #FF0000;
    }
    
    .warning-box {
      background: #fff3cd;
      border: 3px solid #ffc107;
      color: #856404;
      padding: 20px;
      border-radius: 15px;
      margin: 25px 0;
      font-size: 18px;
      font-weight: bold;
      line-height: 1.6;
    }
    
    .hidden { display: none; }
    
    .page-title {
      font-size: 24px;
      font-weight: bold;
      color: #000;
      margin-bottom: 20px;
      text-align: center;
      font-family: 'Hiragino Maru Gothic ProN', 'Rounded Mplus 1c', sans-serif;
    }
    
    .top-waiting-info {
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 25px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .top-waiting-label {
      font-size: 16px;
      font-weight: bold;
      color: #666;
      margin-bottom: 5px;
    }
    
    .top-waiting-count {
      font-size: 32px;
      font-weight: bold;
      color: #ff6b6b;
    }
    
    .item-info-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div class="header">
    <img src="./head.jpg" alt="ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—" style="max-width: 100%; height: auto; display: block; margin: 0 auto;" onerror="this.style.display='none'">
  </div>

  <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ãƒšãƒ¼ã‚¸ -->
  <div id="page-menu">
    <div class="container">
      <div class="top-waiting-info">
        <div class="top-waiting-label">ãŸã ä»Šã®ãŠå¾…ã¡äººæ•°</div>
        <div class="top-waiting-count"><span id="top-waiting">-</span>çµ„</div>
      </div>
      <div class="category-filter">
        <label>ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰é¸ã¶</label>
        <select id="category-select">
          <option value="">å…¨ã¦ã®å•†å“</option>
        </select>
      </div>
      <div class="menu-grid" id="menu-list"></div>
    </div>
    <button id="cart-btn" class="btn-primary" style="position: fixed; bottom: 20px; left: 20px; right: 20px; z-index: 1000; box-shadow: 0 8px 20px rgba(0,0,0,0.3); display: none;" onclick="showCart()">ã‚«ãƒ¼ãƒˆã‚’è¦‹ã‚‹</button>
  </div>

  <!-- ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠãƒšãƒ¼ã‚¸ -->
  <div id="page-topping" class="hidden">
    <div class="container">
      <div class="item-info-card" id="item-info"></div>
      <div class="topping-list" id="topping-list"></div>
      <div class="quantity-control">
        <div class="quantity-btn" onclick="changeQty(-1)">âˆ’</div>
        <div class="quantity-display" id="qty">1</div>
        <div class="quantity-btn" onclick="changeQty(1)">+</div>
      </div>
      <div class="price-display">
        <div class="price-label">å°è¨ˆ</div>
        <div class="price-amount" id="subtotal">Â¥0</div>
      </div>
      <button class="btn-primary" onclick="addToCart()">ã‚«ãƒ¼ãƒˆã«è¿½åŠ </button>
      <button class="btn-secondary" onclick="backToMenu()">æˆ»ã‚‹</button>
    </div>
  </div>

  <!-- ã‚«ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ -->
  <div id="page-cart" class="hidden">
    <div class="container">
      <div class="page-title">ã‚«ãƒ¼ãƒˆ</div>
      <div id="cart-items"></div>
      
      <!-- ãƒ¬ã‚¸è¢‹é¸æŠ -->
      <div style="background: white; padding: 15px; border-radius: 15px; margin: 15px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1);">
        <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px;">ğŸ›ï¸ ãƒ¬ã‚¸è¢‹</div>
        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
          <button id="bag-not-needed" class="bag-btn selected" onclick="selectBagOption('not-needed')" style="flex: 1; padding: 12px; border: 2px solid #4CAF50; background: #e8f5e9; color: #4CAF50; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">ä¸è¦</button>
          <button id="bag-needed" class="bag-btn" onclick="selectBagOption('needed')" style="flex: 1; padding: 12px; border: 2px solid #e0e0e0; background: white; color: #666; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">å¿…è¦</button>
        </div>
        <div style="font-size: 12px; color: #999; margin-bottom: 10px; text-align: center;">â€» 1æš3å•†å“ç¨‹åº¦å…¥ã‚Šã¾ã™</div>
        <div id="bag-quantity-section" class="hidden" style="margin-top: 15px;">
          <div style="font-size: 14px; color: #666; margin-bottom: 8px;">æšæ•°é¸æŠï¼ˆ1æš Â¥3ï¼‰</div>
          <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
            <button onclick="changeBagQuantity(-1)" style="width: 40px; height: 40px; border-radius: 50%; background: #f44336; color: white; font-size: 24px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1;">âˆ’</button>
            <div id="bag-quantity" style="font-size: 28px; font-weight: bold; min-width: 50px; text-align: center;">0</div>
            <button onclick="changeBagQuantity(1)" style="width: 40px; height: 40px; border-radius: 50%; background: #4CAF50; color: white; font-size: 24px; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; line-height: 1;">+</button>
          </div>
          <div style="text-align: center; margin-top: 8px; font-size: 16px; font-weight: bold; color: #4CAF50;">
            ãƒ¬ã‚¸è¢‹ä»£: <span id="bag-price">Â¥0</span>
          </div>
        </div>
      </div>
      
      <!-- ãŠå®¢æ§˜ãƒ¡ãƒ¢ -->
      <div id="memo-section" style="background: white; padding: 15px; border-radius: 15px; margin: 15px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none;">
        <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px;">ğŸ“ å‚™è€ƒãƒ»ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰</div>
        <textarea id="customer-memo" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
      </div>
      
      <!-- ãŠåå‰å…¥åŠ›æ¬„ -->
      <div id="name-section" style="background: white; padding: 15px; border-radius: 15px; margin: 15px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none;">
        <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px;">
          ğŸ‘¤ ãŠåå‰<span id="name-required-mark" style="color: #f44336; margin-left: 5px; display: none;">*</span>
        </div>
        <input type="text" id="customer-name" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;" placeholder="å±±ç”° å¤ªéƒ">
      </div>
      
      <!-- éƒµä¾¿ç•ªå·å…¥åŠ›æ¬„ -->
      <div id="postal-code-section" style="background: white; padding: 15px; border-radius: 15px; margin: 15px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none;">
        <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px;">
          ğŸ“® éƒµä¾¿ç•ªå·<span id="postal-code-required-mark" style="color: #f44336; margin-left: 5px; display: none;">*</span>
        </div>
        <input type="text" id="customer-postal-code" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;" placeholder="123-4567">
      </div>
      
      <!-- ä½æ‰€å…¥åŠ›æ¬„ -->
      <div id="address-section" style="background: white; padding: 15px; border-radius: 15px; margin: 15px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none;">
        <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px;">
          ğŸ  ä½æ‰€<span id="address-required-mark" style="color: #f44336; margin-left: 5px; display: none;">*</span>
        </div>
        <textarea id="customer-address" rows="2" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;" placeholder="æ±äº¬éƒ½â—‹â—‹åŒºâ—‹â—‹ç”º1-2-3"></textarea>
      </div>
      
      <!-- ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›æ¬„ -->
      <div id="email-section" style="background: white; padding: 15px; border-radius: 15px; margin: 15px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none;">
        <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px;">
          ğŸ“§ ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹<span id="email-required-mark" style="color: #f44336; margin-left: 5px; display: none;">*</span>
        </div>
        <input type="email" id="customer-email" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;" placeholder="example@email.com">
      </div>
      
      <!-- é›»è©±ç•ªå·å…¥åŠ›æ¬„ -->
      <div id="phone-section" style="background: white; padding: 15px; border-radius: 15px; margin: 15px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none;">
        <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px;">
          ğŸ“ é›»è©±ç•ªå·<span id="phone-required-mark" style="color: #f44336; margin-left: 5px; display: none;">*</span>
        </div>
        <input type="tel" id="customer-phone" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;" placeholder="090-1234-5678">
      </div>
      
      <!-- ğŸ†• å¼•å–æ™‚é–“å…¥åŠ›æ¬„ -->
      <div id="pickup-time-section" style="background: white; padding: 15px; border-radius: 15px; margin: 15px 0; box-shadow: 0 4px 10px rgba(0,0,0,0.1); display: none;">
        <div style="font-size: 16px; font-weight: bold; color: #333; margin-bottom: 10px;">
          ğŸ• å¼•å–æ™‚é–“<span id="pickup-time-required-mark" style="color: #f44336; margin-left: 5px; display: none;">*</span>
        </div>
        <select id="customer-pickup-time" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
          <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
        </select>
      </div>
      
      <div class="price-display">
        <div class="price-label">åˆè¨ˆé‡‘é¡</div>
        <div class="price-amount" id="cart-total">Â¥0</div>
      </div>
      <button class="btn-primary" onclick="confirmOrder()">æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹</button>
      <button class="btn-secondary" onclick="continueShopping()">è²·ã„ç‰©ã‚’ç¶šã‘ã‚‹</button>
    </div>
  </div>

  <!-- æ³¨æ–‡å®Œäº†ãƒšãƒ¼ã‚¸ -->
  <div id="page-complete" class="hidden">
    <div class="container">
      <div class="order-complete">
        <div style="font-size: 20px; font-weight: bold; color: #000; margin: 20px 0;">ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</div>
        
        <div id="order-status" class="warning-box" style="background: linear-gradient(135deg, #a8edea 0%, #89d4cf 100%); color: #000; border-color: #89d4cf;">
          â³ ãŸã ä»Šæº–å‚™ã—ã¦ã„ã¾ã™ã€<br>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„
        </div>
        
        <div class="waiting-info">ãŠå®¢æ§˜ã¯<span id="waiting">1</span>ç•ªç›®ã«<br>ãŠå¾…ã¡é ‚ã„ã¦ã¾ã™</div>
        
        <div style="color: #000; font-size: 22px; margin: 15px 0;">æ³¨æ–‡ç•ªå·</div>
        <div class="order-number-display" id="order-num">000</div>
        
        <div style="margin: 20px 0; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
          <button class="btn-primary" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%); box-shadow: 0 4px 15px rgba(33,150,243,0.3); padding: 15px; font-size: 16px;" onclick="showReceipt()"> ãƒ¬ã‚·ãƒ¼ãƒˆç™ºè¡Œ</button>
          <button class="btn-primary" style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); box-shadow: 0 4px 15px rgba(156,39,176,0.3); padding: 15px; font-size: 16px;" onclick="showInvoice()"> é ˜åæ›¸ç™ºè¡Œ</button>
        </div>
        
        <div style="margin: 20px 0;">
          <button class="btn-primary" style="background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); box-shadow: 0 8px 20px rgba(0,0,0,0.3); padding: 15px; font-size: 18px; width: 100%;" onclick="callStaffFromComplete()"> å‘¼å‡º</button>
        </div>
        
        <div style="margin: 20px 0;">
          <button class="btn-primary" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); box-shadow: 0 4px 15px rgba(76,175,80,0.3); padding: 15px; font-size: 18px; width: 100%;" onclick="startNewOrder()"> æ–°ã—ã„æ³¨æ–‡ã‚’ã™ã‚‹</button>
        </div>
        
        <div style="background: white; padding: 15px; border-radius: 10px; margin: 20px 0;">
          <div style="font-size: 18px; color: #666; margin-bottom: 5px;">ã”åˆ©ç”¨ã‚¹ã‚¿ã‚¤ãƒ«</div>
          <div style="font-size: 28px; font-weight: bold; color: #ff6b9d;" id="eat-style">-</div>
        </div>
        
        <div id="status-message" class="warning-box" style="display: none;">
          <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
        
        <div id="warning-message" class="warning-box" style="background: #ffebee; border-color: #ef5350; color: #c62828; display: none;">
          <!-- è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
        </div>
        
        <h2 style="color: #000; font-size: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); margin: 20px 0;">âœ… ã”æ³¨æ–‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™</h2>
        
        <div style="color: black; font-size: 22px; margin: 25px 0; font-weight: bold;">ã”æ³¨æ–‡å†…å®¹</div>
        <div id="order-items"></div>
        <div class="price-display">
          <div class="price-label">åˆè¨ˆé‡‘é¡</div>
          <div class="price-amount" id="order-total">Â¥0</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ¬ã‚·ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="receipt-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; overflow-y: auto;">
    <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;">
      <div style="background: white; max-width: 400px; width: 100%; border-radius: 10px; overflow: hidden;">
        <div id="receipt-content" style="padding: 30px; background: white;">
          <!-- Receipt content will be inserted here -->
        </div>
        <div style="padding: 20px; background: #f5f5f5; display: flex; gap: 10px;">
          <button onclick="downloadReceipt()" style="flex: 1; padding: 15px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">ğŸ’¾ ä¿å­˜</button>
          <button onclick="closeReceipt()" style="flex: 1; padding: 15px; background: #666; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <!-- é ˜åæ›¸ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="invoice-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; overflow-y: auto;">
    <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;">
      <div style="background: white; max-width: 400px; width: 100%; border-radius: 10px; overflow: hidden;">
        <div id="invoice-content" style="padding: 30px; background: white;">
          <!-- Invoice content will be inserted here -->
        </div>
        <div style="padding: 20px; background: #f5f5f5; display: flex; gap: 10px;">
          <button onclick="downloadInvoice()" style="flex: 1; padding: 15px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">ğŸ’¾ ä¿å­˜</button>
          <button onclick="closeInvoice()" style="flex: 1; padding: 15px; background: #666; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, getDoc, addDoc, onSnapshot, updateDoc, deleteDoc, doc, Timestamp, setDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // åº—èˆ—IDç®¡ç†
    let currentStoreId = null;
    let currentStoreName = null;

    // åº—èˆ—åˆ¥ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§ã‚’å–å¾—
    window.getStoreCollection = function(collectionName) {
      console.log('ğŸ” getStoreCollectionå‘¼ã³å‡ºã—');
      console.log('   ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å:', collectionName);
      console.log('   window.currentStoreId:', window.currentStoreId);
      console.log('   typeof:', typeof window.currentStoreId);
      
      // ğŸ”§ ä¿®æ­£: currentStoreIdãŒnullã¾ãŸã¯ç©ºã®å ´åˆã®ã¿æ—§ãƒ‘ã‚¹ã‚’ä½¿ç”¨
      if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
        const oldPathMap = {
          "menus": "menu",
          "employees": "kintai_employees",
          "attendance": "kintai_attendance"
        };
        const path = oldPathMap[collectionName] || collectionName;
        console.log('   â†’ æ—§ãƒ‘ã‚¹ä½¿ç”¨:', path);
        return collection(db, path);
      }
      console.log('   â†’ æ–°ãƒ‘ã‚¹ä½¿ç”¨: stores/' + window.currentStoreId + '/' + collectionName);
      return collection(db, "stores", window.currentStoreId, collectionName);
    };

    // åº—èˆ—åˆ¥ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ã‚’å–å¾—
    window.getStoreDoc = function(collectionName, docId) {
      // ğŸ”§ ä¿®æ­£: currentStoreIdãŒnullã¾ãŸã¯ç©ºã®å ´åˆã®ã¿æ—§ãƒ‘ã‚¹ã‚’ä½¿ç”¨
      if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
        const oldPathMap = {
          "menus": "menu",
          "employees": "kintai_employees",
          "attendance": "kintai_attendance"
        };
        return doc(db, oldPathMap[collectionName] || collectionName, docId);
      }
      return doc(db, "stores", window.currentStoreId, collectionName, docId);
    };

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰åº—èˆ—IDã‚’å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const storeIdParam = urlParams.get('store');
    
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('ğŸ“ menu.html åº—èˆ—IDè¨­å®šé–‹å§‹');
    console.log('   URL:', window.location.href);
    console.log('   storeãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:', storeIdParam);
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    if (storeIdParam && storeIdParam !== 'shimoakatsuka') {
      // æ–°ã—ã„åº—èˆ—
      currentStoreId = storeIdParam;
      window.currentStoreId = currentStoreId;
      currentStoreName = storeIdParam; // ä»®ã®åº—èˆ—å
      console.log('âœ… æ–°åº—èˆ—ãƒ¢ãƒ¼ãƒ‰');
      console.log('   è¨­å®šã•ã‚ŒãŸåº—èˆ—ID:', currentStoreId);
      console.log('   window.currentStoreId:', window.currentStoreId);
    } else if (storeIdParam === 'shimoakatsuka' || storeIdParam === 'shimoarekasuka') {
      // ğŸ”§ ä¸‹èµ¤å¡šåº—ï¼ˆURLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æŒ‡å®šï¼‰â†’ null ã«å¤‰æ›ã—ã¦æ—§ãƒ‘ã‚¹ã‚’ä½¿ç”¨
      currentStoreId = null;
      window.currentStoreId = null;
      currentStoreName = 'ä¸‹èµ¤å¡š';
      console.log('ğŸ”§ ä¸‹èµ¤å¡šåº—ã®IDã‚’æ¤œå‡º: ' + storeIdParam + ' â†’ null (æ—§ãƒ‘ã‚¹ä½¿ç”¨)');
      console.log('   window.currentStoreId:', window.currentStoreId);
    } else {
      // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãªã— = ä¸‹èµ¤å¡šåº—ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰â†’ null ã«å¤‰æ›
      currentStoreId = null;
      window.currentStoreId = null;
      currentStoreName = 'ä¸‹èµ¤å¡š';
      console.log('âœ… ä¸‹èµ¤å¡šåº—ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ»æ—§ãƒ‘ã‚¹ä½¿ç”¨ï¼‰');
      console.log('   window.currentStoreId:', window.currentStoreId);
      
      // âš ï¸ è­¦å‘Šï¼šstoreãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒãªã„å ´åˆ
      console.warn('âš ï¸ URLã«storeãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
      console.warn('   ä»–ã®åº—èˆ—ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¦‹ã‚‹å ´åˆã¯ã€æ­£ã—ã„URLã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„');
      console.warn('   ä¾‹: menu.html?store=åº—èˆ—ID&table=ãƒ†ãƒ¼ãƒ–ãƒ«å');
    }
    
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('ğŸ“Œ menu.htmlåˆæœŸåŒ–å®Œäº†');
    console.log('   åº—èˆ—ID:', window.currentStoreId);
    console.log('   åº—èˆ—å:', currentStoreName);
    console.log('   ãƒ†ãƒ¼ãƒ–ãƒ«:', urlParams.get('table'));
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    // ğŸ†• åº—èˆ—åˆ¥ãƒ˜ãƒƒãƒ€ç”»åƒã‚’èª­ã¿è¾¼ã‚€
    async function loadStoreHeaderImage() {
      if (!currentStoreId) {
        console.log('   ä¸‹èµ¤å¡šåº—: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ˜ãƒƒãƒ€ç”»åƒã‚’ä½¿ç”¨');
        return;
      }
      
      try {
        const storeDocRef = doc(db, 'stores', currentStoreId);
        const storeDoc = await getDoc(storeDocRef);
        
        if (storeDoc.exists()) {
          const storeData = storeDoc.data();
          console.log('   åº—èˆ—ãƒ‡ãƒ¼ã‚¿å–å¾—:', storeData.storeName);
          
          // ãƒ˜ãƒƒãƒ€ç”»åƒã‚’è¨­å®š
          if (storeData.headerImageUrl) {
            const headerImg = document.querySelector('.header img');
            if (headerImg) {
              headerImg.src = storeData.headerImageUrl;
              console.log('   âœ… ãƒ˜ãƒƒãƒ€ç”»åƒã‚’è¨­å®š:', storeData.headerImageUrl);
            }
          }
          
          // ğŸ†• èƒŒæ™¯ç”»åƒã‚’è¨­å®š
          if (storeData.backgroundImageUrl) {
            document.body.style.backgroundImage = `url('${storeData.backgroundImageUrl}')`;
            document.body.style.backgroundSize = 'cover';
            document.body.style.backgroundPosition = 'center';
            document.body.style.backgroundAttachment = 'fixed';
            document.body.style.backgroundRepeat = 'no-repeat';
            console.log('   âœ… èƒŒæ™¯ç”»åƒã‚’è¨­å®š:', storeData.backgroundImageUrl);
          }
          
          // åº—èˆ—åã‚‚æ›´æ–°
          if (storeData.storeName) {
            currentStoreName = storeData.storeName;
            const headerAlt = document.querySelector('.header img');
            if (headerAlt) {
              headerAlt.alt = `ç²‰ã‚‚ã‚“å±‹ å…« ${storeData.storeName}`;
            }
            console.log('   âœ… åº—èˆ—åã‚’æ›´æ–°:', currentStoreName);
          }
        }
      } catch (error) {
        console.error('   ãƒ˜ãƒƒãƒ€ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å¾Œã«ãƒ˜ãƒƒãƒ€ç”»åƒã‚’è¨­å®š
    window.addEventListener('DOMContentLoaded', loadStoreHeaderImage);


    let cart = [];
    let currentItem = null;
    let selectedToppings = [];
    let qty = 1;
    let allMenuItems = [];
    let soldOutIds = new Set();
    let currentOrderId = null;
    let orderStatusUnsubscribe = null;
    let bagQuantity = 0;
    let bagNeeded = false;
    const BAG_PRICE = 3;
    
    // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š
    let tableSettings = null;
    
    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®š
    let menuSettings = {
      showMemoField: false, // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯éè¡¨ç¤º
      showNameField: false,
      showPostalCodeField: false,
      showAddressField: false,
      showEmailField: false, // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¬„
      showPhoneField: false, // é›»è©±ç•ªå·æ¬„
      nameRequired: false,
      postalCodeRequired: false,
      addressRequired: false,
      emailRequired: false, // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¿…é ˆã«ã™ã‚‹
      phoneRequired: false, // é›»è©±ç•ªå·ã‚’å¿…é ˆã«ã™ã‚‹
      statusMessage: '',
      warningMessage: ''
    };
    
    // ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ï¼‰
    let alertSettings = {
      completeMessage: 'å•†å“ãŒå‡ºæ¥ä¸ŠãŒã‚Šã¾ã—ãŸï¼\n\næ³¨æ–‡ç•ªå· #{orderNumber}\n\nç”»é¢ã®æ³¨æ–‡ç•ªå·ã‚’åº—å“¡ã«ãŠè¦‹ã›ãã ã•ã„',
      cancelMessage: 'æ³¨æ–‡ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ\n\næ³¨æ–‡ç•ªå· #{orderNumber}\n\nç•ªå·ã‚’ãŠå‘¼ã³ã—ã¾ã—ãŸãŒã”ä¸åœ¨ã§ã—ãŸã®ã§\næ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã›ã¦é ‚ãã¾ã—ãŸ'
    };
    
    // äºŒé‡é€ä¿¡é˜²æ­¢ç”¨ãƒ•ãƒ©ã‚°
    let isOrderProcessing = false;
    let lastOrderTimestamp = 0;
    const ORDER_COOLDOWN = 3000; // 3ç§’é–“ã®ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
    
    const tableNumber = urlParams.get('table') || 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ';

    // LocalStorageã‹ã‚‰æ³¨æ–‡æƒ…å ±ã‚’å¾©å…ƒ
    function restoreOrderFromStorage() {
      const savedOrder = localStorage.getItem('currentOrder_' + tableNumber);
      if (savedOrder) {
        try {
          const orderData = JSON.parse(savedOrder);
          console.log('ğŸ“¦ æ³¨æ–‡æƒ…å ±ã‚’å¾©å…ƒ:', orderData);
          
          // æ³¨æ–‡æƒ…å ±ã‚’ç”»é¢ã«è¡¨ç¤º
          document.getElementById('order-num').textContent = orderData.orderNumber;
          document.getElementById('waiting').textContent = orderData.myPosition;
          document.getElementById('order-total').textContent = 'Â¥' + orderData.totalAmount.toLocaleString();
          document.getElementById('eat-style').textContent = orderData.tableNumber;
          
          const list = document.getElementById('order-items');
          list.innerHTML = '';
          orderData.items.forEach(item => {
            const subtotal = (item.price + item.toppingPrice) * item.quantity;
            const div = document.createElement('div');
            div.className = 'cart-item';
            div.innerHTML = `
              <div class="cart-item-header">
                <div class="cart-item-name">${item.name}</div>
                <div class="cart-item-price">Â¥${subtotal.toLocaleString()}</div>
              </div>
              <div class="cart-item-details">æ•°é‡: ${item.quantity}å€‹</div>
              <div class="cart-item-details" style="color: #4CAF50;">ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${item.toppings}</div>
            `;
            list.appendChild(div);
          });
          
          if (orderData.bagNeeded && orderData.bagQuantity > 0) {
            const bagDiv = document.createElement('div');
            bagDiv.className = 'cart-item';
            bagDiv.innerHTML = `
              <div class="cart-item-header">
                <div class="cart-item-name">ğŸ›ï¸ ãƒ¬ã‚¸è¢‹</div>
                <div class="cart-item-price">Â¥${orderData.bagPrice.toLocaleString()}</div>
              </div>
              <div class="cart-item-details">æ•°é‡: ${orderData.bagQuantity}æš</div>
            `;
            list.appendChild(bagDiv);
          }
          
          currentOrderId = orderData.orderId;
          
          // æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ç›£è¦–ã‚’å†é–‹
          if (currentOrderId) {
            watchOrderStatus(currentOrderId);
          }
          
          // å®Œäº†ãƒšãƒ¼ã‚¸ã‚’è¡¨ç¤º
          document.getElementById('page-menu').classList.add('hidden');
          document.getElementById('page-topping').classList.add('hidden');
          document.getElementById('page-cart').classList.add('hidden');
          document.getElementById('page-complete').classList.remove('hidden');
          
          return true;
        } catch (e) {
          console.error('âŒ æ³¨æ–‡æƒ…å ±ã®å¾©å…ƒã‚¨ãƒ©ãƒ¼:', e);
          localStorage.removeItem('currentOrder_' + tableNumber);
        }
      }
      return false;
    }

    // æ³¨æ–‡æƒ…å ±ã‚’LocalStorageã«ä¿å­˜
    function saveOrderToStorage(orderData) {
      try {
        localStorage.setItem('currentOrder_' + tableNumber, JSON.stringify(orderData));
        console.log('ğŸ’¾ æ³¨æ–‡æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', orderData);
      } catch (e) {
        console.error('âŒ æ³¨æ–‡æƒ…å ±ã®ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    // æ³¨æ–‡å®Œäº†æ™‚ã«LocalStorageã‚’ã‚¯ãƒªã‚¢
    function clearOrderFromStorage() {
      localStorage.removeItem('currentOrder_' + tableNumber);
      console.log('ğŸ—‘ï¸ æ³¨æ–‡æƒ…å ±ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
    }

    // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šã‚’èª­ã¿è¾¼ã¿
    async function loadMenuSettings() {
      try {
        // ğŸ”§ ä¿®æ­£: currentStoreIdãŒnullãªã‚‰æ—§ãƒ‘ã‚¹ã‚’ä½¿ç”¨
        console.log('ğŸ½ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­... åº—èˆ—ID:', currentStoreId);
        
        // currentStoreIdãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ stores/{storeId}/menu_settings/default
        // nullã®å ´åˆã¯ menu_settings/shimoakatsukaï¼ˆæ—§ãƒ‘ã‚¹ï¼‰
        const menuSettingsRef = currentStoreId ? 
          doc(db, 'stores', currentStoreId, 'menu_settings', 'default') : 
          doc(db, 'menu_settings', 'shimoakatsuka');
        const menuSettingsDoc = await getDoc(menuSettingsRef);
        
        if (menuSettingsDoc.exists()) {
          menuSettings = menuSettingsDoc.data();
          console.log('âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', menuSettings);
        } else {
          console.log('âš ï¸ ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
          
          // ä¸‹èµ¤å¡šåº—ï¼ˆcurrentStoreId = nullï¼‰ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§è¡¨ç¤º
          if (!currentStoreId) {
            menuSettings = {
              showMemoField: true,
              showNameField: false,
              showPostalCodeField: false,
              showAddressField: false,
              showEmailField: false,
              showPhoneField: false,
              nameRequired: false,
              postalCodeRequired: false,
              addressRequired: false,
              emailRequired: false,
              phoneRequired: false,
              statusMessage: 'ã“ã®ç•ªå·ã§ãŠå‘¼ã³ã—ã¾ã™ã®ã§\nå•†å“ã‚’å—ã‘å–ã‚‹ã¾ã§\nã“ã®ç”»é¢ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„',
              warningMessage: 'âš ï¸ é‡è¦ãªãŠçŸ¥ã‚‰ã›\n\nâ€¢ å¸­ã‚’å¤–ã™éš›ã«ã¯å…ˆã«\nãŠä¼šè¨ˆã‚’æ¸ˆã¾ã›ã¦ãã ã•ã„\n\nâ€¢ ç•ªå·ã‚’ãŠå‘¼ã³ã—ã¦ã‚‚æœªä¼šè¨ˆã®ã¾ã¾å¸­ã‚’å¤–ã•ã‚Œã¾ã™ã¨æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¨ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™'
            };
            console.log('âœ… ä¸‹èµ¤å¡šåº—ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’é©ç”¨ã—ã¾ã—ãŸ');
          }
        }
        
        // ãƒ¡ãƒ¢æ¬„ã®è¡¨ç¤º/éè¡¨ç¤º
        const memoSection = document.getElementById('memo-section');
        if (memoSection) {
          memoSection.style.display = menuSettings.showMemoField ? 'block' : 'none';
        }
        
        // åå‰æ¬„ã®è¡¨ç¤º/éè¡¨ç¤º
        const nameSection = document.getElementById('name-section');
        const nameRequiredMark = document.getElementById('name-required-mark');
        if (nameSection) {
          nameSection.style.display = menuSettings.showNameField ? 'block' : 'none';
          if (nameRequiredMark) {
            nameRequiredMark.style.display = menuSettings.nameRequired ? 'inline' : 'none';
          }
        }
        
        // éƒµä¾¿ç•ªå·æ¬„ã®è¡¨ç¤º/éè¡¨ç¤º
        const postalCodeSection = document.getElementById('postal-code-section');
        const postalCodeRequiredMark = document.getElementById('postal-code-required-mark');
        if (postalCodeSection) {
          postalCodeSection.style.display = menuSettings.showPostalCodeField ? 'block' : 'none';
          if (postalCodeRequiredMark) {
            postalCodeRequiredMark.style.display = menuSettings.postalCodeRequired ? 'inline' : 'none';
          }
        }
        
        // ä½æ‰€æ¬„ã®è¡¨ç¤º/éè¡¨ç¤º
        const addressSection = document.getElementById('address-section');
        const addressRequiredMark = document.getElementById('address-required-mark');
        if (addressSection) {
          addressSection.style.display = menuSettings.showAddressField ? 'block' : 'none';
          if (addressRequiredMark) {
            addressRequiredMark.style.display = menuSettings.addressRequired ? 'inline' : 'none';
          }
        }
        
        // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹æ¬„ã®è¡¨ç¤º/éè¡¨ç¤º
        const emailSection = document.getElementById('email-section');
        const emailRequiredMark = document.getElementById('email-required-mark');
        if (emailSection) {
          emailSection.style.display = menuSettings.showEmailField ? 'block' : 'none';
          if (emailRequiredMark) {
            emailRequiredMark.style.display = menuSettings.emailRequired ? 'inline' : 'none';
          }
        }
        
        // é›»è©±ç•ªå·æ¬„ã®è¡¨ç¤º/éè¡¨ç¤º
        const phoneSection = document.getElementById('phone-section');
        const phoneRequiredMark = document.getElementById('phone-required-mark');
        if (phoneSection) {
          phoneSection.style.display = menuSettings.showPhoneField ? 'block' : 'none';
          if (phoneRequiredMark) {
            phoneRequiredMark.style.display = menuSettings.phoneRequired ? 'inline' : 'none';
          }
        }
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¨­å®š
        const statusMessageElement = document.getElementById('status-message');
        if (statusMessageElement && menuSettings.statusMessage && menuSettings.statusMessage.trim()) {
          statusMessageElement.innerHTML = menuSettings.statusMessage.replace(/\n/g, '<br>');
          statusMessageElement.style.display = 'block';
        } else if (statusMessageElement) {
          statusMessageElement.style.display = 'none';
        }
        
        // è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¨­å®š
        const warningMessageElement = document.getElementById('warning-message');
        if (warningMessageElement && menuSettings.warningMessage && menuSettings.warningMessage.trim()) {
          warningMessageElement.innerHTML = menuSettings.warningMessage.replace(/\n/g, '<br>');
          warningMessageElement.style.display = 'block';
        } else if (warningMessageElement) {
          warningMessageElement.style.display = 'none';
        }
      } catch (error) {
        console.error('âŒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        // ã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯ä¸‹èµ¤å¡šåº—ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’ä½¿ç”¨
        const storeId = currentStoreId || 'shimoakatsuka';
        if (storeId === 'shimoakatsuka') {
          menuSettings = {
            showMemoField: true,
            showNameField: false,
            showPostalCodeField: false,
            showAddressField: false,
            showEmailField: false,
            showPhoneField: false,
            nameRequired: false,
            postalCodeRequired: false,
            addressRequired: false,
            emailRequired: false,
            phoneRequired: false,
            statusMessage: 'ã“ã®ç•ªå·ã§ãŠå‘¼ã³ã—ã¾ã™ã®ã§\nå•†å“ã‚’å—ã‘å–ã‚‹ã¾ã§\nã“ã®ç”»é¢ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„',
            warningMessage: 'âš ï¸ é‡è¦ãªãŠçŸ¥ã‚‰ã›\n\nâ€¢ å¸­ã‚’å¤–ã™éš›ã«ã¯å…ˆã«\nãŠä¼šè¨ˆã‚’æ¸ˆã¾ã›ã¦ãã ã•ã„\n\nâ€¢ ç•ªå·ã‚’ãŠå‘¼ã³ã—ã¦ã‚‚æœªä¼šè¨ˆã®ã¾ã¾å¸­ã‚’å¤–ã•ã‚Œã¾ã™ã¨æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¨ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™'
          };
          
          // ãƒ¡ãƒ¢æ¬„ã‚’è¡¨ç¤º
          const memoSection = document.getElementById('memo-section');
          if (memoSection) {
            memoSection.style.display = 'block';
          }
          
          // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          const statusMessageElement = document.getElementById('status-message');
          if (statusMessageElement) {
            statusMessageElement.innerHTML = menuSettings.statusMessage.replace(/\n/g, '<br>');
            statusMessageElement.style.display = 'block';
          }
          
          const warningMessageElement = document.getElementById('warning-message');
          if (warningMessageElement) {
            warningMessageElement.innerHTML = menuSettings.warningMessage.replace(/\n/g, '<br>');
            warningMessageElement.style.display = 'block';
          }
        }
      }
    }

    // ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã¿
    async function loadAlertSettings() {
      try {
        console.log('ğŸ”” ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã¿ä¸­... åº—èˆ—ID:', currentStoreId);
        
        const alertSettingsRef = currentStoreId ? 
          doc(db, 'stores', currentStoreId, 'alert_settings', 'default') : 
          doc(db, 'alert_settings', 'shimoakatsuka');
        const alertSettingsDoc = await getDoc(alertSettingsRef);
        
        if (alertSettingsDoc.exists()) {
          alertSettings = alertSettingsDoc.data();
          console.log('âœ… ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', alertSettings);
        } else {
          console.log('âš ï¸ ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
        }
      } catch (error) {
        console.error('âŒ ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šèª­ã¿è¾¼ã¿
    async function loadTableSettings(tableNumber) {
      try {
        const settingsDoc = await getDoc(doc(db, 'stores', currentStoreId, 'tableSettings', tableNumber));
        if (settingsDoc.exists()) {
          tableSettings = settingsDoc.data();
          console.log('âœ… ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', tableSettings);
        } else {
          tableSettings = {
            inputFields: {
              name: { visible: false, required: false },
              phone: { visible: false, required: false },
              postalCode: { visible: false, required: false },
              address: { visible: false, required: false },
              email: { visible: false, required: false },
              pickupTime: { visible: false, required: false },
              notes: { visible: true, required: false }
            },
            menuType: 'default',
            customMenuItems: []
          };
          console.log('â„¹ï¸ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã‚’ä½¿ç”¨ã—ã¾ã™');
        }
      } catch (e) {
        console.error('âŒ ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        tableSettings = {
          inputFields: { notes: { visible: true, required: false } },
          menuType: 'default',
          customMenuItems: []
        };
      }
    }
    
    // ğŸ†• å¼•å–æ™‚é–“è¨ˆç®—
    function getPickupTimeOptions() {
      const now = new Date();
      const options = [];
      
      const time30 = new Date(now.getTime() + 30 * 60 * 1000);
      options.push({ value: '30min', label: `30åˆ†å¾Œï¼ˆ${formatTime(time30)}ï¼‰`, time: formatTime(time30) });
      
      const time60 = new Date(now.getTime() + 60 * 60 * 1000);
      options.push({ value: '60min', label: `1æ™‚é–“å¾Œï¼ˆ${formatTime(time60)}ï¼‰`, time: formatTime(time60) });
      
      const time90 = new Date(now.getTime() + 90 * 60 * 1000);
      options.push({ value: '90min', label: `1æ™‚é–“30åˆ†å¾Œï¼ˆ${formatTime(time90)}ï¼‰`, time: formatTime(time90) });
      
      const time120 = new Date(now.getTime() + 120 * 60 * 1000);
      options.push({ value: '120min', label: `2æ™‚é–“å¾Œï¼ˆ${formatTime(time120)}ï¼‰`, time: formatTime(time120) });
      
      options.push({ value: 'other', label: 'ãã®ä»–ï¼ˆå‚™è€ƒæ¬„ã«è¨˜å…¥ï¼‰', time: 'ãã®ä»–' });
      
      return options;
    }
    
    function formatTime(date) {
      const hours = String(date.getHours()).padStart(2, '0');
      const minutes = String(date.getMinutes()).padStart(2, '0');
      return `${hours}:${minutes}`;
    }

    window.onload = async function() {
      console.log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿é–‹å§‹');
      
      // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚’èª­ã¿è¾¼ã¿
      if (tableNumber) {
        await loadTableSettings(tableNumber);
      }
      
      // ã¾ãšæ³¨æ–‡æƒ…å ±ã®å¾©å…ƒã‚’è©¦ã¿ã‚‹ï¼ˆå–¶æ¥­æ™‚é–“å¤–ã§ã‚‚æ³¨æ–‡ç•ªå·ç”»é¢ã¯è¡¨ç¤ºï¼‰
      const hasStoredOrder = localStorage.getItem('currentOrder_' + tableNumber);
      
      // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã€ãƒ†ãƒ¼ãƒ–ãƒ«ã®å­˜åœ¨ç¢ºèª
      if (tableNumber && tableNumber !== 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ' && tableNumber !== 'å³ä¼šè¨ˆ') {
        try {
          const tablesSnapshot = await getDocs(window.getStoreCollection('tables'));
          let tableExists = false;
          let tableMemoEnabled = false;
          
          tablesSnapshot.forEach(doc => {
            const data = doc.data();
            if (data.name === tableNumber) {
              tableExists = true;
              tableMemoEnabled = data.memoEnabled;
            }
          });
          
          if (!tableExists) {
            // ä¿å­˜ã•ã‚ŒãŸæ³¨æ–‡ãŒã‚ã‚‹å ´åˆã¯ã€ãã‚Œã‚’è¡¨ç¤ºï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«ãŒå‰Šé™¤ã•ã‚Œã¦ã„ã¦ã‚‚ï¼‰
            if (hasStoredOrder) {
              console.log('âš ï¸ ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å‰Šé™¤ã•ã‚Œã¦ã„ã¾ã™ãŒã€ä¿å­˜ã•ã‚ŒãŸæ³¨æ–‡ã‚’è¡¨ç¤ºã—ã¾ã™');
              // åˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰æ³¨æ–‡ã‚’å¾©å…ƒ
              try {
                await loadAllData();
                await updateTopWaitingCount();
                watchSoldOutItems();
                const restored = restoreOrderFromStorage();
                if (restored) {
                  console.log('âœ… ä¿å­˜ã•ã‚ŒãŸæ³¨æ–‡ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤æ¸ˆã¿ï¼‰');
                  return;
                }
              } catch (e) {
                console.error('æ³¨æ–‡å¾©å…ƒã‚¨ãƒ©ãƒ¼:', e);
              }
            }
            
            // ä¿å­˜ã•ã‚ŒãŸæ³¨æ–‡ã‚‚ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼ç”»é¢ã‚’è¡¨ç¤º
            document.body.innerHTML = `
              <div style="
                display: flex;
                align-items: center;
                justify-content: center;
                min-height: 100vh;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                text-align: center;
                padding: 20px;
                font-family: sans-serif;
              ">
                <div style="
                  background: rgba(255, 255, 255, 0.1);
                  padding: 40px;
                  border-radius: 20px;
                  backdrop-filter: blur(10px);
                  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                  max-width: 400px;
                ">
                  <h1 style="font-size: 48px; margin: 0 0 20px 0;">âš ï¸</h1>
                  <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">ã“ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã¯å­˜åœ¨ã—ã¾ã›ã‚“</p>
                  <p style="font-size: 18px; line-height: 1.8; margin: 20px 0;">
                    ãƒ†ãƒ¼ãƒ–ãƒ«ã€Œ${tableNumber}ã€ã¯<br>
                    å‰Šé™¤ã•ã‚ŒãŸã‹ã€<br>
                    å­˜åœ¨ã—ã¾ã›ã‚“
                  </p>
                  <p style="font-size: 16px; margin: 10px 0; opacity: 0.8;">
                    åº—èˆ—ã‚¹ã‚¿ãƒƒãƒ•ã«ãŠå£°ãŒã‘ãã ã•ã„
                  </p>
                </div>
              </div>
            `;
            return;
          }
          
          // ãƒ¡ãƒ¢æ©Ÿèƒ½ã¯å¸¸ã«è¡¨ç¤ºï¼ˆmemoEnabledã«é–¢ä¿‚ãªãï¼‰
          console.log(`âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ã€Œ${tableNumber}ã€ã‚’ç¢ºèªã—ã¾ã—ãŸï¼ˆãƒ¡ãƒ¢æ©Ÿèƒ½: å¸¸æ™‚è¡¨ç¤ºï¼‰`);
          
        } catch (error) {
          console.error('ãƒ†ãƒ¼ãƒ–ãƒ«æ¤œè¨¼ã‚¨ãƒ©ãƒ¼:', error);
        }
      }
      
      // å–¶æ¥­æ™‚é–“ãƒã‚§ãƒƒã‚¯
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const currentTime = hours * 60 + minutes; // åˆ†å˜ä½ã«å¤‰æ›
      
      const hasTableParam = urlParams.get('table');
      let closedStartTime, closedEndTime, operatingHours;
      
      // ğŸ†• æ™‚é–“å¤–è§£é™¤è¨­å®šã‚’ç¢ºèª
      let timeOverrideEnabled = false;
      try {
        const settingsRef = await getDoc(window.getStoreDoc('settings', 'timeOverride'));
        timeOverrideEnabled = settingsRef.exists() ? settingsRef.data().enabled : false;
        console.log('æ™‚é–“å¤–è§£é™¤è¨­å®š:', timeOverrideEnabled);
      } catch (e) {
        console.error('æ™‚é–“å¤–è§£é™¤è¨­å®šã®èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }
      
      if (hasTableParam) {
        // menu.html?table=ã®å ´åˆï¼š22:00-11:00ãŒå–¶æ¥­æ™‚é–“å¤–
        closedStartTime = 22 * 60; // 22:00 = 1320åˆ†
        closedEndTime = 11 * 60;   // 11:00 = 660åˆ†
        operatingHours = '11:00 - 22:00';
      } else {
        // menu.htmlã®ã¿ã®å ´åˆï¼š22:30-11:00ãŒå–¶æ¥­æ™‚é–“å¤–
        closedStartTime = 22 * 60 + 30; // 22:30 = 1350åˆ†
        closedEndTime = 11 * 60;        // 11:00 = 660åˆ†
        operatingHours = '11:00 - 22:30';
      }
      
      // å–¶æ¥­æ™‚é–“å¤–åˆ¤å®šï¼ˆ22:00/22:30ä»¥é™ ã¾ãŸã¯ 11:00ã‚ˆã‚Šå‰ï¼‰
      // ğŸ†• æ™‚é–“å¤–è§£é™¤ãŒæœ‰åŠ¹ãªå ´åˆã¯å–¶æ¥­ä¸­ã¨ã—ã¦æ‰±ã†
      const isClosed = timeOverrideEnabled ? false : (currentTime >= closedStartTime || currentTime < closedEndTime);
      
      if (isClosed) {
        console.log('å–¶æ¥­æ™‚é–“å¤–');
        
        // ä¿å­˜ã•ã‚ŒãŸæ³¨æ–‡ãŒã‚ã‚‹å ´åˆã¯ã€ãã‚Œã‚’è¡¨ç¤ºï¼ˆå–¶æ¥­æ™‚é–“å¤–ã§ã‚‚ï¼‰
        if (hasStoredOrder) {
          console.log('âš ï¸ å–¶æ¥­æ™‚é–“å¤–ã§ã™ãŒã€ä¿å­˜ã•ã‚ŒãŸæ³¨æ–‡ã‚’è¡¨ç¤ºã—ã¾ã™');
          // åˆæœŸåŒ–ã‚’å®Ÿè¡Œã—ã¦ã‹ã‚‰æ³¨æ–‡ã‚’å¾©å…ƒ
          try {
            await loadAllData();
            await updateTopWaitingCount();
            watchSoldOutItems();
            const restored = restoreOrderFromStorage();
            if (restored) {
              console.log('âœ… ä¿å­˜ã•ã‚ŒãŸæ³¨æ–‡ã‚’å¾©å…ƒã—ã¾ã—ãŸï¼ˆå–¶æ¥­æ™‚é–“å¤–ï¼‰');
              return;
            }
          } catch (e) {
            console.error('æ³¨æ–‡å¾©å…ƒã‚¨ãƒ©ãƒ¼:', e);
          }
        }
        
        // ä¿å­˜ã•ã‚ŒãŸæ³¨æ–‡ã‚‚ãªã„å ´åˆã¯å–¶æ¥­æ™‚é–“å¤–ç”»é¢ã‚’è¡¨ç¤º
        // ã™ã¹ã¦ã®ãƒšãƒ¼ã‚¸ã‚’éè¡¨ç¤º
        document.getElementById('page-menu').style.display = 'none';
        document.getElementById('page-topping').style.display = 'none';
        document.getElementById('page-cart').style.display = 'none';
        document.getElementById('page-complete').style.display = 'none';
        
        // å–¶æ¥­æ™‚é–“å¤–ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        document.body.innerHTML = `
          <div style="
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-align: center;
            padding: 20px;
            font-family: sans-serif;
          ">
            <div style="
              background: rgba(255, 255, 255, 0.1);
              padding: 40px;
              border-radius: 20px;
              backdrop-filter: blur(10px);
              box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
              max-width: 400px;
            ">
              <h1 style="font-size: 48px; margin: 0 0 20px 0;">ğŸ•</h1>
              <p style="font-size: 24px; font-weight: bold; margin: 10px 0;">æ³¨æ–‡å¯èƒ½æ™‚é–“å¤–ã§ã™</p>
              <p style="font-size: 20px; line-height: 1.8; margin: 20px 0;">æ³¨æ–‡å¯èƒ½æ™‚é–“<br>${operatingHours}</p>
              <p style="font-size: 18px; margin: 10px 0;">ç¾åœ¨ã¯ã”æ³¨æ–‡ã‚’<br>æ‰¿ã£ã¦ãŠã‚Šã¾ã›ã‚“</p>
            </div>
          </div>
        `;
        return;
      }
      
      try {
        await loadAllData();
        await loadMenuSettings(); // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šã‚’èª­ã¿è¾¼ã¿
        await loadAlertSettings(); // ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã¿
        await updateTopWaitingCount();
        setInterval(updateTopWaitingCount, 20000); // ğŸš€ 10ç§’â†’20ç§’ã«è»½é‡åŒ–
        watchSoldOutItems();
        
        // settingsã®å¤‰æ›´ã‚’ç›£è¦–ï¼ˆæ‰‹å‹•ã‚«ã‚¦ãƒ³ãƒˆã®å¤‰æ›´ã‚’åæ˜ ï¼‰
        onSnapshot(window.getStoreCollection('settings'), () => {
          updateTopWaitingCount().catch(e => console.error('å¾…ã¡äººæ•°æ›´æ–°ã‚¨ãƒ©ãƒ¼:', e));
        });
        
        console.log('åˆæœŸåŒ–å®Œäº†');
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«æ³¨æ–‡æƒ…å ±ã‚’å¾©å…ƒï¼ˆåˆæœŸåŒ–å¾Œã«å®Ÿè¡Œï¼‰
        const restored = restoreOrderFromStorage();
        if (restored) {
          console.log('âœ… ä¿å­˜ã•ã‚ŒãŸæ³¨æ–‡ã‚’å¾©å…ƒã—ã¾ã—ãŸ');
        }
      } catch (e) {
        console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', e);
        alert('åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    };

    // æ³¨æ–‡ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç›£è¦–
    let allOrdersUnsubscribe = null;
    
    function watchOrderStatus(orderId) {
      if (orderStatusUnsubscribe) {
        orderStatusUnsubscribe();
      }
      
      currentOrderId = orderId;
      const orderRef = window.getStoreDoc('orders', orderId);
      
      orderStatusUnsubscribe = onSnapshot(orderRef, async (docSnap) => {
        if (!docSnap.exists()) {
          console.log('âš ï¸ æ³¨æ–‡ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼ˆç‰©ç†å‰Šé™¤ï¼‰');
          clearOrderFromStorage();
          currentOrderId = null;
          // å³åº§ã«ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆãªã—ï¼‰
          window.location.reload();
          return;
        }
        
        const data = docSnap.data();
        
        // deletedãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã‚‹å ´åˆã‚‚å‰Šé™¤ã¨ã—ã¦æ‰±ã†
        if (data.deleted) {
          console.log('âš ï¸ æ³¨æ–‡ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸï¼ˆè«–ç†å‰Šé™¤ï¼‰');
          clearOrderFromStorage();
          currentOrderId = null;
          // å³åº§ã«ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¢ãƒ©ãƒ¼ãƒˆãªã—ï¼‰
          window.location.reload();
          return;
        }
        
        updateOrderStatusDisplay(data);
        
        // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå¤‰æ›´ã•ã‚ŒãŸã‚‰ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤º
        if (data.completedAt && !data.notifiedComplete) {
          // ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºï¼ˆ#{orderNumber}ã‚’å®Ÿéš›ã®æ³¨æ–‡ç•ªå·ã«ç½®æ›ï¼‰
          const message = alertSettings.completeMessage.replace(/#{orderNumber}/g, data.orderNumber);
          showCustomAlert(message);
          
          // é€šçŸ¥æ¸ˆã¿ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹ï¼ˆæ¬¡å›ã®ç›£è¦–ã§å†åº¦é€šçŸ¥ã—ãªã„ã‚ˆã†ã«ï¼‰
          updateDoc(orderRef, { notifiedComplete: true }).catch(e => console.error(e));
        }
        
        if (data.cancelledAt && !data.notifiedCancel) {
          // ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºï¼ˆ#{orderNumber}ã‚’å®Ÿéš›ã®æ³¨æ–‡ç•ªå·ã«ç½®æ›ï¼‰
          const message = alertSettings.cancelMessage.replace(/#{orderNumber}/g, data.orderNumber);
          showCustomAlert(message);
          
          updateDoc(orderRef, { notifiedCancel: true }).catch(e => console.error(e));
        }
      });
      
      // å…¨ã¦ã®æ³¨æ–‡ã‚’ç›£è¦–ã—ã¦é †ç•ªã‚’æ›´æ–°
      if (allOrdersUnsubscribe) {
        allOrdersUnsubscribe();
      }
      
      const ordersRef = window.getStoreCollection('orders');
      allOrdersUnsubscribe = onSnapshot(ordersRef, async (snapshot) => {
        // å¾…ã¡äººæ•°ã‚’æ›´æ–°
        await updateTopWaitingCount();
        
        const orderSnap = await getDoc(orderRef);
        if (orderSnap.exists()) {
          const currentData = orderSnap.data();
          await updateMyPosition(currentData, snapshot);
        }
      });
    }

    // è‡ªåˆ†ã®é †ç•ªã‚’è¨ˆç®—ã—ã¦æ›´æ–°
    async function updateMyPosition(currentOrderData, ordersSnapshot = null) {
      if (currentOrderData.deleted || currentOrderData.cancelledAt || currentOrderData.completedAt) {
        // å‰Šé™¤ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã€ã¾ãŸã¯å®Œäº†æ¸ˆã¿ã®å ´åˆã¯è¨ˆç®—ä¸è¦
        return;
      }
      
      try {
        const now = new Date();
        
        // snapshotãŒæ¸¡ã•ã‚Œã¦ã„ãªã„å ´åˆã¯å–å¾—
        if (!ordersSnapshot) {
          ordersSnapshot = await getDocs(window.getStoreCollection('orders'));
        }
        
        // æœ‰åŠ¹ãªæ³¨æ–‡ï¼ˆæœªå‰Šé™¤ãƒ»æœªã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒ»æœªå®Œäº†ãƒ»å‰Šé™¤äºˆå®šæ™‚åˆ»å‰ï¼‰ã‚’æŠ½å‡º
        const validOrders = [];
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.deleteAt && 
              data.deleteAt.toDate() > now && 
              !data.deleted && 
              !data.cancelledAt &&
              !data.completedAt) {  // âœ… å®Œäº†æ¸ˆã¿ã‚‚é™¤å¤–
            validOrders.push({
              orderNumber: data.orderNumber,
              timestamp: data.timestamp
            });
          }
        });
        
        // æ³¨æ–‡ç•ªå·ã§ã‚½ãƒ¼ãƒˆ
        validOrders.sort((a, b) => a.orderNumber - b.orderNumber);
        
        // è‡ªåˆ†ã®é †ç•ªã‚’è¨ˆç®—ï¼ˆé€šå¸¸ã®é †ç•ª+1ï¼‰
        const myIndex = validOrders.findIndex(order => order.orderNumber === currentOrderData.orderNumber);
        if (myIndex !== -1) {
          const myPosition = myIndex + 1 + 1; // é€šå¸¸ã®é †ç•ªã«+1
          
          // å¾…ã¡é †ç•ªè¡¨ç¤ºã‚’æ›´æ–°
          const waitingElement = document.getElementById('waiting');
          if (waitingElement) {
            waitingElement.textContent = myPosition;
            console.log('é †ç•ªæ›´æ–°:', myPosition, '/', validOrders.length);
          }
        }
      } catch (error) {
        console.error('é †ç•ªè¨ˆç®—ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    // æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®æ›´æ–°
    function updateOrderStatusDisplay(orderData) {
      const statusBox = document.getElementById('order-status');
      if (!statusBox) return;
      
      // å¾…ã¡é †ç•ªã®è¡¨ç¤ºè¦ç´ ã‚’å–å¾—
      const waitingElement = document.getElementById('waiting');
      
      if (orderData.deleted) {
        // å‰Šé™¤æ¸ˆã¿ã®å ´åˆã¯LocalStorageã‚’ã‚¯ãƒªã‚¢
        clearOrderFromStorage();
      } else if (orderData.completedAt) {
        statusBox.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
        statusBox.style.borderColor = '#4CAF50';
        statusBox.style.color = 'white';
        statusBox.innerHTML = 'âœ… å•†å“ãŒå‡ºæ¥ä¸ŠãŒã‚Šã¾ã—ãŸ!<br>ç”»é¢ã®æ³¨æ–‡ç•ªå·ã‚’åº—å“¡ã«ãŠè¦‹ã›ãã ã•ã„';
        // å®Œäº†æ™‚ã¯1ç•ªç›®ã«å¤‰æ›´
        if (waitingElement) {
          waitingElement.textContent = '1';
        }
      } else if (orderData.cancelledAt) {
        statusBox.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
        statusBox.style.borderColor = '#f44336';
        statusBox.style.color = 'white';
        statusBox.innerHTML = 'âŒ æ³¨æ–‡ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ<br>ç•ªå·ã‚’ãŠå‘¼ã³ã—ã¾ã—ãŸãŒã”ä¸åœ¨ã§ã—ãŸã®ã§<br>æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã›ã¦é ‚ãã¾ã—ãŸ';
        // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã‚‚1ç•ªç›®ã«å¤‰æ›´
        if (waitingElement) {
          waitingElement.textContent = '1';
        }
        // LocalStorageã‚’ã‚¯ãƒªã‚¢
        clearOrderFromStorage();
      } else if (orderData.paidAt) {
        statusBox.style.background = 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)';
        statusBox.style.borderColor = '#2196F3';
        statusBox.style.color = 'white';
        statusBox.innerHTML = ' ãŠä¼šè¨ˆå®Œäº†<br>å•†å“ãŒå‡ºæ¥ä¸ŠãŒã‚Šã¾ã—ãŸã‚‰ãŠå‘¼ã³ã—ã¾ã™<br>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„';
        // myPositionãŒã‚ã‚Œã°ãã‚Œã‚’è¡¨ç¤º
        if (waitingElement && orderData.myPosition) {
          waitingElement.textContent = orderData.myPosition;
        }
      } else {
        statusBox.style.background = 'linear-gradient(135deg, #a8edea 0%, #89d4cf 100%)';
        statusBox.style.borderColor = '#89d4cf';
        statusBox.style.color = '#000';
        statusBox.innerHTML = 'â³ ãŸã ä»Šæº–å‚™ã—ã¦ã„ã¾ã™ã€<br>ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„';
        // myPositionãŒã‚ã‚Œã°ãã‚Œã‚’è¡¨ç¤º
        if (waitingElement && orderData.myPosition) {
          waitingElement.textContent = orderData.myPosition;
        }
      }
    }

    function watchSoldOutItems() {
      // controller.htmlã¨åŒã˜å½¢å¼ã§sold_outã‚’ç›£è¦–
      const soldOutRef = collection(db, 'sold_out');
      
      onSnapshot(soldOutRef, (snapshot) => {
        soldOutIds.clear();
        snapshot.forEach(doc => {
          soldOutIds.add(doc.data().menuId);
        });
        
        // applyTimeBasedSoldOut(); // ğŸ”´ è‡ªå‹•å“åˆ‡ã‚Œè¨­å®šã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
        updateSoldOutDisplay();
      });
    }
    
    function updateSoldOutDisplay() {
      const menuItems = document.querySelectorAll('.menu-item');
      menuItems.forEach(item => {
        const menuId = item.dataset.menuId;
        if (soldOutIds.has(menuId)) {
          item.classList.add('sold-out');
          item.onclick = () => {
            showCustomAlert('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\nã“ã®å•†å“ã¯ç¾åœ¨å“åˆ‡ã‚Œã§ã™ã€‚');
          };
        } else {
          item.classList.remove('sold-out');
          const itemData = allMenuItems.find(i => i.id === menuId);
          if (itemData) {
            item.onclick = () => selectItem(itemData);
          }
        }
      });
    }

    async function updateTopWaitingCount() {
      try {
        const ordersSnapshot = await getDocs(window.getStoreCollection('orders'));
        const now = new Date();
        const validOrders = new Set();
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          
          // å‰Šé™¤æ¸ˆã¿ã®æ³¨æ–‡ã¯é™¤å¤–
          if (data.deleted) return;
          
          // å®Œäº†æ¸ˆã¿ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿ã¯é™¤å¤–
          if (data.completedAt || data.cancelledAt) return;
          
          // deleteAtãŒã‚ã‚‹å ´åˆã€å‰Šé™¤äºˆå®šæ™‚åˆ»ã‚’éãã¦ã„ãŸã‚‰é™¤å¤–
          if (data.deleteAt && data.deleteAt.toDate() <= now) return;
          
          // æœ‰åŠ¹ãªæ³¨æ–‡ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ
          validOrders.add(data.orderNumber);
        });
        
        const settingsSnapshot = await getDocs(window.getStoreCollection('settings'));
        let manualCount = 0;
        settingsSnapshot.forEach(doc => {
          if (doc.id === 'waiting') {
            manualCount = doc.data().manualCount || 0;
          }
        });
        
        // å¾…ã¡äººæ•° = æœ‰åŠ¹æ³¨æ–‡æ•° + æ‰‹å‹•è¿½åŠ  + 1ï¼ˆæœ€ä½1çµ„ï¼‰
        // æ³¨æ–‡ãŒ0ã®æ™‚ã¯1çµ„ã€æ³¨æ–‡ãŒ1ã¤ã‚ã‚Œã°2çµ„
        const totalWaiting = validOrders.size + manualCount + 1;
        const waitingElem = document.getElementById('top-waiting');
        if (waitingElem) {
          waitingElem.textContent = totalWaiting;
        }
        console.log('å¾…ã¡äººæ•°æ›´æ–°:', {
          æœ‰åŠ¹æ³¨æ–‡æ•°: validOrders.size,
          æ‰‹å‹•è¿½åŠ : manualCount,
          è¡¨ç¤ºå¾…ã¡äººæ•°: totalWaiting,
          è¨ˆç®—å¼: `${validOrders.size} + ${manualCount} + 1`
        });
      } catch (e) {
        console.error('å¾…ã¡äººæ•°å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    async function loadAllData() {
      try {
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('ğŸ“‚ ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹');
        console.log('   ç¾åœ¨ã®åº—èˆ—ID:', window.currentStoreId);
        console.log('   ç¾åœ¨ã®åº—èˆ—å:', currentStoreName);
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        
        const menuSnapshot = await getDocs(window.getStoreCollection('menus'));
        // POSãƒ¢ãƒ¼ãƒ‰ã®æ™‚ã¯å¸¸ã«åº—å†…ã¨ã—ã¦æ‰±ã†
        const isEatIn = window.isPOSMode ? true : (tableNumber !== 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ');
        
        console.log('ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚¢ã‚¤ãƒ†ãƒ æ•°:', menuSnapshot.size);

        const categoryInfo = new Map();

        menuSnapshot.forEach(doc => {
          const data = doc.data();
          // ğŸ”§ ä¿®æ­£: idãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„å ´åˆã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚’ä½¿ç”¨
          const itemId = data.id || doc.id;
          const category = data.category;
          
          if (!category || !itemId) return;

          const isDineInOnly = typeof data.note === 'string' && data.note.includes('åº—å†…ã®ã¿');
          const showThisItemInThisMode = isEatIn || !isDineInOnly;

          if (!categoryInfo.has(category)) {
            categoryInfo.set(category, {
              minId: itemId,
              hasTakeoutVisibleItem: showThisItemInThisMode
            });
          } else {
            const info = categoryInfo.get(category);
            if (itemId < info.minId) info.minId = itemId;
            if (showThisItemInThisMode) info.hasTakeoutVisibleItem = true;
          }
        });

        const sortedCategories = Array.from(categoryInfo.entries())
          .filter(([cat, info]) => {
            return isEatIn || info.hasTakeoutVisibleItem;
          })
          .sort((a, b) => a[1].minId.localeCompare(b[1].minId))
          .map(entry => entry[0]);

        const sel = document.getElementById('category-select');
        if (sel) {
          sel.innerHTML = "";

          const allOpt = document.createElement('option');
          allOpt.value = "all";
          allOpt.textContent = "å…¨ã¦ã®å•†å“";
          sel.appendChild(allOpt);

          sortedCategories.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            sel.appendChild(opt);
          });
        }
        
        await loadAllMenu();
      } catch (e) {
        console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    }

    async function loadAllMenu() {
      try {
        const menuSnapshot = await getDocs(window.getStoreCollection('menus'));
        const items = [];
        // POSãƒ¢ãƒ¼ãƒ‰ã®æ™‚ã¯å¸¸ã«åº—å†…ã¨ã—ã¦æ‰±ã†
        const isEatIn = window.isPOSMode ? true : (tableNumber !== 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ');
        
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          const note = data.note || '';
          
          if (!isEatIn && note.includes('åº—å†…ã®ã¿')) {
            return;
          }
          
          // ğŸ”§ ä¿®æ­£: idãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„å ´åˆã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚’ä½¿ç”¨
          items.push({
          // ğŸ”§ ä¿®æ­£: idãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒãªã„å ´åˆã¯ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆIDã‚’ä½¿ç”¨
          items.push({
            id: data.id || doc.id,
            category: data.category,
            name: data.name,
            price: data.price,
            toppingsId: data.toppingsId,
            toppingSets: data.toppingSets || [], // è¿½åŠ 
            image: data.image || '',
            note: note,
            order: data.order || 0  // ğŸ†• orderãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
          });
        });
        
        // ğŸ†• æ”¹å–„: orderãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§ã‚½ãƒ¼ãƒˆï¼ˆorderãŒãªã„å ´åˆã¯idé †ï¼‰
        items.sort((a, b) => {
          // orderãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒä¸¡æ–¹ã«ã‚ã‚‹å ´åˆã¯orderé †
          if (a.order && b.order) {
            return a.order - b.order;
          }
          // orderãŒãªã„å ´åˆã¯idé †ï¼ˆå¾“æ¥ã®å‹•ä½œï¼‰
          if (a.id < b.id) return -1;
          if (a.id > b.id) return 1;
          return 0;
        });
        
        // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã«ã‚ˆã‚‹ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        let filteredItems = items;
        if (tableSettings && tableSettings.menuType === 'custom' && tableSettings.customMenuItems) {
          const allowedIds = new Set(tableSettings.customMenuItems);
          filteredItems = items.filter(item => {
            const itemId = item.id || item.name;
            return allowedIds.has(itemId);
          });
          console.log('ğŸ¯ ã‚«ã‚¹ã‚¿ãƒ ãƒ¡ãƒ‹ãƒ¥ãƒ¼é©ç”¨: ', filteredItems.length, '/', items.length, 'ä»¶');
        }
        
        allMenuItems = filteredItems;
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿å®Œäº†');
        console.log('   ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¡¨ç¤ºã‚¢ã‚¤ãƒ†ãƒ æ•°:', filteredItems.length);
        console.log('   åº—èˆ—ID:', window.currentStoreId);
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        displayMenuItems(filteredItems);
        await loadSoldOutItems();
      } catch (e) {
        console.error('ãƒ¡ãƒ‹ãƒ¥ãƒ¼èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    async function loadSoldOutItems() {
      try {
        // controller.htmlã¨åŒã˜å½¢å¼ã§sold_outã‚’å–å¾—
        const soldOutSnapshot = await getDocs(collection(db, 'sold_out'));
        soldOutIds.clear();

        soldOutSnapshot.forEach(doc => {
          soldOutIds.add(doc.data().menuId);
        });

        // applyTimeBasedSoldOut(); // ğŸ”´ è‡ªå‹•å“åˆ‡ã‚Œè¨­å®šã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
        updateSoldOutDisplay();
      } catch (e) {
        console.error('å“åˆ‡ã‚Œæƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    function applyTimeBasedSoldOut() {
      // ğŸ”´ è‡ªå‹•å“åˆ‡ã‚Œè¨­å®šã‚’ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–
      // const now = new Date();
      // const hour = now.getHours();
      // const minute = now.getMinutes();

      // const isTakeout = tableNumber === 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ';
      // const currentTime = hour + (minute / 60);

      // let shouldSoldOut = false;

      // if (isTakeout) {
      //   shouldSoldOut = (currentTime >= 22.5 || hour < 11);
      // } else {
      //   shouldSoldOut = (hour >= 22 || hour < 11);
      // }

      // if (shouldSoldOut) {
      //   allMenuItems.forEach(item => {
      //     soldOutIds.add(item.id);
      //   });
      // }
    }

    document.addEventListener('DOMContentLoaded', function() {
      const sel = document.getElementById('category-select');
      if (sel) {
        sel.addEventListener('change', function() {
          if (this.value === '' || this.value === 'all') {
            displayMenuItems(allMenuItems);
          } else {
            const filtered = allMenuItems.filter(item => item.category === this.value);
            displayMenuItems(filtered);
          }
          setTimeout(() => {
            loadSoldOutItems();
          }, 100);
        });
      }
    });

    function displayMenuItems(items) {
      const list = document.getElementById('menu-list');
      if (!list) return;
      
      list.innerHTML = '';
      
      if (!items || items.length === 0) {
        list.innerHTML = '<div style="text-align:center;color:#666;padding:40px;">å•†å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
        return;
      }
      
      console.log('è¡¨ç¤ºã™ã‚‹å•†å“æ•°:', items.length);
      
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'menu-item';
        div.dataset.menuId = item.id;
        
        let imageHtml = '';
        if (item.image) {
          const imageSrc = item.image.includes('http') ? item.image : `./${item.image}`;
          imageHtml = `<img src="${imageSrc}" class="menu-item-image" loading="lazy" onerror="this.style.display='none'">`;
        }
        
        div.innerHTML = `
          ${imageHtml}
          <div class="menu-item-content">
            <div class="menu-item-name">${item.name}</div>
            <div class="menu-item-price">Â¥${item.price.toLocaleString()}</div>
            ${item.note ? `<div class="menu-item-note">${item.note}</div>` : ''}
          </div>
        `;
        div.onclick = () => selectItem(item);
        list.appendChild(div);
      });
    }

    async function selectItem(item) {
      if (soldOutIds.has(item.id)) {
        showCustomAlert('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\nã“ã®å•†å“ã¯ç¾åœ¨å“åˆ‡ã‚Œã§ã™ã€‚');
        return;
      }
      
      console.log('ğŸ” é¸æŠã•ã‚ŒãŸå•†å“:', {
        name: item.name,
        toppingsId: item.toppingsId,
        toppingsIdType: typeof item.toppingsId,
        toppingsIdLength: item.toppingsId ? item.toppingsId.length : 0
      });
      
      currentItem = item;
      selectedToppings = [];  // ğŸ†• ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’ã‚¯ãƒªã‚¢ï¼ˆæ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°çŠ¶æ…‹ï¼‰
      qty = 1;
      
      document.getElementById('item-info').innerHTML = `
        <div class="menu-item-name" style="font-size: 20px;">${item.name}</div>
        <div class="menu-item-price" style="font-size: 24px; margin-top: 10px;">Â¥${item.price.toLocaleString()}</div>
      `;
      
      // ãƒˆãƒƒãƒ”ãƒ³ã‚°IDãŒç©ºã¾ãŸã¯å­˜åœ¨ã—ãªã„å ´åˆã§ã‚‚ã€æ•°é‡é¸æŠç”»é¢ã‚’è¡¨ç¤º
      if (!item.toppingsId || item.toppingsId.trim() === '') {
        console.log('âœ… ãƒˆãƒƒãƒ”ãƒ³ã‚°ãªã—ã®å•†å“: æ•°é‡é¸æŠç”»é¢ã‚’è¡¨ç¤º');
        
        // ãƒˆãƒƒãƒ”ãƒ³ã‚°ãƒªã‚¹ãƒˆã‚’ç©ºã«ã—ã¦æ•°é‡é¸æŠã®ã¿è¡¨ç¤º
        const list = document.getElementById('topping-list');
        list.innerHTML = '<div style="text-align:center;color:#666;padding:20px;"></div>';
        
        updateSubtotal();
        showPage('page-topping');
        return;
      }
      
      // toppingSetsã‚’å„ªå…ˆçš„ã«ä½¿ç”¨
      if (item.toppingSets && item.toppingSets.length > 0) {
        console.log('âœ… toppingSetsã‚’ä½¿ç”¨:', item.toppingSets);
        
        const list = document.getElementById('topping-list');
        list.innerHTML = '';
        
        // å„ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆã‚’è¡¨ç¤º
        item.toppingSets.forEach((set, setIndex) => {
          // ã‚»ãƒƒãƒˆã®ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ1åˆ—ã§å¤§ããè¡¨ç¤ºï¼‰
          const setHeader = document.createElement('div');
          setHeader.className = 'topping-set-header';
          setHeader.textContent = set.name + (set.type === 'single' ? ' ï¼ˆ1ã¤é¸æŠï¼‰' : ' ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰');
          list.appendChild(setHeader);
          
          // ã‚»ãƒƒãƒˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ç”¨ã®ã‚°ãƒªãƒƒãƒ‰ã‚³ãƒ³ãƒ†ãƒŠï¼ˆ2åˆ—è¡¨ç¤ºï¼‰
          const gridContainer = document.createElement('div');
          gridContainer.className = 'topping-set-grid';
          
          // ã‚»ãƒƒãƒˆã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³
          set.options.forEach((option, optionIndex) => {
            const div = document.createElement('div');
            div.className = 'topping-item';
            div.setAttribute('data-set-index', setIndex);
            div.setAttribute('data-option-index', optionIndex);
            div.setAttribute('data-set-type', set.type);
            div.innerHTML = `
              <span>${option.name}</span>
              <span style="color: #4CAF50; font-weight: bold;">${option.price > 0 ? '+Â¥' + option.price.toLocaleString() : 'ç„¡æ–™'}</span>
            `;
            
            div.onclick = () => {
              if (set.type === 'single') {
                // å˜ä¸€é¸æŠï¼šåŒã˜ã‚»ãƒƒãƒˆå†…ã®ä»–ã®é¸æŠã‚’è§£é™¤
                document.querySelectorAll(`.topping-item[data-set-index="${setIndex}"]`).forEach(item => {
                  item.classList.remove('selected');
                });
                div.classList.add('selected');
                
                // åŒã˜ã‚»ãƒƒãƒˆã®ä»–ã®é¸æŠã‚’å‰Šé™¤
                selectedToppings = selectedToppings.filter(t => t.setIndex !== setIndex);
                selectedToppings.push({
                  setIndex: setIndex,
                  setName: set.name,
                  optionIndex: optionIndex,
                  name: option.name,
                  price: option.price,
                  id: `${setIndex}-${optionIndex}`
                });
              } else {
                // è¤‡æ•°é¸æŠï¼šãƒˆã‚°ãƒ«
                div.classList.toggle('selected');
                const idx = selectedToppings.findIndex(t => t.setIndex === setIndex && t.optionIndex === optionIndex);
                if (idx > -1) {
                  selectedToppings.splice(idx, 1);
                } else {
                  selectedToppings.push({
                    setIndex: setIndex,
                    setName: set.name,
                    optionIndex: optionIndex,
                    name: option.name,
                    price: option.price,
                    id: `${setIndex}-${optionIndex}`
                  });
                }
              }
              updateSubtotal();
            };
            gridContainer.appendChild(div);
          });
          
          list.appendChild(gridContainer);
        });
      } else if (item.toppingsId) {
        // å¾Œæ–¹äº’æ›æ€§: å¤ã„toppingsIdå½¢å¼
        console.log('âš ï¸ å¤ã„toppingsIdå½¢å¼ã‚’ä½¿ç”¨');
        
        const toppingIds = item.toppingsId.split(',').map(id => id.trim());
        const toppingsSnapshot = await getDocs(window.getStoreCollection('toppings'));
        const toppings = [];
        const seenIds = new Set();
        
        toppingsSnapshot.forEach(doc => {
          const data = doc.data();
          if (toppingIds.includes(data.id) && !seenIds.has(data.id)) {
            toppings.push({
              ...data,
              order: data.order || 99
            });
            seenIds.add(data.id);
          }
        });
        
        toppings.sort((a, b) => a.order - b.order);
        
        const list = document.getElementById('topping-list');
        list.innerHTML = '';
        
        // æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°ã®ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ1åˆ—ã§å¤§ããè¡¨ç¤ºï¼‰
        const standardHeader = document.createElement('div');
        standardHeader.className = 'topping-set-header';
        standardHeader.textContent = 'ãƒˆãƒƒãƒ”ãƒ³ã‚° ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰';
        list.appendChild(standardHeader);
        
        // æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°ç”¨ã®ã‚°ãƒªãƒƒãƒ‰ã‚³ãƒ³ãƒ†ãƒŠ
        const standardGrid = document.createElement('div');
        standardGrid.className = 'topping-set-grid';
        
        // æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é¸æŠçŠ¶æ…‹ï¼‰
        const standardDiv = document.createElement('div');
        standardDiv.className = 'topping-item selected';
        standardDiv.id = 'standard-topping';
        standardDiv.innerHTML = `
          <span>æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°</span>
          <span style="color: #4CAF50; font-weight: bold;">ç„¡æ–™</span>
        `;
        standardDiv.onclick = () => {
          // æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’é¸æŠã—ãŸã‚‰ä»–ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’å…¨ã¦è§£é™¤
          document.querySelectorAll('.topping-item').forEach(item => {
            item.classList.remove('selected');
          });
          standardDiv.classList.add('selected');
          selectedToppings = [];
          updateSubtotal();
        };
        standardGrid.appendChild(standardDiv);
        
        if (toppings.length > 0) {
          toppings.forEach(t => {
            const div = document.createElement('div');
            div.className = 'topping-item';
            div.innerHTML = `
              <span>${t.name}</span>
              <span style="color: #4CAF50; font-weight: bold;">${t.price > 0 ? '+Â¥' + t.price.toLocaleString() : 'ç„¡æ–™'}</span>
            `;
            div.onclick = () => {
              // ä»–ã®ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’é¸æŠã—ãŸã‚‰æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’è§£é™¤
              document.getElementById('standard-topping').classList.remove('selected');
              
              div.classList.toggle('selected');
              const idx = selectedToppings.findIndex(x => x.id === t.id);
              if (idx > -1) selectedToppings.splice(idx, 1);
              else selectedToppings.push(t);
              updateSubtotal();
            };
            standardGrid.appendChild(div);
          });
        }
        
        list.appendChild(standardGrid);
      } else {
        document.getElementById('topping-list').innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ãƒˆãƒƒãƒ”ãƒ³ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      }
      
      document.getElementById('qty').textContent = '1';
      
      updateSubtotal();
      showPage('page-topping');
      window.scrollTo(0, 0);
    }

    window.changeQty = function(d) {
      qty = Math.max(1, qty + d);
      document.getElementById('qty').textContent = qty;
      updateSubtotal();
    };

    function updateSubtotal() {
      let total = currentItem.price;
      selectedToppings.forEach(t => total += t.price || 0);
      document.getElementById('subtotal').textContent = 'Â¥' + (total * qty).toLocaleString();
    }
    
    // ğŸ”Š ãƒ¬ã‚¸éŸ³ã‚’å†ç”Ÿã™ã‚‹é–¢æ•°
    function playBeepSound() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        // AudioContextã‚’å†é–‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ã®è‡ªå‹•å†ç”Ÿãƒãƒªã‚·ãƒ¼å¯¾ç­–ï¼‰
        if (audioContext.state === 'suspended') {
          audioContext.resume();
        }
        
        // 2å›ã®ãƒ“ãƒ¼ãƒ—éŸ³ï¼ˆãƒ”ãƒƒãƒ”ãƒƒï¼‰
        const beep = (frequency, startTime, duration) => {
          const oscillator = audioContext.createOscillator();
          const gainNode = audioContext.createGain();
          
          oscillator.connect(gainNode);
          gainNode.connect(audioContext.destination);
          
          oscillator.frequency.value = frequency;
          oscillator.type = 'sine';
          
          gainNode.gain.setValueAtTime(0.2, startTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, startTime + duration);
          
          oscillator.start(startTime);
          oscillator.stop(startTime + duration);
        };
        
        const now = audioContext.currentTime;
        beep(2000, now + 0.05, 0.08);
        beep(2000, now + 0.20, 0.08);
        
        console.log('ğŸ”Š ãƒ¬ã‚¸éŸ³å†ç”Ÿ');
      } catch (e) {
        console.error('ğŸ”‡ éŸ³å£°å†ç”Ÿã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    window.addToCart = async function() {
      if (soldOutIds.has(currentItem.id)) {
        showCustomAlert('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\nã“ã®å•†å“ã¯ç¾åœ¨å“åˆ‡ã‚Œã«ãªã‚Šã¾ã—ãŸã€‚');
        backToMenu();
        return;
      }
      
      let toppingPrice = 0;
      
      // ğŸ†• ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚»ãƒƒãƒˆæƒ…å ±ã‚’å«ã‚ãŸæ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿
      const toppingsData = selectedToppings.map(t => {
        toppingPrice += t.price || 0;
        return {
          setName: t.setName || 'ãƒˆãƒƒãƒ”ãƒ³ã‚°',
          name: t.name,
          price: t.price || 0
        };
      });
      
      // è¡¨ç¤ºç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
      const toppingNames = selectedToppings.map(t => t.name).join(', ') || 'æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°';
      
      // ã‚«ãƒ†ã‚´ãƒªãŒã€ŒåŒ…æã€ã®å ´åˆã¯ç¨ç‡ã‚’10%ã«å¼·åˆ¶è¨­å®š
      // ãã‚Œä»¥å¤–ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è¨­å®šã‚’ä½¿ç”¨
      // ãŸã ã—ã€Firestoreã¯undefinedã‚’å—ã‘ä»˜ã‘ãªã„ãŸã‚ã€æœªè¨­å®šã®å ´åˆã¯nullã‚’è¨­å®š
      let effectiveTaxRate;
      if (currentItem.category === 'åŒ…æ') {
        effectiveTaxRate = 10;
      } else if (currentItem.taxRate !== undefined && currentItem.taxRate !== null) {
        effectiveTaxRate = currentItem.taxRate;
      } else {
        effectiveTaxRate = null; // undefinedã§ã¯ãªãnullã‚’è¨­å®š
      }
      
      const item = {
        id: currentItem.id,
        name: currentItem.name,
        price: currentItem.price,
        category: currentItem.category,  // ã‚«ãƒ†ã‚´ãƒªã‚’è¿½åŠ 
        taxRate: effectiveTaxRate,
        toppings: toppingNames, // è¡¨ç¤ºç”¨ï¼ˆå¾Œæ–¹äº’æ›æ€§ï¼‰
        toppingsData: toppingsData, // ğŸ†• æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿
        toppingPrice: toppingPrice,
        quantity: qty
      };
      
      // POSãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’é€ä¿¡
      if (window.isPOSMode && window.parent !== window) {
        console.log('ğŸ“¤ POSãƒ¢ãƒ¼ãƒ‰: è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«å•†å“ã‚’é€ä¿¡', item);
        
        // ğŸ”Š è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã«éŸ³å†ç”Ÿã‚’ä¾é ¼
        window.parent.postMessage({
          type: 'playBeep'
        }, window.location.origin);
        
        window.parent.postMessage({
          type: 'addToCart',
          item: item
        }, window.location.origin);
        
        // å•†å“è¿½åŠ å®Œäº†
        backToMenu();
        return;
      }
      
      // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: ã‚«ãƒ¼ãƒˆã«è¿½åŠ 
      // ğŸ”Š ãƒ¬ã‚¸éŸ³ã‚’å†ç”Ÿ
      playBeepSound();
      
      cart.push(item);
      
      backToMenu();
    };

    window.backToMenu = function() {
      showPage('page-menu');
      updateCartButton();
      window.scrollTo(0, 0);
    };

    window.continueShopping = function() {
      backToMenu();
    };

    function updateCartButton() {
      const btn = document.getElementById('cart-btn');
      if (cart.length > 0) {
        btn.style.display = 'block';
        btn.textContent = `ã‚«ãƒ¼ãƒˆã‚’è¦‹ã‚‹ (${cart.length}ç‚¹)`;
        btn.onclick = showCart;
      } else {
        btn.style.display = 'none';
      }
    }

    window.showCart = function() {
      if (cart.length === 0) {
        showCustomAlert('ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™');
        return;
      }
      
      const list = document.getElementById('cart-items');
      list.innerHTML = '';
      let total = 0;
      let hasSoldOut = false;
      
      cart.forEach((item, index) => {
        const subtotal = (item.price + item.toppingPrice) * item.quantity;
        total += subtotal;
        const div = document.createElement('div');
        div.className = 'cart-item';
        
        if (soldOutIds.has(item.id)) {
          div.classList.add('sold-out');
          hasSoldOut = true;
        }
        
        // ãƒˆãƒƒãƒ”ãƒ³ã‚°è¡¨ç¤ºã®æ”¹å–„
        let toppingsHtml = '';
        if (item.toppingsData && item.toppingsData.length > 0) {
          const groupedBySet = {};
          item.toppingsData.forEach(topping => {
            const setName = topping.setName || 'ãƒˆãƒƒãƒ”ãƒ³ã‚°';
            if (!groupedBySet[setName]) {
              groupedBySet[setName] = [];
            }
            groupedBySet[setName].push(topping.name);
          });
          
          toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
            return `
              <div class="cart-item-details" style="color: #4CAF50; font-weight: bold; margin-top: 5px;">${setName}:</div>
              ${options.map(opt => `<div class="cart-item-details" style="color: #4CAF50; margin-left: 10px;">ãƒ»${opt}</div>`).join('')}
            `;
          }).join('');
        } else if (item.toppings && item.toppings !== 'æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°') {
          toppingsHtml = `<div class="cart-item-details" style="color: #4CAF50;">ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${item.toppings}</div>`;
        }
        
        div.innerHTML = `
          <button class="cart-item-delete-btn" onclick="removeFromCart(${index})">Ã—</button>
          <div class="cart-item-header">
            <div class="cart-item-name">${item.name}</div>
            <div class="cart-item-price">Â¥${subtotal.toLocaleString()}</div>
          </div>
          <div class="cart-item-details">
            å˜ä¾¡: Â¥${item.price.toLocaleString()} Ã— ${item.quantity}å€‹
          </div>
          ${toppingsHtml}
        `;
        list.appendChild(div);
      });
      
      if (hasSoldOut) {
        const warning = document.createElement('div');
        warning.className = 'warning-box';
        warning.style.marginBottom = '15px';
        warning.innerHTML = 'âš ï¸ å“åˆ‡ã‚Œå•†å“ãŒå«ã¾ã‚Œã¦ã„ã¾ã™<br>æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹å‰ã«å‰Šé™¤ã•ã‚Œã¾ã™';
        list.insertBefore(warning, list.firstChild);
      }
      
      // ãƒ¬ã‚¸è¢‹ä»£ã‚’åŠ ç®—
      const bagTotal = bagNeeded ? bagQuantity * BAG_PRICE : 0;
      const finalTotal = total + bagTotal;
      
      document.getElementById('cart-total').textContent = 'Â¥' + finalTotal.toLocaleString();
      
      // ğŸ†• ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã«åŸºã¥ã„ã¦å…¥åŠ›æ¬„ã‚’è¡¨ç¤º/éè¡¨ç¤º
      if (tableSettings) {
        const fields = tableSettings.inputFields;
        
        // ãŠåå‰
        const nameSection = document.getElementById('name-section');
        const nameRequired = document.getElementById('name-required-mark');
        if (fields.name?.visible) {
          nameSection.style.display = 'block';
          nameRequired.style.display = fields.name.required ? 'inline' : 'none';
        } else {
          nameSection.style.display = 'none';
        }
        
        // é›»è©±ç•ªå·
        const phoneSection = document.getElementById('phone-section');
        const phoneRequired = document.getElementById('phone-required-mark');
        if (fields.phone?.visible) {
          phoneSection.style.display = 'block';
          phoneRequired.style.display = fields.phone.required ? 'inline' : 'none';
        } else {
          phoneSection.style.display = 'none';
        }
        
        // å¼•å–æ™‚é–“
        const pickupTimeSection = document.getElementById('pickup-time-section');
        const pickupTimeRequired = document.getElementById('pickup-time-required-mark');
        if (fields.pickupTime?.visible) {
          pickupTimeSection.style.display = 'block';
          pickupTimeRequired.style.display = fields.pickupTime.required ? 'inline' : 'none';
          
          // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚’ç”Ÿæˆ
          const select = document.getElementById('customer-pickup-time');
          select.innerHTML = '<option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>';
          const options = getPickupTimeOptions();
          options.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.label;
            option.dataset.time = opt.time;
            select.appendChild(option);
          });
        } else {
          pickupTimeSection.style.display = 'none';
        }
        
        // éƒµä¾¿ç•ªå·
        const postalCodeSection = document.getElementById('postal-code-section');
        const postalCodeRequired = document.getElementById('postal-code-required-mark');
        if (fields.postalCode?.visible) {
          postalCodeSection.style.display = 'block';
          postalCodeRequired.style.display = fields.postalCode.required ? 'inline' : 'none';
        } else {
          postalCodeSection.style.display = 'none';
        }
        
        // ä½æ‰€
        const addressSection = document.getElementById('address-section');
        const addressRequired = document.getElementById('address-required-mark');
        if (fields.address?.visible) {
          addressSection.style.display = 'block';
          addressRequired.style.display = fields.address.required ? 'inline' : 'none';
        } else {
          addressSection.style.display = 'none';
        }
        
        // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
        const emailSection = document.getElementById('email-section');
        const emailRequired = document.getElementById('email-required-mark');
        if (fields.email?.visible) {
          emailSection.style.display = 'block';
          emailRequired.style.display = fields.email.required ? 'inline' : 'none';
        } else {
          emailSection.style.display = 'none';
        }
        
        // å‚™è€ƒæ¬„ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
        document.getElementById('memo-section').style.display = 'block';
      } else {
        // ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šãŒãªã„å ´åˆã¯ã™ã¹ã¦éè¡¨ç¤º
        document.getElementById('name-section').style.display = 'none';
        document.getElementById('phone-section').style.display = 'none';
        document.getElementById('pickup-time-section').style.display = 'none';
        document.getElementById('postal-code-section').style.display = 'none';
        document.getElementById('address-section').style.display = 'none';
        document.getElementById('email-section').style.display = 'none';
        document.getElementById('memo-section').style.display = 'block';
      }
      
      showPage('page-cart');
    };
    
    // ãƒ¬ã‚¸è¢‹é¸æŠ
    window.selectBagOption = function(option) {
      bagNeeded = (option === 'needed');
      
      document.getElementById('bag-not-needed').classList.remove('selected');
      document.getElementById('bag-needed').classList.remove('selected');
      
      if (bagNeeded) {
        document.getElementById('bag-needed').classList.add('selected');
        document.getElementById('bag-needed').style.background = '#e8f5e9';
        document.getElementById('bag-needed').style.borderColor = '#4CAF50';
        document.getElementById('bag-needed').style.color = '#4CAF50';
        document.getElementById('bag-not-needed').style.background = 'white';
        document.getElementById('bag-not-needed').style.borderColor = '#e0e0e0';
        document.getElementById('bag-not-needed').style.color = '#666';
        document.getElementById('bag-quantity-section').classList.remove('hidden');
        if (bagQuantity === 0) {
          bagQuantity = 1;
          updateBagDisplay();
        }
      } else {
        document.getElementById('bag-not-needed').classList.add('selected');
        document.getElementById('bag-not-needed').style.background = '#e8f5e9';
        document.getElementById('bag-not-needed').style.borderColor = '#4CAF50';
        document.getElementById('bag-not-needed').style.color = '#4CAF50';
        document.getElementById('bag-needed').style.background = 'white';
        document.getElementById('bag-needed').style.borderColor = '#e0e0e0';
        document.getElementById('bag-needed').style.color = '#666';
        document.getElementById('bag-quantity-section').classList.add('hidden');
        bagQuantity = 0;
        updateBagDisplay();
      }
    };
    
    // ãƒ¬ã‚¸è¢‹æšæ•°å¤‰æ›´
    window.changeBagQuantity = function(delta) {
      bagQuantity = Math.max(0, bagQuantity + delta);
      updateBagDisplay();
    };
    
    // ãƒ¬ã‚¸è¢‹è¡¨ç¤ºæ›´æ–°
    function updateBagDisplay() {
      document.getElementById('bag-quantity').textContent = bagQuantity;
      document.getElementById('bag-price').textContent = 'Â¥' + (bagQuantity * BAG_PRICE).toLocaleString();
      
      // åˆè¨ˆé‡‘é¡ã‚’å†è¨ˆç®—
      let total = 0;
      cart.forEach(item => {
        total += (item.price + item.toppingPrice) * item.quantity;
      });
      const bagTotal = bagNeeded ? bagQuantity * BAG_PRICE : 0;
      const finalTotal = total + bagTotal;
      document.getElementById('cart-total').textContent = 'Â¥' + finalTotal.toLocaleString();
    }
    
    window.removeFromCart = function(index) {
      cart.splice(index, 1);
      if (cart.length === 0) {
        showCustomAlert('ã‚«ãƒ¼ãƒˆãŒç©ºã«ãªã‚Šã¾ã—ãŸ');
        backToMenu();
      } else {
        showCart();
      }
      updateCartButton();
    };

    window.confirmOrder = async function() {
      // ========== äºŒé‡é€ä¿¡é˜²æ­¢ ==========
      // æ—¢ã«å‡¦ç†ä¸­ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
      if (isOrderProcessing) {
        console.log('âš ï¸ æ³¨æ–‡å‡¦ç†ä¸­ã®ãŸã‚ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç„¡è¦–ã—ã¾ã™');
        return;
      }
      
      // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æœŸé–“ä¸­ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
      const now = Date.now();
      if (now - lastOrderTimestamp < ORDER_COOLDOWN) {
        console.log('âš ï¸ ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³æœŸé–“ä¸­ã®ãŸã‚ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ç„¡è¦–ã—ã¾ã™');
        showCustomAlert('æ³¨æ–‡ã‚’é€ä¿¡ä¸­ã§ã™ã€‚\nã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
        return;
      }
      
      // ========== ã‚«ãƒ¼ãƒˆã®å³å¯†ãªãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ ==========
      if (!cart || cart.length === 0) {
        showCustomAlert('ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™');
        return;
      }
      
      // ã‚«ãƒ¼ãƒˆå†…ã®å•†å“ãŒæœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
      let hasValidItems = false;
      for (const item of cart) {
        if (item && item.name && item.price >= 0 && item.quantity > 0) {
          hasValidItems = true;
          break;
        }
      }
      
      if (!hasValidItems) {
        showCustomAlert('ã‚«ãƒ¼ãƒˆã«æœ‰åŠ¹ãªå•†å“ãŒã‚ã‚Šã¾ã›ã‚“');
        cart = []; // ç„¡åŠ¹ãªã‚«ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
        backToMenu();
        return;
      }
      
      // ========== å¿…é ˆé …ç›®ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šï¼‰ ==========
      if (tableSettings && tableSettings.inputFields) {
        const fields = tableSettings.inputFields;
        
        // ãŠåå‰
        if (fields.name?.visible && fields.name?.required) {
          const customerName = document.getElementById('customer-name')?.value.trim();
          if (!customerName) {
            showCustomAlert('ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            isOrderProcessing = false;
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.style.opacity = '1';
              confirmBtn.style.cursor = 'pointer';
              confirmBtn.textContent = 'æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹';
            }
            return;
          }
        }
        
        // é›»è©±ç•ªå·
        if (fields.phone?.visible && fields.phone?.required) {
          const customerPhone = document.getElementById('customer-phone')?.value.trim();
          if (!customerPhone) {
            showCustomAlert('é›»è©±ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            isOrderProcessing = false;
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.style.opacity = '1';
              confirmBtn.style.cursor = 'pointer';
              confirmBtn.textContent = 'æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹';
            }
            return;
          }
        }
        
        // å¼•å–æ™‚é–“
        if (fields.pickupTime?.visible && fields.pickupTime?.required) {
          const pickupTime = document.getElementById('customer-pickup-time')?.value;
          if (!pickupTime) {
            showCustomAlert('å¼•å–æ™‚é–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
            isOrderProcessing = false;
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.style.opacity = '1';
              confirmBtn.style.cursor = 'pointer';
              confirmBtn.textContent = 'æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹';
            }
            return;
          }
        }
        
        // éƒµä¾¿ç•ªå·
        if (fields.postalCode?.visible && fields.postalCode?.required) {
          const customerPostalCode = document.getElementById('customer-postal-code')?.value.trim();
          if (!customerPostalCode) {
            showCustomAlert('éƒµä¾¿ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            isOrderProcessing = false;
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.style.opacity = '1';
              confirmBtn.style.cursor = 'pointer';
              confirmBtn.textContent = 'æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹';
            }
            return;
          }
        }
        
        // ä½æ‰€
        if (fields.address?.visible && fields.address?.required) {
          const customerAddress = document.getElementById('customer-address')?.value.trim();
          if (!customerAddress) {
            showCustomAlert('ä½æ‰€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            isOrderProcessing = false;
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.style.opacity = '1';
              confirmBtn.style.cursor = 'pointer';
              confirmBtn.textContent = 'æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹';
            }
            return;
          }
        }
        
        // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
        if (fields.email?.visible && fields.email?.required) {
          const customerEmail = document.getElementById('customer-email')?.value.trim();
          if (!customerEmail) {
            showCustomAlert('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            isOrderProcessing = false;
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.style.opacity = '1';
              confirmBtn.style.cursor = 'pointer';
              confirmBtn.textContent = 'æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹';
            }
            return;
          }
          const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          if (!emailPattern.test(customerEmail)) {
            showCustomAlert('æ­£ã—ã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            isOrderProcessing = false;
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.style.opacity = '1';
              confirmBtn.style.cursor = 'pointer';
              confirmBtn.textContent = 'æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹';
            }
            return;
          }
        }
      } else {
        // æ—§ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
        if (menuSettings.showNameField && menuSettings.nameRequired) {
          const customerName = document.getElementById('customer-name')?.value.trim();
          if (!customerName) {
            showCustomAlert('ãŠåå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            isOrderProcessing = false;
            if (confirmBtn) {
              confirmBtn.disabled = false;
              confirmBtn.style.opacity = '1';
              confirmBtn.style.cursor = 'pointer';
              confirmBtn.textContent = 'æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹';
            }
            return;
          }
        }
      }
      
      // å‡¦ç†ä¸­ãƒ•ãƒ©ã‚°ã‚’ONï¼ˆãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³é€šéå¾Œï¼‰
      isOrderProcessing = true;
      lastOrderTimestamp = now;
      
      // æ³¨æ–‡ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
      const confirmBtn = document.querySelector('button[onclick="confirmOrder()"]');
      if (confirmBtn) {
        confirmBtn.disabled = true;
        confirmBtn.style.opacity = '0.5';
        confirmBtn.style.cursor = 'not-allowed';
        confirmBtn.textContent = 'æ³¨æ–‡é€ä¿¡ä¸­...';
      }
      
      try {
        // å“åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯
        const soldOutItems = [];
        for (const item of cart) {
          if (soldOutIds.has(item.id)) {
            soldOutItems.push(item.name);
          }
        }
        
        if (soldOutItems.length > 0) {
          showCustomAlert('ç”³ã—è¨³ã”ã–ã„ã¾ã›ã‚“ã€‚\nä»¥ä¸‹ã®å•†å“ãŒå“åˆ‡ã‚Œã«ãªã‚Šã¾ã—ãŸ:\n\n' + soldOutItems.join('\n') + '\n\nã‚«ãƒ¼ãƒˆã‹ã‚‰å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚');
          cart = cart.filter(item => !soldOutIds.has(item.id));
          
          if (cart.length === 0) {
            showCustomAlert('å…¨ã¦ã®å•†å“ãŒå“åˆ‡ã‚Œã«ãªã£ãŸãŸã‚ã€ã‚«ãƒ¼ãƒˆãŒç©ºã«ãªã‚Šã¾ã—ãŸã€‚');
            backToMenu();
          } else {
            showCart();
          }
          return;
        }
        
        const now = new Date();
        const jstNow = new Date(now.getTime() + (9 * 60 * 60 * 1000));
        
        const todayStart = new Date(jstNow);
        todayStart.setHours(1, 0, 0, 0);
        if (jstNow < todayStart) {
          todayStart.setDate(todayStart.getDate() - 1);
        }
        
        const ordersSnapshot = await getDocs(window.getStoreCollection('orders'));
        let maxOrderNumber = 618;
        let hasActiveOrders = false;
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          
          // å‰Šé™¤ã•ã‚Œã¦ã„ãªã„æ³¨æ–‡ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
          if (!data.deleted) {
            hasActiveOrders = true;
            
            // å‰Šé™¤ã•ã‚Œã¦ã„ãªã„æ³¨æ–‡ã®ã¿ã‹ã‚‰æœ€å¤§ç•ªå·ã‚’å–å¾—
            const orderDate = data.timestamp.toDate();
            const jstOrderDate = new Date(orderDate.getTime() + (9 * 60 * 60 * 1000));
            
            if (jstOrderDate >= todayStart && data.orderNumber > maxOrderNumber) {
              maxOrderNumber = data.orderNumber;
            }
          }
        });
        
        // å‰Šé™¤ã•ã‚Œã¦ã„ãªã„æ³¨æ–‡ãŒ0ä»¶ãªã‚‰619ç•ªã‹ã‚‰é–‹å§‹
        const orderNumber = hasActiveOrders ? (maxOrderNumber + 1) : 619;
        
        console.log('æ³¨æ–‡ç•ªå·ç”Ÿæˆ:', {
          hasActiveOrders,
          maxOrderNumber,
          nextOrderNumber: orderNumber
        });
        
        // ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã‹ã©ã†ã‹åˆ¤å®š
        const isTakeout = (tableNumber === 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ');
        
        // ç¨ç‡åˆ¥ã®åˆè¨ˆã‚’è¨ˆç®—
        let tax8Total = 0;  // 8%å¯¾è±¡å•†å“ã®ç¨è¾¼åˆè¨ˆ
        let tax10Total = 0; // 10%å¯¾è±¡å•†å“ã®ç¨è¾¼åˆè¨ˆ
        let totalAmount = 0;
        
        cart.forEach(item => {
          const subtotal = (item.price + item.toppingPrice) * item.quantity;
          totalAmount += subtotal;
          
          // ç¨ç‡ã®åˆ¤å®š:
          // 1. åŒ…æã‚«ãƒ†ã‚´ãƒªã¯å¼·åˆ¶çš„ã«10%ï¼ˆã‚«ãƒ¼ãƒˆè¿½åŠ æ™‚ã«è¨­å®šæ¸ˆã¿ï¼‰
          // 2. å•†å“ã«taxRateãŒè¨­å®šã•ã‚Œã¦ã„ã‚Œã°ãã‚Œã‚’ä½¿ç”¨
          // 3. æœªè¨­å®šï¼ˆnullã¾ãŸã¯undefinedï¼‰ã®å ´åˆã¯ã€ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã¯8%ã€ã‚¤ãƒ¼ãƒˆã‚¤ãƒ³ã¯10%
          let itemTaxRate;
          if (item.taxRate !== undefined && item.taxRate !== null) {
            itemTaxRate = item.taxRate;
          } else {
            itemTaxRate = isTakeout ? 8 : 10;
          }
          
          if (itemTaxRate === 8) {
            tax8Total += subtotal;
          } else {
            tax10Total += subtotal;
          }
        });
        
        // ãƒ¬ã‚¸è¢‹ã¯å¸¸ã«10%
        const bagTotal = bagNeeded ? bagQuantity * BAG_PRICE : 0;
        totalAmount += bagTotal;
        tax10Total += bagTotal;
        
        const deleteAt = new Date(now.getTime() + 10 * 60 * 1000);
        
        // ãŠå®¢æ§˜æƒ…å ±ã‚’å–å¾—
        const customerMemo = document.getElementById('customer-memo') ? document.getElementById('customer-memo').value.trim() : '';
        const customerName = document.getElementById('customer-name') ? document.getElementById('customer-name').value.trim() : '';
        const customerPostalCode = document.getElementById('customer-postal-code') ? document.getElementById('customer-postal-code').value.trim() : '';
        const customerAddress = document.getElementById('customer-address') ? document.getElementById('customer-address').value.trim() : '';
        const customerEmail = document.getElementById('customer-email') ? document.getElementById('customer-email').value.trim() : '';
        const customerPhone = document.getElementById('customer-phone') ? document.getElementById('customer-phone').value.trim() : '';
        
        // ğŸ†• å¼•å–æ™‚é–“ã‚’å–å¾—
        let pickupTime = '';
        const pickupTimeSelect = document.getElementById('customer-pickup-time');
        if (pickupTimeSelect && pickupTimeSelect.value) {
          const selectedOption = pickupTimeSelect.options[pickupTimeSelect.selectedIndex];
          pickupTime = selectedOption.dataset.time || '';
        }
        
        const orderData = {
          orderNumber: orderNumber,
          timestamp: Timestamp.fromDate(now),
          tableNumber: tableNumber,
          items: cart,
          totalAmount: totalAmount,
          bagNeeded: bagNeeded,
          bagQuantity: bagNeeded ? bagQuantity : 0,
          bagPrice: bagTotal,
          tax8Total: tax8Total,
          tax10Total: tax10Total,
          customerMemo: customerMemo,
          customerName: customerName,
          customerPostalCode: customerPostalCode,
          customerAddress: customerAddress,
          customerEmail: customerEmail,
          customerPhone: customerPhone,
          pickupTime: pickupTime,  // ğŸ†• å¼•å–æ™‚é–“
          status: 'pending',
          deleteAt: Timestamp.fromDate(deleteAt),
          cancelledAt: null,
          completedAt: null,
          paidAt: null,
          notifiedComplete: false,
          notifiedCancel: false,
          notifiedPaid: false
        };
        
        const docRef = await addDoc(window.getStoreCollection('orders'), orderData);
        
        await updateDoc(docRef, {
          orderId: docRef.id
        });
        
        const validOrders = [];
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.deleteAt && 
              data.deleteAt.toDate() > now && 
              !data.deleted &&
              !data.cancelledAt &&
              !data.completedAt) {  // âœ… å®Œäº†æ¸ˆã¿ã‚‚é™¤å¤–
            validOrders.push(data.orderNumber);
          }
        });
        validOrders.push(orderNumber);
        validOrders.sort((a, b) => a - b);
        const myPosition = validOrders.indexOf(orderNumber);
        const displayPosition = myPosition + 1 + 1; // é€šå¸¸ã®é †ç•ªã«+1
        
        await updateDoc(docRef, {
          myPosition: displayPosition
        });
        
        document.getElementById('order-num').textContent = orderNumber;
        document.getElementById('waiting').textContent = displayPosition;
        document.getElementById('order-total').textContent = 'Â¥' + totalAmount.toLocaleString();
        document.getElementById('eat-style').textContent = tableNumber;
        
        const list = document.getElementById('order-items');
        list.innerHTML = '';
        cart.forEach(item => {
          const subtotal = (item.price + item.toppingPrice) * item.quantity;
          const div = document.createElement('div');
          div.className = 'cart-item';
          
          // ãƒˆãƒƒãƒ”ãƒ³ã‚°è¡¨ç¤ºã®æ”¹å–„
          let toppingsHtml = '';
          if (item.toppingsData && item.toppingsData.length > 0) {
            const groupedBySet = {};
            item.toppingsData.forEach(topping => {
              const setName = topping.setName || 'ãƒˆãƒƒãƒ”ãƒ³ã‚°';
              if (!groupedBySet[setName]) {
                groupedBySet[setName] = [];
              }
              groupedBySet[setName].push(topping.name);
            });
            
            toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
              return `
                <div class="cart-item-details" style="color: #4CAF50; font-weight: bold; margin-top: 5px;">${setName}:</div>
                ${options.map(opt => `<div class="cart-item-details" style="color: #4CAF50; margin-left: 10px;">ãƒ»${opt}</div>`).join('')}
              `;
            }).join('');
          } else if (item.toppings && item.toppings !== 'æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°') {
            toppingsHtml = `<div class="cart-item-details" style="color: #4CAF50;">ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${item.toppings}</div>`;
          }
          
          div.innerHTML = `
            <div class="cart-item-header">
              <div class="cart-item-name">${item.name}</div>
              <div class="cart-item-price">Â¥${subtotal.toLocaleString()}</div>
            </div>
            <div class="cart-item-details">æ•°é‡: ${item.quantity}å€‹</div>
            ${toppingsHtml}
          `;
          list.appendChild(div);
        });
        
        // ãƒ¬ã‚¸è¢‹æƒ…å ±ã‚’è¡¨ç¤º
        if (bagNeeded && bagQuantity > 0) {
          const bagDiv = document.createElement('div');
          bagDiv.className = 'cart-item';
          bagDiv.innerHTML = `
            <div class="cart-item-header">
              <div class="cart-item-name">ğŸ›ï¸ ãƒ¬ã‚¸è¢‹</div>
              <div class="cart-item-price">Â¥${bagTotal.toLocaleString()}</div>
            </div>
            <div class="cart-item-details">æ•°é‡: ${bagQuantity}æš</div>
          `;
          list.appendChild(bagDiv);
        }
        
        // æ³¨æ–‡æƒ…å ±ã‚’LocalStorageã«ä¿å­˜
        const savedOrderData = {
          orderId: docRef.id,
          orderNumber: orderNumber,
          myPosition: displayPosition,
          totalAmount: totalAmount,
          tableNumber: tableNumber,
          items: cart,
          bagNeeded: bagNeeded,
          bagQuantity: bagQuantity,
          bagPrice: bagTotal,
          tax8Total: tax8Total,
          tax10Total: tax10Total
        };
        saveOrderToStorage(savedOrderData);
        
        // æ³¨æ–‡ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç›£è¦–é–‹å§‹
        watchOrderStatus(docRef.id);
        
        cart = [];
        bagQuantity = 0;
        bagNeeded = false;
        showPage('page-complete');
        
        console.log('âœ… æ³¨æ–‡é€ä¿¡æˆåŠŸ');
        
      } catch (e) {
        console.error('âŒ æ³¨æ–‡ã‚¨ãƒ©ãƒ¼:', e);
        showCustomAlert('æ³¨æ–‡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚\n\nã‚¨ãƒ©ãƒ¼: ' + e.message);
      } finally {
        // å‡¦ç†ä¸­ãƒ•ãƒ©ã‚°ã‚’OFFï¼ˆæˆåŠŸãƒ»å¤±æ•—ã«é–¢ã‚ã‚‰ãšï¼‰
        isOrderProcessing = false;
        
        // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        const confirmBtn = document.querySelector('button[onclick="confirmOrder()"]');
        if (confirmBtn) {
          confirmBtn.disabled = false;
          confirmBtn.style.opacity = '1';
          confirmBtn.style.cursor = 'pointer';
          confirmBtn.textContent = 'æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹';
        }
      }
    };

    function showPage(id) {
      ['page-menu', 'page-topping', 'page-cart', 'page-complete'].forEach(p => {
        document.getElementById(p).classList.add('hidden');
      });
      document.getElementById(id).classList.remove('hidden');
      
      if (id === 'page-menu') {
        updateCartButton();
      }
    }

    window.callStaff = async function() {
      try {
        const callData = {
          tableNumber: tableNumber,
          timestamp: Timestamp.now(),
          type: 'call'
        };
        await addDoc(window.getStoreCollection('staff_calls'), callData);
        
        showCustomAlert('åº—å“¡ã‚’å‘¼ã³ã¾ã—ãŸ!');
      } catch (e) {
        console.error('å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', e);
        showCustomAlert('å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };
    
    window.callStaffFromComplete = async function() {
      try {
        const callData = {
          tableNumber: tableNumber,
          timestamp: Timestamp.now(),
          type: 'call'
        };
        await addDoc(window.getStoreCollection('staff_calls'), callData);
        
        showCustomAlert('åº—å“¡ã‚’å‘¼ã³ã¾ã—ãŸ!\n\næ³¨æ–‡ã®å¤‰æ›´ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãªã©\nãŠæ°—è»½ã«ãŠç”³ã—ä»˜ã‘ãã ã•ã„');
      } catch (e) {
        console.error('å‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', e);
        showCustomAlert('å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };
    
    window.requestBillFromComplete = async function() {
      try {
        const billData = {
          tableNumber: tableNumber,
          timestamp: Timestamp.now(),
          type: 'bill'
        };
        await addDoc(window.getStoreCollection('staff_calls'), billData);
        
        showCustomAlert('ãŠä¼šè¨ˆã‚’å‘¼ã³ã¾ã—ãŸ!\n\nå…ˆã«ãŠä¼šè¨ˆã‚’æ¸ˆã¾ã›ã¦ãŠãã¨\nå•†å“å—å–å¾Œã‚¹ãƒ ãƒ¼ã‚ºã«é€€åº—ã§ãã¾ã™');
      } catch (e) {
        console.error('ãŠä¼šè¨ˆã‚¨ãƒ©ãƒ¼:', e);
        showCustomAlert('ãŠä¼šè¨ˆå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };
    
    // æ–°ã—ã„æ³¨æ–‡ã‚’é–‹å§‹
    window.startNewOrder = function() {
      showCustomConfirm(
        'æ–°ã—ã„æ³¨æ–‡ã‚’é–‹å§‹ã—ã¾ã™ã‹ï¼Ÿ',
        'ç¾åœ¨ã®æ³¨æ–‡æƒ…å ±ã¯ä¿å­˜ã•ã‚ŒãŸã¾ã¾ã§ã™ã€‚',
        () => {
          // OKãŒæŠ¼ã•ã‚ŒãŸå ´åˆ
          clearOrderFromStorage();
          currentOrderId = null;
          
          cart = [];
          bagQuantity = 0;
          bagNeeded = false;
          
          document.getElementById('page-menu').classList.remove('hidden');
          document.getElementById('page-topping').classList.add('hidden');
          document.getElementById('page-cart').classList.add('hidden');
          document.getElementById('page-complete').classList.add('hidden');
          
          updateCartButton();
          showCustomAlert('æ–°ã—ã„æ³¨æ–‡ã‚’é–‹å§‹ã—ã¾ã™ï¼');
        }
      );
    };
    
    // ãƒ¬ã‚·ãƒ¼ãƒˆè¡¨ç¤º
    window.showReceipt = async function() {
      const orderNum = document.getElementById('order-num').textContent;
      const orderTotal = document.getElementById('order-total').textContent;
      const eatStyle = document.getElementById('eat-style').textContent;
      
      const now = new Date();
      const dateStr = now.getFullYear() + '/' + 
                      String(now.getMonth() + 1).padStart(2, '0') + '/' + 
                      String(now.getDate()).padStart(2, '0') + ' ' +
                      String(now.getHours()).padStart(2, '0') + ':' + 
                      String(now.getMinutes()).padStart(2, '0');
      
      // ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã¿
      let receiptStoreName = 'ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—';
      let receiptAddress = 'æ±äº¬éƒ½æ¿æ©‹åŒºèµ¤å¡š2-2-4';
      let receiptPhone = 'TEL: 03-6904-2888';
      let receiptMessage1 = 'ã”æ¥åº—ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ';
      let receiptMessage2 = 'ã¾ãŸã®ãŠè¶Šã—ã‚’ãŠå¾…ã¡ã—ã¦ãŠã‚Šã¾ã™';
      
      try {
        const storeId = window.currentStoreId;
        let receiptSettingsRef;
        
        if (!storeId || storeId === '') {
          receiptSettingsRef = doc(db, 'receipt_settings', 'shimoakatsuka');
        } else {
          receiptSettingsRef = doc(db, 'stores', storeId, 'receipt_settings', 'default');
        }
        
        const receiptSettingsDoc = await getDoc(receiptSettingsRef);
        
        if (receiptSettingsDoc.exists()) {
          const settings = receiptSettingsDoc.data();
          
          if (settings.storeName && settings.branchName) {
            receiptStoreName = settings.storeName + ' ' + settings.branchName;
          } else if (settings.branchName) {
            receiptStoreName = settings.branchName;
          } else if (settings.storeName) {
            receiptStoreName = settings.storeName;
          }
          
          if (settings.postalCode && settings.address) {
            receiptAddress = settings.postalCode + ' ' + settings.address;
          } else if (settings.address) {
            receiptAddress = settings.address;
          }
          
          if (settings.phone) {
            receiptPhone = 'TEL: ' + settings.phone;
          }
          
          if (settings.message) {
            const messages = settings.message.split('\n');
            receiptMessage1 = messages[0] || receiptMessage1;
            receiptMessage2 = messages[1] || receiptMessage2;
          }
        }
      } catch (error) {
        console.error('ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
      
      // LocalStorageã‹ã‚‰æ³¨æ–‡æƒ…å ±ã‚’å–å¾—
      const savedOrder = localStorage.getItem('currentOrder_' + tableNumber);
      let itemsHtml = '';
      let tax8Total = 0;
      let tax10Total = 0;
      
      if (savedOrder) {
        const orderData = JSON.parse(savedOrder);
        
        // LocalStorageã«ä¿å­˜ã•ã‚ŒãŸç¨ç‡æƒ…å ±ã‚’ä½¿ç”¨
        tax8Total = orderData.tax8Total || 0;
        tax10Total = orderData.tax10Total || 0;
        
        orderData.items.forEach(item => {
          const subtotal = (item.price + item.toppingPrice) * item.quantity;
          itemsHtml += `
            <div style="display: flex; justify-content: space-between; margin: 8px 0; padding: 8px 0; border-bottom: 1px dashed #ddd;">
              <div style="flex: 1;">
                <div style="font-weight: bold;">${item.name}</div>
                <div style="font-size: 12px; color: #666;">ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${item.toppings}</div>
                <div style="font-size: 12px; color: #666;">å˜ä¾¡: Â¥${(item.price + item.toppingPrice).toLocaleString()} Ã— ${item.quantity}</div>
              </div>
              <div style="font-weight: bold; white-space: nowrap;">Â¥${subtotal.toLocaleString()}</div>
            </div>
          `;
        });
        
        if (orderData.bagNeeded && orderData.bagQuantity > 0) {
          itemsHtml += `
            <div style="display: flex; justify-content: space-between; margin: 8px 0; padding: 8px 0; border-bottom: 1px dashed #ddd;">
              <div style="flex: 1;">
                <div style="font-weight: bold;">ğŸ›ï¸ ãƒ¬ã‚¸è¢‹</div>
                <div style="font-size: 12px; color: #666;">å˜ä¾¡: Â¥3 Ã— ${orderData.bagQuantity}</div>
              </div>
              <div style="font-weight: bold; white-space: nowrap;">Â¥${orderData.bagPrice.toLocaleString()}</div>
            </div>
          `;
        }
      }
      
      // æ¶ˆè²»ç¨è¨ˆç®—ï¼ˆå†…ç¨ï¼‰
      const tax8Excluded = Math.floor(tax8Total / 1.08);
      const tax10Excluded = Math.floor(tax10Total / 1.10);
      const tax8Amount = tax8Total - tax8Excluded;
      const tax10Amount = tax10Total - tax10Excluded;
      const totalTax = tax8Amount + tax10Amount;
      
      const receiptHtml = `
        <div style="font-family: 'Courier New', monospace; text-align: center;">
          <div style="border-bottom: 2px solid #000; padding-bottom: 15px; margin-bottom: 15px;">
            <div style="font-weight: bold; font-size: 20px; margin-bottom: 5px;">${receiptStoreName}</div>
            <div style="font-size: 12px;">${receiptAddress}</div>
            <div style="font-size: 12px;">${receiptPhone}</div>
          </div>
          
          <div style="text-align: left; margin: 20px 0;">
            <div style="display: flex; justify-content: space-between; margin: 5px 0;">
              <span>æ—¥æ™‚:</span>
              <span>${dateStr}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin: 5px 0;">
              <span>æ³¨æ–‡ç•ªå·:</span>
              <span style="font-weight: bold; font-size: 18px;">#${orderNum}</span>
            </div>
            <div style="display: flex; justify-content: space-between; margin: 5px 0;">
              <span>åˆ©ç”¨å½¢æ…‹:</span>
              <span>${eatStyle}</span>
            </div>
          </div>
          
          <div style="border-top: 2px solid #000; border-bottom: 2px solid #000; padding: 15px 0; margin: 15px 0;">
            <div style="text-align: left;">
              ${itemsHtml}
            </div>
          </div>
          
          <div style="text-align: left; font-size: 14px; margin: 15px 0; padding: 10px 0; border-bottom: 1px solid #ddd;">
            ${tax8Total > 0 ? `<div style="display: flex; justify-content: space-between; margin: 5px 0;">
              <span>8%å¯¾è±¡: Â¥${tax8Excluded.toLocaleString()}</span>
              <span>å†…ç¨: Â¥${tax8Amount.toLocaleString()}</span>
            </div>` : ''}
            ${tax10Total > 0 ? `<div style="display: flex; justify-content: space-between; margin: 5px 0;">
              <span>10%å¯¾è±¡: Â¥${tax10Excluded.toLocaleString()}</span>
              <span>å†…ç¨: Â¥${tax10Amount.toLocaleString()}</span>
            </div>` : ''}
            <div style="display: flex; justify-content: space-between; margin: 5px 0; font-weight: bold;">
              <span>æ¶ˆè²»ç¨åˆè¨ˆ:</span>
              <span>Â¥${totalTax.toLocaleString()}</span>
            </div>
          </div>
          
          <div style="text-align: right; font-size: 24px; font-weight: bold; margin: 20px 0;">
            åˆè¨ˆ: ${orderTotal}
          </div>
          
          <div style="border-top: 2px solid #000; padding-top: 15px; margin-top: 20px; font-size: 12px;">
            <div style="margin-top: 10px;">${receiptMessage1}</div>
            <div style="margin-top: 5px;">${receiptMessage2}</div>
          </div>
        </div>
      `;
      
      document.getElementById('receipt-content').innerHTML = receiptHtml;
      document.getElementById('receipt-modal').style.display = 'block';
    };
    
    window.closeReceipt = function() {
      document.getElementById('receipt-modal').style.display = 'none';
    };
    
    window.downloadReceipt = async function() {
      const element = document.getElementById('receipt-content');
      
      try {
        // html2canvasãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿
        if (!window.html2canvas) {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
          document.head.appendChild(script);
          
          await new Promise((resolve, reject) => {
            script.onload = resolve;
            script.onerror = reject;
          });
        }
        
        const canvas = await html2canvas(element, {
          backgroundColor: '#ffffff',
          scale: 2
        });
        
        const link = document.createElement('a');
        const orderNum = document.getElementById('order-num').textContent;
        link.download = `ãƒ¬ã‚·ãƒ¼ãƒˆ_${orderNum}.png`;
        link.href = canvas.toDataURL();
        link.click();
        
        showCustomAlert('ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
      } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        showCustomAlert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
      }
    };
    
    // é ˜åæ›¸è¡¨ç¤º
    window.showInvoice = async function() {
      const orderNum = document.getElementById('order-num').textContent;
      const orderTotal = document.getElementById('order-total').textContent;
      const eatStyle = document.getElementById('eat-style').textContent;
      
      const now = new Date();
      const dateStr = now.getFullYear() + 'å¹´' + 
                      String(now.getMonth() + 1).padStart(2, '0') + 'æœˆ' + 
                      String(now.getDate()).padStart(2, '0') + 'æ—¥';
      
      // ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šã‚’èª­ã¿è¾¼ã¿
      let receiptStoreName = 'ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—';
      let receiptAddress = 'æ±äº¬éƒ½æ¿æ©‹åŒºèµ¤å¡š2-2-4';
      let receiptPhone = 'TEL: 03-6904-2888';
      let stampImage = '';  // ğŸ†• å°é‘‘ç”»åƒ
      
      try {
        const storeId = window.currentStoreId;
        let receiptSettingsRef;
        
        if (!storeId || storeId === '') {
          receiptSettingsRef = doc(db, 'receipt_settings', 'shimoakatsuka');
        } else {
          receiptSettingsRef = doc(db, 'stores', storeId, 'receipt_settings', 'default');
        }
        
        const receiptSettingsDoc = await getDoc(receiptSettingsRef);
        
        if (receiptSettingsDoc.exists()) {
          const settings = receiptSettingsDoc.data();
          
          if (settings.storeName && settings.branchName) {
            receiptStoreName = settings.storeName + ' ' + settings.branchName;
          } else if (settings.branchName) {
            receiptStoreName = settings.branchName;
          } else if (settings.storeName) {
            receiptStoreName = settings.storeName;
          }
          
          if (settings.postalCode && settings.address) {
            receiptAddress = settings.postalCode + ' ' + settings.address;
          } else if (settings.address) {
            receiptAddress = settings.address;
          }
          
          if (settings.phone) {
            receiptPhone = 'TEL: ' + settings.phone;
          }
          
          // ğŸ†• å°é‘‘ç”»åƒã‚’å–å¾—
          if (settings.stampImage) {
            stampImage = settings.stampImage;
            console.log('âœ… å°é‘‘ç”»åƒã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ');
          }
        }
      } catch (error) {
        console.error('é ˜åæ›¸è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
      }
      
      // LocalStorageã‹ã‚‰æ³¨æ–‡æƒ…å ±ã‚’å–å¾—ã—ã¦æ¶ˆè²»ç¨ã‚’è¨ˆç®—
      const savedOrder = localStorage.getItem('currentOrder_' + tableNumber);
      let tax8Total = 0;
      let tax10Total = 0;
      
      if (savedOrder) {
        const orderData = JSON.parse(savedOrder);
        
        // LocalStorageã«ä¿å­˜ã•ã‚ŒãŸç¨ç‡æƒ…å ±ã‚’ä½¿ç”¨
        tax8Total = orderData.tax8Total || 0;
        tax10Total = orderData.tax10Total || 0;
      }
      
      // æ¶ˆè²»ç¨è¨ˆç®—ï¼ˆå†…ç¨ï¼‰
      const tax8Excluded = Math.floor(tax8Total / 1.08);
      const tax10Excluded = Math.floor(tax10Total / 1.10);
      const tax8Amount = tax8Total - tax8Excluded;
      const tax10Amount = tax10Total - tax10Excluded;
      const totalTax = tax8Amount + tax10Amount;
      
      const invoiceHtml = `
        <div style="font-family: 'Yu Gothic', 'Hiragino Sans', sans-serif; padding: 10px;">
          <div style="text-align: center; border-bottom: 3px double #000; padding-bottom: 20px; margin-bottom: 20px;">
            <h2 style="margin: 0; font-size: 28px; letter-spacing: 8px;">é ˜åæ›¸</h2>
          </div>
          
          <div style="margin: 30px 0;">
            <div style="font-size: 14px; margin-bottom: 10px;">ãŠå®¢æ§˜</div>
            <div style="border-bottom: 1px solid #000; padding-bottom: 5px; margin-bottom: 30px;">
              <span style="font-size: 18px;">ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€ã€€</span>
              <span style="font-size: 14px;">æ§˜</span>
            </div>
          </div>
          
          <div style="text-align: center; margin: 30px 0;">
            <div style="font-size: 16px; margin-bottom: 10px;">ä¸‹è¨˜ã®é€šã‚Šé ˜åã„ãŸã—ã¾ã—ãŸ</div>
            <div style="border: 2px solid #000; padding: 20px; margin: 20px 0;">
              <div style="font-size: 14px; margin-bottom: 5px;">é‡‘é¡</div>
              <div style="font-size: 36px; font-weight: bold;">${orderTotal}</div>
              <div style="font-size: 14px; margin-top: 10px; color: #666;">ï¼ˆå†…æ¶ˆè²»ç¨ Â¥${totalTax.toLocaleString()}ï¼‰</div>
            </div>
          </div>
          
          <div style="margin: 30px 0; font-size: 14px;">
            <div style="margin: 10px 0;">
              <span style="display: inline-block; width: 100px;">ä½†ã—</span>
              <span>é£²é£Ÿä»£ã¨ã—ã¦</span>
            </div>
            <div style="margin: 10px 0;">
              <span style="display: inline-block; width: 100px;">åˆ©ç”¨å½¢æ…‹</span>
              <span>${eatStyle}</span>
            </div>
            <div style="margin: 10px 0;">
              <span style="display: inline-block; width: 100px;">æ³¨æ–‡ç•ªå·</span>
              <span>#${orderNum}</span>
            </div>
          </div>
          
          <div style="text-align: right; margin: 40px 0 20px 0; font-size: 14px;">
            <div style="margin: 5px 0;">${dateStr}</div>
          </div>
          
          <div style="border-top: 2px solid #000; padding-top: 20px; margin-top: 40px; position: relative;">
            <div style="text-align: center; font-size: 18px; font-weight: bold; margin-bottom: 10px;">${receiptStoreName}</div>
            <div style="text-align: center; font-size: 12px; color: #666;">
              <div>${receiptAddress}</div>
              <div style="margin-top: 5px;">${receiptPhone}</div>
              <div style="margin-top: 10px;">â€»ã“ã®é ˜åæ›¸ã¯å†ç™ºè¡Œã§ãã¾ã›ã‚“</div>
            </div>
            ${stampImage ? 
              `<img src="${stampImage}" alt="å°" style="position: absolute; top: -80px; right: 30px; width: 80px; height: 80px; opacity: 0.75;">` :
              `<img src="./takada.png" alt="å°" style="position: absolute; top: -80px; right: 30px; width: 80px; height: 80px; opacity: 0.75; filter: brightness(0) saturate(100%) invert(23%) sepia(89%) saturate(7471%) hue-rotate(359deg) brightness(92%) contrast(117%);" onerror="this.style.display='none'">`
            }
          </div>
        </div>
      `;
      
      document.getElementById('invoice-content').innerHTML = invoiceHtml;
      document.getElementById('invoice-modal').style.display = 'block';
    };
    
    window.closeInvoice = function() {
      document.getElementById('invoice-modal').style.display = 'none';
    };
    
    window.downloadInvoice = async function() {
      const element = document.getElementById('invoice-content');
      
      try {
        // html2canvasãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿
        if (!window.html2canvas) {
          const script = document.createElement('script');
          script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
          document.head.appendChild(script);
          
          await new Promise((resolve, reject) => {
            script.onload = resolve;
            script.onerror = reject;
          });
        }
        
        const canvas = await html2canvas(element, {
          backgroundColor: '#ffffff',
          scale: 2
        });
        
        const link = document.createElement('a');
        const orderNum = document.getElementById('order-num').textContent;
        link.download = `é ˜åæ›¸_${orderNum}.png`;
        link.href = canvas.toDataURL();
        link.click();
        
        showCustomAlert('é ˜åæ›¸ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
      } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        showCustomAlert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’ã”åˆ©ç”¨ãã ã•ã„ã€‚');
      }
    };
    
    // ã‚«ã‚¹ã‚¿ãƒ ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    function showCustomConfirm(title, message, onConfirm) {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        animation: fadeIn 0.2s ease-out;
      `;
      
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        background: white;
        border-radius: 20px;
        padding: 0;
        max-width: 85%;
        width: 340px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        animation: slideUp 0.3s ease-out;
        overflow: hidden;
      `;
      
      const header = document.createElement('div');
      header.style.cssText = `
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        padding: 25px 20px;
        text-align: center;
      `;
      
      const icon = document.createElement('div');
      icon.textContent = '';
      icon.style.cssText = `
        font-size: 48px;
        margin-bottom: 10px;
      `;
      
      const titleText = document.createElement('div');
      titleText.textContent = title;
      titleText.style.cssText = `
        font-size: 22px;
        font-weight: bold;
        color: white;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
      `;
      
      header.appendChild(icon);
      header.appendChild(titleText);
      
      const content = document.createElement('div');
      content.style.cssText = `
        padding: 30px 25px;
        text-align: center;
      `;
      
      const messageText = document.createElement('div');
      messageText.textContent = message;
      messageText.style.cssText = `
        font-size: 16px;
        color: #666;
        line-height: 1.6;
      `;
      
      content.appendChild(messageText);
      
      const buttonContainer = document.createElement('div');
      buttonContainer.style.cssText = `
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        padding: 0 25px 25px 25px;
      `;
      
      const cancelButton = document.createElement('button');
      cancelButton.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
      cancelButton.style.cssText = `
        padding: 15px 20px;
        background: #f5f5f5;
        color: #666;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s;
      `;
      cancelButton.onmouseover = () => {
        cancelButton.style.background = '#e0e0e0';
        cancelButton.style.transform = 'scale(1.02)';
      };
      cancelButton.onmouseout = () => {
        cancelButton.style.background = '#f5f5f5';
        cancelButton.style.transform = 'scale(1)';
      };
      cancelButton.onclick = () => {
        overlay.style.animation = 'fadeOut 0.2s ease-out';
        setTimeout(() => overlay.remove(), 200);
      };
      
      const confirmButton = document.createElement('button');
      confirmButton.textContent = 'OK';
      confirmButton.style.cssText = `
        padding: 15px 20px;
        background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
        color: white;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
        transition: all 0.2s;
      `;
      confirmButton.onmouseover = () => {
        confirmButton.style.transform = 'scale(1.05)';
        confirmButton.style.boxShadow = '0 6px 20px rgba(76, 175, 80, 0.4)';
      };
      confirmButton.onmouseout = () => {
        confirmButton.style.transform = 'scale(1)';
        confirmButton.style.boxShadow = '0 4px 15px rgba(76, 175, 80, 0.3)';
      };
      confirmButton.onclick = () => {
        overlay.style.animation = 'fadeOut 0.2s ease-out';
        setTimeout(() => {
          overlay.remove();
          if (onConfirm) onConfirm();
        }, 200);
      };
      
      buttonContainer.appendChild(cancelButton);
      buttonContainer.appendChild(confirmButton);
      
      dialog.appendChild(header);
      dialog.appendChild(content);
      dialog.appendChild(buttonContainer);
      overlay.appendChild(dialog);
      
      // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
      if (!document.getElementById('custom-confirm-styles')) {
        const style = document.createElement('style');
        style.id = 'custom-confirm-styles';
        style.textContent = `
          @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
          }
          @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
          }
          @keyframes slideUp {
            from {
              transform: translateY(50px);
              opacity: 0;
            }
            to {
              transform: translateY(0);
              opacity: 1;
            }
          }
        `;
        document.head.appendChild(style);
      }
      
      document.body.appendChild(overlay);
    }
    
    function showCustomAlert(message, callback) {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        background: white;
        border-radius: 15px;
        padding: 30px;
        max-width: 80%;
        text-align: center;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      `;
      
      const text = document.createElement('div');
      text.textContent = message;
      text.style.cssText = `
        font-size: 18px;
        margin-bottom: 20px;
        color: #333;
        white-space: pre-line;
      `;
      
      const button = document.createElement('button');
      button.textContent = 'OK';
      button.style.cssText = `
        padding: 12px 40px;
        background: #2196F3;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
      `;
      button.onclick = () => {
        overlay.remove();
        if (callback) callback();
      };
      
      dialog.appendChild(text);
      dialog.appendChild(button);
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);
    }
  </script>
</body>
</html>