<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
    <div id="app" class="container mx-auto p-6"></div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, getDoc, setDoc, doc, query, orderBy, Timestamp, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
            authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
            projectId: "takoyaki-order-system-bacd7",
            storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
            messagingSenderId: "104494752890",
            appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.firebaseModules = { collection, getDocs, getDoc, setDoc, doc, query, orderBy, Timestamp, deleteDoc };
        
        // Reactã®ã‚ˆã†ãªç°¡æ˜“ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
        let state = {
            view: 'list', // 'list', 'create', 'restore'
            backups: [],
            stores: [],
            selectedBackup: null,
            selectedStore: null,
            loading: false
        };

        function setState(newState) {
            state = { ...state, ...newState };
            render();
        }

        async function loadStores() {
            const stores = [
                { id: '', name: 'ä¸‹èµ¤å¡š' }, // IDãªã—ï¼ˆæ­£ã—ã„ä¸‹èµ¤å¡šï¼‰
            ];
            
            try {
                const storesSnapshot = await getDocs(collection(db, 'stores'));
                storesSnapshot.forEach(doc => {
                    // âš ï¸ shimoakatsuka ã¯æ—§ã‚·ã‚¹ãƒ†ãƒ ãªã®ã§é™¤å¤–
                    if (doc.id === 'shimoakatsuka') {
                        console.log('âš ï¸ æ—§ã‚·ã‚¹ãƒ†ãƒ ã®ä¸‹èµ¤å¡šï¼ˆshimoakatsukaï¼‰ã‚’é™¤å¤–ã—ã¾ã—ãŸ');
                        return;
                    }
                    
                    stores.push({
                        id: doc.id,
                        name: doc.data().storeName || doc.id
                    });
                });
            } catch (e) {
                console.error('åº—èˆ—èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
            }
            
            return stores;
        }

        async function loadBackups() {
            try {
                const backupsSnapshot = await getDocs(
                    query(collection(db, 'backups'), orderBy('createdAt', 'desc'))
                );
                
                const backups = [];
                backupsSnapshot.forEach(doc => {
                    backups.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                
                return backups;
            } catch (e) {
                console.error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                return [];
            }
        }

        async function createBackup(storeId, storeName, description) {
            setState({ loading: true });
            
            try {
                console.log('ğŸ”„ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆé–‹å§‹:', storeName);
                
                // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—IDç”Ÿæˆ
                const now = new Date();
                const dateStr = `${now.getFullYear()}_${String(now.getMonth() + 1).padStart(2, '0')}_${String(now.getDate()).padStart(2, '0')}`;
                const timeStr = `${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;
                const backupId = `${storeName}_${dateStr}_${timeStr}`;
                
                // ãƒ‡ãƒ¼ã‚¿åé›†
                const backupData = {
                    backupId: backupId,
                    storeId: storeId,
                    storeName: storeName,
                    description: description || '',
                    createdAt: Timestamp.now(),
                    data: {}
                };
                
                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šã‚’å–å¾—
                let menuSettingsPath;
                if (!storeId || storeId === '') {
                    menuSettingsPath = doc(db, 'menu_settings', 'settings');
                } else {
                    menuSettingsPath = doc(db, 'stores', storeId, 'menu_settings', 'settings');
                }
                
                const menuDoc = await getDoc(menuSettingsPath);
                if (menuDoc.exists()) {
                    backupData.data.menuSettings = menuDoc.data();
                    console.log('âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šã‚’å–å¾—');
                }
                
                // ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šã‚’å–å¾—
                let receiptSettingsPath;
                if (!storeId || storeId === '') {
                    receiptSettingsPath = doc(db, 'receipt_settings', 'settings');
                } else {
                    receiptSettingsPath = doc(db, 'stores', storeId, 'receipt_settings', 'settings');
                }
                
                const receiptDoc = await getDoc(receiptSettingsPath);
                if (receiptDoc.exists()) {
                    backupData.data.receiptSettings = receiptDoc.data();
                    console.log('âœ… ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šã‚’å–å¾—');
                }
                
                // å•†å“ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                let menuItemsRef;
                if (!storeId || storeId === '') {
                    menuItemsRef = collection(db, 'menu_items');
                } else {
                    menuItemsRef = collection(db, 'stores', storeId, 'menu_items');
                }
                
                const menuItemsSnapshot = await getDocs(menuItemsRef);
                backupData.data.menuItems = [];
                menuItemsSnapshot.forEach(doc => {
                    backupData.data.menuItems.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                console.log('âœ… å•†å“ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—:', backupData.data.menuItems.length, 'ä»¶');
                
                // Firestoreã«ä¿å­˜
                await setDoc(doc(db, 'backups', backupId), backupData);
                
                console.log('âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆå®Œäº†:', backupId);
                showAlert(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä½œæˆã—ã¾ã—ãŸ\n${backupId}`, 'success');
                
                // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
                const backups = await loadBackups();
                setState({ view: 'list', backups, loading: false });
                
            } catch (e) {
                console.error('âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã‚¨ãƒ©ãƒ¼:', e);
                showAlert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ:\n' + e.message, 'error');
                setState({ loading: false });
            }
        }

        async function restoreBackup(backupId, targetStoreId, targetStoreName) {
            if (!confirm(`è­¦å‘Š: ${targetStoreName} ã®ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚\n\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            setState({ loading: true });
            
            try {
                console.log('ğŸ”„ å¾©å…ƒé–‹å§‹:', backupId, 'â†’', targetStoreName);
                
                // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const backupDoc = await getDoc(doc(db, 'backups', backupId));
                if (!backupDoc.exists()) {
                    throw new Error('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                const backupData = backupDoc.data();
                
                // ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šã‚’å¾©å…ƒ
                if (backupData.data.menuSettings) {
                    let menuSettingsPath;
                    if (!targetStoreId || targetStoreId === '') {
                        menuSettingsPath = doc(db, 'menu_settings', 'settings');
                    } else {
                        menuSettingsPath = doc(db, 'stores', targetStoreId, 'menu_settings', 'settings');
                    }
                    
                    await setDoc(menuSettingsPath, backupData.data.menuSettings);
                    console.log('âœ… ãƒ¡ãƒ‹ãƒ¥ãƒ¼è¨­å®šã‚’å¾©å…ƒ');
                }
                
                // ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šã‚’å¾©å…ƒ
                if (backupData.data.receiptSettings) {
                    let receiptSettingsPath;
                    if (!targetStoreId || targetStoreId === '') {
                        receiptSettingsPath = doc(db, 'receipt_settings', 'settings');
                    } else {
                        receiptSettingsPath = doc(db, 'stores', targetStoreId, 'receipt_settings', 'settings');
                    }
                    
                    await setDoc(receiptSettingsPath, backupData.data.receiptSettings);
                    console.log('âœ… ãƒ¬ã‚·ãƒ¼ãƒˆè¨­å®šã‚’å¾©å…ƒ');
                }
                
                // å•†å“ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
                if (backupData.data.menuItems) {
                    for (const item of backupData.data.menuItems) {
                        let menuItemPath;
                        if (!targetStoreId || targetStoreId === '') {
                            menuItemPath = doc(db, 'menu_items', item.id);
                        } else {
                            menuItemPath = doc(db, 'stores', targetStoreId, 'menu_items', item.id);
                        }
                        
                        const { id, ...itemData } = item;
                        await setDoc(menuItemPath, itemData);
                    }
                    console.log('âœ… å•†å“ç™»éŒ²ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ:', backupData.data.menuItems.length, 'ä»¶');
                }
                
                console.log('âœ… å¾©å…ƒå®Œäº†');
                showAlert(`å¾©å…ƒãŒå®Œäº†ã—ã¾ã—ãŸ\n${targetStoreName}`, 'success');
                
                setState({ view: 'list', loading: false });
                
            } catch (e) {
                console.error('âŒ å¾©å…ƒã‚¨ãƒ©ãƒ¼:', e);
                showAlert('å¾©å…ƒã«å¤±æ•—ã—ã¾ã—ãŸ:\n' + e.message, 'error');
                setState({ loading: false });
            }
        }

        async function deleteBackup(backupId) {
            if (!confirm(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— ${backupId} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                return;
            }
            
            try {
                await deleteDoc(doc(db, 'backups', backupId));
                console.log('âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤:', backupId);
                showAlert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å‰Šé™¤ã—ã¾ã—ãŸ', 'success');
                
                const backups = await loadBackups();
                setState({ backups });
            } catch (e) {
                console.error('âŒ å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e);
                showAlert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ:\n' + e.message, 'error');
            }
        }

        function showAlert(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            
            const alert = document.createElement('div');
            alert.className = `fixed top-4 right-4 ${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg z-50`;
            alert.textContent = message;
            document.body.appendChild(alert);
            
            setTimeout(() => alert.remove(), 3000);
        }

        function render() {
            const app = document.getElementById('app');
            
            if (state.loading) {
                app.innerHTML = `
                    <div class="flex items-center justify-center h-screen">
                        <div class="text-center">
                            <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-500 border-t-transparent mx-auto mb-4"></div>
                            <p class="text-xl text-gray-700">å‡¦ç†ä¸­...</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            if (state.view === 'create') {
                app.innerHTML = `
                    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
                        <h1 class="text-3xl font-bold mb-6">ğŸ“¦ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</h1>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2">åº—èˆ—ã‚’é¸æŠ</label>
                            <select id="store-select" class="w-full p-3 border rounded-lg">
                                ${state.stores.map(store => `
                                    <option value="${store.id}">${store.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2">èª¬æ˜ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
                            <textarea id="description" class="w-full p-3 border rounded-lg" rows="3" placeholder="ä¾‹: ãƒ¡ãƒ‹ãƒ¥ãƒ¼æ›´æ–°å‰ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—"></textarea>
                        </div>
                        
                        <div class="flex gap-4">
                            <button onclick="handleCreateBackup()" class="flex-1 bg-blue-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-600">
                                ä½œæˆã™ã‚‹
                            </button>
                            <button onclick="setState({ view: 'list' })" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-600">
                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                        </div>
                    </div>
                `;
            } else if (state.view === 'restore') {
                app.innerHTML = `
                    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
                        <h1 class="text-3xl font-bold mb-6">ğŸ”„ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©å…ƒ</h1>
                        
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <h3 class="font-bold mb-2">å¾©å…ƒå…ƒãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—:</h3>
                            <p class="text-lg">${state.selectedBackup.backupId}</p>
                            <p class="text-sm text-gray-600">ä½œæˆæ—¥æ™‚: ${new Date(state.selectedBackup.createdAt.seconds * 1000).toLocaleString('ja-JP')}</p>
                            <p class="text-sm text-gray-600">å…ƒã®åº—èˆ—: ${state.selectedBackup.storeName}</p>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold mb-2">å¾©å…ƒå…ˆåº—èˆ—ã‚’é¸æŠ</label>
                            <select id="target-store-select" class="w-full p-3 border rounded-lg">
                                ${state.stores.map(store => `
                                    <option value="${store.id}">${store.name}</option>
                                `).join('')}
                            </select>
                        </div>
                        
                        <div class="mb-6 p-4 bg-yellow-50 border-2 border-yellow-500 rounded-lg">
                            <p class="text-red-600 font-bold">âš ï¸ è­¦å‘Š</p>
                            <p class="text-sm">å¾©å…ƒå…ˆã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚</p>
                        </div>
                        
                        <div class="flex gap-4">
                            <button onclick="handleRestoreBackup()" class="flex-1 bg-red-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-red-600">
                                å¾©å…ƒã™ã‚‹
                            </button>
                            <button onclick="setState({ view: 'list' })" class="flex-1 bg-gray-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-gray-600">
                                ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            </button>
                        </div>
                    </div>
                `;
            } else {
                // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¸€è¦§
                app.innerHTML = `
                    <div class="max-w-6xl mx-auto">
                        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h1 class="text-3xl font-bold">ğŸ“¦ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç®¡ç†</h1>
                                <button onclick="showCreateView()" class="bg-blue-500 text-white px-6 py-3 rounded-lg font-bold hover:bg-blue-600">
                                    + æ–°è¦ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
                                </button>
                            </div>
                        </div>
                        
                        <div class="space-y-4">
                            ${state.backups.length === 0 ? `
                                <div class="bg-white rounded-lg shadow p-6 text-center text-gray-500">
                                    ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒã‚ã‚Šã¾ã›ã‚“
                                </div>
                            ` : state.backups.map(backup => `
                                <div class="bg-white rounded-lg shadow-lg p-6">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <h3 class="text-xl font-bold mb-2">ğŸ“¦ ${backup.backupId}</h3>
                                            <p class="text-sm text-gray-600 mb-1">åº—èˆ—: ${backup.storeName}</p>
                                            <p class="text-sm text-gray-600 mb-1">ä½œæˆæ—¥æ™‚: ${new Date(backup.createdAt.seconds * 1000).toLocaleString('ja-JP')}</p>
                                            ${backup.description ? `<p class="text-sm text-gray-600">èª¬æ˜: ${backup.description}</p>` : ''}
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="showRestoreView('${backup.id}')" class="bg-green-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-600">
                                                å¾©å…ƒ
                                            </button>
                                            <button onclick="deleteBackup('${backup.id}')" class="bg-red-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-600">
                                                å‰Šé™¤
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
        }

        window.setState = setState;
        window.createBackup = createBackup;
        window.restoreBackup = restoreBackup;
        window.deleteBackup = deleteBackup;

        window.showCreateView = async function() {
            const stores = await loadStores();
            setState({ view: 'create', stores });
        };

        window.showRestoreView = function(backupId) {
            const backup = state.backups.find(b => b.id === backupId);
            if (backup) {
                setState({ view: 'restore', selectedBackup: backup });
            }
        };

        window.handleCreateBackup = function() {
            const storeSelect = document.getElementById('store-select');
            const description = document.getElementById('description').value;
            
            const storeId = storeSelect.value;
            const storeName = storeSelect.options[storeSelect.selectedIndex].text;
            
            createBackup(storeId, storeName, description);
        };

        window.handleRestoreBackup = function() {
            const targetSelect = document.getElementById('target-store-select');
            const targetStoreId = targetSelect.value;
            const targetStoreName = targetSelect.options[targetSelect.selectedIndex].text;
            
            restoreBackup(state.selectedBackup.id, targetStoreId, targetStoreName);
        };

        // åˆæœŸåŒ–
        async function init() {
            setState({ loading: true });
            const stores = await loadStores();
            const backups = await loadBackups();
            setState({ stores, backups, loading: false });
        }

        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
