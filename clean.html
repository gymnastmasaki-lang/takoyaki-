<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ§¹ Firestore ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }
    .log {
      background: #f5f5f5;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      max-height: 400px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 14px;
    }
    .success { color: green; font-weight: bold; }
    .error { color: red; font-weight: bold; }
    .warning { color: orange; font-weight: bold; }
    .info { color: blue; }
    button {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .btn-cleanup {
      background: #f44336;
      color: white;
    }
    .btn-cleanup:hover {
      background: #d32f2f;
    }
    .btn-test {
      background: #2196F3;
      color: white;
    }
    .btn-test:hover {
      background: #1976D2;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§¹ Firestore ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ãƒ„ãƒ¼ãƒ«</h1>
    
    <p><strong>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ä»¥ä¸‹ã®å£Šã‚ŒãŸæ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã™:</strong></p>
    <ul>
      <li>items ãŒç©ºé…åˆ— [] ã®æ³¨æ–‡</li>
      <li>orderNumber ãŒ null/undefined ã®æ³¨æ–‡</li>
      <li>10åˆ†ä»¥ä¸ŠçµŒéã—ãŸæœªå®Œäº†æ³¨æ–‡</li>
    </ul>
    
    <button class="btn-test" onclick="testOnly()">
      ğŸ” ãƒ†ã‚¹ãƒˆã®ã¿ï¼ˆå‰Šé™¤ã—ãªã„ï¼‰
    </button>
    
    <button class="btn-cleanup" onclick="cleanupFirestore()">
      ğŸ—‘ï¸ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œï¼ˆå£Šã‚ŒãŸæ³¨æ–‡ã‚’å‰Šé™¤ï¼‰
    </button>
    
    <div class="log" id="log"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, collection, getDocs, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBo1S4-q5vXrFVj3r3tcF38OkdyPvdE",
      authDomain: "konamonyahachi.firebaseapp.com",
      projectId: "konamonyahachi",
      storageBucket: "konamonyahachi.firebasestorage.app",
      messagingSenderId: "117180785049",
      appId: "1:117180785049:web:c31f23fb05e7aebf608b70"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const className = type;
      const timestamp = new Date().toLocaleTimeString();
      logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    async function findBrokenOrders() {
      const brokenOrders = [];
      const now = new Date();
      
      try {
        log('ğŸ“‹ orders ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¹ã‚­ãƒ£ãƒ³ä¸­...', 'info');
        const snapshot = await getDocs(collection(db, 'orders'));
        log(`âœ… åˆè¨ˆ ${snapshot.size} ä»¶ã®æ³¨æ–‡ã‚’ç¢ºèª`, 'info');
        
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          const id = docSnap.id;
          
          // ãƒã‚§ãƒƒã‚¯1: items ãŒç©º
          if (!data.items || data.items.length === 0) {
            brokenOrders.push({
              id,
              reason: 'items ãŒç©º',
              data: {
                orderNumber: data.orderNumber,
                tableNumber: data.tableNumber,
                timestamp: data.timestamp?.toDate?.()
              }
            });
          }
          // ãƒã‚§ãƒƒã‚¯2: orderNumber ãŒ null/undefined
          else if (!data.orderNumber) {
            brokenOrders.push({
              id,
              reason: 'orderNumber ãŒ null/undefined',
              data: {
                tableNumber: data.tableNumber,
                itemsCount: data.items?.length,
                timestamp: data.timestamp?.toDate?.()
              }
            });
          }
          // ãƒã‚§ãƒƒã‚¯3: 10åˆ†ä»¥ä¸ŠçµŒéã—ãŸæœªå®Œäº†æ³¨æ–‡
          else if (data.timestamp && !data.paidAt && !data.completedAt && !data.cancelledAt) {
            const orderTime = data.timestamp.toDate();
            const diffMinutes = (now - orderTime) / 1000 / 60;
            
            if (diffMinutes > 10) {
              brokenOrders.push({
                id,
                reason: `${Math.floor(diffMinutes)}åˆ†çµŒéã—ãŸæœªå®Œäº†æ³¨æ–‡`,
                data: {
                  orderNumber: data.orderNumber,
                  tableNumber: data.tableNumber,
                  timestamp: orderTime
                }
              });
            }
          }
        });
        
        return brokenOrders;
      } catch (e) {
        log(`âŒ ã‚¨ãƒ©ãƒ¼: ${e.message}`, 'error');
        throw e;
      }
    }

    window.testOnly = async function() {
      const logDiv = document.getElementById('log');
      logDiv.innerHTML = '<h3>ğŸ” ãƒ†ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ‰ï¼ˆå‰Šé™¤ã—ã¾ã›ã‚“ï¼‰</h3>';
      
      try {
        const brokenOrders = await findBrokenOrders();
        
        if (brokenOrders.length === 0) {
          log('âœ… å£Šã‚ŒãŸæ³¨æ–‡ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ', 'success');
        } else {
          log(`âš ï¸ ${brokenOrders.length} ä»¶ã®å£Šã‚ŒãŸæ³¨æ–‡ã‚’ç™ºè¦‹`, 'warning');
          log('', 'info');
          
          brokenOrders.forEach((order, index) => {
            log(`${index + 1}. ID: ${order.id}`, 'warning');
            log(`   ç†ç”±: ${order.reason}`, 'info');
            log(`   ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(order.data, null, 2)}`, 'info');
            log('', 'info');
          });
        }
      } catch (e) {
        log(`âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: ${e.message}`, 'error');
      }
    };

    window.cleanupFirestore = async function() {
      if (!confirm('æœ¬å½“ã«å£Šã‚ŒãŸæ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ\n\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        return;
      }
      
      const logDiv = document.getElementById('log');
      logDiv.innerHTML = '<h3>ğŸ—‘ï¸ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Ÿè¡Œä¸­...</h3>';
      
      try {
        const brokenOrders = await findBrokenOrders();
        
        if (brokenOrders.length === 0) {
          log('âœ… å‰Šé™¤å¯¾è±¡ã®æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“', 'success');
          return;
        }
        
        log(`âš ï¸ ${brokenOrders.length} ä»¶ã®æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã™`, 'warning');
        log('', 'info');
        
        for (const order of brokenOrders) {
          try {
            await deleteDoc(doc(db, 'orders', order.id));
            log(`âœ… å‰Šé™¤æˆåŠŸ: ${order.id} (${order.reason})`, 'success');
          } catch (e) {
            log(`âŒ å‰Šé™¤å¤±æ•—: ${order.id} - ${e.message}`, 'error');
          }
        }
        
        log('', 'info');
        log('ğŸ‰ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†ï¼', 'success');
        log('', 'info');
        log('æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:', 'info');
        log('1. å…¨ã¦ã®ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆCtrl+Shift+Rï¼‰', 'info');
        log('2. menu.html ã§æ–°ã—ã„æ³¨æ–‡ã‚’è©¦ã™', 'info');
        
      } catch (e) {
        log(`âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å¤±æ•—: ${e.message}`, 'error');
      }
    };
  </script>
</body>
</html>
