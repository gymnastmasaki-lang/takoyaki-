<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸è¡¨ç¤º</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .container {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 600px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    
    .header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    .header h1 {
      font-size: 28px;
      color: #333;
      margin-bottom: 10px;
    }
    
    .header p {
      font-size: 14px;
      color: #666;
    }
    
    .receipt-content {
      margin: 30px 0;
      border: 2px solid #eee;
      border-radius: 12px;
      padding: 20px;
      background: #fafafa;
    }
    
    .error-message {
      text-align: center;
      padding: 40px;
      color: #f44336;
      font-size: 18px;
      font-weight: bold;
    }
    
    .loading-message {
      text-align: center;
      padding: 40px;
      color: #667eea;
      font-size: 18px;
      font-weight: bold;
    }
    
    .download-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
      transition: transform 0.2s;
    }
    
    .download-btn:hover {
      transform: translateY(-2px);
    }
    
    .download-btn:active {
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="receiptDisplay" class="receipt-content">
      <div class="loading-message">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>
    
    <button id="downloadBtn" class="download-btn" style="display: none;" onclick="downloadImage()">
      ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
    </button>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBVrGE2p8mZs2cF5YqXxV8yqD4Z9K0v7k8",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    console.log('ğŸš€ FirebaseåˆæœŸåŒ–å®Œäº†');

    // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—
    const urlParams = new URLSearchParams(window.location.search);
    const receiptId = urlParams.get('id');

    console.log('ğŸ†” ãƒ¬ã‚·ãƒ¼ãƒˆID:', receiptId);

    const displayDiv = document.getElementById('receiptDisplay');
    const downloadBtn = document.getElementById('downloadBtn');
    let receiptImageData = null;

    // ãƒ¬ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿é–¢æ•°
    async function loadReceipt() {
      console.log('ğŸ“„ === ãƒ¬ã‚·ãƒ¼ãƒˆèª­ã¿è¾¼ã¿é–‹å§‹ ===');

      if (!receiptId) {
        displayDiv.innerHTML = '<div class="error-message">ãƒ¬ã‚·ãƒ¼ãƒˆIDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
        console.error('âŒ ãƒ¬ã‚·ãƒ¼ãƒˆIDãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      try {
        // Firestoreã‹ã‚‰ãƒ¬ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        console.log('ğŸ’¾ Firestoreã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—:', receiptId);
        const receiptRef = doc(db, 'receipt_images', receiptId);
        const receiptDoc = await getDoc(receiptRef);

        if (!receiptDoc.exists()) {
          displayDiv.innerHTML = `
            <div class="error-message">
              ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“<br><br>
              <small>QRã‚³ãƒ¼ãƒ‰ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã‚‹ã‹ã€ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚ŒãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™</small>
            </div>
          `;
          console.error('âŒ ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“');
          return;
        }

        const data = receiptDoc.data();
        receiptImageData = data.imageData;

        // æœ‰åŠ¹æœŸé™ãƒã‚§ãƒƒã‚¯
        const expiresAt = data.expiresAt?.toDate();
        if (expiresAt && expiresAt < new Date()) {
          displayDiv.innerHTML = `
            <div class="error-message">
              ã“ã®ãƒ¬ã‚·ãƒ¼ãƒˆã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™<br><br>
              <small>ãƒ¬ã‚·ãƒ¼ãƒˆã¯ç™ºè¡Œã‹ã‚‰7æ—¥é–“æœ‰åŠ¹ã§ã™</small>
            </div>
          `;
          console.warn('âš ï¸ ãƒ¬ã‚·ãƒ¼ãƒˆã®æœ‰åŠ¹æœŸé™åˆ‡ã‚Œ');
          return;
        }

        console.log('âœ… ãƒ‡ãƒ¼ã‚¿å–å¾—æˆåŠŸ');
        console.log('ğŸ“Š æ³¨æ–‡ç•ªå·:', data.orderNumber);
        console.log('ğŸ’° åˆè¨ˆ:', data.total);

        // ç”»åƒã‚’è¡¨ç¤º
        displayDiv.innerHTML = '';

        const img = document.createElement('img');
        img.src = receiptImageData;
        img.style.width = '100%';
        img.style.borderRadius = '8px';

        img.onload = function() {
          console.log('âœ… ç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸ');
          console.log('ğŸ“ ç”»åƒã‚µã‚¤ã‚º:', img.naturalWidth, 'x', img.naturalHeight);
        };

        img.onerror = function() {
          console.error('âŒ ç”»åƒèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼');
          displayDiv.innerHTML = '<div class="error-message">ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
        };

        displayDiv.appendChild(img);
        downloadBtn.style.display = 'block';

        console.log('âœ… ãƒ¬ã‚·ãƒ¼ãƒˆè¡¨ç¤ºå®Œäº†');

      } catch (error) {
        console.error('âŒ ã‚¨ãƒ©ãƒ¼:', error);
        displayDiv.innerHTML = `
          <div class="error-message">
            ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ<br><br>
            <small>${error.message}</small>
          </div>
        `;
      }
    }

    // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–¢æ•°
    window.downloadImage = function() {
      if (!receiptImageData) {
        alert('ç”»åƒãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      const link = document.createElement('a');
      link.download = `receipt_${receiptId}.png`;
      link.href = receiptImageData;
      link.click();

      console.log('ğŸ“¥ ç”»åƒãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Ÿè¡Œ');
    };

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å®Ÿè¡Œ
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', loadReceipt);
    } else {
      loadReceipt();
    }
  </script>
</body>
</html>
