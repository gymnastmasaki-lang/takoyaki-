<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ³¨æ–‡ç®¡ç†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼</title>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 15px;
      min-height: 100vh;
    }
    .header {
      background: white;
      color: #667eea;
      padding: 15px 20px;
      border-radius: 15px;
      margin-bottom: 15px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .header h1 { font-size: 20px; font-weight: bold; }
    
    /* å¾…ã¡äººæ•°è¡¨ç¤ºã‚«ãƒ¼ãƒ‰ */
    .waiting-info-card {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 999;
      background: rgba(255, 255, 255, 0.98);
      padding: 12px;
      border-radius: 0 0 12px 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      text-align: center;
    }
    .waiting-label {
      font-size: 14px;
      font-weight: bold;
      color: #666;
      margin-bottom: 3px;
    }
    .waiting-count {
      font-size: 28px;
      font-weight: bold;
      color: #ff6b6b;
    }
    
    /* å›ºå®šã‚«ãƒ¼ãƒ‰ã®åˆ†ã ã‘ä¸Šéƒ¨ã«ä½™ç™½ã‚’è¿½åŠ  */
    .content-spacer {
      height: 70px;
    }
    
    .top-controls { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .big-btn {
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: all 0.3s;
      color: white;
    }
    .big-btn:active { transform: scale(0.95); }
    .btn-refresh { background: #FFFF00; color: #333; }
    .btn-add-waiting { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); }
    .btn-soldout { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
    .manual-waiting-card {
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
    }
    .manual-waiting-label {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      white-space: nowrap;
    }
    .manual-count { 
      font-size: 32px; 
      font-weight: bold; 
      color: #FF9800; 
      flex: 1;
      text-align: center;
    }
    .btn-reset {
      padding: 12px 25px;
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      white-space: nowrap;
    }
    .order-card { 
      background: white; 
      border-radius: 12px; 
      padding: 15px; 
      margin-bottom: 15px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      position: relative;
    }
    .order-number { font-size: 28px; font-weight: bold; color: #4CAF50; }
    .order-table {
      display: inline-block;
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      padding: 6px 15px;
      border-radius: 15px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .order-item {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
    }
    .order-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .order-item-name {
      font-size: 16px;
      font-weight: bold;
    }
    .order-item-price {
      font-size: 14px;
      color: #666;
    }
    .order-item-toppings {
      font-size: 14px;
      color: #666;
      margin: 4px 0;
      padding-left: 10px;
      line-height: 1.8;
    }
    .order-item-total {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      text-align: right;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #ddd;
    }
    .order-item-memo {
      font-size: 12px;
      color: #f44336;
      margin-top: 5px;
      padding-left: 10px;
    }
    .order-total {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      text-align: right;
    }
    .order-total-label {
      font-size: 18px;
      font-weight: bold;
      color: #1976D2;
    }
    .order-total-amount {
      font-size: 24px;
      font-weight: bold;
      color: #1976D2;
      margin-top: 5px;
    }
    .control-btn {
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      color: white;
      margin: 5px;
    }
    .btn-complete { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); }
    .btn-cancel { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); }
    .staff-call-card {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      animation: pulse 1s infinite;
    }
    .staff-call-table { font-size: 48px; font-weight: bold; text-align: center; margin: 10px 0; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
    .hidden { display: none; }
    .category-filter {
      background: white;
      padding: 15px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .category-filter select {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      border: 3px solid #9C27B0;
      border-radius: 12px;
    }
    .soldout-item {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .soldout-item.sold-out { background: #f5f5f5; opacity: 0.7; }
    .soldout-item-name { font-size: 16px; font-weight: bold; color: #333; }
    .soldout-badge { background: #f44336; color: white; padding: 5px 10px; border-radius: 8px; font-size: 12px; font-weight: bold; margin-top: 5px; display: inline-block; }
    .soldout-toggle-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      color: white;
    }
    .soldout-toggle-btn.set-soldout { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); }
    .soldout-toggle-btn.set-available { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); }
    
    
    /* ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .connection-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transition: all 0.3s;
    }
    .connection-indicator.online {
      background: #4CAF50;
      color: white;
    }
    .connection-indicator.offline {
      background: #f44336;
      color: white;
    }
    
    /* æ”¯æ‰•ã„æ–¹æ³•ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .payment-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .payment-modal-overlay.show {
      display: flex;
    }
    .payment-modal {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .payment-modal h3 {
      text-align: center;
      color: #667eea;
      font-size: 24px;
      margin-bottom: 20px;
    }
    .payment-method-btn {
      width: 100%;
      padding: 20px;
      margin: 10px 0;
      font-size: 18px;
      font-weight: bold;
      border: 3px solid #ddd;
      border-radius: 15px;
      cursor: pointer;
      background: white;
      transition: all 0.3s;
    }
    .payment-method-btn:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102,126,234,0.3);
    }
    .payment-method-btn.selected {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }
    .payment-modal-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
    }
    .payment-modal-btn {
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .payment-modal-btn.confirm {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    .payment-modal-btn.cancel {
      background: #e0e0e0;
      color: #333;
    }
    .connection-indicator.offline {
      background: #f44336;
      color: white;
    }
    .connection-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: white;
    }
    
    /* ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
    .custom-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      animation: fadeIn 0.2s ease-out;
    }
    
    .custom-modal-overlay.active {
      display: flex;
    }
    
    .custom-modal {
      background: white;
      border-radius: 20px;
      padding: 40px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      text-align: center;
      animation: slideUp 0.3s ease-out;
    }
    
    .custom-modal-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }
    
    .custom-modal-title {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      margin-bottom: 15px;
    }
    
    .custom-modal-message {
      font-size: 16px;
      color: #666;
      margin-bottom: 30px;
      white-space: pre-line;
      line-height: 1.6;
    }
    
    .custom-modal-buttons {
      display: flex;
      gap: 10px;
    }
    
    .custom-modal-btn {
      flex: 1;
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .custom-modal-btn-cancel {
      background: #e0e0e0;
      color: #666;
    }
    
    .custom-modal-btn-cancel:hover {
      background: #d0d0d0;
    }
    
    .custom-modal-btn-confirm {
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
    }
    
    .custom-modal-btn-confirm:hover {
      opacity: 0.9;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
  <div id="loginScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; align-items: center; justify-content: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 10000;">
    <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
      <div style="text-align: center; margin-bottom: 30px;">
        <div style="font-size: 60px; margin-bottom: 10px;">ğŸ›ï¸</div>
        <h2 style="font-size: 24px; font-weight: bold; color: #333; margin: 0;">ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼</h2>
        <p style="color: #666; margin-top: 10px;">åº—èˆ—æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
      </div>
      
      <form onsubmit="return handleLogin(event);">
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #333; font-weight: bold; margin-bottom: 8px; font-size: 14px;">åº—èˆ—å</label>
          <input type="text" id="storeNameInput" placeholder="åº—èˆ—åã‚’å…¥åŠ›" style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box;" required autofocus />
        </div>
        
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #333; font-weight: bold; margin-bottom: 8px; font-size: 14px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="password" id="passwordInput" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" style="width: 100%; padding: 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; box-sizing: border-box;" required />
        </div>
        
        <div id="loginError" style="display: none; color: #f44336; text-align: center; margin-bottom: 15px; font-size: 14px;"></div>
        
        <button type="submit" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer;">ãƒ­ã‚°ã‚¤ãƒ³</button>
      </form>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
  <div id="mainContent">
  <div class="connection-indicator online" id="connection-indicator">
    <div class="connection-dot"></div>
    <span>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>
  </div>

  <!-- å¾…ã¡äººæ•°è¡¨ç¤ºã‚«ãƒ¼ãƒ‰ï¼ˆå›ºå®šï¼‰ -->
  <div class="waiting-info-card">
    <div class="waiting-label">ãŸã ä»Šã®ãŠå¾…ã¡äººæ•°</div>
    <div class="waiting-count"><span id="top-waiting">-</span>çµ„</div>
  </div>

  <!-- å›ºå®šã‚«ãƒ¼ãƒ‰ã®åˆ†ã ã‘ä¸Šéƒ¨ã«ä½™ç™½ã‚’è¿½åŠ  -->
  <div class="content-spacer"></div>

  <div id="page-orders">
    <div class="top-controls">
      <button class="big-btn" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);" onclick="handleControllerLogout()">LO</button>
      <button class="big-btn btn-add-waiting" onclick="increaseWaiting()">å¾…1</button>
      <button class="big-btn" style="background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);" onclick="alert('åœ¨åº«ç®¡ç†ã¯ç®¡ç†ç”»é¢ã‹ã‚‰è¡Œã£ã¦ãã ã•ã„')">åœ¨åº«</button>
      <button class="big-btn" id="bulk-zero-btn" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);" onclick="alert('ä¸€æ‹¬åœ¨åº«0è¨­å®šã¯ç®¡ç†ç”»é¢ã‹ã‚‰è¡Œã£ã¦ãã ã•ã„')">ä¸€æ‹¬0</button>
      <button class="big-btn" id="time-override-btn" style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);" onclick="toggleTimeOverride()">æ™‚å¤–</button>
    </div>

    <div class="manual-waiting-card">
      <div class="manual-waiting-label">æ‰‹å‹•å¾…ã¡äººæ•°</div>
      <div class="manual-count" id="manual-count">0</div>
      <button class="btn-reset" onclick="resetWaiting()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div id="staff-calls-container"></div>
    <div id="orders-container"><div style="text-align:center;color:white;padding:40px;">èª­ã¿è¾¼ã¿ä¸­...</div></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, getDoc, doc, deleteDoc, setDoc, updateDoc, Timestamp, onSnapshot, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const app = initializeApp({
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    });
    
    const db = getFirestore(app);

    // åº—èˆ—IDç®¡ç†
    let currentStoreId = null;
    let currentStoreName = null;

    // åº—èˆ—åˆ¥ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å‚ç…§ã‚’å–å¾—
    window.getStoreCollection = function(collectionName) {
      console.log('ğŸ” Controller getStoreCollection:', collectionName, 'currentStoreId:', window.currentStoreId);
      if (!window.currentStoreId) {
        const oldPathMap = {
          "menus": "menu",
          "employees": "kintai_employees",
          "attendance": "kintai_attendance"
        };
        const path = oldPathMap[collectionName] || collectionName;
        console.log('  â†’ æ—§ãƒ‘ã‚¹:', path);
        return collection(db, path);
      }
      console.log('  â†’ æ–°ãƒ‘ã‚¹: stores/' + window.currentStoreId + '/' + collectionName);
      return collection(db, "stores", window.currentStoreId, collectionName);
    };

    // åº—èˆ—åˆ¥ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå‚ç…§ã‚’å–å¾—
    window.getStoreDoc = function(collectionName, docId) {
      if (!window.currentStoreId) {
        const oldPathMap = {
          "menus": "menu",
          "employees": "kintai_employees",
          "attendance": "kintai_attendance"
        };
        return doc(db, oldPathMap[collectionName] || collectionName, docId);
      }
      return doc(db, "stores", window.currentStoreId, collectionName, docId);
    };
    
    window.db = db;
    
    // Firebaseãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼ˆãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã§ä½¿ç”¨ï¼‰
    window.collection = collection;
    window.getDocs = getDocs;
    window.getDoc = getDoc;
    window.updateDoc = updateDoc;
    window.query = query;
    window.where = where;
    window.doc = doc;
    window.deleteDoc = deleteDoc;
    window.Timestamp = Timestamp;

    // åº—èˆ—åˆ¥èªè¨¼ç”¨ã®å¤‰æ•°ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«è¨­å®š
    window.currentStoreId = null;
    window.currentStoreName = null;

    let audioEnabled = false;
    let isFirstOrderLoad = true;
    let lastOrderCount = 0;
    let allMenuItems = [];
    let isBulkSoldOut = false;
    let currentAudio = null;
    
    // ã‚¿ãƒƒãƒ—éŸ³ç”¨ã®AudioContext
    let audioContext = null;
    
    // ã‚¿ãƒƒãƒ—éŸ³ã‚’å†ç”Ÿã™ã‚‹é–¢æ•°
    function playTapSound() {
      try {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // ãƒ”ãƒƒã¨ã„ã†éŸ³ï¼ˆ1000Hzï¼‰
        oscillator.frequency.value = 1000;
        oscillator.type = 'sine';
        
        // éŸ³é‡è¨­å®š
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
      } catch (e) {
        console.log('ã‚¿ãƒƒãƒ—éŸ³å†ç”Ÿã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    // å…¨ã¦ã®ãƒœã‚¿ãƒ³ã«ã‚¿ãƒƒãƒ—éŸ³ã‚’è¿½åŠ 
    document.addEventListener('DOMContentLoaded', () => {
      // ãƒœã‚¿ãƒ³è¦ç´ ã‚’å–å¾—ï¼ˆorder-cardã¯é™¤å¤–ï¼‰
      const buttons = document.querySelectorAll('button, .big-btn, .action-btn, .payment-btn');
      
      buttons.forEach(button => {
        button.addEventListener('click', () => {
          playTapSound();
        });
      });
      
      // å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ãƒœã‚¿ãƒ³ç”¨ï¼ˆMutationObserverï¼‰
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (node.tagName === 'BUTTON' || node.classList?.contains('action-btn')) {
              node.addEventListener('click', () => {
                playTapSound();
              });
            }
            // å­è¦ç´ ã®ãƒœã‚¿ãƒ³ã‚‚ãƒã‚§ãƒƒã‚¯
            if (node.querySelectorAll) {
              node.querySelectorAll('button, .action-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                  playTapSound();
                });
              });
            }
          });
        });
      });
      
      observer.observe(document.body, { childList: true, subtree: true });
    });

    // æ¥ç¶šç›£è¦–
    window.addEventListener('online', () => {
      const indicator = document.getElementById('connection-indicator');
      indicator.className = 'connection-indicator online';
      indicator.innerHTML = '<div class="connection-dot"></div><span>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>';
    });

    window.addEventListener('offline', () => {
      const indicator = document.getElementById('connection-indicator');
      indicator.className = 'connection-indicator offline';
      indicator.innerHTML = '<div class="connection-dot"></div><span>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>';
    });

    window.onload = async function() {
      showAudioEnablePopup();
    };


    function showAudioEnablePopup() {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      
      const popup = document.createElement('div');
      popup.style.cssText = `
        background: white;
        border-radius: 20px;
        padding: 40px;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      `;
      
      popup.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ”Š</div>
        <div style="font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #333;">
          éŸ³å£°é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã‹?
        </div>
        <div style="font-size: 16px; color: #666; margin-bottom: 30px;">
          æ–°è¦æ³¨æ–‡ãŒå…¥ã£ãŸæ™‚ã«éŸ³ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™
        </div>
        <button style="
          padding: 15px 40px;
          background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
          color: white;
          border: none;
          border-radius: 12px;
          font-size: 18px;
          font-weight: bold;
          cursor: pointer;
          box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        ">æœ‰åŠ¹ã«ã™ã‚‹</button>
      `;
      
      popup.querySelector('button').onclick = () => {
        audioEnabled = true;
        overlay.remove();
        loadOrders();
        loadTimeOverrideStatus();
        watchWaiting();
        watchStaffCalls();
        watchOrders();
        watchTotalWaitingCount(); // å¾…ã¡äººæ•°ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚’é–‹å§‹
      };
      
      overlay.appendChild(popup);
      document.body.appendChild(overlay);
    }

    function watchOrders() {
      const unsubscribe = onSnapshot(
        window.getStoreCollection('orders'), 
        (snapshot) => {
          const currentCount = snapshot.size;
          
          if (!isFirstOrderLoad && currentCount > lastOrderCount) {
            playOrderSound();
          }
          
          lastOrderCount = currentCount;
          isFirstOrderLoad = false;
          
          loadOrders();
        }
      );
      
      return unsubscribe;
    }

    function watchWaiting() {
      const unsubscribe = onSnapshot(
        window.getStoreDoc('settings', 'waiting'), 
        (doc) => {
          if (doc.exists()) {
            const count = doc.data().manualCount || 0;
            document.getElementById('manual-count').textContent = count;
          }
        }
      );
      
      return unsubscribe;
    }
    
    // å¾…ã¡äººæ•°ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§æ›´æ–°ã™ã‚‹é–¢æ•°
    function watchTotalWaitingCount() {
      // ordersã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç›£è¦–
      onSnapshot(window.getStoreCollection('orders'), async () => {
        await updateTotalWaitingCount();
      });
      
      // settingsã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚‚ç›£è¦–
      onSnapshot(window.getStoreDoc('settings', 'waiting'), async () => {
        await updateTotalWaitingCount();
      });
    }
    
    async function updateTotalWaitingCount() {
      try {
        const ordersSnapshot = await getDocs(window.getStoreCollection('orders'));
        const now = new Date();
        const validOrders = new Set();
        
        ordersSnapshot.forEach(doc => {
          const data = doc.data();
          
          // å‰Šé™¤æ¸ˆã¿ã®æ³¨æ–‡ã¯é™¤å¤–
          if (data.deleted) return;
          
          // å®Œäº†æ¸ˆã¿ãƒ»ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿ã¯é™¤å¤–
          if (data.completedAt || data.cancelledAt) return;
          
          // deleteAtãŒã‚ã‚‹å ´åˆã€å‰Šé™¤äºˆå®šæ™‚åˆ»ã‚’éãã¦ã„ãŸã‚‰é™¤å¤–
          if (data.deleteAt && data.deleteAt.toDate() <= now) return;
          
          // æœ‰åŠ¹ãªæ³¨æ–‡ã¨ã—ã¦ã‚«ã‚¦ãƒ³ãƒˆ
          validOrders.add(data.orderNumber);
        });
        
        const settingsSnapshot = await getDocs(window.getStoreCollection('settings'));
        let manualCount = 0;
        settingsSnapshot.forEach(doc => {
          if (doc.id === 'waiting') {
            manualCount = doc.data().manualCount || 0;
          }
        });
        
        // å¾…ã¡äººæ•° = æœ‰åŠ¹æ³¨æ–‡æ•° + æ‰‹å‹•è¿½åŠ  + 1ï¼ˆæœ€ä½1çµ„ï¼‰
        const totalWaiting = validOrders.size + manualCount + 1;
        const waitingElem = document.getElementById('top-waiting');
        if (waitingElem) {
          waitingElem.textContent = totalWaiting;
        }
      } catch (error) {
        console.error('å¾…ã¡äººæ•°æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
      }
    }

    function watchStaffCalls() {
      let isFirstLoad = true;
      
      const storeId = window.currentStoreId || currentStoreId;
      const callsCollection = storeId 
        ? collection(db, 'stores', storeId, 'staff_calls')
        : window.getStoreCollection('staff_calls');
      
      const unsubscribe = onSnapshot(
        callsCollection,
        (snapshot) => {
        const container = document.getElementById('staff-calls-container');
        container.innerHTML = '';
        
        const calls = [];
        snapshot.forEach(doc => calls.push({ id: doc.id, ...doc.data() }));
        calls.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
        
        calls.forEach(call => {
          const isBill = call.type === 'bill';
          const card = document.createElement('div');
          card.className = 'staff-call-card';
          if (isBill) card.style.background = 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)';
          
          const orderNumberHtml = call.orderNumber 
            ? `<div style="font-size:20px;text-align:center;margin-top:8px;font-weight:bold;color:#fff;">æ³¨æ–‡ç•ªå·: #${call.orderNumber}</div>` 
            : '';
          
          card.innerHTML = `
            <div style="font-size:24px;text-align:center;font-weight:bold;">
              ${isBill ? 'ğŸ’³ ãŠä¼šè¨ˆã§ã™' : 'ğŸ“ å‘¼ã³å‡ºã—'}
            </div>
            <div class="staff-call-table">${call.tableNumber || 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ'}</div>
            ${orderNumberHtml}
            <button class="btn-reset" style="width:100%;margin-top:10px;" onclick="dismissCall('${call.id}')">å¯¾å¿œå®Œäº†</button>
          `;
          container.appendChild(card);
        });
        
        if (!isFirstLoad && calls.length > 0) {
          const isBill = calls[0].type === 'bill';
          if (isBill) playBillSound();
          else playCallSound();
        }
        isFirstLoad = false;
      });
      
      return unsubscribe;
    }

    window.dismissCall = async (id) => {
      try {
        const storeId = window.currentStoreId || currentStoreId;
        if (storeId) {
          await deleteDoc(doc(db, 'stores', storeId, 'staff_calls', id));
        } else {
          await deleteDoc(window.getStoreDoc('staff_calls', id));
        }
        showToast('âœ“ å¯¾å¿œå®Œäº†');
      } catch (error) {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
      }
    };

    function playOrderSound() {
      if (!audioEnabled) return;
      try {
        const audio = new Audio('./order.wav');
        audio.volume = 1.0;
        audio.play().catch(e => console.log('éŸ³å£°å†ç”Ÿå¤±æ•—:', e));
      } catch (e) {
        console.log('éŸ³å£°ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    function playCallSound() {
      if (!audioEnabled) return;
      try {
        const audio = new Audio('./call.wav');
        audio.volume = 1.0;
        audio.play().catch(e => console.log('éŸ³å£°å†ç”Ÿå¤±æ•—:', e));
      } catch (e) {
        console.log('éŸ³å£°ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    function playBillSound() {
      if (!audioEnabled) return;
      try {
        const audio = new Audio('./okaikei.wav');
        audio.volume = 1.0;
        audio.play().catch(e => console.log('éŸ³å£°å†ç”Ÿå¤±æ•—:', e));
      } catch (e) {
        console.log('éŸ³å£°ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    async function loadOrders() {
      const orders = [];
      const storeId = window.currentStoreId || currentStoreId;
      console.log('ğŸ”„ æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹ - åº—èˆ—ID:', storeId);
      
      const ordersCollection = storeId 
        ? collection(db, 'stores', storeId, 'orders')
        : window.getStoreCollection('orders');
      
      (await getDocs(ordersCollection)).forEach(doc => {
        const d = doc.data();
        
        console.log('ğŸ“‹ æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿:', {
          id: doc.id,
          orderNumber: d.orderNumber,
          tableNumber: d.tableNumber,
          hasItems: !!d.items,
          itemsLength: d.items ? d.items.length : 0,
          itemsChecked: d.itemsChecked,  // ğŸ†• ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’ãƒ­ã‚°
          items: d.items
        });
        
        // deletedãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã‚‹æ³¨æ–‡ã¯ã‚¹ã‚­ãƒƒãƒ—
        if (d.deleted) return;
        
        orders.push({
          id: doc.id,
          orderNumber: d.orderNumber,
          tableNumber: d.tableNumber,
          items: d.items,
          totalAmount: d.totalAmount,
          bagNeeded: d.bagNeeded || false,
          bagQuantity: d.bagQuantity || 0,
          bagPrice: d.bagPrice || 0,
          customerMemo: d.customerMemo || '',
          customerName: d.customerName || '',
          customerPostalCode: d.customerPostalCode || '',
          customerAddress: d.customerAddress || '',
          customerEmail: d.customerEmail || '',
          customerPhone: d.customerPhone || '',
          pickupTime: d.pickupTime || '',  // ğŸ†• å¼•å–æ™‚é–“
          memo: d.memo || {},
          itemsChecked: d.itemsChecked || [],  // ğŸ†• ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’è¿½åŠ 
          completedAt: d.completedAt || null,
          cancelledAt: d.cancelledAt || null,
          paidAt: d.paidAt || null
        });
      });
      
      const container = document.getElementById('orders-container');
      if (orders.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:white;padding:40px;">ç¾åœ¨æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = '';
      orders.sort((a, b) => a.orderNumber - b.orderNumber).forEach(order => {
        const card = document.createElement('div');
        card.className = 'order-card';
        
        let statusBadge = '';
        if (order.completedAt) {
          statusBadge = '<div style="background:#4CAF50;color:white;padding:5px 10px;border-radius:8px;display:inline-block;margin:5px 0;">âœ“ å®Œäº†æ¸ˆã¿</div>';
        } else if (order.cancelledAt) {
          statusBadge = '<div style="background:#f44336;color:white;padding:5px 10px;border-radius:8px;display:inline-block;margin:5px 0;">âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿</div>';
        }
        
        let paidBadge = '';
        if (order.paidAt) {
          paidBadge = '<div style="background:#2196F3;color:white;padding:5px 10px;border-radius:8px;display:inline-block;margin:5px 5px 5px 0;">ğŸ’³ ä¼šè¨ˆæ¸ˆ</div>';
        }
        
        let itemsHTML = '';
        let grandTotal = 0;
        
        order.items.forEach((item, idx) => {
          const memoText = order.memo?.[idx] || item.memo || '';
          const itemPrice = item.price || 0;
          const toppingPrice = item.toppingPrice || 0;
          const quantity = item.quantity || 1;
          const itemTotal = (itemPrice + toppingPrice) * quantity;
          grandTotal += itemTotal;
          
          const isChecked = order.itemsChecked && order.itemsChecked[idx];
          const checkboxId = `checkbox-${order.id}-${idx}`;
          
          // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’1è¡Œãšã¤è¡¨ç¤ºï¼ˆtoppingDetailsã¾ãŸã¯toppingsDataã‚’å„ªå…ˆï¼‰
          let toppingsHtml = '';
          if (item.toppingDetails && item.toppingDetails.length > 0) {
            // æ–°ã—ã„å½¢å¼: toppingDetailsãŒã‚ã‚‹å ´åˆï¼ˆPOSç”»é¢ã‹ã‚‰ï¼‰
            const groupedBySet = {};
            item.toppingDetails.forEach(detail => {
              if (!groupedBySet[detail.setName]) {
                groupedBySet[detail.setName] = [];
              }
              groupedBySet[detail.setName].push(detail.optionName);
            });
            
            toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
              return `
                <div class="order-item-toppings" style="font-weight: bold; color: #666;">${setName}</div>
                ${options.map(opt => `<div class="order-item-toppings" style="margin-left: 10px;">ãƒ»${opt}</div>`).join('')}
              `;
            }).join('');
          } else if (item.toppingsData && item.toppingsData.length > 0) {
            // ğŸ†• menu.htmlã‹ã‚‰ã®å½¢å¼: toppingsDataãŒã‚ã‚‹å ´åˆ
            const groupedBySet = {};
            item.toppingsData.forEach(topping => {
              const setName = topping.setName || 'ãƒˆãƒƒãƒ”ãƒ³ã‚°';
              if (!groupedBySet[setName]) {
                groupedBySet[setName] = [];
              }
              groupedBySet[setName].push(topping.name);
            });
            
            toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
              return `
                <div class="order-item-toppings" style="font-weight: bold; color: #666;">${setName}</div>
                ${options.map(opt => `<div class="order-item-toppings" style="margin-left: 10px;">ãƒ»${opt}</div>`).join('')}
              `;
            }).join('');
          } else if (item.toppings && item.toppings !== 'ãªã—' && item.toppings !== 'æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°') {
            // å¤ã„å½¢å¼: toppingsã®ã¿ã®å ´åˆ
            const toppingsList = item.toppings.split(',').map(t => t.trim());
            toppingsHtml = toppingsList.map(topping => 
              `<div class="order-item-toppings">ãƒ»${topping}</div>`
            ).join('');
          } else if (!item.selectedToppings || (Array.isArray(item.selectedToppings) && item.selectedToppings.length === 0)) {
            // ãƒˆãƒƒãƒ”ãƒ³ã‚°æœªé¸æŠã®å ´åˆã¯ã€Œæ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°ã€ã¨è¡¨ç¤º
            toppingsHtml = `<div class="order-item-toppings" style="color: #999;">æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°</div>`;
          }
          
          itemsHTML += `
            <div class="order-item" style="${isChecked ? 'opacity: 0.6; background: #e8f5e9;' : ''}">
              <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                <input type="checkbox" 
                       id="${checkboxId}" 
                       ${isChecked ? 'checked' : ''} 
                       onchange="window.toggleItemCheck('${order.id}', ${idx})"
                       style="width: 24px; height: 24px; cursor: pointer; flex-shrink: 0;">
                <div style="flex: 1; cursor: pointer;" onclick="document.getElementById('${checkboxId}').click()">
                  <div class="order-item-header">
                    <div class="order-item-name">${item.name} Ã— ${quantity}</div>
                    <div class="order-item-price">Â¥${itemPrice.toLocaleString()}</div>
                  </div>
                </div>
              </div>
              ${toppingsHtml}
              ${memoText ? `<div class="order-item-memo">ğŸ“ ${memoText}</div>` : ''}
              <div class="order-item-total">Â¥${itemPrice.toLocaleString()} Ã— ${quantity} = Â¥${itemTotal.toLocaleString()}</div>
            </div>
          `;
        });
        
        // ãƒ¬ã‚¸è¢‹æƒ…å ±ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ä»˜ãï¼‰
        console.log('æ³¨æ–‡#' + order.orderNumber + ' ãƒ¬ã‚¸è¢‹ãƒ‡ãƒ¼ã‚¿:', {
          bagNeeded: order.bagNeeded,
          bagQuantity: order.bagQuantity,
          bagPrice: order.bagPrice
        });
        
        if (order.bagNeeded && order.bagQuantity > 0) {
          const bagTotal = order.bagPrice || (order.bagQuantity * 3);
          const bagUnitPrice = Math.round(bagTotal / order.bagQuantity);
          grandTotal += bagTotal;
          console.log('ãƒ¬ã‚¸è¢‹ã‚’è¡¨ç¤º: ' + order.bagQuantity + 'æšã€åˆè¨ˆÂ¥' + bagTotal);
          itemsHTML += `
            <div class="order-item" style="background: #fff3e0;">
              <div class="order-item-header">
                <div class="order-item-name">ğŸ›ï¸ ãƒ¬ã‚¸è¢‹ Ã— ${order.bagQuantity}</div>
                <div class="order-item-price">Â¥${bagTotal.toLocaleString()}</div>
              </div>
              <div class="order-item-total">Â¥${bagUnitPrice} Ã— ${order.bagQuantity} = Â¥${bagTotal.toLocaleString()}</div>
            </div>
          `;
        } else {
          console.log('ãƒ¬ã‚¸è¢‹ãªã—');
        }
        
        // ãŠå®¢æ§˜ãƒ¡ãƒ¢ã‚’è¿½åŠ ï¼ˆpos.htmlã¨åŒã˜æ–¹å¼ï¼‰
        let customerInfoHTML = '';
        console.log('æ³¨æ–‡#' + order.orderNumber + ' ãŠå®¢æ§˜æƒ…å ±ãƒ‡ãƒ¼ã‚¿:', {
          customerMemo: order.customerMemo,
          customerName: order.customerName,
          customerPhone: order.customerPhone,
          pickupTime: order.pickupTime,  // ğŸ†•
          customerPostalCode: order.customerPostalCode,
          customerAddress: order.customerAddress,
          customerEmail: order.customerEmail
        });
        
        // ãƒ¡ãƒ¢
        if (order.customerMemo && order.customerMemo.trim() !== '') {
          console.log('âœ… ãŠå®¢æ§˜ãƒ¡ãƒ¢ã‚’è¡¨ç¤º: ' + order.customerMemo);
          customerInfoHTML += `
            <div class="order-item" style="background: #e3f2fd; border-left: 4px solid #2196F3; margin-bottom: 8px;">
              <div style="font-weight: bold; color: #1976D2; margin-bottom: 5px;">ãŠå®¢æ§˜ãƒ¡ãƒ¢</div>
              <div style="color: #333;">${order.customerMemo}</div>
            </div>
          `;
        }
        
        // åå‰
        if (order.customerName && order.customerName.trim() !== '') {
          customerInfoHTML += `
            <div class="order-item" style="background: #f3e5f5; border-left: 4px solid #9C27B0; margin-bottom: 8px;">
              <div style="font-weight: bold; color: #7B1FA2; margin-bottom: 5px;">ãŠåå‰</div>
              <div style="color: #333;">${order.customerName}</div>
            </div>
          `;
        }
        
        // é›»è©±ç•ªå·
        if (order.customerPhone && order.customerPhone.trim() !== '') {
          customerInfoHTML += `
            <div class="order-item" style="background: #e0f2f1; border-left: 4px solid #009688; margin-bottom: 8px;">
              <div style="font-weight: bold; color: #00796B; margin-bottom: 5px;">ğŸ“ é›»è©±ç•ªå·</div>
              <div style="color: #333;">${order.customerPhone}</div>
            </div>
          `;
        }
        
        // ğŸ†• å¼•å–æ™‚é–“
        if (order.pickupTime && order.pickupTime.trim() !== '') {
          customerInfoHTML += `
            <div class="order-item" style="background: #fff9c4; border-left: 4px solid #FFC107; margin-bottom: 8px;">
              <div style="font-weight: bold; color: #F57F17; margin-bottom: 5px;">ğŸ• å¼•å–æ™‚é–“</div>
              <div style="color: #333; font-size: 18px; font-weight: bold;">${order.pickupTime}</div>
            </div>
          `;
        }
        
        // éƒµä¾¿ç•ªå·
        if (order.customerPostalCode && order.customerPostalCode.trim() !== '') {
          customerInfoHTML += `
            <div class="order-item" style="background: #fff3e0; border-left: 4px solid #FF9800; margin-bottom: 8px;">
              <div style="font-weight: bold; color: #F57C00; margin-bottom: 5px;">éƒµä¾¿ç•ªå·</div>
              <div style="color: #333;">${order.customerPostalCode}</div>
            </div>
          `;
        }
        
        // ä½æ‰€
        if (order.customerAddress && order.customerAddress.trim() !== '') {
          customerInfoHTML += `
            <div class="order-item" style="background: #e8f5e9; border-left: 4px solid #4CAF50; margin-bottom: 8px;">
              <div style="font-weight: bold; color: #388E3C; margin-bottom: 5px;">ä½æ‰€</div>
              <div style="color: #333;">${order.customerAddress}</div>
            </div>
          `;
        }
        
        // ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
        if (order.customerEmail && order.customerEmail.trim() !== '') {
          customerInfoHTML += `
            <div class="order-item" style="background: #fce4ec; border-left: 4px solid #E91E63; margin-bottom: 8px;">
              <div style="font-weight: bold; color: #C2185B; margin-bottom: 5px;">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹</div>
              <div style="color: #333;">${order.customerEmail}</div>
            </div>
          `;
        }
        
        // å…¨å•†å“ãŒãƒã‚§ãƒƒã‚¯æ¸ˆã¿ã‹ã©ã†ã‹ã‚’åˆ¤å®š
        const allItemsChecked = order.items && order.items.length > 0 && 
          order.items.every((item, idx) => order.itemsChecked && order.itemsChecked[idx]);
        
        card.innerHTML = `
          <div class="order-number">#${order.orderNumber}</div>
          <div class="order-table">${order.tableNumber}</div>
          ${statusBadge}${paidBadge}
          ${customerInfoHTML}
          ${itemsHTML}
          <div class="order-total">
            <div class="order-total-label">å…¨ã¦ã®åˆè¨ˆé‡‘é¡</div>
            <div class="order-total-amount">Â¥${grandTotal.toLocaleString()}</div>
          </div>
          <div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
            <button class="control-btn btn-complete" style="font-size:11px;" data-order-id="${order.id}" data-table="${order.tableNumber}">âœ“å®Œäº†</button>
            <button class="control-btn btn-cancel" style="font-size:11px;" data-order-id="${order.id}" data-table="${order.tableNumber}">âœ•ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="control-btn" style="background:linear-gradient(135deg,#9C27B0 0%,#7B1FA2 100%);font-size:11px;" data-order-id="${order.id}">ğŸ“‹è©³ç´°</button>
          </div>
          <div style="margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <button class="control-btn" id="paid-btn-${order.id}" style="background:linear-gradient(135deg,${order.paidAt ? '#2196F3' : '#FFC107'} 0%,${order.paidAt ? '#1976D2' : '#FFA000'} 100%);font-size:11px;" data-order-id="${order.id}" data-table="${order.tableNumber}" data-paid="${order.paidAt ? 'true' : 'false'}">${order.paidAt ? 'ğŸ’³ æ¸ˆ' : 'ğŸ’³ æœª'}</button>
            <button class="control-btn" style="background:linear-gradient(135deg,#757575 0%,#616161 100%);font-size:11px;${!order.completedAt && !order.cancelledAt ? 'opacity:0.5;cursor:not-allowed;' : ''}" data-order-id="${order.id}" ${!order.completedAt && !order.cancelledAt ? 'disabled' : ''}>ğŸ—‘ï¸å‰Šé™¤</button>
          </div>
        `;
        
        const completeBtn = card.querySelector('.btn-complete');
        const cancelBtn = card.querySelector('.btn-cancel');
        const detailBtn = card.querySelectorAll('.control-btn')[2];
        const paidBtn = card.querySelectorAll('.control-btn')[3];
        const deleteBtn = card.querySelectorAll('.control-btn')[4];
        
        completeBtn.onclick = () => completeOrder(order.id, order.tableNumber, order.orderNumber);
        cancelBtn.onclick = () => cancelOrder(order.id, order.tableNumber, order.orderNumber);
        detailBtn.onclick = () => showOrderDetail(order);
        paidBtn.onclick = () => togglePaidStatus(order);
        
        if (order.completedAt || order.cancelledAt) {
          deleteBtn.onclick = () => deleteOrder(order.id);
        }
        
        container.appendChild(card);
      });
    }

    function showOrderDetail(order) {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        overflow-y: auto;
        padding: 20px 0;
      `;
      
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        background: white;
        border-radius: 15px;
        padding: 20px;
        max-width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      `;
      
      let itemsHtml = '';
      order.items.forEach((item, idx) => {
        const currentMemo = order.memo?.[idx] || item.memo || '';
        
        // ãƒˆãƒƒãƒ”ãƒ³ã‚°è¡¨ç¤ºã®æ”¹å–„
        let toppingsText = 'ãªã—';
        if (item.toppingDetails && item.toppingDetails.length > 0) {
          // POSç”»é¢ã‹ã‚‰
          const groupedBySet = {};
          item.toppingDetails.forEach(detail => {
            if (!groupedBySet[detail.setName]) {
              groupedBySet[detail.setName] = [];
            }
            groupedBySet[detail.setName].push(detail.optionName);
          });
          toppingsText = Object.entries(groupedBySet).map(([setName, options]) => {
            return `<b>${setName}</b>: ${options.join(', ')}`;
          }).join(' / ');
        } else if (item.toppingsData && item.toppingsData.length > 0) {
          // menu.htmlã‹ã‚‰
          const groupedBySet = {};
          item.toppingsData.forEach(topping => {
            const setName = topping.setName || 'ãƒˆãƒƒãƒ”ãƒ³ã‚°';
            if (!groupedBySet[setName]) {
              groupedBySet[setName] = [];
            }
            groupedBySet[setName].push(topping.name);
          });
          toppingsText = Object.entries(groupedBySet).map(([setName, options]) => {
            return `<b>${setName}</b>: ${options.join(', ')}`;
          }).join(' / ');
        } else if (item.toppings && item.toppings !== 'ãªã—' && item.toppings !== 'æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°') {
          toppingsText = item.toppings;
        } else if (!item.selectedToppings || (Array.isArray(item.selectedToppings) && item.selectedToppings.length === 0)) {
          toppingsText = 'æ¨™æº–ãƒˆãƒƒãƒ”ãƒ³ã‚°';
        }
        
        itemsHtml += `
          <div style="background:#f5f5f5;padding:15px;border-radius:10px;margin-bottom:10px;">
            <div style="font-size:16px;font-weight:bold;margin-bottom:5px;">${item.name} Ã— ${item.quantity}</div>
            <div style="font-size:14px;color:#666;margin-bottom:8px;">ğŸ´ ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${toppingsText}</div>
            <input type="text" 
                   id="memo-${idx}" 
                   value="${currentMemo}"
                   placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›(ã‚½ãƒ¼ã‚¹å¤šã‚ã€ãƒãƒ¨æŠœããªã©)"
                   style="width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;font-size:14px;">
          </div>
        `;
      });
      
      // ãƒ¬ã‚¸è¢‹æƒ…å ±ã‚’è¿½åŠ 
      if (order.bagNeeded && order.bagQuantity > 0) {
        const bagTotal = order.bagPrice || (order.bagQuantity * 3);
        const bagUnitPrice = Math.round(bagTotal / order.bagQuantity);
        itemsHtml += `
          <div style="background:#fff3e0;padding:15px;border-radius:10px;margin-bottom:10px;">
            <div style="font-size:16px;font-weight:bold;margin-bottom:5px;">ğŸ›ï¸ ãƒ¬ã‚¸è¢‹ Ã— ${order.bagQuantity}æš</div>
            <div style="font-size:14px;color:#666;">å˜ä¾¡: Â¥${bagUnitPrice} Ã— ${order.bagQuantity} = Â¥${bagTotal.toLocaleString()}</div>
          </div>
        `;
      }
      
      dialog.innerHTML = `
        <div style="font-size:20px;font-weight:bold;margin-bottom:15px;text-align:center;">
          æ³¨æ–‡ #${order.orderNumber} ã®è©³ç´°
        </div>
        <div style="text-align:center;margin-bottom:15px;">
          <span style="background:#2196F3;color:white;padding:5px 15px;border-radius:15px;">${order.tableNumber}</span>
        </div>
        ${itemsHtml}
        <div style="font-size:18px;font-weight:bold;text-align:right;margin:15px 0;color:#4CAF50;">
          åˆè¨ˆ: Â¥${order.totalAmount.toLocaleString()}
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <button id="save-memo-btn" style="
            padding:15px;
            background:#4CAF50;
            color:white;
            border:none;
            border-radius:10px;
            font-size:16px;
            font-weight:bold;
            cursor:pointer;
          ">ğŸ’¾ ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
          <button id="close-detail-btn" style="
            padding:15px;
            background:#757575;
            color:white;
            border:none;
            border-radius:10px;
            font-size:16px;
            font-weight:bold;
            cursor:pointer;
          ">é–‰ã˜ã‚‹</button>
        </div>
      `;
      
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);
      
      document.getElementById('save-memo-btn').onclick = async () => {
        const newMemo = {};
        order.items.forEach((item, idx) => {
          const input = document.getElementById(`memo-${idx}`);
          if (input && input.value.trim()) {
            newMemo[idx] = input.value.trim();
          }
        });
        
        await updateDoc(window.getStoreDoc('orders', order.id), { memo: newMemo });
        showToast('âœ“ ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        overlay.remove();
        loadOrders();
      };
      
      document.getElementById('close-detail-btn').onclick = () => overlay.remove();
    }

    async function completeOrder(orderId, tableNumber, orderNumber) {
      try {
        // æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦åœ¨åº«ã‚’æ¸›ã‚‰ã™
        const orderRef = window.getStoreDoc('orders', orderId);
        const orderSnap = await window.getDoc(orderRef);
        
        if (orderSnap.exists()) {
          const orderData = orderSnap.data();
          await decreaseInventory(orderData.items || []);
        }
        
        await updateDoc(window.getStoreDoc('orders', orderId), {
          status: 'completed',
          completedAt: Timestamp.now()
        });
        
        showToast('âœ“ å®Œäº†ã—ã¾ã—ãŸ');
        loadOrders();
      } catch (e) {
        console.error(e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }

    // å•†å“ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§é–¢æ•°ã‚’å®šç¾©
    async function toggleItemCheck(orderId, itemIndex) {
      console.log('ğŸ”„ toggleItemCheck called:', { orderId, itemIndex });
      
      // ã‚¿ãƒƒãƒ—éŸ³ã‚’å†ç”Ÿ
      playTapSound();
      
      try {
        const orderRef = window.getStoreDoc('orders', orderId);
        console.log('ğŸ“ orderRef:', orderRef);
        
        const orderSnap = await window.getDoc(orderRef);
        
        if (!orderSnap.exists()) {
          console.error('âŒ æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', orderId);
          showToast('æ³¨æ–‡ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        const orderData = orderSnap.data();
        const itemsChecked = orderData.itemsChecked || [];
        
        console.log('ğŸ“‹ ç¾åœ¨ã®ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹:', itemsChecked);
        
        // ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’åè»¢
        itemsChecked[itemIndex] = !itemsChecked[itemIndex];
        
        console.log('ğŸ”„ æ–°ã—ã„ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹:', itemsChecked);
        
        // Firestoreã«ä¿å­˜
        await window.updateDoc(orderRef, {
          itemsChecked: itemsChecked
        });
        
        console.log('âœ… å•†å“ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹ã‚’æ›´æ–°:', orderId, 'item', itemIndex, '=', itemsChecked[itemIndex]);
        showToast(`âœ“ ${itemsChecked[itemIndex] ? 'ãƒã‚§ãƒƒã‚¯' : 'ãƒã‚§ãƒƒã‚¯è§£é™¤'}ã—ã¾ã—ãŸ`);
        
        // æ³¨æ–‡ä¸€è¦§ã‚’å†èª­ã¿è¾¼ã¿
        loadOrders();
      } catch (e) {
        console.error('âŒ ãƒã‚§ãƒƒã‚¯çŠ¶æ…‹æ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
        showToast('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + e.message);
      }
    }
    
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹
    window.toggleItemCheck = toggleItemCheck;

    // ğŸ†• åœ¨åº«ã‚’æ¸›ã‚‰ã™
    async function decreaseInventory(items) {
      try {
        const inventoryRef = window.getStoreDoc('inventory_settings', 'default');
        const inventorySnap = await window.getDoc(inventoryRef);
        
        if (!inventorySnap.exists()) {
          console.log('âš ï¸ åœ¨åº«è¨­å®šãŒå­˜åœ¨ã—ã¾ã›ã‚“');
          return;
        }
        
        const inventoryData = inventorySnap.data();
        const inventorySettings = inventoryData.items || {};
        let updated = false;
        
        for (const item of items) {
          const menuItemId = item.id;
          const quantity = item.quantity || 1;
          
          if (inventorySettings[menuItemId]) {
            const currentStock = inventorySettings[menuItemId].stock;
            
            // åœ¨åº«ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã®ã¿æ¸›ã‚‰ã™
            if (currentStock !== null && currentStock !== undefined) {
              const newStock = Math.max(0, currentStock - quantity);
              inventorySettings[menuItemId].stock = newStock;
              updated = true;
              
              console.log(`ğŸ“¦ åœ¨åº«æ¸›å°‘: ${item.name} ${currentStock} â†’ ${newStock} (${quantity}å€‹ä½¿ç”¨)`);
              
              // åœ¨åº«ãŒ0ã«ãªã£ãŸå ´åˆã€è‡ªå‹•çš„ã«å“åˆ‡ã‚Œã«ã™ã‚‹
              if (newStock === 0) {
                console.log(`âš ï¸ åœ¨åº«åˆ‡ã‚Œ: ${item.name}`);
                try {
                  const menuRef = window.getStoreDoc('menus', menuItemId);
                  await updateDoc(menuRef, {
                    isSoldOut: true
                  });
                  console.log(`âœ… è‡ªå‹•å“åˆ‡ã‚Œè¨­å®š: ${item.name}`);
                } catch (e) {
                  console.error('å“åˆ‡ã‚Œè¨­å®šã‚¨ãƒ©ãƒ¼:', e);
                }
              }
            }
          }
        }
        
        // åœ¨åº«ã‚’æ›´æ–°
        if (updated) {
          await updateDoc(inventoryRef, {
            items: inventorySettings,
            updatedAt: new Date().toISOString()
          });
          console.log('âœ… åœ¨åº«ã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        }
      } catch (error) {
        console.error('âŒ åœ¨åº«æ¸›å°‘ã‚¨ãƒ©ãƒ¼:', error);
      }
    }


    async function cancelOrder(orderId, tableNumber, orderNumber) {
      try {
        await updateDoc(window.getStoreDoc('orders', orderId), {
          cancelledAt: Timestamp.now()
        });
        
        showToast('âœ“ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        loadOrders();
      } catch (e) {
        console.error(e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }

    async function deleteOrder(orderId) {
      try {
        // deleteDocã§ã¯ãªãdeletedãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
        await updateDoc(window.getStoreDoc('orders', orderId), {
          deleted: true,
          deletedAt: Timestamp.now()
        });
        showToast('âœ“ æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        loadOrders();
      } catch (e) {
        console.error(e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }

    let currentPaymentOrder = null;
    let selectedPaymentMethod = null;
    
    async function togglePaidStatus(order) {
      console.log('ğŸ”µ togglePaidStatuså‘¼ã³å‡ºã—');
      console.log('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿:', order);
      
      try {
        if (order.paidAt) {
          console.log('ä¼šè¨ˆæ¸ˆã¿ â†’ æœªæ¸ˆã«æˆ»ã™å‡¦ç†');
          const confirmed = await showConfirmDialog('ä¼šè¨ˆã‚’æœªæ¸ˆã«æˆ»ã—ã¾ã™ã‹?');
          if (!confirmed) return;
          
          await updateDoc(window.getStoreDoc('orders', order.id), {
            paidAt: null
          });
          
          showToast('âœ“ ä¼šè¨ˆã‚’æœªæ¸ˆã«æˆ»ã—ã¾ã—ãŸ');
          loadOrders();
        } else {
          console.log('æœªæ¸ˆ â†’ æ”¯æ‰•ã„æ–¹æ³•é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º');
          // æ”¯æ‰•ã„æ–¹æ³•é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          currentPaymentOrder = order;
          selectedPaymentMethod = null;
          
          console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ å–å¾—ä¸­...');
          const modal = document.getElementById('paymentModal');
          console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ :', modal);
          
          if (!modal) {
            console.error('âŒ paymentModalãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼');
            showToast('ã‚¨ãƒ©ãƒ¼: æ”¯æ‰•ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
          }
          
          modal.classList.add('show');
          console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå®Œäº†');
          
          // é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
          document.querySelectorAll('.payment-method-btn').forEach(btn => {
            btn.classList.remove('selected');
          });
        }
      } catch (e) {
        console.error('âŒ togglePaidStatusã‚¨ãƒ©ãƒ¼:', e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }
    
    window.selectPaymentMethod = function(method, button) {
      console.log('ğŸ”µ selectPaymentMethodå‘¼ã³å‡ºã—:', method);
      selectedPaymentMethod = method;
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      if (button) {
        button.classList.add('selected');
        console.log('âœ… ãƒœã‚¿ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«ã—ã¾ã—ãŸ');
      }
    }
    
    window.closePaymentModal = function() {
      document.getElementById('paymentModal').classList.remove('show');
      currentPaymentOrder = null;
      selectedPaymentMethod = null;
    }
    
    window.confirmPayment = async function() {
      console.log('ğŸ”µ confirmPaymenté–‹å§‹');
      console.log('selectedPaymentMethod:', selectedPaymentMethod);
      console.log('currentPaymentOrder:', currentPaymentOrder);
      
      if (!selectedPaymentMethod) {
        console.log('âŒ æ”¯æ‰•ã„æ–¹æ³•æœªé¸æŠ');
        showToast('æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!currentPaymentOrder) {
        console.log('âŒ æ³¨æ–‡æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        showToast('ã‚¨ãƒ©ãƒ¼: æ³¨æ–‡æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      try {
        const order = currentPaymentOrder;
        console.log('ğŸ“ æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿:', order);
        
        // æ‹…å½“è€…åï¼ˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‹ã‚‰ã¯å›ºå®šï¼‰
        const staffName = 'ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼';
        
        // æ³¨æ–‡ã‚’ä¼šè¨ˆæ¸ˆã¿ã«æ›´æ–°
        console.log('ğŸ’¾ Firestoreæ›´æ–°ä¸­...');
        await updateDoc(window.getStoreDoc('orders', order.id), {
          paidAt: Timestamp.now(),
          notifiedPaid: true,
          paymentMethod: selectedPaymentMethod,
          staffName: staffName
        });
        console.log('âœ… Firestoreæ›´æ–°å®Œäº†');
        
        // å•†å“ç‚¹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        let itemCount = 0;
        let tax8Total = 0;
        let tax10Total = 0;
        
        console.log('ğŸ” order.items:', order.items);
        
        if (order.items && Array.isArray(order.items)) {
          order.items.forEach(item => {
            console.log('ğŸ“¦ å•†å“:', item);
            itemCount += item.quantity || 0;
            
            // å•†å“ã”ã¨ã®é‡‘é¡ã‚’è¨ˆç®—ï¼ˆãƒˆãƒƒãƒ”ãƒ³ã‚°è¾¼ã¿ï¼‰
            const basePrice = item.price || 0;
            const toppingPrice = item.toppingPrice || 0;
            const totalPrice = basePrice + toppingPrice;
            const itemTotal = totalPrice * (item.quantity || 0);
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã«ã‚ˆã‚‹ç¨ç‡åˆ¤å®š
            const tableNumber = order.tableNumber || '';
            const itemName = item.name || '';
            
            console.log('ğŸ” ç¨ç‡åˆ¤å®š:', {
              å•†å“: itemName,
              ãƒ†ãƒ¼ãƒ–ãƒ«: tableNumber,
              é‡‘é¡: itemTotal
            });
            
            // ã€10%ã€‘åº—å†…ãƒ†ãƒ¼ãƒ–ãƒ«: c1, c2, T-M, T-H ã®ã¿
            if (tableNumber.match(/^(c1|c2|T-M|T-H)$/)) {
              tax10Total += itemTotal;
              console.log('â†’ 10%é©ç”¨ï¼ˆåº—å†…ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰');
            }
            // ã€10%ã€‘ãƒ¬ã‚¸è¢‹ï¼ˆã©ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã‚‚ï¼‰
            else if (itemName.includes('ãƒ¬ã‚¸è¢‹') || itemName.includes('è¢‹')) {
              tax10Total += itemTotal;
              console.log('â†’ 10%é©ç”¨ï¼ˆãƒ¬ã‚¸è¢‹ï¼‰');
            }
            // ã€8%ã€‘å³ä¼šè¨ˆã€ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã€äºˆç´„1-5ãªã©å…¨ã¦
            else {
              tax8Total += itemTotal;
              console.log('â†’ 8%é©ç”¨ï¼ˆæŒã¡å¸°ã‚Šï¼‰');
            }
          });
        } else {
          console.log('âŒ order.itemsãŒé…åˆ—ã§ã¯ãªã„ or å­˜åœ¨ã—ãªã„');
        }
        
        // ãƒ¬ã‚¸è¢‹ã‚’è¿½åŠ ï¼ˆåˆ¥é€”ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ï¼‰
        if (order.bagNeeded && order.bagQuantity > 0) {
          const bagTotal = order.bagPrice || (order.bagQuantity * 3);
          itemCount += order.bagQuantity;
          tax10Total += bagTotal;
          console.log('ğŸ›ï¸ ãƒ¬ã‚¸è¢‹è¿½åŠ :', {
            æšæ•°: order.bagQuantity,
            é‡‘é¡: bagTotal,
            ç¨ç‡: '10%'
          });
        }
        
        console.log('ğŸ“¦ ä¼šè¨ˆå•†å“ç‚¹æ•°:', itemCount);
        console.log('ğŸ’° ç¨ç‡åˆ¥å£²ä¸Š:', { tax8Total, tax10Total });
        
        // æ—¥æ¬¡å£²ä¸Šã‚’æ›´æ–°ï¼ˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‹ã‚‰ã¯å€¤å¼•ããªã—ï¼‰
        console.log('ğŸ’¾ æ—¥æ¬¡å£²ä¸Šæ›´æ–°ä¸­...');
        await updateDailySales(order.totalAmount, selectedPaymentMethod, itemCount, tax8Total, tax10Total, 0, order.items);
        console.log('âœ… æ—¥æ¬¡å£²ä¸Šæ›´æ–°å®Œäº†');
        
        closePaymentModal();
        showToast('âœ“ ä¼šè¨ˆæ¸ˆã¿ã«ã—ã¾ã—ãŸ');
        loadOrders();
      } catch (e) {
        console.error('âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:', e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }
    
    // æ—¥æ¬¡å£²ä¸Šæ›´æ–°é–¢æ•°
    async function updateDailySales(totalAmount, paymentMethod, itemCount, tax8Total, tax10Total, discountAmount = 0, items = []) {
      try {
        // åˆå‰3æ™‚åŸºæº–ã§æ—¥ä»˜ã‚’æ±ºå®šï¼ˆãƒ¬ã‚¸ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        const now = new Date();
        let targetDate = new Date(now);
        
        // åˆå‰3æ™‚ã‚ˆã‚Šå‰ãªã‚‰æ˜¨æ—¥æ‰±ã„
        if (now.getHours() < 3) {
          targetDate.setDate(targetDate.getDate() - 1);
        }
        
        const dateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth()+1).padStart(2,'0')}-${String(targetDate.getDate()).padStart(2,'0')}`;
        
        console.log('ğŸ“Š æ—¥æ¬¡å£²ä¸Šæ›´æ–°é–‹å§‹:', { dateStr, totalAmount, paymentMethod, itemCount, tax8Total, tax10Total, discountAmount });
        
        const salesRef = doc(db, 'dailySales', dateStr);
        const salesDoc = await getDoc(salesRef);
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          console.log('æ—¢å­˜ãƒ‡ãƒ¼ã‚¿:', data);
          
          // å•†å“åˆ¥ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨ˆç®—
          const currentItemCounts = data.itemCounts || {};
          items.forEach(item => {
            const itemName = item.name;
            currentItemCounts[itemName] = (currentItemCounts[itemName] || 0) + item.quantity;
          });
          
          const updates = {
            totalSales: (data.totalSales || 0) + totalAmount,
            customerCount: (data.customerCount || 0) + 1,
            totalItems: (data.totalItems || 0) + itemCount,
            tax8Total: (data.tax8Total || 0) + tax8Total,
            tax10Total: (data.tax10Total || 0) + tax10Total,
            totalDiscount: (data.totalDiscount || 0) + discountAmount,
            itemCounts: currentItemCounts,
            drawerOpenCount: data.drawerOpenCount || 0,
            cashSales: data.cashSales || 0,
            emoneSales: data.emoneSales || 0,
            creditSales: data.creditSales || 0,
            updatedAt: Timestamp.now()
          };
          
          // æ”¯æ‰•ã„æ–¹æ³•åˆ¥ã®å£²ä¸Šã‚’åŠ ç®—
          if (paymentMethod === 'cash') {
            updates.cashSales += totalAmount;
          } else if (paymentMethod === 'emoney') {
            updates.emoneSales += totalAmount;
          } else if (paymentMethod === 'credit') {
            updates.creditSales += totalAmount;
          }
          
          await updateDoc(salesRef, updates);
          console.log('âœ… æ—¢å­˜å£²ä¸Šãƒ‡ãƒ¼ã‚¿æ›´æ–°:', updates);
          
        } else {
          // å•†å“åˆ¥ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨ˆç®—
          const newItemCounts = {};
          items.forEach(item => {
            const itemName = item.name;
            newItemCounts[itemName] = (newItemCounts[itemName] || 0) + item.quantity;
          });
          
          const newData = {
            date: dateStr,
            totalSales: totalAmount,
            customerCount: 1,
            totalItems: itemCount,
            tax8Total: tax8Total,
            tax10Total: tax10Total,
            totalDiscount: discountAmount,
            itemCounts: newItemCounts,
            cashSales: paymentMethod === 'cash' ? totalAmount : 0,
            emoneSales: paymentMethod === 'emoney' ? totalAmount : 0,
            creditSales: paymentMethod === 'credit' ? totalAmount : 0,
            drawerOpenCount: 0,
            createdAt: Timestamp.now(),
            updatedAt: Timestamp.now()
          };
          
          await setDoc(salesRef, newData);
          console.log('âœ… æ–°è¦å£²ä¸Šãƒ‡ãƒ¼ã‚¿ä½œæˆ:', newData);
        }
        
        // æ›´æ–°å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ç¢ºèª
        const updatedDoc = await getDoc(salesRef);
        console.log('æ›´æ–°å¾Œã®ãƒ‡ãƒ¼ã‚¿:', updatedDoc.data());
        
      } catch (error) {
        console.error('âŒ æ—¥æ¬¡å£²ä¸Šæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
      }
    }


    window.toggleTimeOverride = async function() {
      const btn = document.getElementById('time-override-btn');
      
      try {
        const settingsRef = window.getStoreDoc('settings', 'timeOverride');
        const settingsSnap = await getDoc(settingsRef);
        const currentOverride = settingsSnap.exists() ? settingsSnap.data().enabled : false;
        
        const newOverride = !currentOverride;
        
        await setDoc(settingsRef, {
          enabled: newOverride,
          timestamp: Timestamp.now()
        });
        
        if (newOverride) {
          // å–¶æ¥­æ™‚é–“å¤–ã§ã‚‚æ³¨æ–‡å¯èƒ½ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰æœ‰åŠ¹ï¼‰
          btn.textContent = 'å–¶æ¥­';
          btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
          showToast('âœ“ å–¶æ¥­æ™‚é–“å¤–ã§ã‚‚æ³¨æ–‡å¯èƒ½ã«ã—ã¾ã—ãŸ');
        } else {
          // å–¶æ¥­æ™‚é–“å¤–ãƒã‚§ãƒƒã‚¯æœ‰åŠ¹ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ç„¡åŠ¹ï¼‰
          btn.textContent = 'æ™‚å¤–';
          btn.style.background = 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)';
          showToast('âœ“ å–¶æ¥­æ™‚é–“å¤–ãƒã‚§ãƒƒã‚¯ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸ');
        }
      } catch (e) {
        console.error(e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    };
    
    async function loadTimeOverrideStatus() {
      try {
        const settingsRef = window.getStoreDoc('settings', 'timeOverride');
        const settingsSnap = await getDoc(settingsRef);
        const overrideEnabled = settingsSnap.exists() ? settingsSnap.data().enabled : false;
        
        const btn = document.getElementById('time-override-btn');
        if (overrideEnabled) {
          // å–¶æ¥­æ™‚é–“å¤–ã§ã‚‚æ³¨æ–‡å¯èƒ½ï¼ˆç·‘ï¼‰
          btn.textContent = 'å–¶æ¥­';
          btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
        } else {
          // å–¶æ¥­æ™‚é–“å¤–ãƒã‚§ãƒƒã‚¯æœ‰åŠ¹ï¼ˆç´«ï¼‰
          btn.textContent = 'æ™‚å¤–';
          btn.style.background = 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)';
        }
      } catch (e) {
        console.error('æ™‚é–“ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    function showConfirmDialog(message) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
        `;
        
        const dialog = document.createElement('div');
        dialog.style.cssText = `
          background: white;
          border-radius: 15px;
          padding: 30px;
          max-width: 80%;
          text-align: center;
          box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        `;
        
        const text = document.createElement('div');
        text.textContent = message;
        text.style.cssText = `
          font-size: 18px;
          margin-bottom: 20px;
          color: #333;
        `;
        
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = `
          display: flex;
          gap: 10px;
          justify-content: center;
        `;
        
        const okButton = document.createElement('button');
        okButton.textContent = 'OK';
        okButton.style.cssText = `
          padding: 12px 30px;
          background: #2196F3;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight:bold;
          cursor: pointer;
        `;
        okButton.onclick = () => {
          overlay.remove();
          resolve(true);
        };
        
        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
        cancelButton.style.cssText = `
          padding: 12px 30px;
          background: #757575;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
        `;
        cancelButton.onclick = () => {
          overlay.remove();
          resolve(false);
        };
        
        buttonContainer.appendChild(okButton);
        buttonContainer.appendChild(cancelButton);
        dialog.appendChild(text);
        dialog.appendChild(buttonContainer);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
      });
    }

    window.increaseWaiting = async () => {
      const ref = window.getStoreDoc('settings', 'waiting');
      const snapshot = await getDocs(window.getStoreCollection('settings'));
      let count = 0;
      snapshot.forEach(d => { if (d.id === 'waiting') count = d.data().manualCount || 0; });
      await setDoc(ref, { manualCount: count + 1 });
      showToast('âœ“ å¾…ã¡+1');
    };

    window.resetWaiting = async () => {
      await setDoc(window.getStoreDoc('settings', 'waiting'), { manualCount: 0 });
      showToast('âœ“ ãƒªã‚»ãƒƒãƒˆ');
    };

    function showToast(msg) {
      const toast = document.createElement('div');
      toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);color:white;padding:30px 50px;border-radius:15px;font-size:24px;font-weight:bold;z-index:10000;';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }
    
    // ========== ãƒãƒƒãƒˆå›ç·šç›£è¦– ==========
    
    let isOffline = false;
    let offlineNotificationShown = false;
    
    // ãƒãƒƒãƒˆå›ç·šã®çŠ¶æ…‹ã‚’ç›£è¦–
    function checkOnlineStatus() {
      if (!navigator.onLine && !isOffline) {
        isOffline = true;
        showOfflineNotification();
      } else if (navigator.onLine && isOffline) {
        isOffline = false;
        hideOfflineNotification();
        showToast('âœ“ ãƒãƒƒãƒˆå›ç·šãŒå¾©æ—§ã—ã¾ã—ãŸ');
      }
    }
    
    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³é€šçŸ¥ã‚’è¡¨ç¤º
    function showOfflineNotification() {
      if (offlineNotificationShown) return;
      offlineNotificationShown = true;
      
      const notification = document.createElement('div');
      notification.id = 'offline-notification';
      notification.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);
        color: white;
        padding: 20px;
        text-align: center;
        z-index: 9999;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      `;
      
      notification.innerHTML = `
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">
          âš ï¸ ãƒãƒƒãƒˆå›ç·šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ
        </div>
        <div style="font-size: 14px; margin-bottom: 15px;">
          éŸ³å£°é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™
        </div>
        <button onclick="enableAudioNotification()" style="
          padding: 12px 30px;
          background: white;
          color: #c92a2a;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        ">
          ğŸ”Š éŸ³å£°ã‚’æœ‰åŠ¹ã«ã™ã‚‹
        </button>
      `;
      
      document.body.appendChild(notification);
      showToast('âš ï¸ ãƒãƒƒãƒˆå›ç·šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
    }
    
    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³é€šçŸ¥ã‚’éè¡¨ç¤º
    function hideOfflineNotification() {
      const notification = document.getElementById('offline-notification');
      if (notification) {
        notification.remove();
        offlineNotificationShown = false;
      }
    }
    
    // éŸ³å£°é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹
    window.enableAudioNotification = function() {
      // éŸ³å£°ã‚’å†ç”Ÿã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨˜éŒ²
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGi77eifTRAMUKjj8LZjHAY4ktfyzXksBS'
      );
      audio.play().then(() => {
        showToast('âœ“ éŸ³å£°é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
        hideOfflineNotification();
      }).catch(e => {
        showToast('éŸ³å£°ã®æœ‰åŠ¹åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    };
    
    // åˆå›ãƒã‚§ãƒƒã‚¯
    checkOnlineStatus();
    
    // å®šæœŸçš„ã«ãƒã‚§ãƒƒã‚¯ï¼ˆ5ç§’ã”ã¨ï¼‰
    setInterval(checkOnlineStatus, 5000);
    
    // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³
    window.addEventListener('online', checkOnlineStatus);
    window.addEventListener('offline', checkOnlineStatus);

    window.loadOrders = loadOrders;
  </script>
  
  <!-- æ”¯æ‰•ã„æ–¹æ³•é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="paymentModal" class="payment-modal-overlay">
    <div class="payment-modal">
      <h3>ğŸ’³ æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠ</h3>
      <div id="paymentMethodsList">
        <button class="payment-method-btn" data-method="cash" onclick="selectPaymentMethod('cash', this)">ğŸ’µ ç¾é‡‘</button>
        <button class="payment-method-btn" data-method="emoney" onclick="selectPaymentMethod('emoney', this)">ğŸ“± é›»å­ãƒãƒãƒ¼</button>
        <button class="payment-method-btn" data-method="credit" onclick="selectPaymentMethod('credit', this)">ğŸ’³ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</button>
      </div>
      <div class="payment-modal-buttons">
        <button class="payment-modal-btn confirm" onclick="confirmPayment()">ä¼šè¨ˆå®Œäº†</button>
        <button class="payment-modal-btn cancel" onclick="closePaymentModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>
  </div> <!-- mainContent -->
  
  <script>
    // ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ï¼‰
    async function handleLogin(event) {
      event.preventDefault();
      
      const storeName = document.getElementById('storeNameInput').value.trim();
      const password = document.getElementById('passwordInput').value;
      const loginError = document.getElementById('loginError');
      
      try {
        // æ—§ã‚·ã‚¹ãƒ†ãƒ èªè¨¼ï¼ˆä¸‹èµ¤å¡šåº—ï¼‰
        if (storeName === 'ä¸‹èµ¤å¡š' && password === 'K12290619T') {
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('mainContent').style.display = 'block';
          sessionStorage.setItem('controllerAuth', 'true');
          
          console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ˆæ—§ã‚·ã‚¹ãƒ†ãƒ ï¼‰');
          return false;
        }
        
        // æ–°ã‚·ã‚¹ãƒ†ãƒ èªè¨¼
        const storesRef = collection(db, 'stores');
        const q = query(storesRef, where('storeName', '==', storeName));
        const snapshot = await getDocs(q);
        
        if (!snapshot.empty) {
          let found = false;
          snapshot.forEach(doc => {
            const data = doc.data();
            if (data.storePassword === password && data.isActive) {
              found = true;
              window.currentStoreId = doc.id;
              window.currentStoreName = data.storeName;
            }
          });
          
          if (found) {
            currentStoreId = window.currentStoreId;
            currentStoreName = window.currentStoreName;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            sessionStorage.setItem('controllerAuth', 'true');
            sessionStorage.setItem('controllerStoreId', currentStoreId);
            sessionStorage.setItem('controllerStoreName', currentStoreName);
            
            console.log('âœ… ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', currentStoreName);
            return false;
          }
        }
        
        loginError.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ';
        loginError.style.display = 'block';
      } catch (error) {
        console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
        loginError.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + error.message;
        loginError.style.display = 'block';
      }
      
      return false;
    }
    
    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
    async function handleControllerLogout() {
      const confirmed = await showCustomConfirm({
        icon: 'ğŸšª',
        title: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ',
        message: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ\nä¿å­˜ã•ã‚Œã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿ã¯å¤±ã‚ã‚Œã¾ã™ã€‚',
        btnText: 'ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ'
      });
      
      if (confirmed) {
        sessionStorage.removeItem('controllerAuth');
        sessionStorage.removeItem('controllerStoreId');
        sessionStorage.removeItem('controllerStoreName');
        window.currentStoreId = null;
        window.currentStoreName = null;
        
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'none';
        
        // å…¥åŠ›ã‚’ã‚¯ãƒªã‚¢
        document.getElementById('storeNameInput').value = '';
        document.getElementById('passwordInput').value = '';
        
        console.log('âœ… ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå®Œäº†');
      }
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®èªè¨¼ãƒã‚§ãƒƒã‚¯
    window.addEventListener('DOMContentLoaded', () => {
      const isAuth = sessionStorage.getItem('controllerAuth');
      const savedStoreId = sessionStorage.getItem('controllerStoreId');
      const savedStoreName = sessionStorage.getItem('controllerStoreName');
      
      if (isAuth === 'true') {
        currentStoreId = savedStoreId || null;
        currentStoreName = savedStoreName || null;
        window.currentStoreId = currentStoreId;
        window.currentStoreName = currentStoreName;
        
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
        console.log('âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒ:', currentStoreName);
      } else {
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'none';
      }
    });
  </script>
  
  <!-- ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="customModalOverlay" class="custom-modal-overlay">
    <div class="custom-modal">
      <div class="custom-modal-icon" id="customModalIcon">â“</div>
      <div class="custom-modal-title" id="customModalTitle">ç¢ºèª</div>
      <div class="custom-modal-message" id="customModalMessage">ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸</div>
      <div class="custom-modal-buttons" id="customModalButtons">
        <button class="custom-modal-btn custom-modal-btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="custom-modal-btn custom-modal-btn-confirm">ç¢ºèª</button>
      </div>
    </div>
  </div>
  
  <script>
    // ã‚«ã‚¹ã‚¿ãƒ ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢æ•°
    function showCustomConfirm(options) {
      return new Promise((resolve) => {
        const overlay = document.getElementById('customModalOverlay');
        const icon = document.getElementById('customModalIcon');
        const title = document.getElementById('customModalTitle');
        const message = document.getElementById('customModalMessage');
        const buttonsDiv = document.getElementById('customModalButtons');
        
        icon.textContent = options.icon || 'â“';
        title.textContent = options.title || 'ç¢ºèª';
        message.textContent = options.message || '';
        
        buttonsDiv.innerHTML = '';
        
        const cancelBtn = document.createElement('button');
        cancelBtn.className = 'custom-modal-btn custom-modal-btn-cancel';
        cancelBtn.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
        cancelBtn.onclick = () => {
          overlay.classList.remove('active');
          resolve(false);
        };
        
        const confirmBtn = document.createElement('button');
        confirmBtn.className = 'custom-modal-btn custom-modal-btn-confirm';
        confirmBtn.textContent = options.btnText || 'ç¢ºèª';
        confirmBtn.onclick = () => {
          overlay.classList.remove('active');
          resolve(true);
        };
        
        buttonsDiv.appendChild(cancelBtn);
        buttonsDiv.appendChild(confirmBtn);
        
        overlay.classList.add('active');
        
        // ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        overlay.onclick = (e) => {
          if (e.target === overlay) {
            overlay.classList.remove('active');
            resolve(false);
          }
        };
      });
    }
  </script>
  
</body>
</html>
