<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ³¨æ–‡ç®¡ç†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼</title>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 15px;
      min-height: 100vh;
    }
    .header {
      background: white;
      color: #667eea;
      padding: 15px 20px;
      border-radius: 15px;
      margin-bottom: 15px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .header h1 { font-size: 20px; font-weight: bold; }
    .top-controls { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .big-btn {
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: all 0.3s;
      color: white;
    }
    .big-btn:active { transform: scale(0.95); }
    .btn-refresh { background: #FFFF00; color: #333; }
    .btn-add-waiting { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); }
    .btn-soldout { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
    .manual-waiting-card {
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
    }
    .manual-waiting-label {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      white-space: nowrap;
    }
    .manual-count { 
      font-size: 32px; 
      font-weight: bold; 
      color: #FF9800; 
      flex: 1;
      text-align: center;
    }
    .btn-reset {
      padding: 12px 25px;
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      white-space: nowrap;
    }
    .order-card { 
      background: white; 
      border-radius: 12px; 
      padding: 15px; 
      margin-bottom: 15px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      position: relative;
    }
    .order-number { font-size: 28px; font-weight: bold; color: #4CAF50; }
    .order-table {
      display: inline-block;
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      padding: 6px 15px;
      border-radius: 15px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .order-item {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
    }
    .order-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .order-item-name {
      font-size: 16px;
      font-weight: bold;
    }
    .order-item-price {
      font-size: 14px;
      color: #666;
    }
    .order-item-toppings {
      font-size: 14px;
      color: #666;
      margin: 4px 0;
      padding-left: 10px;
      line-height: 1.8;
    }
    .order-item-total {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      text-align: right;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #ddd;
    }
    .order-item-memo {
      font-size: 12px;
      color: #f44336;
      margin-top: 5px;
      padding-left: 10px;
    }
    .order-total {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      text-align: right;
    }
    .order-total-label {
      font-size: 18px;
      font-weight: bold;
      color: #1976D2;
    }
    .order-total-amount {
      font-size: 24px;
      font-weight: bold;
      color: #1976D2;
      margin-top: 5px;
    }
    .control-btn {
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      color: white;
      margin: 5px;
    }
    .btn-complete { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); }
    .btn-cancel { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); }
    .staff-call-card {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      animation: pulse 1s infinite;
    }
    .staff-call-table { font-size: 48px; font-weight: bold; text-align: center; margin: 10px 0; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
    .hidden { display: none; }
    .category-filter {
      background: white;
      padding: 15px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .category-filter select {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      border: 3px solid #9C27B0;
      border-radius: 12px;
    }
    .soldout-item {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .soldout-item.sold-out { background: #f5f5f5; opacity: 0.7; }
    .soldout-item-name { font-size: 16px; font-weight: bold; color: #333; }
    .soldout-badge { background: #f44336; color: white; padding: 5px 10px; border-radius: 8px; font-size: 12px; font-weight: bold; margin-top: 5px; display: inline-block; }
    .soldout-toggle-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      color: white;
    }
    .soldout-toggle-btn.set-soldout { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); }
    .soldout-toggle-btn.set-available { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); }
    
    /* éŸ³å£°æ¡ˆå†…ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .audio-buttons-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .audio-buttons-section h2 {
      text-align: center;
      color: #667eea;
      margin-bottom: 15px;
      font-size: 20px;
    }
    .audio-button-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
    }
    .audio-btn {
      padding: 20px 10px;
      font-size: 20px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      color: white;
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: all 0.3s;
    }
    .audio-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    .audio-btn:active {
      transform: scale(0.95);
    }
    .audio-btn.playing {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      animation: pulse 0.5s infinite;
    }
    
    /* ã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
    .connection-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transition: all 0.3s;
    }
    .connection-indicator.online {
      background: #4CAF50;
      color: white;
    }
    .connection-indicator.offline {
      background: #f44336;
      color: white;
    }
    
    /* æ”¯æ‰•ã„æ–¹æ³•ãƒ¢ãƒ¼ãƒ€ãƒ« */
    .payment-modal-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 10000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .payment-modal-overlay.show {
      display: flex;
    }
    .payment-modal {
      background: white;
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }
    .payment-modal h3 {
      text-align: center;
      color: #667eea;
      font-size: 24px;
      margin-bottom: 20px;
    }
    .payment-method-btn {
      width: 100%;
      padding: 20px;
      margin: 10px 0;
      font-size: 18px;
      font-weight: bold;
      border: 3px solid #ddd;
      border-radius: 15px;
      cursor: pointer;
      background: white;
      transition: all 0.3s;
    }
    .payment-method-btn:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(102,126,234,0.3);
    }
    .payment-method-btn.selected {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-color: #667eea;
    }
    .payment-modal-buttons {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 20px;
    }
    .payment-modal-btn {
      padding: 15px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
    }
    .payment-modal-btn.confirm {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    .payment-modal-btn.cancel {
      background: #e0e0e0;
      color: #333;
    }
    .connection-indicator.offline {
      background: #f44336;
      color: white;
    }
    .connection-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: white;
    }
  </style>
</head>
<body>
  <!-- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ -->
  <div id="loginScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 10000; display: flex; align-items: center; justify-content: center;">
    <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
      <div style="text-align: center; margin-bottom: 30px;">
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 80px; height: 80px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
          <svg style="width: 40px; height: 40px; color: white;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
          </svg>
        </div>
        <h1 style="font-size: 28px; font-weight: bold; color: #333; margin-bottom: 10px;">æ³¨æ–‡ç®¡ç†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼</h1>
        <p style="color: #666;">åº—èˆ—æƒ…å ±ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
      </div>
      
      <form id="controllerLoginForm" onsubmit="return false;">
        <div style="margin-bottom: 20px;">
          <label style="display: block; color: #333; font-weight: bold; margin-bottom: 8px;">åº—èˆ—å</label>
          <input type="text" id="controllerStoreNameInput" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px;" placeholder="åº—èˆ—åã‚’å…¥åŠ›" required>
        </div>
        
        <div style="margin-bottom: 25px;">
          <label style="display: block; color: #333; font-weight: bold; margin-bottom: 8px;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
          <input type="password" id="controllerPasswordInput" style="width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px;" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›" required>
        </div>
        
        <div id="controllerLoginError" style="display: none; background: #fee; color: #c33; padding: 12px; border-radius: 8px; margin-bottom: 20px; text-align: center; font-weight: bold;"></div>
        
        <button type="submit" onclick="handleControllerLogin(event)" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer;">
          ãƒ­ã‚°ã‚¤ãƒ³
        </button>
      </form>
    </div>
  </div>

  <div id="mainContent" style="display: none;">
    <div class="connection-indicator online" id="connection-indicator">
      <div class="connection-dot"></div>
      <span>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>
    </div>

    <!-- éŸ³å£°æ¡ˆå†…ãƒœã‚¿ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="audio-buttons-section">
      <div class="audio-button-grid" id="audio-button-grid"></div>
    </div>

    <div id="page-orders">
    <div class="top-controls">
      <button class="big-btn btn-refresh" onclick="loadOrders()">æ›´æ–°</button>
      <button class="big-btn btn-add-waiting" onclick="increaseWaiting()">å¾…1</button>
      <button class="big-btn btn-soldout" onclick="showSoldOutPage()">å“åˆ‡</button>
      <button class="big-btn" id="bulk-soldout-btn" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);" onclick="toggleBulkSoldOut()">ä¸€æ‹¬</button>
      <button class="big-btn" id="time-override-btn" style="background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%);" onclick="toggleTimeOverride()">æ™‚å¤–</button>
    </div>

    <div class="manual-waiting-card">
      <div class="manual-waiting-label">æ‰‹å‹•å¾…ã¡äººæ•°</div>
      <div class="manual-count" id="manual-count">0</div>
      <button class="btn-reset" onclick="resetWaiting()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div id="staff-calls-container"></div>
    <div id="orders-container"><div style="text-align:center;color:white;padding:40px;">èª­ã¿è¾¼ã¿ä¸­...</div></div>
  </div>

  <div id="page-soldout" class="hidden">
    <button class="big-btn btn-refresh" style="margin-bottom: 15px;" onclick="backToOrders()">â† æ³¨æ–‡ç®¡ç†ã«æˆ»ã‚‹</button>
    
    <div class="header" style="margin-bottom: 15px;">
      <h1>ğŸš« å“åˆ‡ã‚Œè¨­å®š</h1>
    </div>
    
    <div class="category-filter">
      <label style="display:block;font-size:16px;font-weight:bold;margin-bottom:10px;">ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„</label>
      <select id="soldout-category-select">
        <option value="">å…¨ã¦ã®å•†å“</option>
      </select>
    </div>
    
    <div id="soldout-menu-list"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, getDoc, doc, deleteDoc, setDoc, updateDoc, Timestamp, onSnapshot, query, where } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const app = initializeApp({
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    });
    
    const db = getFirestore(app);
    window.db = db;
    
    // Firebaseãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«å…¬é–‹ï¼ˆãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†ã§ä½¿ç”¨ï¼‰
    window.firebaseModules = {
      collection, getDocs, getDoc, doc, deleteDoc, setDoc, updateDoc, Timestamp, onSnapshot, query, where
    };

    let audioEnabled = false;
    let isFirstOrderLoad = true;
    let lastOrderCount = 0;
    let allMenuItems = [];
    let isBulkSoldOut = false;
    let currentAudio = null;
    
    // ã‚¿ãƒƒãƒ—éŸ³ç”¨ã®AudioContext
    let audioContext = null;
    
    // ã‚¿ãƒƒãƒ—éŸ³ã‚’å†ç”Ÿã™ã‚‹é–¢æ•°
    function playTapSound() {
      try {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // ãƒ”ãƒƒã¨ã„ã†éŸ³ï¼ˆ1000Hzï¼‰
        oscillator.frequency.value = 1000;
        oscillator.type = 'sine';
        
        // éŸ³é‡è¨­å®š
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.1);
      } catch (e) {
        console.log('ã‚¿ãƒƒãƒ—éŸ³å†ç”Ÿã‚¨ãƒ©ãƒ¼:', e);
      }
    }
    
    // å…¨ã¦ã®ãƒœã‚¿ãƒ³ã«ã‚¿ãƒƒãƒ—éŸ³ã‚’è¿½åŠ 
    document.addEventListener('DOMContentLoaded', () => {
      // ãƒœã‚¿ãƒ³è¦ç´ ã‚’å–å¾—
      const buttons = document.querySelectorAll('button, .order-card, .big-btn, .action-btn, .payment-btn');
      
      buttons.forEach(button => {
        button.addEventListener('click', () => {
          playTapSound();
        });
      });
      
      // å‹•çš„ã«è¿½åŠ ã•ã‚Œã‚‹ãƒœã‚¿ãƒ³ç”¨ï¼ˆMutationObserverï¼‰
      const observer = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          mutation.addedNodes.forEach((node) => {
            if (node.tagName === 'BUTTON' || node.classList?.contains('order-card') || node.classList?.contains('action-btn')) {
              node.addEventListener('click', () => {
                playTapSound();
              });
            }
            // å­è¦ç´ ã®ãƒœã‚¿ãƒ³ã‚‚ãƒã‚§ãƒƒã‚¯
            if (node.querySelectorAll) {
              node.querySelectorAll('button, .action-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                  playTapSound();
                });
              });
            }
          });
        });
      });
      
      observer.observe(document.body, { childList: true, subtree: true });
    });

    // æ¥ç¶šç›£è¦–
    window.addEventListener('online', () => {
      const indicator = document.getElementById('connection-indicator');
      indicator.className = 'connection-indicator online';
      indicator.innerHTML = '<div class="connection-dot"></div><span>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³</span>';
    });

    window.addEventListener('offline', () => {
      const indicator = document.getElementById('connection-indicator');
      indicator.className = 'connection-indicator offline';
      indicator.innerHTML = '<div class="connection-dot"></div><span>ã‚ªãƒ•ãƒ©ã‚¤ãƒ³</span>';
    });

    window.onload = async function() {
      initializeAudioButtons();
      showAudioEnablePopup();
    };

    // éŸ³å£°æ¡ˆå†…ãƒœã‚¿ãƒ³ã®åˆæœŸåŒ–
    function initializeAudioButtons() {
      const numbers = [619, 620, 621, 622, 623, 624, 625, 626, 627, 628];
      const buttonGrid = document.getElementById('audio-button-grid');
      
      numbers.forEach(num => {
        const btn = document.createElement('button');
        btn.className = 'audio-btn';
        btn.textContent = num;
        btn.onclick = () => playAudioAnnouncement(num, btn);
        buttonGrid.appendChild(btn);
      });
    }
    
    // éŸ³å£°æ¡ˆå†…ã‚’å†ç”Ÿ
    function playAudioAnnouncement(number, button) {
      if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
      }

      document.querySelectorAll('.audio-btn').forEach(b => {
        b.classList.remove('playing');
      });

      try {
        const pinpon = new Audio('./pinpon.mp3');
        pinpon.volume = 1.0;
        currentAudio = pinpon;
        
        button.classList.add('playing');
        
        pinpon.play().catch(err => console.error('ãƒ”ãƒ³ãƒãƒ³éŸ³ å†ç”Ÿå¤±æ•—:', err));
        
        pinpon.onended = () => {
          const audio = new Audio(`./${number}.wav`);
          audio.volume = 1.0;
          currentAudio = audio;

          audio.play().catch(err => {
            console.error(`${number}.wav å†ç”Ÿå¤±æ•—:`, err);
            button.classList.remove('playing');
          });

          audio.onended = () => {
            button.classList.remove('playing');
          };

          audio.onerror = () => {
            button.classList.remove('playing');
          };
        };
        
        pinpon.onerror = () => {
          button.classList.remove('playing');
        };

      } catch (e) {
        console.error('ã‚¨ãƒ©ãƒ¼:', e);
        button.classList.remove('playing');
      }
    }

    function showAudioEnablePopup() {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      
      const popup = document.createElement('div');
      popup.style.cssText = `
        background: white;
        border-radius: 20px;
        padding: 40px;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      `;
      
      popup.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ”Š</div>
        <div style="font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #333;">
          éŸ³å£°é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã‹?
        </div>
        <div style="font-size: 16px; color: #666; margin-bottom: 30px;">
          æ–°è¦æ³¨æ–‡ãŒå…¥ã£ãŸæ™‚ã«éŸ³ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™
        </div>
        <button style="
          padding: 15px 40px;
          background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
          color: white;
          border: none;
          border-radius: 12px;
          font-size: 18px;
          font-weight: bold;
          cursor: pointer;
          box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        ">æœ‰åŠ¹ã«ã™ã‚‹</button>
      `;
      
      popup.querySelector('button').onclick = () => {
        audioEnabled = true;
        overlay.remove();
        loadOrders();
        loadTimeOverrideStatus();
        watchWaiting();
        watchStaffCalls();
        watchOrders();
      };
      
      overlay.appendChild(popup);
      document.body.appendChild(overlay);
    }

    function watchOrders() {
      const unsubscribe = onSnapshot(
        collection(db, 'orders'), 
        (snapshot) => {
          const currentCount = snapshot.size;
          
          if (!isFirstOrderLoad && currentCount > lastOrderCount) {
            playOrderSound();
          }
          
          lastOrderCount = currentCount;
          isFirstOrderLoad = false;
          
          loadOrders();
        }
      );
      
      return unsubscribe;
    }

    function watchWaiting() {
      const unsubscribe = onSnapshot(
        doc(db, 'settings', 'waiting'), 
        (doc) => {
          if (doc.exists()) {
            const count = doc.data().manualCount || 0;
            document.getElementById('manual-count').textContent = count;
          }
        }
      );
      
      return unsubscribe;
    }

    function watchStaffCalls() {
      let isFirstLoad = true;
      
      // åº—èˆ—åˆ¥ã®ã‚¹ã‚¿ãƒƒãƒ•å‘¼ã³å‡ºã—ã‚’ç›£è¦–
      const callsCollection = currentStoreId 
        ? collection(db, 'stores', currentStoreId, 'staff_calls')
        : collection(db, 'staff_calls'); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆæ—§ãƒ‡ãƒ¼ã‚¿ç”¨ï¼‰
      
      const unsubscribe = onSnapshot(
        callsCollection,
        (snapshot) => {
        const container = document.getElementById('staff-calls-container');
        container.innerHTML = '';
        
        const calls = [];
        snapshot.forEach(doc => calls.push({ id: doc.id, ...doc.data() }));
        calls.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
        
        calls.forEach(call => {
          const isBill = call.type === 'bill';
          const card = document.createElement('div');
          card.className = 'staff-call-card';
          if (isBill) card.style.background = 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)';
          
          const orderNumberHtml = call.orderNumber 
            ? `<div style="font-size:20px;text-align:center;margin-top:8px;font-weight:bold;color:#fff;">æ³¨æ–‡ç•ªå·: #${call.orderNumber}</div>` 
            : '';
          
          card.innerHTML = `
            <div style="font-size:24px;text-align:center;font-weight:bold;">
              ${isBill ? 'ğŸ’³ ãŠä¼šè¨ˆã§ã™' : 'ğŸ“ å‘¼ã³å‡ºã—'}
            </div>
            <div class="staff-call-table">${call.tableNumber || 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ'}</div>
            ${orderNumberHtml}
            <button class="btn-reset" style="width:100%;margin-top:10px;" onclick="dismissCall('${call.id}')">å¯¾å¿œå®Œäº†</button>
          `;
          container.appendChild(card);
        });
        
        if (!isFirstLoad && calls.length > 0) {
          const isBill = calls[0].type === 'bill';
          if (isBill) playBillSound();
          else playCallSound();
        }
        isFirstLoad = false;
      });
      
      return unsubscribe;
    }

    window.dismissCall = async (id) => {
      try {
        console.log('ğŸ”¥ å¯¾å¿œå®Œäº†å‡¦ç†é–‹å§‹');
        console.log('å‰Šé™¤ID:', id);
        console.log('ç¾åœ¨ã®åº—èˆ—ID:', currentStoreId);
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‹ã‚‰å–å¾—
        const { doc, deleteDoc } = window.firebaseModules;
        const database = window.db;
        
        if (!doc || !deleteDoc || !database) {
          console.error('âŒ Firebaseé–¢æ•°ã¾ãŸã¯DBãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          console.log('doc:', doc);
          console.log('deleteDoc:', deleteDoc);
          console.log('database:', database);
          alert('ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼: Firebaseé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          return;
        }
        
        let docRef;
        if (currentStoreId) {
          docRef = doc(database, 'stores', currentStoreId, 'staff_calls', id);
          console.log('å‰Šé™¤ãƒ‘ã‚¹: stores/' + currentStoreId + '/staff_calls/' + id);
        } else {
          docRef = doc(database, 'staff_calls', id);
          console.log('å‰Šé™¤ãƒ‘ã‚¹: staff_calls/' + id);
        }
        
        console.log('å‰Šé™¤å®Ÿè¡Œä¸­...');
        await deleteDoc(docRef);
        console.log('âœ… å‰Šé™¤æˆåŠŸ');
        showToast('âœ“ å¯¾å¿œå®Œäº†');
      } catch (error) {
        console.error('âŒ ã‚¹ã‚¿ãƒƒãƒ•å‘¼ã³å‡ºã—å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', error);
        console.error('ã‚¨ãƒ©ãƒ¼å†…å®¹:', error.message);
        alert('å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ' + error.message);
        showToast('âœ— å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    };

    function playOrderSound() {
      if (!audioEnabled) return;
      try {
        const audio = new Audio('./order.wav');
        audio.volume = 1.0;
        audio.play().catch(e => console.log('éŸ³å£°å†ç”Ÿå¤±æ•—:', e));
      } catch (e) {
        console.log('éŸ³å£°ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    function playCallSound() {
      if (!audioEnabled) return;
      try {
        const audio = new Audio('./call.wav');
        audio.volume = 1.0;
        audio.play().catch(e => console.log('éŸ³å£°å†ç”Ÿå¤±æ•—:', e));
      } catch (e) {
        console.log('éŸ³å£°ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    function playBillSound() {
      if (!audioEnabled) return;
      try {
        const audio = new Audio('./okaikei.wav');
        audio.volume = 1.0;
        audio.play().catch(e => console.log('éŸ³å£°å†ç”Ÿå¤±æ•—:', e));
      } catch (e) {
        console.log('éŸ³å£°ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    async function loadOrders() {
      const orders = [];
      console.log('ğŸ”„ æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹ - åº—èˆ—ID:', currentStoreId);
      
      // åº—èˆ—åˆ¥ã®æ³¨æ–‡ã‚’èª­ã¿è¾¼ã‚€
      const ordersCollection = currentStoreId 
        ? collection(db, 'stores', currentStoreId, 'orders')
        : collection(db, 'orders'); // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆæ—§ãƒ‡ãƒ¼ã‚¿ç”¨ï¼‰
      
      (await getDocs(ordersCollection)).forEach(doc => {
        const d = doc.data();
        
        console.log('ğŸ“‹ æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿:', {
          id: doc.id,
          orderNumber: d.orderNumber,
          tableNumber: d.tableNumber,
          hasItems: !!d.items,
          itemsLength: d.items ? d.items.length : 0,
          items: d.items
        });
        
        // deletedãƒ•ãƒ©ã‚°ãŒç«‹ã£ã¦ã„ã‚‹æ³¨æ–‡ã¯ã‚¹ã‚­ãƒƒãƒ—
        if (d.deleted) return;
        
        orders.push({
          id: doc.id,
          orderNumber: d.orderNumber,
          tableNumber: d.tableNumber,
          items: d.items,
          totalAmount: d.totalAmount,
          bagNeeded: d.bagNeeded || false,
          bagQuantity: d.bagQuantity || 0,
          bagPrice: d.bagPrice || 0,
          customerMemo: d.customerMemo || '',  // ãŠå®¢æ§˜ãƒ¡ãƒ¢ã‚’è¿½åŠ 
          memo: d.memo || {},
          completedAt: d.completedAt || null,
          cancelledAt: d.cancelledAt || null,
          paidAt: d.paidAt || null
        });
      });
      
      const container = document.getElementById('orders-container');
      if (orders.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:white;padding:40px;">ç¾åœ¨æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = '';
      orders.sort((a, b) => a.orderNumber - b.orderNumber).forEach(order => {
        const card = document.createElement('div');
        card.className = 'order-card';
        
        let statusBadge = '';
        if (order.completedAt) {
          statusBadge = '<div style="background:#4CAF50;color:white;padding:5px 10px;border-radius:8px;display:inline-block;margin:5px 0;">âœ“ å®Œäº†æ¸ˆã¿</div>';
        } else if (order.cancelledAt) {
          statusBadge = '<div style="background:#f44336;color:white;padding:5px 10px;border-radius:8px;display:inline-block;margin:5px 0;">âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿</div>';
        }
        
        let paidBadge = '';
        if (order.paidAt) {
          paidBadge = '<div style="background:#2196F3;color:white;padding:5px 10px;border-radius:8px;display:inline-block;margin:5px 5px 5px 0;">ğŸ’³ ä¼šè¨ˆæ¸ˆ</div>';
        }
        
        let itemsHTML = '';
        let grandTotal = 0;
        
        order.items.forEach((item, idx) => {
          const memoText = order.memo?.[idx] || item.memo || '';
          const itemPrice = item.price || 0;
          const toppingPrice = item.toppingPrice || 0;
          const quantity = item.quantity || 1;
          const itemTotal = (itemPrice + toppingPrice) * quantity;
          grandTotal += itemTotal;
          
          // ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’1è¡Œãšã¤è¡¨ç¤ºï¼ˆtoppingDetailsã‚’å„ªå…ˆï¼‰
          let toppingsHtml = '';
          if (item.toppingDetails && item.toppingDetails.length > 0) {
            // æ–°ã—ã„å½¢å¼: toppingDetailsãŒã‚ã‚‹å ´åˆ
            const groupedBySet = {};
            item.toppingDetails.forEach(detail => {
              if (!groupedBySet[detail.setName]) {
                groupedBySet[detail.setName] = [];
              }
              groupedBySet[detail.setName].push(detail.optionName);
            });
            
            toppingsHtml = Object.entries(groupedBySet).map(([setName, options]) => {
              return `
                <div class="order-item-toppings" style="font-weight: bold; color: #666;">${setName}</div>
                ${options.map(opt => `<div class="order-item-toppings" style="margin-left: 10px;">ãƒ»${opt}</div>`).join('')}
              `;
            }).join('');
          } else if (item.toppings && item.toppings !== 'ãªã—') {
            // å¤ã„å½¢å¼: toppingsã®ã¿ã®å ´åˆ
            const toppingsList = item.toppings.split(',').map(t => t.trim());
            toppingsHtml = toppingsList.map(topping => 
              `<div class="order-item-toppings">ãƒ»${topping}</div>`
            ).join('');
          }
          
          itemsHTML += `
            <div class="order-item">
              <div class="order-item-header">
                <div class="order-item-name">${item.name} Ã— ${quantity}</div>
                <div class="order-item-price">Â¥${itemPrice.toLocaleString()}</div>
              </div>
              ${toppingsHtml}
              ${memoText ? `<div class="order-item-memo">ğŸ“ ${memoText}</div>` : ''}
              <div class="order-item-total">Â¥${itemPrice.toLocaleString()} Ã— ${quantity} = Â¥${itemTotal.toLocaleString()}</div>
            </div>
          `;
        });
        
        // ãƒ¬ã‚¸è¢‹æƒ…å ±ã‚’è¿½åŠ ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ä»˜ãï¼‰
        console.log('æ³¨æ–‡#' + order.orderNumber + ' ãƒ¬ã‚¸è¢‹ãƒ‡ãƒ¼ã‚¿:', {
          bagNeeded: order.bagNeeded,
          bagQuantity: order.bagQuantity,
          bagPrice: order.bagPrice
        });
        
        if (order.bagNeeded && order.bagQuantity > 0) {
          const bagTotal = order.bagPrice || (order.bagQuantity * 3);
          grandTotal += bagTotal;
          console.log('ãƒ¬ã‚¸è¢‹ã‚’è¡¨ç¤º: ' + order.bagQuantity + 'æšã€åˆè¨ˆÂ¥' + bagTotal);
          itemsHTML += `
            <div class="order-item" style="background: #fff3e0;">
              <div class="order-item-header">
                <div class="order-item-name">ğŸ›ï¸ ãƒ¬ã‚¸è¢‹ Ã— ${order.bagQuantity}</div>
                <div class="order-item-price">Â¥${bagTotal.toLocaleString()}</div>
              </div>
              <div class="order-item-total">Â¥3 Ã— ${order.bagQuantity} = Â¥${bagTotal.toLocaleString()}</div>
            </div>
          `;
        } else {
          console.log('ãƒ¬ã‚¸è¢‹ãªã—');
        }
        
        // ãŠå®¢æ§˜ãƒ¡ãƒ¢ã‚’è¿½åŠ ï¼ˆpos.htmlã¨åŒã˜æ–¹å¼ï¼‰
        let customerMemoHTML = '';
        console.log('æ³¨æ–‡#' + order.orderNumber + ' ãŠå®¢æ§˜ãƒ¡ãƒ¢ãƒ‡ãƒ¼ã‚¿:', {
          customerMemo: order.customerMemo,
          exists: !!order.customerMemo,
          trimmed: order.customerMemo ? order.customerMemo.trim() : '',
          length: order.customerMemo ? order.customerMemo.length : 0
        });
        
        if (order.customerMemo && order.customerMemo.trim() !== '') {
          console.log('âœ… ãŠå®¢æ§˜ãƒ¡ãƒ¢ã‚’è¡¨ç¤º: ' + order.customerMemo);
          customerMemoHTML = `
            <div class="order-item" style="background: #e3f2fd; border-left: 4px solid #2196F3;">
              <div style="font-weight: bold; color: #1976D2; margin-bottom: 5px;">ğŸ“ ãŠå®¢æ§˜ãƒ¡ãƒ¢</div>
              <div style="color: #333;">${order.customerMemo}</div>
            </div>
          `;
        } else {
          console.log('âš ï¸ ãŠå®¢æ§˜ãƒ¡ãƒ¢ãªã—');
        }
        
        card.innerHTML = `
          <div class="order-number">#${order.orderNumber}</div>
          <div class="order-table">${order.tableNumber}</div>
          ${statusBadge}${paidBadge}
          ${itemsHTML}
          ${customerMemoHTML}
          <div class="order-total">
            <div class="order-total-label">å…¨ã¦ã®åˆè¨ˆé‡‘é¡</div>
            <div class="order-total-amount">Â¥${grandTotal.toLocaleString()}</div>
          </div>
          <div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
            <button class="control-btn btn-complete" style="font-size:11px;" data-order-id="${order.id}" data-table="${order.tableNumber}">âœ“å®Œäº†</button>
            <button class="control-btn btn-cancel" style="font-size:11px;" data-order-id="${order.id}" data-table="${order.tableNumber}">âœ•ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="control-btn" style="background:linear-gradient(135deg,#9C27B0 0%,#7B1FA2 100%);font-size:11px;" data-order-id="${order.id}">ğŸ“‹è©³ç´°</button>
          </div>
          <div style="margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <button class="control-btn" id="paid-btn-${order.id}" style="background:linear-gradient(135deg,${order.paidAt ? '#2196F3' : '#FFC107'} 0%,${order.paidAt ? '#1976D2' : '#FFA000'} 100%);font-size:11px;" data-order-id="${order.id}" data-table="${order.tableNumber}" data-paid="${order.paidAt ? 'true' : 'false'}">${order.paidAt ? 'ğŸ’³ æ¸ˆ' : 'ğŸ’³ æœª'}</button>
            <button class="control-btn" style="background:linear-gradient(135deg,#757575 0%,#616161 100%);font-size:11px;${!order.completedAt && !order.cancelledAt ? 'opacity:0.5;cursor:not-allowed;' : ''}" data-order-id="${order.id}" ${!order.completedAt && !order.cancelledAt ? 'disabled' : ''}>ğŸ—‘ï¸å‰Šé™¤</button>
          </div>
        `;
        
        const completeBtn = card.querySelector('.btn-complete');
        const cancelBtn = card.querySelector('.btn-cancel');
        const detailBtn = card.querySelectorAll('.control-btn')[2];
        const paidBtn = card.querySelectorAll('.control-btn')[3];
        const deleteBtn = card.querySelectorAll('.control-btn')[4];
        
        completeBtn.onclick = () => completeOrder(order.id, order.tableNumber, order.orderNumber);
        cancelBtn.onclick = () => cancelOrder(order.id, order.tableNumber, order.orderNumber);
        detailBtn.onclick = () => showOrderDetail(order);
        paidBtn.onclick = () => togglePaidStatus(order);
        
        if (order.completedAt || order.cancelledAt) {
          deleteBtn.onclick = () => deleteOrder(order.id);
        }
        
        container.appendChild(card);
      });
    }

    function showOrderDetail(order) {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        overflow-y: auto;
        padding: 20px 0;
      `;
      
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        background: white;
        border-radius: 15px;
        padding: 20px;
        max-width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      `;
      
      let itemsHtml = '';
      order.items.forEach((item, idx) => {
        const currentMemo = order.memo?.[idx] || item.memo || '';
        const toppingsText = item.toppings && item.toppings !== 'ãªã—' ? item.toppings : 'ãªã—';
        itemsHtml += `
          <div style="background:#f5f5f5;padding:15px;border-radius:10px;margin-bottom:10px;">
            <div style="font-size:16px;font-weight:bold;margin-bottom:5px;">${item.name} Ã— ${item.quantity}</div>
            <div style="font-size:14px;color:#666;margin-bottom:8px;">ğŸ´ ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${toppingsText}</div>
            <input type="text" 
                   id="memo-${idx}" 
                   value="${currentMemo}"
                   placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›(ã‚½ãƒ¼ã‚¹å¤šã‚ã€ãƒãƒ¨æŠœããªã©)"
                   style="width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;font-size:14px;">
          </div>
        `;
      });
      
      // ãƒ¬ã‚¸è¢‹æƒ…å ±ã‚’è¿½åŠ 
      if (order.bagNeeded && order.bagQuantity > 0) {
        const bagTotal = order.bagPrice || (order.bagQuantity * 3);
        itemsHtml += `
          <div style="background:#fff3e0;padding:15px;border-radius:10px;margin-bottom:10px;">
            <div style="font-size:16px;font-weight:bold;margin-bottom:5px;">ğŸ›ï¸ ãƒ¬ã‚¸è¢‹ Ã— ${order.bagQuantity}æš</div>
            <div style="font-size:14px;color:#666;">å˜ä¾¡: Â¥3 Ã— ${order.bagQuantity} = Â¥${bagTotal.toLocaleString()}</div>
          </div>
        `;
      }
      
      dialog.innerHTML = `
        <div style="font-size:20px;font-weight:bold;margin-bottom:15px;text-align:center;">
          æ³¨æ–‡ #${order.orderNumber} ã®è©³ç´°
        </div>
        <div style="text-align:center;margin-bottom:15px;">
          <span style="background:#2196F3;color:white;padding:5px 15px;border-radius:15px;">${order.tableNumber}</span>
        </div>
        ${itemsHtml}
        <div style="font-size:18px;font-weight:bold;text-align:right;margin:15px 0;color:#4CAF50;">
          åˆè¨ˆ: Â¥${order.totalAmount.toLocaleString()}
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <button id="save-memo-btn" style="
            padding:15px;
            background:#4CAF50;
            color:white;
            border:none;
            border-radius:10px;
            font-size:16px;
            font-weight:bold;
            cursor:pointer;
          ">ğŸ’¾ ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
          <button id="close-detail-btn" style="
            padding:15px;
            background:#757575;
            color:white;
            border:none;
            border-radius:10px;
            font-size:16px;
            font-weight:bold;
            cursor:pointer;
          ">é–‰ã˜ã‚‹</button>
        </div>
      `;
      
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);
      
      document.getElementById('save-memo-btn').onclick = async () => {
        const newMemo = {};
        order.items.forEach((item, idx) => {
          const input = document.getElementById(`memo-${idx}`);
          if (input && input.value.trim()) {
            newMemo[idx] = input.value.trim();
          }
        });
        
        await updateDoc(doc(db, 'orders', order.id), { memo: newMemo });
        showToast('âœ“ ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        overlay.remove();
        loadOrders();
      };
      
      document.getElementById('close-detail-btn').onclick = () => overlay.remove();
    }

    async function completeOrder(orderId, tableNumber, orderNumber) {
      try {
        await updateDoc(doc(db, 'orders', orderId), {
          status: 'completed',
          completedAt: Timestamp.now()
        });
        
        showToast('âœ“ å®Œäº†ã—ã¾ã—ãŸ');
        loadOrders();
      } catch (e) {
        console.error(e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }

    async function cancelOrder(orderId, tableNumber, orderNumber) {
      try {
        await updateDoc(doc(db, 'orders', orderId), {
          cancelledAt: Timestamp.now()
        });
        
        showToast('âœ“ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        loadOrders();
      } catch (e) {
        console.error(e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }

    async function deleteOrder(orderId) {
      try {
        // deleteDocã§ã¯ãªãdeletedãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
        await updateDoc(doc(db, 'orders', orderId), {
          deleted: true,
          deletedAt: Timestamp.now()
        });
        showToast('âœ“ æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        loadOrders();
      } catch (e) {
        console.error(e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }

    let currentPaymentOrder = null;
    let selectedPaymentMethod = null;
    
    async function togglePaidStatus(order) {
      console.log('ğŸ”µ togglePaidStatuså‘¼ã³å‡ºã—');
      console.log('æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿:', order);
      
      try {
        if (order.paidAt) {
          console.log('ä¼šè¨ˆæ¸ˆã¿ â†’ æœªæ¸ˆã«æˆ»ã™å‡¦ç†');
          const confirmed = await showConfirmDialog('ä¼šè¨ˆã‚’æœªæ¸ˆã«æˆ»ã—ã¾ã™ã‹?');
          if (!confirmed) return;
          
          await updateDoc(doc(db, 'orders', order.id), {
            paidAt: null
          });
          
          showToast('âœ“ ä¼šè¨ˆã‚’æœªæ¸ˆã«æˆ»ã—ã¾ã—ãŸ');
          loadOrders();
        } else {
          console.log('æœªæ¸ˆ â†’ æ”¯æ‰•ã„æ–¹æ³•é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º');
          // æ”¯æ‰•ã„æ–¹æ³•é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
          currentPaymentOrder = order;
          selectedPaymentMethod = null;
          
          console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ å–å¾—ä¸­...');
          const modal = document.getElementById('paymentModal');
          console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ :', modal);
          
          if (!modal) {
            console.error('âŒ paymentModalãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼');
            showToast('ã‚¨ãƒ©ãƒ¼: æ”¯æ‰•ã„ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
          }
          
          modal.classList.add('show');
          console.log('ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºå®Œäº†');
          
          // é¸æŠçŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
          document.querySelectorAll('.payment-method-btn').forEach(btn => {
            btn.classList.remove('selected');
          });
        }
      } catch (e) {
        console.error('âŒ togglePaidStatusã‚¨ãƒ©ãƒ¼:', e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }
    
    window.selectPaymentMethod = function(method, button) {
      console.log('ğŸ”µ selectPaymentMethodå‘¼ã³å‡ºã—:', method);
      selectedPaymentMethod = method;
      document.querySelectorAll('.payment-method-btn').forEach(btn => {
        btn.classList.remove('selected');
      });
      if (button) {
        button.classList.add('selected');
        console.log('âœ… ãƒœã‚¿ãƒ³ã‚’é¸æŠçŠ¶æ…‹ã«ã—ã¾ã—ãŸ');
      }
    }
    
    window.closePaymentModal = function() {
      document.getElementById('paymentModal').classList.remove('show');
      currentPaymentOrder = null;
      selectedPaymentMethod = null;
    }
    
    window.confirmPayment = async function() {
      console.log('ğŸ”µ confirmPaymenté–‹å§‹');
      console.log('selectedPaymentMethod:', selectedPaymentMethod);
      console.log('currentPaymentOrder:', currentPaymentOrder);
      
      if (!selectedPaymentMethod) {
        console.log('âŒ æ”¯æ‰•ã„æ–¹æ³•æœªé¸æŠ');
        showToast('æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      
      if (!currentPaymentOrder) {
        console.log('âŒ æ³¨æ–‡æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        showToast('ã‚¨ãƒ©ãƒ¼: æ³¨æ–‡æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      try {
        const order = currentPaymentOrder;
        console.log('ğŸ“ æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿:', order);
        
        // æ‹…å½“è€…åï¼ˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‹ã‚‰ã¯å›ºå®šï¼‰
        const staffName = 'ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼';
        
        // æ³¨æ–‡ã‚’ä¼šè¨ˆæ¸ˆã¿ã«æ›´æ–°
        console.log('ğŸ’¾ Firestoreæ›´æ–°ä¸­...');
        await updateDoc(doc(db, 'orders', order.id), {
          paidAt: Timestamp.now(),
          notifiedPaid: true,
          paymentMethod: selectedPaymentMethod,
          staffName: staffName
        });
        console.log('âœ… Firestoreæ›´æ–°å®Œäº†');
        
        // å•†å“ç‚¹æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        let itemCount = 0;
        let tax8Total = 0;
        let tax10Total = 0;
        
        console.log('ğŸ” order.items:', order.items);
        
        if (order.items && Array.isArray(order.items)) {
          order.items.forEach(item => {
            console.log('ğŸ“¦ å•†å“:', item);
            itemCount += item.quantity || 0;
            
            // å•†å“ã”ã¨ã®é‡‘é¡ã‚’è¨ˆç®—ï¼ˆãƒˆãƒƒãƒ”ãƒ³ã‚°è¾¼ã¿ï¼‰
            const basePrice = item.price || 0;
            const toppingPrice = item.toppingPrice || 0;
            const totalPrice = basePrice + toppingPrice;
            const itemTotal = totalPrice * (item.quantity || 0);
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·ã«ã‚ˆã‚‹ç¨ç‡åˆ¤å®š
            const tableNumber = order.tableNumber || '';
            const itemName = item.name || '';
            
            console.log('ğŸ” ç¨ç‡åˆ¤å®š:', {
              å•†å“: itemName,
              ãƒ†ãƒ¼ãƒ–ãƒ«: tableNumber,
              é‡‘é¡: itemTotal
            });
            
            // ã€10%ã€‘åº—å†…ãƒ†ãƒ¼ãƒ–ãƒ«: c1, c2, T-M, T-H ã®ã¿
            if (tableNumber.match(/^(c1|c2|T-M|T-H)$/)) {
              tax10Total += itemTotal;
              console.log('â†’ 10%é©ç”¨ï¼ˆåº—å†…ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰');
            }
            // ã€10%ã€‘ãƒ¬ã‚¸è¢‹ï¼ˆã©ã®ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã‚‚ï¼‰
            else if (itemName.includes('ãƒ¬ã‚¸è¢‹') || itemName.includes('è¢‹')) {
              tax10Total += itemTotal;
              console.log('â†’ 10%é©ç”¨ï¼ˆãƒ¬ã‚¸è¢‹ï¼‰');
            }
            // ã€8%ã€‘å³ä¼šè¨ˆã€ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆã€äºˆç´„1-5ãªã©å…¨ã¦
            else {
              tax8Total += itemTotal;
              console.log('â†’ 8%é©ç”¨ï¼ˆæŒã¡å¸°ã‚Šï¼‰');
            }
          });
        } else {
          console.log('âŒ order.itemsãŒé…åˆ—ã§ã¯ãªã„ or å­˜åœ¨ã—ãªã„');
        }
        
        // ãƒ¬ã‚¸è¢‹ã‚’è¿½åŠ ï¼ˆåˆ¥é€”ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ï¼‰
        if (order.bagNeeded && order.bagQuantity > 0) {
          const bagTotal = order.bagPrice || (order.bagQuantity * 3);
          itemCount += order.bagQuantity;
          tax10Total += bagTotal;
          console.log('ğŸ›ï¸ ãƒ¬ã‚¸è¢‹è¿½åŠ :', {
            æšæ•°: order.bagQuantity,
            é‡‘é¡: bagTotal,
            ç¨ç‡: '10%'
          });
        }
        
        console.log('ğŸ“¦ ä¼šè¨ˆå•†å“ç‚¹æ•°:', itemCount);
        console.log('ğŸ’° ç¨ç‡åˆ¥å£²ä¸Š:', { tax8Total, tax10Total });
        
        // æ—¥æ¬¡å£²ä¸Šã‚’æ›´æ–°ï¼ˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‹ã‚‰ã¯å€¤å¼•ããªã—ï¼‰
        console.log('ğŸ’¾ æ—¥æ¬¡å£²ä¸Šæ›´æ–°ä¸­...');
        await updateDailySales(order.totalAmount, selectedPaymentMethod, itemCount, tax8Total, tax10Total, 0, order.items);
        console.log('âœ… æ—¥æ¬¡å£²ä¸Šæ›´æ–°å®Œäº†');
        
        closePaymentModal();
        showToast('âœ“ ä¼šè¨ˆæ¸ˆã¿ã«ã—ã¾ã—ãŸ');
        loadOrders();
      } catch (e) {
        console.error('âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ:', e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }
    
    // æ—¥æ¬¡å£²ä¸Šæ›´æ–°é–¢æ•°
    async function updateDailySales(totalAmount, paymentMethod, itemCount, tax8Total, tax10Total, discountAmount = 0, items = []) {
      try {
        // åˆå‰3æ™‚åŸºæº–ã§æ—¥ä»˜ã‚’æ±ºå®šï¼ˆãƒ¬ã‚¸ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
        const now = new Date();
        let targetDate = new Date(now);
        
        // åˆå‰3æ™‚ã‚ˆã‚Šå‰ãªã‚‰æ˜¨æ—¥æ‰±ã„
        if (now.getHours() < 3) {
          targetDate.setDate(targetDate.getDate() - 1);
        }
        
        const dateStr = `${targetDate.getFullYear()}-${String(targetDate.getMonth()+1).padStart(2,'0')}-${String(targetDate.getDate()).padStart(2,'0')}`;
        
        console.log('ğŸ“Š æ—¥æ¬¡å£²ä¸Šæ›´æ–°é–‹å§‹:', { dateStr, totalAmount, paymentMethod, itemCount, tax8Total, tax10Total, discountAmount });
        
        const salesRef = doc(db, 'dailySales', dateStr);
        const salesDoc = await getDoc(salesRef);
        
        if (salesDoc.exists()) {
          const data = salesDoc.data();
          console.log('æ—¢å­˜ãƒ‡ãƒ¼ã‚¿:', data);
          
          // å•†å“åˆ¥ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨ˆç®—
          const currentItemCounts = data.itemCounts || {};
          items.forEach(item => {
            const itemName = item.name;
            currentItemCounts[itemName] = (currentItemCounts[itemName] || 0) + item.quantity;
          });
          
          const updates = {
            totalSales: (data.totalSales || 0) + totalAmount,
            customerCount: (data.customerCount || 0) + 1,
            totalItems: (data.totalItems || 0) + itemCount,
            tax8Total: (data.tax8Total || 0) + tax8Total,
            tax10Total: (data.tax10Total || 0) + tax10Total,
            totalDiscount: (data.totalDiscount || 0) + discountAmount,
            itemCounts: currentItemCounts,
            drawerOpenCount: data.drawerOpenCount || 0,
            cashSales: data.cashSales || 0,
            emoneSales: data.emoneSales || 0,
            creditSales: data.creditSales || 0,
            updatedAt: Timestamp.now()
          };
          
          // æ”¯æ‰•ã„æ–¹æ³•åˆ¥ã®å£²ä¸Šã‚’åŠ ç®—
          if (paymentMethod === 'cash') {
            updates.cashSales += totalAmount;
          } else if (paymentMethod === 'emoney') {
            updates.emoneSales += totalAmount;
          } else if (paymentMethod === 'credit') {
            updates.creditSales += totalAmount;
          }
          
          await updateDoc(salesRef, updates);
          console.log('âœ… æ—¢å­˜å£²ä¸Šãƒ‡ãƒ¼ã‚¿æ›´æ–°:', updates);
          
        } else {
          // å•†å“åˆ¥ã‚«ã‚¦ãƒ³ãƒˆã‚’è¨ˆç®—
          const newItemCounts = {};
          items.forEach(item => {
            const itemName = item.name;
            newItemCounts[itemName] = (newItemCounts[itemName] || 0) + item.quantity;
          });
          
          const newData = {
            date: dateStr,
            totalSales: totalAmount,
            customerCount: 1,
            totalItems: itemCount,
            tax8Total: tax8Total,
            tax10Total: tax10Total,
            totalDiscount: discountAmount,
            itemCounts: newItemCounts,
            cashSales: paymentMethod === 'cash' ? totalAmount : 0,
            emoneSales: paymentMethod === 'emoney' ? totalAmount : 0,
            creditSales: paymentMethod === 'credit' ? totalAmount : 0,
            drawerOpenCount: 0,
            createdAt: Timestamp.now(),
            updatedAt: Timestamp.now()
          };
          
          await setDoc(salesRef, newData);
          console.log('âœ… æ–°è¦å£²ä¸Šãƒ‡ãƒ¼ã‚¿ä½œæˆ:', newData);
        }
        
        // æ›´æ–°å¾Œã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ç¢ºèª
        const updatedDoc = await getDoc(salesRef);
        console.log('æ›´æ–°å¾Œã®ãƒ‡ãƒ¼ã‚¿:', updatedDoc.data());
        
      } catch (error) {
        console.error('âŒ æ—¥æ¬¡å£²ä¸Šæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
        throw error;
      }
    }

    window.showSoldOutPage = async function() {
      try {
        const menuSnapshot = await getDocs(collection(db, 'menu'));
        allMenuItems = [];
        const categories = new Set();
        
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          allMenuItems.push({
            id: data.id,
            name: data.name,
            price: data.price,
            category: data.category
          });
          if (data.category) categories.add(data.category);
        });
        
        const select = document.getElementById('soldout-category-select');
        select.innerHTML = '<option value="">å…¨ã¦ã®å•†å“</option>';
        Array.from(categories).sort().forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          select.appendChild(opt);
        });
        
        select.onchange = () => {
          const filtered = select.value === '' ? allMenuItems : allMenuItems.filter(i => i.category === select.value);
          displaySoldOutItems(filtered);
        };
        
        await displaySoldOutItems(allMenuItems);
        document.getElementById('page-orders').style.display = 'none';
        document.getElementById('page-soldout').classList.remove('hidden');
      } catch (e) {
        console.error(e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    };

    window.backToOrders = function() {
      document.getElementById('page-soldout').classList.add('hidden');
      document.getElementById('page-orders').style.display = 'block';
    };

    async function displaySoldOutItems(items) {
      const list = document.getElementById('soldout-menu-list');
      list.innerHTML = '';
      
      const soldOutSnapshot = await getDocs(collection(db, 'sold_out'));
      const soldOutIds = new Set();
      soldOutSnapshot.forEach(doc => soldOutIds.add(doc.data().menuId));
      
      items.sort((a, b) => {
        const numA = a.id ? parseInt(a.id.replace(/\D/g, '') || '0') : 0;
        const numB = b.id ? parseInt(b.id.replace(/\D/g, '') || '0') : 0;
        return numA - numB;
      });
      
      items.forEach(item => {
        const isSoldOut = soldOutIds.has(item.id);
        const div = document.createElement('div');
        div.className = 'soldout-item' + (isSoldOut ? ' sold-out' : '');
        
        div.innerHTML = `
          <div>
            <div class="soldout-item-name">${item.name}</div>
            <div style="font-size:14px;color:#666;">Â¥${item.price.toLocaleString()}</div>
            ${isSoldOut ? '<span class="soldout-badge">å“åˆ‡ã‚Œä¸­</span>' : ''}
          </div>
          <button class="soldout-toggle-btn ${isSoldOut ? 'set-available' : 'set-soldout'}" 
                  onclick="toggleSoldOut('${item.id}', ${!isSoldOut})">
            ${isSoldOut ? 'âœ“ è²©å£²å†é–‹' : 'ğŸš« å“åˆ‡ã‚Œ'}
          </button>
        `;
        
        list.appendChild(div);
      });
    }

    window.toggleSoldOut = async function(menuId, setSoldOut) {
      try {
        console.log('toggleSoldOut:', menuId, setSoldOut);
        
        if (setSoldOut) {
          // å“åˆ‡ã‚Œã«è¨­å®š
          await setDoc(doc(db, 'sold_out', menuId), {
            menuId: menuId,
            timestamp: Timestamp.now()
          });
          showToast('âœ“ å“åˆ‡ã‚Œã«è¨­å®š');
        } else {
          // å†è²©ï¼šmenuIdã«ä¸€è‡´ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ¤œç´¢ã—ã¦å‰Šé™¤
          const soldOutSnapshot = await getDocs(collection(db, 'sold_out'));
          const deletePromises = [];
          let foundCount = 0;
          
          soldOutSnapshot.forEach(docSnap => {
            const data = docSnap.data();
            console.log('  sold_out doc:', docSnap.id, data);
            
            // menuIdãŒä¸€è‡´ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’å‰Šé™¤ï¼ˆ.refã‚’ä½¿ç”¨ï¼‰
            if (data.menuId === menuId || docSnap.id === menuId) {
              console.log('    â†’ å‰Šé™¤:', docSnap.id);
              deletePromises.push(deleteDoc(docSnap.ref));
              foundCount++;
            }
          });
          
          if (deletePromises.length > 0) {
            await Promise.all(deletePromises);
            showToast(`âœ“ è²©å£²å†é–‹ (${foundCount}ä»¶)`);
          } else {
            console.warn('å‰Šé™¤ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚menuId:', menuId);
            showToast('âš ï¸ å‰Šé™¤å¯¾è±¡ãªã—');
          }
        }
        
        const sel = document.getElementById('soldout-category-select');
        const filtered = sel.value === '' ? allMenuItems : allMenuItems.filter(i => i.category === sel.value);
        await displaySoldOutItems(filtered);
      } catch (e) {
        console.error('toggleSoldOut error:', e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    };

    window.toggleBulkSoldOut = async function() {
      const btn = document.getElementById('bulk-soldout-btn');
      
      if (!isBulkSoldOut) {
        const confirmed = await showConfirmDialog('å…¨å•†å“ã‚’å“åˆ‡ã‚Œã«è¨­å®šã—ã¾ã™ã‹?');
        if (!confirmed) return;
        
        try {
          const menuSnapshot = await getDocs(collection(db, 'menu'));
          const promises = [];
          
          menuSnapshot.forEach(docSnap => {
            const data = docSnap.data();
            if (data.id) {
              promises.push(setDoc(doc(db, 'sold_out', data.id), {
                menuId: data.id,
                timestamp: Timestamp.now()
              }));
            }
          });
          
          await Promise.all(promises);
          isBulkSoldOut = true;
          btn.textContent = 'å†è²©';
          btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
          showToast('âœ“ å…¨å•†å“ã‚’å“åˆ‡ã‚Œã«è¨­å®š');
        } catch (e) {
          console.error(e);
          showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
        }
      } else {
        const confirmed = await showConfirmDialog('å…¨å•†å“ã‚’è²©å£²å†é–‹ã—ã¾ã™ã‹?');
        if (!confirmed) return;
        
        try {
          const soldOutSnapshot = await getDocs(collection(db, 'sold_out'));
          const promises = [];
          soldOutSnapshot.forEach(docSnap => promises.push(deleteDoc(docSnap.ref)));
          
          await Promise.all(promises);
          isBulkSoldOut = false;
          btn.textContent = 'ä¸€æ‹¬';
          btn.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
          showToast('âœ“ å…¨å•†å“ã‚’è²©å£²å†é–‹');
        } catch (e) {
          console.error(e);
          showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
        }
      }
    };

    window.toggleTimeOverride = async function() {
      const btn = document.getElementById('time-override-btn');
      
      try {
        const settingsRef = doc(db, 'settings', 'timeOverride');
        const settingsSnap = await getDoc(settingsRef);
        const currentOverride = settingsSnap.exists() ? settingsSnap.data().enabled : false;
        
        const newOverride = !currentOverride;
        
        await setDoc(settingsRef, {
          enabled: newOverride,
          timestamp: Timestamp.now()
        });
        
        if (newOverride) {
          // å–¶æ¥­æ™‚é–“å¤–ã§ã‚‚æ³¨æ–‡å¯èƒ½ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰æœ‰åŠ¹ï¼‰
          btn.textContent = 'å–¶æ¥­';
          btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
          showToast('âœ“ å–¶æ¥­æ™‚é–“å¤–ã§ã‚‚æ³¨æ–‡å¯èƒ½ã«ã—ã¾ã—ãŸ');
        } else {
          // å–¶æ¥­æ™‚é–“å¤–ãƒã‚§ãƒƒã‚¯æœ‰åŠ¹ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ç„¡åŠ¹ï¼‰
          btn.textContent = 'æ™‚å¤–';
          btn.style.background = 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)';
          showToast('âœ“ å–¶æ¥­æ™‚é–“å¤–ãƒã‚§ãƒƒã‚¯ã‚’æœ‰åŠ¹ã«ã—ã¾ã—ãŸ');
        }
      } catch (e) {
        console.error(e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    };
    
    async function loadTimeOverrideStatus() {
      try {
        const settingsRef = doc(db, 'settings', 'timeOverride');
        const settingsSnap = await getDoc(settingsRef);
        const overrideEnabled = settingsSnap.exists() ? settingsSnap.data().enabled : false;
        
        const btn = document.getElementById('time-override-btn');
        if (overrideEnabled) {
          // å–¶æ¥­æ™‚é–“å¤–ã§ã‚‚æ³¨æ–‡å¯èƒ½ï¼ˆç·‘ï¼‰
          btn.textContent = 'å–¶æ¥­';
          btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
        } else {
          // å–¶æ¥­æ™‚é–“å¤–ãƒã‚§ãƒƒã‚¯æœ‰åŠ¹ï¼ˆç´«ï¼‰
          btn.textContent = 'æ™‚å¤–';
          btn.style.background = 'linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%)';
        }
      } catch (e) {
        console.error('æ™‚é–“ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    function showConfirmDialog(message) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
        `;
        
        const dialog = document.createElement('div');
        dialog.style.cssText = `
          background: white;
          border-radius: 15px;
          padding: 30px;
          max-width: 80%;
          text-align: center;
          box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        `;
        
        const text = document.createElement('div');
        text.textContent = message;
        text.style.cssText = `
          font-size: 18px;
          margin-bottom: 20px;
          color: #333;
        `;
        
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = `
          display: flex;
          gap: 10px;
          justify-content: center;
        `;
        
        const okButton = document.createElement('button');
        okButton.textContent = 'OK';
        okButton.style.cssText = `
          padding: 12px 30px;
          background: #2196F3;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight:bold;
          cursor: pointer;
        `;
        okButton.onclick = () => {
          overlay.remove();
          resolve(true);
        };
        
        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
        cancelButton.style.cssText = `
          padding: 12px 30px;
          background: #757575;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
        `;
        cancelButton.onclick = () => {
          overlay.remove();
          resolve(false);
        };
        
        buttonContainer.appendChild(okButton);
        buttonContainer.appendChild(cancelButton);
        dialog.appendChild(text);
        dialog.appendChild(buttonContainer);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
      });
    }

    window.increaseWaiting = async () => {
      const ref = doc(db, 'settings', 'waiting');
      const snapshot = await getDocs(collection(db, 'settings'));
      let count = 0;
      snapshot.forEach(d => { if (d.id === 'waiting') count = d.data().manualCount || 0; });
      await setDoc(ref, { manualCount: count + 1 });
      showToast('âœ“ å¾…ã¡+1');
    };

    window.resetWaiting = async () => {
      await setDoc(doc(db, 'settings', 'waiting'), { manualCount: 0 });
      showToast('âœ“ ãƒªã‚»ãƒƒãƒˆ');
    };

    function showToast(msg) {
      const toast = document.createElement('div');
      toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);color:white;padding:30px 50px;border-radius:15px;font-size:24px;font-weight:bold;z-index:10000;';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }
    
    // ========== ãƒãƒƒãƒˆå›ç·šç›£è¦– ==========
    
    let isOffline = false;
    let offlineNotificationShown = false;
    
    // ãƒãƒƒãƒˆå›ç·šã®çŠ¶æ…‹ã‚’ç›£è¦–
    function checkOnlineStatus() {
      if (!navigator.onLine && !isOffline) {
        isOffline = true;
        showOfflineNotification();
      } else if (navigator.onLine && isOffline) {
        isOffline = false;
        hideOfflineNotification();
        showToast('âœ“ ãƒãƒƒãƒˆå›ç·šãŒå¾©æ—§ã—ã¾ã—ãŸ');
      }
    }
    
    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³é€šçŸ¥ã‚’è¡¨ç¤º
    function showOfflineNotification() {
      if (offlineNotificationShown) return;
      offlineNotificationShown = true;
      
      const notification = document.createElement('div');
      notification.id = 'offline-notification';
      notification.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #ff6b6b 0%, #c92a2a 100%);
        color: white;
        padding: 20px;
        text-align: center;
        z-index: 9999;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      `;
      
      notification.innerHTML = `
        <div style="font-size: 18px; font-weight: bold; margin-bottom: 10px;">
          âš ï¸ ãƒãƒƒãƒˆå›ç·šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ
        </div>
        <div style="font-size: 14px; margin-bottom: 15px;">
          éŸ³å£°é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™
        </div>
        <button onclick="enableAudioNotification()" style="
          padding: 12px 30px;
          background: white;
          color: #c92a2a;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
          box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        ">
          ğŸ”Š éŸ³å£°ã‚’æœ‰åŠ¹ã«ã™ã‚‹
        </button>
      `;
      
      document.body.appendChild(notification);
      showToast('âš ï¸ ãƒãƒƒãƒˆå›ç·šãŒåˆ‡æ–­ã•ã‚Œã¾ã—ãŸ');
    }
    
    // ã‚ªãƒ•ãƒ©ã‚¤ãƒ³é€šçŸ¥ã‚’éè¡¨ç¤º
    function hideOfflineNotification() {
      const notification = document.getElementById('offline-notification');
      if (notification) {
        notification.remove();
        offlineNotificationShown = false;
      }
    }
    
    // éŸ³å£°é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹
    window.enableAudioNotification = function() {
      // éŸ³å£°ã‚’å†ç”Ÿã—ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¨˜éŒ²
      const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGi77eifTRAMUKjj8LZjHAY4ktfyzXksBS'
      );
      audio.play().then(() => {
        showToast('âœ“ éŸ³å£°é€šçŸ¥ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ');
        hideOfflineNotification();
      }).catch(e => {
        showToast('éŸ³å£°ã®æœ‰åŠ¹åŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ');
      });
    };
    
    // åˆå›ãƒã‚§ãƒƒã‚¯
    checkOnlineStatus();
    
    // å®šæœŸçš„ã«ãƒã‚§ãƒƒã‚¯ï¼ˆ5ç§’ã”ã¨ï¼‰
    setInterval(checkOnlineStatus, 5000);
    
    // ã‚ªãƒ³ãƒ©ã‚¤ãƒ³/ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒªãƒƒã‚¹ãƒ³
    window.addEventListener('online', checkOnlineStatus);
    window.addEventListener('offline', checkOnlineStatus);

    window.loadOrders = loadOrders;
  </script>
  
  <!-- æ”¯æ‰•ã„æ–¹æ³•é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="paymentModal" class="payment-modal-overlay">
    <div class="payment-modal">
      <h3>ğŸ’³ æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠ</h3>
      <div id="paymentMethodsList">
        <button class="payment-method-btn" data-method="cash" onclick="selectPaymentMethod('cash', this)">ğŸ’µ ç¾é‡‘</button>
        <button class="payment-method-btn" data-method="emoney" onclick="selectPaymentMethod('emoney', this)">ğŸ“± é›»å­ãƒãƒãƒ¼</button>
        <button class="payment-method-btn" data-method="credit" onclick="selectPaymentMethod('credit', this)">ğŸ’³ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆã‚«ãƒ¼ãƒ‰</button>
      </div>
      <div class="payment-modal-buttons">
        <button class="payment-modal-btn confirm" onclick="confirmPayment()">ä¼šè¨ˆå®Œäº†</button>
        <button class="payment-modal-btn cancel" onclick="closePaymentModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      </div>
    </div>
  </div>
  
  </div> <!-- mainContentçµ‚äº† -->

  <script>
    // åº—èˆ—åˆ¥ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
    let currentStoreId = null;
    let currentStoreName = null;

    async function handleControllerLogin(event) {
      event.preventDefault();
      
      const storeNameInput = document.getElementById('controllerStoreNameInput').value.trim();
      const passwordInput = document.getElementById('controllerPasswordInput').value;
      const loginError = document.getElementById('controllerLoginError');
      
      if (!storeNameInput || !passwordInput) {
        loginError.textContent = 'åº—èˆ—åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
        loginError.style.display = 'block';
        return;
      }

      try {
        // Firebaseã®åˆæœŸåŒ–ã‚’å¾…ã¤
        if (!window.db) {
          loginError.textContent = 'ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ä¸­ã§ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚';
          loginError.style.display = 'block';
          return;
        }

        const { collection, query, where, getDocs } = window.firebaseModules || {};
        if (!collection || !query || !where || !getDocs) {
          loginError.textContent = 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ';
          loginError.style.display = 'block';
          return;
        }

        // åº—èˆ—åã§æ¤œç´¢
        const storesRef = collection(window.db, 'stores');
        const q = query(storesRef, where('storeName', '==', storeNameInput));
        const querySnapshot = await getDocs(q);

        // æ–°ã—ã„åº—èˆ—åˆ¥èªè¨¼
        if (!querySnapshot.empty) {
          let authenticated = false;
          let storeData = null;
          let storeDocId = null;

          querySnapshot.forEach((doc) => {
            const data = doc.data();
            if (data.storePassword === passwordInput) {
              if (!data.isActive) {
                loginError.textContent = 'ã“ã®åº—èˆ—ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™';
                loginError.style.display = 'block';
                return;
              }
              authenticated = true;
              storeData = data;
              storeDocId = doc.id;
            }
          });

          if (authenticated && storeData) {
            currentStoreId = storeDocId;
            currentStoreName = storeData.storeName;
            
            sessionStorage.setItem('controllerStoreId', currentStoreId);
            sessionStorage.setItem('controllerStoreName', currentStoreName);
            sessionStorage.setItem('controllerAuthenticated', 'true');
            
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            // ãƒ˜ãƒƒãƒ€ãƒ¼ã«åº—èˆ—åã‚’è¡¨ç¤º
            const header = document.querySelector('.header h1');
            if (header) {
              header.textContent = currentStoreName + ' - æ³¨æ–‡ç®¡ç†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼';
            }
            
            console.log('âœ… åº—èˆ—åˆ¥ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ:', currentStoreName, 'ID:', currentStoreId);
            
            // åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
            initController();
            return;
          }
        }
        
        // åº—èˆ—ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€æ—§ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼ã‚’è©¦ã™ï¼ˆä¸‹èµ¤å¡šåº—ç”¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
        if (storeNameInput === 'ä¸‹èµ¤å¡š' && passwordInput === 'K12290619T') {
          currentStoreId = null; // nullã®å ´åˆã¯æ—§ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¹ã‚’ä½¿ç”¨
          currentStoreName = 'ä¸‹èµ¤å¡š';
          
          sessionStorage.setItem('controllerStoreId', '');
          sessionStorage.setItem('controllerStoreName', currentStoreName);
          sessionStorage.setItem('controllerAuthenticated', 'true');
          
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('mainContent').style.display = 'block';
          
          const header = document.querySelector('.header h1');
          if (header) {
            header.textContent = currentStoreName + ' - æ³¨æ–‡ç®¡ç†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼';
          }
          
          console.log('âœ… æ—§ã‚·ã‚¹ãƒ†ãƒ ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸï¼ˆç§»è¡Œå‰ï¼‰:', currentStoreName);
          
          initController();
          return;
        }

        // ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—
        loginError.textContent = 'ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“';
        loginError.style.display = 'block';
        document.getElementById('controllerPasswordInput').value = '';
      } catch (error) {
        console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
        loginError.textContent = 'ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
        loginError.style.display = 'block';
      }
    }

    // åˆæœŸåŒ–å‡¦ç†
    function initController() {
      console.log('ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼åˆæœŸåŒ–:', currentStoreName);
      // loadOrders ãªã©ã®æ—¢å­˜ã®åˆæœŸåŒ–é–¢æ•°ã‚’å‘¼ã³å‡ºã™
      if (typeof loadOrders === 'function') {
        loadOrders();
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®å‡¦ç†
    window.addEventListener('DOMContentLoaded', () => {
      const savedAuth = sessionStorage.getItem('controllerAuthenticated');
      const savedStoreId = sessionStorage.getItem('controllerStoreId');
      const savedStoreName = sessionStorage.getItem('controllerStoreName');
      
      if (savedAuth === 'true' && savedStoreName) {
        // ç©ºæ–‡å­—åˆ—ã‚‚OKï¼ˆæ—§ã‚·ã‚¹ãƒ†ãƒ ç”¨ï¼‰
        currentStoreId = savedStoreId || null;
        currentStoreName = savedStoreName;
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        
        const header = document.querySelector('.header h1');
        if (header) {
          header.textContent = currentStoreName + ' - æ³¨æ–‡ç®¡ç†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼';
        }
        
        // åˆæœŸåŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
        initController();
      } else {
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('mainContent').style.display = 'none';
      }
    });
  </script>
  
</body>
</html>
