<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ³¨æ–‡ç®¡ç†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 15px;
      min-height: 100vh;
    }
    .header {
      background: white;
      color: #667eea;
      padding: 15px 20px;
      border-radius: 15px;
      margin-bottom: 15px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .header h1 { font-size: 20px; font-weight: bold; }
    .top-controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .big-btn {
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: all 0.3s;
      color: white;
    }
    .big-btn:active { transform: scale(0.95); }
    .btn-refresh { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); }
    .btn-add-waiting { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); }
    .btn-soldout { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
    .manual-waiting-card {
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      text-align: center;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .manual-count { font-size: 32px; font-weight: bold; color: #FF9800; margin: 10px 0; }
    .btn-reset {
      padding: 12px 25px;
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
    }
    .order-card { 
      background: white; 
      border-radius: 12px; 
      padding: 15px; 
      margin-bottom: 15px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
    }
    .order-number { font-size: 28px; font-weight: bold; color: #4CAF50; }
    .order-table {
      display: inline-block;
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      padding: 6px 15px;
      border-radius: 15px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .order-item {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
    }
    .order-item-name {
      font-size: 16px;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .order-item-toppings {
      font-size: 13px;
      color: #666;
      margin: 3px 0;
      padding-left: 10px;
    }
    .order-item-memo {
      font-size: 12px;
      color: #f44336;
      margin-top: 5px;
      padding-left: 10px;
    }
    .control-btn {
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      color: white;
      margin: 5px;
    }
    .btn-complete { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); }
    .btn-cancel { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); }
    .staff-call-card {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      animation: pulse 1s infinite;
    }
    .staff-call-table { font-size: 48px; font-weight: bold; text-align: center; margin: 10px 0; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
    .hidden { display: none; }
    .category-filter {
      background: white;
      padding: 15px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .category-filter select {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      border: 3px solid #9C27B0;
      border-radius: 12px;
    }
    .soldout-item {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .soldout-item.sold-out { background: #f5f5f5; opacity: 0.7; }
    .soldout-item-name { font-size: 16px; font-weight: bold; color: #333; }
    .soldout-badge { background: #f44336; color: white; padding: 5px 10px; border-radius: 8px; font-size: 12px; font-weight: bold; margin-top: 5px; display: inline-block; }
    .soldout-toggle-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      color: white;
    }
    .soldout-toggle-btn.set-soldout { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); }
    .soldout-toggle-btn.set-available { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); }
  </style>
</head>
<body>
  <div class="header"><h1>é«˜ç”°ã®æ³¨æ–‡ç®¡ç†ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼</h1></div>
  
  <div id="page-orders">
    <div class="top-controls">
      <button class="big-btn btn-refresh" onclick="loadOrders()">ğŸ”„ æ›´æ–°</button>
      <button class="big-btn btn-add-waiting" onclick="increaseWaiting()">ğŸ‘¥ å¾…ã¡+1</button>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
      <button class="big-btn btn-soldout" onclick="showSoldOutPage()">ğŸš« å“åˆ‡ã‚Œè¨­å®š</button>
      <button class="big-btn" id="bulk-soldout-btn" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);" onclick="toggleBulkSoldOut()">ğŸš« ä¸€æ‹¬å“åˆ‡ã‚Œ</button>
    </div>
    
    <div class="manual-waiting-card">
      <div>æ‰‹å‹•å¾…ã¡äººæ•°</div>
      <div class="manual-count" id="manual-count">0</div>
      <button class="btn-reset" onclick="resetWaiting()">ãƒªã‚»ãƒƒãƒˆ</button>
    </div>
    
    <div id="staff-calls-container"></div>
    <div id="orders-container"><div style="text-align:center;color:white;padding:40px;">èª­ã¿è¾¼ã¿ä¸­...</div></div>
  </div>

  <div id="page-soldout" class="hidden">
    <button class="big-btn btn-refresh" style="margin-bottom: 15px;" onclick="backToOrders()">â† æ³¨æ–‡ç®¡ç†ã«æˆ»ã‚‹</button>
    
    <div class="header" style="margin-bottom: 15px;">
      <h1>ğŸš« å“åˆ‡ã‚Œè¨­å®š</h1>
    </div>
    
    <div class="category-filter">
      <label style="display:block;font-size:16px;font-weight:bold;margin-bottom:10px;">ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„</label>
      <select id="soldout-category-select">
        <option value="">å…¨ã¦ã®å•†å“</option>
      </select>
    </div>
    
    <div id="soldout-menu-list"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, getDocs, getDoc, doc, deleteDoc, setDoc, updateDoc, Timestamp, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    const app = initializeApp({
      apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
      authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
      projectId: "takoyaki-order-system-bacd7",
      storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
      messagingSenderId: "104494752890",
      appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
    });
    const db = getFirestore(app);

    let audioEnabled = false;
    let isFirstOrderLoad = true;
    let lastOrderCount = 0;
    let allMenuItems = [];
    let isBulkSoldOut = false;

    window.onload = async function() {
      showAudioEnablePopup();
    };

    function showAudioEnablePopup() {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
      `;
      
      const popup = document.createElement('div');
      popup.style.cssText = `
        background: white;
        border-radius: 20px;
        padding: 40px;
        max-width: 90%;
        text-align: center;
        box-shadow: 0 10px 40px rgba(0,0,0,0.5);
      `;
      
      popup.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 20px;">ğŸ”Š</div>
        <div style="font-size: 22px; font-weight: bold; margin-bottom: 15px; color: #333;">
          éŸ³å£°é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã—ã¾ã™ã‹?
        </div>
        <div style="font-size: 16px; color: #666; margin-bottom: 30px;">
          æ–°è¦æ³¨æ–‡ãŒå…¥ã£ãŸæ™‚ã«éŸ³ã§ãŠçŸ¥ã‚‰ã›ã—ã¾ã™
        </div>
        <button style="
          padding: 15px 40px;
          background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
          color: white;
          border: none;
          border-radius: 12px;
          font-size: 18px;
          font-weight: bold;
          cursor: pointer;
          box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        ">æœ‰åŠ¹ã«ã™ã‚‹</button>
      `;
      
      popup.querySelector('button').onclick = () => {
        audioEnabled = true;
        overlay.remove();
        loadOrders();
        watchWaiting();
        watchStaffCalls();
        watchOrders();
      };
      
      overlay.appendChild(popup);
      document.body.appendChild(overlay);
    }

    function watchOrders() {
      onSnapshot(collection(db, 'orders'), (snapshot) => {
        const currentCount = snapshot.size;
        
        if (!isFirstOrderLoad && currentCount > lastOrderCount) {
          playOrderSound();
        }
        
        lastOrderCount = currentCount;
        isFirstOrderLoad = false;
        
        loadOrders();
      });
    }

    function watchWaiting() {
      onSnapshot(doc(db, 'settings', 'waiting'), (doc) => {
        if (doc.exists()) {
          const count = doc.data().manualCount || 0;
          document.getElementById('manual-count').textContent = count;
        }
      });
    }

    function watchStaffCalls() {
      let isFirstLoad = true;
      onSnapshot(collection(db, 'staff_calls'), (snapshot) => {
        const container = document.getElementById('staff-calls-container');
        container.innerHTML = '';
        
        const calls = [];
        snapshot.forEach(doc => calls.push({ id: doc.id, ...doc.data() }));
        calls.sort((a, b) => b.timestamp.seconds - a.timestamp.seconds);
        
        calls.forEach(call => {
          const isBill = call.type === 'bill';
          const card = document.createElement('div');
          card.className = 'staff-call-card';
          if (isBill) card.style.background = 'linear-gradient(135deg, #2196F3 0%, #1976D2 100%)';
          
          card.innerHTML = `
            <div style="font-size:24px;text-align:center;font-weight:bold;">
              ${isBill ? 'ğŸ’³ ãŠä¼šè¨ˆã§ã™' : 'ğŸ“ å‘¼ã³å‡ºã—'}
            </div>
            <div class="staff-call-table">${call.tableNumber || 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ'}</div>
            <button class="btn-reset" style="width:100%;margin-top:10px;" onclick="dismissCall('${call.id}')">å¯¾å¿œå®Œäº†</button>
          `;
          container.appendChild(card);
        });
        
        if (!isFirstLoad && calls.length > 0) {
          const isBill = calls[0].type === 'bill';
          if (isBill) playBillSound();
          else playCallSound();
        }
        isFirstLoad = false;
      });
    }

    window.dismissCall = async (id) => {
      await deleteDoc(doc(db, 'staff_calls', id));
      showToast('âœ“ å¯¾å¿œå®Œäº†');
    };

    function playOrderSound() {
      if (!audioEnabled) {
        console.log('âš ï¸ éŸ³å£°é€šçŸ¥ãŒç„¡åŠ¹ã§ã™');
        return;
      }
      console.log('ğŸ”Š æ³¨æ–‡éŸ³ã‚’å†ç”Ÿ');
      try {
        const audio = new Audio('./order.wav');
        audio.volume = 1.0;
        audio.play()
          .then(() => console.log('âœ… æ³¨æ–‡éŸ³å†ç”ŸæˆåŠŸ'))
          .catch(e => console.error('âŒ æ³¨æ–‡éŸ³å†ç”Ÿå¤±æ•—:', e));
      } catch (e) {
        console.error('âŒ æ³¨æ–‡éŸ³ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    function playCallSound() {
      if (!audioEnabled) {
        console.log('âš ï¸ éŸ³å£°é€šçŸ¥ãŒç„¡åŠ¹ã§ã™');
        return;
      }
      console.log('ğŸ”Š å‘¼ã³å‡ºã—éŸ³ã‚’å†ç”Ÿ');
      try {
        const audio = new Audio('./call.wav');
        audio.volume = 1.0;
        audio.play()
          .then(() => console.log('âœ… å‘¼ã³å‡ºã—éŸ³å†ç”ŸæˆåŠŸ'))
          .catch(e => console.error('âŒ å‘¼ã³å‡ºã—éŸ³å†ç”Ÿå¤±æ•—:', e));
      } catch (e) {
        console.error('âŒ å‘¼ã³å‡ºã—éŸ³ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    function playBillSound() {
      if (!audioEnabled) {
        console.log('âš ï¸ éŸ³å£°é€šçŸ¥ãŒç„¡åŠ¹ã§ã™');
        return;
      }
      console.log('ğŸ”Š ãŠä¼šè¨ˆéŸ³ã‚’å†ç”Ÿ');
      try {
        const audio = new Audio('./okaikei.wav');
        audio.volume = 1.0;
        audio.play()
          .then(() => console.log('âœ… ãŠä¼šè¨ˆéŸ³å†ç”ŸæˆåŠŸ'))
          .catch(e => console.error('âŒ ãŠä¼šè¨ˆéŸ³å†ç”Ÿå¤±æ•—:', e));
      } catch (e) {
        console.error('âŒ ãŠä¼šè¨ˆéŸ³ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    async function loadOrders() {
      const orders = [];
      (await getDocs(collection(db, 'orders'))).forEach(doc => {
        const d = doc.data();
        orders.push({
          id: doc.id,
          orderNumber: d.orderNumber,
          tableNumber: d.tableNumber,
          items: d.items,
          totalAmount: d.totalAmount,
          memo: d.memo || {},
          completedAt: d.completedAt || null,
          cancelledAt: d.cancelledAt || null,
          paidAt: d.paidAt || null
        });
      });
      
      const container = document.getElementById('orders-container');
      if (orders.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:white;padding:40px;">ç¾åœ¨æ³¨æ–‡ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
        return;
      }
      
      container.innerHTML = '';
      orders.sort((a, b) => a.orderNumber - b.orderNumber).forEach(order => {
        const card = document.createElement('div');
        card.className = 'order-card';
        
        let statusBadge = '';
        if (order.completedAt) {
          statusBadge = '<div style="background:#4CAF50;color:white;padding:5px 10px;border-radius:8px;display:inline-block;margin:5px 0;">âœ“ å®Œäº†æ¸ˆã¿</div>';
        } else if (order.cancelledAt) {
          statusBadge = '<div style="background:#f44336;color:white;padding:5px 10px;border-radius:8px;display:inline-block;margin:5px 0;">âœ• ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¸ˆã¿</div>';
        }
        
        let paidBadge = '';
        if (order.paidAt) {
          paidBadge = '<div style="background:#2196F3;color:white;padding:5px 10px;border-radius:8px;display:inline-block;margin:5px 5px 5px 0;">ğŸ’³ ä¼šè¨ˆæ¸ˆ</div>';
        }
        
        const itemsHtml = order.items.map((item, idx) => {
          const memoText = order.memo[idx] || '';
          const toppingsText = item.toppings && item.toppings !== 'ãªã—' ? item.toppings : '';
          
          return `
            <div class="order-item">
              <div class="order-item-name">${item.name} Ã— ${item.quantity}</div>
              ${toppingsText ? `<div class="order-item-toppings">ğŸ´ ${toppingsText}</div>` : ''}
              ${memoText ? `<div class="order-item-memo">ğŸ“ ${memoText}</div>` : ''}
            </div>
          `;
        }).join('');
        
        card.innerHTML = `
          <div class="order-number">#${order.orderNumber}</div>
          <div class="order-table">${order.tableNumber}</div>
          ${statusBadge}${paidBadge}
          ${itemsHtml}
          <div style="font-size:20px;font-weight:bold;color:#4CAF50;margin-top:10px;">Â¥${order.totalAmount.toLocaleString()}</div>
          <div style="margin-top:10px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
            <button class="control-btn btn-complete" style="font-size:11px;" data-order-id="${order.id}" data-table="${order.tableNumber}">âœ“å®Œäº†</button>
            <button class="control-btn btn-cancel" style="font-size:11px;" data-order-id="${order.id}" data-table="${order.tableNumber}">âœ•ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            <button class="control-btn" style="background:linear-gradient(135deg,#9C27B0 0%,#7B1FA2 100%);font-size:11px;" data-order-id="${order.id}">ğŸ“‹è©³ç´°</button>
          </div>
          <div style="margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <button class="control-btn" id="paid-btn-${order.id}" style="background:linear-gradient(135deg,${order.paidAt ? '#2196F3' : '#FFC107'} 0%,${order.paidAt ? '#1976D2' : '#FFA000'} 100%);font-size:11px;" data-order-id="${order.id}" data-table="${order.tableNumber}" data-paid="${order.paidAt ? 'true' : 'false'}">${order.paidAt ? 'ğŸ’³ æ¸ˆ' : 'ğŸ’³ æœª'}</button>
            <button class="control-btn" style="background:linear-gradient(135deg,#757575 0%,#616161 100%);font-size:11px;" data-order-id="${order.id}">ğŸ—‘ï¸å‰Šé™¤</button>
          </div>
        `;
        
        const completeBtn = card.querySelector('.btn-complete');
        const cancelBtn = card.querySelector('.btn-cancel');
        const detailBtn = card.querySelectorAll('.control-btn')[2];
        const paidBtn = card.querySelectorAll('.control-btn')[3];
        const deleteBtn = card.querySelectorAll('.control-btn')[4];
        
        completeBtn.onclick = () => completeOrder(order.id, order.tableNumber, order.orderNumber);
        cancelBtn.onclick = () => cancelOrder(order.id, order.tableNumber, order.orderNumber);
        detailBtn.onclick = () => showOrderDetail(order);
        paidBtn.onclick = () => togglePaidStatus(order);
        deleteBtn.onclick = () => deleteOrder(order.id);
        
        container.appendChild(card);
      });
    }

    function showOrderDetail(order) {
      const overlay = document.createElement('div');
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        overflow-y: auto;
        padding: 20px 0;
      `;
      
      const dialog = document.createElement('div');
      dialog.style.cssText = `
        background: white;
        border-radius: 15px;
        padding: 20px;
        max-width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
      `;
      
      let itemsHtml = '';
      order.items.forEach((item, idx) => {
        const currentMemo = order.memo[idx] || '';
        const toppingsText = item.toppings && item.toppings !== 'ãªã—' ? item.toppings : 'ãªã—';
        itemsHtml += `
          <div style="background:#f5f5f5;padding:15px;border-radius:10px;margin-bottom:10px;">
            <div style="font-size:16px;font-weight:bold;margin-bottom:5px;">${item.name} Ã— ${item.quantity}</div>
            <div style="font-size:14px;color:#666;margin-bottom:8px;">ğŸ´ ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${toppingsText}</div>
            <input type="text" 
                   id="memo-${idx}" 
                   value="${currentMemo}"
                   placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›(ã‚½ãƒ¼ã‚¹å¤šã‚ã€ãƒãƒ¨æŠœããªã©)"
                   style="width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;font-size:14px;">
          </div>
        `;
      });
      
      dialog.innerHTML = `
        <div style="font-size:20px;font-weight:bold;margin-bottom:15px;text-align:center;">
          æ³¨æ–‡ #${order.orderNumber} ã®è©³ç´°
        </div>
        <div style="text-align:center;margin-bottom:15px;">
          <span style="background:#2196F3;color:white;padding:5px 15px;border-radius:15px;">${order.tableNumber}</span>
        </div>
        ${itemsHtml}
        <div style="font-size:18px;font-weight:bold;text-align:right;margin:15px 0;color:#4CAF50;">
          åˆè¨ˆ: Â¥${order.totalAmount.toLocaleString()}
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
          <button id="save-memo-btn" style="
            padding:15px;
            background:#4CAF50;
            color:white;
            border:none;
            border-radius:10px;
            font-size:16px;
            font-weight:bold;
            cursor:pointer;
          ">ğŸ’¾ ãƒ¡ãƒ¢ã‚’ä¿å­˜</button>
          <button id="close-detail-btn" style="
            padding:15px;
            background:#757575;
            color:white;
            border:none;
            border-radius:10px;
            font-size:16px;
            font-weight:bold;
            cursor:pointer;
          ">é–‰ã˜ã‚‹</button>
        </div>
      `;
      
      overlay.appendChild(dialog);
      document.body.appendChild(overlay);
      
      document.getElementById('save-memo-btn').onclick = async () => {
        const newMemo = {};
        order.items.forEach((item, idx) => {
          const input = document.getElementById(`memo-${idx}`);
          if (input && input.value.trim()) {
            newMemo[idx] = input.value.trim();
          }
        });
        
        await updateDoc(doc(db, 'orders', order.id), { memo: newMemo });
        showToast('âœ“ ãƒ¡ãƒ¢ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
        overlay.remove();
        loadOrders();
      };
      
      document.getElementById('close-detail-btn').onclick = () => overlay.remove();
    }

    async function completeOrder(orderId, tableNumber, orderNumber) {
      const confirmed = await showConfirmDialog('ã“ã®æ³¨æ–‡ã‚’å®Œäº†ã—ã¾ã™ã‹?');
      if (!confirmed) return;
      
      try {
        console.log('âœ… æ³¨æ–‡å®Œäº†å‡¦ç†é–‹å§‹:', orderId);
        
        await updateDoc(doc(db, 'orders', orderId), {
          status: 'completed',
          completedAt: Timestamp.now()
        });
        
        console.log('âœ… Firestoreæ›´æ–°å®Œäº† - Cloud FunctionsãŒãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™');
        showToast('âœ“ å®Œäº†ã—ã¾ã—ãŸ');
        loadOrders();
      } catch (e) {
        console.error('âŒ ã‚¨ãƒ©ãƒ¼:', e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }

    async function cancelOrder(orderId, tableNumber, orderNumber) {
      const confirmed = await showConfirmDialog('ã“ã®æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹?');
      if (!confirmed) return;
      
      try {
        console.log('âœ… ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†é–‹å§‹:', orderId);
        
        await updateDoc(doc(db, 'orders', orderId), {
          cancelledAt: Timestamp.now()
        });
        
        console.log('âœ… Firestoreæ›´æ–°å®Œäº† - Cloud FunctionsãŒãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™');
        showToast('âœ“ ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
        loadOrders();
      } catch (e) {
        console.error('âŒ ã‚¨ãƒ©ãƒ¼:', e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }

    async function deleteOrder(orderId) {
      const confirmed = await showConfirmDialog('ã“ã®æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã™ã‹?\nå‰Šé™¤ã™ã‚‹ã¨å¾©å…ƒã§ãã¾ã›ã‚“ã€‚');
      if (!confirmed) return;
      
      try {
        await deleteDoc(doc(db, 'orders', orderId));
        showToast('âœ“ æ³¨æ–‡ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        loadOrders();
      } catch (e) {
        console.error(e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }

    async function togglePaidStatus(order) {
      try {
        if (order.paidAt) {
          const confirmed = await showConfirmDialog('ä¼šè¨ˆã‚’æœªæ¸ˆã«æˆ»ã—ã¾ã™ã‹?');
          if (!confirmed) return;
          
          await updateDoc(doc(db, 'orders', order.id), {
            paidAt: null
          });
          
          showToast('âœ“ ä¼šè¨ˆã‚’æœªæ¸ˆã«æˆ»ã—ã¾ã—ãŸ');
          loadOrders();
        } else {
          console.log('âœ… ä¼šè¨ˆæ¸ˆã¿å‡¦ç†é–‹å§‹:', order.id);
          
          await updateDoc(doc(db, 'orders', order.id), {
            paidAt: Timestamp.now()
          });
          
          console.log('âœ… Firestoreæ›´æ–°å®Œäº† - Cloud FunctionsãŒãƒ—ãƒƒã‚·ãƒ¥é€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã™');
          showToast('âœ“ ä¼šè¨ˆæ¸ˆã¿ã«ã—ã¾ã—ãŸ');
          loadOrders();
        }
      } catch (e) {
        console.error(e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }

    window.showSoldOutPage = async function() {
      try {
        const menuSnapshot = await getDocs(collection(db, 'menu'));
        allMenuItems = [];
        const categories = new Set();
        
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          allMenuItems.push({
            id: data.id,
            name: data.name,
            price: data.price,
            category: data.category
          });
          if (data.category) categories.add(data.category);
        });
        
        const select = document.getElementById('soldout-category-select');
        select.innerHTML = '<option value="">å…¨ã¦ã®å•†å“</option>';
        Array.from(categories).sort().forEach(cat => {
          const opt = document.createElement('option');
          opt.value = cat;
          opt.textContent = cat;
          select.appendChild(opt);
        });
        
        select.onchange = () => {
          const filtered = select.value === '' ? allMenuItems : allMenuItems.filter(i => i.category === select.value);
          displaySoldOutItems(filtered);
        };
        
        await displaySoldOutItems(allMenuItems);
        document.getElementById('page-orders').style.display = 'none';
        document.getElementById('page-soldout').classList.remove('hidden');
      } catch (e) {
        console.error(e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    };

    window.backToOrders = function() {
      document.getElementById('page-soldout').classList.add('hidden');
      document.getElementById('page-orders').style.display = 'block';
    };

    async function displaySoldOutItems(items) {
      const list = document.getElementById('soldout-menu-list');
      list.innerHTML = '';
      
      const soldOutSnapshot = await getDocs(collection(db, 'sold_out'));
      const soldOutIds = new Set();
      soldOutSnapshot.forEach(doc => soldOutIds.add(doc.data().menuId));
      
      items.sort((a, b) => {
        const numA = parseInt(a.id.replace(/\D/g, ''));
        const numB = parseInt(b.id.replace(/\D/g, ''));
        return numA - numB;
      });
      
      items.forEach(item => {
        const isSoldOut = soldOutIds.has(item.id);
        const div = document.createElement('div');
        div.className = 'soldout-item' + (isSoldOut ? ' sold-out' : '');
        
        div.innerHTML = `
          <div>
            <div class="soldout-item-name">${item.name}</div>
            <div style="font-size:14px;color:#666;">Â¥${item.price.toLocaleString()}</div>
            ${isSoldOut ? '<span class="soldout-badge">å“åˆ‡ã‚Œä¸­</span>' : ''}
          </div>
          <button class="soldout-toggle-btn ${isSoldOut ? 'set-available' : 'set-soldout'}" 
                  onclick="toggleSoldOut('${item.id}', ${!isSoldOut})">
            ${isSoldOut ? 'âœ“ è²©å£²å†é–‹' : 'ğŸš« å“åˆ‡ã‚Œ'}
          </button>
        `;
        
        list.appendChild(div);
      });
    }

    window.toggleSoldOut = async function(menuId, setSoldOut) {
      try {
        if (setSoldOut) {
          await setDoc(doc(db, 'sold_out', menuId), {
            menuId: menuId,
            timestamp: Timestamp.now()
          });
          showToast('âœ“ å“åˆ‡ã‚Œã«è¨­å®š');
        } else {
          await deleteDoc(doc(db, 'sold_out', menuId));
          showToast('âœ“ è²©å£²å†é–‹');
        }
        
        const sel = document.getElementById('soldout-category-select');
        const filtered = sel.value === '' ? allMenuItems : allMenuItems.filter(i => i.category === sel.value);
        await displaySoldOutItems(filtered);
      } catch (e) {
        console.error(e);
        showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    };

    window.toggleBulkSoldOut = async function() {
      const btn = document.getElementById('bulk-soldout-btn');
      
      if (!isBulkSoldOut) {
        const confirmed = await showConfirmDialog('å…¨å•†å“ã‚’å“åˆ‡ã‚Œã«è¨­å®šã—ã¾ã™ã‹?');
        if (!confirmed) return;
        
        try {
          const menuSnapshot = await getDocs(collection(db, 'menu'));
          const promises = [];
          
          menuSnapshot.forEach(docSnap => {
            const data = docSnap.data();
            if (data.id) {
              promises.push(setDoc(doc(db, 'sold_out', data.id), {
                menuId: data.id,
                timestamp: Timestamp.now()
              }));
            }
          });
          
          await Promise.all(promises);
          isBulkSoldOut = true;
          btn.textContent = 'âœ“ ä¸€æ‹¬å†è²©';
          btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
          showToast('âœ“ å…¨å•†å“ã‚’å“åˆ‡ã‚Œã«è¨­å®š');
        } catch (e) {
          console.error(e);
          showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
        }
      } else {
        const confirmed = await showConfirmDialog('å…¨å•†å“ã‚’è²©å£²å†é–‹ã—ã¾ã™ã‹?');
        if (!confirmed) return;
        
        try {
          const soldOutSnapshot = await getDocs(collection(db, 'sold_out'));
          const promises = [];
          soldOutSnapshot.forEach(docSnap => promises.push(deleteDoc(docSnap.ref)));
          
          await Promise.all(promises);
          isBulkSoldOut = false;
          btn.textContent = 'ğŸš« ä¸€æ‹¬å“åˆ‡ã‚Œ';
          btn.style.background = 'linear-gradient(135deg, #f44336 0%, #d32f2f 100%)';
          showToast('âœ“ å…¨å•†å“ã‚’è²©å£²å†é–‹');
        } catch (e) {
          console.error(e);
          showToast('ã‚¨ãƒ©ãƒ¼: ' + e.message);
        }
      }
    };

    function showConfirmDialog(message) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
        `;
        
        const dialog = document.createElement('div');
        dialog.style.cssText = `
          background: white;
          border-radius: 15px;
          padding: 30px;
          max-width: 80%;
          text-align: center;
          box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        `;
        
        const text = document.createElement('div');
        text.textContent = message;
        text.style.cssText = `
          font-size: 18px;
          margin-bottom: 20px;
          color: #333;
        `;
        
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = `
          display: flex;
          gap: 10px;
          justify-content: center;
        `;
        
        const okButton = document.createElement('button');
        okButton.textContent = 'OK';
        okButton.style.cssText = `
          padding: 12px 30px;
          background: #2196F3;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
        `;
        okButton.onclick = () => {
          overlay.remove();
          resolve(true);
        };
        
        const cancelButton = document.createElement('button');
        cancelButton.textContent = 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«';
        cancelButton.style.cssText = `
          padding: 12px 30px;
          background: #757575;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
        `;
        cancelButton.onclick = () => {
          overlay.remove();
          resolve(false);
        };
        
        buttonContainer.appendChild(okButton);
        buttonContainer.appendChild(cancelButton);
        dialog.appendChild(text);
        dialog.appendChild(buttonContainer);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
      });
    }

    window.increaseWaiting = async () => {
      const ref = doc(db, 'settings', 'waiting');
      const snapshot = await getDocs(collection(db, 'settings'));
      let count = 0;
      snapshot.forEach(d => { if (d.id === 'waiting') count = d.data().manualCount || 0; });
      await setDoc(ref, { manualCount: count + 1 });
      showToast('âœ“ å¾…ã¡+1');
    };

    window.resetWaiting = async () => {
      await setDoc(doc(db, 'settings', 'waiting'), { manualCount: 0 });
      showToast('âœ“ ãƒªã‚»ãƒƒãƒˆ');
    };

    function showToast(msg) {
      const toast = document.createElement('div');
      toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);color:white;padding:30px 50px;border-radius:15px;font-size:24px;font-weight:bold;z-index:10000;';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }

    window.loadOrders = loadOrders;
  </script>
</body>
</html>