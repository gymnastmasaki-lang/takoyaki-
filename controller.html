<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ê≥®ÊñáÁÆ°ÁêÜ„Ç≥„É≥„Éà„É≠„Éº„É©„Éº</title>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 15px;
      min-height: 100vh;
    }
    .header {
      background: white;
      color: #667eea;
      padding: 15px 20px;
      border-radius: 15px;
      margin-bottom: 15px;
      text-align: center;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .header h1 { font-size: 20px; font-weight: bold; }
    .top-controls { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
    .big-btn {
      padding: 15px;
      font-size: 18px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0,0,0,0.3);
      transition: all 0.3s;
      color: white;
    }
    .big-btn:active { transform: scale(0.95); }
    .btn-refresh { background: #FFFF00; color: #333; }
    .btn-add-waiting { background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%); }
    .btn-soldout { background: linear-gradient(135deg, #9C27B0 0%, #7B1FA2 100%); }
    .manual-waiting-card {
      background: white;
      padding: 15px;
      border-radius: 12px;
      margin-bottom: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 15px;
    }
    .manual-waiting-label {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      white-space: nowrap;
    }
    .manual-count { 
      font-size: 32px; 
      font-weight: bold; 
      color: #FF9800; 
      flex: 1;
      text-align: center;
    }
    .btn-reset {
      padding: 12px 25px;
      background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      white-space: nowrap;
    }
    .order-card { 
      background: white; 
      border-radius: 12px; 
      padding: 15px; 
      margin-bottom: 15px; 
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      position: relative;
    }
    .order-number { font-size: 28px; font-weight: bold; color: #4CAF50; }
    .order-table {
      display: inline-block;
      background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
      color: white;
      padding: 6px 15px;
      border-radius: 15px;
      font-weight: bold;
      margin-bottom: 8px;
    }
    .order-item {
      background: #f5f5f5;
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
    }
    .order-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    .order-item-name {
      font-size: 16px;
      font-weight: bold;
    }
    .order-item-price {
      font-size: 14px;
      color: #666;
    }
    .order-item-toppings {
      font-size: 14px;
      color: #666;
      margin: 4px 0;
      padding-left: 10px;
      line-height: 1.8;
    }
    .order-item-total {
      font-size: 16px;
      font-weight: bold;
      color: #333;
      text-align: right;
      margin-top: 8px;
      padding-top: 8px;
      border-top: 1px solid #ddd;
    }
    .order-item-memo {
      font-size: 12px;
      color: #f44336;
      margin-top: 5px;
      padding-left: 10px;
    }
    .order-total {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin-top: 15px;
      text-align: right;
    }
    .order-total-label {
      font-size: 18px;
      font-weight: bold;
      color: #1976D2;
    }
    .order-total-amount {
      font-size: 24px;
      font-weight: bold;
      color: #1976D2;
      margin-top: 5px;
    }
    .control-btn {
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: bold;
      cursor: pointer;
      color: white;
      margin: 5px;
    }
    .btn-complete { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); }
    .btn-cancel { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); }
    .staff-call-card {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      color: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 15px;
      animation: pulse 1s infinite;
    }
    .staff-call-table { font-size: 48px; font-weight: bold; text-align: center; margin: 10px 0; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.02); } }
    .hidden { display: none; }
    .category-filter {
      background: white;
      padding: 15px;
      border-radius: 15px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    .category-filter select {
      width: 100%;
      padding: 15px;
      font-size: 18px;
      border: 3px solid #9C27B0;
      border-radius: 12px;
    }
    .soldout-item {
      background: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 12px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .soldout-item.sold-out { background: #f5f5f5; opacity: 0.7; }
    .soldout-item-name { font-size: 16px; font-weight: bold; color: #333; }
    .soldout-badge { background: #f44336; color: white; padding: 5px 10px; border-radius: 8px; font-size: 12px; font-weight: bold; margin-top: 5px; display: inline-block; }
    .soldout-toggle-btn {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      color: white;
    }
    .soldout-toggle-btn.set-soldout { background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%); }
    .soldout-toggle-btn.set-available { background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); }
    
    /* Èü≥Â£∞Ê°àÂÜÖ„Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´ */
    .audio-buttons-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    .audio-buttons-section h2 {
      text-align: center;
      color: #667eea;
      margin-bottom: 15px;
      font-size: 20px;
    }
    .audio-button-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
    }
    .audio-btn {
      padding: 20px 10px;
      font-size: 20px;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      color: white;
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      transition: all 0.3s;
    }
    .audio-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }
    .audio-btn:active {
      transform: scale(0.95);
    }
    .audio-btn.playing {
      background: linear-gradient(135deg, #FF9800 0%, #F57C00 100%);
      animation: pulse 0.5s infinite;
    }
    
    /* „Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖã„Ç§„É≥„Ç∏„Ç±„Éº„Çø„Éº */
    .connection-indicator {
      position: fixed;
      top: 10px;
      right: 10px;
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: bold;
      z-index: 9999;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      transition: all 0.3s;
    }
    .connection-indicator.online {
      background: #4CAF50;
      color: white;
    }
    .connection-indicator.offline {
      background: #f44336;
      color: white;
    }
    .connection-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: white;
    }
  </style>
</head>
<body>
  <div class="connection-indicator online" id="connectionStatus">
    <div class="connection-dot"></div>
    <span>„Ç™„É≥„É©„Ç§„É≥</span>
  </div>

  <div class="header">
    <h1>Ê≥®ÊñáÁÆ°ÁêÜ„Ç≥„É≥„Éà„É≠„Éº„É©„Éº</h1>
  </div>

  <div class="top-controls">
    <button class="big-btn btn-refresh" onclick="loadOrders()">üîÑ Êõ¥Êñ∞</button>
    <button class="big-btn btn-add-waiting" onclick="increaseWaiting()">ÂæÖ„Å°+1</button>
    <button class="big-btn btn-soldout" onclick="toggleSection('soldout')">Â£≤ÂàáÁÆ°ÁêÜ</button>
    <button class="big-btn" onclick="toggleSection('audio')" style="background: linear-gradient(135deg, #00BCD4 0%, #0097A7 100%);">üîä Èü≥Â£∞Ê°àÂÜÖ</button>
    <button class="big-btn" id="businessOverrideBtn" onclick="toggleBusinessHours()" style="background: linear-gradient(135deg, #FF5722 0%, #E64A19 100%);">Âñ∂Ê•≠ÊôÇÈñì</button>
  </div>

  <div class="manual-waiting-card">
    <div class="manual-waiting-label">ÊâãÂãïÂæÖ„Å°Êï∞</div>
    <div class="manual-count" id="manualWaitingCount">0</div>
    <button class="btn-reset" onclick="resetWaiting()">„É™„Çª„ÉÉ„Éà</button>
  </div>

  <div id="staffCallsContainer"></div>
  <div id="ordersContainer"></div>

  <!-- Â£≤„ÇäÂàá„ÇåÁÆ°ÁêÜ„Çª„ÇØ„Ç∑„Éß„É≥ -->
  <div id="soldoutSection" class="hidden">
    <div class="category-filter">
      <select id="soldoutCategoryFilter" onchange="filterSoldout()">
        <option value="all">„Åô„Åπ„Å¶</option>
      </select>
    </div>
    <div id="soldoutItemsContainer"></div>
  </div>

  <!-- Èü≥Â£∞Ê°àÂÜÖ„Çª„ÇØ„Ç∑„Éß„É≥ -->
  <div id="audioSection" class="hidden">
    <div class="audio-buttons-section">
      <h2>Èü≥Â£∞Ê°àÂÜÖ„Éú„Çø„É≥</h2>
      <div class="audio-button-grid" id="audioButtonGrid">
        <!-- Èü≥Â£∞„Éú„Çø„É≥„Åå„Åì„Åì„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js';
    import { getFirestore, collection, getDocs, doc, updateDoc, setDoc, onSnapshot, query, orderBy, where } from 'https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyBSwmWiMTRuN5bm0P46aaGzNz2a0qm7QKk",
      authDomain: "ramenorder-2baff.firebaseapp.com",
      projectId: "ramenorder-2baff",
      storageBucket: "ramenorder-2baff.firebasestorage.app",
      messagingSenderId: "502068620820",
      appId: "1:502068620820:web:e4bc2f13b1f85b7b00a882"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;

    let currentSection = 'orders';
    let menuItems = [];
    let categoryMap = {};

    // „Ç™„É≥„É©„Ç§„É≥Áä∂ÊÖã„ÅÆÁõ£Ë¶ñ
    window.addEventListener('online', () => {
      const indicator = document.getElementById('connectionStatus');
      indicator.className = 'connection-indicator online';
      indicator.innerHTML = '<div class="connection-dot"></div><span>„Ç™„É≥„É©„Ç§„É≥</span>';
    });

    window.addEventListener('offline', () => {
      const indicator = document.getElementById('connectionStatus');
      indicator.className = 'connection-indicator offline';
      indicator.innerHTML = '<div class="connection-dot"></div><span>„Ç™„Éï„É©„Ç§„É≥</span>';
    });

    async function loadOrders() {
      const q = query(collection(db, 'orders'), where('status', '==', 'pending'), orderBy('timestamp', 'desc'));
      const snapshot = await getDocs(q);
      const ordersContainer = document.getElementById('ordersContainer');
      ordersContainer.innerHTML = '';
      
      snapshot.forEach(docSnap => {
        const order = docSnap.data();
        const orderCard = document.createElement('div');
        orderCard.className = 'order-card';
        
        let itemsHTML = '';
        let grandTotal = 0;
        
        order.items.forEach((item, idx) => {
          const itemPrice = item.price || 0;
          const toppingPrice = item.toppingPrice || 0;
          const quantity = item.quantity || 1;
          const itemTotal = (itemPrice + toppingPrice) * quantity;
          grandTotal += itemTotal;
          
          // „Éà„ÉÉ„Éî„É≥„Ç∞„ÅÆË°®Á§∫
          let toppingsHTML = '';
          if (item.toppings && item.toppings !== '„Å™„Åó') {
            const toppingsList = item.toppings.split(',').map(t => t.trim());
            toppingsHTML = toppingsList.map(topping => 
              `<div class="order-item-toppings">„Éª${topping}</div>`
            ).join('');
          }
          
          // „É°„É¢„ÅÆË°®Á§∫
          let memoHTML = '';
          if (order.memo && order.memo[idx] || item.memo) {
            memoHTML = `<div class="order-item-memo">‚Äª ${order.memo?.[idx] || item.memo}</div>`;
          }
          
          itemsHTML += `
            <div class="order-item">
              <div class="order-item-header">
                <div class="order-item-name">${item.name} √ó ${quantity}</div>
                <div class="order-item-price">¬•${itemPrice.toLocaleString()}</div>
              </div>
              ${toppingsHTML}
              ${memoHTML}
              <div class="order-item-total">¬•${itemPrice.toLocaleString()} √ó ${quantity} = ¬•${itemTotal.toLocaleString()}</div>
            </div>
          `;
        });
        
        orderCard.innerHTML = `
          <div style="margin-bottom: 10px;">
            <span class="order-number">#${order.orderNumber}</span>
            <span class="order-table">${order.tableNumber}</span>
          </div>
          ${itemsHTML}
          <div class="order-total">
            <div class="order-total-label">ÂÖ®„Å¶„ÅÆÂêàË®àÈáëÈ°ç</div>
            <div class="order-total-amount">¬•${grandTotal.toLocaleString()}</div>
          </div>
          <div style="margin-top: 15px; text-align: center;">
            <button class="control-btn btn-complete" onclick="completeOrder('${docSnap.id}')">ÂÆå‰∫Ü</button>
            <button class="control-btn btn-cancel" onclick="cancelOrder('${docSnap.id}')">„Ç≠„É£„É≥„Çª„É´</button>
          </div>
        `;
        ordersContainer.appendChild(orderCard);
      });
    }

    async function loadStaffCalls() {
      const q = query(collection(db, 'staffCalls'), where('status', '==', 'pending'), orderBy('timestamp', 'desc'));
      const snapshot = await getDocs(q);
      const container = document.getElementById('staffCallsContainer');
      container.innerHTML = '';
      
      snapshot.forEach(docSnap => {
        const call = docSnap.data();
        const card = document.createElement('div');
        card.className = 'staff-call-card';
        card.innerHTML = `
          <div style="text-align:center;font-size:24px;font-weight:bold;">„Çπ„Çø„ÉÉ„ÉïÂëº„Å≥Âá∫„Åó</div>
          <div class="staff-call-table">${call.tableNumber}</div>
          <div style="text-align:center;">
            <button class="control-btn btn-complete" style="font-size:18px;padding:15px 40px;" onclick="resolveStaffCall('${docSnap.id}')">ÂØæÂøúÂÆå‰∫Ü</button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    window.completeOrder = async (orderId) => {
      await updateDoc(doc(db, 'orders', orderId), { status: 'completed' });
      showToast('‚úì ÂÆå‰∫Ü');
      loadOrders();
    };

    window.cancelOrder = async (orderId) => {
      const confirmed = await showConfirmDialog('„Åì„ÅÆÊ≥®Êñá„Çí„Ç≠„É£„É≥„Çª„É´„Åó„Åæ„Åô„Åã?');
      if (confirmed) {
        await updateDoc(doc(db, 'orders', orderId), { status: 'cancelled' });
        showToast('‚úì „Ç≠„É£„É≥„Çª„É´');
        loadOrders();
      }
    };

    window.resolveStaffCall = async (callId) => {
      await updateDoc(doc(db, 'staffCalls', callId), { status: 'resolved' });
      showToast('‚úì ÂØæÂøúÂÆå‰∫Ü');
      loadStaffCalls();
    };

    window.toggleSection = (section) => {
      currentSection = section;
      document.getElementById('ordersContainer').classList.toggle('hidden', section !== 'orders');
      document.getElementById('soldoutSection').classList.toggle('hidden', section !== 'soldout');
      document.getElementById('audioSection').classList.toggle('hidden', section !== 'audio');
      
      if (section === 'soldout') loadSoldoutItems();
      if (section === 'audio') loadAudioButtons();
    };

    async function loadSoldoutItems() {
      const snapshot = await getDocs(collection(db, 'menu'));
      menuItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      
      categoryMap = {};
      menuItems.forEach(item => {
        if (!categoryMap[item.category]) categoryMap[item.category] = [];
        categoryMap[item.category].push(item);
      });
      
      const filterSelect = document.getElementById('soldoutCategoryFilter');
      filterSelect.innerHTML = '<option value="all">„Åô„Åπ„Å¶</option>';
      Object.keys(categoryMap).forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        filterSelect.appendChild(option);
      });
      
      filterSoldout();
    }

    window.filterSoldout = () => {
      const category = document.getElementById('soldoutCategoryFilter').value;
      const container = document.getElementById('soldoutItemsContainer');
      container.innerHTML = '';
      
      const items = category === 'all' ? menuItems : (categoryMap[category] || []);
      
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = `soldout-item ${item.soldOut ? 'sold-out' : ''}`;
        div.innerHTML = `
          <div>
            <div class="soldout-item-name">${item.name}</div>
            ${item.soldOut ? '<span class="soldout-badge">Â£≤„ÇäÂàá„Çå</span>' : ''}
          </div>
          <button class="soldout-toggle-btn ${item.soldOut ? 'set-available' : 'set-soldout'}" 
                  onclick="toggleSoldout('${item.id}', ${!item.soldOut})">
            ${item.soldOut ? 'Ë≤©Â£≤ÂÜçÈñã' : 'Â£≤„ÇäÂàá„Çå'}
          </button>
        `;
        container.appendChild(div);
      });
    };

    window.toggleSoldout = async (itemId, newStatus) => {
      await updateDoc(doc(db, 'menu', itemId), { soldOut: newStatus });
      showToast(newStatus ? '‚úì Â£≤„ÇäÂàá„ÇåË®≠ÂÆö' : '‚úì Ë≤©Â£≤ÂÜçÈñã');
      loadSoldoutItems();
    };

    async function loadAudioButtons() {
      const snapshot = await getDocs(collection(db, 'audioButtons'));
      const grid = document.getElementById('audioButtonGrid');
      grid.innerHTML = '';
      
      snapshot.docs
        .map(doc => ({ id: doc.id, ...doc.data() }))
        .sort((a, b) => (a.order || 0) - (b.order || 0))
        .forEach(button => {
          const btn = document.createElement('button');
          btn.className = 'audio-btn';
          btn.textContent = button.label;
          btn.onclick = () => playAudioMessage(button.audioFile, btn);
          grid.appendChild(btn);
        });
    }

    function playAudioMessage(audioFile, buttonElement) {
      if (!audioFile) {
        showToast('Èü≥Â£∞„Éï„Ç°„Ç§„É´„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì');
        return;
      }
      
      const audio = new Audio(audioFile);
      buttonElement.classList.add('playing');
      
      audio.play().catch(err => {
        console.error('Èü≥Â£∞ÂÜçÁîü„Ç®„É©„Éº:', err);
        showToast('Èü≥Â£∞ÂÜçÁîü„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        buttonElement.classList.remove('playing');
      });
      
      audio.onended = () => {
        buttonElement.classList.remove('playing');
      };
    }

    window.toggleBusinessHours = async () => {
      const ref = doc(db, 'settings', 'businessHours');
      const snapshot = await getDocs(collection(db, 'settings'));
      let current = false;
      snapshot.forEach(d => { 
        if (d.id === 'businessHours') current = d.data().overrideEnabled || false; 
      });
      
      const newValue = !current;
      await setDoc(ref, { overrideEnabled: newValue });
      
      const btn = document.getElementById('businessOverrideBtn');
      if (newValue) {
        btn.textContent = 'Âñ∂Ê•≠';
        btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
        showToast('‚úì Âñ∂Ê•≠‰∏≠„Å´Ë®≠ÂÆö');
      } else {
        btn.textContent = 'Âñ∂Ê•≠ÊôÇÈñì';
        btn.style.background = 'linear-gradient(135deg, #FF5722 0%, #E64A19 100%)';
        showToast('‚úì ÈÄöÂ∏∏Âñ∂Ê•≠ÊôÇÈñì„Å´Êàª„Åô');
      }
    };

    async function loadBusinessHoursOverride() {
      const btn = document.getElementById('businessOverrideBtn');
      try {
        const snapshot = await getDocs(collection(db, 'settings'));
        let overrideEnabled = false;
        snapshot.forEach(d => { 
          if (d.id === 'businessHours') overrideEnabled = d.data().overrideEnabled || false; 
        });
        if (overrideEnabled) {
          btn.textContent = 'Âñ∂Ê•≠';
          btn.style.background = 'linear-gradient(135deg, #4CAF50 0%, #45a049 100%)';
        }
      } catch (e) {
        console.error('ÊôÇÈñì„Ç™„Éº„Éê„Éº„É©„Ç§„ÉâË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', e);
      }
    }

    function showConfirmDialog(message) {
      return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.5);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
        `;
        
        const dialog = document.createElement('div');
        dialog.style.cssText = `
          background: white;
          border-radius: 15px;
          padding: 30px;
          max-width: 80%;
          text-align: center;
          box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        `;
        
        const text = document.createElement('div');
        text.textContent = message;
        text.style.cssText = `
          font-size: 18px;
          margin-bottom: 20px;
          color: #333;
        `;
        
        const buttonContainer = document.createElement('div');
        buttonContainer.style.cssText = `
          display: flex;
          gap: 10px;
          justify-content: center;
        `;
        
        const okButton = document.createElement('button');
        okButton.textContent = 'OK';
        okButton.style.cssText = `
          padding: 12px 30px;
          background: #2196F3;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
        `;
        okButton.onclick = () => {
          overlay.remove();
          resolve(true);
        };
        
        const cancelButton = document.createElement('button');
        cancelButton.textContent = '„Ç≠„É£„É≥„Çª„É´';
        cancelButton.style.cssText = `
          padding: 12px 30px;
          background: #757575;
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: bold;
          cursor: pointer;
        `;
        cancelButton.onclick = () => {
          overlay.remove();
          resolve(false);
        };
        
        buttonContainer.appendChild(okButton);
        buttonContainer.appendChild(cancelButton);
        dialog.appendChild(text);
        dialog.appendChild(buttonContainer);
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
      });
    }

    window.increaseWaiting = async () => {
      const ref = doc(db, 'settings', 'waiting');
      const snapshot = await getDocs(collection(db, 'settings'));
      let count = 0;
      snapshot.forEach(d => { if (d.id === 'waiting') count = d.data().manualCount || 0; });
      await setDoc(ref, { manualCount: count + 1 });
      showToast('‚úì ÂæÖ„Å°+1');
    };

    window.resetWaiting = async () => {
      await setDoc(doc(db, 'settings', 'waiting'), { manualCount: 0 });
      showToast('‚úì „É™„Çª„ÉÉ„Éà');
    };

    function showToast(msg) {
      const toast = document.createElement('div');
      toast.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,0.9);color:white;padding:30px 50px;border-radius:15px;font-size:24px;font-weight:bold;z-index:10000;';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 2000);
    }

    // „É™„Ç¢„É´„Çø„Ç§„É†Êõ¥Êñ∞
    onSnapshot(query(collection(db, 'orders'), where('status', '==', 'pending')), () => {
      if (currentSection === 'orders') loadOrders();
    });

    onSnapshot(query(collection(db, 'staffCalls'), where('status', '==', 'pending')), () => {
      loadStaffCalls();
    });

    onSnapshot(doc(db, 'settings', 'waiting'), (docSnap) => {
      if (docSnap.exists()) {
        const count = docSnap.data().manualCount || 0;
        document.getElementById('manualWaitingCount').textContent = count;
      }
    });

    // ÂàùÊúüË™≠„ÅøËæº„Åø
    loadOrders();
    loadStaffCalls();
    loadBusinessHoursOverride();

    window.loadOrders = loadOrders;
  </script>
</body>
</html>
