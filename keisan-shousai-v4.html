<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½æ°‘ç¨è¨ˆç®—</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <!-- FirebaseåˆæœŸåŒ– -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
            authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
            projectId: "takoyaki-order-system-bacd7",
            storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
            messagingSenderId: "104494752890",
            appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.FirebaseReady = true;
        window.db = db;
        window.firebaseModules = { collection, getDocs, doc, getDoc };
    </script>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // åº—èˆ—IDãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
        window.currentStoreId = null;
        window.currentStoreName = null;

        window.getStoreCollection = function(collectionName) {
            if (!window.currentStoreId || window.currentStoreId === '' || window.currentStoreId === null) {
                const oldPathMap = {
                    'employees': 'kintai_employees',
                    'attendance': 'kintai_attendance'
                };
                const path = oldPathMap[collectionName] || collectionName;
                return window.firebaseModules.collection(window.db, path);
            }
            return window.firebaseModules.collection(window.db, 'stores', window.currentStoreId, collectionName);
        };

        const ResidentTaxCalculator = () => {
            const [employees, setEmployees] = useState([]);
            const [selectedEmployee, setSelectedEmployee] = useState(null);
            const [currentYear, setCurrentYear] = useState(new Date().getFullYear());
            const [currentMonth, setCurrentMonth] = useState(new Date().getMonth());
            
            // å‰å¹´æ‰€å¾—å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ 
            const [previousYearIncome, setPreviousYearIncome] = useState({
                year: new Date().getFullYear() - 1,
                totalIncome: 0,
                municipality: 'æ±äº¬éƒ½',
                socialInsurance: 0,
                incomeType: 'salary'
            });
            
            // è¨ˆç®—ã‚¿ã‚¤ãƒ—ï¼ˆæ™‚çµ¦ or å›ºå®šçµ¦ï¼‰- URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—
            const [salaryType, setSalaryType] = useState('hourly');
            
            // è¨ˆç®—çµæœ
            const [residentTax, setResidentTax] = useState(0);
            const [calculationDetails, setCalculationDetails] = useState(null);

            // ã‚»ãƒƒã‚·ãƒ§ãƒ³å¾©å…ƒ
            useEffect(() => {
                const storedStoreId = sessionStorage.getItem('kanriStoreId');
                const storedStoreName = sessionStorage.getItem('kanriStoreName');
                
                if (storedStoreName) {
                    let actualStoreId = null;
                    if (storedStoreId && storedStoreId !== '' && storedStoreId !== 'shimoakatsuka' && storedStoreId !== 'shimoarekasuka') {
                        actualStoreId = storedStoreId;
                    }
                    
                    window.currentStoreId = actualStoreId;
                    window.currentStoreName = storedStoreName;
                    loadEmployees();
                }
            }, []);

            // å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            const loadEmployees = async () => {
                try {
                    while (!window.FirebaseReady) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    
                    const { getDocs } = window.firebaseModules;
                    const empRef = window.getStoreCollection('employees');
                    const empSnapshot = await getDocs(empRef);
                    const empList = [];
                    
                    empSnapshot.forEach(docSnap => {
                        empList.push({ id: docSnap.id, ...docSnap.data() });
                    });
                    
                    empList.sort((a, b) => (a.order || 0) - (b.order || 0));
                    setEmployees(empList);
                    
                    // ğŸ†• URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å¾“æ¥­å“¡ã‚’è‡ªå‹•é¸æŠ
                    const params = new URLSearchParams(window.location.search);
                    const employeeId = params.get('employeeId');
                    const salaryTypeParam = params.get('salaryType');
                    const yearParam = params.get('year');
                    const monthParam = params.get('month');
                    
                    if (employeeId) {
                        const emp = empList.find(e => e.id === employeeId);
                        if (emp) {
                            setSelectedEmployee(emp);
                            console.log('âœ… URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å¾“æ¥­å“¡ã‚’è‡ªå‹•é¸æŠ:', emp.name);
                        }
                    }
                    
                    if (salaryTypeParam) {
                        setSalaryType(salaryTypeParam);
                        console.log('âœ… çµ¦ä¸ã‚¿ã‚¤ãƒ—:', salaryTypeParam === 'hourly' ? 'æ™‚é–“çµ¦' : 'å›ºå®šçµ¦');
                    }
                    
                    if (yearParam) setCurrentYear(parseInt(yearParam));
                    if (monthParam) setCurrentMonth(parseInt(monthParam));
                    
                    console.log('âœ… å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', empList.length, 'äºº');
                } catch (error) {
                    console.error('å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                }
            };

            // å¾“æ¥­å“¡é¸æŠæ™‚
            useEffect(() => {
                if (selectedEmployee) {
                    // ğŸ†• å‰å¹´æ‰€å¾—ã‚’è‡ªå‹•å–å¾—
                    loadPreviousYearIncome(selectedEmployee.id);
                }
            }, [selectedEmployee]);

            // ğŸ†• å‰å¹´æ‰€å¾—ã‚’è‡ªå‹•å–å¾—
            const loadPreviousYearIncome = async (employeeId) => {
                try {
                    const prevYear = currentYear - 1;
                    console.log(`ğŸ“Š ${prevYear}å¹´ã®æ‰€å¾—ã‚’å–å¾—ä¸­...`);
                    
                    const { getDocs } = window.firebaseModules;
                    const attRef = window.getStoreCollection('attendance');
                    const attSnapshot = await getDocs(attRef);
                    
                    let totalIncome = 0;
                    let totalSocialInsurance = 0;
                    
                    // å‰å¹´1æœˆã€œ12æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆ
                    attSnapshot.forEach(docSnap => {
                        const docId = docSnap.id;
                        const parts = docId.split('_');
                        
                        if (parts.length >= 2) {
                            const empId = parts[0];
                            const dateKey = parts.slice(1).join('_');
                            
                            // å¾“æ¥­å“¡IDã¨å¹´ã‚’ãƒã‚§ãƒƒã‚¯
                            if (empId === employeeId && dateKey.startsWith(`${prevYear}-`)) {
                                const data = docSnap.data();
                                
                                // ç·æ”¯çµ¦é¡ã‚’åŠ ç®—ï¼ˆhourlyTotalGrossã¾ãŸã¯fixedTotalGrossã‹ã‚‰å–å¾—ï¼‰
                                if (data.hourlyTotalGross) {
                                    totalIncome += data.hourlyTotalGross || 0;
                                }
                                if (data.fixedTotalGross) {
                                    totalIncome += data.fixedTotalGross || 0;
                                }
                                
                                // ç¤¾ä¼šä¿é™ºæ–™ã‚’åŠ ç®—
                                if (data.hourlyDeductions) {
                                    totalSocialInsurance += (data.hourlyDeductions.healthInsurance || 0);
                                    totalSocialInsurance += (data.hourlyDeductions.pension || 0);
                                    totalSocialInsurance += (data.hourlyDeductions.employmentInsurance || 0);
                                }
                                if (data.fixedDeductions) {
                                    totalSocialInsurance += (data.fixedDeductions.healthInsurance || 0);
                                    totalSocialInsurance += (data.fixedDeductions.pension || 0);
                                    totalSocialInsurance += (data.fixedDeductions.employmentInsurance || 0);
                                }
                            }
                        }
                    });
                    
                    // è‡ªå‹•å…¥åŠ›
                    if (totalIncome > 0) {
                        setPreviousYearIncome(prev => ({
                            ...prev,
                            year: prevYear,
                            totalIncome: Math.round(totalIncome),
                            socialInsurance: Math.round(totalSocialInsurance)
                        }));
                        
                        console.log(`âœ… ${prevYear}å¹´ã®æ‰€å¾—ã‚’å–å¾—ã—ã¾ã—ãŸ:`, {
                            ç·æ‰€å¾—: totalIncome,
                            ç¤¾ä¼šä¿é™ºæ–™: totalSocialInsurance
                        });
                        
                        alert(
                            `${prevYear}å¹´ã®æ‰€å¾—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ\n\n` +
                            `ç·æ‰€å¾—: Â¥${Math.round(totalIncome).toLocaleString()}\n` +
                            `ç¤¾ä¼šä¿é™ºæ–™: Â¥${Math.round(totalSocialInsurance).toLocaleString()}\n\n` +
                            `â€»æ‰‹å‹•ã§ç·¨é›†ã§ãã¾ã™`
                        );
                    } else {
                        console.log(`âš ï¸ ${prevYear}å¹´ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“`);
                        setPreviousYearIncome(prev => ({
                            ...prev,
                            year: prevYear,
                            totalIncome: 0,
                            socialInsurance: 0
                        }));
                    }
                } catch (error) {
                    console.error('å‰å¹´æ‰€å¾—å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
                }
            };

            // ä½æ°‘ç¨è¨ˆç®—
            const calculateResidentTax = () => {
                if (!selectedEmployee) {
                    alert('å¾“æ¥­å“¡ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
                
                if (previousYearIncome.totalIncome <= 0) {
                    alert('å‰å¹´ã®å¹´é–“æ‰€å¾—ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                
                // çµ¦ä¸æ‰€å¾—æ§é™¤
                let employmentIncomeDeduction = 0;
                if (previousYearIncome.incomeType === 'salary') {
                    const income = previousYearIncome.totalIncome;
                    if (income <= 1625000) {
                        employmentIncomeDeduction = 550000;
                    } else if (income <= 1800000) {
                        employmentIncomeDeduction = Math.floor(income * 0.4 - 100000);
                    } else if (income <= 3600000) {
                        employmentIncomeDeduction = Math.floor(income * 0.3 + 80000);
                    } else if (income <= 6600000) {
                        employmentIncomeDeduction = Math.floor(income * 0.2 + 440000);
                    } else if (income <= 8500000) {
                        employmentIncomeDeduction = Math.floor(income * 0.1 + 1100000);
                    } else {
                        employmentIncomeDeduction = 1950000;
                    }
                }
                
                // çµ¦ä¸æ‰€å¾—
                const employmentIncome = Math.max(0, previousYearIncome.totalIncome - employmentIncomeDeduction);
                
                // èª²ç¨æ‰€å¾—
                const socialInsurance = previousYearIncome.socialInsurance || 0;
                const baseDeduction = 480000;
                const taxableIncome = Math.max(0, employmentIncome - socialInsurance - baseDeduction);
                
                // å¹´é–“ä½æ°‘ç¨
                const municipalityEqualTax = {
                    'æ±äº¬éƒ½': 5000, 'å¤§é˜ªåºœ': 5300, 'ç¥å¥ˆå·çœŒ': 5800,
                    'åŸ¼ç‰çœŒ': 5000, 'åƒè‘‰çœŒ': 5000, 'åŒ—æµ·é“': 5500,
                    'é’æ£®çœŒ': 5500, 'å²©æ‰‹çœŒ': 6000, 'å®®åŸçœŒ': 5500,
                    'ç§‹ç”°çœŒ': 5500, 'å±±å½¢çœŒ': 5500, 'ç¦å³¶çœŒ': 5500,
                    'èŒ¨åŸçœŒ': 5000, 'æ ƒæœ¨çœŒ': 5000, 'ç¾¤é¦¬çœŒ': 5500,
                    'æ–°æ½ŸçœŒ': 5500, 'å¯Œå±±çœŒ': 5500, 'çŸ³å·çœŒ': 5500,
                    'ç¦äº•çœŒ': 5500, 'å±±æ¢¨çœŒ': 5500, 'é•·é‡çœŒ': 5500,
                    'å²é˜œçœŒ': 5500, 'é™å²¡çœŒ': 5500, 'æ„›çŸ¥çœŒ': 5300,
                    'ä¸‰é‡çœŒ': 5500, 'æ»‹è³€çœŒ': 5300, 'äº¬éƒ½åºœ': 5600,
                    'å…µåº«çœŒ': 5800, 'å¥ˆè‰¯çœŒ': 5500, 'å’Œæ­Œå±±çœŒ': 5500,
                    'é³¥å–çœŒ': 5500, 'å³¶æ ¹çœŒ': 5500, 'å²¡å±±çœŒ': 5500,
                    'åºƒå³¶çœŒ': 5500, 'å±±å£çœŒ': 5500, 'å¾³å³¶çœŒ': 5500,
                    'é¦™å·çœŒ': 5500, 'æ„›åª›çœŒ': 5500, 'é«˜çŸ¥çœŒ': 5500,
                    'ç¦å²¡çœŒ': 5500, 'ä½è³€çœŒ': 5500, 'é•·å´çœŒ': 5500,
                    'ç†Šæœ¬çœŒ': 5500, 'å¤§åˆ†çœŒ': 5500, 'å®®å´çœŒ': 5500,
                    'é¹¿å…å³¶çœŒ': 5500, 'æ²–ç¸„çœŒ': 5500
                };
                const equalTax = municipalityEqualTax[previousYearIncome.municipality] || 5500;
                const annualResidentTax = Math.floor(taxableIncome * 0.10) + equalTax;
                
                // æœˆé¡ä½æ°‘ç¨ï¼ˆ6æœˆã‹ã‚‰12å›æ‰•ã„ï¼‰
                let monthlyResidentTax = 0;
                if (currentMonth >= 5) {
                    monthlyResidentTax = Math.floor(annualResidentTax / 12);
                } else {
                    monthlyResidentTax = 0;
                }
                
                setResidentTax(monthlyResidentTax);
                setCalculationDetails({
                    previousYearIncome: previousYearIncome.totalIncome,
                    employmentIncomeDeduction,
                    employmentIncome,
                    socialInsuranceDeduction: socialInsurance,
                    baseDeduction,
                    taxableIncome,
                    equalTax,
                    annualResidentTax,
                    monthlyResidentTax
                });
                
                console.log('âœ… ä½æ°‘ç¨è¨ˆç®—å®Œäº†:', {
                    å‰å¹´æ‰€å¾—: previousYearIncome.totalIncome,
                    èª²ç¨æ‰€å¾—: taxableIncome,
                    å¹´é–“ä½æ°‘ç¨: annualResidentTax,
                    æœˆé¡ä½æ°‘ç¨: monthlyResidentTax
                });
            };

            // kanri.htmlã«çµæœã‚’é€ä¿¡ã—ã¦é–‰ã˜ã‚‹
            const sendResultAndClose = () => {
                if (residentTax === 0) {
                    alert('å…ˆã«è¨ˆç®—ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
                    return;
                }
                
                // kanri.htmlã«é€ä¿¡
                if (window.opener) {
                    window.opener.postMessage({
                        type: 'residentTaxCalculated',
                        employeeId: selectedEmployee.id,
                        employeeName: selectedEmployee.name,
                        year: currentYear,
                        month: currentMonth,
                        residentTax: residentTax,
                        salaryType: salaryType,
                        calculationDetails: calculationDetails,
                        previousYearIncome: previousYearIncome
                    }, '*');
                    
                    console.log('âœ… ãƒ‡ãƒ¼ã‚¿é€ä¿¡å®Œäº†ã€‚ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‰ã˜ã¾ã™ã€‚');
                    
                    // å°‘ã—å¾…ã£ã¦ã‹ã‚‰é–‰ã˜ã‚‹ï¼ˆé€ä¿¡ã‚’ç¢ºå®Ÿã«ã™ã‚‹ãŸã‚ï¼‰
                    setTimeout(() => {
                        window.close();
                    }, 500);
                } else {
                    alert('è¦ªã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã“ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’æ‰‹å‹•ã§é–‰ã˜ã¦ãã ã•ã„ã€‚');
                }
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-purple-50 to-pink-100 p-4">
                    <div className="max-w-4xl mx-auto">
                        <div className="bg-white rounded-2xl shadow-2xl p-8">
                            <h1 className="text-3xl font-bold text-gray-800 mb-6">ğŸ’° ä½æ°‘ç¨è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ </h1>
                            
                            {/* å¾“æ¥­å“¡é¸æŠ */}
                            <div className="mb-6">
                                <label className="block text-gray-700 font-bold mb-2">å¾“æ¥­å“¡ã‚’é¸æŠ</label>
                                <select
                                    value={selectedEmployee?.id || ''}
                                    onChange={(e) => {
                                        const emp = employees.find(emp => emp.id === e.target.value);
                                        setSelectedEmployee(emp);
                                        console.log('âœ… å¾“æ¥­å“¡é¸æŠ:', emp);
                                    }}
                                    className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg focus:border-purple-500"
                                >
                                    <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                                    {employees.map(emp => (
                                        <option key={emp.id} value={emp.id}>{emp.name}</option>
                                    ))}
                                </select>
                            </div>
                            
                            {/* å¯¾è±¡å¹´æœˆ */}
                            <div className="grid grid-cols-2 gap-4 mb-6">
                                <div>
                                    <label className="block text-gray-700 font-bold mb-2">å¯¾è±¡å¹´</label>
                                    <select
                                        value={currentYear}
                                        onChange={(e) => setCurrentYear(parseInt(e.target.value))}
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg"
                                    >
                                        {[2026, 2025, 2024, 2023].map(year => (
                                            <option key={year} value={year}>{year}å¹´</option>
                                        ))}
                                    </select>
                                </div>
                                <div>
                                    <label className="block text-gray-700 font-bold mb-2">å¯¾è±¡æœˆ</label>
                                    <select
                                        value={currentMonth}
                                        onChange={(e) => setCurrentMonth(parseInt(e.target.value))}
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg"
                                    >
                                        {[...Array(12)].map((_, i) => (
                                            <option key={i} value={i}>{i + 1}æœˆ</option>
                                        ))}
                                    </select>
                                </div>
                            </div>
                            
                            {/* å‰å¹´æ‰€å¾—å…¥åŠ› */}
                            <div className="border-t-2 pt-6 mb-6">
                                <h2 className="text-xl font-bold text-gray-800 mb-4">å‰å¹´ã®å¹´é–“æ‰€å¾—</h2>
                                
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label className="block text-gray-700 font-bold mb-2">å¯¾è±¡å¹´</label>
                                        <input
                                            type="number"
                                            value={previousYearIncome.year}
                                            onChange={(e) => setPreviousYearIncome({...previousYearIncome, year: parseInt(e.target.value)})}
                                            className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 font-bold mb-2">æ‰€å¾—åŒºåˆ†</label>
                                        <select
                                            value={previousYearIncome.incomeType}
                                            onChange={(e) => setPreviousYearIncome({...previousYearIncome, incomeType: e.target.value})}
                                            className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg"
                                        >
                                            <option value="salary">çµ¦ä¸æ‰€å¾—è€…</option>
                                            <option value="business">äº‹æ¥­æ‰€å¾—è€…</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div className="mb-4">
                                    <label className="block text-gray-700 font-bold mb-2">
                                        å¹´é–“ç·æ”¯çµ¦é¡ï¼ˆæ§é™¤å‰ï¼‰
                                    </label>
                                    <input
                                        type="number"
                                        value={previousYearIncome.totalIncome}
                                        onChange={(e) => setPreviousYearIncome({...previousYearIncome, totalIncome: parseInt(e.target.value) || 0})}
                                        className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg"
                                        placeholder="3000000"
                                    />
                                    <p className="text-sm text-gray-600 mt-1">
                                        â€»çµ¦ä¸æ‰€å¾—è€…: æ¯æœˆã®çµ¦ä¸æ˜ç´°ã®ã€Œç·æ”¯çµ¦é¡ã€ã‚’1å¹´åˆ†åˆè¨ˆ<br/>
                                        â€»äº‹æ¥­æ‰€å¾—è€…: å£²ä¸Š - çµŒè²»ï¼ˆæº–ç²—åˆ©ï¼‰
                                    </p>
                                </div>
                                
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <label className="block text-gray-700 font-bold mb-2">éƒ½é“åºœçœŒ</label>
                                        <select
                                            value={previousYearIncome.municipality}
                                            onChange={(e) => setPreviousYearIncome({...previousYearIncome, municipality: e.target.value})}
                                            className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg"
                                        >
                                            <option value="æ±äº¬éƒ½">æ±äº¬éƒ½</option>
                                            <option value="å¤§é˜ªåºœ">å¤§é˜ªåºœ</option>
                                            <option value="ç¥å¥ˆå·çœŒ">ç¥å¥ˆå·çœŒ</option>
                                            <option value="åŸ¼ç‰çœŒ">åŸ¼ç‰çœŒ</option>
                                            <option value="åƒè‘‰çœŒ">åƒè‘‰çœŒ</option>
                                            <option value="åŒ—æµ·é“">åŒ—æµ·é“</option>
                                            <option value="æ„›çŸ¥çœŒ">æ„›çŸ¥çœŒ</option>
                                            <option value="ç¦å²¡çœŒ">ç¦å²¡çœŒ</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-gray-700 font-bold mb-2">å¹´é–“ç¤¾ä¼šä¿é™ºæ–™</label>
                                        <input
                                            type="number"
                                            value={previousYearIncome.socialInsurance}
                                            onChange={(e) => setPreviousYearIncome({...previousYearIncome, socialInsurance: parseInt(e.target.value) || 0})}
                                            className="w-full px-4 py-3 border-2 border-gray-300 rounded-lg"
                                            placeholder="450000"
                                        />
                                    </div>
                                </div>
                            </div>
                            
                            {/* è¨ˆç®—ãƒœã‚¿ãƒ³ */}
                            <button
                                onClick={calculateResidentTax}
                                className="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white py-4 rounded-lg font-bold text-lg hover:opacity-90 mb-4"
                            >
                                ğŸ’° ä½æ°‘ç¨ã‚’è¨ˆç®—
                            </button>
                            
                            {/* è¨ˆç®—çµæœ */}
                            {calculationDetails && (
                                <div className="bg-green-50 border-2 border-green-500 rounded-lg p-6 mb-4">
                                    <h3 className="text-xl font-bold text-gray-800 mb-4">è¨ˆç®—çµæœ</h3>
                                    
                                    <div className="space-y-2 mb-4">
                                        <div className="flex justify-between">
                                            <span>å‰å¹´ç·åå…¥:</span>
                                            <span className="font-bold">Â¥{calculationDetails.previousYearIncome.toLocaleString()}</span>
                                        </div>
                                        <div className="flex justify-between text-gray-600">
                                            <span>çµ¦ä¸æ‰€å¾—æ§é™¤:</span>
                                            <span>-Â¥{calculationDetails.employmentIncomeDeduction.toLocaleString()}</span>
                                        </div>
                                        <div className="flex justify-between">
                                            <span>çµ¦ä¸æ‰€å¾—:</span>
                                            <span className="font-bold">Â¥{calculationDetails.employmentIncome.toLocaleString()}</span>
                                        </div>
                                        <div className="flex justify-between text-gray-600">
                                            <span>ç¤¾ä¼šä¿é™ºæ–™æ§é™¤:</span>
                                            <span>-Â¥{calculationDetails.socialInsuranceDeduction.toLocaleString()}</span>
                                        </div>
                                        <div className="flex justify-between text-gray-600">
                                            <span>åŸºç¤æ§é™¤:</span>
                                            <span>-Â¥{calculationDetails.baseDeduction.toLocaleString()}</span>
                                        </div>
                                        <div className="border-t-2 pt-2 flex justify-between">
                                            <span className="font-bold">èª²ç¨æ‰€å¾—:</span>
                                            <span className="font-bold">Â¥{calculationDetails.taxableIncome.toLocaleString()}</span>
                                        </div>
                                    </div>
                                    
                                    <div className="bg-white rounded-lg p-4 mb-4">
                                        <div className="flex justify-between mb-2">
                                            <span>å¹´é–“ä½æ°‘ç¨:</span>
                                            <span className="font-bold text-lg">Â¥{calculationDetails.annualResidentTax.toLocaleString()}</span>
                                        </div>
                                        <div className="text-sm text-gray-600">
                                            æ‰€å¾—å‰² Â¥{Math.floor(calculationDetails.taxableIncome * 0.10).toLocaleString()} + å‡ç­‰å‰² Â¥{calculationDetails.equalTax.toLocaleString()}
                                        </div>
                                    </div>
                                    
                                    <div className="bg-yellow-100 rounded-lg p-4">
                                        <div className="flex justify-between">
                                            <span className="text-xl font-bold">æœˆé¡ä½æ°‘ç¨:</span>
                                            <span className="text-2xl font-bold text-purple-600">Â¥{residentTax.toLocaleString()}</span>
                                        </div>
                                        <div className="text-sm text-gray-600 mt-1">
                                            â€»6æœˆã‹ã‚‰12å›æ‰•ã„ï¼ˆ1ã€œ5æœˆã¯Â¥0ï¼‰
                                        </div>
                                    </div>
                                </div>
                            )}
                            
                            {/* kanri.htmlã«é€ä¿¡ */}
                            {residentTax > 0 && (
                                <button
                                    onClick={sendResultAndClose}
                                    className="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-4 rounded-lg font-bold text-lg hover:opacity-90"
                                >
                                    âœ… è¨ˆç®—çµæœã‚’é€ä¿¡ã—ã¦kanri.htmlã«æˆ»ã‚‹
                                </button>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<ResidentTaxCalculator />, document.getElementById('root'));
    </script>
</body>
</html>
