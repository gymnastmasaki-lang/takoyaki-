<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>セットメニュー追加</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    button {
      padding: 20px 40px;
      font-size: 18px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      background: #45a049;
    }
    #result {
      margin-top: 20px;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: monospace;
    }
    .error {
      color: red;
      font-weight: bold;
    }
    .success {
      color: green;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>セットメニュー追加スクリプト</h1>
  <p>このスクリプトでFirestoreにセットメニューを追加します。</p>
  
  <div>
    <button onclick="checkExisting()">既存データを確認</button>
    <button onclick="addSetMenus()">セットメニューを追加</button>
    <button onclick="deleteSetMenus()">セットメニューを削除</button>
  </div>
  
  <div id="result"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, query, where, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDihde65cnLva8l9tvi4u0oUM0gQ49bWNk",
      authDomain: "takoyaki-pos.firebaseapp.com",
      projectId: "takoyaki-pos",
      storageBucket: "takoyaki-pos.firebasestorage.app",
      messagingSenderId: "868693716352",
      appId: "1:868693716352:web:51d8c09ac51a7c8bc2a17c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    window.db = db;
    window.collection = collection;
    window.addDoc = addDoc;
    window.getDocs = getDocs;
    window.query = query;
    window.where = where;
    window.deleteDoc = deleteDoc;
    window.doc = doc;
    
    console.log('Firebase初期化完了');
  </script>

  <script>
    function log(message, isError = false) {
      const resultDiv = document.getElementById('result');
      const timestamp = new Date().toLocaleTimeString();
      const className = isError ? 'error' : '';
      resultDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      console.log(message);
    }
    
    async function checkExisting() {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '';
      log('既存データ確認中...');
      
      try {
        // メニュー確認
        const menuSnapshot = await window.getDocs(window.collection(window.db, 'menu'));
        log(`✅ メニュー数: ${menuSnapshot.size}件`);
        
        let hasSetMenu = false;
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.category === 'セット') {
            hasSetMenu = true;
            log(`  - ${data.name} (${data.price}円) [ID: ${data.id}]`);
          }
        });
        
        if (!hasSetMenu) {
          log('⚠️ セットメニューは存在しません');
        }
        
        // トッピング確認
        const toppingsSnapshot = await window.getDocs(window.collection(window.db, 'toppings'));
        log(`✅ トッピング数: ${toppingsSnapshot.size}件`);
        
        const toppings = [];
        toppingsSnapshot.forEach(doc => {
          toppings.push(doc.data());
        });
        
        log('最初の5件のトッピング:');
        toppings.slice(0, 5).forEach(t => {
          log(`  - ${t.name} (${t.price}円) [ID: ${t.id}]`);
        });
        
      } catch (error) {
        log(`❌ エラー: ${error.message}`, true);
        console.error('エラー:', error);
      }
    }
    
    async function deleteSetMenus() {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '';
      
      if (!confirm('セットメニューと関連トッピングを削除しますか？')) {
        return;
      }
      
      log('削除処理開始...');
      
      try {
        // セットメニューを削除
        const menuSnapshot = await window.getDocs(window.collection(window.db, 'menu'));
        let deletedMenus = 0;
        
        for (const docSnapshot of menuSnapshot.docs) {
          const data = docSnapshot.data();
          if (data.id && (data.id.startsWith('SET') || data.category === 'セット')) {
            await window.deleteDoc(window.doc(window.db, 'menu', docSnapshot.id));
            deletedMenus++;
            log(`削除: ${data.name}`);
          }
        }
        
        log(`✅ メニュー削除完了: ${deletedMenus}件`);
        
        // トッピングを削除
        const toppingsSnapshot = await window.getDocs(window.collection(window.db, 'toppings'));
        let deletedToppings = 0;
        
        for (const docSnapshot of toppingsSnapshot.docs) {
          const data = docSnapshot.data();
          if (data.id && (data.id.startsWith('OTUMAMI_') || data.id.startsWith('TASTE'))) {
            await window.deleteDoc(window.doc(window.db, 'toppings', docSnapshot.id));
            deletedToppings++;
          }
        }
        
        log(`✅ トッピング削除完了: ${deletedToppings}件`);
        log('✅ 全ての削除処理が完了しました', false);
        
      } catch (error) {
        log(`❌ エラー: ${error.message}`, true);
        console.error('エラー:', error);
      }
    }
    
    async function addSetMenus() {
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '';
      log('セットメニュー追加処理開始...');
      
      try {
        // 1. 既存のトッピングを確認
        log('既存トッピング確認中...');
        const toppingsSnapshot = await window.getDocs(window.collection(window.db, 'toppings'));
        const existingToppings = [];
        toppingsSnapshot.forEach(doc => {
          existingToppings.push(doc.data());
        });
        log(`既存トッピング数: ${existingToppings.length}件`);
        
        // たこ焼き味トッピングのIDを探す（既存のものを使用）
        let tasteTopping = '';
        for (const t of existingToppings) {
          if (t.name && t.name.includes('ソース')) {
            tasteTopping = t.id;
            log(`既存のたこ焼き味トッピングID: ${tasteTopping}`);
            break;
          }
        }
        
        if (!tasteTopping) {
          log('⚠️ たこ焼き味トッピングが見つかりません。新規作成します。');
          
          const tasteToppings = [
            { id: 'TASTE01', name: 'ソース', price: 0, order: 1 },
            { id: 'TASTE02', name: 'しょうゆ', price: 0, order: 2 },
            { id: 'TASTE03', name: '塩', price: 0, order: 3 },
            { id: 'TASTE04', name: 'ポン酢', price: 30, order: 4 },
            { id: 'TASTE05', name: 'みそだれ', price: 30, order: 5 }
          ];
          
          for (const topping of tasteToppings) {
            const docRef = await window.addDoc(window.collection(window.db, 'toppings'), topping);
            log(`✅ トッピング追加: ${topping.name} (Firestore ID: ${docRef.id})`);
          }
          tasteTopping = 'TASTE01,TASTE02,TASTE03,TASTE04,TASTE05';
        }
        
        // 2. おつまみセット用の全トッピングを作成
        log('おつまみセット用トッピング追加中...');
        
        const otumamisetToppings = [
          // ドリンク
          { id: 'OTUMAMI_DRINK01', name: '【ドリンク】生ビール', price: 0, order: 101 },
          { id: 'OTUMAMI_DRINK02', name: '【ドリンク】チューハイプレーン', price: 0, order: 102 },
          { id: 'OTUMAMI_DRINK03', name: '【ドリンク】チューハイゆず', price: 0, order: 103 },
          { id: 'OTUMAMI_DRINK04', name: '【ドリンク】チューハイグレープフルーツ', price: 0, order: 104 },
          { id: 'OTUMAMI_DRINK05', name: '【ドリンク】チューハイ青りんご', price: 0, order: 105 },
          { id: 'OTUMAMI_DRINK06', name: '【ドリンク】チューハイ梅', price: 0, order: 106 },
          { id: 'OTUMAMI_DRINK07', name: '【ドリンク】チューハイカルピス', price: 0, order: 107 },
          { id: 'OTUMAMI_DRINK08', name: '【ドリンク】角ハイ', price: 0, order: 108 },
          { id: 'OTUMAMI_DRINK09', name: '【ドリンク】ジムビーム', price: 0, order: 109 },
          { id: 'OTUMAMI_DRINK10', name: '【ドリンク】ウーロンハイ', price: 0, order: 110 },
          // たこ焼き味
          { id: 'OTUMAMI_TASTE01', name: '【たこ焼き味】ソース', price: 0, order: 201 },
          { id: 'OTUMAMI_TASTE02', name: '【たこ焼き味】しょうゆ', price: 0, order: 202 },
          { id: 'OTUMAMI_TASTE03', name: '【たこ焼き味】塩', price: 0, order: 203 },
          { id: 'OTUMAMI_TASTE04', name: '【たこ焼き味】ポン酢', price: 30, order: 204 },
          { id: 'OTUMAMI_TASTE05', name: '【たこ焼き味】みそだれ', price: 30, order: 205 },
          // 一品
          { id: 'OTUMAMI_SIDE01', name: '【一品】枝豆', price: 0, order: 301 },
          { id: 'OTUMAMI_SIDE02', name: '【一品】揚げにんにく', price: 0, order: 302 },
          { id: 'OTUMAMI_SIDE03', name: '【一品】ごま油キムチ', price: 0, order: 303 },
          { id: 'OTUMAMI_SIDE04', name: '【一品】冷奴', price: 0, order: 304 },
          { id: 'OTUMAMI_SIDE05', name: '【一品】ポテトフライ', price: 0, order: 305 },
          { id: 'OTUMAMI_SIDE06', name: '【一品】唐揚げ2個', price: 0, order: 306 },
          // オプション
          { id: 'OTUMAMI_OPT01', name: '【オプション】生ビールお得ジョッキに変更', price: 150, order: 401 },
          { id: 'OTUMAMI_OPT02', name: '【オプション】その他メガに変更', price: 300, order: 402 }
        ];
        
        for (const topping of otumamisetToppings) {
          const docRef = await window.addDoc(window.collection(window.db, 'toppings'), topping);
          log(`✅ トッピング追加: ${topping.name} (Firestore ID: ${docRef.id})`);
        }
        
        log('✅ 全トッピング追加完了');
        
        // 3. おつまみセット用のトッピングIDリストを作成
        const otumamisetToppingIds = otumamisetToppings.map(t => t.id).join(',');
        log(`おつまみセットトッピングID: ${otumamisetToppingIds.substring(0, 50)}...`);
        
        // 4. セットメニューを作成
        log('メニュー追加中...');
        
        const setMenus = [
          {
            id: 'SET001',
            category: 'セット',
            name: 'Aセット',
            price: 1000,
            toppingsId: tasteTopping,
            image: '',
            note: '店内のみ'
          },
          {
            id: 'SET002',
            category: 'セット',
            name: 'Bセット',
            price: 1250,
            toppingsId: tasteTopping,
            image: '',
            note: '店内のみ'
          },
          {
            id: 'SET003',
            category: 'セット',
            name: 'おつまみセット',
            price: 1000,
            toppingsId: otumamisetToppingIds,
            image: '',
            note: '店内のみ'
          }
        ];
        
        for (const menu of setMenus) {
          const docRef = await window.addDoc(window.collection(window.db, 'menu'), menu);
          log(`✅ メニュー追加: ${menu.name} (${menu.price}円) [Firestore ID: ${docRef.id}]`);
        }
        
        log('', false);
        log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', false);
        log('✅ 全ての処理が完了しました！', false);
        log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━', false);
        log('', false);
        log('追加されたメニュー:', false);
        log('- Aセット (1000円) - たこ焼き味を選択', false);
        log('- Bセット (1250円) - たこ焼き味を選択', false);
        log('- おつまみセット (1000円) - ドリンク・たこ焼き味・一品・オプションを選択', false);
        log('', false);
        log('注意:', false);
        log('- menu.htmlからの注文では非表示', false);
        log('- ?table=からの注文では表示（店内のみ設定）', false);
        log('- メニューアプリを再読み込みして確認してください', false);
        
      } catch (error) {
        log(`❌ エラー: ${error.message}`, true);
        log(`エラー詳細: ${error.stack}`, true);
        console.error('エラー:', error);
      }
    }
    
    window.checkExisting = checkExisting;
    window.addSetMenus = addSetMenus;
    window.deleteSetMenus = deleteSetMenus;
  </script>
</body>
</html>
