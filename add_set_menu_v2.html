<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>セットメニュー追加（シンプル版）</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
    }
    button {
      padding: 15px 30px;
      font-size: 16px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    #result {
      margin-top: 20px;
      padding: 20px;
      background: #f5f5f5;
      border-radius: 8px;
      white-space: pre-wrap;
      font-family: monospace;
      max-height: 500px;
      overflow-y: auto;
    }
    .error {
      color: red;
      font-weight: bold;
    }
    .success {
      color: green;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>セットメニュー追加（シンプル版）</h1>
  <p>処理を3つのステップに分けて実行します。</p>
  
  <div>
    <button id="btn1" onclick="step1()">ステップ1: トッピング追加（23個）</button>
    <button id="btn2" onclick="step2()" disabled>ステップ2: メニュー追加（3個）</button>
    <button id="btn3" onclick="checkResult()" disabled>ステップ3: 結果確認</button>
  </div>
  
  <div id="result"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDihde65cnLva8l9tvi4u0oUM0gQ49bWNk",
      authDomain: "takoyaki-pos.firebaseapp.com",
      projectId: "takoyaki-pos",
      storageBucket: "takoyaki-pos.firebasestorage.app",
      messagingSenderId: "868693716352",
      appId: "1:868693716352:web:51d8c09ac51a7c8bc2a17c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    window.db = db;
    window.collection = collection;
    window.addDoc = addDoc;
    window.getDocs = getDocs;
    
    console.log('Firebase初期化完了');
  </script>

  <script>
    function log(message, isError = false) {
      const resultDiv = document.getElementById('result');
      const timestamp = new Date().toLocaleTimeString();
      const className = isError ? 'error' : '';
      resultDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      resultDiv.scrollTop = resultDiv.scrollHeight;
      console.log(message);
    }
    
    async function step1() {
      const btn = document.getElementById('btn1');
      btn.disabled = true;
      
      const resultDiv = document.getElementById('result');
      resultDiv.innerHTML = '';
      log('ステップ1: トッピング追加開始...');
      
      try {
        const toppings = [
          // ドリンク（10個）
          { id: 'OTUMAMI_DRINK01', name: '【ドリンク】生ビール', price: 0, order: 101 },
          { id: 'OTUMAMI_DRINK02', name: '【ドリンク】チューハイプレーン', price: 0, order: 102 },
          { id: 'OTUMAMI_DRINK03', name: '【ドリンク】チューハイゆず', price: 0, order: 103 },
          { id: 'OTUMAMI_DRINK04', name: '【ドリンク】チューハイグレープフルーツ', price: 0, order: 104 },
          { id: 'OTUMAMI_DRINK05', name: '【ドリンク】チューハイ青りんご', price: 0, order: 105 },
          { id: 'OTUMAMI_DRINK06', name: '【ドリンク】チューハイ梅', price: 0, order: 106 },
          { id: 'OTUMAMI_DRINK07', name: '【ドリンク】チューハイカルピス', price: 0, order: 107 },
          { id: 'OTUMAMI_DRINK08', name: '【ドリンク】角ハイ', price: 0, order: 108 },
          { id: 'OTUMAMI_DRINK09', name: '【ドリンク】ジムビーム', price: 0, order: 109 },
          { id: 'OTUMAMI_DRINK10', name: '【ドリンク】ウーロンハイ', price: 0, order: 110 },
          // たこ焼き味（5個）
          { id: 'OTUMAMI_TASTE01', name: '【たこ焼き味】ソース', price: 0, order: 201 },
          { id: 'OTUMAMI_TASTE02', name: '【たこ焼き味】しょうゆ', price: 0, order: 202 },
          { id: 'OTUMAMI_TASTE03', name: '【たこ焼き味】塩', price: 0, order: 203 },
          { id: 'OTUMAMI_TASTE04', name: '【たこ焼き味】ポン酢', price: 30, order: 204 },
          { id: 'OTUMAMI_TASTE05', name: '【たこ焼き味】みそだれ', price: 30, order: 205 },
          // 一品（6個）
          { id: 'OTUMAMI_SIDE01', name: '【一品】枝豆', price: 0, order: 301 },
          { id: 'OTUMAMI_SIDE02', name: '【一品】揚げにんにく', price: 0, order: 302 },
          { id: 'OTUMAMI_SIDE03', name: '【一品】ごま油キムチ', price: 0, order: 303 },
          { id: 'OTUMAMI_SIDE04', name: '【一品】冷奴', price: 0, order: 304 },
          { id: 'OTUMAMI_SIDE05', name: '【一品】ポテトフライ', price: 0, order: 305 },
          { id: 'OTUMAMI_SIDE06', name: '【一品】唐揚げ2個', price: 0, order: 306 },
          // オプション（2個）
          { id: 'OTUMAMI_OPT01', name: '【オプション】生ビールお得ジョッキに変更', price: 150, order: 401 },
          { id: 'OTUMAMI_OPT02', name: '【オプション】その他メガに変更', price: 300, order: 402 }
        ];
        
        log(`追加するトッピング数: ${toppings.length}個`);
        
        let successCount = 0;
        let errorCount = 0;
        
        for (let i = 0; i < toppings.length; i++) {
          const topping = toppings[i];
          try {
            await window.addDoc(window.collection(window.db, 'toppings'), topping);
            successCount++;
            
            if (i % 5 === 0 || i === toppings.length - 1) {
              log(`進捗: ${i + 1}/${toppings.length}`);
            }
            
            // 少し待機（レート制限対策）
            await new Promise(resolve => setTimeout(resolve, 100));
            
          } catch (error) {
            errorCount++;
            log(`❌ エラー: ${topping.name} - ${error.message}`, true);
          }
        }
        
        log(`✅ トッピング追加完了: ${successCount}個成功, ${errorCount}個失敗`);
        
        if (successCount > 0) {
          document.getElementById('btn2').disabled = false;
          log('→ ステップ2のボタンが有効になりました');
        }
        
      } catch (error) {
        log(`❌ エラー: ${error.message}`, true);
        console.error('エラー:', error);
      }
    }
    
    async function step2() {
      const btn = document.getElementById('btn2');
      btn.disabled = true;
      
      log('');
      log('ステップ2: メニュー追加開始...');
      
      try {
        // トッピングIDリストを作成
        const toppingIds = [];
        for (let i = 1; i <= 10; i++) {
          toppingIds.push(`OTUMAMI_DRINK${String(i).padStart(2, '0')}`);
        }
        for (let i = 1; i <= 5; i++) {
          toppingIds.push(`OTUMAMI_TASTE${String(i).padStart(2, '0')}`);
        }
        for (let i = 1; i <= 6; i++) {
          toppingIds.push(`OTUMAMI_SIDE${String(i).padStart(2, '0')}`);
        }
        toppingIds.push('OTUMAMI_OPT01', 'OTUMAMI_OPT02');
        
        const otumamisetToppingIds = toppingIds.join(',');
        
        // 既存のたこ焼き味トッピングIDを取得
        const toppingsSnapshot = await window.getDocs(window.collection(window.db, 'toppings'));
        let tasteTopping = '';
        
        toppingsSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.name && data.name.includes('ソース') && !data.id.startsWith('OTUMAMI_')) {
            if (!tasteTopping) {
              tasteTopping = data.id;
            }
          }
        });
        
        if (!tasteTopping) {
          tasteTopping = 'OTUMAMI_TASTE01,OTUMAMI_TASTE02,OTUMAMI_TASTE03,OTUMAMI_TASTE04,OTUMAMI_TASTE05';
        }
        
        log(`たこ焼き味トッピングID: ${tasteTopping}`);
        
        const menus = [
          {
            id: 'SET001',
            category: 'セット',
            name: 'Aセット',
            price: 1000,
            toppingsId: tasteTopping,
            image: '',
            note: '店内のみ'
          },
          {
            id: 'SET002',
            category: 'セット',
            name: 'Bセット',
            price: 1250,
            toppingsId: tasteTopping,
            image: '',
            note: '店内のみ'
          },
          {
            id: 'SET003',
            category: 'セット',
            name: 'おつまみセット',
            price: 1000,
            toppingsId: otumamisetToppingIds,
            image: '',
            note: '店内のみ'
          }
        ];
        
        for (const menu of menus) {
          const docRef = await window.addDoc(window.collection(window.db, 'menu'), menu);
          log(`✅ メニュー追加: ${menu.name} (${menu.price}円)`);
          
          await new Promise(resolve => setTimeout(resolve, 100));
        }
        
        log('✅ 全メニュー追加完了');
        document.getElementById('btn3').disabled = false;
        log('→ ステップ3のボタンが有効になりました');
        
      } catch (error) {
        log(`❌ エラー: ${error.message}`, true);
        console.error('エラー:', error);
      }
    }
    
    async function checkResult() {
      log('');
      log('ステップ3: 結果確認中...');
      
      try {
        const menuSnapshot = await window.getDocs(window.collection(window.db, 'menu'));
        let setMenuCount = 0;
        
        menuSnapshot.forEach(doc => {
          const data = doc.data();
          if (data.category === 'セット') {
            setMenuCount++;
            log(`- ${data.name} (${data.price}円)`);
          }
        });
        
        log('');
        log(`✅ セットメニュー: ${setMenuCount}件`);
        log('');
        log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
        log('✅ 全ての処理が完了しました！');
        log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
        log('');
        log('メニューアプリを再読み込みして確認してください。');
        log('テーブルURLから確認: ?table=T-M など');
        
      } catch (error) {
        log(`❌ エラー: ${error.message}`, true);
        console.error('エラー:', error);
      }
    }
    
    window.step1 = step1;
    window.step2 = step2;
    window.checkResult = checkResult;
  </script>
</body>
</html>
