<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¢ºå®šç”³å‘Šã‚·ã‚¹ãƒ†ãƒ  - é’è‰²ç”³å‘Š</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @media print {
            body * { visibility: hidden; }
            .print-area, .print-area * { visibility: visible; }
            .print-area { position: absolute; left: 0; top: 0; width: 100%; }
            .no-print { display: none !important; }
            @page { size: A4; margin: 15mm; }
        }
        
        .a4-page {
            width: 210mm;
            min-height: 297mm;
            padding: 20mm;
            background: white;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            margin: 20px auto;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app"></div>

    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, getDoc, doc, query, where, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBoSdfEkez-b3P0BUHtowxCrTw-yEBdHSg",
            authDomain: "takoyaki-order-system-bacd7.firebaseapp.com",
            projectId: "takoyaki-order-system-bacd7",
            storageBucket: "takoyaki-order-system-bacd7.firebasestorage.app",
            messagingSenderId: "104494752890",
            appId: "1:104494752890:web:c0a25d62f42ffca01687c3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.firebaseModules = { collection, getDocs, getDoc, doc, query, where, Timestamp };
        window.FirebaseReady = true;
    </script>

    <script>
        const appDiv = document.getElementById('app');
        
        let storeName = '';
        let storeId = '';
        let targetYear = new Date().getFullYear() - 1; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯å‰å¹´
        let salesData = null;
        let expenseData = null;
        let salaryData = null;
        let deductions = {};

        // ç¢ºå®šç”³å‘Šè¨ˆç®—ã‚¯ãƒ©ã‚¹
        class KakuteiCalculator {
            constructor(data) {
                this.salesData = data.salesData || {};
                this.expenseData = data.expenseData || {};
                this.salaryData = data.salaryData || {};
                this.deductions = data.deductions || {};
            }

            // å£²ä¸Šé«˜
            getTotalSales() {
                return this.salesData.totalSales || 0;
            }

            // çµŒè²»åˆè¨ˆ
            getTotalExpenses() {
                const expenses = this.expenseData.expenses || {};
                return Object.values(expenses).reduce((sum, val) => sum + (val || 0), 0);
            }

            // é’è‰²ç”³å‘Šç‰¹åˆ¥æ§é™¤å‰ã®æ‰€å¾—
            getIncomeBeforeBlueDeduction() {
                return this.getTotalSales() - this.getTotalExpenses();
            }

            // é’è‰²ç”³å‘Šç‰¹åˆ¥æ§é™¤
            getBlueDeduction() {
                // ç°¡æ˜“ç°¿è¨˜: 10ä¸‡å††ã€è¤‡å¼ç°¿è¨˜: 65ä¸‡å††
                return this.deductions.blueType === 'simple' ? 100000 : 650000;
            }

            // äº‹æ¥­æ‰€å¾—
            getBusinessIncome() {
                return Math.max(0, this.getIncomeBeforeBlueDeduction() - this.getBlueDeduction());
            }

            // åŸºç¤æ§é™¤
            getBasicDeduction() {
                const income = this.getBusinessIncome();
                if (income <= 24000000) return 480000;
                if (income <= 24500000) return 320000;
                if (income <= 25000000) return 160000;
                return 0;
            }

            // é…å¶è€…æ§é™¤
            getSpouseDeduction() {
                if (!this.deductions.hasSpouse) return 0;
                const income = this.getBusinessIncome();
                const spouseIncome = this.deductions.spouseIncome || 0;
                
                if (spouseIncome > 1330000 || income > 10000000) return 0;
                if (spouseIncome <= 950000) {
                    if (income <= 9000000) return 380000;
                    if (income <= 9500000) return 260000;
                    if (income <= 10000000) return 130000;
                }
                return 0;
            }

            // é…å¶è€…ç‰¹åˆ¥æ§é™¤
            getSpouseSpecialDeduction() {
                if (!this.deductions.hasSpouse) return 0;
                const income = this.getBusinessIncome();
                const spouseIncome = this.deductions.spouseIncome || 0;
                
                if (spouseIncome <= 950000 || spouseIncome > 2015999 || income > 10000000) return 0;
                
                if (income <= 9000000) {
                    if (spouseIncome <= 1000000) return 380000;
                    if (spouseIncome <= 1050000) return 360000;
                    if (spouseIncome <= 1100000) return 310000;
                    if (spouseIncome <= 1150000) return 260000;
                    if (spouseIncome <= 1200000) return 210000;
                    if (spouseIncome <= 1250000) return 160000;
                    if (spouseIncome <= 1300000) return 110000;
                    if (spouseIncome <= 1350000) return 60000;
                    if (spouseIncome <= 1400000) return 30000;
                }
                return 0;
            }

            // æ‰¶é¤Šæ§é™¤
            getDependentDeduction() {
                const dependents = this.deductions.dependents || [];
                let total = 0;
                dependents.forEach(d => {
                    if (d.age >= 16 && d.age < 19) total += 380000;
                    else if (d.age >= 19 && d.age < 23) total += 630000;
                    else if (d.age >= 23 && d.age < 70) total += 380000;
                    else if (d.age >= 70) total += 480000;
                });
                return total;
            }

            // ç¤¾ä¼šä¿é™ºæ–™æ§é™¤
            getSocialInsuranceDeduction() {
                return this.deductions.socialInsurance || 0;
            }

            // ç”Ÿå‘½ä¿é™ºæ–™æ§é™¤
            getLifeInsuranceDeduction() {
                const calc = (amount) => {
                    if (amount <= 20000) return amount;
                    if (amount <= 40000) return amount * 0.5 + 10000;
                    if (amount <= 80000) return amount * 0.25 + 20000;
                    return 40000;
                };
                
                const life = calc(this.deductions.lifeInsurance || 0);
                const medical = calc(this.deductions.medicalInsurance || 0);
                const pension = calc(this.deductions.pensionInsurance || 0);
                
                return Math.min(life + medical + pension, 120000);
            }

            // åœ°éœ‡ä¿é™ºæ–™æ§é™¤
            getEarthquakeDeduction() {
                return Math.min(this.deductions.earthquakeInsurance || 0, 50000);
            }

            // å°è¦æ¨¡ä¼æ¥­å…±æ¸ˆç­‰æ›é‡‘æ§é™¤
            getSmallBusinessDeduction() {
                return this.deductions.smallBusiness || 0;
            }

            // æ‰€å¾—æ§é™¤åˆè¨ˆ
            getTotalDeductions() {
                return this.getBasicDeduction() +
                       this.getSpouseDeduction() +
                       this.getSpouseSpecialDeduction() +
                       this.getDependentDeduction() +
                       this.getSocialInsuranceDeduction() +
                       this.getLifeInsuranceDeduction() +
                       this.getEarthquakeDeduction() +
                       this.getSmallBusinessDeduction();
            }

            // èª²ç¨æ‰€å¾—
            getTaxableIncome() {
                return Math.max(0, this.getBusinessIncome() - this.getTotalDeductions());
            }

            // æ‰€å¾—ç¨é¡
            getIncomeTax() {
                const taxable = this.getTaxableIncome();
                if (taxable <= 1950000) return taxable * 0.05;
                if (taxable <= 3300000) return taxable * 0.1 - 97500;
                if (taxable <= 6950000) return taxable * 0.2 - 427500;
                if (taxable <= 9000000) return taxable * 0.23 - 636000;
                if (taxable <= 18000000) return taxable * 0.33 - 1536000;
                if (taxable <= 40000000) return taxable * 0.40 - 2796000;
                return taxable * 0.45 - 4796000;
            }

            // å¾©èˆˆç‰¹åˆ¥æ‰€å¾—ç¨
            getReconstructionTax() {
                return Math.floor(this.getIncomeTax() * 0.021);
            }

            // æ‰€å¾—ç¨åŠã³å¾©èˆˆç‰¹åˆ¥æ‰€å¾—ç¨ã®é¡
            getTotalTax() {
                return Math.floor(this.getIncomeTax() + this.getReconstructionTax());
            }

            // äºˆå®šç´ç¨é¡ï¼ˆæºæ³‰å¾´åç¨é¡ï¼‰
            getPrepaidTax() {
                return this.deductions.prepaidTax || 0;
            }

            // ç´ä»˜ç¨é¡ï¼ˆã¾ãŸã¯é‚„ä»˜ç¨é¡ï¼‰
            getPaymentAmount() {
                return this.getTotalTax() - this.getPrepaidTax();
            }

            // ===== æ¶ˆè²»ç¨è¨ˆç®— =====

            // èª²ç¨å£²ä¸Šé«˜ï¼ˆç¨æŠœï¼‰
            getTaxableSales8() {
                return Math.floor(this.salesData.tax8Sales / 1.08);
            }

            getTaxableSales10() {
                return Math.floor(this.salesData.tax10Sales / 1.10);
            }

            getTotalTaxableSales() {
                return this.getTaxableSales8() + this.getTaxableSales10();
            }

            // èª²ç¨ä»•å…¥é«˜ï¼ˆç¨æŠœï¼‰
            getTaxablePurchase8() {
                return Math.floor(this.expenseData.tax8Expenses / 1.08);
            }

            getTaxablePurchase10() {
                return Math.floor(this.expenseData.tax10Expenses / 1.10);
            }

            getTotalTaxablePurchase() {
                return this.getTaxablePurchase8() + this.getTaxablePurchase10();
            }

            // èª²ç¨å£²ä¸Šã«ä¿‚ã‚‹æ¶ˆè²»ç¨é¡
            getSalesConsumptionTax8() {
                return Math.floor(this.getTaxableSales8() * 0.08);
            }

            getSalesConsumptionTax10() {
                return Math.floor(this.getTaxableSales10() * 0.10);
            }

            getTotalSalesConsumptionTax() {
                return this.getSalesConsumptionTax8() + this.getSalesConsumptionTax10();
            }

            // èª²ç¨ä»•å…¥ã«ä¿‚ã‚‹æ¶ˆè²»ç¨é¡
            getPurchaseConsumptionTax8() {
                return Math.floor(this.getTaxablePurchase8() * 0.08);
            }

            getPurchaseConsumptionTax10() {
                return Math.floor(this.getTaxablePurchase10() * 0.10);
            }

            getTotalPurchaseConsumptionTax() {
                return this.getPurchaseConsumptionTax8() + this.getPurchaseConsumptionTax10();
            }

            // æ§é™¤å¯¾è±¡ä»•å…¥ç¨é¡
            getDeductiblePurchaseTax() {
                // ä¸€èˆ¬èª²ç¨
                return this.getTotalPurchaseConsumptionTax();
            }

            // å·®å¼•ç¨é¡
            getNetConsumptionTax() {
                return Math.max(0, this.getTotalSalesConsumptionTax() - this.getDeductiblePurchaseTax());
            }

            // åœ°æ–¹æ¶ˆè²»ç¨
            getLocalConsumptionTax() {
                // æ¶ˆè²»ç¨é¡ã®22/78
                return Math.floor(this.getNetConsumptionTax() * 22 / 78);
            }

            // æ¶ˆè²»ç¨ã¨åœ°æ–¹æ¶ˆè²»ç¨ã®åˆè¨ˆ
            getTotalConsumptionTaxPayment() {
                return this.getNetConsumptionTax() + this.getLocalConsumptionTax();
            }

            // ä¸­é–“ç´ä»˜ç¨é¡
            getIntermediatePayment() {
                return this.deductions.intermediatePayment || 0;
            }

            // å·®å¼•ç´ä»˜ç¨é¡ï¼ˆæ¶ˆè²»ç¨ï¼‰
            getConsumptionTaxPaymentAmount() {
                return this.getTotalConsumptionTaxPayment() - this.getIntermediatePayment();
            }

            // æ¶ˆè²»ç¨ãŒå¿…è¦ã‹ã©ã†ã‹ï¼ˆå£²ä¸Š1000ä¸‡å††è¶…ï¼‰
            needsConsumptionTaxFiling() {
                return this.getTotalSales() > 10000000;
            }
        }

        async function init() {
            if (!window.FirebaseReady) {
                setTimeout(init, 100);
                return;
            }

            const storedStoreId = localStorage.getItem('kakuteiStoreId');
            const storedStoreName = localStorage.getItem('kakuteiStoreName');
            
            if (storedStoreId && storedStoreName) {
                storeId = storedStoreId;
                storeName = storedStoreName;
                render();
            } else {
                showLoginScreen();
            }
        }

        function showLoginScreen() {
            appDiv.innerHTML = `
                <div class="min-h-screen flex items-center justify-center">
                    <div class="bg-white p-8 rounded-lg shadow-lg max-w-md w-full">
                        <h1 class="text-2xl font-bold mb-6 text-center">ç¢ºå®šç”³å‘Šã‚·ã‚¹ãƒ†ãƒ </h1>
                        <p class="text-sm text-gray-600 mb-4">å€‹äººäº‹æ¥­ä¸»å‘ã‘é’è‰²ç”³å‘Šæ›¸é¡ä½œæˆ</p>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">åº—èˆ—å</label>
                            <input type="text" id="storeNameInput" class="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" id="passwordInput" class="w-full px-3 py-2 border rounded-lg" />
                        </div>
                        <button onclick="handleLogin()" class="w-full bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600">
                            ãƒ­ã‚°ã‚¤ãƒ³
                        </button>
                    </div>
                </div>
            `;
        }

        window.handleLogin = async function() {
            const storeNameValue = document.getElementById('storeNameInput').value.trim();
            const passwordValue = document.getElementById('passwordInput').value;
            
            if (!storeNameValue || !passwordValue) {
                alert('åº—èˆ—åã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }
            
            try {
                const { collection, query, where, getDocs } = window.firebaseModules;
                
                // ğŸ”§ ä¸‹èµ¤å¡šåº—ã®å ´åˆã¯ç‰¹åˆ¥å‡¦ç†ï¼ˆstoreIdã‚’ç©ºã«ã™ã‚‹ï¼‰
                if (storeNameValue === 'ä¸‹èµ¤å¡š' || storeNameValue === 'shimoakatsuka') {
                    // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
                    const shimoarekasukaPassword = 'K12290619T';  // ğŸ”§ æ­£ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
                    
                    if (passwordValue === shimoarekasukaPassword) {
                        // ğŸ”§ å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢
                        localStorage.removeItem('kakuteiStoreId');
                        localStorage.removeItem('kakuteiStoreName');
                        
                        storeId = '';  // ğŸ”§ ç©ºæ–‡å­—åˆ—ã«ã—ã¦ãƒ«ãƒ¼ãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’ä½¿ç”¨
                        storeName = 'ä¸‹èµ¤å¡š';
                        
                        localStorage.setItem('kakuteiStoreId', '');
                        localStorage.setItem('kakuteiStoreName', 'ä¸‹èµ¤å¡š');
                        
                        console.log('âœ… ä¸‹èµ¤å¡šåº—ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã—ãŸï¼ˆãƒ«ãƒ¼ãƒˆã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ä½¿ç”¨ï¼‰');
                        console.log('ğŸ“ storeId:', storeId, '(ç©ºæ–‡å­—åˆ—)');
                        render();
                        return;
                    } else {
                        alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                        return;
                    }
                }
                
                // é€šå¸¸ã®åº—èˆ—ã®ãƒ­ã‚°ã‚¤ãƒ³å‡¦ç†
                const storesRef = collection(window.db, 'stores');
                const q = query(storesRef, where('storeName', '==', storeNameValue));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    alert('åº—èˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                let authenticated = false;
                let storeData = null;
                let storeDocId = null;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.storePassword === passwordValue) {
                        if (data.isActive === false) {
                            alert('ã“ã®åº—èˆ—ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™');
                            return;
                        }
                        authenticated = true;
                        storeData = data;
                        storeDocId = doc.id;
                    }
                });

                if (authenticated && storeData) {
                    storeId = storeDocId;
                    storeName = storeData.storeName;
                    
                    localStorage.setItem('kakuteiStoreId', storeDocId);
                    localStorage.setItem('kakuteiStoreName', storeData.storeName);
                    
                    render();
                } else {
                    alert('ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“');
                }
            } catch (error) {
                console.error('ãƒ­ã‚°ã‚¤ãƒ³ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        };

        window.handleLogout = function() {
            localStorage.removeItem('kakuteiStoreId');
            localStorage.removeItem('kakuteiStoreName');
            storeId = '';
            storeName = '';
            location.reload();
        };

        function render() {
            if (!salesData) {
                renderYearSelection();
            } else {
                renderMainScreen();
            }
        }

        function renderYearSelection() {
            appDiv.innerHTML = `
                <div class="container mx-auto px-4 py-8">
                    <div class="bg-white rounded-lg shadow-lg p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold">ç¢ºå®šç”³å‘Šã‚·ã‚¹ãƒ†ãƒ </h1>
                            <button onclick="handleLogout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                            </button>
                        </div>
                        
                        <div class="mb-6 p-4 bg-blue-50 rounded-lg">
                            <p class="text-gray-600">åº—èˆ—: ${storeName}</p>
                            <p class="text-gray-600">åº—èˆ—ID: ${storeId}</p>
                        </div>

                        <h2 class="text-xl font-bold mb-4">ç¢ºå®šç”³å‘Šã™ã‚‹å¹´åº¦ã‚’é¸æŠ</h2>
                        <div class="grid grid-cols-3 gap-4">
                            ${[0, 1, 2].map(i => {
                                const year = new Date().getFullYear() - 1 - i;
                                return `
                                    <button 
                                        onclick="selectYear(${year})" 
                                        class="p-6 border-2 border-blue-500 rounded-lg hover:bg-blue-50 transition"
                                    >
                                        <div class="text-2xl font-bold text-blue-600">${year}å¹´</div>
                                        <div class="text-sm text-gray-600 mt-2">
                                            ${year === new Date().getFullYear() - 1 ? 'ï¼ˆæ¨å¥¨ï¼‰' : ''}
                                        </div>
                                    </button>
                                `;
                            }).join('')}
                        </div>

                        <div class="mt-6 p-4 bg-yellow-50 border-l-4 border-yellow-400">
                            <p class="text-sm text-gray-700">
                                ğŸ’¡ é€šå¸¸ã¯å‰å¹´ï¼ˆ${new Date().getFullYear() - 1}å¹´ï¼‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br>
                                ç¢ºå®šç”³å‘ŠæœŸé–“: æ¯å¹´2æœˆ16æ—¥ã€œ3æœˆ15æ—¥
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }

        window.selectYear = async function(year) {
            // null ãŒæ¸¡ã•ã‚ŒãŸå ´åˆã¯å¹´åº¦é¸æŠç”»é¢ã«æˆ»ã‚‹
            if (year === null) {
                salesData = null;
                expenseData = null;
                salaryData = null;
                deductions = {};
                targetYear = new Date().getFullYear() - 1;
                render();
                return;
            }
            
            targetYear = year;
            
            appDiv.innerHTML = `
                <div class="min-h-screen flex items-center justify-center">
                    <div class="text-center">
                        <div class="animate-spin rounded-full h-16 w-16 border-4 border-blue-500 border-t-transparent mx-auto mb-4"></div>
                        <p class="text-xl text-gray-700">${year}å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
                        <p class="text-sm text-gray-500 mt-2">å£²ä¸Šãƒ»çµŒè²»ãƒ»çµ¦ä¸ãƒ‡ãƒ¼ã‚¿ã‚’é›†è¨ˆä¸­</p>
                    </div>
                </div>
            `;
            
            try {
                await loadYearData(year);
                render();
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
                salesData = null;
                render();
            }
        };

        async function loadYearData(year) {
            console.log('ğŸ“Š å¹´é–“ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹:', year);
            
            const { collection, getDocs, doc, getDoc } = window.firebaseModules;
            
            // ğŸ”§ å£²ä¸Šãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆä¸‹èµ¤å¡šåº—å¯¾å¿œï¼‰
            let ordersRef;
            if (!storeId || storeId === '') {
                console.log('ğŸ“ ä¸‹èµ¤å¡šåº—ï¼ˆIDãªã—ï¼‰: ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ã§å£²ä¸Šã‚’å–å¾— (orders/)');
                ordersRef = collection(window.db, 'orders');
            } else {
                console.log('ğŸ“ åº—èˆ—IDä½¿ç”¨: stores/' + storeId + '/orders');
                ordersRef = collection(window.db, 'stores', storeId, 'orders');
            }
            const ordersSnapshot = await getDocs(ordersRef);
            
            console.log('ğŸ“Š å–å¾—ã—ãŸæ³¨æ–‡æ•°:', ordersSnapshot.size);
            
            let totalSales = 0;
            let tax8Sales = 0;
            let tax10Sales = 0;
            let tax8Amount = 0;
            let tax10Amount = 0;
            const monthlySales = Array(12).fill(0);
            const monthlyTax8 = Array(12).fill(0);
            const monthlyTax10 = Array(12).fill(0);
            
            ordersSnapshot.forEach(doc => {
                const data = doc.data();
                
                // ğŸ”§ æœªä¼šè¨ˆã¾ãŸã¯å‰Šé™¤æ¸ˆã¿ã®æ³¨æ–‡ã¯é™¤å¤–
                if (!data.paidAt || data.deleted) {
                    console.log('â­ï¸ ã‚¹ã‚­ãƒƒãƒ—:', doc.id, data.deleted ? '(å‰Šé™¤æ¸ˆã¿)' : '(æœªä¼šè¨ˆ)');
                    return;
                }
                
                const paidDate = data.paidAt.toDate();
                if (paidDate.getFullYear() !== year) return;
                
                const month = paidDate.getMonth();
                const amount = data.totalAmount || 0;
                
                totalSales += amount;
                monthlySales[month] += amount;
                
                // ç¨ç‡åˆ¥é›†è¨ˆ
                const tax8Total = data.tax8Total || 0;
                const tax10Total = data.tax10Total || 0;
                
                tax8Sales += tax8Total;
                tax10Sales += tax10Total;
                monthlyTax8[month] += tax8Total;
                monthlyTax10[month] += tax10Total;
                
                // æ¶ˆè²»ç¨é¡ã‚’è¨ˆç®—ï¼ˆå†…ç¨ï¼‰
                const tax8Excluded = Math.floor(tax8Total / 1.08);
                const tax10Excluded = Math.floor(tax10Total / 1.10);
                tax8Amount += (tax8Total - tax8Excluded);
                tax10Amount += (tax10Total - tax10Excluded);
            });
            
            // ğŸ”§ çµŒè²»ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆä¸‹èµ¤å¡šåº—å¯¾å¿œï¼‰
            let expensesRef;
            if (!storeId || storeId === '') {
                console.log('ğŸ“ ä¸‹èµ¤å¡šåº—ï¼ˆIDãªã—ï¼‰: ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ã§çµŒè²»ã‚’å–å¾— (expenses/)');
                expensesRef = collection(window.db, 'expenses');
            } else {
                console.log('ğŸ“ åº—èˆ—IDä½¿ç”¨: stores/' + storeId + '/expenses');
                expensesRef = collection(window.db, 'stores', storeId, 'expenses');
            }
            const expensesSnapshot = await getDocs(expensesRef);
            
            const expenses = {
                material: 0,      // ææ–™è²»
                salary: 0,        // çµ¦æ–™è³ƒé‡‘
                rent: 0,          // åœ°ä»£å®¶è³ƒ
                utilities: 0,     // æ°´é“å…‰ç†±è²»
                communication: 0, // é€šä¿¡è²»
                transport: 0,     // æ—…è²»äº¤é€šè²»
                entertainment: 0, // æ¥å¾…äº¤éš›è²»
                supplies: 0,      // æ¶ˆè€—å“è²»
                other: 0          // é›‘è²»
            };
            
            let tax8Expenses = 0;
            let tax10Expenses = 0;
            let tax8ExpenseAmount = 0;
            let tax10ExpenseAmount = 0;
            
            expensesSnapshot.forEach(doc => {
                const data = doc.data();
                const date = data.date;
                
                if (!date || !date.startsWith(year.toString())) return;
                
                if (data.items && Array.isArray(data.items)) {
                    data.items.forEach(item => {
                        const amount = item.amount || 0;
                        const category = item.category || '';
                        
                        // ã‚«ãƒ†ã‚´ãƒªåˆ¥æŒ¯ã‚Šåˆ†ã‘ & æ¶ˆè²»ç¨è¨ˆç®—
                        if (category === 'ææ–™è²»' || category === 'é£Ÿè²»') {
                            expenses.material += amount;
                            tax8Expenses += amount;
                            // 8%ã®æ¶ˆè²»ç¨é¡ã‚’è¨ˆç®—ï¼ˆå†…ç¨ï¼‰
                            const excluded = Math.floor(amount / 1.08);
                            tax8ExpenseAmount += (amount - excluded);
                        } else if (category === 'æ°´å…‰ç†±è²»') {
                            expenses.utilities += amount;
                            tax10Expenses += amount;
                            const excluded = Math.floor(amount / 1.10);
                            tax10ExpenseAmount += (amount - excluded);
                        } else if (category === 'äº¤é€šè²»8%') {
                            expenses.transport += amount;
                            tax8Expenses += amount;
                            const excluded = Math.floor(amount / 1.08);
                            tax8ExpenseAmount += (amount - excluded);
                        } else if (category === 'äº¤é€šè²»10%') {
                            expenses.transport += amount;
                            tax10Expenses += amount;
                            const excluded = Math.floor(amount / 1.10);
                            tax10ExpenseAmount += (amount - excluded);
                        } else if (category === 'æ¥å¾…äº¤éš›è²»') {
                            expenses.entertainment += amount;
                            tax8Expenses += amount;
                            const excluded = Math.floor(amount / 1.08);
                            tax8ExpenseAmount += (amount - excluded);
                        } else if (category === 'æ—¥ç”¨å“' || category === 'é›‘è²»ãƒ»é›‘å“') {
                            expenses.supplies += amount;
                            tax10Expenses += amount;
                            const excluded = Math.floor(amount / 1.10);
                            tax10ExpenseAmount += (amount - excluded);
                        } else {
                            expenses.other += amount;
                            tax10Expenses += amount;
                            const excluded = Math.floor(amount / 1.10);
                            tax10ExpenseAmount += (amount - excluded);
                        }
                    });
                }
            });
            
            // çµ¦ä¸ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆkanri.htmlã‹ã‚‰ï¼‰
            // ğŸ”§ å¾“æ¥­å“¡ãƒ‡ãƒ¼ã‚¿å–å¾—ï¼ˆä¸‹èµ¤å¡šåº—å¯¾å¿œï¼‰
            let empRef, attRef;
            if (!storeId || storeId === '') {
                console.log('ğŸ“ ä¸‹èµ¤å¡šåº—ï¼ˆIDãªã—ï¼‰: ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹ã§å¾“æ¥­å“¡ãƒ»å‹¤æ€ ã‚’å–å¾— (kintai_employees/, kintai_attendance/)');
                empRef = collection(window.db, 'kintai_employees');
                attRef = collection(window.db, 'kintai_attendance');
            } else {
                console.log('ğŸ“ åº—èˆ—IDä½¿ç”¨: stores/' + storeId + '/employees, attendance');
                empRef = collection(window.db, 'stores', storeId, 'employees');
                attRef = collection(window.db, 'stores', storeId, 'attendance');
            }
            
            const empSnapshot = await getDocs(empRef);
            const attSnapshot = await getDocs(attRef);
            
            let totalSalary = 0;
            
            attSnapshot.forEach(doc => {
                const date = doc.id;
                if (!date.startsWith(year.toString())) return;
                
                const data = doc.data();
                if (data.employees) {
                    Object.values(data.employees).forEach(emp => {
                        if (emp.dailyWage) {
                            totalSalary += emp.dailyWage;
                        }
                    });
                }
            });
            
            expenses.salary = totalSalary;
            
            salesData = {
                totalSales: totalSales,
                tax8Sales: tax8Sales,
                tax10Sales: tax10Sales,
                tax8Amount: Math.floor(tax8Amount),
                tax10Amount: Math.floor(tax10Amount),
                monthlySales: monthlySales,
                monthlyTax8: monthlyTax8,
                monthlyTax10: monthlyTax10
            };
            
            expenseData = {
                expenses: expenses,
                tax8Expenses: tax8Expenses,
                tax10Expenses: tax10Expenses,
                tax8ExpenseAmount: Math.floor(tax8ExpenseAmount),
                tax10ExpenseAmount: Math.floor(tax10ExpenseAmount),
                totalExpenses: Object.values(expenses).reduce((sum, val) => sum + val, 0)
            };
            
            salaryData = {
                totalSalary: totalSalary
            };
            
            console.log('âœ… ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†:', {
                å£²ä¸Š: totalSales,
                å£²ä¸Šæ¶ˆè²»ç¨8: Math.floor(tax8Amount),
                å£²ä¸Šæ¶ˆè²»ç¨10: Math.floor(tax10Amount),
                çµŒè²»: expenseData.totalExpenses,
                çµŒè²»æ¶ˆè²»ç¨8: Math.floor(tax8ExpenseAmount),
                çµŒè²»æ¶ˆè²»ç¨10: Math.floor(tax10ExpenseAmount),
                çµ¦ä¸: totalSalary
            });
        }

        function renderMainScreen() {
            const calc = new KakuteiCalculator({
                salesData: salesData,
                expenseData: expenseData,
                salaryData: salaryData,
                deductions: deductions
            });
            
            // ç¤¾ä¼šä¿é™ºæ–™ã®è‡ªå‹•è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
            // äº‹æ¥­æ‰€å¾—ã‹ã‚‰æ¦‚ç®—: å›½æ°‘å¥åº·ä¿é™º(ç´„10%) + å›½æ°‘å¹´é‡‘(ç´„20ä¸‡å††)
            const estimatedSocialInsurance = Math.floor(calc.getBusinessIncome() * 0.10) + 200000;
            
            appDiv.innerHTML = `
                <div class="container mx-auto px-4 py-8 no-print">
                    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-3xl font-bold">${targetYear}å¹´ ç¢ºå®šç”³å‘Š</h1>
                            <div class="flex gap-4">
                                <button onclick="selectYear(null)" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                                    â† å¹´åº¦é¸æŠã«æˆ»ã‚‹
                                </button>
                                <button onclick="handleLogout()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">
                                    ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                                </button>
                            </div>
                        </div>

                        <!-- åæ”¯ã‚µãƒãƒªãƒ¼ -->
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="p-4 bg-blue-50 rounded-lg">
                                <div class="text-sm text-gray-600">å¹´é–“å£²ä¸Šé«˜</div>
                                <div class="text-2xl font-bold text-blue-600">Â¥${calc.getTotalSales().toLocaleString()}</div>
                            </div>
                            <div class="p-4 bg-red-50 rounded-lg">
                                <div class="text-sm text-gray-600">å¹´é–“çµŒè²»</div>
                                <div class="text-2xl font-bold text-red-600">Â¥${calc.getTotalExpenses().toLocaleString()}</div>
                            </div>
                            <div class="p-4 bg-green-50 rounded-lg">
                                <div class="text-sm text-gray-600">é’è‰²ç”³å‘Šå‰æ‰€å¾—</div>
                                <div class="text-2xl font-bold text-green-600">Â¥${calc.getIncomeBeforeBlueDeduction().toLocaleString()}</div>
                            </div>
                        </div>

                        <div class="mb-6 p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg border-2 border-purple-200">
                            <h3 class="text-lg font-bold mb-2 text-purple-800">ğŸ’¡ è‡ªå‹•è¨ˆç®—ã®ãŠçŸ¥ã‚‰ã›</h3>
                            <p class="text-sm text-gray-700">
                                âœ… å£²ä¸Šãƒ»çµŒè²»ãƒ»çµ¦ä¸ â†’ POSã‹ã‚‰è‡ªå‹•å–å¾—æ¸ˆã¿<br>
                                âœ… ç¤¾ä¼šä¿é™ºæ–™ â†’ æ‰€å¾—ã‹ã‚‰è‡ªå‹•è¨ˆç®—ï¼ˆæ¦‚ç®—: Â¥${estimatedSocialInsurance.toLocaleString()}ï¼‰<br>
                                ğŸ’¡ ç¤¾ä¼šä¿é™ºæ–™ã¯è‡ªå‹•å…¥åŠ›ã•ã‚Œã¾ã™ãŒã€å®Ÿéš›ã®é‡‘é¡ã«ä¿®æ­£ã§ãã¾ã™
                            </p>
                        </div>

                        <!-- æ§é™¤å…¥åŠ› -->
                        <div class="mb-6">
                            <h3 class="text-xl font-bold mb-4">æ§é™¤æƒ…å ±ã®å…¥åŠ›</h3>
                            
                            <div id="deductionForm" class="space-y-4">
                                <!-- é’è‰²ç”³å‘Šç‰¹åˆ¥æ§é™¤ -->
                                <div class="p-4 border rounded-lg">
                                    <h4 class="font-bold mb-2">é’è‰²ç”³å‘Šç‰¹åˆ¥æ§é™¤</h4>
                                    <select id="blueType" onchange="updateDeductions()" class="px-3 py-2 border rounded">
                                        <option value="full">65ä¸‡å††æ§é™¤ï¼ˆè¤‡å¼ç°¿è¨˜ï¼‰</option>
                                        <option value="simple">10ä¸‡å††æ§é™¤ï¼ˆç°¡æ˜“ç°¿è¨˜ï¼‰</option>
                                    </select>
                                    <p class="text-xs text-gray-500 mt-2">â€» ã“ã®POSã¯è¤‡å¼ç°¿è¨˜å¯¾å¿œãªã®ã§65ä¸‡å††æ§é™¤æ¨å¥¨</p>
                                </div>

                                <!-- é…å¶è€…æƒ…å ± -->
                                <div class="p-4 border rounded-lg">
                                    <h4 class="font-bold mb-2">é…å¶è€…æƒ…å ±</h4>
                                    <label class="flex items-center mb-2">
                                        <input type="checkbox" id="hasSpouse" onchange="toggleSpouse()" class="mr-2" />
                                        é…å¶è€…ã‚ã‚Š
                                    </label>
                                    <div id="spouseIncome" class="hidden">
                                        <label class="text-sm">é…å¶è€…ã®æ‰€å¾—:</label>
                                        <input type="number" id="spouseIncomeAmount" value="0" class="px-3 py-2 border rounded ml-2" />
                                        <span class="text-sm ml-2">å††</span>
                                    </div>
                                </div>

                                <!-- æ‰¶é¤Šè¦ªæ— -->
                                <div class="p-4 border rounded-lg">
                                    <h4 class="font-bold mb-2">æ‰¶é¤Šè¦ªæ—</h4>
                                    <button onclick="addDependent()" class="px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600 mb-3">
                                        + æ‰¶é¤Šè¦ªæ—ã‚’è¿½åŠ 
                                    </button>
                                    <div id="dependentsList"></div>
                                </div>

                                <!-- ç¤¾ä¼šä¿é™ºæ–™ï¼ˆè‡ªå‹•è¨ˆç®—ï¼‰ -->
                                <div class="p-4 border rounded-lg bg-blue-50">
                                    <h4 class="font-bold mb-2">ç¤¾ä¼šä¿é™ºæ–™æ§é™¤ âœ¨è‡ªå‹•è¨ˆç®—</h4>
                                    <input type="number" id="socialInsurance" value="${estimatedSocialInsurance}" class="px-3 py-2 border rounded w-full mb-2" />
                                    <p class="text-xs text-gray-600">
                                        ğŸ’¡ æ‰€å¾—ã‹ã‚‰è‡ªå‹•è¨ˆç®—ã•ã‚Œã¦ã„ã¾ã™ï¼ˆå›½æ°‘å¥åº·ä¿é™º + å›½æ°‘å¹´é‡‘ã®æ¦‚ç®—ï¼‰<br>
                                        å®Ÿéš›ã®æ”¯æ‰•é¡ãŒåˆ†ã‹ã‚‹å ´åˆã¯ã€ä¸Šè¨˜ã®é‡‘é¡ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„
                                    </p>
                                </div>

                                <!-- ç”Ÿå‘½ä¿é™ºæ–™ -->
                                <div class="p-4 border rounded-lg">
                                    <h4 class="font-bold mb-2">ç”Ÿå‘½ä¿é™ºæ–™æ§é™¤</h4>
                                    <div class="grid grid-cols-3 gap-4">
                                        <div>
                                            <label class="text-sm">ä¸€èˆ¬ç”Ÿå‘½ä¿é™º</label>
                                            <input type="number" id="lifeInsurance" value="0" class="w-full px-3 py-2 border rounded" />
                                        </div>
                                        <div>
                                            <label class="text-sm">ä»‹è­·åŒ»ç™‚ä¿é™º</label>
                                            <input type="number" id="medicalInsurance" value="0" class="w-full px-3 py-2 border rounded" />
                                        </div>
                                        <div>
                                            <label class="text-sm">å€‹äººå¹´é‡‘ä¿é™º</label>
                                            <input type="number" id="pensionInsurance" value="0" class="w-full px-3 py-2 border rounded" />
                                        </div>
                                    </div>
                                </div>

                                <!-- åœ°éœ‡ä¿é™ºæ–™ -->
                                <div class="p-4 border rounded-lg">
                                    <h4 class="font-bold mb-2">åœ°éœ‡ä¿é™ºæ–™æ§é™¤</h4>
                                    <input type="number" id="earthquakeInsurance" value="0" class="px-3 py-2 border rounded" />
                                    <span class="text-sm ml-2">å††</span>
                                </div>

                                <!-- å°è¦æ¨¡ä¼æ¥­å…±æ¸ˆç­‰æ›é‡‘ -->
                                <div class="p-4 border rounded-lg">
                                    <h4 class="font-bold mb-2">å°è¦æ¨¡ä¼æ¥­å…±æ¸ˆç­‰æ›é‡‘æ§é™¤</h4>
                                    <input type="number" id="smallBusiness" value="0" class="px-3 py-2 border rounded" />
                                    <span class="text-sm ml-2">å††ï¼ˆiDeCoãªã©ï¼‰</span>
                                </div>

                                <!-- äºˆå®šç´ç¨é¡ -->
                                <div class="p-4 border rounded-lg">
                                    <h4 class="font-bold mb-2">äºˆå®šç´ç¨é¡ï¼ˆæºæ³‰å¾´åç¨é¡ï¼‰</h4>
                                    <input type="number" id="prepaidTax" value="0" class="px-3 py-2 border rounded" />
                                    <span class="text-sm ml-2">å††</span>
                                </div>

                                <!-- æ¶ˆè²»ç¨ä¸­é–“ç´ä»˜é¡ -->
                                <div class="p-4 border rounded-lg bg-blue-50">
                                    <h4 class="font-bold mb-2">æ¶ˆè²»ç¨ã®ä¸­é–“ç´ä»˜ç¨é¡</h4>
                                    <input type="number" id="intermediatePayment" value="0" class="px-3 py-2 border rounded" />
                                    <span class="text-sm ml-2">å††ï¼ˆå‰å¹´ã®æ¶ˆè²»ç¨ã®ä¸­é–“ç´ä»˜åˆ†ï¼‰</span>
                                    <p class="text-xs text-gray-600 mt-2">â€» å‰å¹´ã®æ¶ˆè²»ç¨ãŒ48ä¸‡å††è¶…ã®å ´åˆã«ä¸­é–“ç´ä»˜ãŒå¿…è¦</p>
                                </div>
                            </div>
                        </div>

                        <!-- è¨ˆç®—ãƒœã‚¿ãƒ³ -->
                        <button onclick="calculate()" class="w-full px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 font-bold text-lg">
                            ğŸ’° è¨ˆç®—ã™ã‚‹
                        </button>

                        <!-- è¨ˆç®—çµæœ -->
                        <div id="result" class="hidden mt-6"></div>
                    </div>
                </div>

                <!-- å°åˆ·ã‚¨ãƒªã‚¢ -->
                <div id="printArea" class="hidden"></div>
            `;
        }

        window.toggleSpouse = function() {
            const checked = document.getElementById('hasSpouse').checked;
            document.getElementById('spouseIncome').classList.toggle('hidden', !checked);
        };

        let dependents = [];
        window.addDependent = function() {
            dependents.push({ age: 16 });
            renderDependents();
        };

        window.removeDependent = function(index) {
            dependents.splice(index, 1);
            renderDependents();
        };

        function renderDependents() {
            const list = document.getElementById('dependentsList');
            list.innerHTML = dependents.map((d, i) => `
                <div class="flex items-center gap-4 mb-2">
                    <label class="text-sm">å¹´é½¢:</label>
                    <input type="number" value="${d.age}" onchange="dependents[${i}].age = parseInt(this.value)" class="px-3 py-2 border rounded w-20" />
                    <button onclick="removeDependent(${i})" class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600">å‰Šé™¤</button>
                </div>
            `).join('');
        }

        window.calculate = function() {
            // æ§é™¤æƒ…å ±ã‚’åé›†
            deductions = {
                blueType: document.getElementById('blueType').value,
                hasSpouse: document.getElementById('hasSpouse').checked,
                spouseIncome: parseInt(document.getElementById('spouseIncomeAmount').value) || 0,
                dependents: dependents,
                socialInsurance: parseInt(document.getElementById('socialInsurance').value) || 0,
                lifeInsurance: parseInt(document.getElementById('lifeInsurance').value) || 0,
                medicalInsurance: parseInt(document.getElementById('medicalInsurance').value) || 0,
                pensionInsurance: parseInt(document.getElementById('pensionInsurance').value) || 0,
                earthquakeInsurance: parseInt(document.getElementById('earthquakeInsurance').value) || 0,
                smallBusiness: parseInt(document.getElementById('smallBusiness').value) || 0,
                prepaidTax: parseInt(document.getElementById('prepaidTax').value) || 0,
                intermediatePayment: parseInt(document.getElementById('intermediatePayment').value) || 0
            };

            const calc = new KakuteiCalculator({
                salesData: salesData,
                expenseData: expenseData,
                salaryData: salaryData,
                deductions: deductions
            });

            const resultDiv = document.getElementById('result');
            resultDiv.classList.remove('hidden');
            
            const paymentAmount = calc.getPaymentAmount();
            const isRefund = paymentAmount < 0;
            
            resultDiv.innerHTML = `
                <div class="p-6 bg-gradient-to-r from-blue-50 to-green-50 rounded-lg">
                    <h3 class="text-2xl font-bold mb-6 text-center">è¨ˆç®—çµæœ</h3>
                    
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-sm text-gray-600">å£²ä¸Šé«˜</div>
                            <div class="text-xl font-bold">Â¥${calc.getTotalSales().toLocaleString()}</div>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-sm text-gray-600">å¿…è¦çµŒè²»</div>
                            <div class="text-xl font-bold">Â¥${calc.getTotalExpenses().toLocaleString()}</div>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-sm text-gray-600">é’è‰²ç”³å‘Šç‰¹åˆ¥æ§é™¤</div>
                            <div class="text-xl font-bold">Â¥${calc.getBlueDeduction().toLocaleString()}</div>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-sm text-gray-600">äº‹æ¥­æ‰€å¾—</div>
                            <div class="text-xl font-bold text-blue-600">Â¥${calc.getBusinessIncome().toLocaleString()}</div>
                        </div>
                    </div>

                    <div class="p-4 bg-white rounded-lg shadow mb-6">
                        <div class="text-sm text-gray-600">æ‰€å¾—æ§é™¤åˆè¨ˆ</div>
                        <div class="text-2xl font-bold text-blue-600">Â¥${calc.getTotalDeductions().toLocaleString()}</div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-sm text-gray-600">èª²ç¨æ‰€å¾—</div>
                            <div class="text-xl font-bold">Â¥${calc.getTaxableIncome().toLocaleString()}</div>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow">
                            <div class="text-sm text-gray-600">æ‰€å¾—ç¨é¡</div>
                            <div class="text-xl font-bold">Â¥${calc.getTotalTax().toLocaleString()}</div>
                        </div>
                    </div>

                    <div class="p-6 bg-white rounded-lg shadow-lg">
                        <div class="text-center mb-2">
                            <div class="text-lg text-gray-600">${isRefund ? 'é‚„ä»˜ã•ã‚Œã‚‹ç¨é‡‘' : 'ç´ã‚ã‚‹ç¨é‡‘'}</div>
                            <div class="text-4xl font-bold ${isRefund ? 'text-green-600' : 'text-red-600'}">
                                ${isRefund ? '+' : ''}Â¥${Math.abs(paymentAmount).toLocaleString()}
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 grid grid-cols-2 gap-4">
                        <button onclick="printDocuments()" class="px-6 py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 font-bold">
                            ğŸ“„ ç”³å‘Šæ›¸é¡ã‚’å°åˆ·
                        </button>
                        <button onclick="exportData()" class="px-6 py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 font-bold">
                            ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                        </button>
                    </div>

                    ${calc.needsConsumptionTaxFiling() ? `
                        <div class="mt-6 p-6 bg-blue-50 border-2 border-blue-400 rounded-lg">
                            <h3 class="text-xl font-bold mb-4 text-blue-800">ğŸ’³ æ¶ˆè²»ç¨ç”³å‘Šï¼ˆå£²ä¸Š1000ä¸‡å††è¶…ï¼‰</h3>
                            
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div class="p-3 bg-white rounded shadow">
                                    <div class="text-sm text-gray-600">èª²ç¨å£²ä¸Šé«˜ï¼ˆç¨æŠœï¼‰</div>
                                    <div class="text-lg font-bold">Â¥${calc.getTotalTaxableSales().toLocaleString()}</div>
                                </div>
                                <div class="p-3 bg-white rounded shadow">
                                    <div class="text-sm text-gray-600">èª²ç¨ä»•å…¥é«˜ï¼ˆç¨æŠœï¼‰</div>
                                    <div class="text-lg font-bold">Â¥${calc.getTotalTaxablePurchase().toLocaleString()}</div>
                                </div>
                                <div class="p-3 bg-white rounded shadow">
                                    <div class="text-sm text-gray-600">å£²ä¸Šã«ä¿‚ã‚‹æ¶ˆè²»ç¨</div>
                                    <div class="text-lg font-bold text-red-600">Â¥${calc.getTotalSalesConsumptionTax().toLocaleString()}</div>
                                </div>
                                <div class="p-3 bg-white rounded shadow">
                                    <div class="text-sm text-gray-600">ä»•å…¥ã«ä¿‚ã‚‹æ¶ˆè²»ç¨</div>
                                    <div class="text-lg font-bold text-blue-600">Â¥${calc.getTotalPurchaseConsumptionTax().toLocaleString()}</div>
                                </div>
                            </div>

                            <div class="p-4 bg-white rounded shadow mb-4">
                                <div class="text-sm text-gray-600">å·®å¼•æ¶ˆè²»ç¨é¡</div>
                                <div class="text-2xl font-bold text-blue-800">Â¥${calc.getNetConsumptionTax().toLocaleString()}</div>
                            </div>

                            <div class="p-4 bg-white rounded shadow mb-4">
                                <div class="text-sm text-gray-600">åœ°æ–¹æ¶ˆè²»ç¨é¡</div>
                                <div class="text-xl font-bold">Â¥${calc.getLocalConsumptionTax().toLocaleString()}</div>
                            </div>

                            <div class="p-4 bg-gradient-to-r from-blue-100 to-blue-200 rounded shadow">
                                <div class="text-center">
                                    <div class="text-lg text-gray-700">ç´ã‚ã‚‹æ¶ˆè²»ç¨ãƒ»åœ°æ–¹æ¶ˆè²»ç¨</div>
                                    <div class="text-3xl font-bold text-blue-800">Â¥${calc.getConsumptionTaxPaymentAmount().toLocaleString()}</div>
                                </div>
                            </div>

                            <p class="text-sm text-gray-600 mt-4">
                                â„¹ï¸ æ¶ˆè²»ç¨ç”³å‘Šæ›¸ã¯å°åˆ·ãƒœã‚¿ãƒ³ã§é’è‰²ç”³å‘Šæ±ºç®—æ›¸ãƒ»ç¢ºå®šç”³å‘Šæ›¸Bã¨ä¸€ç·’ã«å‡ºåŠ›ã•ã‚Œã¾ã™
                            </p>
                        </div>
                    ` : `
                        <div class="mt-6 p-4 bg-gray-50 border-l-4 border-gray-400 rounded">
                            <p class="text-sm text-gray-700">
                                â„¹ï¸ å£²ä¸Š1000ä¸‡å††ä»¥ä¸‹ã®ãŸã‚ã€æ¶ˆè²»ç¨ç”³å‘Šã¯ä¸è¦ã§ã™<br>
                                ï¼ˆå‰ã€…å¹´ã®å£²ä¸ŠãŒ1000ä¸‡å††ã‚’è¶…ãˆãŸå ´åˆã€ç¿Œã€…å¹´ã‹ã‚‰æ¶ˆè²»ç¨èª²ç¨äº‹æ¥­è€…ã¨ãªã‚Šã¾ã™ï¼‰
                            </p>
                        </div>
                    `}

                    <div class="mt-4 p-4 bg-yellow-50 border-l-4 border-yellow-400">
                        <p class="text-sm text-gray-700">
                            âœ… ã“ã®æ›¸é¡ã‚’ç¨å‹™ç½²ã«æŒå‚ã—ã¦ãã ã•ã„<br>
                            âœ… æ§é™¤è¨¼æ˜æ›¸ï¼ˆç”Ÿå‘½ä¿é™ºãƒ»åœ°éœ‡ä¿é™ºãªã©ï¼‰ã‚‚å¿…è¦ã§ã™<br>
                            âœ… ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼ã‚«ãƒ¼ãƒ‰ã¾ãŸã¯é€šçŸ¥ã‚«ãƒ¼ãƒ‰ã‚’æŒå‚ã—ã¦ãã ã•ã„<br>
                            ${calc.needsConsumptionTaxFiling() ? 'âœ… æ¶ˆè²»ç¨ç”³å‘Šæ›¸ã‚‚ä¸€ç·’ã«æå‡ºã—ã¦ãã ã•ã„<br>' : ''}
                            âœ… ãƒ¬ã‚·ãƒ¼ãƒˆãƒ»é ˜åæ›¸ã¯7å¹´é–“ä¿ç®¡ï¼ˆæå‡ºä¸è¦ï¼‰
                        </p>
                    </div>
                </div>
            `;
        };

        window.printDocuments = function() {
            const calc = new KakuteiCalculator({
                salesData: salesData,
                expenseData: expenseData,
                salaryData: salaryData,
                deductions: deductions
            });

            const printArea = document.getElementById('printArea');
            printArea.classList.remove('hidden');
            
            // é’è‰²ç”³å‘Šæ±ºç®—æ›¸
            printArea.innerHTML = generateAoiroKessan(calc);
            
            // ç¢ºå®šç”³å‘Šæ›¸B
            printArea.innerHTML += generateKakuteiB(calc);
            
            // æ¶ˆè²»ç¨ç”³å‘Šæ›¸ï¼ˆå£²ä¸Š1000ä¸‡å††è¶…ã®å ´åˆï¼‰
            if (calc.needsConsumptionTaxFiling()) {
                printArea.innerHTML += generateConsumptionTaxReturn(calc);
            }
            
            window.print();
            
            setTimeout(() => {
                printArea.classList.add('hidden');
            }, 1000);
        };

        function generateConsumptionTaxReturn(calc) {
            return `
                <div class="print-area a4-page">
                    <h1 class="text-center text-2xl font-bold mb-4">æ¶ˆè²»ç¨åŠã³åœ°æ–¹æ¶ˆè²»ç¨ã®ç¢ºå®šç”³å‘Šæ›¸</h1>
                    <p class="text-center mb-6">${targetYear}å¹´åˆ†ï¼ˆä¸€èˆ¬èª²ç¨ç”¨ï¼‰</p>
                    
                    <div class="mb-4">
                        <p>ä½æ‰€ã¾ãŸã¯äº‹æ¥­æ‰€æ‰€åœ¨åœ°: _______________________________</p>
                        <p>æ°å: ${storeName}</p>
                        <p>ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼: ___ ____ ____</p>
                    </div>

                    <h3 class="font-bold mb-2">èª²ç¨æ¨™æº–é¡ç­‰</h3>
                    <table class="w-full border-collapse border border-black mb-6">
                        <tr>
                            <th class="border border-black p-2 bg-gray-100">ç¨ç‡</th>
                            <th class="border border-black p-2 bg-gray-100">èª²ç¨æ¨™æº–é¡ï¼ˆç¨æŠœï¼‰</th>
                            <th class="border border-black p-2 bg-gray-100">æ¶ˆè²»ç¨é¡</th>
                        </tr>
                        <tr>
                            <td class="border border-black p-2">8%</td>
                            <td class="border border-black p-2 text-right">Â¥${calc.getTaxableSales8().toLocaleString()}</td>
                            <td class="border border-black p-2 text-right">Â¥${calc.getSalesConsumptionTax8().toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td class="border border-black p-2">10%</td>
                            <td class="border border-black p-2 text-right">Â¥${calc.getTaxableSales10().toLocaleString()}</td>
                            <td class="border border-black p-2 text-right">Â¥${calc.getSalesConsumptionTax10().toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td class="border border-black p-2 font-bold">åˆè¨ˆ</td>
                            <td class="border border-black p-2 text-right font-bold">Â¥${calc.getTotalTaxableSales().toLocaleString()}</td>
                            <td class="border border-black p-2 text-right font-bold">Â¥${calc.getTotalSalesConsumptionTax().toLocaleString()}</td>
                        </tr>
                    </table>

                    <h3 class="font-bold mb-2">èª²ç¨ä»•å…¥ã‚Œã«ä¿‚ã‚‹æ”¯æ‰•å¯¾ä¾¡ã®é¡</h3>
                    <table class="w-full border-collapse border border-black mb-6">
                        <tr>
                            <th class="border border-black p-2 bg-gray-100">ç¨ç‡</th>
                            <th class="border border-black p-2 bg-gray-100">èª²ç¨ä»•å…¥é«˜ï¼ˆç¨æŠœï¼‰</th>
                            <th class="border border-black p-2 bg-gray-100">æ¶ˆè²»ç¨é¡</th>
                        </tr>
                        <tr>
                            <td class="border border-black p-2">8%</td>
                            <td class="border border-black p-2 text-right">Â¥${calc.getTaxablePurchase8().toLocaleString()}</td>
                            <td class="border border-black p-2 text-right">Â¥${calc.getPurchaseConsumptionTax8().toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td class="border border-black p-2">10%</td>
                            <td class="border border-black p-2 text-right">Â¥${calc.getTaxablePurchase10().toLocaleString()}</td>
                            <td class="border border-black p-2 text-right">Â¥${calc.getPurchaseConsumptionTax10().toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td class="border border-black p-2 font-bold">åˆè¨ˆ</td>
                            <td class="border border-black p-2 text-right font-bold">Â¥${calc.getTotalTaxablePurchase().toLocaleString()}</td>
                            <td class="border border-black p-2 text-right font-bold">Â¥${calc.getTotalPurchaseConsumptionTax().toLocaleString()}</td>
                        </tr>
                    </table>

                    <h3 class="font-bold mb-2">æ¶ˆè²»ç¨é¡ã®è¨ˆç®—</h3>
                    <table class="w-full border-collapse border border-black mb-6">
                        <tr>
                            <td class="border border-black p-2">èª²ç¨å£²ä¸Šã’ã«ä¿‚ã‚‹æ¶ˆè²»ç¨é¡</td>
                            <td class="border border-black p-2 text-right">Â¥${calc.getTotalSalesConsumptionTax().toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td class="border border-black p-2">æ§é™¤å¯¾è±¡ä»•å…¥ç¨é¡</td>
                            <td class="border border-black p-2 text-right">Â¥${calc.getDeductiblePurchaseTax().toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td class="border border-black p-2 font-bold">å·®å¼•ç¨é¡</td>
                            <td class="border border-black p-2 text-right font-bold">Â¥${calc.getNetConsumptionTax().toLocaleString()}</td>
                        </tr>
                    </table>

                    <h3 class="font-bold mb-2">åœ°æ–¹æ¶ˆè²»ç¨é¡ã®è¨ˆç®—</h3>
                    <table class="w-full border-collapse border border-black mb-6">
                        <tr>
                            <td class="border border-black p-2">æ¶ˆè²»ç¨é¡</td>
                            <td class="border border-black p-2 text-right">Â¥${calc.getNetConsumptionTax().toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td class="border border-black p-2">åœ°æ–¹æ¶ˆè²»ç¨é¡ï¼ˆæ¶ˆè²»ç¨é¡ Ã— 22/78ï¼‰</td>
                            <td class="border border-black p-2 text-right">Â¥${calc.getLocalConsumptionTax().toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td class="border border-black p-2 font-bold">æ¶ˆè²»ç¨åŠã³åœ°æ–¹æ¶ˆè²»ç¨ã®é¡</td>
                            <td class="border border-black p-2 text-right font-bold">Â¥${calc.getTotalConsumptionTaxPayment().toLocaleString()}</td>
                        </tr>
                    </table>

                    <table class="w-full border-collapse border border-black">
                        <tr>
                            <td class="border border-black p-2">ä¸­é–“ç´ä»˜ç¨é¡</td>
                            <td class="border border-black p-2 text-right">Â¥${calc.getIntermediatePayment().toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td class="border border-black p-2 font-bold text-lg">å·®å¼•ç´ä»˜ã™ã¹ãç¨é¡</td>
                            <td class="border border-black p-2 text-right font-bold text-xl text-red-600">
                                Â¥${calc.getConsumptionTaxPaymentAmount().toLocaleString()}
                            </td>
                        </tr>
                    </table>

                    <div class="mt-6 p-4 border-2 border-gray-300 rounded">
                        <p class="text-sm text-gray-700">
                            ã€å†…è¨³ã€‘<br>
                            ãƒ»8%å¯¾è±¡å–å¼•: å£²ä¸Š Â¥${calc.getTaxableSales8().toLocaleString()} / ä»•å…¥ Â¥${calc.getTaxablePurchase8().toLocaleString()}<br>
                            ãƒ»10%å¯¾è±¡å–å¼•: å£²ä¸Š Â¥${calc.getTaxableSales10().toLocaleString()} / ä»•å…¥ Â¥${calc.getTaxablePurchase10().toLocaleString()}<br>
                            <br>
                            â€» POSã‚·ã‚¹ãƒ†ãƒ ã§ç¨ç‡åˆ¥ã«è‡ªå‹•é›†è¨ˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
                        </p>
                    </div>
                </div>
            `;
        }

        function generateAoiroKessan(calc) {
            const expenses = expenseData.expenses;
            
            return `
                <div class="print-area a4-page">
                    <h1 class="text-center text-2xl font-bold mb-4">æ‰€å¾—ç¨é’è‰²ç”³å‘Šæ±ºç®—æ›¸ï¼ˆä¸€èˆ¬ç”¨ï¼‰</h1>
                    <p class="text-center mb-6">${targetYear}å¹´åˆ†</p>
                    
                    <div class="mb-4">
                        <p>ä½æ‰€ã¾ãŸã¯äº‹æ¥­æ‰€æ‰€åœ¨åœ°: _______________________________</p>
                        <p>æ°å: ${storeName}</p>
                    </div>

                    <table class="w-full border-collapse border border-black mb-6">
                        <tr>
                            <th class="border border-black p-2 bg-gray-100">ç§‘ç›®</th>
                            <th class="border border-black p-2 bg-gray-100">é‡‘é¡ï¼ˆå††ï¼‰</th>
                        </tr>
                        <tr>
                            <td class="border border-black p-2">å£²ä¸Šï¼ˆåå…¥ï¼‰é‡‘é¡</td>
                            <td class="border border-black p-2 text-right">${calc.getTotalSales().toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td class="border border-black p-2 font-bold">å£²ä¸Šï¼ˆåå…¥ï¼‰é‡‘é¡ è¨ˆ</td>
                            <td class="border border-black p-2 text-right font-bold">${calc.getTotalSales().toLocaleString()}</td>
                        </tr>
                    </table>

                    <h3 class="font-bold mb-2">å¿…è¦çµŒè²»</h3>
                    <table class="w-full border-collapse border border-black mb-6">
                        <tr>
                            <th class="border border-black p-2 bg-gray-100">ç§‘ç›®</th>
                            <th class="border border-black p-2 bg-gray-100">é‡‘é¡ï¼ˆå††ï¼‰</th>
                        </tr>
                        ${Object.entries({
                            'ææ–™è²»': expenses.material,
                            'çµ¦æ–™è³ƒé‡‘': expenses.salary,
                            'åœ°ä»£å®¶è³ƒ': expenses.rent,
                            'æ°´é“å…‰ç†±è²»': expenses.utilities,
                            'é€šä¿¡è²»': expenses.communication,
                            'æ—…è²»äº¤é€šè²»': expenses.transport,
                            'æ¥å¾…äº¤éš›è²»': expenses.entertainment,
                            'æ¶ˆè€—å“è²»': expenses.supplies,
                            'é›‘è²»': expenses.other
                        }).map(([name, amount]) => `
                            <tr>
                                <td class="border border-black p-2">${name}</td>
                                <td class="border border-black p-2 text-right">${amount.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                        <tr>
                            <td class="border border-black p-2 font-bold">çµŒè²»åˆè¨ˆ</td>
                            <td class="border border-black p-2 text-right font-bold">${calc.getTotalExpenses().toLocaleString()}</td>
                        </tr>
                    </table>

                    <table class="w-full border-collapse border border-black">
                        <tr>
                            <td class="border border-black p-2">å·®å¼•é‡‘é¡ï¼ˆå£²ä¸Š - çµŒè²»ï¼‰</td>
                            <td class="border border-black p-2 text-right">${calc.getIncomeBeforeBlueDeduction().toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td class="border border-black p-2">é’è‰²ç”³å‘Šç‰¹åˆ¥æ§é™¤é¡</td>
                            <td class="border border-black p-2 text-right">${calc.getBlueDeduction().toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td class="border border-black p-2 font-bold">æ‰€å¾—é‡‘é¡</td>
                            <td class="border border-black p-2 text-right font-bold text-lg">${calc.getBusinessIncome().toLocaleString()}</td>
                        </tr>
                    </table>
                </div>
            `;
        }

        function generateKakuteiB(calc) {
            return `
                <div class="print-area a4-page">
                    <h1 class="text-center text-2xl font-bold mb-4">ç¢ºå®šç”³å‘Šæ›¸ Bï¼ˆç¬¬ä¸€è¡¨ï¼‰</h1>
                    <p class="text-center mb-6">${targetYear}å¹´åˆ†ã®æ‰€å¾—ç¨åŠã³å¾©èˆˆç‰¹åˆ¥æ‰€å¾—ç¨ã®ç¢ºå®šç”³å‘Šæ›¸</p>
                    
                    <div class="mb-4">
                        <p>ä½æ‰€: _______________________________</p>
                        <p>æ°å: ${storeName}</p>
                        <p>ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼: ___ ____ ____</p>
                    </div>

                    <h3 class="font-bold mb-2">åå…¥é‡‘é¡ç­‰</h3>
                    <table class="w-full border-collapse border border-black mb-6">
                        <tr>
                            <td class="border border-black p-2">äº‹æ¥­ï¼ˆå–¶æ¥­ç­‰ï¼‰</td>
                            <td class="border border-black p-2 text-right">${calc.getTotalSales().toLocaleString()}</td>
                        </tr>
                    </table>

                    <h3 class="font-bold mb-2">æ‰€å¾—é‡‘é¡</h3>
                    <table class="w-full border-collapse border border-black mb-6">
                        <tr>
                            <td class="border border-black p-2">äº‹æ¥­æ‰€å¾—</td>
                            <td class="border border-black p-2 text-right">${calc.getBusinessIncome().toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td class="border border-black p-2 font-bold">åˆè¨ˆ</td>
                            <td class="border border-black p-2 text-right font-bold">${calc.getBusinessIncome().toLocaleString()}</td>
                        </tr>
                    </table>

                    <h3 class="font-bold mb-2">æ‰€å¾—ã‹ã‚‰å·®ã—å¼•ã‹ã‚Œã‚‹é‡‘é¡ï¼ˆæ‰€å¾—æ§é™¤ï¼‰</h3>
                    <table class="w-full border-collapse border border-black mb-6">
                        <tr>
                            <td class="border border-black p-2">åŸºç¤æ§é™¤</td>
                            <td class="border border-black p-2 text-right">${calc.getBasicDeduction().toLocaleString()}</td>
                        </tr>
                        ${calc.getSpouseDeduction() > 0 ? `
                        <tr>
                            <td class="border border-black p-2">é…å¶è€…æ§é™¤</td>
                            <td class="border border-black p-2 text-right">${calc.getSpouseDeduction().toLocaleString()}</td>
                        </tr>
                        ` : ''}
                        ${calc.getSpouseSpecialDeduction() > 0 ? `
                        <tr>
                            <td class="border border-black p-2">é…å¶è€…ç‰¹åˆ¥æ§é™¤</td>
                            <td class="border border-black p-2 text-right">${calc.getSpouseSpecialDeduction().toLocaleString()}</td>
                        </tr>
                        ` : ''}
                        ${calc.getDependentDeduction() > 0 ? `
                        <tr>
                            <td class="border border-black p-2">æ‰¶é¤Šæ§é™¤</td>
                            <td class="border border-black p-2 text-right">${calc.getDependentDeduction().toLocaleString()}</td>
                        </tr>
                        ` : ''}
                        ${calc.getSocialInsuranceDeduction() > 0 ? `
                        <tr>
                            <td class="border border-black p-2">ç¤¾ä¼šä¿é™ºæ–™æ§é™¤</td>
                            <td class="border border-black p-2 text-right">${calc.getSocialInsuranceDeduction().toLocaleString()}</td>
                        </tr>
                        ` : ''}
                        ${calc.getLifeInsuranceDeduction() > 0 ? `
                        <tr>
                            <td class="border border-black p-2">ç”Ÿå‘½ä¿é™ºæ–™æ§é™¤</td>
                            <td class="border border-black p-2 text-right">${calc.getLifeInsuranceDeduction().toLocaleString()}</td>
                        </tr>
                        ` : ''}
                        ${calc.getEarthquakeDeduction() > 0 ? `
                        <tr>
                            <td class="border border-black p-2">åœ°éœ‡ä¿é™ºæ–™æ§é™¤</td>
                            <td class="border border-black p-2 text-right">${calc.getEarthquakeDeduction().toLocaleString()}</td>
                        </tr>
                        ` : ''}
                        ${calc.getSmallBusinessDeduction() > 0 ? `
                        <tr>
                            <td class="border border-black p-2">å°è¦æ¨¡ä¼æ¥­å…±æ¸ˆç­‰æ›é‡‘æ§é™¤</td>
                            <td class="border border-black p-2 text-right">${calc.getSmallBusinessDeduction().toLocaleString()}</td>
                        </tr>
                        ` : ''}
                        <tr>
                            <td class="border border-black p-2 font-bold">æ‰€å¾—æ§é™¤åˆè¨ˆ</td>
                            <td class="border border-black p-2 text-right font-bold">${calc.getTotalDeductions().toLocaleString()}</td>
                        </tr>
                    </table>

                    <h3 class="font-bold mb-2">ç¨é‡‘ã®è¨ˆç®—</h3>
                    <table class="w-full border-collapse border border-black">
                        <tr>
                            <td class="border border-black p-2">èª²ç¨ã•ã‚Œã‚‹æ‰€å¾—é‡‘é¡</td>
                            <td class="border border-black p-2 text-right">${calc.getTaxableIncome().toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td class="border border-black p-2">ä¸Šè¨˜ã«å¯¾ã™ã‚‹ç¨é¡</td>
                            <td class="border border-black p-2 text-right">${calc.getTotalTax().toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td class="border border-black p-2">äºˆå®šç´ç¨é¡</td>
                            <td class="border border-black p-2 text-right">${calc.getPrepaidTax().toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td class="border border-black p-2 font-bold text-lg">${calc.getPaymentAmount() >= 0 ? 'ç´ã‚ã‚‹ç¨é‡‘' : 'é‚„ä»˜ã•ã‚Œã‚‹ç¨é‡‘'}</td>
                            <td class="border border-black p-2 text-right font-bold text-xl ${calc.getPaymentAmount() >= 0 ? 'text-red-600' : 'text-green-600'}">
                                ${Math.abs(calc.getPaymentAmount()).toLocaleString()}
                            </td>
                        </tr>
                    </table>
                </div>
            `;
        }

        window.exportData = function() {
            const calc = new KakuteiCalculator({
                salesData: salesData,
                expenseData: expenseData,
                salaryData: salaryData,
                deductions: deductions
            });

            const data = {
                å¹´åº¦: targetYear,
                åº—èˆ—å: storeName,
                å£²ä¸Šé«˜: calc.getTotalSales(),
                çµŒè²»åˆè¨ˆ: calc.getTotalExpenses(),
                é’è‰²ç”³å‘Šç‰¹åˆ¥æ§é™¤: calc.getBlueDeduction(),
                äº‹æ¥­æ‰€å¾—: calc.getBusinessIncome(),
                æ‰€å¾—æ§é™¤åˆè¨ˆ: calc.getTotalDeductions(),
                èª²ç¨æ‰€å¾—: calc.getTaxableIncome(),
                æ‰€å¾—ç¨é¡: calc.getTotalTax(),
                ç´ç¨é¡ã¾ãŸã¯é‚„ä»˜é¡: calc.getPaymentAmount()
            };

            // æ¶ˆè²»ç¨ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ ï¼ˆå£²ä¸Š1000ä¸‡å††è¶…ã®å ´åˆï¼‰
            if (calc.needsConsumptionTaxFiling()) {
                data['æ¶ˆè²»ç¨_èª²ç¨å£²ä¸Šé«˜'] = calc.getTotalTaxableSales();
                data['æ¶ˆè²»ç¨_èª²ç¨ä»•å…¥é«˜'] = calc.getTotalTaxablePurchase();
                data['æ¶ˆè²»ç¨_å£²ä¸Šç¨é¡'] = calc.getTotalSalesConsumptionTax();
                data['æ¶ˆè²»ç¨_ä»•å…¥ç¨é¡'] = calc.getTotalPurchaseConsumptionTax();
                data['æ¶ˆè²»ç¨_å·®å¼•ç¨é¡'] = calc.getNetConsumptionTax();
                data['åœ°æ–¹æ¶ˆè²»ç¨é¡'] = calc.getLocalConsumptionTax();
                data['æ¶ˆè²»ç¨_ç´ä»˜ç¨é¡'] = calc.getConsumptionTaxPaymentAmount();
            }

            const csv = Object.entries(data).map(([key, value]) => `${key},${value}`).join('\n');
            const bom = new Uint8Array([0xEF, 0xBB, 0xBF]);
            const blob = new Blob([bom, csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ç¢ºå®šç”³å‘Šãƒ‡ãƒ¼ã‚¿_${storeName}_${targetYear}.csv`;
            a.click();
        };

        init();
    </script>
</body>
</html>
