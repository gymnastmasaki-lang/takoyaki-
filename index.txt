<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif;
      background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
      min-height: 100vh;
      padding: 0;
      margin: 0;
      max-width: 100vw;
      overflow-x: hidden;
    }
    
    .header {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 15px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header h1 {
      font-size: 28px;
      margin-bottom: 5px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .container {
  width: 100%;
  max-width: 100% !important;
  margin: 0;
  padding: 10px;
}

    
    .category-filter {
      background: white;
      padding: 15px;
      border-radius: 15px;
      margin-bottom: 50px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .category-filter label {
      display: block;
      font-size: 40px;
      font-weight: bold;
      color: #333;
      margin-bottom: 10px;
    }
    
    select {
      width: 100%;
      padding: 40px;
      font-size: 35px;
      border: 3px solid #4CAF50;
      border-radius: 12px;
      background: white;
      color: #333;
      font-weight: 500;
    }
    
    .menu-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 12px;
  margin-bottom: 100px;
}

    
    @media (min-width: 420px) {
      .menu-grid {
        gap: 15px;
      }
    }
    
    .menu-item {
      padding: 22px !important;
  min-height: 150px !important;
  flex-direction: column;
  justify-content: center;
      background: white;
      border-radius: 15px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .menu-item:active {
      transform: scale(0.95);
    }
    
    .menu-item:hover {
      box-shadow: 0 6px 20px rgba(76, 175, 80, 0.3);
      transform: translateY(-3px);
    }
    
    .menu-item-name {
      font-size: 50px !important;
      line-height: 1.4 !important;
      font-weight: 600 !important;
      font-weight: bold;
      color: #333;
      margin-bottom: 8px;
      line-height: 1.3;
      min-height: 40px;
    }
    
    @media (min-width: 420px) {
      .menu-item-name {
        font-size: 50px;
      }
    }
    
    .menu-item-price {
      font-size: 30px !important;
      color: #4CAF50;
      font-weight: bold;
    }
    
    .menu-item-note {
      font-size: 35px;
      color: #999;
      margin-top: 5px;
    }
    
    button {
      width: 100%;
      padding: 18px;
      font-size: 50px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      margin: 8px 0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
    }
    
    button:active {
      transform: scale(0.98);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
    }
    
    .btn-primary:hover {
      background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .topping-list {
      display: grid;
      gap: 36px;
      margin: 60px 0;
    }
    
    .topping-item {
      padding: 15px;
      border: 3px solid #e0e0e0;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      font-size: 60px;
    }
    
    .topping-item.selected {
      background: #e8f5e9;
      border-color: #4CAF50;
      font-weight: bold;
    }
    
    .topping-item:active {
      transform: scale(0.98);
    }
    
    .quantity-control {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      margin: 25px 0;
      background: white;
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .quantity-btn {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: #4CAF50;
      color: white;
      font-size: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
    }
    
    .quantity-btn:active {
      transform: scale(0.9);
    }
    
    .quantity-display {
      font-size: 60px;
      font-weight: bold;
      min-width: 80px;
      text-align: center;
      color: #333;
    }
    
    .price-display {
      background: white;
      padding: 60px;
      border-radius: 15px;
      text-align: center;
      margin: 20px 0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .price-label {
      font-size: 60px;
      color: #666;
      margin-bottom: 8px;
    }
    
    .price-amount {
      font-size: 120px;
      font-weight: bold;
      color: #4CAF50;
    }
    
    .cart-item {
      background: white;
      border-radius: 15px;
      padding: 18px;
      margin-bottom: 15px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    
    .cart-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .cart-item-name {
      font-weight: bold;
      font-size: 60px;
      color: #333;
    }
    
    .cart-item-price {
      font-size: 60px;
      color: #4CAF50;
      font-weight: bold;
    }
    
    .cart-item-details {
      font-size: 40px;
      color: #666;
      margin-top: 5px;
    }
    
    .order-complete {
      text-align: center;
      padding: 30px 20px;
    }
    
    .order-number-display {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      font-size: 160px;
      font-weight: bold;
      padding: 40px;
      border-radius: 20px;
      margin: 30px 0;
      box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
      text-shadow: 3px 3px 6px rgba(0,0,0,0.3);
    }
    
    .waiting-info {
      font-size: 60px;
      color: red;
      margin: 25px 0;
      font-weight: bold;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
    }
    
    .warning-box {
      background: #fff3cd;
      border: 3px solid #ffc107;
      color: #856404;
      padding: 20px;
      border-radius: 15px;
      margin: 25px 0;
      font-size: 35px;
      font-weight: bold;
      line-height: 1.6;
    }
    
    .hidden { display: none; }
    
    .fixed-cart-btn {
      position: fixed;
      bottom: 20px;
      left: 20px;
      right: 20px;
      z-index: 1000;
      box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    
    .page-title {
      font-size: 24px;
      font-weight: bold;
      color: white;
      margin-bottom: 20px;
      text-align: center;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .top-waiting-info {
      background: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 12px;
      text-align: center;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }
    
    .top-waiting-label {
      font-size: 40px;
      color: #666;
      margin-bottom: 5px;
    }
    
    .top-waiting-count {
      font-size: 32px;
      font-weight: bold;
      color: #ff6b6b;
    }
    
    .item-info-card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    /* ğŸ”¥ã‚¹ãƒãƒ›ç”»é¢ã„ã£ã±ã„ã«åºƒã’ã‚‹ãƒ•ãƒ«å¹…èª¿æ•´ğŸ”¥ */

/* container ã®æ¨ªå¹…åˆ¶é™ã‚’è§£é™¤ */
.container {
  width: 100% !important;
  max-width: 100% !important;
  margin: 0 !important;
  padding: 10px !important;
}

/* PC ã§ã‚‚ 420px å›ºå®šã«ã—ãªã„ */
@media (min-width: 420px) {
  .container {
    width: 100% !important;
    max-width: 100% !important;
    margin: 0 !important;
  }
}

/* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ã‚’å·¦å³ã„ã£ã±ã„ã« */
.menu-item {
  width: 100% !important;
}

/* ã‚°ãƒªãƒƒãƒ‰ã®å·¦å³ã®ç„¡é§„ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ */
.menu-grid {
  width: 100%;
  margin-left: 0;
  margin-right: 0;
}

/* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«æ™‚ã«æ¨ªã‚ºãƒ¬ã—ãªã„ã‚ˆã†ã« */
body, html {
  overflow-x: hidden !important;
  width: 100%;
}
/* ----------------------------
   ğŸ”¥ ã‚¹ãƒãƒ›ã‚¢ãƒ—ãƒªé¢¨ã«è¶…å¤§å‹åŒ–ã™ã‚‹è¨­å®š
   ---------------------------- */

/* å•†å“ã‚«ãƒ¼ãƒ‰ã®é«˜ã•ãƒ»ä½™ç™½ã‚’å¤§å¹…ã«æ‹¡å¤§ */
.menu-item {
  padding: 28px 20px !important;
  min-height: 350px !important;   /* â†é«˜ã•ã‚’å¤§ãã */
  border-radius: 18px !important; /* â†ã‚¢ãƒ—ãƒªé¢¨ã®ä¸¸ã¿ */
  display: flex;
  flex-direction: column;
  justify-content: center;
}

/* å•†å“åï¼ˆãƒ¡ã‚¤ãƒ³æ–‡å­—ï¼‰ã‚’å¤§ããå¤ªã */
.menu-item-name {
  font-size: 55px !important;    /* â†ã•ã‚‰ã«å¤§ãã */
  line-height: 1.5 !important;
  font-weight: 700 !important;   /* å¤ªå­— */
  margin-bottom: 10px !important;
}

/* ä¾¡æ ¼ã‚’ã‚‚ã£ã¨ç›®ç«‹ã¤ã‚ˆã†ã«å¤§ãã */
.menu-item-price {
  font-size: 50px !important;
  font-weight: 700 !important;
}

/* ç”»é¢å·¦å³ã„ã£ã±ã„ã«åºƒã’ã‚‹ï¼ˆé‡è¦ï¼‰ */
.menu-grid {
  width: 100% !important;
  margin: 0 !important;
  padding: 0 !important;
  grid-template-columns: 1fr !important;  /* â†1åˆ—å¤§ããè¡¨ç¤º */
}

/* ã‚«ãƒ¼ãƒ‰é–“ã®ä½™ç™½ */
.menu-item + .menu-item {
  margin-top: 18px !important;
}
/* ãŸã ä»Šã®ãŠå¾…ã¡äººæ•°ã‚¨ãƒªã‚¢ï¼ˆå…¨ä½“ï¼‰ */
.top-waiting-info {
  text-align: center;
  margin-bottom: 25px;
}

/* ã€ŒãŸã ä»Šã®ãŠå¾…ã¡äººæ•°ã€ */
.top-waiting-label {
  font-size: 50px;       /* â†ã“ã“ã§å¤§ãã */
  font-weight: bold;
  margin-bottom: 5px;
}

/* ã€Œâ—¯çµ„ã€éƒ¨åˆ† */
.top-waiting-count {
  font-size: 70px;       /* â†ã•ã‚‰ã«å¤§ãã */
  font-weight: bold;
}

/* ã‚«ãƒ†ã‚´ãƒªã®ãƒ©ãƒ™ãƒ« */
.category-filter label {
  font-size: 50px;        /* â†ã“ã“ã‚’èª¿æ•´ã—ã¦å¤§ãã•å¤‰æ›´ */
  font-weight: bold;
  display: block;
  margin-bottom: 10px;
  text-align: center;
}

/* ã‚«ãƒ†ã‚´ãƒªé¸æŠãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚‚å¤§ãã */
.category-filter select {
  font-size: 30px;
  padding: 12px;
  height: 65px;
}

  </style>

</head>

<body>
  <div class="header">
    <h1>ğŸ± ç²‰ã‚‚ã‚“å±‹ å…« ä¸‹èµ¤å¡šåº—</h1>
  </div>

  <!-- ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä¸€è¦§ãƒšãƒ¼ã‚¸ -->
  <div id="page-menu">
    <div class="container">
      <div class="top-waiting-info">
        <div class="top-waiting-label">ãŸã ä»Šã®ãŠå¾…ã¡äººæ•°</div>
        <div class="top-waiting-count"><span id="top-waiting">-</span>çµ„</div>
      </div>
      <div class="category-filter">
        <label>ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„</label>
        <select id="category-select">
          <option value="">å…¨ã¦ã®å•†å“</option>
        </select>
      </div>
      <div class="menu-grid" id="menu-list"></div>
    </div>
    <button id="cart-btn" class="btn-primary fixed-cart-btn hidden" onclick="showCart()">ã‚«ãƒ¼ãƒˆã‚’è¦‹ã‚‹</button>
  </div>

  <!-- ãƒˆãƒƒãƒ”ãƒ³ã‚°é¸æŠãƒšãƒ¼ã‚¸ -->
  <div id="page-topping" class="hidden">
    <div class="container">
      <div class="page-title">ãƒˆãƒƒãƒ”ãƒ³ã‚°ã‚’é¸æŠ</div>
      <div class="item-info-card" id="item-info"></div>
      <div class="topping-list" id="topping-list"></div>
      <div class="quantity-control">
        <div class="quantity-btn" onclick="changeQty(-1)">âˆ’</div>
        <div class="quantity-display" id="qty">1</div>
        <div class="quantity-btn" onclick="changeQty(1)">+</div>
      </div>
      <div class="price-display">
        <div class="price-label">å°è¨ˆ</div>
        <div class="price-amount" id="subtotal">Â¥0</div>
      </div>
      <button class="btn-primary" onclick="addToCart()">ã‚«ãƒ¼ãƒˆã«è¿½åŠ </button>
      <button class="btn-secondary" onclick="backToMenu()">æˆ»ã‚‹</button>
    </div>
  </div>

  <!-- ã‚«ãƒ¼ãƒˆãƒšãƒ¼ã‚¸ -->
  <div id="page-cart" class="hidden">
    <div class="container">
      <div class="page-title">ã‚«ãƒ¼ãƒˆ</div>
      <div id="cart-items"></div>
      <div class="price-display">
        <div class="price-label">åˆè¨ˆé‡‘é¡</div>
        <div class="price-amount" id="cart-total">Â¥0</div>
      </div>
      <button class="btn-primary" onclick="confirmOrder()">æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹</button>
      <button class="btn-secondary" onclick="continueShopping()">è²·ã„ç‰©ã‚’ç¶šã‘ã‚‹</button>
    </div>
  </div>

  <!-- æ³¨æ–‡å®Œäº†ãƒšãƒ¼ã‚¸ -->
  <div id="page-complete" class="hidden">
    <div class="container">
      <div class="order-complete">
        <h2 style="color: white; font-size: 28px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">âœ… ã”æ³¨æ–‡ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™</h2>
        <div style="background: white; padding: 15px; border-radius: 10px; margin: 20px 0;">
          <div style="font-size: 18px; color: #666; margin-bottom: 5px;">ã”åˆ©ç”¨ã‚¹ã‚¿ã‚¤ãƒ«</div>
          <div style="font-size: 28px; font-weight: bold; color: #ff6b9d;" id="eat-style">-</div>
        </div>
        <div class="waiting-info">ãŸã ä»Šã®ãŠå¾…ã¡äººæ•°: <span id="waiting">1</span>çµ„</div>
        <div style="color: white; font-size: 22px; margin: 15px 0;">æ³¨æ–‡ç•ªå·</div>
        <div class="order-number-display" id="order-num">000</div>
        
        <!-- æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
        <div id="order-status" class="warning-box" style="background: linear-gradient(135deg, #a8edea 0%, #89d4cf 100%); color: white; border-color: #89d4cf;">
          â³ åªä»Šæº–å‚™ã—ã¦ã„ã¾ã™ã€ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„
        </div>
        
        <div class="warning-box">
          ã“ã®ç•ªå·ã§ãŠå‘¼ã³ã—ã¾ã™ã®ã§<br>
          å•†å“ã‚’å—ã‘å–ã‚‹ã¾ã§<br>
          ã“ã®ç”»é¢ã‚’é–‰ã˜ãªã„ã§ãã ã•ã„
        </div>
        
        <div class="warning-box" style="background: #ffebee; border-color: #ef5350; color: #c62828;">
          <strong>âš ï¸ é‡è¦ãªãŠçŸ¥ã‚‰ã›</strong><br><br>
          â€¢ å¸­ã‚’å¤–ã™éš›ã«ã¯å…ˆã«ãŠä¼šè¨ˆã‚’æ¸ˆã¾ã›ã¦ãã ã•ã„<br><br>
          â€¢ ç•ªå·ã‚’ãŠå‘¼ã³ã—ã¦ã‚‚æœªä¼šè¨ˆã®ã¾ã¾å¸­ã‚’å¤–ã•ã‚Œã¾ã™ã¨æ³¨æ–‡ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã¨ãªã‚‹å ´åˆãŒã‚ã‚Šã¾ã™
        </div>
        
        <div style="color: white; font-size: 22px; margin: 25px 0; font-weight: bold;">ã”æ³¨æ–‡å†…å®¹</div>
        <div id="order-items"></div>
        <div class="price-display">
          <div class="price-label">åˆè¨ˆé‡‘é¡</div>
          <div class="price-amount" id="order-total">Â¥0</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let cart = [];
    let currentItem = null;
    let selectedToppings = [];
    let qty = 1;
    let allMenuItems = [];
    let tableNumber = '<?= tableNumber ?>' || 'ãƒ†ã‚¤ã‚¯ã‚¢ã‚¦ãƒˆ';

    window.onload = function() {
      console.log('ãƒ†ãƒ¼ãƒ–ãƒ«ç•ªå·:', tableNumber);
      loadAllData();
      updateTopWaitingCount();
      // 10ç§’ã”ã¨ã«ãƒˆãƒƒãƒ—ã®å¾…ã¡äººæ•°ã‚’æ›´æ–°
      setInterval(updateTopWaitingCount, 10000);
    };

    function updateTopWaitingCount() {
      google.script.run
        .withSuccessHandler(function(count) {
          document.getElementById('top-waiting').textContent = count;
        })
        .withFailureHandler(function(e) {
          console.error('å¾…ã¡äººæ•°å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        })
        .getWaitingCountWithManual();
    }

    function loadAllData() {
      google.script.run
        .withSuccessHandler(function(cats) {
          const sel = document.getElementById('category-select');
          cats.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = c;
            sel.appendChild(opt);
          });
          loadAllMenu();
        })
        .withFailureHandler(e => alert('ã‚¨ãƒ©ãƒ¼: ' + e))
        .getCategories();
    }

    function loadAllMenu() {
      google.script.run
        .withSuccessHandler(function(items) {
          allMenuItems = items;
          displayMenuItems(items);
        })
        .withFailureHandler(e => alert('ã‚¨ãƒ©ãƒ¼: ' + e))
        .getAllMenu(tableNumber);
    }

    document.addEventListener('DOMContentLoaded', function() {
      const sel = document.getElementById('category-select');
      sel.addEventListener('change', function() {
        if (this.value === '') {
          displayMenuItems(allMenuItems);
        } else {
          const filtered = allMenuItems.filter(item => item.category === this.value);
          displayMenuItems(filtered);
        }
      });
    });

    function displayMenuItems(items) {
      const list = document.getElementById('menu-list');
      list.innerHTML = '';
      items.forEach(item => {
        const div = document.createElement('div');
        div.className = 'menu-item';
        let html = `
          <div class="menu-item-name">${item.name}</div>
          <div class="menu-item-price">Â¥${item.price.toLocaleString()}</div>
        `;
        if (item.note) {
          html += `<div class="menu-item-note">${item.note}</div>`;
        }
        div.innerHTML = html;
        div.onclick = () => selectItem(item);
        list.appendChild(div);
      });
    }

    function selectItem(item) {
      currentItem = item;
      selectedToppings = [];
      qty = 1;
      
      document.getElementById('item-info').innerHTML = `
        <div class="menu-item-name" style="font-size: 20px;">${item.name}</div>
        <div class="menu-item-price" style="font-size: 24px; margin-top: 10px;">Â¥${item.price.toLocaleString()}</div>
      `;
      
      if (item.toppingsId) {
        google.script.run
          .withSuccessHandler(function(tops) {
            const list = document.getElementById('topping-list');
            list.innerHTML = '';
            if (tops.length > 0) {
              tops.forEach(t => {
                const div = document.createElement('div');
                div.className = 'topping-item';
                div.innerHTML = `
                  <span>${t.name}</span>
                  <span style="color: #4CAF50; font-weight: bold;">${t.price > 0 ? '+Â¥' + t.price.toLocaleString() : 'ç„¡æ–™'}</span>
                `;
                div.onclick = () => {
                  div.classList.toggle('selected');
                  const idx = selectedToppings.findIndex(x => x.id === t.id);
                  if (idx > -1) selectedToppings.splice(idx, 1);
                  else selectedToppings.push(t);
                  updateSubtotal();
                };
                list.appendChild(div);
              });
            } else {
              list.innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ãƒˆãƒƒãƒ”ãƒ³ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
            }
          })
          .getToppings(item.toppingsId);
      } else {
        document.getElementById('topping-list').innerHTML = '<div style="text-align:center;color:#999;padding:20px;">ãƒˆãƒƒãƒ”ãƒ³ã‚°ã¯ã‚ã‚Šã¾ã›ã‚“</div>';
      }
      
      updateSubtotal();
      showPage('page-topping');
    }

    function changeQty(d) {
      qty = Math.max(1, qty + d);
      document.getElementById('qty').textContent = qty;
      updateSubtotal();
    }

    function updateSubtotal() {
      let total = currentItem.price;
      selectedToppings.forEach(t => total += t.price || 0);
      document.getElementById('subtotal').textContent = 'Â¥' + (total * qty).toLocaleString();
    }

    function addToCart() {
      let toppingPrice = 0;
      const toppingNames = selectedToppings.map(t => {
        toppingPrice += t.price || 0;
        return t.name;
      }).join(', ') || 'ãªã—';
      
      cart.push({
        id: currentItem.id,
        name: currentItem.name,
        price: currentItem.price,
        toppings: toppingNames,
        toppingPrice: toppingPrice,
        quantity: qty
      });
      
      backToMenu();
    }

    function backToMenu() {
      showPage('page-menu');
      updateCartButton();
    }

    function continueShopping() {
      backToMenu();
    }

    function updateCartButton() {
      const btn = document.getElementById('cart-btn');
      if (cart.length > 0) {
        btn.classList.remove('hidden');
        btn.textContent = `ã‚«ãƒ¼ãƒˆã‚’è¦‹ã‚‹ (${cart.length}ç‚¹)`;
        btn.onclick = showCart; // onclickå±æ€§ã‚’å†è¨­å®š
      } else {
        btn.classList.add('hidden');
      }
    }

    function showCart() {
      if (cart.length === 0) {
        alert('ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™');
        return;
      }
      
      const list = document.getElementById('cart-items');
      list.innerHTML = '';
      let total = 0;
      
      cart.forEach(item => {
        const subtotal = (item.price + item.toppingPrice) * item.quantity;
        total += subtotal;
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `
          <div class="cart-item-header">
            <div class="cart-item-name">${item.name}</div>
            <div class="cart-item-price">Â¥${subtotal.toLocaleString()}</div>
          </div>
          <div class="cart-item-details">
            å˜ä¾¡: Â¥${item.price.toLocaleString()} Ã— ${item.quantity}å€‹
          </div>
          <div class="cart-item-details" style="color: #4CAF50;">
            ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${item.toppings}
          </div>
        `;
        list.appendChild(div);
      });
      
      document.getElementById('cart-total').textContent = 'Â¥' + total.toLocaleString();
      showPage('page-cart');
    }

    function confirmOrder() {
      if (cart.length === 0) {
        alert('ã‚«ãƒ¼ãƒˆãŒç©ºã§ã™');
        return;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          console.log('æ³¨æ–‡å®Œäº†:', result);
          document.getElementById('order-num').textContent = result.orderNumber;
          document.getElementById('waiting').textContent = result.waitingCount;
          document.getElementById('order-total').textContent = 'Â¥' + result.totalAmount.toLocaleString();
          document.getElementById('eat-style').textContent = result.tableNumber;
          
          const list = document.getElementById('order-items');
          list.innerHTML = '';
          cart.forEach(item => {
            const subtotal = (item.price + item.toppingPrice) * item.quantity;
            const div = document.createElement('div');
            div.className = 'cart-item';
            div.innerHTML = `
              <div class="cart-item-header">
                <div class="cart-item-name">${item.name}</div>
                <div class="cart-item-price">Â¥${subtotal.toLocaleString()}</div>
              </div>
              <div class="cart-item-details">
                æ•°é‡: ${item.quantity}å€‹
              </div>
              <div class="cart-item-details" style="color: #4CAF50;">
                ãƒˆãƒƒãƒ”ãƒ³ã‚°: ${item.toppings}
              </div>
            `;
            list.appendChild(div);
          });
          
          cart = [];
          showPage('page-complete');
          
          // æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å®šæœŸãƒã‚§ãƒƒã‚¯
          checkOrderStatus(result.orderNumber);
        })
        .withFailureHandler(e => alert('æ³¨æ–‡å¤±æ•—: ' + e))
        .saveOrder({ 
          items: cart,
          tableNumber: tableNumber 
        });
    }

    function showPage(id) {
      ['page-menu', 'page-topping', 'page-cart', 'page-complete'].forEach(p => {
        document.getElementById(p).classList.add('hidden');
      });
      document.getElementById(id).classList.remove('hidden');
      
      if (id === 'page-menu') {
        updateCartButton();
      }
    }

    // æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆ5ç§’ã”ã¨ï¼‰
    let statusCheckInterval = null;
    
    function checkOrderStatus(orderNumber) {
      console.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯é–‹å§‹: æ³¨æ–‡ç•ªå·', orderNumber);
      
      if (statusCheckInterval) {
        clearInterval(statusCheckInterval);
      }
      
      // åˆå›ãƒã‚§ãƒƒã‚¯
      updateOrderStatus(orderNumber);
      
      // 5ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
      statusCheckInterval = setInterval(() => {
        updateOrderStatus(orderNumber);
      }, 5000);
    }
    
    function updateOrderStatus(orderNumber) {
      const now = new Date();
      console.log('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°:', now.toLocaleTimeString());
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒã‚§ãƒƒã‚¯
      google.script.run
        .withSuccessHandler(function(cancelled) {
          if (cancelled) {
            console.log('âŒ ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ¤œå‡º');
            const statusDiv = document.getElementById('order-status');
            statusDiv.style.background = '#f44336';
            statusDiv.style.borderColor = '#d32f2f';
            statusDiv.style.color = 'white';
            statusDiv.innerHTML = 'âŒ ç•ªå·ã‚’ãŠå‘¼ã³ã—ã¾ã—ãŸãŒã”ä¸åœ¨ã§ã—ãŸã®ã§<br>æ³¨æ–‡ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã›ã¦é ‚ãã¾ã—ãŸ';
            clearInterval(statusCheckInterval);
            
            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«éŸ³ã‚’é³´ã‚‰ã™
            playCancelSound();
            return;
          }
          
          // é€šå¸¸ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
          google.script.run
            .withSuccessHandler(function(exists) {
              console.log('æ³¨æ–‡å­˜åœ¨:', exists ? 'ã¯ã„ï¼ˆèª¿ç†ä¸­ï¼‰' : 'ã„ã„ãˆï¼ˆå®Œæˆï¼‰');
              const statusDiv = document.getElementById('order-status');
              
              if (exists) {
                // ã¾ã èª¿ç†ä¸­
                statusDiv.style.background = 'linear-gradient(135deg, #a8edea 0%, #89d4cf 100%)';
                statusDiv.style.borderColor = '#89d4cf';
                statusDiv.style.color = 'white';
                statusDiv.innerHTML = 'â³ åªä»Šæº–å‚™ã—ã¦ã„ã¾ã™ã€ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„';
              } else {
                // å®Œæˆï¼
                console.log('âœ… æ³¨æ–‡å®Œäº†ã‚’æ¤œå‡ºï¼');
                statusDiv.style.background = 'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)';
                statusDiv.style.borderColor = '#fcb69f';
                statusDiv.style.color = 'white';
                statusDiv.innerHTML = 'âœ… å•†å“ãŒå‡ºæ¥ä¸ŠãŒã‚Šã¾ã—ãŸ<br>ç”»é¢ã®æ³¨æ–‡ç•ªå·ã‚’åº—å“¡ã«è¦‹ã›ã¦å•†å“ã‚’å—ã‘å–ã£ã¦ãã ã•ã„';
                clearInterval(statusCheckInterval);
                
                // å®ŒæˆéŸ³ã‚’é³´ã‚‰ã™
                playCompletionSound();
              }
              
              // å¾…ã¡äººæ•°ã‚‚æ›´æ–°
              updateWaitingCount(orderNumber);
            })
            .withFailureHandler(function(e) {
              console.error('ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', e);
            })
            .checkOrderExists(orderNumber);
        })
        .withFailureHandler(function(e) {
          console.error('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', e);
        })
        .checkIfCancelled(orderNumber);
    }
    
    // å¾…ã¡äººæ•°ã‚’æ›´æ–°
    function updateWaitingCount(orderNumber) {
      google.script.run
        .withSuccessHandler(function(count) {
          console.log('å¾…ã¡äººæ•°æ›´æ–°:', count);
          document.getElementById('waiting').textContent = count;
        })
        .withFailureHandler(function(e) {
          console.error('å¾…ã¡äººæ•°å–å¾—ã‚¨ãƒ©ãƒ¼:', e);
        })
        .getWaitingCountWithManual();
    }
    
    // å®Œäº†éŸ³ã‚’é³´ã‚‰ã™
    function playCompletionSound() {
      try {
        // Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå®ŒæˆéŸ³ï¼‰
        const audioUrl = 'https://drive.google.com/uc?export=download&id=1VcqhVJ-7mkmIfihqHh0CxttdwrXfGd4s';
        const audio = new Audio(audioUrl);
        
        audio.addEventListener('error', function(e) {
          console.error('å®ŒæˆéŸ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
          playDefaultBeep();
        });
        
        audio.play().catch(function(e) {
          console.error('å®ŒæˆéŸ³å†ç”Ÿã‚¨ãƒ©ãƒ¼:', e);
          playDefaultBeep();
        });
        
      } catch (e) {
        console.error('å®ŒæˆéŸ³å‡¦ç†ã‚¨ãƒ©ãƒ¼:', e);
        playDefaultBeep();
      }
    }
    
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«éŸ³ã‚’é³´ã‚‰ã™
    function playCancelSound() {
      try {
        // Googleãƒ‰ãƒ©ã‚¤ãƒ–ã®éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆã‚­ãƒ£ãƒ³ã‚»ãƒ«éŸ³ï¼‰
        const audioUrl = 'https://drive.google.com/uc?export=download&id=10auHV4gZuNN3Ce1bGMXJ6uP5L5OUBP7R';
        const audio = new Audio(audioUrl);
        
        audio.addEventListener('error', function(e) {
          console.error('ã‚­ãƒ£ãƒ³ã‚»ãƒ«éŸ³èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
          playDefaultBeep();
        });
        
        audio.play().catch(function(e) {
          console.error('ã‚­ãƒ£ãƒ³ã‚»ãƒ«éŸ³å†ç”Ÿã‚¨ãƒ©ãƒ¼:', e);
          playDefaultBeep();
        });
        
      } catch (e) {
        console.error('ã‚­ãƒ£ãƒ³ã‚»ãƒ«éŸ³å‡¦ç†ã‚¨ãƒ©ãƒ¼:', e);
        playDefaultBeep();
      }
    }
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ“ãƒ¼ãƒ—éŸ³
    function playDefaultBeep() {
      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = 800;
        oscillator.type = 'sine';
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
      } catch (e) {
        console.log('ãƒ“ãƒ¼ãƒ—éŸ³å†ç”Ÿã‚¨ãƒ©ãƒ¼ï¼ˆç„¡è¦–ï¼‰:', e);
      }
    }
  </script>
</body>
</html>